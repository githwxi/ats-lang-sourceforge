<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of the GNU LESSER GENERAL PUBLIC LICENSE as published by the
** Free Software Foundation; either version 2.1, or (at your option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* author: Hongwei Xi (hwxi AT cs DOT bu DOT edu) *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^

#include "prelude/CATS/array.cats"

%}</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// loaded by [ats_main_prelude]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">i2sz size1_of_int1</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* persistent matrices *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">matrix_v
  <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> m<span class="keyword">:</span>int<span class="keyword">,</span> n<span class="keyword">:</span>int<span class="keyword">,</span> l<span class="keyword">:</span>addr<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>mn<span class="keyword">:</span>int<span class="keyword">]</span> <span class="keyword">(</span>MUL <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> mn<span class="keyword">)</span><span class="keyword">,</span> array_v <span class="keyword">(</span>a<span class="keyword">,</span> mn<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">// end of [assume]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> array_v_of_matrix_v <span class="keyword">(</span>pf_mat<span class="keyword">)</span> <span class="keyword">=</span> pf_mat
<span class="keyword">implement</span> matrix_v_of_array_v <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf_arr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@(</span>pf_mul<span class="keyword">,</span> pf_arr<span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">matrix_viewt0ype_int_int_type
  <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> m<span class="keyword">:</span>int<span class="keyword">,</span> n<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>l<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">@{</span>
  data<span class="keyword">=</span> ptr l<span class="keyword">,</span> view<span class="keyword">=</span> vbox <span class="keyword">(</span>matrix_v <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">}</span></span> <span class="comment">// end of [matrix_viewt0ype_int_int_type]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="2251"><span class="dyncstdec">vbox_make_view_ptr_matrix
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> 
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">matrix_v <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span>vbox <span class="keyword">(</span>matrix_v <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> void<span class="keyword">)</span></span></span></a>
  <span class="keyword">=</span> "atspre_vbox_make_view_ptr"
<span class="comment">// end of [vbox_make_view_ptr_matrix]
</span>
<span class="keyword">implement</span>
matrix_make_arrsz__main
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> arrsz<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> free_gc_elim <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>arrsz<span class="keyword">.</span>0<span class="keyword">)</span></span> <span class="comment">// return the certificate to GC
</span>  <span class="keyword">prval</span> <span class="prfexp">pf_mat <span class="keyword">=</span> matrix_v_of_array_v <span class="keyword">(</span>pf_mul<span class="keyword">,</span> arrsz<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mat_box</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> vbox_make_view_ptr_matrix <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> arrsz<span class="keyword">.</span>2<span class="keyword">)</span>
<span class="keyword">in</span> <span class="keyword">@{</span>
  data<span class="keyword">=</span> arrsz<span class="keyword">.</span>2<span class="keyword">,</span> view<span class="keyword">=</span> pf_mat_box
<span class="keyword">}</span> <span class="keyword">end</span>
<span class="comment">// end of [matrix_make_arrsize__main]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> matrix_make_elt <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> mn<span class="keyword">)</span> <span class="keyword">=</span> mul2_size1_size1 <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_nat_nat_nat pf_mul</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_arr</span> <span class="keyword">|</span> p_arr<span class="keyword">)</span> <span class="keyword">=</span>
    array_ptr_alloc_tsz <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>mn<span class="keyword">,</span> sizeof&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> free_gc_elim <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>pf_gc<span class="keyword">)</span></span> <span class="comment">// return the certificate
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> array_ptr_initialize_elt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_arr<span class="keyword">,</span> mn<span class="keyword">,</span> x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf_mat <span class="keyword">=</span> matrix_v_of_array_v <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf_arr<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mat_box</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> vbox_make_view_ptr_matrix <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> p_arr<span class="keyword">)</span>
<span class="keyword">in</span> <span class="keyword">@{</span>
  data<span class="keyword">=</span> p_arr<span class="keyword">,</span> view<span class="keyword">=</span> pf_mat_box
<span class="keyword">}</span> <span class="keyword">end</span> <span class="comment">// end of [matrix_make_elt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#define atspre_matrix_szdiv(i, n) (i / n)
%}</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="3456"><span class="dyncstdec">szdiv <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>pos<span class="keyword">;</span> mn<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> mn<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> mn<span class="keyword">)</span></span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">size_t i</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">size_t n</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>d<span class="keyword">:</span>nat <span class="keyword">|</span> d <span class="keyword">&lt;</span> m<span class="keyword">]</span> size_t d</span></span></a>
  <span class="keyword">=</span> "#atspre_matrix_szdiv" <span class="comment">// macro!
</span><span class="comment">// end of [szdiv]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">infixl</span> <span class="keyword">(</span> * <span class="keyword">)</span> szmul2</span><span class="keyword">;</span> <span class="neuexp"><span class="keyword">infixl</span> <span class="keyword">(</span> mod <span class="keyword">)</span> szmod1</span>

<span class="keyword">implement</span>
matrix_make_fun_tsz__main
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">,</span> tsz<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">mn<span class="keyword">:</span>int</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> mn<span class="keyword">)</span> <span class="keyword">=</span> m szmul2 n
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_nat_nat_nat pf_mul</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_arr</span> <span class="keyword">|</span> p_arr<span class="keyword">)</span> <span class="keyword">=</span> array_ptr_alloc_tsz <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>mn<span class="keyword">,</span> tsz<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> free_gc_elim <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>pf_gc<span class="keyword">)</span></span> <span class="comment">// return the certificate
</span>  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="4000"><span class="stacstdec">fun_t <span class="keyword">=</span>
    <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a<span class="keyword">,</span> sizeLt m<span class="keyword">,</span> natLt n<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> void</span></a></span>
  <span class="keyword">var</span> <span class="keyword">!</span>p_f1 <span class="keyword">=</span> @lam
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">sizeLt mn</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=&lt;</span><span class="staexp">clo</span><span class="keyword">&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> d <span class="keyword">=</span> szdiv <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> i<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">and</span> r <span class="keyword">=</span> i szmod1 n
  <span class="keyword">in</span>
    f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> d<span class="keyword">,</span> r<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f1]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    array_ptr_initialize_clo_tsz__main <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_arr<span class="keyword">,</span> mn<span class="keyword">,</span> <span class="keyword">!</span>p_f1<span class="keyword">,</span> tsz<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf_mat <span class="keyword">=</span> matrix_v_of_array_v <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf_arr<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mat_box</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> vbox_make_view_ptr_matrix <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> p_arr<span class="keyword">)</span>
<span class="keyword">in</span> <span class="keyword">@{</span>
  data<span class="keyword">=</span> p_arr<span class="keyword">,</span> view<span class="keyword">=</span> pf_mat_box
<span class="keyword">}</span> <span class="keyword">end</span> <span class="comment">// end of [matrix_make_fun_tsz__main]
</span>
<span class="keyword">implement</span> matrix_make_fun_tsz
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">,</span> tsz<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="4671"><span class="stacstdec">fun_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="4739"><span class="stacstdec">fun1_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="4851"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">fun_t</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">fun1_t</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  matrix_make_fun_tsz__main <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">,</span> tsz<span class="keyword">,</span> null<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_make_fun_tsz]
</span>
<span class="keyword">implement</span> matrix_make_clo_tsz
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">,</span> tsz<span class="keyword">)</span> <span class="keyword">=</span> M <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span>
  <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">typedef</span> <span class="staexp"><a name="5133"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="5201"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span>
    <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">sizeLt m</span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">sizeLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> i<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> M <span class="keyword">=</span> matrix_make_fun_tsz__main <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> app<span class="keyword">,</span> tsz<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf1 := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ f := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="keyword">}</span> <span class="comment">// end of [matrix_make_clo_tsz]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">prfun</span> <span class="prfexp">lemma_for_matrix_subscripting
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> m<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>mn<span class="keyword">,</span>p<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>m<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>pf1<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> mn<span class="keyword">)</span></span><span class="keyword">,</span> pf2<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>i<span class="keyword">,</span> n<span class="keyword">,</span> p<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>p+n &lt;= mn<span class="keyword">]</span> void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">MULind pf11 <span class="keyword">=</span> pf1</span>
<span class="keyword">in</span>
  <span class="keyword">sif</span> <span class="staexp">i <span class="keyword">&lt;</span> m-1</span> <span class="keyword">then</span> <span class="keyword">begin</span>
    lemma_for_matrix_subscripting <span class="keyword">(</span>pf11<span class="keyword">,</span> pf2<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// i = m-1
</span>    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_isfun <span class="keyword">(</span>pf11<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [sif]
</span><span class="keyword">end</span></span> <span class="comment">// end of [lemma_for_matrix_subscripting]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_get_elt_at <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf_mat <span class="keyword">=</span> M<span class="keyword">.</span>view</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_arr<span class="keyword">)</span> <span class="keyword">=</span> array_v_of_matrix_v <span class="keyword">(</span>pf_mat<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul_i_n</span> <span class="keyword">|</span> i_n<span class="keyword">)</span> <span class="keyword">=</span> i szmul2 n
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_nat_nat_nat pf_mul_i_n</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma_for_matrix_subscripting <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_mul_i_n<span class="keyword">)</span></span>
  <span class="keyword">val</span> M_data <span class="keyword">=</span> M<span class="keyword">.</span>data
  <span class="keyword">val</span> x <span class="keyword">=</span> <span class="keyword">!</span>M_data<span class="keyword">.</span><span class="keyword">[</span><span class="prfexp">i_n+j</span><span class="keyword">]</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_mat := matrix_v_of_array_v <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_arr<span class="keyword">)</span></span>
<span class="keyword">in</span>
  x <span class="comment">// return value
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_get_elt_at]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_set_elt_at <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf_mat <span class="keyword">=</span> M<span class="keyword">.</span>view</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_arr<span class="keyword">)</span> <span class="keyword">=</span> array_v_of_matrix_v <span class="keyword">(</span>pf_mat<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul_i_n</span> <span class="keyword">|</span> i_n<span class="keyword">)</span> <span class="keyword">=</span> i szmul2 n
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_nat_nat_nat pf_mul_i_n</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma_for_matrix_subscripting <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_mul_i_n<span class="keyword">)</span></span>
  <span class="keyword">val</span> M_data <span class="keyword">=</span> M<span class="keyword">.</span>data
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>M_data<span class="keyword">.</span><span class="keyword">[</span><span class="prfexp">i_n+j</span><span class="keyword">]</span> := x
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_mat := matrix_v_of_array_v <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_arr<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_set_elt_at]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_get_elt_at__intsz <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> i2sz i<span class="keyword">;</span> <span class="keyword">val</span> n <span class="keyword">=</span> i2sz n<span class="keyword">;</span> <span class="keyword">val</span> j <span class="keyword">=</span> i2sz j
<span class="keyword">in</span>
  matrix_get_elt_at&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_get_elt_at__intsz]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_set_elt_at__intsz <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> i2sz i<span class="keyword">;</span> <span class="keyword">val</span> n <span class="keyword">=</span> i2sz n<span class="keyword">;</span> <span class="keyword">val</span> j <span class="keyword">=</span> i2sz j
<span class="keyword">in</span>
  matrix_set_elt_at&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>M<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_set_elt_at__intsz]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
matrix_ptr_takeout_tsz
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l0<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> base<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> tsz<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_arr<span class="keyword">)</span> <span class="keyword">=</span> array_v_of_matrix_v <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mat<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul_i_n</span> <span class="keyword">|</span> i_n<span class="keyword">)</span> <span class="keyword">=</span> i szmul2 n
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> mul_nat_nat_nat pf_mul_i_n</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma_for_matrix_subscripting <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> pf_mul_i_n<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf2</span> <span class="keyword">|</span> p_ofs<span class="keyword">)</span> <span class="keyword">=</span>
    array_ptr_takeout_tsz <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_arr</span> <span class="keyword">|</span> base<span class="keyword">,</span> i_n + j<span class="keyword">,</span> tsz<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">fpf2 <span class="keyword">=</span>
    <span class="keyword">llam</span> <span class="keyword">(</span>pf1<span class="keyword">:</span> <span class="staexp">a @ l</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> matrix_v_of_array_v <span class="keyword">(</span>pf_mul_mn<span class="keyword">,</span> fpf2 pf1<span class="keyword">)</span></span>
  <span class="comment">// end of [prval]
</span><span class="keyword">in</span>
  <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf2</span> <span class="keyword">|</span> p_ofs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [val]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_foreach_fun__main
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="8078"><span class="stacstdec">fun_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="8123"><span class="stacstdec">mat_t <span class="keyword">=</span> matrix <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn*</span> loop1 <span class="staexp"><span class="keyword">{</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i &lt;= m<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>m-i+1<span class="keyword">,</span>0<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> M<span class="keyword">:</span> <span class="staexp">mat_t</span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span><span class="keyword">,</span> m<span class="keyword">:</span> <span class="staexp">size_t m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">size_t n</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">size_t i</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> i <span class="keyword">&lt;</span> m <span class="keyword">then</span> loop2 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i<span class="keyword">,</span> 0<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop1]
</span>
  <span class="keyword">and</span> loop2 <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> m<span class="keyword">;</span> j &lt;= n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>m-i<span class="keyword">,</span>n-j+1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> M<span class="keyword">:</span> <span class="staexp">mat_t</span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span><span class="keyword">,</span> m<span class="keyword">:</span> <span class="staexp">size_t m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">size_t n</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">size_t i</span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">size_t j</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> j <span class="keyword">&lt;</span> n <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">prval</span> <span class="prfexp">vbox pf_mat <span class="keyword">=</span> M<span class="keyword">.</span>view</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf2</span> <span class="keyword">|</span> p_ij<span class="keyword">)</span> <span class="keyword">=</span>
          matrix_ptr_takeout_tsz <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> M<span class="keyword">.</span>data<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> sizeof&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_ij<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_mat := fpf2 <span class="keyword">(</span>pf1<span class="keyword">)</span>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      loop2 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i<span class="keyword">,</span> j+1<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      loop1 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i+1<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop2]
</span><span class="keyword">in</span>
  loop1 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> 0<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_foreach_fun__main]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_foreach_fun <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_v</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="9213"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="keyword">in</span>
  matrix_foreach_fun__main&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_v</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> null<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_foreach_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_v</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span>
  <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">typedef</span> <span class="staexp"><a name="9510"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="9550"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">@(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span> <span class="keyword">in</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span><span class="keyword">;</span> pf := <span class="keyword">@(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf_v<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> matrix_foreach_fun__main&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> app<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_v := pf1<span class="keyword">;</span> view@ f := pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_foreach_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_foreach_cloref <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span>M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="10010"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span> 
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> matrix_foreach_fun__main&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> app<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_iforeach_fun__main
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="10400"><span class="stacstdec">fun_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span>a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="10465"><span class="stacstdec">mat_t <span class="keyword">=</span> matrix <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn*</span> loop1 <span class="staexp"><span class="keyword">{</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i &lt;= m<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>m-i+1<span class="keyword">,</span>0<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> M<span class="keyword">:</span> <span class="staexp">mat_t</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span><span class="keyword">,</span> m<span class="keyword">:</span> <span class="staexp">size_t m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">size_t n</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">size_t i</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> i <span class="keyword">&lt;</span> m <span class="keyword">then</span> loop2 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i<span class="keyword">,</span> 0<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop1]
</span>
  <span class="keyword">and</span> loop2 <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> m<span class="keyword">;</span> j &lt;= n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>m-i<span class="keyword">,</span>n-j+1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> M<span class="keyword">:</span> <span class="staexp">mat_t</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span><span class="keyword">,</span> m<span class="keyword">:</span> <span class="staexp">size_t m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">size_t n</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">size_t i</span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">size_t j</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> j <span class="keyword">&lt;</span> n <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">prval</span> <span class="prfexp">vbox pf_mat <span class="keyword">=</span> M<span class="keyword">.</span>view</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf2</span> <span class="keyword">|</span> p_ij<span class="keyword">)</span> <span class="keyword">=</span>
          matrix_ptr_takeout_tsz <span class="keyword">(</span><span class="prfexp">pf_mat</span> <span class="keyword">|</span> M<span class="keyword">.</span>data<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">,</span> j<span class="keyword">,</span> sizeof&lt;<span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i<span class="keyword">,</span> j<span class="keyword">,</span> <span class="keyword">!</span>p_ij<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_mat := fpf2 <span class="keyword">(</span>pf1<span class="keyword">)</span>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      loop2 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i<span class="keyword">,</span> j+1<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      loop1 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> i+1<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop2]
</span><span class="keyword">in</span>
  loop1 <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> 0<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_iforeach_fun__main]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_iforeach_fun
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="11535"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span>a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="keyword">in</span>
  matrix_iforeach_fun__main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> null<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [matrix_iforeach_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_iforeach_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_v</span> <span class="keyword">|</span> M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span>
  <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">typedef</span> <span class="staexp"><a name="11872"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="11932"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">@(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span>
    <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">sizeLt m</span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">sizeLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> i<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">;</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf_v<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> matrix_iforeach_fun__main&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> app<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_v := pf1<span class="keyword">;</span> view@ f := pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_iforeach_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
matrix_iforeach_cloref <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="keyword">(</span>M<span class="keyword">,</span> f<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="12449"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>sizeLt m<span class="keyword">,</span> sizeLt n<span class="keyword">,</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref1<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span>
    <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">sizeLt m</span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">sizeLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">$effmask_all</span> <span class="keyword">(</span>f <span class="keyword">(</span>i<span class="keyword">,</span> j<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> matrix_iforeach_fun__main&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> M<span class="keyword">,</span> app<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [matrix_iforeach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// [matrix.sats] is already loaded by a call to [pervasive_load]
</span><span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "prelude/SATS/matrix.sats"</span> <span class="comment">// this forces that the static
</span><span class="comment">// loading function for [matrix.sats] is to be called at run-time
</span><span class="comment">// this is really needed only if some datatypes are declared in [matrix.sats]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [matrix.dats] *)</span>
</pre>
</body>
</html>
