<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: April 2008
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Glo <span class="keyword">=</span> "ats_global.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Map <span class="keyword">=</span> "ats_map_lin.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Set <span class="keyword">=</span> "ats_set_fun.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_hiexp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_trans4.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_map_lin.dats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_set_fun.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_ccomp_env)"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="2232"><span class="dyncstdec">compare_strlst_strlst
  <span class="keyword">(</span>ss1<span class="keyword">:</span> <span class="staexp">strlst</span><span class="keyword">,</span> ss2<span class="keyword">:</span> <span class="staexp">strlst</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> compare <span class="keyword">with</span> compare_strlst_strlst</span>

<span class="keyword">implement</span> compare_strlst_strlst <span class="keyword">(</span>ss1<span class="keyword">,</span> ss2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>ss1<span class="keyword">,</span> ss2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>list_cons <span class="keyword">(</span>s1<span class="keyword">,</span> ss1<span class="keyword">)</span><span class="keyword">,</span> list_cons <span class="keyword">(</span>s2<span class="keyword">,</span> ss2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn &lt;&gt; 0 <span class="keyword">then</span> sgn <span class="keyword">else</span> compare <span class="keyword">(</span>ss1<span class="keyword">,</span> ss2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons, list_cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>list_cons _<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>  1
  <span class="keyword">|</span> <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> list_cons _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ~1
  <span class="keyword">|</span> <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>  0
<span class="keyword">end</span> <span class="comment">// end [compare_strlst_strlst]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="2752"><span class="dyncstdec">compare_labstrlst_labstrlst
  <span class="keyword">(</span>lss1<span class="keyword">:</span> <span class="staexp">labstrlst</span><span class="keyword">,</span> lss2<span class="keyword">:</span> <span class="staexp">labstrlst</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> compare <span class="keyword">with</span> compare_labstrlst_labstrlst</span>

<span class="keyword">implement</span> compare_labstrlst_labstrlst
  <span class="keyword">(</span>lss1<span class="keyword">,</span> lss2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">(</span>lss1<span class="keyword">,</span> lss2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>LABSTRLSTcons <span class="keyword">(</span>l1<span class="keyword">,</span> s1<span class="keyword">,</span> lss1<span class="keyword">)</span><span class="keyword">,</span>
     LABSTRLSTcons <span class="keyword">(</span>l2<span class="keyword">,</span> s2<span class="keyword">,</span> lss2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> $Lab<span class="keyword">.</span>compare_label_label <span class="keyword">(</span>l1<span class="keyword">,</span> l2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn &lt;&gt; 0 <span class="keyword">then</span> sgn <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_string_string <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> sgn &lt;&gt; 0 <span class="keyword">then</span> sgn <span class="keyword">else</span> compare <span class="keyword">(</span>lss1<span class="keyword">,</span> lss2<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>LABSTRLSTcons _<span class="keyword">,</span> LABSTRLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>  1
  <span class="keyword">|</span> <span class="keyword">(</span>LABSTRLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> LABSTRLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>  0
  <span class="keyword">|</span> <span class="keyword">(</span>LABSTRLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> LABSTRLSTcons _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ~1
<span class="keyword">end</span> <span class="comment">// end [compare_labstrlst_labstrlst]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="3447"><span class="dyncstdec">compare_typkey_typkey
  <span class="keyword">(</span>tk1<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">,</span> tk2<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> compare <span class="keyword">with</span> compare_typkey_typkey</span>

<span class="keyword">implement</span> compare_typkey_typkey <span class="keyword">(</span>tk1<span class="keyword">,</span> tk2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>tk1<span class="keyword">,</span> tk2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYrec lss1<span class="keyword">,</span> TYPKEYrec lss2<span class="keyword">)</span> <span class="keyword">=&gt;</span> compare <span class="keyword">(</span>lss1<span class="keyword">,</span> lss2<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYrec _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ~1
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYsum <span class="keyword">(</span>i1<span class="keyword">,</span> ss1<span class="keyword">)</span><span class="keyword">,</span> TYPKEYsum <span class="keyword">(</span>i2<span class="keyword">,</span> ss2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="keyword">let</span> <span class="keyword">val</span> sgn <span class="keyword">=</span> compare <span class="keyword">(</span>i1<span class="keyword">,</span> i2<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">if</span> sgn &lt;&gt; 0 <span class="keyword">then</span> sgn <span class="keyword">else</span> compare <span class="keyword">(</span>ss1<span class="keyword">,</span> ss2<span class="keyword">)</span>
      <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYsum _<span class="keyword">,</span> TYPKEYrec _<span class="keyword">)</span> <span class="keyword">=&gt;</span>  1
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYsum _<span class="keyword">,</span> TYPKEYuni _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ~1
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYuni lss1<span class="keyword">,</span> TYPKEYuni lss2<span class="keyword">)</span> <span class="keyword">=&gt;</span> compare <span class="keyword">(</span>lss1<span class="keyword">,</span> lss2<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>TYPKEYuni _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span>  1
<span class="keyword">end</span> <span class="comment">// end of [compare_typkey_typkey]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_typdef_base <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">string</span><span class="keyword">&gt;</span> <span class="keyword">(</span>"anairiats"<span class="keyword">)</span>
<span class="keyword">val</span> the_typdef_count <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4228"><span class="dyncstdec">typdef_base_get <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4266"><span class="dyncstdec">typdef_base_set <span class="keyword">(</span>base<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span> typdef_base_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_typdef_base
<span class="keyword">implement</span> typdef_base_set <span class="keyword">(</span>base<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_typdef_base := base

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4424"><span class="dyncstdec">typdef_count_get_and_inc <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span></span></a>

<span class="keyword">implement</span> typdef_count_get_and_inc <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">(</span><span class="keyword">!</span>the_typdef_count := n+1<span class="keyword">;</span> n<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>the_typdef_count <span class="keyword">}</span>
<span class="keyword">end</span> <span class="comment">// end of [typdef_count_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_typdeflst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">typdeflst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>TYPDEFLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fn</span> typdeflst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">typdeflst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">typdeflst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">typdeflst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">typdeflst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">typdeflst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> TYPDEFLSTcons <span class="keyword">(</span>_<span class="comment">(*tk*)</span><span class="keyword">,</span> _<span class="comment">(*name*)</span><span class="keyword">,</span> <span class="keyword">!</span>xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [TYPDEFLSTcons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>TYPDEFLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> TYPDEFLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [typdeflst_reverse]
</span>
<span class="keyword">in</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="5168"><span class="dyncstdec">typdeflst_add <span class="keyword">(</span>tk<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">,</span> name<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span> typdeflst_add <span class="keyword">(</span>tk<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdeflst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := TYPDEFLSTcons <span class="keyword">(</span>tk<span class="keyword">,</span> name<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">implement</span> typdeflst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdeflst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := TYPDEFLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> res
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  typdeflst_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [typdeflst_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="5725"><span class="stacstdec">typdefmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>typkey<span class="keyword">,</span> string<span class="keyword">)</span></span></a></span>

<span class="keyword">fn</span> typdefmap_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_make <span class="keyword">(</span>compare_typkey_typkey<span class="keyword">)</span>
<span class="keyword">val</span> the_typdefmap <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">typdefmap</span><span class="keyword">&gt;</span> <span class="keyword">(</span>typdefmap_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5927"><span class="dyncstdec">typdefmap_add_rec <span class="keyword">(</span>tk<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5977"><span class="dyncstdec">typdefmap_add_sum <span class="keyword">(</span>tk<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6027"><span class="dyncstdec">typdefmap_add_uni <span class="keyword">(</span>tk<span class="keyword">:</span> <span class="staexp">typkey</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> typdefmap_add_rec <span class="keyword">(</span>tk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> base <span class="keyword">=</span> typdef_base_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> typdef_count_get_and_inc <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> name_rec <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> prfx <span class="keyword">=</span> $Glo<span class="keyword">.</span>atsccomp_namespace_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> stropt_is_some prfx <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> prfx <span class="keyword">=</span> stropt_unsome prfx
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s%s_rec_%i"<span class="keyword">,</span> <span class="keyword">@(</span>prfx<span class="keyword">,</span> base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s_rec_%i"<span class="keyword">,</span> <span class="keyword">@(</span>base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdefmap<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> tk<span class="keyword">,</span> name_rec<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  name_rec
<span class="keyword">end</span> <span class="comment">// end of [typdefmap_add_rec]
</span>
<span class="keyword">implement</span> typdefmap_add_sum <span class="keyword">(</span>tk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> base <span class="keyword">=</span> typdef_base_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> typdef_count_get_and_inc <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> name_sum <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> prfx <span class="keyword">=</span> $Glo<span class="keyword">.</span>atsccomp_namespace_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> stropt_is_some prfx <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> prfx <span class="keyword">=</span> stropt_unsome prfx
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s%s_sum_%i"<span class="keyword">,</span> <span class="keyword">@(</span>prfx<span class="keyword">,</span> base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s_sum_%i"<span class="keyword">,</span> <span class="keyword">@(</span>base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdefmap<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> tk<span class="keyword">,</span> name_sum<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  name_sum
<span class="keyword">end</span> <span class="comment">// end of [typdefmap_add_sum]
</span>
<span class="keyword">implement</span> typdefmap_add_uni <span class="keyword">(</span>tk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> base <span class="keyword">=</span> typdef_base_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> typdef_count_get_and_inc <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> name_uni <span class="keyword">=</span> <span class="keyword">let</span> <span class="comment">// union
</span>    <span class="keyword">val</span> prfx <span class="keyword">=</span> $Glo<span class="keyword">.</span>atsccomp_namespace_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> stropt_is_some prfx <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> prfx <span class="keyword">=</span> stropt_unsome prfx
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s%s_uni_%i"<span class="keyword">,</span> <span class="keyword">@(</span>prfx<span class="keyword">,</span> base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> tostringf <span class="keyword">(</span>"%s_uni_%i"<span class="keyword">,</span> <span class="keyword">@(</span>base<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">in</span>
      string_of_strptr <span class="keyword">(</span>name<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdefmap<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> tk<span class="keyword">,</span> name_uni<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  name_uni
<span class="keyword">end</span> <span class="comment">// end of [typdefmap_add_uni]
</span>
<span class="keyword">implement</span> typdefmap_find <span class="keyword">(</span>tk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> oname <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_typdefmap<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    $Map<span class="keyword">.</span>map_search <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> tk<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> oname <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt name <span class="keyword">=&gt;</span> name
  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> tk <span class="keyword">of</span>
        <span class="keyword">|</span> TYPKEYrec _ <span class="keyword">=&gt;</span> typdefmap_add_rec <span class="keyword">(</span>tk<span class="keyword">)</span>
        <span class="keyword">|</span> TYPKEYsum _ <span class="keyword">=&gt;</span> typdefmap_add_sum <span class="keyword">(</span>tk<span class="keyword">)</span>
        <span class="keyword">|</span> TYPKEYuni _ <span class="keyword">=&gt;</span> typdefmap_add_uni <span class="keyword">(</span>tk<span class="keyword">)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">string</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> typdeflst_add <span class="keyword">(</span>tk<span class="keyword">,</span> name<span class="keyword">)</span>
    <span class="keyword">in</span>
      name
    <span class="keyword">end</span> <span class="comment">// end of [None]
</span><span class="keyword">end</span> <span class="comment">// end of [typdefmap_find]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_datcstlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">datcstlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>DATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fn</span> datcstlst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">datcstlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">datcstlst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">datcstlst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">datcstlst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">datcstlst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> DATCSTLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">~</span>DATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> DATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [datcstlst_reverse]
</span>
<span class="keyword">in</span>

<span class="keyword">implement</span> datcstlst_free <span class="keyword">(</span>s2cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>DATCSTLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> s2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> datcstlst_free s2cs
  <span class="keyword">|</span> <span class="keyword">~</span>DATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [datcstlst_free]
</span>
<span class="keyword">implement</span> the_datcstlst_add <span class="keyword">(</span>s2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_datcstlst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
 <span class="keyword">!</span>p := DATCSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_datcstlst_add]
</span>
<span class="keyword">implement</span> the_datcstlst_adds <span class="keyword">(</span>s2cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
  <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> s2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      the_datcstlst_add s2c<span class="keyword">;</span> the_datcstlst_adds s2cs
    <span class="keyword">end</span>
  <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_datcstlst_adds]
</span>
<span class="keyword">implement</span> the_datcstlst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2cs <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_datcstlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> s2cs <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := DATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> s2cs
  <span class="keyword">end</span>
<span class="keyword">in</span>
  datcstlst_reverse <span class="keyword">(</span>s2cs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_datcstlst_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_exnconlst <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">exnconlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>EXNCONLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">fn</span> exnconlst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">exnconlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">exnconlst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">exnconlst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">exnconlst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">exnconlst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> EXNCONLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">~</span>EXNCONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> EXNCONLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [exnconlst_reverse]
</span>
<span class="keyword">in</span>

<span class="keyword">implement</span> exnconlst_free <span class="keyword">(</span>d2cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d2cs <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>EXNCONLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> d2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> exnconlst_free d2cs
  <span class="keyword">|</span> <span class="keyword">~</span>EXNCONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [exnconlst_free]
</span>
<span class="keyword">implement</span> the_exnconlst_add <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_exnconlst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
 <span class="keyword">!</span>p := EXNCONLSTcons <span class="keyword">(</span>d2c<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_exnconlst_add]
</span>
<span class="keyword">implement</span> the_exnconlst_adds <span class="keyword">(</span>d2cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d2cs <span class="keyword">of</span>
  <span class="keyword">|</span> D2CONLSTcons <span class="keyword">(</span>d2c<span class="keyword">,</span> d2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      the_exnconlst_add d2c<span class="keyword">;</span> the_exnconlst_adds d2cs
    <span class="keyword">end</span>
  <span class="keyword">|</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_exnconlst_adds]
</span>
<span class="keyword">implement</span> the_exnconlst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_exnconlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> d2cs <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := EXNCONLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> d2cs
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  exnconlst_reverse <span class="keyword">(</span>d2cs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_exnconlst_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="11562"><span class="stacstdec">vartypsetlst <span class="keyword">=</span> List_vt <span class="keyword">(</span>vartypset<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> the_vartypset <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">vartypset</span><span class="keyword">&gt;</span> <span class="keyword">(</span>$Set<span class="keyword">.</span>set_nil<span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">val</span> the_vartypsetlst <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">vartypsetlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_vartypset_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> x0 <span class="keyword">=</span> <span class="keyword">!</span>the_vartypset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_vartypsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>the_vartypset := x<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p := <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">vartypsetlst</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="comment">// error reporting
</span>    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": the_vartypset_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">in</span>
  x0
<span class="keyword">end</span> <span class="comment">// end of [the_vartypset_pop]
</span>
<span class="keyword">implement</span> the_vartypset_push <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vts <span class="keyword">=</span> <span class="keyword">!</span>the_vartypset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_vartypsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>vts<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">!</span>the_vartypset := $Set<span class="keyword">.</span>set_nil
<span class="keyword">end</span> <span class="comment">// end of [the_vartypset_push]
</span>
<span class="keyword">implement</span> the_vartypset_add <span class="keyword">(</span>vtp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> _new <span class="keyword">=</span> $Set<span class="keyword">.</span>set_insert&lt;<span class="staexp">vartyp_t</span><span class="keyword">&gt;</span>
    <span class="keyword">(</span><span class="keyword">!</span>the_vartypset<span class="keyword">,</span> vtp<span class="keyword">,</span> compare_vartyp_vartyp<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>the_vartypset := _new
<span class="keyword">end</span> <span class="comment">// end of [the_vartypset_add]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">implement</span> vartypset_d2varlst_make <span class="keyword">(</span>vtps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="12978"><span class="stacstdec">d2varlst_vt <span class="keyword">=</span> List_vt d2var_t</span></a></span>
  <span class="keyword">var</span> d2vs<span class="keyword">:</span> <span class="staexp">d2varlst_vt</span> <span class="keyword">=</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="13059"><span class="stacstdec">V <span class="keyword">=</span> d2varlst_vt @ d2vs</span></a></span><span class="keyword">;</span> <span class="keyword">viewtypedef</span> <span class="staexp"><a name="13095"><span class="stacstdec">VT <span class="keyword">=</span> ptr d2vs</span></a></span>
  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">!</span>env := list_vt_cons <span class="keyword">(</span>vartyp_var_get vtp<span class="keyword">,</span> <span class="keyword">!</span>env<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [fn]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">view@ d2vs</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">&amp;</span>d2vs<span class="keyword">)</span>
<span class="keyword">in</span>
  $Lst<span class="keyword">.</span>list_vt_reverse <span class="keyword">(</span>d2vs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [vartypset_d2varlst_make]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span> vartypset_union <span class="keyword">(</span>vtps1<span class="keyword">,</span> vtps2<span class="keyword">)</span> <span class="keyword">=</span>
  $Set<span class="keyword">.</span>set_union <span class="keyword">(</span>vtps1<span class="keyword">,</span> vtps2<span class="keyword">,</span> compare_vartyp_vartyp<span class="keyword">)</span>

<span class="comment">//
</span>
<span class="keyword">implement</span> vartypset_foreach_main
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="comment">// end of [vartypset_foreach_main]
</span>
<span class="keyword">implement</span> vartypset_foreach_cloptr
  <span class="keyword">(</span>vtps<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_cloptr <span class="keyword">(</span>vtps<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">// end of [vartypset_foreach_cloptr]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span> print_vartypset <span class="keyword">(</span>vtps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">fn</span> f <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>int @ i</span></span>
    <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr i</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">let</span> <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := i + 1 <span class="keyword">in</span>
      <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> print <span class="keyword">(</span>", "<span class="keyword">)</span><span class="keyword">;</span> print_vartyp vtp
    <span class="keyword">end</span>
  <span class="comment">// end of [fn f]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>int @ i<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr i<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">view@ i</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [print_vartypset]
</span>
<span class="comment">(*
// not used
implement prerr_vartypset (vtps) = let
  var i: int = 0
  fn f (pf: !int @ i | vtp: vartyp_t, p: !ptr i): void =
    let val i = !p; val () = !p := i + 1 in
      if i &gt; 0 then prerr (", "); prerr_vartyp vtp
    end
  val () = begin
    vartypset_foreach_main {int @ i} {ptr i} (view@ i | vtps, f, &amp;i)
  end // end of [val]
in
  // empty
end // end of [prerr_vartypset]
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="14595"><span class="stacstdec">funlabsetlst <span class="keyword">=</span> List_vt <span class="keyword">(</span>funlabset<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> the_funlabset <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">funlabset</span><span class="keyword">&gt;</span> <span class="keyword">(</span>$Set<span class="keyword">.</span>set_nil<span class="keyword">)</span>
<span class="keyword">val</span> the_funlabsetlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">funlabsetlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_funlabset_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> x0 <span class="keyword">=</span> <span class="keyword">!</span>the_funlabset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlabsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>the_funlabset := x<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p := <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">funlabsetlst</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="comment">// error reporting
</span>    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": the_funlabset_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  x0
<span class="keyword">end</span> <span class="comment">// end of [the_funlabset_pop]
</span>
<span class="keyword">implement</span> the_funlabset_push <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> fls <span class="keyword">=</span> <span class="keyword">!</span>the_funlabset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlabsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>fls<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">!</span>the_funlabset := $Set<span class="keyword">.</span>set_nil
<span class="keyword">end</span> <span class="comment">// end of [the_funlabset_push]
</span>
<span class="keyword">implement</span> the_funlabset_add <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> _new <span class="keyword">=</span> <span class="keyword">begin</span>
    $Set<span class="keyword">.</span>set_insert&lt;<span class="staexp">funlab_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>the_funlabset<span class="keyword">,</span> fl<span class="keyword">,</span> compare_funlab_funlab<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">!</span>the_funlabset := _new
<span class="keyword">end</span> <span class="comment">// end of [the_funlabset_add]
</span>
<span class="keyword">implement</span> the_funlabset_mem <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Set<span class="keyword">.</span>set_member&lt;<span class="staexp">funlab_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>the_funlabset<span class="keyword">,</span> fl<span class="keyword">,</span> compare_funlab_funlab<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_funlabset_mem]
</span>
<span class="keyword">implement</span> funlabset_foreach_main
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> fls<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> fls<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="comment">// end of [funlabset_foreach_main]
</span>
<span class="keyword">implement</span> funlabset_foreach_cloptr <span class="keyword">(</span>fls<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_cloptr <span class="keyword">(</span>fls<span class="keyword">,</span> f<span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">implement</span> print_funlabset <span class="keyword">(</span>fls<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>int @ i</span></span> <span class="keyword">|</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr i</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">let</span> <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := i + 1 <span class="keyword">in</span>
      <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> print <span class="keyword">(</span>", "<span class="keyword">)</span><span class="keyword">;</span> print_funlab fl
    <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    funlabset_foreach_main <span class="staexp"><span class="keyword">{</span>int @ i<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr i<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">view@ i</span> <span class="keyword">|</span> fls<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [print_funlabset]
</span>
<span class="comment">(*
// not used
implement prerr_funlabset (fls) = let
  var i: int = 0
  fn f (pf: !int @ i | fl: funlab_t, p: !ptr i): void =
    let val i = !p; val () = !p := i + 1 in
      if i &gt; 0 then prerr (", "); prerr_funlab fl
    end
  // end of [fn f]
  val () = begin
    funlabset_foreach_main {int @ i} {ptr i} (view@ i | fls, f, &amp;i)
  end // end of [val]
in
  // empty
end // end of [prerr_funlabset]
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="17108"><span class="stacstdec">dynconset <span class="keyword">=</span> $Set<span class="keyword">.</span>set_t <span class="keyword">(</span>d2con_t<span class="keyword">)</span></span></a></span>
<span class="keyword">assume</span> <span class="staexp">dynconset_t <span class="keyword">=</span> dynconset</span>

<span class="keyword">val</span> the_dynconset <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">dynconset</span><span class="keyword">&gt;</span> <span class="keyword">(</span>$Set<span class="keyword">.</span>set_nil<span class="keyword">)</span> 

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> dynconset_foreach_main
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> d2cs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> d2cs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="comment">// end of [dynconset_foreach_main]
</span>
<span class="keyword">implement</span> the_dynconset_add <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> _new <span class="keyword">=</span> $Set<span class="keyword">.</span>set_insert&lt;<span class="staexp">d2con_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>the_dynconset<span class="keyword">,</span> d2c<span class="keyword">,</span> compare_d2con_d2con<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>the_dynconset := _new
<span class="keyword">end</span> <span class="comment">// end of [the_dynconset_add]
</span>
<span class="keyword">implement</span> the_dynconset_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_dynconset

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="17682"><span class="stacstdec">dyncstset <span class="keyword">=</span> $Set<span class="keyword">.</span>set_t <span class="keyword">(</span>d2cst_t<span class="keyword">)</span></span></a></span>
<span class="keyword">assume</span> <span class="staexp">dyncstset_t <span class="keyword">=</span> dyncstset</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="17759"><span class="stacstdec">dyncstsetlst <span class="keyword">=</span> List_vt <span class="keyword">(</span>dyncstset<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> the_dyncstset <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">dyncstset</span><span class="keyword">&gt;</span> <span class="keyword">(</span>$Set<span class="keyword">.</span>set_nil<span class="keyword">)</span> 
<span class="keyword">val</span> the_dyncstsetlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">dyncstsetlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fn</span> dyncstset_add
  <span class="keyword">(</span>d2cset_ref<span class="keyword">:</span> <span class="staexp">ref dyncstset</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> d2cst_loc_get d2c
  <span class="keyword">val</span> hit0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> d2cst_is_proof <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">then</span> hityp_proof <span class="keyword">else</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> d2cst_typ_get d2c<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span>
  <span class="keyword">val</span> hit0 <span class="keyword">=</span> hityp_normalize hit0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2cst_hityp_set <span class="keyword">(</span>d2c<span class="keyword">,</span> Some hit0<span class="keyword">)</span>
  <span class="keyword">val</span> d2cset <span class="keyword">=</span> <span class="keyword">!</span>d2cset_ref
<span class="keyword">in</span>
  <span class="keyword">!</span>d2cset_ref := $Set<span class="keyword">.</span>set_insert&lt;<span class="staexp">d2cst_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span>d2cset<span class="keyword">,</span> d2c<span class="keyword">,</span> compare_d2cst_d2cst<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_dyncstset_add]
</span>
<span class="keyword">fn</span> dyncstset_add_if
  <span class="keyword">(</span>d2cset_ref<span class="keyword">:</span> <span class="staexp">ref <span class="keyword">(</span>dyncstset<span class="keyword">)</span></span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="comment">// a template constant should not be added!
</span>  <span class="keyword">if</span> d2cst_is_temp d2c <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> d2cset <span class="keyword">=</span> <span class="keyword">!</span>d2cset_ref
    <span class="keyword">val</span> ismem <span class="keyword">=</span> <span class="keyword">begin</span>
      $Set<span class="keyword">.</span>set_member&lt;<span class="staexp">d2cst_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>d2cset_ref<span class="keyword">,</span> d2c<span class="keyword">,</span> compare_d2cst_d2cst<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    <span class="keyword">if</span> ismem <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">(*already added*)</span> <span class="keyword">else</span> dyncstset_add <span class="keyword">(</span>d2cset_ref<span class="keyword">,</span> d2c<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [dyncstset_add_if]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> dyncstset_foreach_main
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> d2cs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> $Set<span class="keyword">.</span>set_foreach_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> d2cs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="comment">// end of [dyncstset_foreach_main]
</span>
<span class="keyword">implement</span> the_dyncstset_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_dyncstset

<span class="keyword">implement</span> the_dyncstset_add_if <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="comment">// a template constant should not be added!
</span>  <span class="keyword">if</span> d2cst_is_temp d2c <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ismem <span class="keyword">=</span> <span class="keyword">begin</span>
      $Set<span class="keyword">.</span>set_member&lt;<span class="staexp">d2cst_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>the_dyncstset<span class="keyword">,</span> d2c<span class="keyword">,</span> compare_d2cst_d2cst<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    <span class="keyword">if</span> ismem <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">(*already added*)</span> <span class="keyword">else</span> dyncstset_add <span class="keyword">(</span>the_dyncstset<span class="keyword">,</span> d2c<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [the_dyncstset_add_if]
</span>
<span class="keyword">implement</span> the_dyncstsetlst_push <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> <span class="keyword">!</span>the_dyncstset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_dyncstsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>d2cs<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_dyncstset := $Set<span class="keyword">.</span>set_nil
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [the_dyncstsetlst_push]
</span>
<span class="keyword">implement</span> the_dyncstsetlst_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> <span class="keyword">!</span>the_dyncstset
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_dyncstsetlst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>d2cs1<span class="keyword">,</span> d2cslst1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>the_dyncstset := d2cs1<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">!</span>p := <span class="keyword">(</span>d2cslst1<span class="keyword">:</span> <span class="staexp">dyncstsetlst</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">(</span>err <span class="keyword">&gt;</span> 0<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": the_dyncstsetlst_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  d2cs
<span class="keyword">end</span> <span class="comment">// end of [the_dyncstsetlst_pop]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_extypelst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">extypelst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>EXTYPELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_extypelst_add <span class="keyword">(</span>name<span class="keyword">,</span> hit<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extypelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := EXTYPELSTcons <span class="keyword">(</span>name<span class="keyword">,</span> hit<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_extypelst_add]
</span>
<span class="keyword">implement</span> the_extypelst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extypelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := EXTYPELSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [the_extypelst_add]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_extvallst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">extvallst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>EXTVALLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fn</span> extvallst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">extvallst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">extvallst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">extvallst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">extvallst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">extvallst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> EXTVALLSTcons <span class="keyword">(</span>_<span class="comment">(*name*)</span><span class="keyword">,</span> _<span class="comment">(*vp*)</span><span class="keyword">,</span> <span class="keyword">!</span>xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">~</span>EXTVALLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> EXTVALLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [extvallst_reverse]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_extvallst_add <span class="keyword">(</span>name<span class="keyword">,</span> hit<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extvallst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := EXTVALLSTcons <span class="keyword">(</span>name<span class="keyword">,</span> hit<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_extvallst_add]
</span>
<span class="keyword">implement</span> the_extvallst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extvallst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := EXTVALLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> res
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  extvallst_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_extvallst_get]
</span>
<span class="keyword">implement</span> extvallst_free <span class="keyword">(</span>exts<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> exts <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>EXTVALLSTcons <span class="keyword">(</span>_<span class="comment">(*name*)</span><span class="keyword">,</span> _<span class="comment">(*vp*)</span><span class="keyword">,</span> exts<span class="keyword">)</span> <span class="keyword">=&gt;</span> extvallst_free exts
  <span class="keyword">|</span> <span class="keyword">~</span>EXTVALLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [extvallst_free]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_extcodelst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">extcodelst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>EXTCODELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fn</span> extcodelst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">extcodelst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">extcodelst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">extcodelst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">extcodelst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">extcodelst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> EXTCODELSTcons <span class="keyword">(</span>
        _<span class="comment">(*loc*)</span><span class="keyword">,</span> _<span class="comment">(*pos*)</span><span class="keyword">,</span> _<span class="comment">(*code*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_xs1
      <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>p_xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">~</span>EXTCODELSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> EXTCODELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [extcodelst_reverse]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span>
the_extcodelst_add <span class="keyword">(</span>loc<span class="keyword">,</span> pos<span class="keyword">,</span> code<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extcodelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := EXTCODELSTcons <span class="keyword">(</span>loc<span class="keyword">,</span> pos<span class="keyword">,</span> code<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_extcodelst_add]
</span>
<span class="keyword">implement</span>
the_extcodelst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_extcodelst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := EXTCODELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> res
  <span class="keyword">end</span> <span class="comment">// end of [res]
</span><span class="keyword">in</span>
  extcodelst_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_extcodelst_get]
</span>
<span class="keyword">implement</span>
extcodelst_free <span class="keyword">(</span>codes<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> codes <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>EXTCODELSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> codes<span class="keyword">)</span> <span class="keyword">=&gt;</span> extcodelst_free <span class="keyword">(</span>codes<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>EXTCODELSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [extcodelst_free]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_stafilelst <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">stafilelst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>STAFILELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">fn</span> stafilelst_reverse
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">stafilelst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stafilelst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">stafilelst</span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">stafilelst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">stafilelst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> STAFILELSTcons <span class="keyword">(</span>_fil<span class="keyword">,</span> _loadflag<span class="keyword">,</span> <span class="keyword">!</span>xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> xs1_v <span class="keyword">=</span> <span class="keyword">!</span>xs1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>xs1 := ys<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>xs1_v<span class="keyword">,</span> xs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [STAFILELSTcons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>STAFILELSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> STAFILELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [stafilelst_reverse]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_stafilelst_add <span class="keyword">(</span>fil<span class="keyword">,</span> loadflag<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_stafilelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := STAFILELSTcons <span class="keyword">(</span>fil<span class="keyword">,</span> loadflag<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_stafilelst_add]
</span>
<span class="keyword">implement</span> the_stafilelst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> res <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_stafilelst<span class="keyword">)</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := STAFILELSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  stafilelst_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_stafilelst_get]
</span>
<span class="keyword">implement</span> stafilelst_free <span class="keyword">(</span>fils<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> fils <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>STAFILELSTcons <span class="keyword">(</span>_fil<span class="keyword">,</span> _loadflag<span class="keyword">,</span> fils<span class="keyword">)</span> <span class="keyword">=&gt;</span> stafilelst_free fils
  <span class="keyword">|</span> <span class="keyword">~</span>STAFILELSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [stafilelst_free]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_dynfilelst <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">dynfilelst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>DYNFILELSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> the_dynfilelst_add <span class="keyword">(</span>fil<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_dynfilelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := DYNFILELSTcons <span class="keyword">(</span>fil<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_dynfilelst_add]
</span>
<span class="keyword">implement</span> the_dynfilelst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_dynfilelst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := DYNFILELSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [the_dynfilelst_get]
</span>
<span class="keyword">implement</span> dynfilelst_free <span class="keyword">(</span>fils<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> fils <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>DYNFILELSTcons <span class="keyword">(</span>fil<span class="keyword">,</span> fils<span class="keyword">)</span> <span class="keyword">=&gt;</span> dynfilelst_free fils
  <span class="keyword">|</span> <span class="keyword">~</span>DYNFILELSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [dynfilelst_free]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">funlab_token <span class="keyword">=</span> unit_v</span>
<span class="keyword">val</span> the_funlablst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">funlablst_vt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> funlab_pop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlablst<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> fls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">!</span>p := <span class="keyword">(</span>fls<span class="keyword">:</span> <span class="staexp">funlablst_vt</span><span class="keyword">)</span>
    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": funlab_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [funlab_pop]
</span>
<span class="keyword">implement</span> funlab_push <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlablst<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>fl<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funlab_push]
</span>
<span class="keyword">implement</span> funlab_top <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> err <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">funlab_t</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": funlab_top"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>funlab_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlablst<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
  <span class="keyword">|</span> list_vt_cons <span class="keyword">(</span>fl<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fl
    <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>  <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>err <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [funlab_top]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="26670"><span class="stacstdec">funentry <span class="keyword">=</span> <span class="keyword">'{</span>
  funentry_loc<span class="keyword">=</span> loc_t <span class="comment">// location of the function in the source
</span><span class="keyword">,</span> funentry_lab<span class="keyword">=</span> funlab_t <span class="comment">// the funentry label
</span><span class="keyword">,</span> funentry_lev<span class="keyword">=</span> int
<span class="keyword">,</span> funentry_vtps<span class="keyword">=</span> vartypset <span class="comment">// local variables
</span><span class="keyword">,</span> funentry_vtps_flag<span class="keyword">=</span> int <span class="comment">// 0/1: changeable/finalized
</span><span class="keyword">,</span> funentry_labset<span class="keyword">=</span> funlabset <span class="comment">// list of funentrys called
</span><span class="keyword">,</span> funentry_ret<span class="keyword">=</span> tmpvar_t <span class="comment">// storing the funentry return
</span><span class="keyword">,</span> funentry_body<span class="keyword">=</span> instrlst <span class="comment">// instructions of the funentry body
</span><span class="keyword">,</span> funentry_tailjoin<span class="keyword">=</span> tailjoinlst <span class="comment">// mutual tail-recursion
</span><span class="keyword">}</span></span></a></span> <span class="comment">// end of [funentry]
</span>
<span class="keyword">assume</span> <span class="staexp">funentry_t <span class="keyword">=</span> funentry</span>

<span class="keyword">in</span>

<span class="keyword">extern</span> <span class="keyword">typedef</span> <span class="staexp">"funentry_t" <span class="keyword">=</span> funentry</span>

<span class="keyword">fn</span> _funentry_make <span class="keyword">(</span>
    loc<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span>
  <span class="keyword">,</span> level<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">,</span> fls<span class="keyword">:</span> <span class="staexp">funlabset</span>
  <span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp">tmpvar_t</span>
  <span class="keyword">,</span> inss<span class="keyword">:</span> <span class="staexp">instrlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">funentry</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  funentry_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> funentry_lab<span class="keyword">=</span> fl
<span class="keyword">,</span> funentry_lev<span class="keyword">=</span> level
<span class="keyword">,</span> funentry_vtps<span class="keyword">=</span> vtps
<span class="keyword">,</span> funentry_vtps_flag<span class="keyword">=</span> 0 <span class="comment">// it needs to be finalized
</span><span class="keyword">,</span> funentry_labset<span class="keyword">=</span> fls
<span class="keyword">,</span> funentry_ret<span class="keyword">=</span> tmp_ret
<span class="keyword">,</span> funentry_body<span class="keyword">=</span> inss
<span class="keyword">,</span> funentry_tailjoin<span class="keyword">=</span> TAILJOINLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [_funentry_make]
</span>
<span class="keyword">implement</span> funentry_make
   <span class="keyword">(</span>loc<span class="keyword">,</span> fl<span class="keyword">,</span> level<span class="keyword">,</span> fls<span class="keyword">,</span> vtps<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> inss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  _funentry_make <span class="keyword">(</span>loc<span class="keyword">,</span> fl<span class="keyword">,</span> level<span class="keyword">,</span> fls<span class="keyword">,</span> vtps<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> inss<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_make]
</span>
<span class="keyword">implement</span> funentry_loc_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_loc
<span class="keyword">implement</span> funentry_lab_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_lab
<span class="keyword">implement</span> funentry_lev_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_lev
<span class="keyword">implement</span> funentry_vtps_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_vtps
<span class="keyword">implement</span> funentry_vtps_flag_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_vtps_flag
<span class="keyword">implement</span> funentry_labset_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_labset
<span class="keyword">implement</span> funentry_ret_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_ret
<span class="keyword">implement</span> funentry_body_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_body
<span class="keyword">implement</span> funentry_tailjoin_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span> entry<span class="keyword">.</span>funentry_tailjoin

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">implement</span> funentry_associate <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">let</span> <span class="keyword">val</span> fl <span class="keyword">=</span> funentry_lab_get <span class="keyword">(</span>entry<span class="keyword">)</span> <span class="keyword">in</span>
    funlab_entry_set <span class="keyword">(</span>fl<span class="keyword">,</span> Some entry<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [funentry_associate]
</span>
<span class="keyword">local</span>

<span class="comment">// transitive closure
</span><span class="keyword">fn</span> funentry_labset_get_all
  <span class="keyword">(</span>entry0<span class="keyword">:</span> <span class="staexp">funentry_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">funlabset</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> level0 <span class="keyword">=</span> funentry_lev_get <span class="keyword">(</span>entry0<span class="keyword">)</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> entry <span class="keyword">=</span> funlab_entry_get_some fl
    <span class="keyword">val</span> level <span class="keyword">=</span> funentry_lev_get <span class="keyword">(</span>entry<span class="keyword">)</span>
<span class="comment">(*
    val () = begin
      print "funentry_labset_get_all: aux: fl = "; print fl; print_newline ();
      print "funentry_labset_get_all: aux: level = "; print level; print_newline ();
    end // end of [val]
*)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> level &gt;= level0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> the_funlabset_mem fl <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">let</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_funlabset_add <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">in</span>
            funlabset_foreach_cloptr <span class="keyword">(</span>funentry_labset_get entry<span class="keyword">,</span> aux<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [let]
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> the_funlabset_add <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_funlabset_push <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> fls0 <span class="keyword">=</span> funentry_labset_get entry0
<span class="comment">(*
  val () = begin
    print "funentry_labset_get_all: fls0 = "; print_funlabset fls0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funlabset_foreach_cloptr <span class="keyword">(</span>fls0<span class="keyword">,</span> aux<span class="keyword">)</span>
<span class="keyword">in</span>
  the_funlabset_pop <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_labset_get_all]
</span>
<span class="keyword">dataviewtype</span> <span class="staexp"><a name="29758"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon <span class="staexp"><span class="keyword">(</span>l<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> int<span class="keyword">)</span></span>

<span class="keyword">in</span>

<span class="keyword">implement</span> funentry_vtps_get_all <span class="keyword">(</span>entry0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val fl0 = funentry_lab_get entry0
  val () = begin
    print "funentry_vtps_get_all: entry0 = "; print fl0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> vtps_flag <span class="keyword">=</span> funentry_vtps_flag_get <span class="keyword">(</span>entry0<span class="keyword">)</span>
  <span class="keyword">var</span> vtps_all<span class="keyword">:</span> <span class="staexp">vartypset</span> <span class="keyword">=</span> funentry_vtps_get <span class="keyword">(</span>entry0<span class="keyword">)</span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="30122"><span class="stacstdec">V <span class="keyword">=</span> vartypset @ vtps_all</span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="30161"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>vtps_all<span class="keyword">)</span></span></a></span>
  <span class="keyword">fun</span> aux
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>p<span class="keyword">,</span> level0<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> entry <span class="keyword">=</span> funlab_entry_get_some <span class="keyword">(</span>fl<span class="keyword">)</span>
    <span class="keyword">val</span> level <span class="keyword">=</span> funentry_lev_get <span class="keyword">(</span>entry<span class="keyword">)</span>
    <span class="keyword">val</span> vtps <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> level <span class="keyword">&lt;</span> level0 <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="comment">// higher-level should be handled earlier
</span>        funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">// [level = level0]
</span>        funentry_vtps_get <span class="keyword">(</span>entry<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">vartypset</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      <span class="keyword">!</span>p := $Set<span class="keyword">.</span>set_union <span class="keyword">(</span>vtps<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">,</span> compare_vartyp_vartyp<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">in</span>
    fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> vtps_flag <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> level0 <span class="keyword">=</span> funentry_lev_get <span class="keyword">(</span>entry0<span class="keyword">)</span>
      <span class="keyword">val</span> fls <span class="keyword">=</span> funentry_labset_get_all <span class="keyword">(</span>entry0<span class="keyword">)</span>
<span class="comment">(*
      val () = begin
        print "funentry_vtps_get_all: fls = "; print_funlabset fls; print_newline ()        
      end // end of [val]
*)</span>
      <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span><span class="keyword">&amp;</span>vtps_all<span class="keyword">,</span> level0<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        funlabset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">view@ vtps_all</span> <span class="keyword">|</span> fls<span class="keyword">,</span> aux<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funentry_vtps_set <span class="keyword">(</span>entry0<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funentry_vtps_flag_set <span class="keyword">(</span>entry0<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span>
<span class="comment">(*
  val () = begin
    print "funentry_vtps_get_all: vtps_all = "; print_vartypset vtps_all; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  vtps_all
<span class="keyword">end</span> <span class="comment">// end of [funentry_vtps_get_all]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="31592"><span class="stacstdec">varindmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>d2var_t<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="31645"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>

<span class="keyword">fn</span> varindmap_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">varindmap</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Map<span class="keyword">.</span>map_make <span class="staexp"><span class="keyword">{</span>d2var_t<span class="keyword">,</span> int<span class="keyword">}</span></span> <span class="keyword">(</span>compare_d2var_d2var<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">val</span> the_varindmap <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">varindmap</span><span class="keyword">&gt;</span> <span class="keyword">(</span>varindmap_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">implement</span> varindmap_find <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_varindmap<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_search <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [varindmap_find]
</span>
<span class="keyword">implement</span> varindmap_find_some <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> varindmap_find d2v <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ind <span class="keyword">=&gt;</span> ind <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": varindmap_find: d2v = "<span class="keyword">;</span> prerr_d2var d2v<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>int<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [varindmap_find_some]
</span>
<span class="keyword">implement</span> funentry_varindmap_reset <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_varindmap<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_free&lt;<span class="staexp">d2var_t</span><span class="keyword">,</span><span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := varindmap_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_varindmap_reset]
</span>
<span class="keyword">implement</span> funentry_varindmap_set <span class="keyword">(</span>vtps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> r<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_varindmap<span class="keyword">)</span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="32726"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>varindmap @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="32765"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_map<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p_l<span class="keyword">,</span> vartyp_var_get vtp<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">in</span>
    pf := <span class="keyword">(</span>pf_map<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf_map <span class="keyword">=</span> pfbox</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_map<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span>r<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="keyword">in</span>
  pf_map := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1
<span class="keyword">end</span> <span class="comment">// end of [funentry_varindmap_set]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_funlablst <span class="keyword">=</span> <span class="keyword">begin</span>
  ref_make_elt&lt;<span class="staexp">funlablst_vt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> funentry_lablst_add <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "funentry_lablst_add: fl = "; print fl; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlablst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>fl<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_lablst_add]
</span>
<span class="keyword">implement</span> funentry_lablst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funlablst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">!</span>p
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> res
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  $Lst<span class="keyword">.</span>list_vt_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_lablst_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="34101"><span class="stacstdec">loopexnlablst</span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> LOOPEXNLABLSTcons <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      tmplab_t<span class="comment">(*init*)</span><span class="keyword">,</span> tmplab_t<span class="comment">(*fini*)</span><span class="keyword">,</span> tmplab_t<span class="comment">(*cont*)</span><span class="keyword">,</span> loopexnlablst
    <span class="keyword">)</span></span>
  <span class="keyword">|</span> LOOPEXNLABLSTnil <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span>
<span class="comment">// end of [loopexnlablst]
</span>
<span class="keyword">val</span> the_loopexnlablst <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">loopexnlablst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>LOOPEXNLABLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [the_loopexnlablst]
</span>
<span class="keyword">in</span>

<span class="keyword">implement</span> loopexnlablst_push <span class="keyword">(</span>tl_init<span class="keyword">,</span> tl_fini<span class="keyword">,</span> tl_cont<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_loopexnlablst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := LOOPEXNLABLSTcons <span class="keyword">(</span>tl_init<span class="keyword">,</span> tl_fini<span class="keyword">,</span> tl_cont<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [loopexnlablst_push]
</span>
<span class="keyword">implement</span> loopexnlablst_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_loopexnlablst<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>LOOPEXNLABLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> tls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p := tls<span class="keyword">)</span>
    <span class="keyword">|</span> LOOPEXNLABLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": loopexnlablst_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [loopexnlablst_pop]
</span>
<span class="keyword">implement</span> loopexnlablst_get <span class="keyword">(</span>i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> tmplab_gen <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tmplab_t</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": loopexnlablst_get"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>tmplab_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [tmplab_gen]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_loopexnlablst<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">vbox pf <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
  <span class="keyword">|</span> LOOPEXNLABLSTcons
      <span class="keyword">(</span>_<span class="comment">(*init*)</span><span class="keyword">,</span> tl_fini<span class="keyword">,</span> tl_cont<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">if</span> i <span class="keyword">=</span> 0 <span class="keyword">then</span> tl_fini <span class="keyword">else</span> tl_cont
    <span class="keyword">end</span> <span class="comment">// end of [LOOPEXNLABLSTcons]
</span>  <span class="keyword">|</span> LOOPEXNLABLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_all</span> <span class="keyword">(</span>tmplab_gen <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [loopexnlablst_get]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{$

ats_void_type
ats_ccomp_env_funentry_vtps_set
  (ats_ptr_type entry, ats_ptr_type vtps) {
  ((funentry_t)entry)-&gt;atslab_funentry_vtps = vtps ; return ;
}

ats_void_type
ats_ccomp_env_funentry_vtps_flag_set (ats_ptr_type entry) {
  ((funentry_t)entry)-&gt;atslab_funentry_vtps_flag = 1 ; return ;
}

ats_void_type
ats_ccomp_env_funentry_tailjoin_set
  (ats_ptr_type entry, ats_ptr_type tjs) {
  ((funentry_t)entry)-&gt;atslab_funentry_tailjoin = tjs ; return ;
}

%}</span> <span class="comment">// end of [%{$]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_ccomp_env.dats] *)</span>
</pre>
</body>
</html>
