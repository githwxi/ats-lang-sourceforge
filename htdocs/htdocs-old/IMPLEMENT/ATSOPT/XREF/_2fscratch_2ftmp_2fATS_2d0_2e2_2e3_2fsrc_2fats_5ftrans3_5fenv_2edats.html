<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: December 2007
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* Mainly for handling environments during the third translation *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#include "ats_counter.cats" /* only needed for [ATS/Geizella] */
%}</span> <span class="comment">// end of [%{^]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Loc <span class="keyword">=</span> "ats_location.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Map <span class="keyword">=</span> "ats_map_lin.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_stadyncst2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_patcst2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp3.sats"</span>

<span class="keyword">staload</span> <span class="staexp">TR2 <span class="keyword">=</span> "ats_trans2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">SOL <span class="keyword">=</span> "ats_staexp2_solve.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_stadyncst2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_trans3_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_map_lin.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THISFILENAME "ats_trans3_env.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">overload</span> <span class="keyword">=</span> <span class="keyword">with</span> $Lab<span class="keyword">.</span>eq_label_label</span>
<span class="neuexp"><span class="keyword">overload</span> prerr <span class="keyword">with</span> $Loc<span class="keyword">.</span>prerr_location</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_loc_error3 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">(</span>$Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(3)"<span class="keyword">)</span>
<span class="comment">// end of [prerr_loc_error3]
</span>
<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_trans3_env)"

<span class="keyword">fn</span> prerr_loc_interror <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": INTERNAL ERROR (ats_trans3_env)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_interror]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
c3str_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  c3str_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> c3str_kind<span class="keyword">=</span> C3STRKINDnone
<span class="keyword">,</span> c3str_node<span class="keyword">=</span> C3STRprop s2e
<span class="keyword">}</span> <span class="comment">// end of [c3str_prop]
</span>
<span class="keyword">implement</span>
c3str_itmlst <span class="keyword">(</span>loc<span class="keyword">,</span> knd<span class="keyword">,</span> s3is<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  c3str_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> c3str_kind<span class="keyword">=</span> knd
<span class="keyword">,</span> c3str_node<span class="keyword">=</span> C3STRitmlst s3is
<span class="keyword">}</span> <span class="comment">// end of [c3str_itmlst]
</span>
<span class="keyword">implement</span>
c3str_metric_nat <span class="keyword">(</span>loc<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  c3str_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> c3str_kind<span class="keyword">=</span> C3STRKINDmetric_nat
<span class="keyword">,</span> c3str_node<span class="keyword">=</span> <span class="keyword">begin</span>
    C3STRprop <span class="keyword">(</span>s2exp_gte_int_int_bool <span class="keyword">(</span>s2e<span class="keyword">,</span> s2exp_int_0<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [c3str_node]
</span><span class="keyword">}</span>

<span class="keyword">implement</span>
c3str_metric_dec <span class="keyword">(</span>loc<span class="keyword">,</span> met<span class="keyword">,</span> met_bound<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  c3str_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> c3str_kind<span class="keyword">=</span> C3STRKINDmetric_dec
<span class="keyword">,</span> c3str_node<span class="keyword">=</span> C3STRprop <span class="keyword">(</span>s2exp_metlt <span class="keyword">(</span>met<span class="keyword">,</span> met_bound<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">}</span>

<span class="keyword">implement</span>
  c3str_pattern_match_exhaustiveness <span class="keyword">(</span>loc<span class="keyword">,</span> knd<span class="keyword">,</span> p2tcs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  c3str_loc<span class="keyword">=</span> loc
<span class="keyword">,</span> c3str_kind<span class="keyword">=</span> C3STRKINDpattern_match_exhaustiveness <span class="keyword">(</span>knd<span class="keyword">,</span> p2tcs<span class="keyword">)</span>
<span class="keyword">,</span> c3str_node<span class="keyword">=</span> C3STRprop <span class="keyword">(</span>s2exp_bool false<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [c3str_pattern_match_exhaustiveness]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
h3ypo_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  h3ypo_loc<span class="keyword">=</span> loc<span class="keyword">,</span> h3ypo_node <span class="keyword">=</span> H3YPOprop s2p
<span class="keyword">}</span> <span class="comment">// end of [h3ypo_prop]
</span>
<span class="keyword">implement</span>
h3ypo_bind <span class="keyword">(</span>loc<span class="keyword">,</span> s2v1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  h3ypo_loc<span class="keyword">=</span> loc<span class="keyword">,</span> h3ypo_node <span class="keyword">=</span> H3YPObind <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [h3ypo_bind]
</span>
<span class="keyword">implement</span>
h3ypo_eqeq <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  h3ypo_loc<span class="keyword">=</span> loc<span class="keyword">,</span> h3ypo_node <span class="keyword">=</span> H3YPOeqeq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [h3ypo_eqeq]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span>
<span class="staexp"><a name="4178"><span class="stacstdec">s2varbindmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>stamp_t<span class="keyword">,</span> s2exp<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> s2varbind_svs<span class="keyword">:</span> <span class="staexp">ref <span class="keyword">(</span>s2varlst<span class="keyword">)</span></span> <span class="keyword">=</span> ref_make_elt <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">val</span> s2varbind_svs_lst<span class="keyword">:</span> <span class="staexp">ref <span class="keyword">(</span>List s2varlst<span class="keyword">)</span></span> <span class="keyword">=</span> ref_make_elt <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">val</span> the_s2varbindmap <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">s2varbindmap</span><span class="keyword">&gt;</span> <span class="keyword">(</span>
  $Map<span class="keyword">.</span>map_make <span class="staexp"><span class="keyword">{</span>stamp_t<span class="keyword">,</span> s2exp<span class="keyword">}</span></span>
    <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span> <span class="keyword">=&gt;</span> $Stamp<span class="keyword">.</span>compare_stamp_stamp <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">// end of [the_s2varbindmap]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span>
the_s2varbindmap_initialize <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2varbindmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_cleanup&lt;<span class="staexp">stamp_t</span><span class="keyword">,</span> <span class="staexp">s2exp</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2varbindmap_initialize]
</span>
<span class="keyword">implement</span>
fprint_the_s2varbindmap
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pfout</span> <span class="keyword">|</span> out<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> kis<span class="keyword">:</span> <span class="staexp">List_vt <span class="keyword">@(</span>stamp_t<span class="keyword">,</span> s2exp<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> kis <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>ki<span class="keyword">,</span> kis<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
         $Stamp<span class="keyword">.</span>fprint_stamp <span class="keyword">(</span><span class="prfexp">pfout</span> <span class="keyword">|</span> out<span class="keyword">,</span> ki<span class="keyword">.</span>0<span class="keyword">)</span><span class="keyword">;</span>
         fprint_string <span class="keyword">(</span><span class="prfexp">pfout</span> <span class="keyword">|</span> out<span class="keyword">,</span>  " -&gt; "<span class="keyword">)</span><span class="keyword">;</span>
         fprint_s2exp <span class="keyword">(</span><span class="prfexp">pfout</span> <span class="keyword">|</span> out<span class="keyword">,</span> ki<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">;</span>
         fprint_string <span class="keyword">(</span><span class="prfexp">pfout</span> <span class="keyword">|</span> out<span class="keyword">,</span>  "\n"<span class="keyword">)</span><span class="keyword">;</span>
         loop <span class="keyword">(</span>out<span class="keyword">,</span> kis<span class="keyword">)</span>
       <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span>  <span class="keyword">val</span> kis <span class="keyword">=</span> $Map<span class="keyword">.</span>map_list_inf <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2varbindmap<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>out<span class="keyword">,</span> kis<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [fprint_the_s2varbindmap]
</span>
<span class="keyword">implement</span>
print_the_s2varbindmap <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_stdout</span> <span class="keyword">|</span> ptr_stdout<span class="keyword">)</span> <span class="keyword">=</span> stdout_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_the_s2varbindmap <span class="keyword">(</span><span class="prfexp">file_mode_lte_w_w</span> <span class="keyword">|</span> <span class="keyword">!</span>ptr_stdout<span class="keyword">)</span>
<span class="keyword">in</span>
  stdout_view_set <span class="keyword">(</span><span class="prfexp">pf_stdout</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [print_the_s2varbindmap]
</span>
<span class="keyword">implement</span>
prerr_the_s2varbindmap <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_stderr</span> <span class="keyword">|</span> ptr_stderr<span class="keyword">)</span> <span class="keyword">=</span> stderr_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_the_s2varbindmap <span class="keyword">(</span><span class="prfexp">file_mode_lte_w_w</span> <span class="keyword">|</span> <span class="keyword">!</span>ptr_stderr<span class="keyword">)</span>
<span class="keyword">in</span>
  stderr_view_set <span class="keyword">(</span><span class="prfexp">pf_stderr</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [prerr_the_s2varbindmap]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_s2varbindmap_add <span class="keyword">(</span>s2v<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> stamp <span class="keyword">=</span> s2var_stamp_get <span class="keyword">(</span>s2v<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "the_s2varbindmap_add: s2v = "; print s2v; print_newline ();
    print "the_s2varbindmap_add: s2e = "; print s2e; print_newline ();
    print "the_s2varbindmap_add: stamp = "; $Stamp.print_stamp stamp; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2varbindmap<span class="keyword">)</span>
<span class="comment">(*
    val () = $effmask_ref (case+ $Map.map_search (!p, stamp) of
      | ~None_vt () =&gt; () | ~Some_vt s2e0 =&gt; begin
          prerr "the_s2varbindmap_add: a binding for the static variable [";
          prerr s2v; prerr "] already exists: "; prerr_newline ();
          prerr "the_s2varbindmap_add: s2e = "; prerr s2e; prerr_newline ();
          prerr "the_s2varbindmap_add: s2e0 = "; prerr s2e0; prerr_newline ();
          $Err.abort {void} ()
        end // end of [Some_vt]
    ) // end of [val]
*)</span>
  <span class="keyword">in</span>
    $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> stamp<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">!</span>s2varbind_svs := list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> <span class="keyword">!</span>s2varbind_svs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2varbindmap_add]
</span>
<span class="keyword">implement</span>
the_s2varbindmap_find <span class="keyword">(</span>s2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "the_s2varbindmap_find: s2v = "; print s2v; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> stamp <span class="keyword">=</span> s2var_stamp_get <span class="keyword">(</span>s2v<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2varbindmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_search <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> stamp<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2varbindmap_find]
</span>
<span class="keyword">implement</span>
the_s2varbindmap_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "the_s2varbindmap_pop: the_s2varbindmap =\n"; print_the_s2varbindmap ()
  end // end of [val]
*)</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>s2varbindmap @ l</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2var_t<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> s2vs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> stamp <span class="keyword">=</span> <span class="keyword">$effmask_all</span> <span class="keyword">(</span>s2var_stamp_get s2v<span class="keyword">)</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> $Map<span class="keyword">.</span>map_remove <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> stamp<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> ans <span class="keyword">of</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p<span class="keyword">,</span> s2vs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>s2varbind_svs_lst <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2vss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2varbindmap<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p<span class="keyword">,</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>s2varbind_svs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>s2varbind_svs := s2vs<span class="keyword">;</span> <span class="keyword">!</span>s2varbind_svs_lst := s2vss
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the_s2varbindmap_pop: [s2varbind_svs_lst] is empty."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [s2varbindmap_pop]
</span>
<span class="keyword">implement</span>
the_s2varbindmap_push <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2vs <span class="keyword">=</span> <span class="keyword">!</span>s2varbind_svs
<span class="keyword">in</span>
  <span class="keyword">!</span>s2varbind_svs := list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">!</span>s2varbind_svs_lst := list_cons <span class="keyword">(</span>s2vs<span class="keyword">,</span> <span class="keyword">!</span>s2varbind_svs_lst<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2varbindmap_push]
</span>
<span class="keyword">end</span> <span class="comment">// end of [loca]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="8814"><span class="stacstdec">s2Varsetlst <span class="keyword">=</span> List_vt s2Varset_t</span></a></span>

<span class="keyword">val</span> the_s2Varset <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">s2Varset_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span>s2Varset_nil<span class="keyword">)</span>
<span class="keyword">val</span> the_s2Varsetlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">s2Varsetlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">implement</span>
the_s2Varset_env_add <span class="keyword">(</span>s2V<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">!</span>the_s2Varset := s2Varset_add <span class="keyword">(</span><span class="keyword">!</span>the_s2Varset<span class="keyword">,</span> s2V<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span>
the_s2Varset_env_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_s2Varset

<span class="keyword">implement</span>
the_s2Varset_env_get_prev <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2Varsetlst<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
  <span class="keyword">|</span> list_vt_cons <span class="keyword">(</span>sVs<span class="keyword">,</span> <span class="keyword">!</span>sVss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> sVs<span class="keyword">)</span>
  <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> s2Varset_nil<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2Varset_env_get_prev]
</span>
<span class="keyword">implement</span>
the_s2Varset_env_pop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s2Varsetlst<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>sVs<span class="keyword">,</span> sVss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>the_s2Varset := sVs<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p := <span class="keyword">(</span>sVss<span class="keyword">:</span> <span class="staexp">s2Varsetlst</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": the_s2Varset_env_pop"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// endof [if]
</span><span class="keyword">end</span> <span class="comment">// end of [the_s2Varset_env_pop]
</span>
<span class="keyword">implement</span>
the_s2Varset_env_push <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s2Varsetlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span><span class="keyword">$effmask_ref</span> <span class="keyword">(</span><span class="keyword">!</span>the_s2Varset<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_s2Varset_env_push]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2lablst_is_prefix
  <span class="keyword">(</span>s2ls1<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">,</span> s2ls2<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt s2lablst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2ls1 <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2l1<span class="keyword">,</span> s2ls1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2l1 <span class="keyword">of</span>
    <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ls2 <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2l2<span class="keyword">,</span> s2ls2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2l2 <span class="keyword">of</span>
        <span class="keyword">|</span> S2LAB0lab l2 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> l1 <span class="keyword">=</span> l2 <span class="keyword">then</span> s2lablst_is_prefix <span class="keyword">(</span>s2ls1<span class="keyword">,</span> s2ls2<span class="keyword">)</span> <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [S2LAB0lab]
</span>        <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l2<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> l1 <span class="keyword">=</span> l2 <span class="keyword">then</span>
              <span class="keyword">if</span> s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">then</span> s2lablst_is_prefix <span class="keyword">(</span>s2ls1<span class="keyword">,</span> s2ls2<span class="keyword">)</span>
              <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [S2LAB1lab]
</span>        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2LAB1lab]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// raise an exception?
</span>    <span class="keyword">end</span> <span class="comment">// end [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>s2ls2<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2lablst_is_prefix]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d2var_fin_check
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "d2var_fin_check: d2v = "; print_d2var d2v; print_newline ()
  end // end of [val]
  val os2e = d2var_typ_get (d2v)
  val () = case+ os2e of
    | Some _ =&gt; (print "d2var_fin_check: os2e = Some _"; print_newline ())
    | None _ =&gt; (print "d2var_fin_check: os2e = None _"; print_newline ())
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> d2var_typ_get <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">of</span> 
  <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d2var_fin_get <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">of</span> 
    <span class="keyword">|</span> D2VARFINsome s2e0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
        val () = begin
          print "d2var_fin_check: D2VARFINsome: d2v = "; print d2v; print_newline ();
          print "d2var_fin_check: D2VARFINsome: s2e = "; print s2e; print_newline ();
          print "d2var_fin_check: D2VARFINsome: s2e0 = "; print s2e0; print_newline ();
        end // end of [val]
*)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $SOL<span class="keyword">.</span>s2exp_tyleq_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e0<span class="keyword">)</span>
        <span class="keyword">val</span> knd <span class="keyword">=</span> C3STRKINDvarfin <span class="keyword">(</span>d2v<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_pop_sta_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> knd<span class="keyword">)</span>
      <span class="keyword">in</span>
        d2var_typ_set <span class="keyword">(</span>d2v<span class="keyword">,</span> Some s2e0<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [D2VARFINsome]
</span>    <span class="keyword">|</span> D2VARFINvbox s2e0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $SOL<span class="keyword">.</span>s2exp_tyleq_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e0<span class="keyword">)</span>
        <span class="keyword">val</span> knd <span class="keyword">=</span> C3STRKINDvarfin <span class="keyword">(</span>d2v<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_pop_sta_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> knd<span class="keyword">)</span>
      <span class="keyword">in</span>
        d2var_typ_set <span class="keyword">(</span>d2v<span class="keyword">,</span> Some s2e0<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [D2VARFINvbox]
</span>    <span class="keyword">|</span> D2VARFINdone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// handled by [funarg_varfin_check]
</span>    <span class="keyword">|</span> D2VARFINnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> s2exp_is_linear s2e <span class="keyword">then</span> <span class="keyword">begin</span>
          prerr_loc_error3 loc0<span class="keyword">;</span>
          prerr ": the linear dynamic variable ["<span class="keyword">;</span>
          prerr d2v<span class="keyword">;</span>
          prerr "] needs to be consumed but it is preserved with the type ["<span class="keyword">;</span>
          prerr s2e<span class="keyword">;</span>
          prerr "] instead."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">in</span>
        <span class="keyword">if</span> d2var_lin_get d2v &gt;= 0 <span class="keyword">then</span> d2var_typ_set <span class="keyword">(</span>d2v<span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [D2VARFINnone] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d2var_fin_get <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> D2VARFINdone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// handled by [funarg_varfin_check]
</span>    <span class="keyword">|</span> D2VARFINnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the linear dynamic variable ["<span class="keyword">;</span> prerr d2v<span class="keyword">;</span>
        prerr "] needs to be preserved but it is consumed instead."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None]
</span><span class="keyword">end</span> <span class="comment">(* end of [d2var_fin_check] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">d2varset_env_token <span class="keyword">=</span> unit_v</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="13646"><span class="stacstdec">ld2vsitem</span></a></span> <span class="keyword">=</span> <span class="comment">// local dynamic variables
</span>  <span class="keyword">|</span> LD2VSITEMlam <span class="comment">// marker for nonlinear lambda
</span>  <span class="keyword">|</span> LD2VSITEMllam <span class="keyword">of</span> <span class="staexp">ref <span class="keyword">(</span>d2varlst<span class="keyword">)</span></span> <span class="comment">// marker for linear lambda
</span>  <span class="keyword">|</span> LD2VSITEMset <span class="keyword">of</span> <span class="staexp">d2varset_t</span> <span class="comment">// local dynamic variable set
</span><span class="comment">// end of [ld2vsitem]
</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="13889"><span class="stacstdec">ld2vsitemlst <span class="keyword">=</span> List ld2vsitem</span></a></span>

<span class="keyword">val</span> the_ld2vs <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">d2varset_t</span><span class="keyword">&gt;</span> <span class="keyword">(</span>d2varset_nil<span class="keyword">)</span>
<span class="keyword">val</span> the_ld2vsitems <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">ld2vsitemlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">implement</span>
the_d2varset_env_add <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">!</span>the_ld2vs := d2varset_add <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_add]
</span>
<span class="keyword">implement</span>
the_d2varset_env_adds <span class="keyword">(</span>d2vs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">!</span>the_ld2vs := d2varset_adds <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> d2vs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_adds]
</span>
<span class="keyword">implement</span>
the_d2varset_env_add_p2at <span class="keyword">(</span>p2t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> d2vs <span class="keyword">=</span> d2varlst_of_d2varlstord <span class="keyword">(</span>p2t<span class="keyword">.</span>p2at_dvs<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>the_ld2vs := d2varset_adds <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> d2vs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_add_p2at]
</span>
<span class="keyword">implement</span>
the_d2varset_env_add_p2atlst <span class="keyword">(</span>p2ts<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> p2ts <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>p2t<span class="keyword">,</span> p2ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      the_d2varset_env_add_p2at p2t<span class="keyword">;</span> the_d2varset_env_add_p2atlst p2ts
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [the_d2varset_env_add_p2atlst]  
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_d2varset_env_print_ld2vs <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">)</span>
<span class="keyword">implement</span>
the_d2varset_env_prerr_ld2vs <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">)</span>

<span class="keyword">fn</span> the_d2varset_env_get_llam_ld2vs
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">d2varlst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">!</span>the_ld2vsitems <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>LD2VSITEMllam r<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">!</span>r
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": the_d2varset_env_get_llam_ld2vs"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>d2varlst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_get_llam_ld2vs]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_d2varset_env_pop_lam <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> ld2vsitems_var<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span> <span class="keyword">=</span> list_nil
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">!</span>the_ld2vsitems <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ld2vsitem<span class="keyword">,</span> ld2vsitems<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> ld2vsitem <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ld2vsitems_var := ld2vsitems
      <span class="keyword">|</span> LD2VSITEMllam _ <span class="keyword">=&gt;</span> ld2vsitems_var := ld2vsitems
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> ld2vsitems_var <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ld2vsitem<span class="keyword">,</span> ld2vsitems<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> ld2vsitem <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMset ld2vs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">!</span>the_ld2vs := ld2vs<span class="keyword">;</span> <span class="keyword">!</span>the_ld2vsitems := ld2vsitems
        <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the_d2varset_env_pop_lam"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_pop_lam]
</span>
<span class="keyword">implement</span>
the_d2varset_env_push_lam <span class="keyword">(</span>lin<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> marker <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">if</span> lin <span class="keyword">&gt;</span> 0 <span class="keyword">then</span>
      <span class="keyword">(</span>LD2VSITEMllam <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">d2varlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_nil<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">ld2vsitem</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_ld2vsitems :=
     list_cons <span class="keyword">(</span>marker<span class="keyword">,</span> list_cons <span class="keyword">(</span>LD2VSITEMset <span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> <span class="keyword">!</span>the_ld2vsitems<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_ld2vs := d2varset_nil
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_push_lam]
</span>
<span class="keyword">implement</span>
the_d2varset_env_pop_let <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> <span class="keyword">!</span>the_ld2vsitems <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ld2vsitem<span class="keyword">,</span> ld2vsitems<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> ld2vsitem <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMset ld2vs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">!</span>the_ld2vs := ld2vs<span class="keyword">;</span> <span class="keyword">!</span>the_ld2vsitems := ld2vsitems
        <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the_d2varset_env_pop_let"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_pop_let]
</span>
<span class="keyword">implement</span>
the_d2varset_env_push_let <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_ld2vsitems :=
    list_cons <span class="keyword">(</span>LD2VSITEMset <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">!</span>the_ld2vsitems<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_ld2vs := d2varset_nil <span class="comment">// it is not a constructor
</span><span class="keyword">in</span>
  <span class="keyword">(</span><span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_push_let]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_d2varset_env_pop_try <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  the_d2varset_env_pop_lam <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_pop_try]
</span>
<span class="keyword">implement</span>
the_d2varset_env_push_try <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  the_d2varset_env_push_lam <span class="keyword">(</span>0<span class="comment">(*lin*)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_push_try]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_d2varset_env_d2var_is_lam_local <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>itms<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> itms <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>itm<span class="keyword">,</span> itms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> itm <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
      <span class="keyword">|</span> LD2VSITEMllam _ <span class="keyword">=&gt;</span> false
      <span class="keyword">|</span> LD2VSITEMset dvs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d2varset_ismem <span class="keyword">(</span>dvs<span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">then</span> true <span class="keyword">else</span> aux <span class="keyword">(</span>itms<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [LD2VSITEMset]
</span>      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": d2var_is_lam_local: aux: d2v = "<span class="keyword">;</span> prerr d2v<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>bool<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> ans<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> d2varset_ismem <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> ans <span class="keyword">then</span> true <span class="keyword">else</span> aux <span class="keyword">(</span><span class="keyword">!</span>the_ld2vsitems<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_d2var_is_lam_local]
</span>
<span class="keyword">implement</span>
the_d2varset_env_d2var_is_llam_local <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>itms<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> itms <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>itm<span class="keyword">,</span> itms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> itm <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
      <span class="keyword">|</span> LD2VSITEMllam r <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">!</span>r := list_cons <span class="keyword">(</span>d2v<span class="keyword">,</span> <span class="keyword">!</span>r<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>itms<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [LD2VSITEMllam]
</span>      <span class="keyword">|</span> LD2VSITEMset dvs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d2varset_ismem <span class="keyword">(</span>dvs<span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">then</span> true <span class="keyword">else</span> aux <span class="keyword">(</span>itms<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [LD2VSITEMset]
</span>      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": d2var_is_llam_local: aux: d2v = "<span class="keyword">;</span> prerr d2v<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>bool<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> ans<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> d2varset_ismem <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "d2var_is_llam_local: the_ld2vs = ";
    print (!the_ld2vs);
    print_newline ();
    print "d2var_is_llam_local: d2v = ";
    print (d2v);
    print_newline ();
    print "d2var_is_llam_local: ans = ";
    print (ans);
    print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> ans <span class="keyword">then</span> true <span class="keyword">else</span> aux <span class="keyword">(</span><span class="keyword">!</span>the_ld2vsitems<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_d2var_is_llam_local]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
the_d2varset_env_check <span class="keyword">(</span>loc0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "the_d2varset_env_check: enter"; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  d2varset_foreach_cloptr
    <span class="keyword">(</span><span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> <span class="keyword">lam</span> <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> d2var_fin_check <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_check]
</span>
<span class="keyword">implement</span>
the_d2varset_env_check_llam <span class="keyword">(</span>loc0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> auxCK <span class="keyword">(</span>d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d2var_typ_get <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> s2exp_is_nonlin s2e <span class="keyword">then</span> d2var_typ_set <span class="keyword">(</span>d2v<span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">begin</span>
          prerr_loc_error3 loc0<span class="keyword">;</span>
          prerr ": the linear dynamic variable ["<span class="keyword">;</span> prerr d2v<span class="keyword">;</span>
          prerr "] needs to be consumed but it is preserved with the type ["<span class="keyword">;</span>
          prerr s2e<span class="keyword">;</span>
          prerr "] instead."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [auxCK]
</span>  <span class="keyword">fun</span> auxlst <span class="keyword">(</span>d2vs<span class="keyword">:</span> <span class="staexp">d2varlst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d2vs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>d2v<span class="keyword">,</span> d2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>auxCK d2v<span class="keyword">;</span> auxlst d2vs<span class="keyword">)</span> <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [auxlst]
</span><span class="keyword">in</span>
  auxlst <span class="keyword">(</span>the_d2varset_env_get_llam_ld2vs <span class="keyword">(</span>loc0<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_check_llam]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
the_d2varset_env_find_view <span class="keyword">(</span>s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">exception</span> NotFound <span class="comment">// local exception
</span>  <span class="keyword">exception</span> Found <span class="keyword">of</span> <span class="staexp">d2var_t</span> <span class="comment">// local exception
</span>  <span class="keyword">typedef</span> <span class="staexp"><a name="21061"><span class="stacstdec">env_t <span class="keyword">=</span> s2exp</span></a></span><span class="keyword">;</span> <span class="keyword">val</span> env <span class="keyword">=</span> s2e0 <span class="comment">// closure environment
</span>  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d2var_typ_get d2v <span class="keyword">of</span>
    <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> s2exp_syneq <span class="keyword">(</span>env<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">$raise</span> Found <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// this happens if [d2v] is linear and consumed
</span>  <span class="keyword">end</span> <span class="comment">// end of [f]
</span>  <span class="keyword">fun</span> loop <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> ld2vsitems<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env_t</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ld2vsitems <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ld2vsitem<span class="keyword">,</span> ld2vsitems<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> ld2vsitem <span class="keyword">of</span>
          <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> NotFound <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">|</span> LD2VSITEMllam _<span class="comment">(*r_d2vs*)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// continue search
</span>          <span class="keyword">|</span> LD2VSITEMset dvs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>env_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> dvs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [LD2VSITEMset]
</span>        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span>
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> ld2vsitems<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  <span class="keyword">try</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>env_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vsitems<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">in</span>
    None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">with</span>
    <span class="keyword">|</span> <span class="keyword">~</span>NotFound <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Found d2v <span class="keyword">=&gt;</span> Some_vt d2v
  <span class="comment">// end of [try]
</span><span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_find_view]
</span>
<span class="keyword">implement</span>
the_d2varset_env_find_viewat <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">exception</span> NotFound <span class="comment">// local exception
</span>  <span class="keyword">exception</span> Found <span class="keyword">of</span> <span class="staexp">d2varset_env_find_viewat_t</span> <span class="comment">// local exception
</span>  <span class="keyword">dataviewtype</span> <span class="staexp"><a name="22572"><span class="stacstdec">env_vt</span></a></span> <span class="keyword">=</span> ENVcon <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>s2exp<span class="keyword">,</span> s2lablst<span class="keyword">)</span></span>

  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env_vt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d2var_typ_get d2v <span class="keyword">of</span>
    <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf s2e <span class="keyword">in</span>
        <span class="keyword">case+</span> un_s2exp_at_viewt0ype_addr_view s2e <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2ts2a <span class="comment">(*type/addr*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span>s2r<span class="keyword">,</span> s2ls_ft<span class="keyword">)</span> <span class="keyword">=</span> s2exp_addr_normalize s2ts2a<span class="keyword">.</span>1
            <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">=</span> env
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
              <span class="keyword">|</span> _ <span class="keyword">when</span> s2exp_syneq <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                <span class="keyword">case+</span> s2lablst_is_prefix <span class="keyword">(</span>s2ls_ft<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">of</span>
                <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2ls_bk<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                    <span class="keyword">$raise</span> Found <span class="keyword">@(</span>d2v<span class="keyword">,</span> s2ts2a<span class="keyword">.</span>0<span class="keyword">,</span> s2ts2a<span class="keyword">.</span>1<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span>
                  <span class="keyword">end</span>
                <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
                <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>              <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span>
          <span class="keyword">in</span>
            fold@ env
          <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [let]
</span>    <span class="keyword">|</span> None <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// this happens if [d2v] is linear and consumed
</span>  <span class="keyword">end</span> <span class="comment">// end of [f]
</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span>
    <span class="keyword">|</span> ld2vsitems<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env_vt</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ld2vsitems <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ld2vsitem<span class="keyword">,</span> ld2vsitems<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> ld2vsitem <span class="keyword">of</span>
          <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> NotFound <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">|</span> LD2VSITEMllam _<span class="comment">(*r_d2vs*)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// continue search
</span>          <span class="keyword">|</span> LD2VSITEMset dvs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>env_vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> dvs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [LD2VSITEMset]
</span>        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span>
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> ld2vsitems<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  <span class="keyword">try</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="comment">// cloenv
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>env_vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vsitems<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">in</span>
    None_vt <span class="keyword">(</span><span class="keyword">)</span>  
  <span class="keyword">end</span> <span class="keyword">with</span>
    <span class="keyword">|</span> <span class="keyword">~</span>NotFound <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Found x <span class="keyword">=&gt;</span> Some_vt x
  <span class="comment">// end of [try]
</span><span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_find_viewat]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
the_d2varset_env_stbefitemlst_save <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> sbis<span class="keyword">:</span> <span class="staexp">stbefitemlst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="24761"><span class="stacstdec">sbisptr <span class="keyword">=</span> ptr sbis</span></a></span>
  <span class="keyword">viewdef</span> <span class="staexp"><a name="24790"><span class="stacstdec">V <span class="keyword">=</span> stbefitemlst @ sbis</span></a></span>
  <span class="keyword">fun</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> sbis<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>sbisptr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> lin <span class="keyword">=</span> d2var_lin_get d2v
<span class="comment">(*
    val () = begin
      print "the_d2varset_env_stbefitemlst_save: f: d2v = "; print d2v; print_newline ();
      print "the_d2varset_env_stbefitemlst_save: f: lin = "; print lin; print_newline ();
    end // end of [val]
*)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> lin &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="keyword">val</span> sbi <span class="keyword">=</span>
      stbefitem_make <span class="keyword">(</span>d2v<span class="keyword">,</span> lin<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">!</span>sbis := list_cons <span class="keyword">(</span>sbi<span class="keyword">,</span> <span class="keyword">!</span>sbis<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">(* end of [f] *)</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">ld2vsitemlst</span><span class="keyword">,</span> sbis<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>sbisptr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> x <span class="keyword">of</span>
      <span class="keyword">|</span> LD2VSITEMlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">|</span> LD2VSITEMllam _ <span class="keyword">=&gt;</span> aux <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> sbis<span class="keyword">)</span>
      <span class="keyword">|</span> LD2VSITEMset dvs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
            d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>sbisptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> dvs<span class="keyword">,</span> f<span class="keyword">,</span> sbis<span class="keyword">)</span>
          <span class="keyword">end</span>
        <span class="keyword">in</span>
          aux <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> sbis<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* LD2VSITEMset *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> view@ sbis</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    d2varset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>sbisptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vs<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">&amp;</span>sbis<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>the_ld2vsitems<span class="keyword">,</span> <span class="keyword">&amp;</span>sbis<span class="keyword">)</span>
<span class="keyword">in</span>
  view@ sbis := pf<span class="keyword">;</span> sbis
<span class="keyword">end</span> <span class="comment">// end of [the_d2varset_env_stbefitemlst_save]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> the_s3itemlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">s3itemlst_vt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">val</span> the_s3itemlstlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">s3itemlstlst_vt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">implement</span>
trans3_env_s3itemlst_copy <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s3itemlst<span class="keyword">)</span>
<span class="keyword">in</span>
  $Lst<span class="keyword">.</span>list_vt_copy__boxed <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_Env_s3itemlst_copy]
</span>
<span class="keyword">implement</span>
trans3_env_s3itemlst_get <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s3itemlst<span class="keyword">)</span>
  <span class="keyword">val</span> s3is <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  s3is
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_s3itemlst_get]
</span>
<span class="keyword">implement</span>
trans3_env_s3itemlst_set <span class="keyword">(</span>s3is<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s3itemlst<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p := s3is<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> list_vt_cons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> Some_vt s3is<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_s3itemlst_set]
</span>
<span class="keyword">implement</span>
trans3_env_add_svar <span class="keyword">(</span>s2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s3itemlst<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMsvar s2v<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_svar]
</span>
<span class="keyword">implement</span>
trans3_env_add_svarlst <span class="keyword">(</span>s2vs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>s3is<span class="keyword">:</span> <span class="staexp">s3itemlst_vt</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2var_t<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">s3itemlst_vt</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> s2vs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>list_vt_cons <span class="keyword">(</span>S3ITEMsvar s2v<span class="keyword">,</span> s3is<span class="keyword">)</span><span class="keyword">,</span> s2vs<span class="keyword">)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s3is
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_s3itemlst<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p := aux <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> s2vs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_svarlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_add_sVar <span class="keyword">(</span>s2V<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2Varset_env_add <span class="keyword">(</span>s2V<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
 <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMsVar s2V<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_sVar]
</span>
<span class="keyword">implement</span>
trans3_env_add_sVarlst <span class="keyword">(</span>s2Vs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>s3is<span class="keyword">:</span> <span class="staexp">s3itemlst_vt</span><span class="keyword">,</span> s2Vs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2Var_t<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">s3itemlst_vt</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2Vs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2V<span class="keyword">,</span> s2Vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">$effmask_all</span> <span class="keyword">(</span>the_s2Varset_env_add s2V<span class="keyword">)</span><span class="keyword">;</span>
        aux <span class="keyword">(</span>list_vt_cons <span class="keyword">(</span>S3ITEMsVar s2V<span class="keyword">,</span> s3is<span class="keyword">)</span><span class="keyword">,</span> s2Vs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s3is
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := aux <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> s2Vs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_sVarlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_add_cstr <span class="keyword">(</span>c3t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMcstr c3t<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_cstr]
</span>
<span class="keyword">implement</span>
trans3_env_add_cstr_ref <span class="keyword">(</span>r<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMcstr_ref r<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_cstr_ref]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
trans3_env_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2p<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Etyleq <span class="keyword">(</span>knd<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">when</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $SOL<span class="keyword">.</span>s2exp_tyleq_solve <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_pop_sta_and_add_none <span class="keyword">(</span>loc<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2Etyleq when ...]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      trans3_env_add_cstr <span class="keyword">(</span>c3str_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="comment">// end of [trans3_env_add_prop]
</span>
<span class="keyword">implement</span>
trans3_env_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2ps <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2p<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span>
    <span class="keyword">in</span>
      trans3_env_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2ps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [trans3_env_add_proplst]
</span>
<span class="keyword">implement</span>
trans3_env_add_proplstlst <span class="keyword">(</span>loc<span class="keyword">,</span> s2pss<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2pss <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2ps<span class="keyword">,</span> s2pss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2ps<span class="keyword">)</span>
    <span class="keyword">in</span>
      trans3_env_add_proplstlst <span class="keyword">(</span>loc<span class="keyword">,</span> s2pss<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [trans3_env_add_proplstlst]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
trans3_env_add_eqeq
  <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_add_eqeq: s2e1 = "; print_s2exp s2e1; print_newline ();
    print "trans3_env_add_eqeq: s2e2 = "; print_s2exp s2e2; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_eqeq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
<span class="keyword">in</span>
  trans3_env_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_eqeq]
</span>
<span class="keyword">implement</span>
trans3_env_add_tyleq
  <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_tyleq <span class="keyword">(</span>0<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="comment">// already tried
</span><span class="keyword">in</span>
  trans3_env_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_add_tyleq]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_hypo_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_hypo_add_prop: s2p = "; print s2p; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> h3p <span class="keyword">=</span> h3ypo_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMhypo h3p<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_prop]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2ps <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2p<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      trans3_env_hypo_add_prop <span class="keyword">(</span>loc<span class="keyword">,</span> s2p<span class="keyword">)</span><span class="keyword">;</span>
      trans3_env_hypo_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2ps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [trans3_env_hypo_add_proplst]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_bind
  <span class="keyword">(</span>loc<span class="keyword">,</span> s2v1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_hypo_add_bind: s2v1 = "; print s2v1; print_newline ();
    print "trans3_env_hypo_add_bind: s2e2 = "; print s2e2; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> os2e1 <span class="keyword">=</span> the_s2varbindmap_find <span class="keyword">(</span>s2v1<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> os2e1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      trans3_env_hypo_add_eqeq <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
    <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2varbindmap_add <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">val</span> h3p <span class="keyword">=</span> h3ypo_bind <span class="keyword">(</span>loc<span class="keyword">,</span> s2v1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
    <span class="keyword">in</span>
      <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMhypo h3p<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_bind]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_eqeq <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_hypo_add_eqeq: s2e1 = "; print s2e1; print_newline ();
    print "trans3_env_hypo_add_eqeq: s2e2 = "; print s2e2; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> h3p <span class="keyword">=</span> h3ypo_eqeq <span class="keyword">(</span>loc<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMhypo h3p<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_eqeq]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_s2qualst <span class="keyword">(</span>loc<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2vpss <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vps<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      trans3_env_add_svarlst s2vps<span class="keyword">.</span>0<span class="keyword">;</span>
      trans3_env_hypo_add_proplst <span class="keyword">(</span>loc<span class="keyword">,</span> s2vps<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">;</span>
      trans3_env_hypo_add_s2qualst <span class="keyword">(</span>loc<span class="keyword">,</span> s2vpss<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_s2qualst]
</span>
<span class="comment">// used in [trans3_env_hypo_add_p2atcstlstlst]
</span><span class="keyword">fn</span> trans3_env_hypo_add_disj <span class="keyword">(</span>s3iss<span class="keyword">:</span> <span class="staexp">s3itemlstlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMdisj s3iss<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_p2atcstlstlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="32574"><span class="dyncstdec">print_the_s3itemlst <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "ats_trans3_env_print_the_s3itemlst"
<span class="comment">// end of [print_the_s3itemlst]
</span>
<span class="keyword">implement</span>
print_the_s3itemlst <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>print_s3itemlst_vt <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [print_the_s3itemlst]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="32859"><span class="dyncstdec">print_the_s3itemlstlst <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "ats_trans3_env_print_the_s3itemlstlst"
<span class="comment">// end of [print_the_s3itemlstlst]
</span>  
<span class="keyword">implement</span>
print_the_s3itemlstlst <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> ps<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlstlst
<span class="keyword">in</span>
  <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>print_s3itemlstlst_vt <span class="keyword">!</span>ps<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [print_the_s3itemlstlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="33190"><span class="dyncstdec">free_the_s3itemlst <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "ats_trans3_env_free_the_s3itemlst"
<span class="comment">// end of [free_the_s3itemlst]
</span>
<span class="keyword">implement</span>
free_the_s3itemlst <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
  <span class="keyword">val</span> s3is <span class="keyword">=</span> <span class="keyword">!</span>p
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> $Lst<span class="keyword">.</span>list_vt_free__boxed <span class="keyword">(</span>s3is<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [free_the_s3itemlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_pop_sta <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = $effmask_ref begin
    print "trans3_env_pop_sta: the_s3itemlst = "; print_the_s3itemlst (); print_newline ();
    print "trans3_env_pop_sta: the_s3itemlstlst = "; print_the_s3itemlstlst (); print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2varbindmap_pop <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2Varset_env_pop <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> s3is1 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> ps<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlstlst
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>ps <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>s3is<span class="keyword">,</span> s3iss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>ps := <span class="keyword">(</span>s3iss<span class="keyword">:</span> <span class="staexp">s3itemlstlst_vt</span><span class="keyword">)</span><span class="keyword">;</span> s3is<span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>ps := list_vt_nil <span class="staexp"><span class="keyword">{</span>s3itemlst_vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> err := 1<span class="keyword">;</span> list_vt_nil <span class="staexp"><span class="keyword">{</span>s3item<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span>  <span class="keyword">end</span><span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s3itemlst_vt</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": trans3_env_pop_sta: [the_s3itemlstlst] is empty."<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
  <span class="keyword">val</span> s3is0 <span class="keyword">=</span> <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p := s3is1<span class="keyword">)</span>
<span class="keyword">in</span>
  s3is0
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_pop_sta]
</span>
<span class="keyword">implement</span>
trans3_env_pop_sta_and_add <span class="keyword">(</span>loc<span class="keyword">,</span> cstrknd<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s3is0 <span class="keyword">=</span> trans3_env_pop_sta <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> c3t <span class="keyword">=</span> c3str_itmlst <span class="keyword">(</span>loc<span class="keyword">,</span> cstrknd<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_vt_reverse_list s3is0<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_pop_sta_and_add: c3t = "; print c3t; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>S3ITEMcstr c3t<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_pop_sta_and_add]
</span>
<span class="keyword">implement</span>
trans3_env_pop_sta_and_add_none <span class="keyword">(</span>loc<span class="keyword">)</span> <span class="keyword">=</span>
 trans3_env_pop_sta_and_add <span class="keyword">(</span>loc<span class="keyword">,</span> C3STRKINDnone <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of ...
</span>
<span class="keyword">implement</span>
trans3_env_pop_sta_and_free <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s3is <span class="keyword">=</span> trans3_env_pop_sta <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> $Lst<span class="keyword">.</span>list_vt_free__boxed <span class="keyword">(</span>s3is<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_pop_sta_and_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "trans3_env_push_sta: the_s3itemlst = "; print_the_s3itemlst (); print_newline ();
    print "trans3_env_push_sta: the_s3itemlstlst = "; print_the_s3itemlstlst (); print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">var</span> s3is0<span class="keyword">:</span> <span class="staexp">s3itemlst_vt?</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlst
  <span class="keyword">in</span>
    s3is0 := <span class="keyword">!</span>p<span class="keyword">;</span> <span class="keyword">!</span>p := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> ps<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr the_s3itemlstlst
  <span class="keyword">in</span>
    <span class="keyword">!</span>ps := list_vt_cons <span class="keyword">(</span>s3is0<span class="keyword">,</span> <span class="keyword">!</span>ps<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  the_s2varbindmap_push <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> the_s2Varset_env_push <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_push_sta]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_Var_make_srt <span class="keyword">(</span>loc<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2V <span class="keyword">=</span> s2Var_make_srt <span class="keyword">(</span>loc<span class="keyword">,</span> s2t<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2Var_sVarset_set <span class="keyword">(</span>s2V<span class="keyword">,</span> the_s2Varset_env_get_prev <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  trans3_env_add_sVar <span class="keyword">(</span>s2V<span class="keyword">)</span><span class="keyword">;</span> s2exp_Var <span class="keyword">(</span>s2V<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_Var_make_srt]
</span>
<span class="keyword">implement</span>
s2exp_Var_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> s2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_Var_make_var: s2v = "; print s2v; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> s2V <span class="keyword">=</span> s2Var_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> s2v<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2Var_sVarset_set <span class="keyword">(</span>s2V<span class="keyword">,</span> the_s2Varset_env_get_prev <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "s2exp_Var_make_var: s2V = "; print s2V; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  trans3_env_add_sVar <span class="keyword">(</span>s2V<span class="keyword">)</span><span class="keyword">;</span> s2exp_Var <span class="keyword">(</span>s2V<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_Var_make_var]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2qua_instantiate_and_add: s2vs = "; print s2vs; print_newline ();
    print "s2qua_instantiate_and_add: s2ps = "; print s2ps; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> sub <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stasub_t</span> <span class="keyword">=</span>
      <span class="keyword">case+</span> s2vs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
          val () = begin
            print "s2qua_instantiate_and_add: aux: s2v = "; print s2v; print_newline ()
          end
*)</span>
          <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_Var_make_var <span class="keyword">(</span>loc0<span class="keyword">,</span> s2v<span class="keyword">)</span>
        <span class="keyword">in</span>
          stasub_add <span class="keyword">(</span>aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">,</span> s2v<span class="keyword">,</span> s2e<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> stasub_nil
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> s2ps_new <span class="keyword">=</span> s2explst_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2ps<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "s2qua_instantiate_and_add: s2ps_new = "; print s2ps_new; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ps_new<span class="keyword">)</span><span class="keyword">;</span> sub
<span class="keyword">end</span> <span class="comment">// end of [s2qua_instantiate_and_add]
</span>
<span class="keyword">implement</span>
s2qua_instantiate_with_and_add
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> loc_arg<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">stasub_t</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">,</span> list_cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2t_s2v <span class="keyword">=</span> s2var_srt_get s2v <span class="keyword">and</span> s2t_s2e <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// sort-checking
</span>          <span class="keyword">if</span> s2t_s2e &lt;= s2t_s2v <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            prerr_loc_error3 loc_arg<span class="keyword">;</span>
            prerr ": the static expression ["<span class="keyword">;</span>
            prerr s2e<span class="keyword">;</span>
            prerr "] is of sort ["<span class="keyword">;</span>
            prerr s2t_s2e<span class="keyword">;</span>
            prerr "] but is expected to be of sort ["<span class="keyword">;</span>
            prerr s2t_s2v<span class="keyword">;</span>
            prerr "]."<span class="keyword">;</span>
            prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
            $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span>
      <span class="keyword">in</span>
        stasub_add <span class="keyword">(</span>aux <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span><span class="keyword">,</span> s2v<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons, list_cons]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>list_nil _<span class="keyword">,</span> list_nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> stasub_nil
    <span class="keyword">|</span> <span class="keyword">(</span>list_cons _<span class="keyword">,</span> list_nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the static application needs more arguments."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>stasub_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons, list_nil]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>list_nil _<span class="keyword">,</span> list_cons _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the static application needs less arguments."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>stasub_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_nil, list_cons]
</span>  <span class="keyword">val</span> sub <span class="keyword">=</span> aux <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span>
  <span class="keyword">val</span> s2ps_new <span class="keyword">=</span> s2explst_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2ps<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ps_new<span class="keyword">)</span>
<span class="keyword">in</span>
  sub
<span class="keyword">end</span> <span class="comment">// end of [s2qua_instantiate_with_and_add]
</span>
<span class="keyword">implement</span>
s2qua_hypo_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">@(</span>sub<span class="keyword">,</span> s2vs_new<span class="keyword">)</span> <span class="keyword">=</span> stasub_extend_svarlst <span class="keyword">(</span>stasub_nil<span class="keyword">,</span> s2vs<span class="keyword">)</span>
  <span class="keyword">val</span> s2ps_new <span class="keyword">=</span> s2explst_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2ps<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_svarlst s2vs_new
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ps_new<span class="keyword">)</span>
<span class="keyword">in</span>
  sub
<span class="keyword">end</span> <span class="comment">// end of [s2qua_hypo_instantiate_and_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_metric_instantiate <span class="keyword">(</span>loc0<span class="keyword">,</span> d2vopt<span class="keyword">,</span> met<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d2vopt <span class="keyword">of</span>
  <span class="keyword">|</span> Some d2v_stamp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> met_bound <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> metric_env_get d2v_stamp <span class="keyword">of</span>
        <span class="keyword">|</span> Some s2es <span class="keyword">=&gt;</span> s2es <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
            prerr ": s2exp_metric_instantiate: no metric bound"<span class="keyword">;</span>
            prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>            
            $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2explst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [None]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2explst</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length_compare <span class="keyword">(</span>met<span class="keyword">,</span> met_bound<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert_errmsg_bool1 <span class="keyword">(</span>sgn <span class="keyword">=</span> 0<span class="keyword">,</span>
        "INTERNAL ERROR: s2exp_metric_instantiate: metric length mismatch"
      <span class="keyword">)</span> <span class="comment">// end of [assert_errmsg]
</span>    <span class="keyword">in</span>
      trans3_env_add_metric_dec <span class="keyword">(</span>loc0<span class="keyword">,</span> met<span class="keyword">,</span> met_bound<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_metric_instantiate]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_exi_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_exi_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eexi]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end of [s2exp_exi_instantiate_all]
</span>
<span class="keyword">implement</span>
s2exp_exi_instantiate_one <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eexi]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the type ["<span class="keyword">;</span> prerr s2e0<span class="keyword">;</span>
        prerr "] is expected to be existentially quantified."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_exi_instantiate_one]
</span>
<span class="keyword">implement</span>
s2exp_exi_instantiate_seq <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> loc_arg<span class="keyword">,</span> s2es0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> <span class="keyword">begin</span>
          s2qua_instantiate_with_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> loc_arg<span class="keyword">,</span> s2es0<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">in</span>
        s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eexi]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the type ["<span class="keyword">;</span> prerr s2e0<span class="keyword">;</span>
        prerr "] is expected to be existentially quantified."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_exi_instantiate_seq]
</span>
<span class="keyword">implement</span>
s2exp_exi_instantiate_sexparg <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2a<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2a<span class="keyword">.</span>s2exparg_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2EXPARGall <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_exi_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
  <span class="keyword">|</span> S2EXPARGone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_exi_instantiate_one <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
  <span class="keyword">|</span> S2EXPARGseq s2es <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s2exp_exi_instantiate_seq <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2a<span class="keyword">.</span>s2exparg_loc<span class="keyword">,</span> s2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2EXPARGseq]
</span><span class="comment">// end of [s2exp_exi_instantiate_sexparg]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
funarg_varfin_check <span class="keyword">(</span>loc0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    $Loc.print_location loc0; print ": funarg_varfin_check"; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">fn</span> auxvar
    <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
    val () = begin
      print "funarg_varfin_check: auxvar: d2v (bef) = "; print_d2var d2v; print_newline ()
    end // end of [val]
*)</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d2var_view_get d2v <span class="keyword">of</span>
      <span class="keyword">|</span> D2VAROPTsome d2v <span class="keyword">=&gt;</span> d2v <span class="keyword">|</span> D2VAROPTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> d2v
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">d2var_t</span>
<span class="comment">(*
    val () = begin
      print "funarg_varfin_check: auxvar: d2v (aft) = "; print_d2var d2v; print_newline ()
    end // end of [val]
*)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_fin_check <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span>
  <span class="keyword">in</span>
    d2var_fin_set <span class="keyword">(</span>d2v<span class="keyword">,</span> D2VARFINdone <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="comment">// done!
</span>  <span class="keyword">end</span> <span class="comment">// end of [auxvar]
</span>
  <span class="keyword">fun</span> auxpatlst
    <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> p3ts<span class="keyword">:</span> <span class="staexp">p3atlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> p3ts <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>p3t<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> p3t<span class="keyword">.</span>p3at_node <span class="keyword">of</span>
          <span class="keyword">|</span> P3Tvar <span class="keyword">(</span>_<span class="comment">(*refknd*)</span><span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> auxvar <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span>
          <span class="keyword">|</span> P3Tas <span class="keyword">(</span>_<span class="comment">(*refknd*)</span><span class="keyword">,</span> d2v<span class="keyword">,</span> _<span class="comment">(*p3at*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> auxvar <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        auxpatlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p3ts<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [auxpatlst]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> the_lamloop_env_arg_get loc0 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt p3ts <span class="keyword">=&gt;</span> auxpatlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": funarg_varfin_check: no argument(s)."<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">(* end of [funarg_varfin_check] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_wth_instantiate <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_wth_instantiate: s2e0 = "; print s2e0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">fn</span> aux <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
    <span class="keyword">,</span> refval<span class="keyword">:</span> <span class="staexp">int</span>
    <span class="keyword">,</span> p3t<span class="keyword">:</span> <span class="staexp">p3at</span>
    <span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> p3t<span class="keyword">.</span>p3at_node <span class="keyword">of</span>
      <span class="keyword">|</span> P3Tvar <span class="keyword">(</span>_<span class="comment">(*refknd*)</span><span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> d2v
      <span class="keyword">|</span> P3Tas <span class="keyword">(</span>_<span class="comment">(*refknd*)</span><span class="keyword">,</span> d2v<span class="keyword">,</span> _<span class="comment">(*p2at*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> d2v
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_interror loc0<span class="keyword">;</span>
          prerr ": s2exp_wth_instantiate: aux: p3t = "<span class="keyword">;</span> prerr p3t<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>d2var_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">d2var_t</span> <span class="comment">// end of [val]
</span><span class="comment">(*
    val () = begin
      print "s2exp_wth_instantiate: aux: refval = "; print refval; print_newline ();
      print "s2exp_wth_instantiate: aux: d2v = "; print d2v; print_newline ();
      print "s2exp_wth_instantiate: aux: s2e = "; print s2e; print_newline ();
    end // end of [val]
*)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> refval <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> refval <span class="keyword">=</span> 0 <span class="keyword">=&gt;</span> d2var_fin_set <span class="keyword">(</span>d2v<span class="keyword">,</span> D2VARFINsome s2e<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="comment">(* refval = 1 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> d2v_view <span class="keyword">=</span> d2var_view_get_some <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="keyword">val</span> s2e_addr <span class="keyword">=</span> d2var_addr_get_some <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="keyword">val</span> s2e_at <span class="keyword">=</span> s2exp_at_viewt0ype_addr_view <span class="keyword">(</span>s2e<span class="keyword">,</span> s2e_addr<span class="keyword">)</span>
      <span class="keyword">in</span>
        d2var_fin_set <span class="keyword">(</span>d2v_view<span class="keyword">,</span> D2VARFINsome s2e_at<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">fun</span> auxlst <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> p3ts<span class="keyword">:</span> <span class="staexp">p3atlst</span><span class="keyword">,</span> wths2es<span class="keyword">:</span> <span class="staexp">wths2explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> wths2es <span class="keyword">of</span>
    <span class="keyword">|</span> WTHS2EXPLSTcons_some <span class="keyword">(</span>refval<span class="keyword">,</span> s2e<span class="keyword">,</span> wths2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert_errmsg_bool1 <span class="keyword">(</span>
          $Lst<span class="keyword">.</span>list_is_cons p3ts<span class="keyword">,</span> "INTERNAL ERROR: s2exp_wth_instantiate"
        <span class="keyword">)</span> <span class="comment">// end of [assert_errmsg]
</span>        <span class="keyword">val+</span> list_cons <span class="keyword">(</span>p3t<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">=</span> p3ts
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> refval<span class="keyword">,</span> p3t<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">in</span>
        auxlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p3ts<span class="keyword">,</span> wths2es<span class="keyword">)</span>     
      <span class="keyword">end</span> <span class="comment">// end of [WTHS2EXPLSTcons_some]
</span>    <span class="keyword">|</span> WTHS2EXPLSTcons_none <span class="keyword">(</span>wths2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
        val () = assert_errmsg_bool1 (
          $Lst.list_is_cons p3ts, "INTERNAL ERROR: s2exp_wth_instantiate"
        ) // end of [assert_errmsg]
*)</span>
        <span class="keyword">val-</span> list_cons <span class="keyword">(</span>p3t<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">=</span> p3ts
      <span class="keyword">in</span>
        auxlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p3ts<span class="keyword">,</span> wths2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [WTHS2EXPLSTcons_none]
</span>    <span class="keyword">|</span> WTHS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_exi_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Ewth <span class="keyword">(</span>s2e<span class="keyword">,</span> wths2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> p3ts <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> the_lamloop_env_arg_get <span class="keyword">(</span>loc0<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt p3ts <span class="keyword">=&gt;</span> p3ts <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            prerr_loc_interror loc0<span class="keyword">;</span>
            prerr ": s2exp_wth_instantiate"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
            $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>p3atlst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">p3atlst</span>
    <span class="keyword">in</span>
      auxlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p3ts<span class="keyword">,</span> wths2es<span class="keyword">)</span><span class="keyword">;</span> s2e
    <span class="keyword">end</span> <span class="comment">// end of [S2Ewth]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end of [s2exp_wth_instantiate]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_uni_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Euni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_uni_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Euni]
</span>    <span class="keyword">|</span> S2Emetfn <span class="keyword">(</span>d2vopt<span class="keyword">,</span> s2es_met<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2exp_metric_instantiate <span class="keyword">(</span>loc0<span class="keyword">,</span> d2vopt<span class="keyword">,</span> s2es_met<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_uni_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Emetfn]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end [s2exp_uni_instantiate_all]
</span>
<span class="keyword">implement</span>
s2exp_uni_instantiate_one <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Euni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Euni]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the type ["<span class="keyword">;</span> prerr s2e0<span class="keyword">;</span>
        prerr "] is expected to be universally quantified."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_uni_instantiate_one]
</span>
<span class="keyword">implement</span>
s2exp_uni_instantiate_seq <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> loc_arg<span class="keyword">,</span> s2es0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Euni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> <span class="keyword">begin</span>
          s2qua_instantiate_with_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> loc_arg<span class="keyword">,</span> s2es0<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Euni]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the type ["<span class="keyword">;</span> prerr s2e0<span class="keyword">;</span>
        prerr "] is expected to be universally quantified."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_uni_instantiate_seq]
</span>
<span class="keyword">implement</span>
s2exp_uni_instantiate_sexparg <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2a<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2a<span class="keyword">.</span>s2exparg_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2EXPARGone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_uni_instantiate_one <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
  <span class="keyword">|</span> S2EXPARGall <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_uni_instantiate_all <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
  <span class="keyword">|</span> S2EXPARGseq s2es <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s2exp_uni_instantiate_seq <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2a<span class="keyword">.</span>s2exparg_loc<span class="keyword">,</span> s2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2EXPARGseq]
</span><span class="comment">// end of [s2exp_uni_instantiate_sexparg]
</span>
<span class="keyword">implement</span>
s2exp_uni_instantiate_sexparglst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2as<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2as <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2a<span class="keyword">,</span> s2as<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_uni_instantiate_sexparg <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2a<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_uni_instantiate_sexparglst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2as<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0
<span class="comment">// end of [s2exp_uni_instantiate_sexparglst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_template_instantiate <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vpss<span class="keyword">,</span> ts2ess<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux0 <span class="keyword">(</span>sub<span class="keyword">:</span> <span class="staexp">stasub_t</span><span class="keyword">,</span> s2vpss<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2qualst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2vpss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vps<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        list_cons <span class="keyword">(</span><span class="keyword">@(</span>s2vps<span class="keyword">.</span>0<span class="keyword">,</span> s2explst_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2vps<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> aux0 <span class="keyword">(</span>sub<span class="keyword">,</span> s2vpss<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux0]
</span>  <span class="keyword">fun</span> aux1 <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> subs<span class="keyword">:</span> <span class="staexp">List stasub_t</span><span class="keyword">,</span> s2vpss<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>List stasub_t<span class="keyword">,</span> s2exp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2vpss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vps<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sub <span class="keyword">=</span> s2qua_instantiate_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vps<span class="keyword">.</span>0<span class="keyword">,</span> s2vps<span class="keyword">.</span>1<span class="keyword">)</span>
        <span class="keyword">val</span> s2vpss <span class="keyword">=</span> aux0 <span class="keyword">(</span>sub<span class="keyword">,</span> s2vpss<span class="keyword">)</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> list_cons <span class="keyword">(</span>sub<span class="keyword">,</span> subs<span class="keyword">)</span><span class="keyword">,</span> s2vpss<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>$Lst<span class="keyword">.</span>list_reverse subs<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux1]
</span>  <span class="keyword">fun</span> aux2
    <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> subs<span class="keyword">:</span> <span class="staexp">List stasub_t</span><span class="keyword">,</span> s2vpss<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">,</span>
     ts2ess<span class="keyword">:</span> <span class="staexp">tmps2explstlst</span><span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>List stasub_t<span class="keyword">,</span> s2exp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> ts2ess <span class="keyword">of</span>
    <span class="keyword">|</span> TMPS2EXPLSTLSTcons <span class="keyword">(</span>loc<span class="keyword">,</span> s2es<span class="keyword">,</span> ts2ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2vpss <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vps<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> sub <span class="keyword">=</span> <span class="keyword">begin</span>
            s2qua_instantiate_with_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vps<span class="keyword">.</span>0<span class="keyword">,</span> s2vps<span class="keyword">.</span>1<span class="keyword">,</span>loc<span class="keyword">,</span>  s2es<span class="keyword">)</span>
          <span class="keyword">end</span>
          <span class="keyword">val</span> s2vpss <span class="keyword">=</span> aux0 <span class="keyword">(</span>sub<span class="keyword">,</span> s2vpss<span class="keyword">)</span>
          <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> list_cons <span class="keyword">(</span>sub<span class="keyword">,</span> subs<span class="keyword">)</span><span class="keyword">,</span> s2vpss<span class="keyword">,</span> ts2ess<span class="keyword">,</span> s2e<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_error3 loc0<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s2exp_template_instantiate"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": too many template arguments are given."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span>      <span class="keyword">end</span> <span class="comment">// end of [TMPS2EMPLSTLSTcons]
</span>    <span class="keyword">|</span> TMPS2EXPLSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> subs<span class="keyword">,</span> s2vpss<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux2]
</span><span class="keyword">in</span>
  aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> s2vpss<span class="keyword">,</span> ts2ess<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_template_instantiate]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_absuni_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_absuni_and_add: before: s2e0 = "; print s2e0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> s2vss2pss2e <span class="keyword">=</span> s2exp_absuni s2e0
<span class="comment">(*
  val () = begin
    print "s2exp_absuni_and_add: after: s2vs = "; print s2vss2pss2e.0;
    print_newline ()
  end // end of [val]
  val () = begin
    print "s2exp_absuni_and_add: before: s2e = "; print s2vss2pss2e.2;
    print_newline ()
  end // end of [val]
*)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> s2vss2pss2e<span class="keyword">.</span>0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2varlst_sVarset_set <span class="keyword">(</span>s2vs<span class="keyword">,</span> the_s2Varset_env_get <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_svarlst <span class="keyword">(</span>s2vss2pss2e<span class="keyword">.</span>0<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vss2pss2e<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="keyword">in</span>
  s2vss2pss2e<span class="keyword">.</span>2
<span class="keyword">end</span> <span class="comment">// end of [s2exp_absuni_and_add]
</span>
<span class="keyword">implement</span>
s2exp_opnexi_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_opnexi_and_add: before: s2e0 = "; print s2e0;
    print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> s2vss2pss2e <span class="keyword">=</span> s2exp_opnexi s2e0
<span class="comment">(*
  val () = begin
    print "s2exp_opnexi_and_add: after: s2vs = "; print s2vss2pss2e.0;
    print_newline ()
  end // end of [val]
  val () = begin
    print "s2exp_opnexi_and_add: after: s2e = "; print s2vss2pss2e.2;
    print_newline ()
  end // end of [val]
*)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> s2vss2pss2e<span class="keyword">.</span>0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2varlst_sVarset_set <span class="keyword">(</span>s2vs<span class="keyword">,</span> the_s2Varset_env_get <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_svarlst <span class="keyword">(</span>s2vs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vss2pss2e<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="keyword">in</span>
  s2vss2pss2e<span class="keyword">.</span>2
<span class="keyword">end</span> <span class="comment">// end of [s2exp_opnexi_and_add]
</span>
<span class="keyword">implement</span>
s2explst_opnexi_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2vss2pss2es <span class="keyword">=</span> s2explst_opnexi s2es0
<span class="comment">//
</span>  <span class="keyword">val</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> s2vss2pss2es<span class="keyword">.</span>0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2varlst_sVarset_set <span class="keyword">(</span>s2vs<span class="keyword">,</span> the_s2Varset_env_get <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_svarlst <span class="keyword">(</span>s2vs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vss2pss2es<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="keyword">in</span>
  s2vss2pss2es<span class="keyword">.</span>2
<span class="keyword">end</span> <span class="comment">// end of [s2exp_opnexi_and_add]
</span>
<span class="keyword">implement</span>
s2expopt_opnexi_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> os2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> os2e0 <span class="keyword">of</span>
  <span class="keyword">|</span> Some s2e0 <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>s2exp_opnexi_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2expopt_opnexi_and_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_hypo_add_p2atcst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tc<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">let</span> <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_opnexi_and_add <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> p2tc <span class="keyword">of</span>
    <span class="keyword">|</span> P2TCany <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> P2TCbool b <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> un_s2exp_bool_bool_t0ype s2e0 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            $SOL<span class="keyword">.</span>s2exp_hypo_equal_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_arg<span class="keyword">,</span> s2exp_bool b<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [P2TCbool]
</span>    <span class="keyword">|</span> P2TCchar c <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> un_s2exp_bool_bool_t0ype s2e0 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            $SOL<span class="keyword">.</span>s2exp_hypo_equal_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_arg<span class="keyword">,</span> s2exp_char c<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [P2TCchar]
</span>    <span class="keyword">|</span> P2TCcon <span class="keyword">(</span>d2c<span class="keyword">,</span> p2tcs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Edatcontyp <span class="keyword">(</span>d2c1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> <span class="keyword">(</span>d2c &lt;&gt; d2c1<span class="keyword">)</span> <span class="keyword">then</span> trans3_env_hypo_add_prop <span class="keyword">(</span>loc0<span class="keyword">,</span> s2exp_bool false<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Edatcontyp]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">@(</span>s2vpss_d2c<span class="keyword">,</span> s2e_d2c<span class="keyword">)</span> <span class="keyword">=</span> $TR2<span class="keyword">.</span>p1at_con_instantiate <span class="keyword">(</span>loc0<span class="keyword">,</span> d2c<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span>s2es_fun_arg<span class="keyword">,</span> s2e_fun_res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
            <span class="keyword">case+</span> s2e_d2c<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
            <span class="keyword">|</span> S2Efun <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> s2es<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">@(</span>s2es<span class="keyword">,</span> s2e<span class="keyword">)</span>
            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                prerr ": tran3_env_hypo_add_p2atcst: P2TCcon"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span><span class="keyword">@(</span>s2explst<span class="keyword">,</span> s2exp<span class="keyword">)</span><span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_]
</span>          <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2explst<span class="keyword">,</span> s2exp<span class="keyword">)</span></span>
<span class="comment">(*
          val () = begin
            print "trans3_env_hypo_add_p2atcst: s2vpss_d2c = "; print_s2qualst s2vpss_d2c; print_newline ()
          end // end of [val]
          val () = begin
            print "trans3_env_hypo_add_p2atcst: s2es_arg_res = "; print_s2explst s2es_fun_arg; print_newline ()
          end // end of [val]
          val () = begin
            print "trans3_env_hypo_add_p2atcst: s2e_fun_res = "; print_s2exp s2e_fun_res; print_newline ()
          end // end of [val]
*)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vpss_d2c<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
            <span class="keyword">fun</span> aux <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2vpss<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
              <span class="keyword">case+</span> s2vpss <span class="keyword">of</span>
              <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2vps<span class="keyword">,</span> s2vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                  trans3_env_add_svarlst s2vps<span class="keyword">.</span>0<span class="keyword">;</span>
                  trans3_env_hypo_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vps<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">;</span>
                  aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2vpss<span class="keyword">)</span>
                <span class="keyword">end</span>
              <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">}</span> <span class="comment">// end of [where]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $SOL<span class="keyword">.</span>s2exp_hypo_equal_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_fun_res<span class="keyword">,</span> s2e0<span class="keyword">)</span>
        <span class="keyword">in</span>
          trans3_env_hypo_add_p2atcstlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es_fun_arg<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [P2TCcon]
</span>    <span class="keyword">|</span> P2TCempty _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> P2TCfloat _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> P2TCint i <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> un_s2exp_int_int_t0ype s2e0 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e_arg <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            $SOL<span class="keyword">.</span>s2exp_hypo_equal_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_arg<span class="keyword">,</span> s2exp_intinf i<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [P2TCint]
</span>    <span class="keyword">|</span> P2TCintc xs <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> un_s2exp_int_int_t0ype s2e0 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e_arg <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>intinflst_of_intinfset xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">List intinf_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
            <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_neq_int_int_bool <span class="keyword">(</span>s2e_arg<span class="keyword">,</span> s2exp_intinf x<span class="keyword">)</span>
              <span class="keyword">in</span>
                trans3_env_hypo_add_prop <span class="keyword">(</span>loc0<span class="keyword">,</span> s2p<span class="keyword">)</span><span class="keyword">;</span> aux xs
              <span class="keyword">end</span>
            <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">}</span> <span class="comment">// end of [Some_vt]
</span>      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [P2TCintc]
</span>    <span class="keyword">|</span> P2TCrec <span class="keyword">(</span>_<span class="keyword">,</span> lp2tcs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
        <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            trans3_env_hypo_add_labp2atcstlst <span class="keyword">(</span>loc0<span class="keyword">,</span> lp2tcs<span class="keyword">,</span> ls2es<span class="keyword">)</span>
          <span class="keyword">end</span>
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [P2TCrec]
</span>    <span class="keyword">|</span> P2TCstring _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_p2atcst]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_p2atcstlst
  <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> p2tcs<span class="keyword">:</span> <span class="staexp">p2atcstlst</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> p2tcs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>p2tc<span class="keyword">,</span> p2tcs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2es <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          trans3_env_hypo_add_p2atcst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tc<span class="keyword">,</span> s2e<span class="keyword">)</span><span class="keyword">;</span>
          aux <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 1
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> s2es <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> 1 <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0
      <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> err <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_loc_interror loc0<span class="keyword">;</span>
    prerr ": trans3_env_hypo_add_p2atcstlst"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_p2atcstlst]
</span>
<span class="keyword">implement</span>
trans3_env_hypo_add_labp2atcstlst
  <span class="keyword">(</span>loc0<span class="keyword">,</span> lp2tcs<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> lp2tcs<span class="keyword">:</span> <span class="staexp">labp2atcstlst</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> lp2tcs <span class="keyword">of</span>
    <span class="keyword">|</span> LABP2ATCSTLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> p2tc<span class="keyword">,</span> lp2tcs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
      <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          trans3_env_hypo_add_p2atcst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tc<span class="keyword">,</span> s2e<span class="keyword">)</span><span class="keyword">;</span>
          aux <span class="keyword">(</span>loc0<span class="keyword">,</span> lp2tcs<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>      <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 1
      <span class="keyword">end</span> <span class="comment">// end of [LABP2ATCSTLSTcons]
</span>    <span class="keyword">|</span> LABP2ATCSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> ls2es <span class="keyword">of</span> LABS2EXPLSTcons _ <span class="keyword">=&gt;</span> 1 <span class="keyword">|</span> LABS2EXPLSTnil _ <span class="keyword">=&gt;</span> 0
      <span class="keyword">end</span> <span class="comment">// end of [LABP2ATCSTLSTnil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> err <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> lp2tcs<span class="keyword">,</span> ls2es<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr_loc_interror loc0<span class="keyword">;</span>
    prerr ": trans3_env_hypo_add_labp2atcstlst"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_labp2atcstlst]
</span>
<span class="comment">//
</span>
<span class="comment">// for adding sequentiality assumption
</span><span class="keyword">implement</span>
trans3_env_hypo_add_p2atcstlstlst
  <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcss<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>p2tcss<span class="keyword">:</span> <span class="staexp">p2atcstlstlst</span><span class="keyword">,</span> s3iss<span class="keyword">:</span> <span class="staexp">List_vt <span class="keyword">(</span>s3itemlst<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">s3itemlstlst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> p2tcss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>p2tcs<span class="keyword">,</span> p2tcss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_p2atcstlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es<span class="keyword">)</span>
        <span class="keyword">val</span> s3is <span class="keyword">=</span> trans3_env_pop_sta <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> s3is <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_vt_reverse_list s3is
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>p2tcss<span class="keyword">,</span> list_vt_cons <span class="keyword">(</span>s3is<span class="keyword">,</span> s3iss<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Lst<span class="keyword">.</span>list_vt_reverse_list <span class="keyword">(</span>s3iss<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  trans3_env_hypo_add_disj <span class="keyword">(</span>aux <span class="keyword">(</span>p2tcss<span class="keyword">,</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [trans3_env_hypo_add_p2atcstlstlst]
</span>
<span class="comment">//
</span>
<span class="comment">// for checking termination metric being decreasing
</span><span class="keyword">implement</span>
trans3_env_add_metric_dec <span class="keyword">(</span>loc<span class="keyword">,</span> met<span class="keyword">,</span> met_bound<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">let</span> <span class="keyword">val</span> c3t <span class="keyword">=</span> c3str_metric_dec <span class="keyword">(</span>loc<span class="keyword">,</span> met<span class="keyword">,</span> met_bound<span class="keyword">)</span> <span class="keyword">in</span>
    trans3_env_add_cstr c3t
  <span class="keyword">end</span>
<span class="comment">// end of [trans3_env_add_metric]
</span>
<span class="comment">// for checking pattern matching exhaustiveness
</span><span class="keyword">implement</span>
trans3_env_add_p2atcstlstlst_false
  <span class="keyword">(</span>loc0<span class="keyword">,</span> casknd<span class="keyword">,</span> p2tcss<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=</span> aux p2tcss <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>p2tcss<span class="keyword">:</span> <span class="staexp">p2atcstlstlst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> p2tcss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>p2tcs<span class="keyword">,</span> p2tcss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_push_sta <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_hypo_add_p2atcstlst <span class="keyword">(</span>loc0<span class="keyword">,</span> p2tcs<span class="keyword">,</span> s2es<span class="keyword">)</span>
        <span class="keyword">val</span> c3t <span class="keyword">=</span> <span class="keyword">begin</span>
          c3str_pattern_match_exhaustiveness <span class="keyword">(</span>loc0<span class="keyword">,</span> casknd<span class="keyword">,</span> p2tcs<span class="keyword">)</span>
        <span class="keyword">end</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_cstr <span class="keyword">(</span>c3t<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_pop_sta_and_add_none <span class="keyword">(</span>loc0<span class="keyword">)</span><span class="keyword">;</span>
      <span class="keyword">in</span>
        aux p2tcss
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [trans3_env_add_p2atcstlstlst_false]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
trans3_env_initialize <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2varbindmap_initialize <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Bool_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Bool_bool_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Char_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Char_char_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Int_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Int_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Uint_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Uint_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Lint_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Lint_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ulint_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ulint_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Size_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Size_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ssize_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ssize_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ptr_type<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Ptr_addr_type<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Strbuf_t0ype<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Strbuf_int_int_t0ype<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_sup_add <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> s2c0 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>String_type<span class="keyword">)</span>
    <span class="keyword">val</span> s2c1 <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>String_int_type<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clo_viewt0ype_viewt0ype_assume <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cloptr_viewt0ype_viewtype_assume <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cloref_t0ype_type_assume <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> crypt_viewt0ype_viewt0ype_assume <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> sizeof_viewt0ype_int_assume <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">}</span> <span class="comment">// end of [trans3_env_initilize]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_trans3_env.sats] *)</span>
</pre>
</body>
</html>
