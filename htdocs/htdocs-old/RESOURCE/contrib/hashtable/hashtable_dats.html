<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** A hashtable implementation
** where buckets are represented as linked lists
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">//
</span><span class="comment">// This implementation is intended for being used in functional programming
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="458"><span class="stacstdec">hash <span class="keyword">(</span>key<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> ulint</span></span></A>
<span class="keyword">typedef</span> <span class="staexp"><A name="508"><span class="stacstdec">eq <span class="keyword">(</span>key<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> bool</span></span></A>

<span class="keyword">abstype</span> <span class="staexp"><A name="561"><span class="stacstdec">hashtbl_t</span></span></A> <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype+<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="645"><span class="dyncstdec">equal_key_key <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span> equal_key_key <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=</span> eq <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="801"><span class="dyncstdec">hash_key <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> hash<span class="keyword">:</span> <span class="staexp">hash key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ulint</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span> hash_key <span class="keyword">(</span>x<span class="keyword">,</span> hash<span class="keyword">)</span> <span class="keyword">=</span> hash <span class="keyword">(</span>x<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="923"><span class="dyncstdec">hashtbl_size
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">size_t</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="1012"><span class="dyncstdec">hashtbl_total
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">size_t</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1129"><span class="dyncstdec">hashtbl_make <span class="keyword">(</span>hash<span class="keyword">:</span> <span class="staexp">hash key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1232"><span class="dyncstdec">hashtbl_make_hint <span class="keyword">(</span>hash<span class="keyword">:</span> <span class="staexp">hash key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">,</span> hint<span class="keyword">:</span> <span class="staexp">size_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1350"><span class="dyncstdec">hashtbl_search <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt itm</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1456"><span class="dyncstdec">hashtbl_insert_err <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt itm</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1573"><span class="dyncstdec">hashtbl_remove_err <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt itm</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1679"><span class="dyncstdec">hashtbl_clear <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1741"><span class="dyncstdec">hashtbl_free_err
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1833"><span class="dyncstdec">hashtbl_free_exn
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1970"><span class="dyncstdec">hashtbl_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="2121"><span class="dyncstdec">hashtbl_foreach_cloref
  <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span>key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>
<span class="comment">// end of [hashtbl_foreach_cloref__nvw]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><A name="2293"><span class="stacstdec">chain <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype+<span class="keyword">,</span> int<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> CHAINcons <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> CHAINnil <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">)</span></span>
<span class="comment">// end of [chain]
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="2465"><span class="stacstdec">chain <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">]</span> chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span></span></A>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="2539"><span class="stacstdec">chain0 <span class="keyword">=</span> chain <span class="keyword">(</span>void<span class="keyword">,</span> void<span class="keyword">,</span> 0<span class="keyword">)</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">stadef</span> <span class="staexp"><A name="2599"><span class="stacstdec">chainsz <span class="keyword">=</span> sizeof <span class="keyword">(</span>chain0<span class="keyword">)</span></span></span></A>
<span class="keyword">extern</span> <span class="keyword">typedef</span> <span class="staexp">"chain0" <span class="keyword">=</span> chain0</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> chain_free <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>kis<span class="keyword">:</span> <span class="staexp">chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> kis <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>CHAINcons <span class="keyword">(</span>_<span class="comment">(*key*)</span><span class="keyword">,</span> _<span class="comment">(*itm*)</span><span class="keyword">,</span> kis<span class="keyword">)</span> <span class="keyword">=&gt;</span> chain_free <span class="keyword">(</span>kis<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>CHAINnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [chain_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> chain_search <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>kis<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>chain <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt itm</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> kis <span class="keyword">of</span>
  <span class="keyword">|</span> CHAINcons <span class="keyword">(</span>k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>kis1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> keq <span class="keyword">=</span> equal_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> eq<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> keq <span class="keyword">then</span> <span class="keyword">(</span>fold@ kis<span class="keyword">;</span> Some_vt i<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> chain_search <span class="keyword">(</span><span class="keyword">!</span>kis1<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">)</span>
      <span class="keyword">in</span>
        fold@ kis<span class="keyword">;</span> ans
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> CHAINnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ kis<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [chain_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> chain_insert <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>kis<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>chain <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n<span class="keyword">)</span> &gt;&gt; chain <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n+1<span class="keyword">)</span></span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
  kis := CHAINcons <span class="keyword">(</span>k<span class="keyword">,</span> i<span class="keyword">,</span> kis<span class="keyword">)</span>
<span class="comment">// end of [chain_insert]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">stadef</span> <span class="staexp"><A name="3620"><span class="stacstdec">b2i <span class="keyword">=</span> int_of_bool</span></span></A>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> chain_remove <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>kis<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>chain <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n<span class="keyword">)</span> &gt;&gt; chain <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n-b2i b<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>b<span class="keyword">:</span>bool <span class="keyword">|</span> b2i b &lt;= n<span class="keyword">]</span> option_vt <span class="keyword">(</span>itm<span class="keyword">,</span> b<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> kis <span class="keyword">of</span>
  <span class="keyword">|</span> CHAINcons <span class="keyword">(</span>k<span class="keyword">,</span> <span class="keyword">!</span>i<span class="keyword">,</span> <span class="keyword">!</span>kis1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> keq <span class="keyword">=</span> equal_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> eq<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> keq <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>i <span class="keyword">and</span> kis1 <span class="keyword">=</span> <span class="keyword">!</span>kis1
      <span class="keyword">in</span>
        free@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">{</span>n<span class="keyword">}</span> <span class="keyword">(</span>kis<span class="keyword">)</span><span class="keyword">;</span> kis := kis1<span class="keyword">;</span> Some_vt i
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> chain_remove&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>n-1<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">!</span>kis1<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">)</span>
      <span class="keyword">in</span>
        fold@ kis<span class="keyword">;</span> ans
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> CHAINnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ kis</span> <span class="keyword">in</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [nil]
</span><span class="keyword">end</span> <span class="comment">// end of [chain_remove]
</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  chain_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> kis<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> kis <span class="keyword">of</span>
  <span class="keyword">|</span> CHAINcons <span class="keyword">(</span>k<span class="keyword">,</span> <span class="keyword">!</span>i<span class="keyword">,</span> <span class="keyword">!</span>kis1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> k<span class="keyword">,</span> <span class="keyword">!</span>i<span class="keyword">)</span><span class="keyword">;</span> chain_foreach_clo <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>kis1<span class="keyword">,</span> f<span class="keyword">)</span><span class="keyword">;</span> fold@ kis
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> CHAINnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ kis
<span class="keyword">end</span> <span class="comment">// end of [chain_foreach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataview</span> <span class="prfexp"><span class="staexp"><A name="4746"><span class="stacstdec">hashtbl_v <span class="comment">// it is just an array of chains
</span>  <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype+<span class="keyword">,</span> int<span class="comment">(*sz*)</span><span class="keyword">,</span> int<span class="comment">(*tot*)</span><span class="keyword">,</span> addr<span class="keyword">,</span> addr<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">sz<span class="keyword">,</span>tot<span class="keyword">,</span>n<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    hashtbl_v_cons <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz+1<span class="keyword">,</span> tot+n<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span> <span class="keyword">of</span>
      <span class="staexp"><span class="keyword">(</span>chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span> @ l_beg<span class="keyword">,</span> hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg+chainsz<span class="keyword">,</span> l_end<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">}</span> hashtbl_v_nil <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> l<span class="keyword">,</span> l<span class="keyword">)</span></span></span>
<span class="comment">// end of [hashtbl_v]
</span>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="comment">// proof is omitted
</span>  <span class="prfexp"><A name="5151"><span class="dyncstdec">hashtbl_v_split <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>sz1<span class="keyword">,</span>tot<span class="keyword">:</span>nat <span class="keyword">|</span> sz1 &lt;= sz<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ofs<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>
    pf_mul<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>sz1<span class="keyword">,</span> chainsz<span class="keyword">,</span> ofs<span class="keyword">)</span></span>
  <span class="keyword">,</span> pf_tbl<span class="keyword">:</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>tot1<span class="keyword">:</span>nat <span class="keyword">|</span> tot1 &lt;= tot<span class="keyword">]</span> <span class="keyword">@(</span>
    hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1<span class="keyword">,</span> tot1<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_beg+ofs<span class="keyword">)</span>
  <span class="keyword">,</span> hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz-sz1<span class="keyword">,</span> tot-tot1<span class="keyword">,</span> l_beg+ofs<span class="keyword">,</span> l_end<span class="keyword">)</span>
  <span class="keyword">)</span></span></span></span></A> <span class="comment">// end of [hashtbl_v_split]
</span>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="comment">// proof is omitted
</span>  <span class="prfexp"><A name="5566"><span class="dyncstdec">hashtbl_v_unsplit <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>sz1<span class="keyword">,</span>sz2<span class="keyword">,</span>tot1<span class="keyword">,</span>tot2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_mid<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    pf1<span class="keyword">:</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1<span class="keyword">,</span> tot1<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_mid<span class="keyword">)</span></span>
  <span class="keyword">,</span> pf2<span class="keyword">:</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz2<span class="keyword">,</span> tot2<span class="keyword">,</span> l_mid<span class="keyword">,</span> l_end<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>
      key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1+sz2<span class="keyword">,</span> tot1+tot2<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end
    <span class="keyword">)</span></span></span></span></A> <span class="comment">// end of [hashtbl_v_unsplit]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> hashtbl_ptr_split 
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>sz1<span class="keyword">,</span>tot<span class="keyword">:</span>nat <span class="keyword">|</span> sz1 &lt;= sz<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_tbl<span class="keyword">:</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span><span class="keyword">,</span> sz1<span class="keyword">:</span> <span class="staexp">size_t sz1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>tot1<span class="keyword">:</span>nat <span class="keyword">|</span> tot1 &lt;= tot<span class="keyword">]</span> <span class="keyword">[</span>l_mid<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">@(</span>
      hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1<span class="keyword">,</span> tot1<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_mid<span class="keyword">)</span>
    <span class="keyword">,</span> hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz-sz1<span class="keyword">,</span> tot-tot1<span class="keyword">,</span> l_mid<span class="keyword">,</span> l_end<span class="keyword">)</span>
    <span class="keyword">|</span> ptr l_mid
    <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> ofs<span class="keyword">)</span> <span class="keyword">=</span> mul2_size1_size1 <span class="keyword">(</span>sz1<span class="keyword">,</span> sizeof&lt;<span class="staexp">chain0</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1_tbl<span class="keyword">,</span> pf2_tbl<span class="keyword">)</span> <span class="keyword">=</span> hashtbl_v_split <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf_tbl<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="prfexp">pf1_tbl</span><span class="keyword">,</span> <span class="prfexp">pf2_tbl</span> <span class="keyword">|</span> p_beg + ofs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_split]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> hashtbl_ptr_search_ofs
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">:</span>nat <span class="keyword">|</span> ofs <span class="keyword">&lt;</span> sz<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">,</span> ofs<span class="keyword">:</span> <span class="staexp">size_t ofs</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt itm</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p_mid<span class="keyword">)</span> <span class="keyword">=</span>
    hashtbl_ptr_split&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> ofs<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> pf2</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> chain_search <span class="keyword">(</span><span class="keyword">!</span>p_mid<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_unsplit <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_search_ofs]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> hashtbl_ptr_insert_ofs
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">:</span>nat <span class="keyword">|</span> ofs <span class="keyword">&lt;</span> sz<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot+1<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">,</span> ofs<span class="keyword">:</span> <span class="staexp">size_t ofs</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p_mid<span class="keyword">)</span> <span class="keyword">=</span>
    hashtbl_ptr_split&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> ofs<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> pf2</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> chain_insert <span class="keyword">(</span><span class="keyword">!</span>p_mid<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_unsplit <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_insert_ofs]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> hashtbl_ptr_remove_ofs
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">:</span>nat <span class="keyword">|</span> ofs <span class="keyword">&lt;</span> sz<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot-b2i b<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp">eq key</span><span class="keyword">,</span> ofs<span class="keyword">:</span> <span class="staexp">size_t ofs</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>b<span class="keyword">:</span>bool <span class="keyword">|</span> b2i b &lt;= tot<span class="keyword">]</span> option_vt <span class="keyword">(</span>itm<span class="keyword">,</span> b<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p_mid<span class="keyword">)</span> <span class="keyword">=</span>
    hashtbl_ptr_split&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> ofs<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> pf2</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> chain_remove <span class="keyword">(</span><span class="keyword">!</span>p_mid<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_unsplit <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_remove_ofs]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="8388"><span class="dyncstdec">size1_of_ulint <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">ulint</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>i<span class="keyword">:</span>nat<span class="keyword">]</span> size_t i</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">i2sz size1_of_int1</span>
<span class="keyword">#define</span> <span class="neuexp">sz1mod mod1_size1_size1</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  hashtbl_ptr_insert_chain
  <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">:</span>pos<span class="keyword">;</span>tot<span class="keyword">,</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot+n<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> sz<span class="keyword">:</span> <span class="staexp">size_t sz</span>
  <span class="keyword">,</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span>
  <span class="keyword">,</span> kis<span class="keyword">:</span> <span class="staexp">chain <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">,</span> hash<span class="keyword">:</span> <span class="staexp">hash key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> kis <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>CHAINcons <span class="keyword">(</span>k<span class="keyword">,</span> i<span class="keyword">,</span> kis<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// insertion must be done in the reverse order!
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_insert_chain <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> p_beg<span class="keyword">,</span> kis<span class="keyword">,</span> hash<span class="keyword">)</span>
      <span class="keyword">val</span> h <span class="keyword">=</span> hash_key <span class="keyword">(</span>k<span class="keyword">,</span> hash<span class="keyword">)</span>
      <span class="keyword">val</span> h <span class="keyword">=</span> size1_of_ulint <span class="keyword">(</span>h<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">ofs<span class="keyword">:</span>int</span><span class="keyword">]</span> ofs <span class="keyword">=</span> sz1mod <span class="keyword">(</span>h<span class="keyword">,</span> sz<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p_mid<span class="keyword">)</span> <span class="keyword">=</span>
        hashtbl_ptr_split&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>ofs<span class="keyword">,</span>tot+n-1<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> ofs<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> pf2</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> chain_insert <span class="keyword">(</span><span class="keyword">!</span>p_mid<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> hashtbl_v_cons <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_unsplit <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>CHAINnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_insert_chain]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  hashtbl_ptr_relocate
  <span class="staexp"><span class="keyword">{</span>sz1<span class="keyword">:</span>nat<span class="keyword">;</span>sz2<span class="keyword">:</span>pos<span class="keyword">;</span>tot1<span class="keyword">,</span>tot2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>sz1<span class="keyword">&gt;.</span></span>
  <span class="staexp"><span class="keyword">{</span>l1_beg<span class="keyword">,</span>l2_beg<span class="keyword">,</span>l1_end<span class="keyword">,</span>l2_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1<span class="keyword">,</span> tot1<span class="keyword">,</span> l1_beg<span class="keyword">,</span> l1_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz1<span class="keyword">,</span> 0<span class="comment">(*tot*)</span><span class="keyword">,</span> l1_beg<span class="keyword">,</span> l1_end<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf2<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz2<span class="keyword">,</span> tot2<span class="keyword">,</span> l2_beg<span class="keyword">,</span> l2_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz2<span class="keyword">,</span> tot1+tot2<span class="keyword">,</span> l2_beg<span class="keyword">,</span> l2_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> sz1<span class="keyword">:</span> <span class="staexp">size_t sz1</span><span class="keyword">,</span> sz2<span class="keyword">:</span> <span class="staexp">size_t sz2</span><span class="keyword">,</span> p1_beg<span class="keyword">:</span> <span class="staexp">ptr l1_beg</span><span class="keyword">,</span> p2_beg<span class="keyword">:</span> <span class="staexp">ptr l2_beg</span>
  <span class="keyword">,</span> hash<span class="keyword">:</span> <span class="staexp">hash key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> sz1 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf11<span class="keyword">,</span> pf12<span class="keyword">)</span> <span class="keyword">=</span> pf1</span>
    <span class="keyword">val</span> kis <span class="keyword">=</span> <span class="keyword">!</span>p1_beg<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p1_beg := CHAINnil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_insert_chain <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> sz2<span class="keyword">,</span> p2_beg<span class="keyword">,</span> kis<span class="keyword">,</span> hash<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_relocate
      <span class="keyword">(</span><span class="prfexp">pf12</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> sz1-1<span class="keyword">,</span> sz2<span class="keyword">,</span> p1_beg+sizeof&lt;<span class="staexp">chain0</span><span class="keyword">&gt;</span><span class="keyword">,</span> p2_beg<span class="keyword">,</span> hash<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := hashtbl_v_cons <span class="keyword">(</span>pf11<span class="keyword">,</span> pf12<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := hashtbl_v_nil <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_relocate]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  hashtbl_ptr_clear
    <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">:</span>nat<span class="keyword">;</span>tot<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>sz<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
          &gt;&gt; hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> 0<span class="comment">(*tot*)</span><span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> sz<span class="keyword">:</span> <span class="staexp">size_t sz</span><span class="keyword">,</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> sz <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> chain_free <span class="keyword">(</span><span class="keyword">!</span>p_beg<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_beg := CHAINnil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_clear&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> sz-1<span class="keyword">,</span> p_beg+sizeof&lt;<span class="staexp">chain0</span><span class="keyword">&gt;</span><span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_cons <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := hashtbl_v_nil <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_clear]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="11318"><span class="dyncstdec">hashtbl_ptr_make
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>sz<span class="keyword">:</span> <span class="staexp">size_t sz</span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">@(</span>
    free_gc_v l_beg
  <span class="keyword">,</span> hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> 0<span class="comment">(*tot*)</span><span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
  <span class="keyword">|</span> ptr l_beg
  <span class="keyword">)</span></span></span></A> <span class="comment">// end of [hashtbl_ptr_make]
</span>  <span class="keyword">=</span> "hashtbl_ptr_make"

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="11571"><span class="dyncstdec">hashtbl_ptr_free
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_gc<span class="keyword">:</span> <span class="staexp">free_gc_v l_beg</span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_tbl<span class="keyword">:</span> <span class="staexp">hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> 0<span class="comment">(*tot*)</span><span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>
  <span class="keyword">=</span> "hashtbl_ptr_free"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  hashtbl_ptr_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>tot<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>sz<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span><span class="keyword">,</span> <span class="prfexp">pf_tbl<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> sz<span class="keyword">:</span> <span class="staexp">size_t sz</span><span class="keyword">,</span> p_beg<span class="keyword">:</span> <span class="staexp">ptr l_beg</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> sz <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">hashtbl_v_cons <span class="keyword">(</span>pf1_tbl<span class="keyword">,</span> pf2_tbl<span class="keyword">)</span> <span class="keyword">=</span> pf_tbl</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> chain_foreach_clo <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_beg<span class="keyword">,</span> f<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// segfault during typechecking if {v} is not provided!!!
</span>      hashtbl_ptr_foreach_clo&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span>
        <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">pf2_tbl</span> <span class="keyword">|</span> sz-1<span class="keyword">,</span> p_beg+sizeof&lt;<span class="staexp">chain0</span><span class="keyword">&gt;</span><span class="keyword">,</span> f<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_tbl := hashtbl_v_cons <span class="keyword">(</span>pf1_tbl<span class="keyword">,</span> pf2_tbl<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_ptr_foreach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><A name="12552"><span class="stacstdec">hashtbl_vt <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">sz<span class="keyword">:</span>pos</span><span class="keyword">;</span><span class="staexp">tot<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">l_beg<span class="keyword">,</span>l_end<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    hashtbl_vt_some <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      free_gc_v <span class="keyword">(</span>l_beg<span class="keyword">)</span>
    <span class="keyword">,</span> hashtbl_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> l_beg<span class="keyword">,</span> l_end<span class="keyword">)</span>
    <span class="keyword">|</span> size_t sz<span class="keyword">,</span> size_t tot<span class="keyword">,</span> ptr l_beg<span class="keyword">,</span> hash key<span class="keyword">,</span> eq key
    <span class="keyword">)</span></span> <span class="comment">// end of [hashtbl_vt_some]
</span>  <span class="keyword">|</span> hashtbl_vt_none <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">hashtbl_t
  <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> ref <span class="keyword">(</span>hashtbl_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> hashtbl_size <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span> <span class="keyword">|</span> sz<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> sz<span class="keyword">)</span>
  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> hashtbl_total <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span> <span class="keyword">|</span> _<span class="keyword">,</span> tot<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> tot<span class="keyword">)</span>
  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_total]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_search <span class="keyword">(</span>tbl<span class="keyword">,</span> k0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> _<span class="keyword">,</span> p_beg<span class="keyword">,</span> hash<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> h <span class="keyword">=</span> hash_key <span class="keyword">(</span>k0<span class="keyword">,</span> hash<span class="keyword">)</span>
      <span class="keyword">val</span> h <span class="keyword">=</span> size1_of_ulint <span class="keyword">(</span>h<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> ofs <span class="keyword">=</span> sz1mod <span class="keyword">(</span>h<span class="keyword">,</span> sz<span class="keyword">)</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> hashtbl_ptr_search_ofs <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">,</span> ofs<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> ans
    <span class="keyword">end</span> <span class="comment">// end of [hashtbl_vt_some]
</span>  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> hashtbl_resize
  <span class="staexp"><span class="keyword">{</span>sz_new<span class="keyword">:</span>pos<span class="keyword">}</span></span><span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> sz_new<span class="keyword">:</span> <span class="staexp">size_t sz_new</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_gc</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> <span class="keyword">!</span>sz<span class="keyword">,</span> _<span class="comment">(*tot*)</span><span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">,</span> hash<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">pf1_gc <span class="keyword">=</span> <span class="keyword">!</span>pf_gc <span class="keyword">and</span> pf1 <span class="keyword">=</span> <span class="keyword">!</span>pf</span><span class="keyword">;</span> <span class="keyword">val</span> p1 <span class="keyword">=</span> <span class="keyword">!</span>p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf2_gc</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p2<span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_make <span class="keyword">(</span>sz_new<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_relocate <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> <span class="keyword">!</span>sz<span class="keyword">,</span> sz_new<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">,</span> p2<span class="keyword">,</span> hash<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_free <span class="keyword">(</span><span class="prfexp">pf1_gc</span><span class="keyword">,</span> <span class="prfexp">pf1</span> <span class="keyword">|</span> p1<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">!</span>pf_gc := pf2_gc<span class="keyword">;</span> <span class="keyword">!</span>pf := pf2<span class="keyword">;</span> <span class="keyword">!</span>sz := sz_new<span class="keyword">;</span> <span class="keyword">!</span>p := p2<span class="keyword">;</span> fold@ <span class="keyword">!</span>p_tbl
    <span class="keyword">end</span>
  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_resize]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">HASHTABLE_DOUBLE_THRESHOLD 5.0</span>
<span class="keyword">#assert</span> <span class="neuexp"><span class="keyword">(</span>HASHTABLE_DOUBLE_THRESHOLD <span class="keyword">&gt;</span> 2.0<span class="keyword">)</span></span>
<span class="keyword">#define</span> <span class="neuexp">HASHTABLE_HALF_THRESHOLD 0.5</span>
<span class="keyword">#assert</span> <span class="neuexp"><span class="keyword">(</span>HASHTABLE_HALF_THRESHOLD <span class="keyword">&lt;</span> 1.0<span class="keyword">)</span></span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  hashtbl_resize_double <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> sz <span class="keyword">=</span> hashtbl_size <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">val</span> sz <span class="keyword">=</span> size1_of_size <span class="keyword">(</span>sz<span class="keyword">)</span> <span class="comment">// casting: no op
</span><span class="keyword">in</span>
  <span class="keyword">if</span> sz <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> hashtbl_resize <span class="keyword">(</span>tbl<span class="keyword">,</span> sz + sz<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_resize_double]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  hashtbl_resize_half <span class="keyword">(</span>tbl<span class="keyword">:</span> <span class="staexp">hashtbl_t <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> sz <span class="keyword">=</span> hashtbl_size <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">val</span> sz <span class="keyword">=</span> size1_of_size <span class="keyword">(</span>sz<span class="keyword">)</span> <span class="comment">// casting: no op
</span><span class="keyword">in</span>
  <span class="keyword">if</span> sz &gt;= 2 <span class="keyword">then</span> hashtbl_resize <span class="keyword">(</span>tbl<span class="keyword">,</span> sz / 2<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_resize_half]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_insert_err <span class="keyword">(</span>tbl<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> ratio<span class="keyword">:</span> <span class="staexp">double</span> <span class="keyword">=</span> 0.0
  <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
    <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> <span class="keyword">!</span>tot<span class="keyword">,</span> p_beg<span class="keyword">,</span> hash<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> tot1 <span class="keyword">=</span> <span class="keyword">!</span>tot + 1
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ratio := double_of_size tot1 / double_of_size sz
        <span class="keyword">val</span> h <span class="keyword">=</span> hash_key <span class="keyword">(</span>k<span class="keyword">,</span> hash<span class="keyword">)</span>
        <span class="keyword">val</span> h <span class="keyword">=</span> size1_of_ulint <span class="keyword">(</span>h<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> ofs <span class="keyword">=</span> sz1mod <span class="keyword">(</span>h<span class="keyword">,</span> sz<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_insert_ofs&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> ofs<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">!</span>tot := <span class="keyword">!</span>tot + 1<span class="keyword">;</span> fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [hashtbl_vt_some]
</span>    <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> Some_vt i<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">Option_vt itm</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> ratio &gt;= HASHTABLE_DOUBLE_THRESHOLD <span class="keyword">then</span> hashtbl_resize_double <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_insert_err]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_remove_err <span class="keyword">(</span>tbl<span class="keyword">,</span> k0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> ratio<span class="keyword">:</span> <span class="staexp">double</span> <span class="keyword">=</span> 1.0
  <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
    <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> <span class="keyword">!</span>tot<span class="keyword">,</span> p_beg<span class="keyword">,</span> hash<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> h <span class="keyword">=</span> hash_key <span class="keyword">(</span>k0<span class="keyword">,</span> hash<span class="keyword">)</span>
        <span class="keyword">val</span> h <span class="keyword">=</span> size1_of_ulint <span class="keyword">(</span>h<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> ofs <span class="keyword">=</span> sz1mod <span class="keyword">(</span>h<span class="keyword">,</span> sz<span class="keyword">)</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> hashtbl_ptr_remove_ofs&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> p_beg<span class="keyword">,</span> k0<span class="keyword">,</span> eq<span class="keyword">,</span> ofs<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
          <span class="keyword">|</span> Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> tot1 <span class="keyword">=</span> <span class="keyword">!</span>tot - 1
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ratio := double_of_size tot1 / double_of_size sz
            <span class="keyword">in</span>
              fold@ ans<span class="keyword">;</span> <span class="keyword">!</span>tot := tot1<span class="keyword">;</span> fold@ <span class="keyword">!</span>p_tbl
            <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>          <span class="keyword">|</span> None_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ ans<span class="keyword">;</span> fold@ <span class="keyword">!</span>p_tbl<span class="keyword">)</span>
      <span class="keyword">in</span>
        ans
      <span class="keyword">end</span> <span class="comment">// end of [hashtbl_vt_some]
</span>    <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">Option_vt itm</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> ratio &lt;= HASHTABLE_HALF_THRESHOLD <span class="keyword">then</span> hashtbl_resize_half <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_remove_err]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
// some prime numbers
53, 97, 193, 389, 769, 1543, 3079, 6151, 12289, 24593, 49157, 98317, 196613, 393241, 786433, 1572869, 3145739, 6291469, 12582917, 25165843, 50331653, 100663319, 201326611, 402653189, 805306457, 1610612741
*)</span>

<span class="keyword">#define</span> <span class="neuexp">HASHTABLE_SIZE_HINT 97</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_make
  <span class="keyword">(</span>hash<span class="keyword">,</span> eq<span class="keyword">)</span> <span class="keyword">=</span> hashtbl_make_hint&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>hash<span class="keyword">,</span> eq<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="comment">// end of [hashtbl_make]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_make_hint <span class="keyword">(</span>hash<span class="keyword">,</span> eq<span class="keyword">,</span> hint<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hint <span class="keyword">=</span> size1_of_size hint
  <span class="keyword">val</span> sz <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">if</span> hint <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> hint <span class="keyword">else</span> i2sz HASHTABLE_SIZE_HINT
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">sizeGt 0</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> p_beg<span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_make <span class="keyword">(</span>sz<span class="keyword">)</span>
  <span class="keyword">val</span> tbl <span class="keyword">=</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> 0<span class="keyword">,</span> p_beg<span class="keyword">,</span> hash<span class="keyword">,</span> eq<span class="keyword">)</span>
<span class="keyword">in</span>
  ref_make_elt&lt;<span class="staexp">hashtbl_vt<span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_make_hint]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> hashtbl_clear <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_gc</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> <span class="keyword">!</span>tot<span class="keyword">,</span> p_beg<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_clear <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> p_beg<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">!</span>tot := i2sz 0<span class="keyword">;</span> fold@ <span class="keyword">!</span>p_tbl
    <span class="keyword">end</span> <span class="comment">// end of [hashtbl_vt_some]
</span>  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ <span class="keyword">!</span>p_tbl
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_clear]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">HashtblFreeError1 1</span> <span class="comment">// freeing a nonempty hashtable
</span><span class="keyword">#define</span> <span class="neuexp">HashtblFreeError2 2</span> <span class="comment">// freeing an already freed hashtable
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> hashtbl_free_err <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
    <span class="keyword">|</span> hashtbl_vt_some <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>sz<span class="keyword">,</span>tot<span class="keyword">}</span></span>
        <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_gc</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> tot<span class="keyword">,</span> p_beg<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> tot <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hashtbl_ptr_free <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_gc</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> p_beg<span class="keyword">)</span>
        <span class="keyword">in</span>
          free@ <span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span> <span class="keyword">{</span>sz<span class="keyword">,</span>tot<span class="keyword">}</span> <span class="keyword">!</span>p_tbl<span class="keyword">;</span> <span class="keyword">!</span>p_tbl := hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> err := HashtblFreeError1
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [hashtbl_vt_some]
</span>    <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">!</span>p_tbl<span class="keyword">;</span> err := HashtblFreeError2<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  err <span class="comment">// error code
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_free_err]
</span>
<span class="keyword">exception</span> HashtblFreeException <span class="keyword">of</span> <span class="staexp">int</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> hashtbl_free_exn <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> err <span class="keyword">=</span> hashtbl_free_err <span class="keyword">(</span>tbl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">$raise</span> HashtblFreeException <span class="keyword">(</span>err<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hashtbl]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  hashtbl_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> tbl<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_tbl</span> <span class="keyword">|</span> p_tbl<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>tbl<span class="keyword">)</span> <span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">!</span>p_tbl <span class="keyword">of</span>
  <span class="keyword">|</span> hashtbl_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> _<span class="keyword">,</span> p_beg<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_ref</span> <span class="keyword">begin</span>
        hashtbl_ptr_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf</span> <span class="keyword">|</span> sz<span class="keyword">,</span> p_beg<span class="keyword">,</span> f<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      fold@ <span class="keyword">!</span>p_tbl
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> hashtbl_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ <span class="keyword">!</span>p_tbl
<span class="keyword">end</span> <span class="comment">// end of [hashtbl_foreach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  hashtbl_foreach_cloref <span class="keyword">(</span>tbl<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> __cast <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="20123"><span class="dyncstdec">__cast
    <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">typedef</span> <span class="staexp"><A name="20236"><span class="stacstdec">clo_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_f</span> <span class="keyword">|</span> p_f<span class="keyword">)</span> <span class="keyword">=</span> cloref_get_view_ptr <span class="staexp"><span class="keyword">{</span>clo_type<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf0 <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_ref</span>
    <span class="keyword">(</span>hashtbl_foreach_clo&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> tbl<span class="keyword">,</span> <span class="keyword">!</span>p_f<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [hashtbl_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{$

// shortcuts? yes. worth it? probably.

// static inline
ats_ptr_type
hashtbl_ptr_make (ats_size_type sz) {
  ats_ptr_type p ;
  /* zeroing the allocated memory is mandatory! */
  p = ATS_CALLOC(sz, sizeof(chain0)) ;
  return p ;
} /* end of [hashtbl_ptr_make] */

// static inline
ats_void_type
hashtbl_ptr_free (ats_ptr_type p) { ATS_FREE(p) ; return ; }
/* end of [hashtbl_ptr_free] */

%}</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [hashtable.dats] *)</span>
</PRE>
</BODY>
</HTML>
