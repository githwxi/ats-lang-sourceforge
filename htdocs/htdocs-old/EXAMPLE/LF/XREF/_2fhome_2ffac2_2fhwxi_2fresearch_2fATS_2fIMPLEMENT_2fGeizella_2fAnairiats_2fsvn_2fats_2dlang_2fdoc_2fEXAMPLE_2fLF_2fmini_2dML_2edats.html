<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">//
</span><span class="comment">// An implementation of mini-ML that is proven to be correct
</span><span class="comment">//
</span>
<span class="comment">// January 2005:
</span><span class="comment">// It is completed by Hongwei Xi.
</span>
<span class="comment">// January 2007:
</span><span class="comment">// It is ported to ATS/Geizella by Hongwei Xi.
</span>
<span class="comment">// March 5th, 2008:
</span><span class="comment">// It is verified by ATS/Anairiats (without any changes being made).
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datasort</span> <span class="staexp">tp <span class="keyword">=</span>
  <span class="keyword">|</span> TPnat
  <span class="keyword">|</span> TPfun <span class="keyword">of</span> <span class="keyword">(</span>tp<span class="keyword">,</span> tp<span class="keyword">)</span>
  <span class="keyword">|</span> TPtup <span class="keyword">of</span> <span class="keyword">(</span>tp<span class="keyword">,</span> tp<span class="keyword">)</span></span>

<span class="keyword">dataparasort</span> <span class="staexp">tm <span class="keyword">=</span> 
  <span class="keyword">|</span> TMzero
  <span class="keyword">|</span> TMsucc <span class="keyword">of</span> tm
  <span class="keyword">|</span> TMlam <span class="keyword">of</span> <span class="keyword">(</span>tm <span class="keyword">-&gt;</span> tm<span class="keyword">)</span>
  <span class="keyword">|</span> TMapp <span class="keyword">of</span> <span class="keyword">(</span>tm<span class="keyword">,</span> tm<span class="keyword">)</span>
  <span class="keyword">|</span> TMtup <span class="keyword">of</span> <span class="keyword">(</span>tm<span class="keyword">,</span> tm<span class="keyword">)</span>
  <span class="keyword">|</span> TMfst <span class="keyword">of</span> tm
  <span class="keyword">|</span> TMsnd <span class="keyword">of</span> tm
  <span class="keyword">|</span> TMfix <span class="keyword">of</span> <span class="keyword">(</span>tm <span class="keyword">-&gt;</span> tm<span class="keyword">)</span>
  <span class="keyword">|</span> TMcase <span class="keyword">of</span> <span class="keyword">(</span>tm<span class="keyword">,</span> tm<span class="keyword">,</span> tm <span class="keyword">-&gt;</span> tm<span class="keyword">)</span></span>

<span class="keyword">datasort</span> <span class="staexp">ctx <span class="keyword">=</span> CTXnil <span class="keyword">|</span> CTXcons <span class="keyword">of</span> <span class="keyword">(</span>ctx<span class="keyword">,</span> tm<span class="keyword">,</span> tp<span class="keyword">)</span></span>

<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><a name="629"><span class="stacstdec">ISVAL <span class="keyword">(</span>tm<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> ISVALzero <span class="staexp"><span class="keyword">(</span>TMzero<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> ISVALsucc <span class="staexp"><span class="keyword">(</span>TMsucc e<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">ISVAL <span class="keyword">(</span>e<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span> tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> ISVALlam <span class="staexp"><span class="keyword">(</span>TMlam f<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">,</span>e2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      ISVALtup <span class="staexp"><span class="keyword">(</span>TMtup <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span><span class="keyword">,</span> n1+n2+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ISVAL <span class="keyword">(</span>e1<span class="keyword">,</span> n1<span class="keyword">)</span><span class="keyword">,</span> ISVAL <span class="keyword">(</span>e2<span class="keyword">,</span> n2<span class="keyword">)</span><span class="keyword">)</span></span></span>

<span class="keyword">propdef</span> <span class="staexp"><a name="885"><span class="stacstdec">ISVAL0 <span class="keyword">(</span>e<span class="keyword">:</span> tm<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">]</span> ISVAL <span class="keyword">(</span>e<span class="keyword">,</span> n<span class="keyword">)</span></span></a></span>

<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><a name="933"><span class="stacstdec">EVAL <span class="keyword">(</span>tm<span class="keyword">,</span> tm<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> EVALzero <span class="staexp"><span class="keyword">(</span>TMzero<span class="keyword">,</span> TMzero<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">,</span>v<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> EVALsucc <span class="staexp"><span class="keyword">(</span>TMsucc e<span class="keyword">,</span>TMsucc v<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">EVAL <span class="keyword">(</span>e<span class="keyword">,</span> v<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm <span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> EVALlam <span class="staexp"><span class="keyword">(</span>TMlam f<span class="keyword">,</span> TMlam f<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">:</span>tm</span><span class="keyword">;</span> <span class="staexp">f1<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">;</span> <span class="staexp">e2<span class="keyword">,</span>v2<span class="keyword">,</span>v<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">,</span>n3<span class="keyword">:</span>nat</span><span class="keyword">}</span> 
      EVALapp<span class="staexp"><span class="keyword">(</span>TMapp<span class="keyword">(</span>e1<span class="keyword">,</span>e2<span class="keyword">)</span><span class="keyword">,</span> v<span class="keyword">,</span> n1+n2+n3+1<span class="keyword">)</span></span> <span class="keyword">of</span>
        <span class="staexp"><span class="keyword">(</span>EVAL<span class="keyword">(</span>e1<span class="keyword">,</span> TMlam f1<span class="keyword">,</span> n1<span class="keyword">)</span><span class="keyword">,</span> EVAL<span class="keyword">(</span>e2<span class="keyword">,</span> v2<span class="keyword">,</span> n2<span class="keyword">)</span><span class="keyword">,</span> EVAL <span class="keyword">(</span>f1 v2<span class="keyword">,</span> v<span class="keyword">,</span> n3<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">,</span>v1<span class="keyword">,</span>e2<span class="keyword">,</span>v2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALtup <span class="staexp"><span class="keyword">(</span>TMtup <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span><span class="keyword">,</span> TMtup <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">,</span> n1+n2+1<span class="keyword">)</span></span> <span class="keyword">of</span>
        <span class="staexp"><span class="keyword">(</span>EVAL <span class="keyword">(</span>e1<span class="keyword">,</span> v1<span class="keyword">,</span> n1<span class="keyword">)</span><span class="keyword">,</span> EVAL <span class="keyword">(</span>e2<span class="keyword">,</span> v2<span class="keyword">,</span> n2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">,</span>v1<span class="keyword">,</span>v2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALfst <span class="staexp"><span class="keyword">(</span>TMfst e<span class="keyword">,</span> v1<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">EVAL <span class="keyword">(</span>e<span class="keyword">,</span> TMtup <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">,</span>v1<span class="keyword">,</span>v2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALsnd <span class="staexp"><span class="keyword">(</span>TMsnd e<span class="keyword">,</span> v2<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">EVAL <span class="keyword">(</span>e<span class="keyword">,</span> TMtup <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">;</span> <span class="staexp">v<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALfix <span class="staexp"><span class="keyword">(</span>TMfix f<span class="keyword">,</span> v<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">EVAL <span class="keyword">(</span>f <span class="keyword">(</span>TMfix f<span class="keyword">)</span><span class="keyword">,</span> v<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e0<span class="keyword">,</span>e1<span class="keyword">:</span>tm</span><span class="keyword">;</span><span class="staexp">f2<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">;</span><span class="staexp">v<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALcase1 <span class="staexp"><span class="keyword">(</span>TMcase <span class="keyword">(</span>e0<span class="keyword">,</span> e1<span class="keyword">,</span> f2<span class="keyword">)</span><span class="keyword">,</span> v<span class="keyword">,</span> n1+n2+1<span class="keyword">)</span></span> <span class="keyword">of</span>
        <span class="staexp"><span class="keyword">(</span>EVAL <span class="keyword">(</span>e0<span class="keyword">,</span> TMzero<span class="keyword">,</span> n1<span class="keyword">)</span><span class="keyword">,</span> EVAL <span class="keyword">(</span>e1<span class="keyword">,</span> v<span class="keyword">,</span> n2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e0<span class="keyword">,</span>e1<span class="keyword">:</span>tm</span><span class="keyword">;</span><span class="staexp">f2<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">;</span><span class="staexp">v0<span class="keyword">,</span>v<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span>
      EVALcase2 <span class="staexp"><span class="keyword">(</span>TMcase <span class="keyword">(</span>e0<span class="keyword">,</span> e1<span class="keyword">,</span> f2<span class="keyword">)</span><span class="keyword">,</span> v<span class="keyword">,</span> n1+n2+1<span class="keyword">)</span></span> <span class="keyword">of</span>
        <span class="staexp"><span class="keyword">(</span>EVAL <span class="keyword">(</span>e0<span class="keyword">,</span> TMsucc v0<span class="keyword">,</span> n1<span class="keyword">)</span><span class="keyword">,</span> EVAL <span class="keyword">(</span>f2 v0<span class="keyword">,</span> v<span class="keyword">,</span> n2<span class="keyword">)</span><span class="keyword">)</span></span></span>

<span class="keyword">propdef</span> <span class="staexp"><a name="1989"><span class="stacstdec">EVAL0 <span class="keyword">(</span>e1<span class="keyword">:</span> tm<span class="keyword">,</span> e2<span class="keyword">:</span> tm<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">]</span> EVAL <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">,</span> n<span class="keyword">)</span></span></a></span>

<span class="comment">//
</span>
<span class="keyword">prfun</span> <span class="prfexp">lemma0 <span class="staexp"><span class="keyword">{</span>e1<span class="keyword">,</span>e2<span class="keyword">:</span>tm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">EVAL <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ISVAL0 <span class="keyword">(</span>e2<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> pf <span class="keyword">of</span>
  <span class="keyword">|</span> EVALzero <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ISVALzero
  <span class="keyword">|</span> EVALsucc pf <span class="keyword">=&gt;</span> ISVALsucc <span class="keyword">(</span>lemma0 pf<span class="keyword">)</span>
  <span class="keyword">|</span> EVALlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ISVALlam
  <span class="keyword">|</span> EVALapp <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma0 pf
  <span class="keyword">|</span> EVALtup <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=&gt;</span> ISVALtup <span class="keyword">(</span>lemma0 pf1<span class="keyword">,</span> lemma0 pf2<span class="keyword">)</span>
  <span class="keyword">|</span> EVALfst <span class="keyword">(</span>pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">prval</span> <span class="prfexp">ISVALtup <span class="keyword">(</span>pf1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> lemma0 pf</span> <span class="keyword">in</span> pf1 <span class="keyword">end</span>
  <span class="keyword">|</span> EVALsnd <span class="keyword">(</span>pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">prval</span> <span class="prfexp">ISVALtup <span class="keyword">(</span>_<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> lemma0 pf</span> <span class="keyword">in</span> pf2 <span class="keyword">end</span>
  <span class="keyword">|</span> EVALfix <span class="keyword">(</span>pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma0 pf
  <span class="keyword">|</span> EVALcase1 <span class="keyword">(</span>_<span class="keyword">,</span> pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma0 pf
  <span class="keyword">|</span> EVALcase2 <span class="keyword">(</span>_<span class="keyword">,</span> pf<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma0 pf
<span class="keyword">end</span></span> <span class="comment">// end of [lemma0]
</span>
<span class="keyword">prfun</span> <span class="prfexp">lemma1 <span class="staexp"><span class="keyword">{</span>e<span class="keyword">:</span>tm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">ISVAL <span class="keyword">(</span>e<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">EVAL0 <span class="keyword">(</span>e<span class="keyword">,</span> e<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> pf <span class="keyword">of</span>
  <span class="keyword">|</span> ISVALzero <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> EVALzero
  <span class="keyword">|</span> ISVALsucc pf <span class="keyword">=&gt;</span> EVALsucc <span class="keyword">(</span>lemma1 pf<span class="keyword">)</span>
  <span class="keyword">|</span> ISVALlam <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> EVALlam
  <span class="keyword">|</span> ISVALtup <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=&gt;</span> EVALtup <span class="keyword">(</span>lemma1 pf1<span class="keyword">,</span> lemma1 pf2<span class="keyword">)</span>
<span class="keyword">end</span></span> <span class="comment">// end of [lemma1]
</span>
<span class="keyword">prfn</span> <span class="prfexp">lemma2 <span class="staexp"><span class="keyword">{</span>e<span class="keyword">:</span>tm<span class="keyword">}</span></span>
  <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">ISVAL0 <span class="keyword">(</span>TMsucc e<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ISVAL0 <span class="keyword">(</span>e<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">let</span> <span class="keyword">prval</span> <span class="prfexp">ISVALsucc pf <span class="keyword">=</span> pf</span> <span class="keyword">in</span> pf <span class="keyword">end</span></span>

<span class="comment">//
</span>
<span class="keyword">datatype</span> <span class="staexp"><a name="2986"><span class="stacstdec">IN <span class="keyword">(</span>tm<span class="keyword">,</span>tp<span class="keyword">,</span>ctx<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> 
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> INone<span class="staexp"><span class="keyword">(</span>e<span class="keyword">,</span>t<span class="keyword">,</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>e<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">,</span>e'<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">,</span>t'<span class="keyword">:</span>tp</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span>
      INshi<span class="staexp"><span class="keyword">(</span>e<span class="keyword">,</span>t<span class="keyword">,</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>e'<span class="keyword">,</span>t'<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">IN<span class="keyword">(</span>e<span class="keyword">,</span>t<span class="keyword">,</span>G<span class="keyword">)</span></span>

<span class="keyword">datatype</span> <span class="staexp"><a name="3145"><span class="stacstdec">DER <span class="keyword">(</span>ctx<span class="keyword">,</span>tm<span class="keyword">,</span>tp<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> 
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span> DERvar <span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span>e<span class="keyword">,</span>t<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">IN <span class="keyword">(</span>e<span class="keyword">,</span>t<span class="keyword">,</span>G<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> DERzero<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span>TMzero<span class="keyword">,</span>TPnat<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> DERsucc <span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span>TMsucc e<span class="keyword">,</span>TPnat<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">DER <span class="keyword">(</span>G<span class="keyword">,</span>e<span class="keyword">,</span>TPnat<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span> 
      DERlam<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span>TMlam f<span class="keyword">,</span>TPfun<span class="keyword">(</span>t1<span class="keyword">,</span>t2<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">{</span>x<span class="keyword">:</span>tm<span class="keyword">}</span> <span class="keyword">(</span>DER <span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>x<span class="keyword">,</span>t1<span class="keyword">)</span><span class="keyword">,</span> f x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">,</span>e2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERapp<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span>TMapp<span class="keyword">(</span>e1<span class="keyword">,</span>e2<span class="keyword">)</span><span class="keyword">,</span>t2<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>DER <span class="keyword">(</span>G<span class="keyword">,</span>e1<span class="keyword">,</span>TPfun <span class="keyword">(</span>t1<span class="keyword">,</span>t2<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span>DER <span class="keyword">(</span>G<span class="keyword">,</span>e2<span class="keyword">,</span>t1<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">,</span>e2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERtup<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span> TMtup<span class="keyword">(</span>e1<span class="keyword">,</span>e2<span class="keyword">)</span><span class="keyword">,</span> TPtup <span class="keyword">(</span>t1<span class="keyword">,</span>t2<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>DER <span class="keyword">(</span>G<span class="keyword">,</span> e1<span class="keyword">,</span> t1<span class="keyword">)</span><span class="keyword">,</span> DER <span class="keyword">(</span>G<span class="keyword">,</span> e2<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERfst<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span> TMfst e<span class="keyword">,</span> t1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">DER <span class="keyword">(</span>G<span class="keyword">,</span> e<span class="keyword">,</span> TPtup <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERsnd<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span> TMsnd e<span class="keyword">,</span> t2<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">DER <span class="keyword">(</span>G<span class="keyword">,</span> e<span class="keyword">,</span> TPtup <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERfix<span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span> TMfix f<span class="keyword">,</span> t<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">{</span>x<span class="keyword">:</span>tm<span class="keyword">}</span> <span class="keyword">(</span>DER <span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>x<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">,</span> f x<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e0<span class="keyword">,</span>e1<span class="keyword">:</span>tm</span><span class="keyword">;</span> <span class="staexp">f2<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      DERcase <span class="staexp"><span class="keyword">(</span>G<span class="keyword">,</span> TMcase <span class="keyword">(</span>e0<span class="keyword">,</span> e1<span class="keyword">,</span> f2<span class="keyword">)</span><span class="keyword">,</span> t<span class="keyword">)</span></span> <span class="keyword">of</span>
        <span class="staexp"><span class="keyword">(</span>DER <span class="keyword">(</span>G<span class="keyword">,</span> e0<span class="keyword">,</span> TPnat<span class="keyword">)</span><span class="keyword">,</span> DER <span class="keyword">(</span>G<span class="keyword">,</span> e1<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">{</span>x<span class="keyword">:</span>tm<span class="keyword">}</span> DER <span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>x<span class="keyword">,</span>TPnat<span class="keyword">)</span><span class="keyword">,</span> f2 x<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="keyword">datatype</span> <span class="staexp"><a name="4126"><span class="stacstdec">ENV <span class="keyword">(</span>ctx<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> ENVnil<span class="staexp"><span class="keyword">(</span>CTXnil<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span>
       ENVlamcons<span class="staexp"><span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>e<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ISVAL0 e <span class="keyword">|</span> ENV <span class="keyword">(</span>G<span class="keyword">)</span><span class="keyword">,</span> VAL <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t<span class="keyword">:</span>tp</span><span class="keyword">}</span>
       ENVfixcons<span class="staexp"><span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>TMfix f<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span>
         <span class="staexp"><span class="keyword">(</span>ENV <span class="keyword">(</span>G<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">{</span>x<span class="keyword">:</span>tm<span class="keyword">}</span> <span class="keyword">(</span>DER <span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>x<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">,</span> f x<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span></span>

<span class="keyword">and</span> <span class="staexp"><a name="4389"><span class="stacstdec">VAL <span class="keyword">(</span>tm<span class="keyword">,</span> tp<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> VALzero <span class="staexp"><span class="keyword">(</span>TMzero<span class="keyword">,</span> TPnat<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">e<span class="keyword">:</span>tm</span><span class="keyword">}</span> VALsucc <span class="staexp"><span class="keyword">(</span>TMsucc e<span class="keyword">,</span> TPnat<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">VAL <span class="keyword">(</span>e<span class="keyword">,</span> TPnat<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">f<span class="keyword">:</span>tm<span class="keyword">-&gt;</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      VALclo<span class="staexp"><span class="keyword">(</span>TMlam f<span class="keyword">,</span> TPfun <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> 
        <span class="staexp"><span class="keyword">(</span>ENV<span class="keyword">(</span>G<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">{</span>x<span class="keyword">:</span>tm<span class="keyword">}</span> DER<span class="keyword">(</span>CTXcons<span class="keyword">(</span>G<span class="keyword">,</span>x<span class="keyword">,</span>t1<span class="keyword">)</span><span class="keyword">,</span> f x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">G<span class="keyword">:</span>ctx</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">e1<span class="keyword">,</span>e2<span class="keyword">:</span>tm</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">t1<span class="keyword">,</span>t2<span class="keyword">:</span>tp</span><span class="keyword">}</span>
      VALtup<span class="staexp"><span class="keyword">(</span>TMtup<span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span><span class="keyword">,</span> TPtup<span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>VAL <span class="keyword">(</span>e1<span class="keyword">,</span> t1<span class="keyword">)</span><span class="keyword">,</span> VAL <span class="keyword">(</span>e2<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">//
</span>
<span class="comment">(* need to check pattern matching always succeeds *)</span>
<span class="keyword">fun</span> eval <span class="staexp"><span class="keyword">{</span>G<span class="keyword">:</span>ctx<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>e1<span class="keyword">:</span>tm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t1<span class="keyword">:</span>tp<span class="keyword">}</span></span>
   <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">ENV G</span><span class="keyword">,</span> der<span class="keyword">:</span> <span class="staexp">DER<span class="keyword">(</span>G<span class="keyword">,</span>e1<span class="keyword">,</span>t1<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>e2<span class="keyword">:</span>tm<span class="keyword">]</span> <span class="keyword">(</span>EVAL0 <span class="keyword">(</span>e1<span class="keyword">,</span>e2<span class="keyword">)</span> <span class="keyword">|</span> VAL <span class="keyword">(</span>e2<span class="keyword">,</span>t1<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> der <span class="keyword">of</span>
  <span class="keyword">|</span> DERvar i <span class="keyword">=&gt;</span> evalVar <span class="keyword">(</span>env<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">|</span> DERzero <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="prfexp">EVALzero</span> <span class="keyword">|</span> VALzero<span class="keyword">)</span>
  <span class="keyword">|</span> DERsucc der <span class="keyword">=&gt;</span>
      <span class="keyword">let</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> v<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">EVALsucc pf</span> <span class="keyword">|</span> VALsucc v<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">|</span> DERlam <span class="keyword">(</span>fder<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="prfexp">EVALlam</span> <span class="keyword">|</span> VALclo <span class="keyword">(</span>env<span class="keyword">,</span> fder<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> DERapp <span class="keyword">(</span>der1<span class="keyword">,</span> der2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> c1<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der1<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> v2<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der2<span class="keyword">)</span>
      <span class="keyword">val</span> VALclo <span class="keyword">(</span>env<span class="keyword">,</span> fder<span class="keyword">)</span> <span class="keyword">=</span> c1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> v<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>ENVlamcons <span class="keyword">(</span><span class="prfexp">lemma0 pf2</span> <span class="keyword">|</span> env<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">,</span> fder <span class="staexp"><span class="keyword">{</span><span class="keyword">...</span><span class="keyword">}</span></span><span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">EVALapp <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">,</span> pf<span class="keyword">)</span></span> <span class="keyword">|</span> v<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> DERtup <span class="keyword">(</span>der1<span class="keyword">,</span> der2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> v1<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der1<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> v2<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">EVALtup <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span> <span class="keyword">|</span> VALtup <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> DERfst <span class="keyword">(</span>der<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val+</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> VALtup <span class="keyword">(</span>v1<span class="keyword">,</span> _<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">EVALfst pf</span> <span class="keyword">|</span> v1<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> DERsnd <span class="keyword">(</span>der<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val+</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> VALtup <span class="keyword">(</span>_<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">EVALsnd pf</span> <span class="keyword">|</span> v2<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> DERfix <span class="staexp"><span class="keyword">{</span>G<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">}</span></span> <span class="keyword">(</span>fder<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> v<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>ENVfixcons <span class="staexp"><span class="keyword">{</span>G<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">,</span> fder<span class="keyword">)</span><span class="keyword">,</span> fder <span class="staexp"><span class="keyword">{</span><span class="keyword">...</span><span class="keyword">}</span></span><span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">EVALfix pf</span> <span class="keyword">|</span> v<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> DERcase <span class="keyword">(</span>der0<span class="keyword">,</span> der1<span class="keyword">,</span> fder2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> v0<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der0<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> v0 <span class="keyword">of</span>
      <span class="keyword">|</span> VALzero <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> v1<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> der1<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">EVALcase1 <span class="keyword">(</span>pf0<span class="keyword">,</span> pf1<span class="keyword">)</span></span> <span class="keyword">|</span> v1<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> VALsucc v0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> v2<span class="keyword">)</span> <span class="keyword">=</span>
            eval <span class="keyword">(</span>ENVlamcons <span class="keyword">(</span><span class="prfexp">lemma2 <span class="keyword">(</span>lemma0 pf0<span class="keyword">)</span></span> <span class="keyword">|</span> env<span class="keyword">,</span> v0<span class="keyword">)</span><span class="keyword">,</span> fder2 <span class="staexp"><span class="keyword">{</span><span class="keyword">...</span><span class="keyword">}</span></span><span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">EVALcase2 <span class="keyword">(</span>pf0<span class="keyword">,</span> pf2<span class="keyword">)</span></span> <span class="keyword">|</span> v2<span class="keyword">)</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [eval]
</span>
<span class="keyword">and</span> evalVar <span class="staexp"><span class="keyword">{</span>G<span class="keyword">:</span>ctx<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>e1<span class="keyword">:</span>tm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">:</span>tp<span class="keyword">}</span></span>
  <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">ENV G</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">IN<span class="keyword">(</span>e1<span class="keyword">,</span>t<span class="keyword">,</span>G<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>e2<span class="keyword">:</span>tm<span class="keyword">]</span> <span class="keyword">(</span>EVAL0 <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span> <span class="keyword">|</span> VAL <span class="keyword">(</span>e2<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> i <span class="keyword">of</span>
  <span class="keyword">|</span> INone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> env <span class="keyword">of</span>
    <span class="keyword">|</span> ENVlamcons <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> _<span class="keyword">,</span> v<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="prfexp">lemma1 pf</span> <span class="keyword">|</span> v<span class="keyword">)</span>
    <span class="keyword">|</span> ENVfixcons <span class="staexp"><span class="keyword">{</span>G<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">,</span> fder<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> v<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>ENVfixcons <span class="staexp"><span class="keyword">{</span>G<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">,</span> fder<span class="keyword">)</span><span class="keyword">,</span> fder<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">EVALfix pf</span> <span class="keyword">|</span> v<span class="keyword">)</span>
         <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> INshi i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> env <span class="keyword">of</span>
    <span class="keyword">|</span> ENVlamcons <span class="keyword">(</span><span class="prfexp">_</span> <span class="keyword">|</span> env<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> evalVar <span class="keyword">(</span>env<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">|</span> ENVfixcons <span class="keyword">(</span>env<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> evalVar <span class="keyword">(</span>env<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end [of evalVar]
</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="6968"><span class="stacstdec">DER0 <span class="keyword">(</span>e<span class="keyword">:</span>tm<span class="keyword">,</span> t<span class="keyword">:</span>tp<span class="keyword">)</span> <span class="keyword">=</span> DER <span class="keyword">(</span>CTXnil<span class="keyword">,</span> e<span class="keyword">,</span> t<span class="keyword">)</span></span></a></span>

<span class="keyword">fun</span> evaluate <span class="staexp"><span class="keyword">{</span>e<span class="keyword">:</span>tm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>t<span class="keyword">:</span>tp<span class="keyword">}</span></span>
  <span class="keyword">(</span>der<span class="keyword">:</span> <span class="staexp">DER0 <span class="keyword">(</span>e<span class="keyword">,</span>t<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>e'<span class="keyword">:</span>tm<span class="keyword">]</span> <span class="keyword">(</span>EVAL0 <span class="keyword">(</span>e<span class="keyword">,</span>e'<span class="keyword">)</span> <span class="keyword">|</span> VAL<span class="keyword">(</span>e'<span class="keyword">,</span>t<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  eval <span class="keyword">(</span>ENVnil<span class="keyword">,</span> der<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [evaluate]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [miniML.dats] *)</span>
</pre>
</body>
</html>
