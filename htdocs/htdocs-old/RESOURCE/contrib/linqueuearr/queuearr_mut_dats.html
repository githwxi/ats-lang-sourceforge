<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of multithread queues based on arrays
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/SATS/pthread.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">LQA <span class="keyword">=</span> "linqueuearr.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">abstype</span> <span class="staexp"><A name="444"><span class="stacstdec">queuearr_mut_t</span></span></A> <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absview</span> <span class="staexp"><A name="503"><span class="stacstdec">ISEMP</span></span></A> <span class="keyword">(</span>int<span class="keyword">,</span> addr<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">absview</span> <span class="staexp"><A name="530"><span class="stacstdec">ISFUL</span></span></A> <span class="keyword">(</span>int<span class="keyword">,</span> int<span class="keyword">,</span> addr<span class="keyword">)</span>

<span class="keyword">absview</span> <span class="staexp"><A name="562"><span class="stacstdec">queuearr_lock_v</span></span></A> <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> l<span class="keyword">:</span>addr<span class="keyword">)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><A name="613"><span class="stacstdec">queuearr_mut_struct
  <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> m<span class="keyword">:</span>int<span class="keyword">,</span> n<span class="keyword">:</span>int<span class="keyword">,</span> l<span class="keyword">:</span>addr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  queue<span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_vt <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">)</span>
<span class="keyword">,</span> queue_mutex<span class="keyword">=</span> mutex_vt <span class="keyword">(</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">,</span> isemp_view<span class="keyword">=</span> ISEMP <span class="keyword">(</span>n<span class="keyword">,</span> l<span class="keyword">)</span>
<span class="keyword">,</span> isemp_cond<span class="keyword">=</span> cond_vt <span class="comment">// signaling the transition: n = 0 -&gt; n &gt; 0 
</span><span class="keyword">,</span> isful_view<span class="keyword">=</span> ISFUL <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span>
<span class="keyword">,</span> isful_cond<span class="keyword">=</span> cond_vt <span class="comment">// signaling the transition: m = n -&gt; m &gt; n
</span><span class="keyword">}</span></span></span></A> <span class="comment">// end of [queuearr_mut_vt]
</span>
<span class="keyword">extern</span> <span class="keyword">typedef</span> <span class="staexp">"queuearr_mut_struct" <span class="keyword">=</span> queuearr_mut_struct <span class="keyword">(</span>void<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> null<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="1098"><span class="dyncstdec">queuearr_lock_v_fold
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>nat <span class="keyword">|</span> n &lt;= m<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
    <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">queuearr_mut_struct <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="1253"><span class="dyncstdec">queuearr_lock_v_unfold
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>m<span class="keyword">,</span>n<span class="keyword">:</span>nat <span class="keyword">|</span> n &lt;= m<span class="keyword">]</span> queuearr_mut_struct <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="1432"><span class="dyncstdec">isemp_dec_prfun
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISEMP <span class="keyword">(</span>n<span class="keyword">,</span> l<span class="keyword">)</span> &gt;&gt; ISEMP <span class="keyword">(</span>n-1<span class="keyword">,</span> l<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="1530"><span class="dyncstdec">isful_inc_prfun
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>nat <span class="keyword">|</span> n <span class="keyword">&lt;</span> m<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n<span class="keyword">,</span>l<span class="keyword">)</span> &gt;&gt; ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n+1<span class="keyword">,</span>l<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1661"><span class="dyncstdec">isemp_inc_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISEMP <span class="keyword">(</span>n<span class="keyword">,</span> l<span class="keyword">)</span> &gt;&gt; ISEMP <span class="keyword">(</span>n+1<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> isemp_inc_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> n<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">pfstruct <span class="keyword">=</span> queuearr_mut_struct_make <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="1892"><span class="dyncstdec">queuearr_mut_struct_make
      <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">queuearr_mut_struct <span class="keyword">(</span>void<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span>  <span class="comment">// [pthread_cond_broadcast]: wake up all the waiting threads
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">=</span> 0 <span class="keyword">then</span> pthread_cond_broadcast <span class="keyword">(</span>p<span class="keyword">-&gt;</span>isemp_cond<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_mut_struct_free <span class="keyword">(</span>pfstruct<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="2195"><span class="dyncstdec">queuearr_mut_struct_free
      <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">queuearr_mut_struct <span class="keyword">(</span>void<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isemp_inc_prfun <span class="keyword">(</span>pf<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="2363"><span class="dyncstdec">isemp_inc_prfun <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISEMP <span class="keyword">(</span>n<span class="keyword">,</span> l<span class="keyword">)</span> &gt;&gt; ISEMP <span class="keyword">(</span>n+1<span class="keyword">,</span> l<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [isemp_inc]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="2525"><span class="dyncstdec">isful_dec_fun <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n<span class="keyword">,</span>l<span class="keyword">)</span> &gt;&gt; ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n-1<span class="keyword">,</span>l<span class="keyword">)</span></span></span> <span class="keyword">|</span> m<span class="keyword">:</span> <span class="staexp">int m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> isful_dec_fun <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">pfstruct <span class="keyword">=</span> queuearr_mut_struct_make <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="2775"><span class="dyncstdec">queuearr_mut_struct_make
      <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">queuearr_mut_struct <span class="keyword">(</span>void<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span>  <span class="comment">// [pthread_cond_broadcast]: wake up all the waiting threads
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> m <span class="keyword">=</span> n <span class="keyword">then</span> pthread_cond_broadcast <span class="keyword">(</span>p<span class="keyword">-&gt;</span>isful_cond<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_mut_struct_free <span class="keyword">(</span>pfstruct<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="3078"><span class="dyncstdec">queuearr_mut_struct_free
      <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">queuearr_mut_struct <span class="keyword">(</span>void<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> l<span class="keyword">)</span> @ l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isful_dec_prfun <span class="keyword">(</span>pf<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="3246"><span class="dyncstdec">isful_dec_prfun <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n<span class="keyword">,</span>l<span class="keyword">)</span> &gt;&gt; ISFUL <span class="keyword">(</span>m<span class="keyword">,</span>n-1<span class="keyword">,</span>l<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [isful_inc]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="3408"><span class="dyncstdec">queuearr_lock_acquire <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">_<span class="keyword">:</span> <span class="staexp">vbox <span class="keyword">(</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span></span></span> <span class="keyword">|</span> _<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span> <span class="keyword">|</span> void<span class="keyword">)</span></span></span></A>
  <span class="keyword">=</span> "queuearr_lock_acquire"

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="3576"><span class="dyncstdec">queuearr_lock_release <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">_<span class="keyword">:</span> <span class="staexp">queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> _<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>
  <span class="keyword">=</span> "queuearr_lock_release"

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="3710"><span class="dyncstdec">queuearr_lock_cond_wait_isemp <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">_<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> _<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>
  <span class="keyword">=</span> "queuearr_lock_cond_wait_isemp"

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="3861"><span class="dyncstdec">queuearr_lock_cond_wait_isful <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">_<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> _<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>
  <span class="keyword">=</span> "queuearr_lock_cond_wait_isful"

<span class="extern">%{$

ats_void_type
queuearr_lock_acquire (ats_ptr_type p) {
  // fprintf (stderr, "queuearr_lock_acquire: start.\n") ;
  atslib_pthread_mutex_lock (&amp;((queuearr_mut_struct*)p)-&gt;atslab_queue_mutex) ;
  // fprintf (stderr, "queuearr_lock_acquire: finish.\n") ;
  return ;
} // end of [queuearr_lock_acquire]

ats_void_type
queuearr_lock_release (ats_ptr_type p) {
  // fprintf (stderr, "queuearr_lock_release: start.\n") ;
  atslib_pthread_mutex_unlock (&amp;((queuearr_mut_struct*)p)-&gt;atslab_queue_mutex) ;
  // fprintf (stderr, "queuearr_lock_release: finish.\n") ;
  return ;
} // end of [queuearr_lock_release]

ats_void_type
queuearr_lock_cond_wait_isemp (ats_ptr_type p0) {
  queuearr_mut_struct *p = (queuearr_mut_struct*)p0 ;
  atslib_pthread_cond_wait_mutex (&amp;p-&gt;atslab_isemp_cond, &amp;p-&gt;atslab_queue_mutex) ;
  return ;
} // end of [queuearr_lock_cond_wait_isemp]

ats_void_type
queuearr_lock_cond_wait_isful (ats_ptr_type p0) {
  queuearr_mut_struct *p = (queuearr_mut_struct*)p0 ;
  atslib_pthread_cond_wait_mutex (&amp;p-&gt;atslab_isful_cond, &amp;p-&gt;atslab_queue_mutex) ;
  return ;
} // end of [queuearr_lock_cond_wait_isful]

%}</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">queuearr_mut_t <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>l<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>vbox <span class="keyword">(</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> ptr l<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
<A name="5284"><span class="dyncstdec">queuearr_mut_make <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp">int m</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">queuearr_mut_t <span class="keyword">(</span>a<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [queuearr_mut_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="5421"><span class="dyncstdec">queuearr_mut_enqueue <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">queuearr_mut_t a</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> queuearr_mut_enqueue <span class="keyword">(</span><span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> q_mut<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> q_mut
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_lock_acquire <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop
      <span class="keyword">(</span><span class="prfexp">pflock<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span>
      <span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> queuearr_lock_v_unfold <span class="keyword">(</span>pflock<span class="keyword">)</span></span>
      <span class="keyword">val</span> m <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_max <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">)</span>
      <span class="keyword">val</span> n <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_size <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">)</span>
<span class="comment">(*
      val () = $effmask_all begin
        prerr "queuearr_mut_enqueue: m = "; prerr m; prerr_newline ();
        prerr "queuearr_mut_enqueue: n = "; prerr n; prerr_newline ();
      end // end of [val]
*)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> m <span class="keyword">&gt;</span> n <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_enqueue <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">,</span> x<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isemp_inc_fun <span class="keyword">(</span><span class="prfexp">p<span class="keyword">-&gt;</span>isemp_view</span> <span class="keyword">|</span> n<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isful_inc_prfun <span class="keyword">(</span>p<span class="keyword">-&gt;</span>isful_view<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pflock := queuearr_lock_v_fold <span class="keyword">(</span>pf<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        <span class="comment">// empty
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pflock := queuearr_lock_v_fold <span class="keyword">(</span>pf<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_lock_cond_wait_isful <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span>
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">,</span> x<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="keyword">in</span>
  queuearr_lock_release <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [queuearr_mut_enqueue]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
<A name="6771"><span class="dyncstdec">queuearr_mut_dequeue <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">queuearr_mut_t a</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">a</span></span></A>
<span class="comment">// end of [queuearr_mut_dequeue]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> queuearr_mut_dequeue <span class="keyword">(</span><span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> q_mut<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> q_mut
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_lock_acquire <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p<span class="keyword">)</span>
  <span class="keyword">val</span> x <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop
      <span class="keyword">(</span><span class="prfexp">pflock<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queuearr_lock_v <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">1</span><span class="keyword">,</span><span class="keyword">~</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> queuearr_lock_v_unfold <span class="keyword">(</span>pflock<span class="keyword">)</span></span>
      <span class="keyword">val</span> m <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_max <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">)</span>
      <span class="keyword">val</span> n <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_size <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">)</span>
<span class="comment">(*
      val () = $effmask_all begin
        prerr "queuearr_mut_dequeue: m = "; prerr m; prerr_newline ();
        prerr "queuearr_mut_dequeue: n = "; prerr n; prerr_newline ();
      end
*)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> x <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_dequeue <span class="keyword">(</span>p<span class="keyword">-&gt;</span>queue<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isemp_dec_prfun <span class="keyword">(</span>p<span class="keyword">-&gt;</span>isemp_view<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isful_dec_fun <span class="keyword">(</span><span class="prfexp">p<span class="keyword">-&gt;</span>isful_view</span> <span class="keyword">|</span> m<span class="keyword">,</span> n<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pflock := queuearr_lock_v_fold <span class="keyword">(</span>pf<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        x <span class="comment">// return value
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pflock := queuearr_lock_v_fold <span class="keyword">(</span>pf<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> queuearr_lock_cond_wait_isemp <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span>
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="keyword">in</span>
  queuearr_lock_release <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pflock</span> <span class="keyword">|</span> p<span class="keyword">)</span><span class="keyword">;</span> x
<span class="keyword">end</span> <span class="comment">// end of [queuearr_mut_dequeue]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{$

ats_ptr_type
queuearr_mut_make_lqa (ats_ptr_type lqa) {
  queuearr_mut_struct *p ;
  p = ATS_MALLOC (sizeof(queuearr_mut_struct)) ;
  p-&gt;atslab_queue = lqa ;
  pthread_mutex_init (&amp;p-&gt;atslab_queue_mutex, NULL) ;
  pthread_cond_init (&amp;p-&gt;atslab_isemp_cond, NULL) ;
  pthread_cond_init (&amp;p-&gt;atslab_isful_cond, NULL) ;
  return p ;
} /* queuearr_mut_make */

%}</span> <span class="comment">// end of [%{$]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="8482"><span class="dyncstdec">queuearr_mut_make_lqa <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">$LQA<span class="keyword">.</span>linqueuearr_vt <span class="keyword">(</span>a<span class="keyword">,</span> m<span class="keyword">,</span> 0<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">queuearr_mut_t a</span></span></A>
  <span class="keyword">=</span> "queuearr_mut_make_lqa"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
<A name="8658"><span class="dyncstdec">queuearr_mut_make <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp">int m</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">queuearr_mut_t a</span></span></A>
<span class="comment">// end of [queuearr_mul_make]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> queuearr_mut_make <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> xs <span class="keyword">=</span> $LQA<span class="keyword">.</span>linqueuearr_make <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">in</span> queuearr_mut_make_lqa <span class="keyword">(</span>xs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [queuearr_mut_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [queuearr_mut.dats] *)</span>
</PRE>
</BODY>
</HTML>
