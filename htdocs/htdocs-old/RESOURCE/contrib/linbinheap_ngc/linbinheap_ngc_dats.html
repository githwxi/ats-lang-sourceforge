<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of linear binary heaps based on Braun trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: September, 2009
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absviewtype</span> <span class="staexp"><A name="347"><span class="stacstdec">heap_vt</span></span></A> <span class="keyword">(</span>elt<span class="keyword">:</span>viewt@ype+<span class="keyword">)</span> <span class="comment">// boxed viewtype
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">sortdef</span> <span class="staexp">vt0p <span class="keyword">=</span> viewt@ype</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="467"><span class="stacstdec">cmp <span class="keyword">(</span>elt<span class="keyword">:</span>vt0p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">&amp;</span>elt<span class="keyword">,</span> <span class="keyword">&amp;</span>elt<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> Sgn</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
  <A name="535"><span class="dyncstdec">compare_elt_elt <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>elt</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>elt</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></A>
<span class="comment">// end of ...
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> compare_elt_elt <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> cmp <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="703"><span class="dyncstdec">linbinheap_empty <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">heap_vt <span class="keyword">(</span>elt<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="765"><span class="dyncstdec">linbinheap_empty_free <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="keyword">(</span>hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>heap_vt <span class="keyword">(</span>elt<span class="keyword">)</span> &gt;&gt; opt <span class="keyword">(</span>heap_vt <span class="keyword">(</span>elt<span class="keyword">)</span><span class="keyword">,</span> tag<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>bool<span class="keyword">]</span> bool tag</span></span></A>
<span class="comment">// end of [linbinheap_empty_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="940"><span class="dyncstdec">linbinheap_is_empty <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>heap_vt elt</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="1012"><span class="dyncstdec">linbinheap_isnot_empty <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>heap_vt elt</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// [linbinheap_size] is of O(log^2 n) time-complexity
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1170"><span class="dyncstdec">linbinheap_size <span class="keyword">(</span>hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>heap_vt elt</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>
<span class="comment">// end of ...
</span>
<span class="comment">// absviewt@ype{a:viewt@ype} btnode // this is not yet supported ...
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1309"><span class="stacstdec">btnode <span class="keyword">(</span>
  a<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> lft<span class="keyword">:</span>addr<span class="keyword">,</span> rgh<span class="keyword">:</span>addr
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  elt<span class="keyword">=</span> a<span class="keyword">,</span> lft<span class="keyword">=</span> ptr lft<span class="keyword">,</span> rgh<span class="keyword">=</span> ptr rgh
<span class="keyword">}</span></span></span></A> <span class="comment">// end of [btnode]
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1430"><span class="stacstdec">btnode <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span> elt<span class="keyword">=</span> a<span class="keyword">,</span> lft<span class="keyword">=</span> ptr?<span class="keyword">,</span> rgh<span class="keyword">=</span> ptr? <span class="keyword">}</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1530"><span class="dyncstdec">linbinheap_insert <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp">btnode elt @ l_at</span></span> <span class="keyword">|</span> hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>heap_vt elt</span><span class="keyword">,</span> p_at<span class="keyword">:</span> <span class="staexp">ptr l_at</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>
<span class="comment">// end of ...
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
  <A name="1684"><span class="dyncstdec">linbinheap_delmin <span class="keyword">(</span>hp<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>heap_vt elt</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>ptropt_v <span class="keyword">(</span>btnode elt<span class="keyword">,</span> l_at<span class="keyword">)</span> <span class="keyword">|</span> ptr l_at<span class="keyword">)</span></span></span></A>
<span class="comment">// end of ...
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataview</span> <span class="prfexp"><span class="staexp"><A name="1839"><span class="stacstdec">brauntree_v <span class="keyword">(</span>
  a<span class="keyword">:</span>viewt@ype+<span class="comment">(*elt*)</span><span class="keyword">,</span> int<span class="comment">(*size*)</span><span class="keyword">,</span> addr<span class="comment">(*root*)</span>
<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">n2 &lt;= n1</span><span class="keyword">;</span> <span class="staexp">n1 &lt;= n2+1</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    B <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> n1+n2+1<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      btnode <span class="keyword">(</span>a<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">)</span> @ slf<span class="keyword">,</span> brauntree_v <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">,</span> lft<span class="keyword">)</span><span class="keyword">,</span> brauntree_v <span class="keyword">(</span>a<span class="keyword">,</span> n2<span class="keyword">,</span> rgh<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B]
</span>  <span class="keyword">|</span> E <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">,</span> null<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [brauntree_v]
</span>
<span class="keyword">stadef</span> <span class="staexp"><A name="2176"><span class="stacstdec">bt_v <span class="keyword">=</span> brauntree_v</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">heap_vt <span class="keyword">(</span>elt<span class="keyword">:</span>vt0p<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">;</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>brauntree_v <span class="keyword">(</span>elt<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span>
<span class="comment">// end of [heap_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linbinheap_empty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linbinheap_empty_free <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>hp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="2457"><span class="stacstdec">heap_vt <span class="keyword">=</span> heap_vt elt</span></span></A>
<span class="keyword">in</span>
  <span class="keyword">if</span> hp<span class="keyword">.</span>1 &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_some <span class="staexp"><span class="keyword">{</span>heap_vt<span class="keyword">}</span></span> <span class="keyword">(</span>hp<span class="keyword">)</span></span> <span class="keyword">in</span> true
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hp<span class="keyword">.</span>0</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_none <span class="staexp"><span class="keyword">{</span>heap_vt<span class="keyword">}</span></span> <span class="keyword">(</span>hp<span class="keyword">)</span></span> <span class="keyword">in</span> false
  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [linbinheap_empty_free] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linbinheap_is_empty <span class="keyword">(</span>hp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>hp<span class="keyword">.</span>1 <span class="keyword">=</span> null<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linbinheap_isnot_empty <span class="keyword">(</span>hp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>hp<span class="keyword">.</span>1 &lt;&gt; null<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> linbinheap_size <span class="keyword">(</span>hp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// this algorithm is taken from a paper by Okasaki
</span>  <span class="keyword">fun</span> diff <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat <span class="keyword">|</span> nr &lt;= nl<span class="keyword">;</span> nl &lt;= nr+1<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>nr<span class="keyword">&gt;.</span></span> 
    <span class="keyword">(</span><span class="prfexp">pf_l<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> nl<span class="keyword">,</span> l1<span class="keyword">)</span></span></span> <span class="keyword">|</span> nr<span class="keyword">:</span> <span class="staexp">int nr</span><span class="keyword">,</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l1</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int <span class="keyword">(</span>nl-nr<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> p_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> nr <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> nr2 <span class="keyword">=</span> nr / 2 <span class="keyword">in</span>
        <span class="keyword">if</span> nr <span class="keyword">&gt;</span> nr2 + nr2 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> p_l_l <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>lft
          <span class="keyword">val</span> df <span class="keyword">=</span> diff <span class="keyword">(</span><span class="prfexp">pf_l_l</span> <span class="keyword">|</span> nr2<span class="keyword">,</span> p_l_l<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l := B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          df
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> p_l_r <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>rgh
          <span class="keyword">val</span> df <span class="keyword">=</span> diff <span class="keyword">(</span><span class="prfexp">pf_l_r</span> <span class="keyword">|</span> nr2-1<span class="keyword">,</span> p_l_r<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l := B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          df
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l := B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span> <span class="keyword">in</span> 1
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l := E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> 0
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [diff]
</span>
  <span class="keyword">fun</span> size <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">val</span> nr <span class="keyword">=</span> size <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>rgh<span class="keyword">)</span>
      <span class="keyword">val</span> df <span class="keyword">=</span> diff <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> nr<span class="keyword">,</span> p<span class="keyword">-&gt;</span>lft<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      1 + nr + nr + df
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> 0
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [size]
</span><span class="keyword">in</span>
  size <span class="keyword">(</span><span class="prfexp">hp<span class="keyword">.</span>0</span> <span class="keyword">|</span> hp<span class="keyword">.</span>1<span class="keyword">)</span>  
<span class="keyword">end</span> <span class="comment">// end of [linbinheap_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> linbinheap_insert
  <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> hp<span class="keyword">,</span> p_at<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma <span class="keyword">(</span>pf_at<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="4473"><span class="dyncstdec">lemma <span class="keyword">(</span>pf_at<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>btnode elt @ l_at</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at &lt;&gt; null<span class="keyword">]</span> void</span></span></span></A>
  <span class="keyword">}</span></span>
<span class="comment">//
</span>  <span class="keyword">fun</span> insert <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr <span class="keyword">|</span> l_at &lt;&gt; null<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span></span></span>
    <span class="keyword">,</span> <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp">btnode elt @ l_at</span></span>
    <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> p_at<span class="keyword">:</span> <span class="staexp">ptr l_at</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>l_new<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n+1<span class="keyword">,</span> l_new<span class="keyword">)</span> <span class="keyword">|</span> ptr l_new<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt <span class="keyword">(</span>p<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_at<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft <span class="keyword">and</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l_new</span> <span class="keyword">|</span> p_l_new<span class="keyword">)</span> <span class="keyword">=</span> insert <span class="keyword">(</span><span class="prfexp">pf_r</span><span class="keyword">,</span> <span class="prfexp">pf1_at</span> <span class="keyword">|</span> p_r<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := p_l_new<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := p_l
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l_new<span class="keyword">,</span> pf_l<span class="keyword">)</span></span> <span class="keyword">|</span> p_at<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft <span class="keyword">and</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l_new</span> <span class="keyword">|</span> p_l_new<span class="keyword">)</span> <span class="keyword">=</span> insert <span class="keyword">(</span><span class="prfexp">pf_r</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> p_r<span class="keyword">,</span> p_at<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft := p_l_new<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh := p_l
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf_l_new<span class="keyword">,</span> pf_l<span class="keyword">)</span></span> <span class="keyword">|</span> p<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := null <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := null
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">|</span> p_at<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [insert]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_rt</span> <span class="keyword">|</span> p_rt<span class="keyword">)</span> <span class="keyword">=</span> insert <span class="keyword">(</span><span class="prfexp">hp<span class="keyword">.</span>0</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> hp<span class="keyword">.</span>1<span class="keyword">,</span> p_at<span class="keyword">)</span>
<span class="keyword">in</span>
  hp<span class="keyword">.</span>0 := pf_rt<span class="keyword">;</span> hp<span class="keyword">.</span>1 := p_rt
<span class="keyword">end</span> <span class="comment">// end of [linbinheap_insert]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> brauntree_ptr_leftrem <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span> &gt;&gt; bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n-1<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> rp<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>ptr slf &gt;&gt; ptr slf</span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span>
    <span class="keyword">[</span>l_at<span class="keyword">:</span>addr <span class="keyword">|</span> l_at &lt;&gt; null<span class="keyword">]</span> <span class="keyword">(</span>btnode elt @ l_at <span class="keyword">|</span> ptr l_at<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p <span class="keyword">=</span> rp
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft
<span class="keyword">in</span>
  <span class="keyword">if</span> p_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span> <span class="comment">// prove that n1 &gt; 0 holds
</span>    <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
    <span class="keyword">val</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rp := p_l
    <span class="keyword">val</span> res <span class="keyword">=</span> brauntree_ptr_leftrem <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> rp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft := p_r <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh := rp
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rp := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_r<span class="keyword">,</span> pf_l<span class="keyword">)</span>
  <span class="keyword">in</span>
    res
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rp := p<span class="keyword">-&gt;</span>rgh<span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_r</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> p<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [brauntree_ptr_leftrem]
</span>  
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> brauntree_ptr_siftdn
  <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat <span class="keyword">|</span> nr &lt;= nl<span class="keyword">;</span> nl &lt;= nr+1<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>nl<span class="keyword">&gt;.</span></span>
  <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr <span class="keyword">|</span> l_at &lt;&gt; null<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l1<span class="keyword">,</span>l2<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp">btnode elt @ l_at</span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_l<span class="keyword">:</span> <span class="staexp">bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> nl<span class="keyword">,</span> l1<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_r<span class="keyword">:</span> <span class="staexp">bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> nr<span class="keyword">,</span> l2<span class="keyword">)</span></span></span>  
  <span class="keyword">|</span> p_at<span class="keyword">:</span> <span class="staexp">ptr l_at</span><span class="keyword">,</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l1</span><span class="keyword">,</span> p_r<span class="keyword">:</span> <span class="staexp">ptr l2</span>
  <span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> nl+nr+1<span class="keyword">,</span> l<span class="keyword">)</span> <span class="keyword">|</span> ptr l<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">if</span> p_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> p_r &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r</span>
      <span class="keyword">var</span> knd <span class="keyword">:</span> <span class="staexp">Sgn</span> <span class="comment">// uninitialized
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
        <span class="keyword">val</span> cmp_xl_x <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p_l<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_at<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> cmp_xl_x &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// xl &gt;= x
</span>          <span class="keyword">val</span> cmp_xr_x <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p_r<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_at<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> cmp_xr_x &gt;= 0 <span class="keyword">then</span>
            knd := 0<span class="comment">(*N*)</span> <span class="comment">// xl &gt;= x and xr &gt;= x
</span>          <span class="keyword">else</span> 
            knd := 1<span class="comment">(*R*)</span> <span class="comment">// x1 &gt;= x and xr &lt; x
</span>          <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// xl &lt; x
</span>          <span class="keyword">val</span> cmp_xr_x <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p_r<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_at<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> cmp_xr_x &gt;= 0 <span class="keyword">then</span>
            knd := ~1<span class="comment">(*L*)</span> <span class="comment">// xl &lt; x and xr &gt;= x
</span>          <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> cmp_xl_xr <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p_l<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_r<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="keyword">if</span> cmp_xl_xr &gt;= 0 <span class="keyword">then</span> knd := 1<span class="comment">(*R*)</span> <span class="keyword">else</span> knd := ~1<span class="comment">(*L*)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="keyword">case+</span> knd <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> knd <span class="keyword">=</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
          <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := p_l <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := p_r
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_at<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of ...
</span>      <span class="keyword">|</span> _ <span class="keyword">when</span> knd <span class="keyword">&lt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l_new</span> <span class="keyword">|</span> p_l_new<span class="keyword">)</span> <span class="keyword">=</span>
            brauntree_ptr_siftdn&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_at</span><span class="keyword">,</span> <span class="prfexp">pf_l_l</span><span class="keyword">,</span> <span class="prfexp">pf_l_r</span> <span class="keyword">|</span> p_at<span class="keyword">,</span> p_l<span class="keyword">-&gt;</span>lft<span class="keyword">,</span> p_l<span class="keyword">-&gt;</span>rgh<span class="keyword">,</span> cmp<span class="keyword">)</span>
          <span class="comment">// end of [val]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>lft := p_l_new <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>rgh := p_r
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_new<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_l<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of ...
</span>      <span class="keyword">|</span> _ <span class="comment">(* knd &gt; 0 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r_new</span> <span class="keyword">|</span> p_r_new<span class="keyword">)</span> <span class="keyword">=</span>
            brauntree_ptr_siftdn&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_at</span><span class="keyword">,</span> <span class="prfexp">pf_r_l</span><span class="keyword">,</span> <span class="prfexp">pf_r_r</span> <span class="keyword">|</span> p_at<span class="keyword">,</span> p_r<span class="keyword">-&gt;</span>lft<span class="keyword">,</span> p_r<span class="keyword">-&gt;</span>rgh<span class="keyword">,</span> cmp<span class="keyword">)</span>
          <span class="comment">// end of [val]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>lft := p_l <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>rgh := p_r_new
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_new<span class="keyword">)</span></span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of ...
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// p_r == null
</span>      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_r</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l_l <span class="keyword">and</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l_r</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p_l<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> p_at<span class="keyword">-&gt;</span>elt<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := p_l <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := null
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">|</span> p_at<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// sgn &lt; 0
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := null <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := null
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>lft := p_at
        <span class="keyword">prval</span> <span class="prfexp">pf_l_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">and</span> pf_l_r <span class="keyword">=</span> E <span class="keyword">(</span><span class="keyword">)</span></span>
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_l<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// p_l == null
</span>    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_r</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>lft := null <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>rgh := null
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">|</span> p_at<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [brauntree_ptr_sifdn]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> linbinheap_delmin <span class="keyword">(</span>hp<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> delmin <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr <span class="keyword">|</span> l &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n<span class="keyword">,</span> l<span class="keyword">)</span> &gt;&gt; bt_v <span class="keyword">(</span>elt<span class="keyword">,</span> n-1<span class="keyword">,</span> l_new<span class="keyword">)</span></span></span>
    <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>l_new<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>btnode elt @ l <span class="keyword">|</span> ptr l_new<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">var</span> rp_l<span class="keyword">:</span> <span class="staexp">ptr</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>lft
  <span class="keyword">in</span>
    <span class="keyword">if</span> rp_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> p_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> p_l_r<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1_at</span> <span class="keyword">|</span> p1_at<span class="keyword">)</span> <span class="keyword">=</span> brauntree_ptr_leftrem&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> rp_l<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span>
        brauntree_ptr_siftdn&lt;<span class="staexp">elt</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf1_at</span><span class="keyword">,</span> <span class="prfexp">pf_r</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> p1_at<span class="keyword">,</span> p<span class="keyword">-&gt;</span>rgh<span class="keyword">,</span> rp_l<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_new</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> p_new<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// rp_l = null
</span>      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_r</span>
      <span class="keyword">val</span> p_new <span class="keyword">=</span> p<span class="keyword">-&gt;</span>rgh
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> p_new<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [delmin]
</span>  <span class="keyword">stavar</span> <span class="staexp">l <span class="keyword">:</span> addr</span> 
  <span class="keyword">val</span> p <span class="keyword">=</span> hp<span class="keyword">.</span>1 <span class="keyword">:</span> <span class="staexp">ptr l</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> hp<span class="keyword">.</span>0</span>
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span> delmin <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hp<span class="keyword">.</span>0 := pf</span><span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hp<span class="keyword">.</span>1 := p_new
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">Some_v <span class="staexp"><span class="keyword">{</span>btnode elt @ l<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">)</span></span> <span class="keyword">|</span> p<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span>
    <span class="keyword">(</span><span class="prfexp">None_v <span class="staexp"><span class="keyword">{</span>btnode elt @ null<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span>
  <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [linbinheap_delmin]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [linbinheap_ngc.dats] *)</span>
</PRE>
</BODY>
</HTML>
