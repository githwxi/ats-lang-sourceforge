<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2010 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: March 2008
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#include "ats_counter.cats" /* only needed for [ATS/Geizella] */
%}</span> <span class="comment">// end of [%{^]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#include</span> <span class="neuexp">"prelude/params.hats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Fil <span class="keyword">=</span> "ats_filename.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Glo <span class="keyword">=</span> "ats_global.sats"</span>
<span class="keyword">staload</span> <span class="staexp">IntInf <span class="keyword">=</span> "ats_intinf.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lab <span class="keyword">=</span> "ats_label.sats"</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="1884"><span class="stacstdec">lab_t <span class="keyword">=</span> $Lab<span class="keyword">.</span>label_t</span></a></span>
<span class="keyword">staload</span> <span class="staexp">Loc <span class="keyword">=</span> "ats_location.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_hiexp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">stadef</span> <span class="staexp"><a name="2272"><span class="stacstdec">fmlte <span class="keyword">=</span> file_mode_lte</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
  prerr "INTERNAL ERROR (ats_ccomp_emit)"
<span class="comment">// end of [prerr_interror]
</span>
<span class="keyword">fn</span> prerr_loc_errorccomp <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">(</span>$Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(ccomp)"<span class="keyword">)</span>
<span class="comment">// end of [prerr_loc_errorccomp]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{$

ats_void_type
atsccomp_emit_identifier (
  ats_ptr_type out, ats_ptr_type name
) {
  char c, *s ;
  s = name ;
  while (c = *s++) {
    if (isalnum (c)) {
      fputc (c, (FILE*)out) ; continue ;
    }
    if (c == '_') {
/*
    fputs ("_0", (FILE*)out); continue ;
*/
      fputc ('_', (FILE*)out); continue ;
    }
    if (c == '$') {
      fputs ("_0", (FILE*)out); continue ;
    } // end of [if]
    if (c == '\'') {
      fputs ("_1", (FILE*)out); continue ;
    } // end of [if]
    if (c == '/') {
      fputs ("_2", (FILE*)out); continue ;
    } // end of [if]
    if (c == '\\') {
      fputs ("_3", (FILE*)out); continue ;
    } // end of [if]
    fputc ('_', (FILE*)out);
    fprintf ((FILE*)out, "%.2x", (unsigned char)c);
  } /* end of [while] */
  return ;
} /* atsccomp_emit_identifier */

%}</span> <span class="comment">// end of [%{$]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="3403"><span class="dyncstdec">emit_identifier <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> name<span class="keyword">:</span> <span class="staexp">string</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a> <span class="keyword">=</span> "atsccomp_emit_identifier"
<span class="comment">// end of [emit_identifier]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_label <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> l<span class="keyword">)</span> <span class="keyword">=</span> $Lab<span class="keyword">.</span>fprint_label <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> l<span class="keyword">)</span>

<span class="keyword">implement</span>
emit_labelext
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> isext<span class="keyword">,</span> l<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">if</span> isext <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "atslab_"<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  $Lab<span class="keyword">.</span>fprint_label <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> l<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_atslabel]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
//
// HX: not working properly on special chars
//
implement emit_filename (pf | out, fil) =
  emit_identifier (pf | out, $Fil.filename_full fil)
// end of [emit_filename]
*)</span>

<span class="extern">%{$

extern char *atsopt_ATSHOME ;
extern int atsopt_ATSHOME_length ;
extern char *atsopt_ATSHOMERELOC ;
extern ats_ptr_type atsopt_filename_full (ats_ptr_type) ;

ats_void_type
atsccomp_emit_filename (ats_ptr_type out, ats_ptr_type fil) {
  int sgn ; char *name ;
  name = atsopt_filename_full (fil) ;
//
  if (!atsopt_ATSHOMERELOC) {
    atsccomp_emit_identifier (out, name) ; return ;
  }
//
  sgn = strncmp
    (atsopt_ATSHOME, name, atsopt_ATSHOME_length) ;
  if (sgn) {
    atsccomp_emit_identifier (out, name) ;
  } else {
    atsccomp_emit_identifier (out, atsopt_ATSHOMERELOC) ;
    atsccomp_emit_identifier (out, (char*)name + atsopt_ATSHOME_length) ;
  } // end of [if]
//
  return ;
} /* end of atsccomp_emit_filename */

%}</span> <span class="comment">// end of [%{$]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_d2con
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> fil <span class="keyword">=</span> d2con_fil_get d2c
  <span class="keyword">val</span> sym <span class="keyword">=</span> d2con_sym_get d2c
  <span class="keyword">val</span> name <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_name sym
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_filename <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fil<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__"<span class="keyword">)</span>
<span class="keyword">in</span>
  emit_identifier <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_d2con]
</span>
<span class="keyword">implement</span>
emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> extdef <span class="keyword">=</span> d2cst_extdef_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> extdef <span class="keyword">of</span>
  <span class="keyword">|</span> $Syn<span class="keyword">.</span>DCSTEXTDEFnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> fil <span class="keyword">=</span> d2cst_fil_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_name <span class="keyword">(</span>d2cst_sym_get d2c<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_filename <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fil<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_identifier <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [DCSTEXTDEFnone]
</span>  <span class="keyword">|</span> $Syn<span class="keyword">.</span>DCSTEXTDEFsome_fun name <span class="keyword">=&gt;</span> emit_identifier <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
  <span class="keyword">|</span> $Syn<span class="keyword">.</span>DCSTEXTDEFsome_mac name <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">// [name] = "#..."
</span><span class="comment">(*
** HX: this is a bit ugly but rather convenient
*)</span>
      <span class="keyword">val</span> p_name <span class="keyword">=</span> __cast name <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="5778"><span class="dyncstdec">__cast <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l<span class="keyword">:</span>addr<span class="keyword">]</span> ptr l</span></span></a>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> p_name1 <span class="keyword">=</span> p_name + sizeof&lt;<span class="staexp">char</span><span class="keyword">&gt;</span>
      <span class="keyword">val</span> name1 <span class="keyword">=</span> __cast <span class="keyword">(</span>p_name1<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="5946"><span class="dyncstdec">__cast <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">string</span></span></a>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      emit_identifier <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [DCSTEXTDEFcall]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_d2cst]
</span>
<span class="keyword">fn</span> emit_funlab_prefix <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> prfx <span class="keyword">=</span> $Glo<span class="keyword">.</span>atsccomp_namespace_get <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> stropt_is_some prfx <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> prfx <span class="keyword">=</span> stropt_unsome prfx <span class="keyword">in</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> prfx<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="comment">// the default is the empty string
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_funlab_prefix]
</span>
<span class="keyword">implement</span>
emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> funlab_qua_get fl <span class="keyword">of</span>
    <span class="keyword">|</span> D2CSTOPTsome d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">// global function
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span> <span class="keyword">in</span> <span class="comment">(*empty*)</span>
      <span class="keyword">end</span> <span class="comment">// end of [D2CSTOPTsome]
</span>    <span class="keyword">|</span> D2CSTOPTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">// local function
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab_prefix <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_identifier <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> funlab_name_get fl<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// empty
</span>      <span class="keyword">end</span> <span class="comment">// end of [D2CSTOPTnone]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> funlab_prfck_get fl <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_prfck"<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_funlab]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_tmplab
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__ats_lab_"<span class="keyword">)</span>
<span class="keyword">in</span>
  $Stamp<span class="keyword">.</span>fprint_stamp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmplab_stamp_get tl<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_tmplab]
</span>
<span class="keyword">implement</span>
emit_tmplabint
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [emit_tmplabint]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_tmpvar
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> knd <span class="keyword">=</span> tmpvar_top_get <span class="keyword">(</span>tmp<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> knd <span class="keyword">=</span> 1<span class="comment">(*top(static)*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> prfx <span class="keyword">=</span> $Glo<span class="keyword">.</span>atsccomp_namespace_get <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> stropt_is_some prfx <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> prfx <span class="keyword">=</span> stropt_unsome prfx <span class="keyword">in</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> prfx<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="comment">// there is no prefix
</span>        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
         fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "statmp"<span class="keyword">)</span> <span class="comment">// static temporary
</span>      <span class="keyword">end</span> <span class="comment">// end of [knd = 1]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "tmp"<span class="keyword">)</span> <span class="comment">// local temporary variable
</span>      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  $Stamp<span class="keyword">.</span>fprint_stamp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmpvar_stamp_get tmp<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_tmpvar]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">PTR_TYPE_NAME "ats_ptr_type"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> _emit_hityp <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> hit<span class="keyword">:</span> <span class="staexp">hityp</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> HITNAM <span class="keyword">(</span>knd<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> hit<span class="keyword">.</span>hityp_name
<span class="comment">(*
  val () = (
    print "_emit_hityp: knd = "; print knd; print_newline ()
  ) // end of [val]
  val () = (
    print "_emit_hityp: name = "; print name; print_newline ()
  ) // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> 0 <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> knd &lt;= 0 <span class="keyword">=&gt;</span> <span class="comment">(* flt_ext: ~1; flt: 0 *)</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="comment">(* boxed: knd &gt; 0 *)</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> PTR_TYPE_NAME<span class="keyword">)</span>
  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_hityp]
</span>
<span class="keyword">fn</span> _emit_hityp_ptr <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> hit<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> HITNAM <span class="keyword">(</span>knd<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> hit<span class="keyword">.</span>hityp_name
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 0 <span class="keyword">then</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '&amp;'<span class="keyword">)</span> <span class="comment">// an error!
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_hityp_ptr]
</span>
<span class="keyword">fn</span> _emit_hityplst_sep <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">,</span> sep<span class="keyword">:</span> <span class="staexp">string</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">,</span> sep<span class="keyword">:</span> <span class="staexp">string</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hits <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> sep<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> _emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> hits<span class="keyword">,</span> sep<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [list_cons] *)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> hits<span class="keyword">,</span> sep<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [_emit_hityplst_sep]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hityp_decode hit<span class="keyword">)</span>
<span class="comment">// end of [emit_hityp]
</span>
<span class="keyword">implement</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hityp_decode hit<span class="keyword">)</span>
<span class="comment">// end of [emit_hityp_ptr]
</span>
<span class="keyword">implement</span>
emit_hityplst_sep <span class="keyword">(</span>
  <span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _arg<span class="keyword">,</span> sep
<span class="keyword">)</span> <span class="keyword">=</span> _emit_hityplst_sep <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hityplst_decode <span class="keyword">(</span>_arg<span class="keyword">)</span><span class="keyword">,</span> sep<span class="keyword">)</span>
<span class="comment">// end of [emit_hityplst_sep]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="10089"><span class="dyncstdec">emit_hityp_fun <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> _arg<span class="keyword">:</span> <span class="staexp">hityplst_t</span><span class="keyword">,</span> _res<span class="keyword">:</span> <span class="staexp">hityp_t</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a> <span class="comment">// end of [emit_hityp_fun]
</span><span class="keyword">implement</span>
emit_hityp_fun <span class="keyword">(</span>
  <span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _arg<span class="keyword">,</span> _res
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(*)("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityplst_sep <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _arg<span class="keyword">,</span> ", "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [emit_hityp_fun]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="10507"><span class="dyncstdec">emit_hityp_clofun <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> _arg<span class="keyword">:</span> <span class="staexp">hityplst_t</span><span class="keyword">,</span> _res<span class="keyword">:</span> <span class="staexp">hityp_t</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a> <span class="comment">// end of [emit_hityp_clofun]
</span><span class="keyword">implement</span>
emit_hityp_clofun <span class="keyword">(</span>
  <span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _arg<span class="keyword">,</span> _res
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(*)(ats_clo_ptr_type"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons _arg <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span> <span class="keyword">in</span>
        emit_hityplst_sep <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> _arg<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [_]
</span>  <span class="comment">// end of [_]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_hityp_fun]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="11170"><span class="dyncstdec">emit_cloenv <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">envmap_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span><span class="keyword">,</span> i0<span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span></span></a> <span class="comment">// i0 = 0: without leading comma; i0 = 1: with leading comma
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="11383"><span class="stacstdec">valprimlstlst_vt <span class="keyword">=</span> List_vt <span class="keyword">(</span>valprimlst<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> the_level <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>
<span class="keyword">val</span> the_funarglst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">valprimlst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">val</span> the_funarglstlst <span class="keyword">=</span> ref_make_elt&lt;<span class="staexp">valprimlstlst_vt</span><span class="keyword">&gt;</span> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">fn</span> funarglst_find <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt <span class="keyword">(</span>valprim<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>vps<span class="keyword">:</span> <span class="staexp">valprimlst</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">valprim</span> <span class="keyword">=</span> <span class="keyword">case+</span> vps <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> loop <span class="keyword">(</span>vps<span class="keyword">,</span> i-1<span class="keyword">)</span> <span class="keyword">else</span> vp
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> valprim_void <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// deadcode
</span>  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> <span class="keyword">!</span>the_level <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> Some_vt <span class="keyword">(</span>loop <span class="keyword">(</span><span class="keyword">!</span>the_funarglst<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funarglst_find]
</span>
<span class="keyword">fn</span> funarglst_pop <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>the_level
  <span class="comment">// run-time checking
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">!</span>the_level := n-1<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> prerr ": funarglst_pop: n = 0"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">var</span> vps0<span class="keyword">:</span> <span class="staexp">valprimlst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funarglstlst<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>vps<span class="keyword">,</span> vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>p := <span class="keyword">(</span>vpss<span class="keyword">:</span> <span class="staexp">valprimlstlst_vt</span><span class="keyword">)</span><span class="keyword">;</span> vps0 := vps
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">!</span>the_funarglst := vps0
<span class="keyword">end</span> <span class="comment">// end of [funarglst_pop]
</span>
<span class="keyword">fn</span> funarglst_push <span class="keyword">(</span>vps<span class="keyword">:</span> <span class="staexp">valprimlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>the_level<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>the_level := n + 1
<span class="keyword">in</span>
  <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vps0 <span class="keyword">=</span> <span class="keyword">!</span>the_funarglst
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>the_funarglst := vps<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_funarglstlst<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>p := list_vt_cons <span class="keyword">(</span>vps0<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="keyword">!</span>the_funarglst := vps
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [funarglst_push]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_arg <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> ind<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> funarglst_find ind <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt vp <span class="keyword">=&gt;</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "arg%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [emit_valprim_arg] *)</span>

<span class="keyword">fn</span> emit_valprim_argref
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> ind<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hit<span class="keyword">:</span> <span class="staexp">hityp_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_ptrget_mac("<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_arg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// nothing
</span><span class="keyword">end</span> <span class="comment">(* end of [emit_valprim_argref] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_bool <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> b<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> b <span class="keyword">then</span> <span class="keyword">begin</span>
    fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_true_bool"<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_false_bool"<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [emit_valprim_bool] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_char <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> c<span class="keyword">:</span> <span class="staexp">char</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> c <span class="keyword">of</span>
  <span class="keyword">|</span> '\'' <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'\\''"<span class="keyword">)</span>
  <span class="keyword">|</span> '\n' <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'\\n'"<span class="keyword">)</span>
  <span class="keyword">|</span> '\t' <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'\\t'"<span class="keyword">)</span>
  <span class="keyword">|</span> '\\' <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'\\\\'"<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> char_isprint c <span class="keyword">=&gt;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'%c'"<span class="keyword">,</span> <span class="keyword">@(</span>c<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "'\\%.3o'"<span class="keyword">,</span> <span class="keyword">@(</span>uint_of_char c<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [emit_valprim_char] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_clo_init <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> knd<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">,</span> vp_clo<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">envmap_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> entry <span class="keyword">=</span> funlab_entry_get_some <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> vtps <span class="keyword">=</span> funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_init ("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_clo<span class="keyword">)</span>
  <span class="keyword">val</span> _<span class="comment">(*int*)</span> <span class="keyword">=</span> emit_cloenv <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> map<span class="keyword">,</span> vtps<span class="keyword">,</span> 1<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_valprim_clo_init]
</span>
<span class="keyword">fn</span> emit_valprim_clo_make <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> knd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">envmap_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> entry <span class="keyword">=</span> funlab_entry_get_some <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> vtps <span class="keyword">=</span> funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> 0 <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> knd &lt;&gt; 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_make ("<span class="keyword">)</span>
      <span class="keyword">val</span> _<span class="comment">(*int*)</span> <span class="keyword">=</span> emit_cloenv <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> map<span class="keyword">,</span> vtps<span class="keyword">,</span> 0<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span>  <span class="comment">// end of [knd &lt;&gt; 0]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">(* knd = 0: a flat closure *)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_error ()"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_valprim_clo_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
ats_void_type
atsccomp_emit_valprim_float
  (ats_ptr_type out, ats_ptr_type str) {
  char *s = str ;
  if (*s == '~') { fputc ('-', (FILE*)out) ; s += 1 ; }
  fputs (s, (FILE*)out) ;
  return ;
} /* atsccomp_emit_valprim_float */
%}</span> <span class="comment">// end of [%{^]
</span><span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16019"><span class="dyncstdec">emit_valprim_float <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "atsccomp_emit_valprim_float"
<span class="comment">// end of [emit_valprim_float]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_int <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> int<span class="keyword">:</span> <span class="staexp">intinf_t</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $IntInf<span class="keyword">.</span>fprint_intinf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> int<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_valprim_int]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
ats_void_type
atsccomp_emit_valprim_intsp
  (ats_ptr_type out, ats_ptr_type str) {
  char *s = str ;
  if (*s == '~') { fputc ('-', (FILE*)out) ; s += 1 ; }
  fputs (s, (FILE*)out) ;
  return ;
} /* atsccomp_emit_valprim_intsp */
%}</span> <span class="comment">// end of [%{^]
</span><span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16653"><span class="dyncstdec">emit_valprim_intsp <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "atsccomp_emit_valprim_intsp"
<span class="comment">// end of [emit_valprim_intsp]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_ptrof <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> vp<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
  <span class="keyword">|</span> VParg ind <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(&amp;"<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_arg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> VPargref ind <span class="keyword">=&gt;</span> emit_valprim_arg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">)</span>
  <span class="keyword">|</span> VPenv vtp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ind <span class="keyword">=</span> varindmap_find_some <span class="keyword">(</span>vartyp_var_get vtp<span class="keyword">)</span>
    <span class="keyword">in</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "env"<span class="keyword">)</span><span class="keyword">;</span> fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPenv]
</span>  <span class="keyword">|</span> VPtmpref tmp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(&amp;"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [VPtmp]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
      val () = prerr_interror ()
      val () = (prerr ": emit_valprim_ptrof: vp = "; prerr_valprim vp; prerr_newline ())
      val () = $Err.abort {void} ()
*)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ptrof_error("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_valprim_ptrof]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_array_index
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vpss<span class="keyword">:</span> <span class="staexp">valprimlstlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
      out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vpss<span class="keyword">:</span> <span class="staexp">valprimlstlst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> vpss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>vps<span class="keyword">,</span> vpss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "["<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "]"<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>out<span class="keyword">,</span> vpss<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> vpss<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_array_index]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> label_is_tyarr <span class="keyword">(</span>
  hit_rec<span class="keyword">:</span> <span class="staexp">hityp_t</span><span class="keyword">,</span> lab<span class="keyword">:</span> <span class="staexp">lab_t</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hit_rec <span class="keyword">=</span> hityp_decode <span class="keyword">(</span>hit_rec<span class="keyword">)</span>
  <span class="keyword">fun</span> istyarr
    <span class="keyword">(</span>lhits<span class="keyword">:</span> <span class="staexp">labhityplst</span><span class="keyword">,</span> lab<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> lhits <span class="keyword">of</span>
    <span class="keyword">|</span> LABHITYPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hit<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> $Lab<span class="keyword">.</span>eq_label_label <span class="keyword">(</span>lab<span class="keyword">,</span> l<span class="keyword">)</span>
          <span class="keyword">then</span> hityp_is_tyarr<span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">else</span> istyarr <span class="keyword">(</span>lhits<span class="keyword">,</span> lab<span class="keyword">)</span>
      <span class="comment">// end of [if]
</span>    <span class="keyword">|</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">in</span>
  <span class="keyword">case+</span> hit_rec<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HITtyrec <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=&gt;</span> istyarr <span class="keyword">(</span>lhits<span class="keyword">,</span> lab<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [label_is_tyarr]
</span>
<span class="keyword">fn</span> emit_select_clo
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">offsetlst</span><span class="keyword">,</span> froot<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">&amp;</span>FILE m<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr1<span class="keyword">&gt;</span> void</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">List_vt <span class="keyword">(</span>offset<span class="keyword">)</span></span><span class="keyword">,</span> froot<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">&amp;</span>FILE m<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr1<span class="keyword">&gt;</span> void</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> offs <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>off<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> off <span class="keyword">of</span>
    <span class="keyword">|</span> OFFSETind <span class="keyword">(</span>
        vpss_dim<span class="keyword">,</span> hit_elt
      <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
          <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_caselind_mac("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> offs<span class="keyword">,</span> froot<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_array_index <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vpss_dim<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// nothing
</span>      <span class="keyword">end</span> <span class="comment">// end of [OFFSETind]
</span>    <span class="keyword">|</span> OFFSETlab <span class="keyword">(</span>
        lab<span class="keyword">,</span> hit_rec
      <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">var</span> isext<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
        <span class="keyword">var</span> istyarr<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_t_is_tyrecbox hit_rec <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> istyarr <span class="keyword">=</span> label_is_tyarr <span class="keyword">(</span>hit_rec<span class="keyword">,</span> lab<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_selbox_mac("<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// nothing
</span>          <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>        <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_t_is_tyrecsin hit_rec <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_selsin_mac("<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// nothing
</span>          <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> istyarr <span class="keyword">=</span> label_is_tyarr <span class="keyword">(</span>hit_rec<span class="keyword">,</span> lab<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> isext := hityp_t_is_tyrecext hit_rec
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_select_mac("<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// nothing
</span>          <span class="keyword">end</span> <span class="comment">// end of [_]
</span>        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>        <span class="keyword">val</span> hit_rec <span class="keyword">=</span> hityp_decode <span class="keyword">(</span>hit_rec<span class="keyword">)</span>
        <span class="keyword">var</span> iscast<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
        <span class="keyword">val</span> HITNAM <span class="keyword">(</span>knd<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> hit_rec<span class="keyword">.</span>hityp_name
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
          <span class="keyword">|</span> _ <span class="keyword">when</span> knd <span class="keyword">&gt;</span> 0 <span class="comment">(*ptr*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> iscast := 1
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_castptr_mac("<span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
            <span class="keyword">in</span>
              <span class="comment">// nothing
</span>            <span class="keyword">end</span> <span class="comment">// end of [_ when knd &gt; 0]
</span>          <span class="keyword">|</span> _ <span class="comment">(*nonptr*)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>  
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> offs<span class="keyword">,</span> froot<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> iscast <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_labelext <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> isext<span class="keyword">,</span> lab<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> istyarr <span class="keyword">then</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "[0]"<span class="keyword">)</span> <span class="comment">// HX: label for flat array
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// nothing
</span>      <span class="keyword">end</span> <span class="comment">// end of [OFFSETlab]
</span>    <span class="keyword">)</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> froot <span class="keyword">(</span>out<span class="keyword">)</span>
  <span class="keyword">val</span> offs <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_reverse_list_vt <span class="keyword">(</span>offs<span class="keyword">)</span>
<span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> offs<span class="keyword">,</span> froot<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_select_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_select
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">offsetlst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> emit_select_clo <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> offs<span class="keyword">,</span> <span class="keyword">lam</span> <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=&gt;</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [emit_valprim_select]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* knd=0/1: var/ptr *)</span>
<span class="keyword">fn</span> emit_valprim_select_varptr
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
  <span class="keyword">,</span> knd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> vp_root<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">offsetlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> aux_fst <span class="keyword">(</span>
    out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> knd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> vp_root<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> off<span class="keyword">:</span> <span class="staexp">offset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> off <span class="keyword">of</span>
    <span class="keyword">|</span> OFFSETind <span class="keyword">(</span>vpss<span class="keyword">,</span> hit_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
          <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_caselind_mac("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
          emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span><span class="keyword">;</span> <span class="comment">// ptr
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          emit_valprim_ptrof <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span><span class="keyword">;</span> <span class="comment">// var
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_array_index <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vpss<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// nothing
</span>      <span class="keyword">end</span> <span class="comment">// end of [OFFSETind]
</span>    <span class="keyword">|</span> OFFSETlab <span class="keyword">(</span>lab<span class="keyword">,</span> hit_rec<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_t_is_tyrecbox <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> isext <span class="keyword">=</span> false
          <span class="keyword">val</span> istyarr <span class="keyword">=</span> label_is_tyarr <span class="keyword">(</span>hit_rec<span class="keyword">,</span> lab<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
            <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_caselptr_mac("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_labelext <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> isext<span class="keyword">,</span> lab<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> istyarr <span class="keyword">then</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "[0]"<span class="keyword">)</span> <span class="comment">// HX: label for flat array
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_t_is_tyrecsin <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_ptrget_mac("<span class="keyword">)</span>
          <span class="keyword">else</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_varget_mac("<span class="keyword">)</span>
          <span class="comment">// end of [if]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">// HX: [hit_rec] is flat!
</span>          <span class="keyword">val</span> isext <span class="keyword">=</span> hityp_t_is_tyrecext hit_rec
          <span class="keyword">val</span> istyarr <span class="keyword">=</span> label_is_tyarr <span class="keyword">(</span>hit_rec<span class="keyword">,</span> lab<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_selptr_mac("<span class="keyword">)</span>
          <span class="keyword">else</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_select_mac("<span class="keyword">)</span>
          <span class="comment">// end of [if]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_castptr_mac("<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// nothing
</span>          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// nothing
</span>          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_labelext <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> isext<span class="keyword">,</span> lab<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> istyarr <span class="keyword">then</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "[0]"<span class="keyword">)</span> <span class="comment">// HX: label for flat array
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end [OFFSETlab]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux_fst]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> offs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>off_fst<span class="keyword">,</span> offs_rst<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_select_clo <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span>
        <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> offs_rst<span class="keyword">,</span> <span class="keyword">lam</span> <span class="keyword">(</span>out<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_fst <span class="keyword">(</span>out<span class="keyword">,</span> knd<span class="keyword">,</span> vp_root<span class="keyword">,</span> off_fst<span class="keyword">)</span><span class="keyword">)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
        prerr ": emit_valprim_select_varptr: vp_root = "<span class="keyword">;</span> prerr vp_root<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_valprim_select_varptr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_valprim_select_var <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
<span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vp_root<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">offsetlst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  emit_valprim_select_varptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> 0<span class="comment">(*var*)</span><span class="keyword">,</span> vp_root<span class="keyword">,</span> offs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_valprim_select_var]
</span>
<span class="keyword">fn</span> emit_valprim_select_ptr <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vp_root<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> offs<span class="keyword">:</span> <span class="staexp">offsetlst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  emit_valprim_select_varptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> 1<span class="comment">(*ptr*)</span><span class="keyword">,</span> vp_root<span class="keyword">,</span> offs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_valprim_select_ptr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{$

ats_void_type
atsccomp_emit_valprim_string (
  ats_ptr_type out, ats_ptr_type str, ats_size_type len
) {
  char *s = str; int i; char c;
//
  fputs ("(ats_ptr_type)", (FILE*)out);
  fputc ('"', (FILE*)out);
//
  for (i = 0; i &lt; len; i += 1, s += 1) {
    c = *s;
    switch (c) {
    case '"': fprintf ((FILE*)out, "\\\""); break;
    case '\n': fprintf ((FILE*)out, "\\n"); break;
    case '\t': fprintf ((FILE*)out, "\\t"); break;
    case '\\': fprintf ((FILE*)out, "\\\\"); break;
    default:
      if (isprint(c)) {
        fputc (c, (FILE*)out) ;
      } else {
        fprintf ((FILE*)out, "\\%.3o", (unsigned char)c);
      }
    } // end of [switch]
  } // end of [for]
//
  fputc ('"', (FILE*)out);
//
  return ;
} // end of [atsccomp_emit_valprim_string]

%}</span> <span class="comment">// end of [%{$]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="27428"><span class="dyncstdec">emit_valprim_string <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> str<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">,</span> len<span class="keyword">:</span> <span class="staexp">size_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
  <span class="keyword">=</span> "atsccomp_emit_valprim_string"
<span class="comment">// end of [emit_valprim_string]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_valprim_tmpvar
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> tmp_root <span class="keyword">=</span> tmpvar_root_get <span class="keyword">(</span>tmp<span class="keyword">)</span>
  <span class="keyword">val</span> tmp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> tmp_root <span class="keyword">of</span>
    <span class="keyword">|</span> TMPVAROPTsome tmp <span class="keyword">=&gt;</span> tmp <span class="keyword">|</span> TMPVAROPTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> tmp
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">tmpvar_t</span>
<span class="keyword">}</span> <span class="comment">// end of [emit_valprim_tmpvar]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_valprim
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> vp0<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
  <span class="keyword">|</span> VParg ind <span class="keyword">=&gt;</span> emit_valprim_arg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">)</span>
  <span class="keyword">|</span> VPargref ind <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_valprim_argref <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ind<span class="keyword">,</span> vp0<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPargref]
</span>  <span class="keyword">|</span> VPbool b <span class="keyword">=&gt;</span> emit_valprim_bool <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> b<span class="keyword">)</span>
  <span class="keyword">|</span> VPcastfn <span class="keyword">(</span>_d2c<span class="keyword">,</span> vp_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
        <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_castfn_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp0<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_arg<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [VPcast]
</span>  <span class="keyword">|</span> VPchar c <span class="keyword">=&gt;</span> emit_valprim_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> c<span class="keyword">)</span>
  <span class="keyword">|</span> VPclo <span class="keyword">(</span>knd<span class="keyword">,</span> fl<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      emit_valprim_clo_make <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> knd<span class="keyword">,</span> fl<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">|</span> VPcst d2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> d2cst_is_fun d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '&amp;'<span class="keyword">)</span>
      <span class="keyword">in</span>
        emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span> <span class="comment">// HX: is '&amp;' mandatory?
</span>      <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPcst]
</span>  <span class="keyword">|</span> VPcstsp <span class="keyword">(</span>loc<span class="keyword">,</span> cst<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cst <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>CSTSPfilename <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> fil <span class="keyword">=</span> $Loc<span class="keyword">.</span>location_get_filename <span class="keyword">(</span>loc<span class="keyword">)</span>
        <span class="keyword">val</span> name <span class="keyword">=</span> $Fil<span class="keyword">.</span>filename_full fil<span class="keyword">;</span> <span class="keyword">val</span> len <span class="keyword">=</span> string_length <span class="keyword">(</span>name<span class="keyword">)</span>
      <span class="keyword">in</span>
        emit_valprim_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">,</span> len<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [CSTSPfilename] *)</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>CSTSPlocation <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\""<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Loc<span class="keyword">.</span>fprint_location <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> loc<span class="keyword">)</span> 
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\""<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// nothing
</span>      <span class="keyword">end</span> <span class="comment">(* end of [CSTSPlocation] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPcstsp]
</span>  <span class="keyword">|</span> VPenv vtp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> d2v <span class="keyword">=</span> vartyp_var_get vtp
      <span class="keyword">val</span> ind <span class="keyword">=</span> varindmap_find_some <span class="keyword">(</span>d2v<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> d2var_is_mutable d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
            <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_ptrget_mac("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vartyp_typ_get vtp<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "env%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "env%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPenv]
</span>  <span class="keyword">|</span> VPext code <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> code<span class="keyword">)</span>
  <span class="keyword">|</span> VPfix <span class="keyword">(</span>vpr<span class="keyword">)</span> <span class="keyword">=&gt;</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> <span class="keyword">!</span>vpr<span class="keyword">)</span>
  <span class="keyword">|</span> VPfloat str <span class="keyword">=&gt;</span> emit_valprim_float <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> str<span class="keyword">)</span>
  <span class="keyword">|</span> VPfloatsp str <span class="keyword">=&gt;</span> emit_valprim_float <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> str<span class="keyword">)</span>
  <span class="keyword">|</span> VPfun fl <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "&amp;"<span class="keyword">)</span><span class="keyword">;</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPfun]
</span>  <span class="keyword">|</span> VPint <span class="keyword">(</span>int<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      $IntInf<span class="keyword">.</span>fprint_intinf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> int<span class="keyword">)</span>
  <span class="keyword">|</span> VPintsp <span class="keyword">(</span>str<span class="keyword">,</span> _<span class="comment">(*int*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> emit_valprim_intsp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> str<span class="keyword">)</span>
  <span class="keyword">|</span> VPptrof vp <span class="keyword">=&gt;</span> emit_valprim_ptrof <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">|</span> VPptrof_ptr_offs <span class="keyword">(</span>vp<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '&amp;'<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_select_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">,</span> offs<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPptrof_ptr_offs]
</span>  <span class="keyword">|</span> VPptrof_var_offs <span class="keyword">(</span>vp<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '&amp;'<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_select_var <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">,</span> offs<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPptrof_var_offs]
</span>  <span class="keyword">|</span> VPsizeof hit <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "sizeof("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [VPsizeof]
</span>  <span class="keyword">|</span> VPstring <span class="keyword">(</span>str<span class="keyword">,</span> len<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> len <span class="keyword">=</span> int1_of_int len<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert <span class="keyword">(</span>len &gt;= 0<span class="keyword">)</span>
    <span class="keyword">in</span>
      emit_valprim_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> str<span class="keyword">,</span> size1_of_int1 len<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [VPstring]
</span>  <span class="keyword">|</span> VPtmp tmp <span class="keyword">=&gt;</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> VPtmpref tmp <span class="keyword">=&gt;</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> VPtop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "?top"<span class="keyword">)</span> <span class="comment">// for debugging
</span>  <span class="keyword">|</span> VPvoid <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "?void"<span class="keyword">)</span> <span class="comment">// for debugging
</span><span class="comment">(*
  | _ =&gt; begin
      prerr_interror ();
      prerr ": emit_valprim: vp0 = "; prerr vp0; prerr_newline ();
      $Err.abort {void} ()
    end // end of [_]
*)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_valprim]
</span>
<span class="keyword">implement</span>
emit_valprimlst <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux
    <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> vps<span class="keyword">:</span> <span class="staexp">valprimlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> vps <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span><span class="keyword">;</span>
        emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> vps<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> vps<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_valprimlst]    
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_kont
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> kont<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> kont <span class="keyword">of</span>
  <span class="keyword">|</span> KONTtmplab tl <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "goto "<span class="keyword">)</span><span class="keyword">;</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [KONTtmplab]
</span>  <span class="keyword">|</span> KONTtmplabint <span class="keyword">(</span>tl<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "goto "<span class="keyword">)</span><span class="keyword">;</span> emit_tmplabint <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [KONTtmplabint]
</span>  <span class="keyword">|</span> KONTcaseof_fail <span class="keyword">(</span>loc<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_caseof_failure_handle (\""<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Loc<span class="keyword">.</span>fprint_location <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> loc<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\")"<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [KONTcaseof_fail]
</span>  <span class="keyword">|</span> KONTfunarg_fail <span class="keyword">(</span>loc<span class="keyword">,</span> fl<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_funarg_failure_handle (\""<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Loc<span class="keyword">.</span>fprint_location <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> loc<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\")"<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [KONTfunarg_fail]
</span>  <span class="keyword">|</span> KONTraise vp_exn <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_raise_exn ("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_exn<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [KONTraise]
</span>  <span class="keyword">|</span> KONTmatpnt mpt <span class="keyword">=&gt;</span> emit_matpnt <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> mpt<span class="keyword">)</span>
  <span class="keyword">|</span> KONTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_deadcode_failure_handle ()"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [KONTnone]
</span><span class="comment">(* end of [emit_kont] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="33538"><span class="dyncstdec">emit_patck <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> patck<span class="keyword">:</span> <span class="staexp">patck</span><span class="keyword">,</span> fail<span class="keyword">:</span> <span class="staexp">kont</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span>
emit_patck
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">,</span> patck<span class="keyword">,</span> fail<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> patck <span class="keyword">of</span>
  <span class="keyword">|</span> PATCKbool b <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
      <span class="keyword">if</span> b <span class="keyword">then</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '!'<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
      emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKbool]
</span>  <span class="keyword">|</span> PATCKchar c <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " != "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
      emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKchar]
</span>  <span class="keyword">|</span> PATCKcon d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2c <span class="keyword">=</span> d2con_scst_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2c <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_singular <span class="keyword">(</span>s2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_listlike <span class="keyword">(</span>s2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> isnil <span class="keyword">=</span> <span class="keyword">(</span>
            <span class="keyword">case+</span> s2cst_islst_get <span class="keyword">(</span>s2c<span class="keyword">)</span> <span class="keyword">of</span>
            <span class="keyword">|</span> Some x<span class="comment">(*nil,cons*)</span> <span class="keyword">=&gt;</span> eq_d2con_d2con <span class="keyword">(</span>d2c<span class="keyword">,</span> x<span class="keyword">.</span>0<span class="keyword">)</span>
            <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">(* deadcode *)</span>
          <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
          <span class="keyword">val</span> iscons <span class="keyword">=</span> not <span class="keyword">(</span>isnil<span class="keyword">)</span>
        <span class="keyword">in</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">if</span> isnil <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " != "<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">if</span> iscons <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " == "<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(ats_sum_ptr_type)0) { "<span class="keyword">)</span><span class="keyword">;</span>
          emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [s2cst_is_listlike]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if (((ats_sum_ptr_type)"<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")-&gt;tag != "<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2con_tag_get d2c<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
          emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKcon]
</span>  <span class="keyword">|</span> PATCKexn d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> arity <span class="keyword">=</span> d2con_arity_real_get d2c
    <span class="keyword">in</span>
      <span class="keyword">case+</span> arity <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> arity <span class="keyword">=</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " != &amp;"<span class="keyword">)</span><span class="keyword">;</span>
          emit_d2con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
          emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if (((ats_exn_ptr_type)"<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")-&gt;tag != "<span class="keyword">)</span><span class="keyword">;</span>
          emit_d2con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".tag) { "<span class="keyword">)</span><span class="keyword">;</span>
          emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKexn]
</span>  <span class="keyword">|</span> PATCKfloat <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " != "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_float <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> f<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
      emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKfloat]
</span>  <span class="keyword">|</span> PATCKint int <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " != "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> int<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") { "<span class="keyword">)</span><span class="keyword">;</span>
      emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKint]
</span>  <span class="keyword">|</span> PATCKstring str <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if (__strcmpats("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> str<span class="keyword">,</span> string0_length str<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) { "<span class="keyword">)</span><span class="keyword">;</span>
      emit_kont <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fail<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; }"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [PATCKstr]
</span><span class="comment">(*
  | _ =&gt; begin
      prerr_interror ();
      prerr ": emit_patck: not implemented yet"; prerr_newline ();
      $Err.abort {void} ()
    end // end of [_]
*)</span>
<span class="keyword">end</span> <span class="comment">(* end of [emit_patck] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="37611"><span class="dyncstdec">emit_branch <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> br<span class="keyword">:</span> <span class="staexp">branch</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span>
emit_branch
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> br<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> inss <span class="keyword">=</span> br<span class="keyword">.</span>branch_inss
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* branch: "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> br<span class="keyword">.</span>branch_lab<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> inss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span> <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss<span class="keyword">)</span><span class="keyword">;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\nbreak ;\n"<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_branch]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="38152"><span class="dyncstdec">emit_branchlst <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> brs<span class="keyword">:</span> <span class="staexp">branchlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span>
emit_branchlst <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> brs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> brs<span class="keyword">:</span> <span class="staexp">branchlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> brs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>br<span class="keyword">,</span> brs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
      <span class="keyword">in</span>
        emit_branch <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> br<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> brs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> brs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_branchlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_cloenv <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> map<span class="keyword">,</span> vtps<span class="keyword">,</span> i0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> aux_envmap <span class="keyword">(</span>
      out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
    <span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">envmap_t</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> envmap_find <span class="keyword">(</span>map<span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt vp <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
       <span class="keyword">|</span> _ <span class="keyword">when</span> d2var_is_mutable d2v <span class="keyword">=&gt;</span>
           emit_valprim_ptrof <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
         <span class="comment">// end of [_ when ...]
</span>       <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": emit_cloenv: None_vt: d2v = "<span class="keyword">;</span> prerr d2v<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="keyword">end</span> <span class="comment">// end of [envmap]
</span>
  <span class="keyword">fun</span> aux_main <span class="keyword">(</span>
      out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
    <span class="keyword">,</span> map<span class="keyword">:</span> <span class="staexp">envmap_t</span>
    <span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span>
    <span class="keyword">,</span> d2vs<span class="keyword">:</span> <span class="staexp">d2varlst_vt</span>
    <span class="keyword">,</span> err<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d2vs <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>d2v<span class="keyword">,</span> d2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> varindmap_find <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ind <span class="keyword">=&gt;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "env%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_envmap <span class="keyword">(</span>out<span class="keyword">,</span> map<span class="keyword">,</span> d2v<span class="keyword">)</span>
        <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        aux_main <span class="keyword">(</span>out<span class="keyword">,</span> map<span class="keyword">,</span> i+1<span class="keyword">,</span> d2vs<span class="keyword">,</span> err<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> i
  <span class="keyword">end</span> <span class="comment">// end of [aux_main]
</span>
  <span class="keyword">val</span> d2vs <span class="keyword">=</span> vartypset_d2varlst_make <span class="keyword">(</span>vtps<span class="keyword">)</span>
  <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> n <span class="keyword">=</span> aux_main <span class="keyword">(</span>out<span class="keyword">,</span> map<span class="keyword">,</span> i0<span class="keyword">,</span> d2vs<span class="keyword">,</span> err<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  n - i0 <span class="comment">// the number of variables in the closure environment
</span><span class="keyword">end</span> <span class="comment">// end of [emit_cloenv]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_move_con <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
  <span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span>
  <span class="keyword">,</span> hit_sum<span class="keyword">:</span> <span class="staexp">hityp_t</span>
  <span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2con_t</span>
  <span class="keyword">,</span> vps<span class="keyword">:</span> <span class="staexp">valprimlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> vps <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = ATS_MALLOC(sizeof("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_sum<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> 0 <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> d2con_is_exn <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "((ats_exn_ptr_type)"<span class="keyword">)</span><span class="keyword">;</span>
            emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")-&gt;tag = "<span class="keyword">)</span><span class="keyword">;</span>
            emit_d2con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".tag ;\n"<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "((ats_exn_ptr_type)"<span class="keyword">)</span><span class="keyword">;</span>
            emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")-&gt;name = "<span class="keyword">)</span><span class="keyword">;</span>
            emit_d2con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".name ;"<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> s2c <span class="keyword">=</span> d2con_scst_get d2c
          <span class="keyword">in</span>
            <span class="keyword">case+</span> 0 <span class="keyword">of</span>
            <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_singular s2c <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_listlike s2c <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span><span class="keyword">;</span>
                fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "((ats_sum_ptr_type)"<span class="keyword">)</span><span class="keyword">;</span>
                emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
                fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")-&gt;tag = "<span class="keyword">)</span><span class="keyword">;</span>
                fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2con_tag_get d2c<span class="keyword">)</span><span class="keyword">;</span>
                fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
              <span class="keyword">end</span>
          <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_arg <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">fun</span> aux_arg <span class="keyword">(</span>
          out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
        <span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> vps<span class="keyword">:</span> <span class="staexp">valprimlst</span>
        <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> vps <span class="keyword">of</span>
          <span class="keyword">|</span> list_cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
                <span class="keyword">case+</span> vp<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
                <span class="keyword">|</span> VPtop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
                <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">//
</span>                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
<span class="comment">//
</span>                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
                      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_selptrset_mac("<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_sum<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "atslab_%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
                  <span class="keyword">}</span> <span class="comment">// end of [_]
</span>              <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>            <span class="keyword">in</span>
              aux_arg <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> vps<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>          <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [aux_arg]
</span>      <span class="keyword">}</span> <span class="comment">// end of [where]
</span>    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2c <span class="keyword">=</span> d2con_scst_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_listlike s2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = (ats_sum_ptr_type)0 ;"<span class="keyword">)</span><span class="keyword">;</span>
        <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = (ats_sum_ptr_type)(&amp;"<span class="keyword">)</span><span class="keyword">;</span>
          emit_d2con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_move_con]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_instr_assgn_arr <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
  <span class="keyword">,</span> vp_arr<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> vp_asz<span class="keyword">:</span> <span class="staexp">valprim</span>
  <span class="keyword">,</span> tmp_elt<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> vp_tsz<span class="keyword">:</span> <span class="staexp">valprim</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* array initialization */\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "atspre_array_ptr_initialize_elt_tsz ("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_arr<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_asz<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "&amp;"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_elt<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_tsz<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_instr_assgn_arr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*

// This definition should not be changed!!!
viewtypedef
arraysize_viewt0ype_int_viewt0ype (a: viewt@ype, n:int) =
  [l:addr | l &lt;&gt; null] (free_gc_v (a, n, l), @[a][n] @ l | ptr l, int n)

*)</span>

<span class="keyword">fn</span> emit_instr_arr_heap <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> asz<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hit_elt<span class="keyword">:</span> <span class="staexp">hityp_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* array allocation on heap */\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".atslab_2 = atspre_array_ptr_alloc_tsz ("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> asz<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", sizeof("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".atslab_3 = "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> asz<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;\n"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_instr_arr_heap]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> emit_instr_arr_stack <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
  <span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> level<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> vp_asz<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">,</span> hit_elt<span class="keyword">:</span> <span class="staexp">hityp_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* array allocation on stack */\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> level <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = ATS_ALLOCA2("<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="comment">(* level = 0 *)</span> <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = ATS_MALLOC2("<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_asz<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", sizeof("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_instr_arr_stack]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d2cst_fun_is_void
  <span class="keyword">(</span>d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  hityp_t_fun_is_void <span class="keyword">(</span>d2cst_hityp_get_some d2c<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funlab_fun_is_void]
</span>
<span class="keyword">fn</span> funlab_fun_is_void
  <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  hityp_t_is_void <span class="keyword">(</span>funlab_typ_res_get fl<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funlab_fun_is_void]
</span>
<span class="keyword">fun</span> emit_instr_call
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
  <span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span>
  <span class="keyword">,</span> hit_fun<span class="keyword">:</span> <span class="staexp">hityp_t</span>
  <span class="keyword">,</span> vp_fun<span class="keyword">:</span> <span class="staexp">valprim</span>
  <span class="keyword">,</span> vps_arg<span class="keyword">:</span> <span class="staexp">valprimlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = (
    print "emit_instr_call: vp_fun = "; print_valprim vp_fun; print_newline ()
  ) // end of [val]
*)</span>
  <span class="keyword">val</span> noret <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> vp_fun<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
    <span class="keyword">|</span> VPcst d2c <span class="keyword">=&gt;</span> d2cst_fun_is_void <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">|</span> VPclo <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> fl<span class="keyword">,</span> _<span class="comment">(*env*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> funlab_fun_is_void <span class="keyword">(</span>fl<span class="keyword">)</span>
    <span class="keyword">|</span> VPfun fl <span class="keyword">=&gt;</span> funlab_fun_is_void <span class="keyword">(</span>fl<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hityp_t_fun_is_void hit_fun
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> noret <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> noret <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "*/ "<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="comment">//
</span><span class="keyword">case+</span> vp_fun<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
<span class="comment">//
</span><span class="keyword">|</span> VPcst <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">when</span> d2cst_is_fun <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ("<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [VPcst]
</span><span class="comment">//
</span><span class="keyword">|</span> VPclo <span class="keyword">(</span>knd<span class="keyword">,</span> fl<span class="keyword">,</span> envmap<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> entry <span class="keyword">=</span> funlab_entry_get_some <span class="keyword">(</span>fl<span class="keyword">)</span>
    <span class="keyword">val</span> vtps <span class="keyword">=</span> funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ("<span class="keyword">)</span>
    <span class="keyword">val</span> n <span class="keyword">=</span> emit_cloenv <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> envmap<span class="keyword">,</span> vtps<span class="keyword">,</span> 0<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> vps_arg <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [VPclo]
</span><span class="comment">//
</span><span class="keyword">|</span> VPfun fl <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ("<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [VPfun]
</span><span class="comment">//
</span><span class="keyword">|</span> VPfix <span class="keyword">(</span>vpr<span class="keyword">)</span> <span class="keyword">=&gt;</span> emit_instr_call <span class="keyword">(</span>
    <span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">,</span> hit_fun<span class="keyword">,</span> <span class="keyword">!</span>vpr<span class="keyword">,</span> vps_arg
  <span class="keyword">)</span> <span class="comment">// end of [VPfix]
</span><span class="comment">//
</span><span class="keyword">|</span> _ <span class="comment">(*variadic function*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> hit_fun <span class="keyword">=</span> hityp_decode <span class="keyword">(</span>hit_fun<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> hit_fun<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
    <span class="keyword">|</span> HITfun <span class="keyword">(</span>fc<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> fc <span class="keyword">of</span>
      <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo _<span class="comment">(*knd*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hityplst_encode hits_arg
          <span class="keyword">val</span> hit_res <span class="keyword">=</span> hityp_encode hit_res
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_clofun <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")(ats_closure_fun("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_fun<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "))) ("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_fun<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> $Lst<span class="keyword">.</span>list_is_cons <span class="keyword">(</span>vps_arg<span class="keyword">)</span> <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [FUNCLOclo]
</span>      <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hityplst_encode hits_arg
          <span class="keyword">val</span> hit_res <span class="keyword">=</span> hityp_encode hit_res
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "(("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_fun <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_fun<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprimlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// nothing
</span>        <span class="keyword">end</span> <span class="comment">// end of [FUNCLOfun]
</span>      <span class="keyword">end</span> <span class="comment">// end of [HITfun]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": emit_instr_call: hit_fun = "<span class="keyword">;</span> prerr_hityp hit_fun<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="comment">// end of [case]
</span>  <span class="keyword">end</span> <span class="comment">(* end of [_(*variadic function*)] *)</span>
<span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_instr_call]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_instr <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ins<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span><span class="comment">// generating #line progma for debugging
</span><span class="comment">//
</span>  <span class="keyword">val</span> gline <span class="keyword">=</span> $Deb<span class="keyword">.</span>gline_flag_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> gline <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span>
    $Loc<span class="keyword">.</span>fprint_line_pragma <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ins<span class="keyword">.</span>instr_loc<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> ndeb <span class="keyword">=</span> $Deb<span class="keyword">.</span>debug_flag_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// generating informaion for debugging
</span>    <span class="keyword">if</span> ndeb <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_instr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ins<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> ins<span class="keyword">.</span>instr_node <span class="keyword">of</span>
  <span class="keyword">|</span> INSTRarr_heap <span class="keyword">(</span>tmp<span class="keyword">,</span> asz<span class="keyword">,</span> hit_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_instr_arr_heap <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">,</span> asz<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRarr_heap]
</span>  <span class="keyword">|</span> INSTRarr_stack <span class="keyword">(</span>tmp<span class="keyword">,</span> level<span class="keyword">,</span> vp_asz<span class="keyword">,</span> hit_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_instr_arr_stack <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">,</span> level<span class="keyword">,</span> vp_asz<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRarr_heap]
</span>  <span class="keyword">|</span> INSTRassgn_arr <span class="keyword">(</span>vp_arr<span class="keyword">,</span> vp_asz<span class="keyword">,</span> tmp_elt<span class="keyword">,</span> vp_tsz<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_instr_assgn_arr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_arr<span class="keyword">,</span> vp_asz<span class="keyword">,</span> tmp_elt<span class="keyword">,</span> vp_tsz<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRassgn_arr]
</span>  <span class="keyword">|</span> INSTRassgn_clo <span class="keyword">(</span>vp_clo<span class="keyword">,</span> fl<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_clo<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span>  <span class="keyword">|</span> out<span class="keyword">,</span> " = ATS_ALLOCA(sizeof("<span class="keyword">)</span><span class="keyword">;</span>
      emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_type)) ;\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_clo_init <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> 0<span class="comment">(*unboxed*)</span><span class="keyword">,</span> vp_clo<span class="keyword">,</span> fl<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; // closure initialization"<span class="keyword">)</span><span class="keyword">;</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRassgn_clo]
</span>  <span class="keyword">|</span> INSTRcall <span class="keyword">(</span>tmp<span class="keyword">,</span> hit_fun<span class="keyword">,</span> vp_fun<span class="keyword">,</span> vps_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_instr_call <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">,</span> hit_fun<span class="keyword">,</span> vp_fun<span class="keyword">,</span> vps_arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRcall]
</span>  <span class="keyword">|</span> INSTRcall_tail fl <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "goto "<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__ats_lab_"<span class="keyword">)</span><span class="keyword">;</span>
      emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; // tail call"<span class="keyword">)</span>      
    <span class="keyword">end</span> <span class="comment">// end of [INSTRcall_tail]
</span>  <span class="keyword">|</span> INSTRcond <span class="keyword">(</span>vp_cond<span class="keyword">,</span> inss_then<span class="keyword">,</span> inss_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if ("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_cond<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") {\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_then<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n} else {\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_else<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n} /* end of [if] */"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRcond]
</span>  <span class="keyword">|</span> INSTRdefine_clo <span class="keyword">(</span>d2c<span class="keyword">,</span> fl<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_GC_MARKROOT(&amp;"<span class="keyword">)</span><span class="keyword">;</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", sizeof(ats_ptr_type)) ;\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
      emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_make () ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRdefine_clo]
</span>  <span class="keyword">|</span> INSTRdefine_fun <span class="keyword">(</span>d2c<span class="keyword">,</span> fl<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = &amp;"<span class="keyword">)</span><span class="keyword">;</span>
      emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRdefine_fun]
</span>  <span class="keyword">|</span> INSTRdefine_val <span class="keyword">(</span>d2c<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_GC_MARKROOT(&amp;"<span class="keyword">)</span><span class="keyword">;</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", sizeof("<span class="keyword">)</span><span class="keyword">;</span>
      emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">.</span>valprim_typ<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRdefine_val]
</span>  <span class="keyword">|</span> INSTRextval <span class="keyword">(</span>name<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_GC_MARKROOT(&amp;"<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", sizeof("<span class="keyword">)</span><span class="keyword">;</span>
      emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">.</span>valprim_typ<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;\n"<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> name<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRextval]
</span>  <span class="keyword">|</span> INSTRfreeptr vp <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_FREE("<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRfreeptr]
</span>  <span class="keyword">|</span> INSTRfunction
      <span class="keyword">(</span>tmp_ret_all<span class="keyword">,</span> vps_arg<span class="keyword">,</span> inss_body<span class="keyword">,</span> tmp_ret<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funarglst_push <span class="keyword">(</span>vps_arg<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_body<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funarglst_pop <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> tmpvar_is_void tmp_ret <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "return /* "<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_ret<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */ ;\n"<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "return "<span class="keyword">)</span><span class="keyword">;</span>
          emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_ret<span class="keyword">)</span><span class="keyword">;</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;\n"<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRfunction]
</span>  <span class="keyword">|</span> INSTRfunlab fl <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__ats_lab_"<span class="keyword">)</span><span class="keyword">;</span>
      emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ':'<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRfunlab]
</span>  <span class="keyword">|</span> INSTRdynload_file fil <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_filename <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fil<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__dynload () ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRdynload_file]
</span>  <span class="keyword">|</span> INSTRload_ptr <span class="keyword">(</span>tmp<span class="keyword">,</span> vp_ptr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_ptrget_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmpvar_typ_get tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_ptr<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRload_ptr]
</span>  <span class="keyword">|</span> INSTRload_ptr_offs <span class="keyword">(</span>tmp<span class="keyword">,</span> vp_ptr<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_select_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_ptr<span class="keyword">,</span> offs<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRload_ptr_offs]
</span>  <span class="keyword">|</span> INSTRload_var_offs <span class="keyword">(</span>tmp<span class="keyword">,</span> vp_var<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim_select_var <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_var<span class="keyword">,</span> offs<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRload_var_offs]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRloop <span class="keyword">(</span>
      tl_init<span class="keyword">,</span> tl_fini<span class="keyword">,</span> tl_cont
    <span class="keyword">,</span> inss_init
    <span class="keyword">,</span> vp_test<span class="keyword">,</span> inss_test
    <span class="keyword">,</span> inss_post
    <span class="keyword">,</span> inss_body
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* loop initialization */\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_init<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n"<span class="keyword">)</span>
      <span class="keyword">val</span> ispost <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_is_cons inss_post <span class="comment">// this is a for loop
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_loop_beg_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl_init<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_test<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "if (!"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_test<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") break ;\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_body<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> ispost <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* post update before continue */\n"<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl_cont<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ":\n"<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss_post<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n"<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// empty
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_loop_end_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl_init<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl_fini<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRloop]
</span>  <span class="keyword">|</span> INSTRloopexn <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> tl<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "goto "<span class="keyword">)</span><span class="keyword">;</span>
      emit_tmplab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRloopexn]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRmove_arg <span class="keyword">(</span>arg<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "arg%i = "<span class="keyword">,</span> <span class="keyword">@(</span>arg<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_arg]
</span>  <span class="keyword">|</span> INSTRmove_con <span class="keyword">(</span>tmp<span class="keyword">,</span> hit_sum<span class="keyword">,</span> d2c<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_move_con <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">,</span> hit_sum<span class="keyword">,</span> d2c<span class="keyword">,</span> vps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_con]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRmove_lazy_delay <span class="keyword">(</span>tmp<span class="keyword">,</span> lin<span class="keyword">,</span> hit_body<span class="keyword">,</span> vp_clo<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> lin <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_instr_move_lazy_delay_mac ("<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_instr_move_lazy_vt_delay_mac ("<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_body<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_clo<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_lazy_delay]
</span>  <span class="keyword">|</span> INSTRmove_lazy_force <span class="keyword">(</span>tmp<span class="keyword">,</span> lin<span class="keyword">,</span> hit_val<span class="keyword">,</span> vp_lazy<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> lin <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_instr_move_lazy_force_mac ("<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_instr_move_lazy_vt_force_mac ("<span class="keyword">)</span>        
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_val<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_lazy<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_lazy_delay]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRmove_rec_box
      <span class="keyword">(</span>tmp<span class="keyword">,</span> hit_rec<span class="keyword">,</span> lvps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> isext <span class="keyword">=</span>
        hityp_t_is_tyrecext hit_rec
      <span class="comment">// end of [val]
</span>      <span class="keyword">fun</span> aux <span class="keyword">(</span>
        out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span>
      <span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> lvps<span class="keyword">:</span> <span class="staexp">labvalprimlst</span>
      <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> lvps <span class="keyword">of</span>
        <span class="keyword">|</span> LABVALPRIMLSTcons
            <span class="keyword">(</span>l<span class="keyword">,</span> vp<span class="keyword">,</span> lvps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
              <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_selptrset_mac("<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_labelext <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> isext<span class="keyword">,</span> l<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
          <span class="keyword">in</span>
            aux <span class="keyword">(</span>out<span class="keyword">,</span> tmp<span class="keyword">,</span> lvps<span class="keyword">)</span>
          <span class="keyword">end</span>
        <span class="keyword">|</span> LABVALPRIMLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="comment">// end of [aux]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = ATS_MALLOC(sizeof("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")) ;\n"<span class="keyword">)</span>
    <span class="keyword">in</span>
      aux <span class="keyword">(</span>out<span class="keyword">,</span> tmp<span class="keyword">,</span> lvps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_rec_box]
</span>  <span class="keyword">|</span> INSTRmove_rec_flt
      <span class="keyword">(</span>tmp<span class="keyword">,</span> hit_rec<span class="keyword">,</span> lvps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> isext <span class="keyword">=</span> hityp_t_is_tyrecext hit_rec
      <span class="keyword">fun</span> aux <span class="keyword">(</span>
          out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> lvps<span class="keyword">:</span> <span class="staexp">labvalprimlst</span>
        <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> lvps <span class="keyword">of</span>
        <span class="keyword">|</span> LABVALPRIMLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> v<span class="keyword">,</span> lvps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isext <span class="keyword">then</span>
              fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "."<span class="keyword">)</span>
            <span class="keyword">else</span>
              fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ".atslab_"<span class="keyword">)</span>
            <span class="comment">// end of [if]
</span>            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_label <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> l<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> v<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;\n"<span class="keyword">)</span>
          <span class="keyword">in</span>
            aux <span class="keyword">(</span>out<span class="keyword">,</span> tmp<span class="keyword">,</span> lvps<span class="keyword">)</span>
          <span class="keyword">end</span>
        <span class="keyword">|</span> LABVALPRIMLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>    <span class="keyword">in</span>
      aux <span class="keyword">(</span>out<span class="keyword">,</span> tmp<span class="keyword">,</span> lvps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_rec_flt]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRmove_ref <span class="keyword">(</span>tmp<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
        <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_instr_move_ref_mac ("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_ref]
</span>  <span class="keyword">|</span> INSTRmove_val <span class="keyword">(</span>tmp<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> isvoid <span class="keyword">=</span> valprim_is_void vp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isvoid <span class="keyword">then</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isvoid <span class="keyword">then</span>
        fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRmove_val]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRpatck <span class="keyword">(</span>vp<span class="keyword">,</span> patck<span class="keyword">,</span> fail<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> fail1 <span class="keyword">=</span> <span class="keyword">case+</span> fail <span class="keyword">of</span>
        <span class="keyword">|</span> KONTmatpnt mpt <span class="keyword">=&gt;</span> matpnt_kont_get mpt <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> fail
      <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> fail1 <span class="keyword">of</span>
        <span class="keyword">|</span> KONTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "// "<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      emit_patck <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp<span class="keyword">,</span> patck<span class="keyword">,</span> fail<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRpatck]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRraise <span class="keyword">(</span>tmp<span class="keyword">,</span> vp_exn<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = */ ats_raise_exn ("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_exn<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [INSTRraise]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRselect <span class="keyword">(</span>tmp<span class="keyword">,</span> vp_root<span class="keyword">,</span> offs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> is_void <span class="keyword">=</span> tmpvar_is_void tmp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> is_void <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_select <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_root<span class="keyword">,</span> offs<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> is_void <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRselect]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRselcon <span class="keyword">(</span>
      tmp<span class="keyword">,</span> vp_sum<span class="keyword">,</span> hit_sum<span class="keyword">,</span> ind
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_caselptr_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_sum<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_sum<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "atslab_%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRselcon]
</span>  <span class="keyword">|</span> INSTRselcon_ptr <span class="keyword">(</span>
      tmp<span class="keyword">,</span> vp_sum<span class="keyword">,</span> hit_sum<span class="keyword">,</span> ind
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "&amp;ats_caselptr_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_sum<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_sum<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "atslab_%i"<span class="keyword">,</span> <span class="keyword">@(</span>ind<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRselcon_ptr]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRstore_ptr <span class="keyword">(</span>vp_ptr<span class="keyword">,</span> vp_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
        <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_ptrget_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_val<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_ptr<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_val<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRstore_ptr]
</span>  <span class="keyword">|</span> INSTRstore_ptr_offs
      <span class="keyword">(</span>vp_ptr<span class="keyword">,</span> offs<span class="keyword">,</span> vp_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_select_ptr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_ptr<span class="keyword">,</span> offs<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_val<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRstore_ptr_offs]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRstore_var
      <span class="keyword">(</span>vp_mut<span class="keyword">,</span> vp_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_mut<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_val<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRstore_var]
</span>  <span class="keyword">|</span> INSTRstore_var_offs
      <span class="keyword">(</span>vp_var<span class="keyword">,</span> offs<span class="keyword">,</span> vp_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_select_var <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_var<span class="keyword">,</span> offs<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " = "<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vp_val<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// nothing
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRstore_ptr]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRswitch branchlst <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "do {\n"<span class="keyword">)</span><span class="keyword">;</span>
      emit_branchlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> branchlst<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "} while (0) ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRswitch]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRtmplabint <span class="keyword">(</span>tl<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_tmplabint <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tl<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">;</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ':'<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRtmplabint]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRprfck_beg <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_proofcheck_beg_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRprfck_beg]
</span>  <span class="keyword">|</span> INSTRprfck_end <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_proofcheck_end_mac("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRprfck_end]
</span>  <span class="keyword">|</span> INSTRprfck_tst <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      emit_d2cst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> d2c<span class="keyword">)</span><span class="keyword">;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_prfck () ;"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRprfck_end]
</span><span class="comment">//
</span>  <span class="keyword">|</span> INSTRtrywith <span class="keyword">(</span>res_try<span class="keyword">,</span> tmp_exn<span class="keyword">,</span> brs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_TRYWITH_TRY("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_exn<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> res_try<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_TRYWITH_WITH("<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_valprim_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_exn<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "do {\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_branchlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> brs<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "} while (0) ;\n"<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_TRYWITH_END() ;\n"<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [INSTRtrywith]
</span>  <span class="keyword">|</span> INSTRvardec tmp <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span><span class="keyword">;</span>
      emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmpvar_typ_get tmp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ' '<span class="keyword">)</span><span class="keyword">;</span>
      emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span>
      fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ; */"<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRvardec]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": emit_instr: ins = "<span class="keyword">;</span> prerr ins<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_instr]
</span>
<span class="keyword">implement</span>
emit_instrlst <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> inss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> inss<span class="keyword">:</span> <span class="staexp">instrlst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> inss <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>ins<span class="keyword">,</span> inss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span><span class="keyword">;</span>
        emit_instr <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ins<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> inss<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* empty */"<span class="keyword">)</span>
      <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> inss<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_instrlst]    
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="69278"><span class="dyncstdec">emit_funarg <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="comment">// end of [emit_funarg]
</span>
<span class="keyword">implement</span>
emit_funarg <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> hits <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> _emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// variadacity needs to be properly handled
</span>          <span class="keyword">if</span> hityp_is_vararg hit <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " arg"<span class="keyword">)</span><span class="keyword">;</span> fprint1_int <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> i<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">in</span>
        loop <span class="keyword">(</span>out<span class="keyword">,</span> i + 1<span class="keyword">,</span> hits<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [list_cons] *)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>out<span class="keyword">,</span> 0<span class="keyword">,</span> hityplst_decode hits<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [emit_funarg]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="70093"><span class="dyncstdec">emit_funenvarg <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span></span></a>
<span class="comment">// end of [emit_funenvarg]
</span>
<span class="keyword">local</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="70228"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>

<span class="keyword">fn</span> _emit_funenvarg <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">viewdef</span> <span class="staexp"><a name="70452"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="70492"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f_arg <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span><span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> vartyp_var_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">val</span> hit <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> d2var_is_mutable <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">then</span> hityp_encode hityp_ptr
      <span class="keyword">else</span> vartyp_typ_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp_t</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hit<span class="keyword">)</span> <span class="comment">// type specifier
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " env%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span> <span class="comment">// arg
</span>  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span>
  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span>p_l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_arg<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="keyword">in</span>
  i <span class="comment">// the number of environment variables
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_funenvarg]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span>
emit_funenvarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vtps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_funenvarg <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> vtps<span class="keyword">)</span>
<span class="comment">// end of [emit_funenvarg]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> funentry_env_err
  <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> d2vs <span class="keyword">=</span> vartypset_d2varlst_make <span class="keyword">(</span>vtps<span class="keyword">)</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_vt_length__boxed <span class="keyword">(</span>d2vs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> prerr_loc_errorccomp loc <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 1 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr ": the dynamic variables ["
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr ": the dynamic variable ["
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">fun</span> aux <span class="keyword">(</span>d2vs<span class="keyword">:</span> <span class="staexp">d2varlst_vt</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d2vs <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>d2v<span class="keyword">,</span> d2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> prerr ", "<span class="keyword">;</span> prerr d2v<span class="keyword">;</span> aux <span class="keyword">(</span>d2vs<span class="keyword">,</span> i+1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>d2vs<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 1 <span class="keyword">then</span> <span class="keyword">begin</span>
    prerr "] are not function arguments."
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr "] is not a function argument."
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [funentry_env_err]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="72587"><span class="dyncstdec">emit_closure_type <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="72711"><span class="dyncstdec">emit_closure_init <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="72835"><span class="dyncstdec">emit_closure_make <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="72959"><span class="dyncstdec">emit_closure_clofun <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span> <span class="keyword">|</span> out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">fn</span> _emit_closure_type
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">dataviewtype</span> <span class="staexp"><a name="73278"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon2 <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">viewdef</span> <span class="staexp"><a name="73361"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="73401"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f_fld <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span><span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> vartyp_var_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">val</span> hit <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> d2var_is_mutable <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">then</span> hityp_encode hityp_ptr
      <span class="keyword">else</span> vartyp_typ_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp_t</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hit<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " closure_env_%i ;\n"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "typedef struct {\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ats_fun_ptr_type closure_fun ;\n"<span class="keyword">)</span>

  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_fld<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon2 <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "} "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_type ;"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_closure_type]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> _emit_closure_init
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">dataviewtype</span> <span class="staexp"><a name="74658"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon2 <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninitialized
</span>  <span class="keyword">viewdef</span> <span class="staexp"><a name="74754"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="74794"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f_arg <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> vartyp_var_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">val</span> hit <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> d2var_is_mutable <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">then</span> hityp_encode hityp_ptr
      <span class="keyword">else</span> vartyp_typ_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp_t</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hit<span class="keyword">)</span><span class="keyword">;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " env%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [f_arg]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> f_body <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn
      <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "p_clo-&gt;closure_env_%i = env%i ;\n"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [f_body]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATSinline()\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ats_void_type\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_init ("<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_type *p_clo"<span class="keyword">)</span>
<span class="comment">//  
</span>  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> i := 0
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_arg<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") {\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "p_clo-&gt;closure_fun = (ats_fun_ptr_type)&amp;"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_clofun ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> i := 0
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_body<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon2 <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "return ;\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "} /* end of function */"<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_closure_init]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> _emit_closure_make
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">dataviewtype</span> <span class="staexp"><a name="77073"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon2 <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninitialized
</span>  <span class="keyword">viewdef</span> <span class="staexp"><a name="77169"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="77209"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
<span class="comment">//
</span>  <span class="keyword">fn</span> f_arg <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> d2v <span class="keyword">=</span> vartyp_var_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">val</span> hit <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> d2var_is_mutable <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">then</span> hityp_encode hityp_ptr
      <span class="keyword">else</span> vartyp_typ_get <span class="keyword">(</span>vtp<span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp_t</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hit<span class="keyword">)</span><span class="keyword">;</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " env%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [f_arg]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ats_clo_ptr_type\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_make ("<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon2 <span class="keyword">(</span>p_l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> i := 0
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_arg<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val</span> narg <span class="keyword">=</span> i
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") {\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_type *p_clo = ATS_MALLOC(sizeof("<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_type)) ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_init (p_clo"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="keyword">!</span>p_l<span class="keyword">,</span> narg<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
      <span class="keyword">if</span> i <span class="keyword">&lt;</span> n <span class="keyword">then</span> <span class="keyword">begin</span>
        fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", env%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>out<span class="keyword">,</span> n<span class="keyword">,</span> i+1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="comment">// end of [loop]
</span>  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon2 <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "return (ats_clo_ptr_type)p_clo ;\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "} /* end of function */"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_closure_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> _emit_closure_clofun
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">fmlte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> p_l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp">funlab_t</span><span class="keyword">,</span> vtps<span class="keyword">:</span> <span class="staexp">vartypset</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">dataviewtype</span> <span class="staexp"><a name="79374"><span class="stacstdec">ENV <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon3 <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>funlab_t<span class="keyword">,</span> ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>
  <span class="comment">// function header
</span>  <span class="keyword">val</span> hit_res <span class="keyword">=</span> funlab_typ_res_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hit_res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> '\n'<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_clofun (ats_clo_ptr_type cloptr"<span class="keyword">)</span>
  <span class="keyword">val</span> hits_arg <span class="keyword">=</span> funlab_typ_arg_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons hits_arg <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funarg <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") {\n"<span class="keyword">)</span>

  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">viewdef</span> <span class="staexp"><a name="80011"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="80051"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f_env <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> vtp<span class="keyword">:</span> <span class="staexp">vartyp_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon3 <span class="keyword">(</span>fl<span class="keyword">,</span> p_l<span class="keyword">,</span> p_i<span class="keyword">)</span> <span class="keyword">=</span> env
    <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>p_i<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "(("<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn
      <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "_closure_type*)cloptr)-&gt;closure_env_%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [f_end]
</span>
  <span class="keyword">val</span> is_void <span class="keyword">=</span> hityp_t_is_void <span class="keyword">(</span>hit_res<span class="keyword">)</span> <span class="comment">// function body
</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> is_void <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "return "<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " ("<span class="keyword">)</span>

  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon3 <span class="keyword">(</span>fl<span class="keyword">,</span> p_l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vartypset_foreach_main <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> vtps<span class="keyword">,</span> f_env<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon3 <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// print a comma for separation if needed
</span>    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons hits_arg <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [val]
</span>
  <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hityplst_decode <span class="keyword">(</span>hits_arg<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_arglst <span class="keyword">(</span><span class="keyword">!</span>p_l<span class="keyword">,</span> 0<span class="keyword">,</span> hits_arg<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> emit_arglst <span class="comment">// tailrec
</span>      <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">)</span>
      <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hits <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [val]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> out<span class="keyword">,</span> "arg%i"<span class="keyword">,</span> <span class="keyword">@(</span>i<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          emit_arglst <span class="keyword">(</span>out<span class="keyword">,</span> i+1<span class="keyword">,</span> hits<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [emit_arglst]
</span>  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") ;"<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> is_void <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> " return ;"<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "\n} /* end of function */"<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_clofun]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_closure_type <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_closure_type <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span>
<span class="comment">// end of [emit_closure_type]
</span>
<span class="keyword">implement</span>
emit_closure_init <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_closure_init <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span>
<span class="comment">// end of [emit_closure_init]
</span>
<span class="keyword">implement</span>
emit_closure_make <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_closure_make <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span>
<span class="comment">// end of [emit_closure_make]
</span>
<span class="keyword">implement</span>
emit_closure_clofun <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_closure_clofun <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps<span class="keyword">)</span>
<span class="comment">// end of [emit_closure_clofun]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hityplst_nvararg_get
  <span class="keyword">(</span>hits<span class="keyword">:</span> <span class="staexp">hityplst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hits <span class="keyword">=</span> hityplst_decode hits <span class="keyword">in</span>
  <span class="keyword">case+</span> hits <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>0<span class="keyword">,</span> hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">fun</span> loop <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> hit<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span>
        <span class="keyword">case+</span> hits <span class="keyword">of</span>
        <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>n+1<span class="keyword">,</span> hit<span class="keyword">,</span> hits<span class="keyword">)</span>
        <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">if</span> hityp_is_vararg hit <span class="keyword">then</span> n <span class="keyword">else</span> ~1
      <span class="comment">// end of [loop]
</span>    <span class="keyword">}</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ~1
<span class="keyword">end</span> <span class="comment">// end of [hityplst_nvararg_get]
</span>
<span class="keyword">implement</span>
emit_funentry <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> entry<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> fl <span class="keyword">=</span> funentry_lab_get <span class="keyword">(</span>entry<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "emit_funentry: fl = "; print_funlab fl; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> fc <span class="keyword">=</span> funlab_funclo_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> hits_arg <span class="keyword">=</span> funlab_typ_arg_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> nvararg <span class="keyword">=</span> hityplst_nvararg_get <span class="keyword">(</span>hits_arg<span class="keyword">)</span>
  <span class="keyword">val</span> hit_res <span class="keyword">=</span> funlab_typ_res_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> vtps_all <span class="keyword">=</span> funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "emit_funentry: vtps_all = "; print_vartypset vtps_all; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> loc_entry <span class="keyword">=</span> funentry_loc_get entry
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> fc <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        funentry_env_err <span class="keyword">(</span>loc_entry<span class="keyword">,</span> fl<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [FUNCLOfun]
</span>    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">(*
  val () = begin
    print "emit_funentry: after [funentry_env_err]"; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> tmp_ret <span class="keyword">=</span> funentry_ret_get <span class="keyword">(</span>entry<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funentry_varindmap_set <span class="keyword">(</span>vtps_all<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">#if</span> <span class="neuexp"><span class="keyword">(</span>ATS_CC_VERBOSE_LEVEL &gt;= 1<span class="keyword">)</span></span> <span class="keyword">#then</span>
<span class="comment">//
</span><span class="comment">// this location information is mostly for the purpose of debugging
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/*\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "// "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Loc<span class="keyword">.</span>fprint_location <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> loc_entry<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n*/\n"<span class="keyword">)</span>
<span class="keyword">#endif</span> <span class="comment">// end of ...
</span><span class="comment">//
</span>  <span class="keyword">val</span> ndeb <span class="keyword">=</span> $Deb<span class="keyword">.</span>debug_flag_get <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> ndeb &gt;= 1 <span class="keyword">then</span> <span class="keyword">(</span>
    $Loc<span class="keyword">.</span>fprint_line_pragma <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> loc_entry<span class="keyword">)</span> <span class="comment">// #line pragma
</span>  <span class="keyword">)</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span><span class="comment">// function head
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
     emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_res<span class="keyword">)</span><span class="keyword">;</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ("<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> n <span class="keyword">=</span> emit_funenvarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// comma separation if needed
</span>    <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons hits_arg <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    emit_funarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits_arg<span class="keyword">)</span><span class="keyword">;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") {\n"<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span><span class="comment">// tailjoinlst
</span><span class="comment">//
</span>  <span class="keyword">val</span> tjs <span class="keyword">=</span> funentry_tailjoin_get <span class="keyword">(</span>entry<span class="keyword">)</span>
<span class="comment">//
</span><span class="comment">// local variable declaration
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* local vardec */\n"<span class="keyword">)</span>
    <span class="keyword">var</span> tmps_local<span class="keyword">:</span> <span class="staexp">tmpvarmap_vt</span> <span class="keyword">=</span> tmpvarmap_nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
      tailjoinlst_tmpvarmap_add <span class="keyword">(</span>tmps_local<span class="keyword">,</span> tjs<span class="keyword">)</span>
    <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funentry_tmpvarmap_add <span class="keyword">(</span>tmps_local<span class="keyword">,</span> entry<span class="keyword">)</span>
    <span class="keyword">val</span> n <span class="keyword">=</span> emit_tmpvarmap_dec_local <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmps_local<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> '\n'<span class="keyword">)</span>
  <span class="keyword">in</span>
    tmpvarmap_free <span class="keyword">(</span>tmps_local<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">(* end of [val] *)</span>
<span class="comment">//
</span><span class="comment">// mutual tail-recursion
</span><span class="comment">//
</span>  <span class="keyword">val</span> istailjoin <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> tjs <span class="keyword">of</span>
    <span class="keyword">|</span> TAILJOINLSTcons _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> TAILJOINLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> istailjoin <span class="keyword">then</span> emit_tailjoinlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tjs<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> nvararg &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> nvararg <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr_loc_errorccomp loc_entry<span class="keyword">;</span>
      prerr ": a variadic function must have at least one argument (in front of ...)"<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">(*
    // this check needs to be done earlier!!!
    val () = if istailjoin then begin
      prerr_loc_errorccomp loc_entry;
      prerr ": variadic functions cannot be joined."; prerr_newline ();
      $Err.abort {void} ()
    end // end of [val]
*)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn
      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATSlocal (va_list, arg%i) ;\n"<span class="keyword">,</span> <span class="keyword">@(</span>nvararg<span class="keyword">)</span><span class="keyword">)</span>
    <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprintf1_exn
      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "va_start(arg%i, arg%i) ;\n\n"<span class="keyword">,</span> <span class="keyword">@(</span>nvararg<span class="keyword">,</span> nvararg-1<span class="keyword">)</span><span class="keyword">)</span>
    <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span><span class="comment">// function body
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_instrlst <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> funentry_body_get entry<span class="keyword">)</span>
<span class="comment">//
</span><span class="comment">// varindmap needs to be reset
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> funentry_varindmap_reset <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span><span class="comment">// return
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\nreturn "<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> is_void <span class="keyword">=</span> tmpvar_is_void <span class="keyword">(</span>tmp_ret<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> is_void <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "/* "<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "("<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmp_ret<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ")"<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> is_void <span class="keyword">then</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " */"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ;\n} /* end of ["<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span><span class="keyword">;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "] */"<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span><span class="comment">// closure_type and closure_make and clofun
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> istailjoin <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> fc <span class="keyword">of</span>
      <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo knd <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n\n"<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_closure_type <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n\n"<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_closure_clofun <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n\n"<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_closure_init <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">(</span>knd &lt;&gt; 0<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// boxed closure
</span>            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "\n\n"<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_closure_make <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="comment">// empty
</span>          <span class="keyword">end</span> <span class="comment">// end of [val]
</span>        <span class="keyword">in</span>
          <span class="comment">// empty
</span>        <span class="keyword">end</span> <span class="comment">// end of [FUNCLOclo]
</span>      <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>   <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [emit_funentry]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_funentry_prototype
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> entry<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> fl <span class="keyword">=</span> funentry_lab_get <span class="keyword">(</span>entry<span class="keyword">)</span>
  <span class="keyword">val</span> fc <span class="keyword">=</span> funlab_funclo_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> hits_arg <span class="keyword">=</span> funlab_typ_arg_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> hit_res <span class="keyword">=</span> funlab_typ_res_get <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> vtps_all <span class="keyword">=</span> funentry_vtps_get_all <span class="keyword">(</span>entry<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">fn</span> aux_function
    <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "static\n"<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_res<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ' '<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> " ("<span class="keyword">)</span>
    <span class="keyword">val</span> n <span class="keyword">=</span> emit_funenvarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span> <span class="comment">// comma separation if needed
</span>      <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons hits_arg <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux_function]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> aux_closure_make
    <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "static\n"<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ats_clo_ptr_type "<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_closure_make ("<span class="keyword">)</span>
    <span class="keyword">val</span> _<span class="comment">(*int*)</span> <span class="keyword">=</span> emit_funenvarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> vtps_all<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux_closure_make]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> aux_closure_clofun
    <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>FILE m</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "static\n"<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hit_res<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_char <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ' '<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funlab <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fl<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "_clofun (ats_clo_ptr_type cloptr"<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> hityplst_is_cons hits_arg <span class="keyword">=&gt;</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ", "<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_funarg <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux_closure_clofun]
</span><span class="comment">//
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> funlab_qua_get <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> D2CSTOPTsome _<span class="comment">(*d2c*)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> fc <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo knd <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> knd &lt;&gt; 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_closure_make <span class="keyword">(</span>out<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_closure_clofun <span class="keyword">(</span>out<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// empty
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="comment">// end of [FUNCLOclo]
</span>    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D2CSTOPTsome]
</span>  <span class="keyword">|</span> D2CSTOPTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> fc <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo _<span class="comment">(*knd*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_function <span class="keyword">(</span>out<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_closure_make <span class="keyword">(</span>out<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_closure_clofun <span class="keyword">(</span>out<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// empty
</span>      <span class="keyword">end</span> <span class="comment">// end of [FUNCLOclo]
</span>    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_function <span class="keyword">(</span>out<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="comment">// empty
</span>      <span class="keyword">end</span> <span class="comment">// end of [FUNCLOfun]
</span>    <span class="keyword">end</span> <span class="comment">// end of [D2CSTOPTnone]
</span><span class="keyword">end</span> <span class="comment">// end of [emit_funentry_prototype]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_mainfun
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fil<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "int main (int argc, char *argv[]) {\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "ATS_GC_INIT() ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "mainats_prelude() ;\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_filename <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> fil<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "__dynload() ;\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "mainats((ats_int_type)argc, (ats_ptr_type)argv) ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "return (0) ;\n"<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> "} /* end of main */\n"<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [emit_mainfun]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_ccomp_emit.dats] *)</span>
</pre>
</body>
</html>
