<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: Summer, 2009
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// book: AUP (2nd edition), pages 170 - 174
</span><span class="comment">// section 3.6.4: Implementing getcwd (walking up the tree)
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">UNSAFE <span class="keyword">=</span> "prelude/SATS/unsafe.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/sys/SATS/stat.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/sys/SATS/types.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/SATS/errno.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/SATS/fcntl.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/SATS/dirent.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/SATS/stdlib.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/SATS/unistd.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="578"><span class="stacstdec">pathlist <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#21577"><span class="stacstuse">List_vt</span></a> <span class="keyword">(</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15362"><span class="stacstuse">strptr0</span></a><span class="keyword">)</span></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> push_pathlist
  <span class="keyword">(</span>lstrs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span></a></span><span class="keyword">,</span> name<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15243"><span class="stacstuse">string</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15547"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> name <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#4982"><span class="dyncstuse">string1_of_string</span></a> name
  <span class="keyword">val</span> n <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#14525"><span class="dyncstuse">string1_length</span></a> <span class="keyword">(</span>name<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_buf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#12612"><span class="dyncstuse">string_make_substring</span></a> <span class="keyword">(</span>name<span class="keyword">,</span> 0<span class="keyword">,</span> n<span class="keyword">)</span>
  <span class="keyword">val</span> lstr <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#22037"><span class="dyncstuse">strptr_of_strbuf</span></a> <span class="keyword">@(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_buf</span> <span class="keyword">|</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  lstrs := list_vt_cons <span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15362"><span class="stacstuse">strptr0</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>lstr<span class="keyword">,</span> lstrs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [push_pathlist] *)</span>

<span class="keyword">fun</span> free_pathlist <span class="keyword">(</span>ps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15547"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">case+</span> ps <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>p<span class="keyword">,</span> ps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#21411"><span class="dyncstuse">strptr_free</span></a> p<span class="keyword">;</span> free_pathlist ps<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [free_pathlist]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1162"><span class="dyncstdec">getcwdx <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15362"><span class="stacstuse">strptr0</span></a></span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> SAME_INODE <span class="staexp"><span class="keyword">.&lt;&gt;.</span></span>
  <span class="keyword">(</span>s1<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a></span></a></span><span class="keyword">,</span> s2<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14296"><span class="stacstuse">bool</span></a></span> <span class="keyword">=</span>
  <span class="keyword">(</span>s1<span class="keyword">.</span>st_dev <span class="keyword">=</span> s2<span class="keyword">.</span>st_dev<span class="keyword">)</span> andalso <span class="keyword">(</span>s1<span class="keyword">.</span>st_ino <span class="keyword">=</span> s2<span class="keyword">.</span>st_ino<span class="keyword">)</span>
<span class="comment">// end of [SAME_INODE]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">macdef</span> <span class="neuexp">errno_is_ENOENT <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2ferrno_2esats.html#5349"><span class="dyncstuse">errno_get</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ENOENT<span class="keyword">)</span></span>

<span class="keyword">fun</span> loop_dir <span class="keyword">(</span>
    ents<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#23644"><span class="stacstuse">stream_vt</span></a> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2fdirent_2esats.html#1849"><span class="stacstuse">dirent</span></a></span><span class="keyword">,</span> stat<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a></span></a></span><span class="keyword">,</span> lstrs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span></a></span><span class="keyword">,</span> nent<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse">int</span></a></span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">!</span>ents <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>stream_vt_cons <span class="keyword">(</span>ent<span class="keyword">,</span> ents<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> ent <span class="keyword">=</span> ent
      <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">fpf_d_name</span> <span class="keyword">|</span> d_name<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2fdirent_2esats.html#1897"><span class="dyncstuse">dirent_get_d_name</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span>
      <span class="keyword">viewtypedef</span> <span class="staexp"><a name="1668"><span class="stacstdec">VT <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15303"><span class="stacstuse">strptr</span></a><span class="keyword">(</span>l<span class="keyword">)</span></span></a></span>
      <span class="keyword">var</span> stat_entry<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a>?</span> <span class="comment">// uninitialized
</span>      <span class="keyword">val</span> rtn <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#5176"><span class="dyncstuse">lstat_err</span></a> <span class="keyword">(</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2funsafe_2esats.html#2029"><span class="dyncstuse">$UNSAFE<span class="keyword">.</span>castvwtp1</span></a><span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15243"><span class="stacstuse">string</span></a><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#1668"><span class="stacstuse">VT</span></a><span class="keyword">}</span></span><span class="keyword">(</span>d_name<span class="keyword">)</span><span class="keyword">,</span> stat_entry<span class="keyword">)</span>
      <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">if</span> rtn &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#8913"><span class="dyncstuse">opt_unsome</span></a> <span class="keyword">(</span>stat_entry<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        <span class="keyword">case+</span> 0 <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> SAME_INODE <span class="keyword">(</span>stat<span class="keyword">,</span> stat_entry<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">~</span>ents
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> nent <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> push_pathlist <span class="keyword">(</span>lstrs<span class="keyword">,</span> "/"<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> push_pathlist <span class="keyword">(</span>lstrs<span class="keyword">,</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2funsafe_2esats.html#2029"><span class="dyncstuse">$UNSAFE<span class="keyword">.</span>castvwtp1</span></a><span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15243"><span class="stacstuse">string</span></a><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#1668"><span class="stacstuse">VT</span></a><span class="keyword">}</span></span><span class="keyword">(</span>d_name<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">in</span>  
            1 <span class="comment">// the entry for the current directory is found
</span>          <span class="keyword">end</span> <span class="comment">// end of [_ when ...]  
</span>        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> loop_dir <span class="keyword">(</span>ents<span class="keyword">,</span> stat<span class="keyword">,</span> lstrs<span class="keyword">,</span> nent<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#9049"><span class="dyncstuse">opt_unnone</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>stat_entry<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">~</span>ents
      <span class="keyword">in</span>
        0 <span class="comment">(* error *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf_d_name <span class="keyword">(</span>d_name<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      res
    <span class="keyword">end</span> <span class="comment">(* end of [stream_vt_cons] *)</span>
   <span class="keyword">|</span> <span class="keyword">~</span>stream_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0 <span class="comment">(* error *)</span>
<span class="comment">// end of [loop_dir]
</span>
<span class="keyword">fun</span> getcwdx_main <span class="staexp"><span class="keyword">{</span>fd<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_fd<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2funistd_2esats.html#1866"><span class="stacstuse">fildes_v</span></a> <span class="keyword">(</span>fd<span class="keyword">)</span></span></span> <span class="keyword">|</span> fd<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14651"><span class="stacstuse">int</span></a> fd</span><span class="keyword">,</span> stat<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a></span></a></span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15362"><span class="stacstuse">strptr0</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> nerr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> lstrs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span> <span class="keyword">=</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">,</span> stat<span class="keyword">,</span> lstrs<span class="keyword">,</span> 0<span class="comment">(*nent*)</span><span class="keyword">,</span> nerr<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>fd<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>
        <span class="prfexp">pf_fd<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2funistd_2esats.html#1866"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2funistd_2esats.html#1866"><span class="stacstuse">fildes_v</span></a></span></a> <span class="keyword">(</span>fd<span class="keyword">)</span></span></span>
      <span class="keyword">|</span> fd<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14651"><span class="stacstuse">int</span></a> fd</span><span class="keyword">,</span> stat<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a></span></a></span><span class="keyword">,</span> lstrs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span></a></span><span class="keyword">,</span> nent<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> nerr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#14678"><span class="stacstuse">int</span></a></span></a></span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15547"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">var</span> stat_parent<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a>?</span> <span class="comment">// uninitialized
</span>      <span class="keyword">val</span> rtn <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#5176"><span class="dyncstuse">lstat_err</span></a> <span class="keyword">(</span>".."<span class="keyword">,</span> stat_parent<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> rtn &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#8913"><span class="dyncstuse">opt_unsome</span></a> <span class="keyword">(</span>stat_parent<span class="keyword">)</span></span>
        <span class="keyword">val</span> rtn <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2funistd_2esats.html#8352"><span class="dyncstuse">chdir</span></a> ".."
        <span class="keyword">val</span> term <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">:</span><span class="keyword">(</span>stat_parent<span class="keyword">:</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a><span class="keyword">)</span> <span class="keyword">=&gt;</span> 
          <span class="keyword">(</span>rtn <span class="keyword">=</span> ~1  andalso errno_is_ENOENT <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">then</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4303"><span class="dyncstuse">true</span></a> <span class="keyword">else</span> SAME_INODE <span class="keyword">(</span>stat<span class="keyword">,</span> stat_parent<span class="keyword">)</span>
        <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        <span class="keyword">case+</span> 0 <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> term <span class="keyword">=&gt;</span> push_pathlist <span class="keyword">(</span>lstrs<span class="keyword">,</span> "/"<span class="keyword">)</span> <span class="comment">// for leading "/"
</span>        <span class="keyword">|</span> _ <span class="keyword">when</span> rtn <span class="keyword">=</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">(</span>nerr := nerr + 1<span class="keyword">)</span> <span class="comment">// loop exists abnormally
</span>        <span class="keyword">|</span> _ <span class="comment">(*continue*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfopt_dir</span> <span class="keyword">|</span> p_dir<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2fdirent_2esats.html#2066"><span class="dyncstuse">opendir_err</span></a> <span class="keyword">(</span>"."<span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="keyword">if</span> p_dir <span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fpointer_2esats.html#2941"><span class="dyncstuse">null</span></a> <span class="keyword">then</span> <span class="keyword">let</span>
              <span class="keyword">prval</span> <span class="prfexp">Some_v pf_dir <span class="keyword">=</span> pfopt_dir</span>
              <span class="keyword">val</span> ents <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2fdirent_2esats.html#2974"><span class="dyncstuse">dirent_stream_vt_make_DIR</span></a> <span class="keyword">(</span><span class="prfexp">pf_dir</span> <span class="keyword">|</span> p_dir<span class="keyword">)</span>
              <span class="keyword">val</span> found <span class="keyword">=</span> loop_dir <span class="keyword">(</span>ents<span class="keyword">,</span> stat<span class="keyword">,</span> lstrs<span class="keyword">,</span> nent<span class="keyword">)</span>
            <span class="keyword">in</span>
              <span class="keyword">if</span> found <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> stat := stat_parent <span class="keyword">in</span> loop <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">,</span> stat<span class="keyword">,</span> lstrs<span class="keyword">,</span> nent+1<span class="keyword">,</span> nerr<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
                <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2ferrno_2esats.html#5398"><span class="dyncstuse">errno_set</span></a> <span class="keyword">(</span>ENOENT<span class="keyword">)</span><span class="keyword">;</span> nerr := nerr + 1
              <span class="keyword">end</span> <span class="comment">// end of [if]
</span>            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
              <span class="keyword">prval</span> <span class="prfexp">None_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pfopt_dir</span> <span class="keyword">in</span> nerr := nerr + 1 <span class="comment">// loop exits abnormally 
</span>            <span class="keyword">end</span> <span class="comment">(* end of if *)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [_(*continue*)] *)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#9049"><span class="dyncstuse">opt_unnone</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>stat_parent<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        nerr := nerr + 1 <span class="comment">// loop exits abnormally
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]  
</span>    <span class="keyword">end</span> <span class="comment">(* end of [loop] *)</span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> _err <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2funistd_2esats.html#8414"><span class="dyncstuse">fchdir</span></a> <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert_errmsg <span class="keyword">(</span>_err &lt;&gt; ~1<span class="keyword">,</span> <span class="keyword">#LOCATION</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2ffcntl_2esats.html#3815"><span class="dyncstuse">close_exn</span></a> <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">(</span>nerr <span class="keyword">&gt;</span> 0<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span>free_pathlist lstrs<span class="keyword">;</span> lstrs := list_vt_nil<span class="keyword">)</span>
  <span class="keyword">val</span> lstrs <span class="keyword">=</span> lstrs
<span class="keyword">in</span>
  <span class="keyword">case+</span> lstrs <span class="keyword">of</span>
  <span class="keyword">|</span> list_vt_cons _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ lstrs
      <span class="keyword">val</span> path <span class="keyword">=</span>
        <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13837"><span class="dyncstuse">stringlst_concat</span></a> <span class="keyword">(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#4855"><span class="dyncstuse">__cast</span></a> lstrs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="4855"><span class="dyncstdec">__cast <span class="keyword">(</span>lstrs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#578"><span class="stacstuse">pathlist</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#20799"><span class="stacstuse">List</span></a> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15243"><span class="stacstuse">string</span></a></span></span></a>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> free_pathlist <span class="keyword">(</span>lstrs<span class="keyword">)</span>
    <span class="keyword">in</span>
      path
    <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#20295"><span class="dyncstuse">strptr_null</span></a> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [getcwdx_main]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#1162"><span class="dyncstimp">getcwdx</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> st<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a>?</span> <span class="comment">// uinitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfopt_fd</span> <span class="keyword">|</span> fd<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2ffcntl_2esats.html#3069"><span class="dyncstuse">open_flag_err</span></a> <span class="keyword">(</span>"."<span class="keyword">,</span> O_RDONLY<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> fd &lt;&gt; ~1 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">open_v_succ pf_fd <span class="keyword">=</span> pfopt_fd</span>
    <span class="keyword">val</span> rtn <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#5176"><span class="dyncstuse">lstat_err</span></a> <span class="keyword">(</span>"."<span class="keyword">,</span> st<span class="keyword">)</span> 
  <span class="keyword">in</span>
    <span class="keyword">if</span> rtn &gt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#8913"><span class="dyncstuse">opt_unsome</span></a> <span class="keyword">(</span>st<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      getcwdx_main <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">,</span> st<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#9049"><span class="dyncstuse">opt_unnone</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2ftmp_2ftrunk_2flibc_2fsys_2fSATS_2fstat_2esats.html#2659"><span class="stacstuse">stat</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>st<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <a href="XREF/_2ftmp_2ftrunk_2flibc_2fSATS_2ffcntl_2esats.html#3815"><span class="dyncstuse">close_exn</span></a> <span class="keyword">(</span><span class="prfexp">pf_fd</span> <span class="keyword">|</span> fd<span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#20295"><span class="dyncstuse">strptr_null</span></a> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">open_v_fail <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pfopt_fd</span> <span class="keyword">in</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#20295"><span class="dyncstuse">strptr_null</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]  
</span><span class="keyword">end</span> <span class="comment">(* end of [getcwdx] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#6716"><span class="dyncstimp">main</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">l<span class="keyword">:</span>addr</span><span class="keyword">]</span> path <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#1162"><span class="dyncstuse">getcwdx</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#3243"><span class="dyncstuse">addr_is_gtez</span></a> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">if</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#20445"><span class="dyncstuse">strptr_isnot_null</span></a> path <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
      <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fprintf_2esats.html#2494"><span class="dyncstuse">printf</span></a> <span class="keyword">(</span>"%s\n"<span class="keyword">,</span> <span class="keyword">@(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fAUP_2fAUP_5f3_5f6_5f4_2edats.html#5896"><span class="dyncstuse">__cast</span></a> path<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="5896"><span class="dyncstdec">__cast <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>agz<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15303"><span class="stacstuse"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15303"><span class="stacstuse">strptr</span></a></span></a> l</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15243"><span class="stacstuse">string</span></a></span></span></a>
    <span class="keyword">}</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#21411"><span class="dyncstuse">strptr_free</span></a> <span class="keyword">(</span>path<span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4627"><span class="dyncstuse">exit</span></a> <span class="keyword">(</span>EXIT_SUCCESS<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> _null <span class="keyword">=</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fSATS_2fstring_2esats.html#21361"><span class="dyncstuse">strptr_free_null</span></a> <span class="keyword">(</span>path<span class="keyword">)</span> <span class="keyword">in</span> <a href="XREF/_2ftmp_2ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4627"><span class="dyncstuse">exit</span></a> <span class="keyword">(</span>EXIT_FAILURE<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if] 
</span><span class="keyword">end</span> <span class="comment">(* end of [main] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [AUP_3_6_4.dats] *)</span>
</pre>
</body>
</html>
