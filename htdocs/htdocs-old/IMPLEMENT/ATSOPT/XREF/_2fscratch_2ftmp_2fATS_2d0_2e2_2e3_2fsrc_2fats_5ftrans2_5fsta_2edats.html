<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: November 2007
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#include "ats_counter.cats" /* only needed for [ATS/Geizella] */
%}</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">IntInf <span class="keyword">=</span> "ats_intinf.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lab <span class="keyword">=</span> "ats_label.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Loc <span class="keyword">=</span> "ats_location.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">PM <span class="keyword">=</span> "ats_posmark.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Stamp <span class="keyword">=</span> "ats_stamp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Sym <span class="keyword">=</span> "ats_symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Syn <span class="keyword">=</span> "ats_syntax.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_trans2_env.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_stadyncst2.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_trans2.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THISFILENAME "ats_trans2_sta.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">nil list_nil</span>
<span class="keyword">#define</span> <span class="neuexp">cons list_cons</span>
<span class="keyword">#define</span> <span class="neuexp">:: list_cons</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="2353"><span class="stacstdec">loc_t <span class="keyword">=</span> $Loc<span class="keyword">.</span>location_t</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2385"><span class="stacstdec">funclo <span class="keyword">=</span> $Syn<span class="keyword">.</span>funclo</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2414"><span class="stacstdec">funcloopt <span class="keyword">=</span> $Syn<span class="keyword">.</span>funcloopt</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2449"><span class="stacstdec">efc <span class="keyword">=</span> $Eff<span class="keyword">.</span>effcst</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2475"><span class="stacstdec">efcopt <span class="keyword">=</span> Option efc</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2503"><span class="stacstdec">sym_t <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_t</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2533"><span class="stacstdec">symopt_t <span class="keyword">=</span> Option sym_t</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">overload</span> <span class="keyword">=</span> <span class="keyword">with</span> $Sym<span class="keyword">.</span>eq_symbol_symbol</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_loc_error2 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">(</span>$Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(2)"<span class="keyword">)</span>
<span class="comment">// end of [prerr_loc_error2]
</span>
<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_trans2_sta)"

<span class="keyword">fn</span> prerr_loc_interror <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": INTERNAL ERROR (ats_trans2_sta)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_interror]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> stacstuseloc_posmark
  <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc_s2c <span class="keyword">=</span> s2cst_loc_get <span class="keyword">(</span>s2c<span class="keyword">)</span>
  <span class="keyword">val</span> loc_begoff <span class="keyword">=</span> $Loc<span class="keyword">.</span>location_begpos_toff loc
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $PM<span class="keyword">.</span>posmark_insert_stacstuse_beg <span class="keyword">(</span>loc_begoff<span class="keyword">,</span> loc_s2c<span class="keyword">)</span>
  <span class="keyword">val</span> loc_endoff <span class="keyword">=</span> $Loc<span class="keyword">.</span>location_endpos_toff loc
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $PM<span class="keyword">.</span>posmark_insert_stacstuse_end <span class="keyword">(</span>loc_endoff<span class="keyword">,</span> loc_s2c<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [stacstuseloc_posmark]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s1rt_app_tr <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> s1t_fun<span class="keyword">:</span> <span class="staexp">s1rt</span>
  <span class="keyword">,</span> s1ts_arg<span class="keyword">:</span> <span class="staexp">s1rtlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> s1rt_is_arrow s1t_fun <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s1ts_arg <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s1t1<span class="keyword">,</span> cons <span class="keyword">(</span>s1t2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s1ts1 <span class="keyword">=</span> <span class="keyword">(</span>
          <span class="keyword">case+</span> s1t1<span class="keyword">.</span>s1rt_node <span class="keyword">of</span>
          <span class="keyword">|</span> S1RTlist s1ts <span class="keyword">=&gt;</span> s1ts <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>s1t1<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s1rtlst</span>
        <span class="keyword">val</span> s2ts1 <span class="keyword">=</span> s1rtlst_tr s1ts1 <span class="keyword">and</span> s2t2 <span class="keyword">=</span> s1rt_tr s1t2
      <span class="keyword">in</span>
        S2RTfun <span class="keyword">(</span>s2ts1<span class="keyword">,</span> s2t2<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": [s1rt_app_tr]: [-&gt;] is not an infix operator!"<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2rt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [s1rt_is_arrow]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error2 loc0<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1rt_app_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": sort application is not supported."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2rt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s1rt_app_tr]
</span>
<span class="keyword">implement</span>
s1rt_tr <span class="keyword">(</span>s1t0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1t0<span class="keyword">.</span>s1rt_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1RTapp <span class="keyword">(</span>s1t<span class="keyword">,</span> s1ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
<span class="comment">(*
      print "s1rt_tr: S1RTapp: "; print s1t0.s1rt_loc; print_newline ();
*)</span>
      s1rt_app_tr <span class="keyword">(</span>s1t0<span class="keyword">.</span>s1rt_loc<span class="keyword">,</span> s1t<span class="keyword">,</span> s1ts<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1RTapp]
</span>  <span class="keyword">|</span> S1RTlist s1ts <span class="keyword">=&gt;</span> S2RTtup <span class="keyword">(</span>s1rtlst_tr s1ts<span class="keyword">)</span> 
  <span class="keyword">|</span> S1RTqid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> the_s2rtenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2te <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2te <span class="keyword">of</span>
      <span class="keyword">|</span> S2TEsrt s2t <span class="keyword">=&gt;</span> s2t <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_error2 s1t0<span class="keyword">.</span>s1rt_loc<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1rt_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": the identifier ["<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
          prerr "] refers to an extended sort but not a sort."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error2 s1t0<span class="keyword">.</span>s1rt_loc<span class="keyword">;</span>
        $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1rt_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": the identifier ["<span class="keyword">;</span>
        $Syn<span class="keyword">.</span>prerr_s0rtq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
        prerr "] refers to an unrecognized sort."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S1RTqid]
</span>  <span class="keyword">|</span> S1RTtup s1ts <span class="keyword">=&gt;</span> S2RTtup <span class="keyword">(</span>s1rtlst_tr s1ts<span class="keyword">)</span>
<span class="comment">(*
  | _ =&gt; begin
      prerr_loc_interror s1t0.s1rt_loc;
      prerr ": not yet implemented: ["; prerr s1t0; prerr "]";
      prerr_newline ();
      $Err.abort ()
    end // end of [_]
*)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1rt_tr]
</span>
<span class="keyword">implement</span>
s1rtlst_tr <span class="keyword">(</span>s1ts<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1ts <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s1t<span class="keyword">,</span> s1ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>s1rt_tr s1t<span class="keyword">,</span> s1rtlst_tr s1ts<span class="keyword">)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1rtlst_tr]
</span>
<span class="keyword">implement</span>
s1rtopt_tr <span class="keyword">(</span>os1t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> os1t <span class="keyword">of</span>
  <span class="keyword">|</span> Some s1t <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>s1rt_tr s1t<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span> 
<span class="keyword">end</span> <span class="comment">// end of [s1rtopt_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* static special identifier *)</span>
<span class="keyword">datatype</span> <span class="staexp"><a name="6113"><span class="stacstdec">staspecid</span></a></span> <span class="keyword">=</span> SPSIDarrow <span class="keyword">|</span> SPSIDnone

<span class="keyword">fn</span> staspecid_of_qid <span class="keyword">(</span>q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">staspecid</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> q<span class="keyword">.</span>s0taq_node <span class="keyword">of</span>
  <span class="keyword">|</span> $Syn<span class="keyword">.</span>S0TAQnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> id <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_MINUSGT <span class="keyword">then</span> SPSIDarrow <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> SPSIDnone <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> SPSIDnone <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [staspecid_of_qid]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> effvar_tr
  <span class="keyword">(</span>efv<span class="keyword">:</span> <span class="staexp">$Eff<span class="keyword">.</span>effvar</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> the_s2expenv_find efv<span class="keyword">.</span>i0de_sym <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
    <span class="keyword">|</span> S2ITEMvar s2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2var_tmplev_check <span class="keyword">(</span>efv<span class="keyword">.</span>i0de_loc<span class="keyword">,</span> s2v<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_var <span class="keyword">(</span>s2v<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2ITEMvar]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error2 efv<span class="keyword">.</span>i0de_loc<span class="keyword">;</span>
        $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: effvar_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": the static identifer ["<span class="keyword">;</span>
        $Sym<span class="keyword">.</span>prerr_symbol efv<span class="keyword">.</span>i0de_sym<span class="keyword">;</span>
        prerr "] should refer to a variable but it does not."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> 
      prerr_loc_error2 efv<span class="keyword">.</span>i0de_loc<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: effvar_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": unrecognized static identifer ["<span class="keyword">;</span>
      $Sym<span class="keyword">.</span>prerr_symbol efv<span class="keyword">.</span>i0de_sym<span class="keyword">;</span>
      prerr "]."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [effvar_tr]
</span>
<span class="keyword">fn</span> effvarlst_tr <span class="keyword">(</span>efvs<span class="keyword">:</span> <span class="staexp">$Eff<span class="keyword">.</span>effvarlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>efvs<span class="keyword">,</span> effvar_tr<span class="keyword">)</span>

<span class="keyword">implement</span>
effcst_tr <span class="keyword">(</span>efc<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2eff</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> efc <span class="keyword">of</span>
  <span class="keyword">|</span> $Eff<span class="keyword">.</span>EFFCSTall <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2EFFall <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> $Eff<span class="keyword">.</span>EFFCSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2EFFnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> $Eff<span class="keyword">.</span>EFFCSTset <span class="keyword">(</span>efs<span class="keyword">,</span> efvs<span class="keyword">)</span> <span class="keyword">=&gt;</span> S2EFFset <span class="keyword">(</span>efs<span class="keyword">,</span> effvarlst_tr efvs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [effcst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1arglst_var_tr <span class="keyword">(</span>s1as<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> s1rtopt_search <span class="keyword">(</span>s1as<span class="keyword">:</span> <span class="staexp">s1arglst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s1rtopt</span> <span class="keyword">=</span> <span class="keyword">case+</span> s1as <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1a<span class="keyword">,</span> s1as<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> os1t <span class="keyword">=</span> s1a<span class="keyword">.</span>s1arg_srt <span class="keyword">in</span>
        <span class="keyword">case+</span> os1t <span class="keyword">of</span> Some _ <span class="keyword">=&gt;</span> os1t <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1rtopt_search s1as
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [s1rtopt_search]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s1as <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1a_fst<span class="keyword">,</span> s1as_rst<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> os1t <span class="keyword">=</span> s1rtopt_search s1as<span class="keyword">;</span> <span class="keyword">val</span> s1t <span class="keyword">=</span> <span class="keyword">case+</span> os1t <span class="keyword">of</span>
        <span class="keyword">|</span> Some s1t <span class="keyword">=&gt;</span> s1t <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            prerr_loc_error2 s1a_fst<span class="keyword">.</span>s1arg_loc<span class="keyword">;</span>
            $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1arglst_var_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
            prerr ": the static variable ["<span class="keyword">;</span>
            $Sym<span class="keyword">.</span>prerr_symbol s1a_fst<span class="keyword">.</span>s1arg_sym<span class="keyword">;</span>
            prerr "] must be ascribed a sort."<span class="keyword">;</span>
            prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
            $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [None]
</span>      <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr s1t
      <span class="keyword">val</span> s2v_fst <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>s1a_fst<span class="keyword">.</span>s1arg_sym<span class="keyword">,</span> s2t<span class="keyword">)</span>
      <span class="keyword">val</span> s2vs_rst <span class="keyword">=</span> s1arglst_var_tr s1as_rst
      <span class="keyword">val</span> s2vs <span class="keyword">=</span> list_cons <span class="keyword">(</span>s2v_fst<span class="keyword">,</span> s2vs_rst<span class="keyword">)</span>
    <span class="keyword">in</span>
      the_s2expenv_add_svarlst s2vs<span class="keyword">;</span> s2vs
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1arglst_var_tr]
</span>
<span class="keyword">implement</span>
s1arglstlst_var_tr <span class="keyword">(</span>s1ass<span class="keyword">)</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1ass<span class="keyword">,</span> s1arglst_var_tr<span class="keyword">)</span>
<span class="comment">// end of [s1arglstlst_var_tr]
</span>
<span class="keyword">implement</span>
s1arg_var_tr_srt
  <span class="keyword">(</span>s1a<span class="keyword">,</span> s2t0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> s1a<span class="keyword">.</span>s1arg_srt <span class="keyword">of</span>
    <span class="keyword">|</span> Some s1t <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr s1t
      <span class="keyword">in</span>
        <span class="keyword">if</span> s2t0 &lt;= s2t <span class="keyword">then</span> s2t <span class="keyword">else</span> <span class="keyword">begin</span>
          prerr_loc_error2 s1a<span class="keyword">.</span>s1arg_loc<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1arg_var_tr_srt"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": the static variable ["<span class="keyword">;</span>
          $Sym<span class="keyword">.</span>prerr_symbol s1a<span class="keyword">.</span>s1arg_sym<span class="keyword">;</span>
          prerr "] is expected to be of the sort ["<span class="keyword">;</span>
          prerr s2t0<span class="keyword">;</span>
          prerr "]."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2rt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2t0
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> s2v <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>s1a<span class="keyword">.</span>s1arg_sym<span class="keyword">,</span> s2t<span class="keyword">)</span>
<span class="keyword">in</span>
  the_s2expenv_add_svar s2v<span class="keyword">;</span> s2v
<span class="keyword">end</span> <span class="comment">// end of [s1arg_var_tr_srt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> sp1at_arg_tr_dn <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
<span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">,</span> s1as<span class="keyword">:</span> <span class="staexp">s1arglst</span><span class="keyword">,</span> s2ts<span class="keyword">:</span> <span class="staexp">s2rtlst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>s1as<span class="keyword">,</span> s2ts<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>list_cons <span class="keyword">(</span>s1a<span class="keyword">,</span> s1as<span class="keyword">)</span><span class="keyword">,</span> list_cons <span class="keyword">(</span>s2t<span class="keyword">,</span> s2ts<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2v <span class="keyword">=</span> s1arg_var_tr_srt <span class="keyword">(</span>s1a<span class="keyword">,</span> s2t<span class="keyword">)</span>
      <span class="keyword">val</span> s2vs <span class="keyword">=</span> sp1at_arg_tr_dn <span class="keyword">(</span>loc0<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">,</span> s1as<span class="keyword">,</span> s2ts<span class="keyword">)</span>
    <span class="keyword">in</span>
      list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons, list_cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error2 loc0<span class="keyword">;</span>
      prerr ": the static constructor ["<span class="keyword">;</span>
      $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "] requires "<span class="keyword">;</span>
      <span class="keyword">case+</span> s1as <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> prerr "less" <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> prerr "more"<span class="keyword">;</span>
      prerr " arguments."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2varlst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons, list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [sp2at_arg_tr_dn]
</span>
<span class="keyword">fun</span> sp1at_argcheck
  <span class="keyword">(</span>s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt s2var_t</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> check <span class="keyword">(</span>
    name<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option_vt s2var_t</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> s2vs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> <span class="keyword">(</span>name <span class="keyword">=</span> s2var_sym_get s2v<span class="keyword">)</span> <span class="keyword">then</span> Some_vt s2v <span class="keyword">else</span> check <span class="keyword">(</span>name<span class="keyword">,</span> s2vs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [check]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s2vs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> check <span class="keyword">(</span>s2var_sym_get s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
      <span class="keyword">|</span> Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ ans<span class="keyword">;</span> ans<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> sp1at_argcheck s2vs
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [sp1at_argcheck]
</span>
<span class="keyword">implement</span>
sp1at_tr_dn <span class="keyword">(</span>sp1t<span class="keyword">,</span> s2t_pat<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> sp1t<span class="keyword">.</span>sp1at_loc
<span class="comment">//
</span>  <span class="keyword">fn</span> err1
    <span class="keyword">(</span>q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">sp2at</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc0<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: sp1at_tr_dn"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] does not refer to a constructor associated with the sort ["<span class="keyword">;</span>
    prerr s2t_pat<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>sp2at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err1]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> err2 
    <span class="keyword">(</span>q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">sp2at</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc0<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: sp1at_tr_dn"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] does not refer to a static constructor."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>sp2at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err2]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> err3
    <span class="keyword">(</span>q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">sp2at</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc0<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: sp1at_tr_dn"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "] is unrecognized."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>sp2at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err3]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> argcheck_err <span class="keyword">(</span>s2v<span class="keyword">:</span> <span class="staexp">s2var_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    $Loc<span class="keyword">.</span>prerr_location loc0<span class="keyword">;</span> prerr ": warning(2)"<span class="keyword">;</span>    
    prerr ": the static variable ["<span class="keyword">;</span> prerr s2v<span class="keyword">;</span> prerr "] occurs repeatedly."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [argcheck_err]
</span><span class="comment">//
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> sp1t<span class="keyword">.</span>sp1at_node <span class="keyword">of</span>
  <span class="keyword">|</span> SP1Tcon <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">,</span> s1as<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span>
      the_s2expenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">in</span>
    <span class="keyword">case+</span> ans <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
      <span class="keyword">|</span> S2ITEMcst s2cs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">var</span> s2ts_arg<span class="keyword">:</span> <span class="staexp">s2rtlst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">val</span> s2cs <span class="keyword">=</span> sel <span class="keyword">(</span>s2cs<span class="keyword">,</span> s2t_pat<span class="keyword">,</span> s2ts_arg<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
            <span class="keyword">fun</span> sel <span class="keyword">(</span>
                s2cs<span class="keyword">:</span> <span class="staexp">s2cstlst</span><span class="keyword">,</span> s2t_pat<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> s2ts_arg<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2rtlst</span>
              <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2cstlst</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
              <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> s2cs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                  <span class="keyword">val</span> s2t_s2c <span class="keyword">=</span> s2cst_srt_get s2c <span class="keyword">in</span> <span class="keyword">case+</span> s2t_s2c <span class="keyword">of</span>
                  <span class="keyword">|</span> S2RTfun <span class="keyword">(</span>s2ts<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
                    <span class="keyword">|</span> _ <span class="keyword">when</span> s2t_pat &lt;= s2t <span class="keyword">=&gt;</span> <span class="keyword">(</span>s2ts_arg := s2ts<span class="keyword">;</span> s2cs<span class="keyword">)</span>
                    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> sel <span class="keyword">(</span>s2cs1<span class="keyword">,</span> s2t_pat<span class="keyword">,</span> s2ts_arg<span class="keyword">)</span>
                    <span class="keyword">end</span> <span class="comment">// end of [S2RTfun]
</span>                  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> sel <span class="keyword">(</span>s2cs1<span class="keyword">,</span> s2t_pat<span class="keyword">,</span> s2ts_arg<span class="keyword">)</span>
                <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTcons]
</span>              <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">}</span> <span class="comment">// end of [val]
</span>        <span class="keyword">in</span>
          <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
          <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> s2vs <span class="keyword">=</span> sp1at_arg_tr_dn <span class="keyword">(</span>loc0<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">,</span> s1as<span class="keyword">,</span> s2ts_arg<span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> sp1at_argcheck <span class="keyword">(</span>s2vs<span class="keyword">)</span> <span class="keyword">of</span>
                <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2v <span class="keyword">=&gt;</span> argcheck_err <span class="keyword">(</span>s2v<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>            <span class="keyword">in</span>
              sp2at_con <span class="keyword">(</span>loc0<span class="keyword">,</span> s2c<span class="keyword">,</span> s2vs<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTcons]
</span>          <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2ITEMcst]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err2 <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err3 <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [SP1Tcon]
</span><span class="keyword">end</span> <span class="comment">// end of [sp1at_tr_dn]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exp_tr_dn_bool
  <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_bool<span class="keyword">)</span>
<span class="comment">// end of [s1exp_tr_dn_bool]
</span>
<span class="keyword">implement</span> s1explst_tr_dn_bool <span class="keyword">(</span>s1es<span class="keyword">)</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_dn_bool<span class="keyword">)</span>

<span class="keyword">implement</span>
s1exp_tr_dn_cls <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_cls<span class="keyword">)</span>

<span class="keyword">implement</span> s1explst_tr_dn_cls <span class="keyword">(</span>s1es<span class="keyword">)</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_dn_cls<span class="keyword">)</span>

<span class="keyword">implement</span>
s1exp_tr_dn_int <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_int<span class="keyword">)</span>

<span class="keyword">implement</span>
s1explst_tr_dn_int <span class="keyword">(</span>s1es<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_dn_int<span class="keyword">)</span>
<span class="comment">// end of [s1explst_tr_dn_int]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> s1exp_tr_dn_prop <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_prop<span class="keyword">)</span>
<span class="keyword">implement</span> s1exp_tr_dn_type <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_type<span class="keyword">)</span>
<span class="keyword">implement</span> s1exp_tr_dn_t0ype <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_t0ype<span class="keyword">)</span>

<span class="keyword">fun</span> s1explst_tr_dn_t0ype
  <span class="keyword">(</span>s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_dn_t0ype<span class="keyword">)</span>
<span class="comment">// end of [s1explst_tr_dn_t0ype]
</span>
<span class="keyword">implement</span> s1exp_tr_dn_view <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_view<span class="keyword">)</span>
<span class="keyword">implement</span> s1exp_tr_dn_viewtype <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_viewtype<span class="keyword">)</span>
<span class="keyword">implement</span> s1exp_tr_dn_viewt0ype <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_viewt0ype<span class="keyword">)</span>

<span class="keyword">fun</span> s1explst_tr_dn_viewt0ype
  <span class="keyword">(</span>s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_dn_viewt0ype<span class="keyword">)</span>
<span class="comment">// end of [s1explst_tr_dn_viewt0ype]
</span><span class="keyword">fun</span> s1explstlst_tr_dn_viewt0ype
  <span class="keyword">(</span>s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explstlst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1ess<span class="keyword">,</span> s1explst_tr_dn_viewt0ype<span class="keyword">)</span>
<span class="comment">// end of [s1explstlst_tr_dn_viewt0ype]
</span>
<span class="keyword">implement</span>
s1exp_tr_dn_impredicative <span class="keyword">(</span>s1e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_up s1e<span class="keyword">;</span> <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
<span class="keyword">in</span>
  <span class="keyword">if</span> s2rt_is_impredicative s2t <span class="keyword">then</span> s2e <span class="keyword">else</span> <span class="keyword">begin</span>
    prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tr_dn_impredicative"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static expression needs to be impredicative"<span class="keyword">;</span>
    prerr " but is assigned the sort ["<span class="keyword">;</span>
    prerr s2t<span class="keyword">;</span>
    prerr "]."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_tr_dn_impredicative]
</span>
<span class="keyword">implement</span>
s1expopt_tr_dn_impredicative <span class="keyword">(</span>os1e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> os1e <span class="keyword">of</span>
  <span class="keyword">|</span> Some s1e <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>s1exp_tr_dn_impredicative s1e<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [s1expopt_tr_dn_impredicative]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_any_tr_up <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  prerr_loc_error2 loc0<span class="keyword">;</span>
  $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_any_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
  prerr "the static expression needs to be ascribed a sort."<span class="keyword">;</span>
  prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
  $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_any_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_app_tr_up
  <span class="keyword">(</span>loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> loc_fun<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> loop <span class="keyword">(</span>loc_app<span class="keyword">,</span> loc_fun<span class="keyword">,</span> s2e<span class="keyword">,</span> s1ess<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop
    <span class="keyword">(</span>loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> loc_fun<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1ess <span class="keyword">of</span>
    <span class="keyword">|</span> s1es :: s1ess <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">@(</span>s2ts<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
          <span class="keyword">case+</span> un_s2rt_fun <span class="keyword">(</span>s2e<span class="keyword">.</span>s2exp_srt<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2ts_s2t <span class="keyword">=&gt;</span> s2ts_s2t
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error2 loc_fun<span class="keyword">;</span>
              $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": the static expresstion ["<span class="keyword">;</span>
              prerr s2e<span class="keyword">;</span>
              prerr "] is expected to be of a functional sort"<span class="keyword">;</span>
              prerr ", but is assigned the sort ["<span class="keyword">;</span>
              prerr s2e<span class="keyword">.</span>s2exp_srt<span class="keyword">;</span>
              prerr "]."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2rtlst<span class="keyword">,</span> s2rt<span class="keyword">)</span></span>
        <span class="keyword">val</span> ns2es <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length s1es <span class="keyword">and</span> ns2ts <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length s2ts
        <span class="keyword">val</span> s2es <span class="keyword">=</span> <span class="keyword">case+</span> compare <span class="keyword">(</span>ns2es<span class="keyword">,</span> ns2ts<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> s1explst_tr_dn <span class="keyword">(</span>s1es<span class="keyword">,</span> s2ts<span class="keyword">)</span>
          <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error2 loc_app<span class="keyword">;</span>
              $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": the static application needs less arguments."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [1]
</span>          <span class="keyword">|</span> _ <span class="comment">(* ~1 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error2 loc_app<span class="keyword">;</span>
              $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": the static application needs more arguments."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end [_]
</span>      <span class="keyword">in</span>
        loop <span class="keyword">(</span>loc_app<span class="keyword">,</span> loc_fun<span class="keyword">,</span> s2exp_app_srt <span class="keyword">(</span>s2t<span class="keyword">,</span> s2e<span class="keyword">,</span> s2es<span class="keyword">)</span><span class="keyword">,</span> s1ess<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">}</span> <span class="comment">// end of [s1exp_app_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_app_datconptr_tr_up
  <span class="keyword">(</span>loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2con_t</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s1es <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> s1ess <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s1es<span class="keyword">,</span> s1ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> s1ess <span class="keyword">of</span>
      <span class="keyword">|</span> nil _ <span class="keyword">=&gt;</span> s1es <span class="keyword">|</span> cons _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_error2 loc_app<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_datconptr_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": the type constructor ["<span class="keyword">;</span>
          prerr d2c<span class="keyword">;</span>
          prerr "] is overly applied."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s1explst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s1explst</span>
  <span class="keyword">val</span> s2es <span class="keyword">=</span> aux s1es <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> <span class="keyword">case+</span> s1es <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>s1e<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          cons <span class="keyword">(</span>s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2rt_addr<span class="keyword">)</span><span class="keyword">,</span> aux s1es<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> ns2es <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length s2es
  <span class="keyword">val</span> arity <span class="keyword">=</span> d2con_arity_full_get d2c
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> ns2es <span class="keyword">&gt;</span> arity <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr_loc_error2 loc_app<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_datcon_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the type constructor ["<span class="keyword">;</span>
      prerr d2c<span class="keyword">;</span>
      prerr "] expects less arguments."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> ns2es <span class="keyword">&lt;</span> arity <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr_loc_error2 loc_app<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_datcon_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the type constructor ["<span class="keyword">;</span>
      prerr d2c<span class="keyword">;</span>
      prerr "] expects more arguments."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">in</span>
  s2exp_datconptr <span class="keyword">(</span>d2c<span class="keyword">,</span> s2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end [s1exp_app_datconptr_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_app_datcontyp_tr_up
  <span class="keyword">(</span>loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2con_t</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> err <span class="keyword">(</span>loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2con_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s1explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
     prerr_loc_error2 loc_app<span class="keyword">;</span>
     $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_app_datcon_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
     prerr ": the type constructor ["<span class="keyword">;</span>
     prerr d2c<span class="keyword">;</span>
     prerr "_t0ype] is overly applied."<span class="keyword">;</span>
     prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
     $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s1explst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span>  <span class="keyword">val</span> s1es <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> s1ess <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1es<span class="keyword">,</span> s1ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> s1ess <span class="keyword">of</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1es <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err <span class="keyword">(</span>loc_app<span class="keyword">,</span> d2c<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s1explst</span>
  <span class="keyword">val</span> s2es <span class="keyword">=</span> s1explst_tr_dn_viewt0ype s1es
<span class="keyword">in</span>
  s2exp_datcontyp <span class="keyword">(</span>d2c<span class="keyword">,</span> s2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_app_datcontyp_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s1exp_qid_app_tr_up <span class="keyword">(</span>
    loc_app<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> loc_qid<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span>
  <span class="keyword">,</span> s2i<span class="keyword">:</span> <span class="staexp">s2item</span>
  <span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
  <span class="keyword">|</span> S2ITEMcst s2cs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2ess <span class="keyword">=</span> s1explstlst_tr_up s1ess
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2cst_select_s2explstlst <span class="keyword">(</span>s2cs<span class="keyword">,</span> s2ess<span class="keyword">)</span> <span class="keyword">of</span>
      <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">//
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> stacstuseloc_posmark <span class="keyword">(</span>loc_qid<span class="keyword">,</span> s2c<span class="keyword">)</span> <span class="keyword">in</span>
<span class="comment">//
</span>          s2exp_app_wind <span class="keyword">(</span>s2exp_cst s2c<span class="keyword">,</span> s2ess<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTcons]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_error2 loc_app<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_qid_app_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": none of the static constants referred to by ["<span class="keyword">;</span>
          $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
          prerr "] is applicable."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2ITEMcst]
</span>  <span class="keyword">|</span> S2ITEMvar s2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2var_tmplev_check <span class="keyword">(</span>loc_qid<span class="keyword">,</span> s2v<span class="keyword">)</span>
    <span class="keyword">in</span>
      s1exp_app_tr_up <span class="keyword">(</span>loc_app<span class="keyword">,</span> loc_qid<span class="keyword">,</span> s2exp_var s2v<span class="keyword">,</span> s1ess<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2ITEMvar]
</span>  <span class="keyword">|</span> S2ITEMdatconptr d2c <span class="keyword">=&gt;</span> s1exp_app_datconptr_tr_up <span class="keyword">(</span>loc_app<span class="keyword">,</span> d2c<span class="keyword">,</span> s1ess<span class="keyword">)</span>
  <span class="keyword">|</span> S2ITEMdatcontyp d2c <span class="keyword">=&gt;</span> s1exp_app_datcontyp_tr_up <span class="keyword">(</span>loc_app<span class="keyword">,</span> d2c<span class="keyword">,</span> s1ess<span class="keyword">)</span>
<span class="comment">(*
  | S2ITEMfil _ =&gt; s1exp_qid_app_tr_up_errmsg_fil loc_qid qid
*)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc_qid<span class="keyword">;</span>
      prerr ": s1exp_qid_app_tr_up: not implemented yet: s2i = "<span class="keyword">;</span> prerr s2i<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_qid_app_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_qid_tr_up
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> the_s2expenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
    <span class="keyword">|</span> S2ITEMcst s2cs <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
      <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">//
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> stacstuseloc_posmark <span class="keyword">(</span>loc0<span class="keyword">,</span> s2c<span class="keyword">)</span>
<span class="comment">//
</span>          <span class="keyword">val</span> s2t <span class="keyword">=</span> s2cst_srt_get s2c<span class="keyword">;</span> <span class="keyword">val</span> s2e_s2c <span class="keyword">=</span> s2exp_cst s2c
        <span class="keyword">in</span>
          <span class="keyword">case+</span> s2t <span class="keyword">of</span>
          <span class="keyword">|</span> S2RTfun <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> _res<span class="keyword">)</span> <span class="keyword">when</span> s2rt_is_dat _res <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              <span class="comment">// a nullary constructor is automatically applied!!!
</span>              s2exp_app_srt <span class="keyword">(</span>_res<span class="keyword">,</span> s2e_s2c<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [S2RTfun]
</span>          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e_s2c
        <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTcons]
</span>      <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="comment">// this clause should be unreachable
</span>          prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": s1exp_qid_tr_up: Some: S2ITEMcst: S2CSTLSTnil"<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTnil]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2ITEMcst]
</span>    <span class="keyword">|</span> S2ITEMe1xp e1xp <span class="keyword">=&gt;</span> s1exp_tr_up <span class="keyword">(</span>s1exp_make_e1xp <span class="keyword">(</span>loc0<span class="keyword">,</span> e1xp<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> S2ITEMvar s2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2var_tmplev_check <span class="keyword">(</span>loc0<span class="keyword">,</span> s2v<span class="keyword">)</span> <span class="keyword">in</span> s2exp_var s2v
      <span class="keyword">end</span> <span class="comment">// end of [S2ITEMvar]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_interror loc0<span class="keyword">;</span>
        prerr ": s1exp_qid_tr_up: s2i = "<span class="keyword">;</span> prerr s2i<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error2 loc0<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_qid_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the static identifier ["<span class="keyword">;</span>
      $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "] is unrecognized."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_qid_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_invar_tr_up
  <span class="keyword">(</span>refval<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1e<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
    <span class="keyword">if</span> refval <span class="keyword">=</span> 0 <span class="keyword">then</span> s2rt_view <span class="comment">(*val*)</span> <span class="keyword">else</span> s2rt_viewt0ype <span class="comment">(*ref*)</span>
  <span class="keyword">val</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span>
<span class="keyword">in</span>
  s2exp_refarg <span class="keyword">(</span>refval<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_invar_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_read_tr_up <span class="keyword">(</span>_v<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">,</span> s1e<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> _v <span class="keyword">=</span> s1exp_tr_dn_view <span class="keyword">(</span>_v<span class="keyword">)</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_up s1e<span class="keyword">;</span> <span class="keyword">val</span> s2t_s2e <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> s2rt_is_impredicative s2t_s2e <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_read_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the static expression needs to be impredicative"<span class="keyword">;</span>
      prerr " but is assigned the sort ["<span class="keyword">;</span>
      prerr s2t_s2e<span class="keyword">;</span>
      prerr "]."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">in</span>
  s2exp_readize <span class="keyword">(</span>_v<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_read_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_top_tr_up <span class="keyword">(</span>knd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1e<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_up s1e
  <span class="keyword">val</span> s2t_fun <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
  <span class="keyword">val</span> s2t_res <span class="keyword">=</span> s2rt_base_fun s2t_fun
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> s2rt_is_impredicative s2t_res <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_top_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the static expression needs to be impredicative"<span class="keyword">;</span>
      prerr " but is assigned the sort ["<span class="keyword">;</span>
      prerr s2t_fun<span class="keyword">;</span>
      prerr "]."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">in</span>
  s2exp_topize <span class="keyword">(</span>knd<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_top_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exp_arg_tr_up
  <span class="keyword">(</span>s1e0<span class="keyword">,</span> wths1es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1e0<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1Einvar <span class="keyword">(</span>refval<span class="keyword">,</span> s1e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        wths1es := WTHS1EXPLSTcons_some <span class="keyword">(</span>refval<span class="keyword">,</span> s1e<span class="keyword">,</span> wths1es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      s1exp_invar_tr_up <span class="keyword">(</span>refval<span class="keyword">,</span> s1e<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Einvar]
</span>  <span class="keyword">|</span> S1Etrans <span class="keyword">(</span>s1e1<span class="keyword">,</span> s1e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1e1<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S1Einvar <span class="keyword">(</span>refval<span class="keyword">,</span> s1e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
          wths1es := WTHS1EXPLSTcons_some <span class="keyword">(</span>refval<span class="keyword">,</span> s1e2<span class="keyword">,</span> wths1es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        s1exp_invar_tr_up <span class="keyword">(</span>refval<span class="keyword">,</span> s1e_arg<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S1Einvar]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error2 s1e1<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
        $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_arg_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": a refval type must begin with !(call-by-value) or &amp;(call-by-reference)"<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S1Etrans]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> wths1es := WTHS1EXPLSTcons_none wths1es
    <span class="keyword">in</span>
      s1exp_tr_up s1e0
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_arg_tr_up]
</span>
<span class="keyword">implement</span>
s1exp_arg_tr_dn_impredicative
  <span class="keyword">(</span>s1e<span class="keyword">,</span> wths1es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_arg_tr_up <span class="keyword">(</span>s1e<span class="keyword">,</span> wths1es<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
<span class="keyword">in</span>
  <span class="keyword">if</span> s2rt_is_impredicative s2t <span class="keyword">then</span> s2e <span class="keyword">else</span> <span class="keyword">begin</span>
    prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_arg_tr_dn_impredicative"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static expression needs to be impredicative"<span class="keyword">;</span>
    prerr " but is assigned the sort ["<span class="keyword">;</span>
    prerr s2t<span class="keyword">;</span>
    prerr "]."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_arg_tr_dn_impredicative]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exp_res_tr_dn_impredicative
  <span class="keyword">(</span>s1e0<span class="keyword">,</span> wths1es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fun</span> auxwth <span class="keyword">(</span>
    wths1es<span class="keyword">:</span> <span class="staexp">wths1explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">wths2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> wths1es <span class="keyword">of</span>
    <span class="keyword">|</span> WTHS1EXPLSTcons_some <span class="keyword">(</span>refval<span class="keyword">,</span> s1e<span class="keyword">,</span> wths1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2t<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span> 
          <span class="keyword">if</span> refval <span class="keyword">=</span> 0 <span class="keyword">then</span> s2rt_view <span class="comment">(*call-by-val*)</span>
          <span class="keyword">else</span> s2rt_viewt0ype <span class="comment">(*call-by-ref*)</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span>
      <span class="keyword">in</span>
        WTHS2EXPLSTcons_some <span class="keyword">(</span>refval<span class="keyword">,</span> s2e<span class="keyword">,</span> auxwth wths1es<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> WTHS1EXPLSTcons_none <span class="keyword">(</span>wths1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        WTHS2EXPLSTcons_none <span class="keyword">(</span>auxwth wths1es<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> WTHS1EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> WTHS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// endof [auxwth]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> auxres <span class="keyword">(</span>
    s1e<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">,</span> wths1es<span class="keyword">:</span> <span class="staexp">wths1explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s1e<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S1Eexi <span class="keyword">(</span>1<span class="comment">(*funres*)</span><span class="keyword">,</span> s1qs<span class="keyword">,</span> s1e_scope<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">@(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span> s1qualst_tr <span class="keyword">(</span>s1qs<span class="keyword">)</span>
        <span class="keyword">val</span> s2e_scope <span class="keyword">=</span> auxres <span class="keyword">(</span>s1e_scope<span class="keyword">,</span> wths1es<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_exi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_scope<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn_impredicative <span class="keyword">(</span>s1e<span class="keyword">)</span>
        <span class="keyword">val</span> wths2es <span class="keyword">=</span> auxwth wths1es
      <span class="keyword">in</span>
        s2exp_wth <span class="keyword">(</span>s2e<span class="keyword">,</span> wths2es<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="comment">// end of [auxres]
</span><span class="comment">//
</span><span class="keyword">in</span>
  <span class="keyword">if</span> wths1explst_is_none <span class="keyword">(</span>wths1es<span class="keyword">)</span> <span class="keyword">then</span> s1exp_tr_dn_impredicative <span class="keyword">(</span>s1e0<span class="keyword">)</span>
  <span class="keyword">else</span> auxres <span class="keyword">(</span>s1e0<span class="keyword">,</span> wths1es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_res_tr_dn_impredicative]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_arrow_tr_up <span class="comment">// arrow is a special type constructor
</span>  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> ofc<span class="keyword">:</span> <span class="staexp">funcloopt</span><span class="keyword">,</span>
   islin<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> isprf<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> oefc<span class="keyword">:</span> <span class="staexp">efcopt</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp">s1explstlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s1es <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> s1ess <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s1es<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1es <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error2 loc0<span class="keyword">;</span>
        $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_arrow_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": illegal static application."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s1explst</span>
  <span class="keyword">val</span> <span class="keyword">@(</span>s1e_arg<span class="keyword">,</span> s1e_res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> s1es <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s1e1<span class="keyword">,</span> cons <span class="keyword">(</span>s1e2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">@(</span>s1e1<span class="keyword">,</span> s1e2<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_interror loc0<span class="keyword">;</span>
        prerr ": s1exp_arrow_tr_up: s1es = "<span class="keyword">;</span> prerr_s1explst s1es<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s1exp<span class="keyword">,</span> s1exp<span class="keyword">)</span></span> <span class="comment">// end of [val]
</span>  <span class="keyword">var</span> npf<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> s1es_arg<span class="keyword">:</span> <span class="staexp">s1explst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> s1e_arg<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S1Elist <span class="keyword">(</span>n<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>npf := n<span class="keyword">;</span> s1es_arg := s1es<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s1es_arg := cons <span class="keyword">(</span>s1e_arg<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">var</span> wths1es<span class="keyword">:</span> <span class="staexp">wths1explst</span> <span class="keyword">=</span> WTHS1EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// restoration
</span>  <span class="keyword">val</span> s2es_arg<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> aux <span class="keyword">(</span>s1es_arg<span class="keyword">,</span> wths1es<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">,</span> wths1es<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>wths1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span>
      <span class="keyword">case+</span> s1es <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>s1e<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_arg_tr_up <span class="keyword">(</span>s1e<span class="keyword">,</span> wths1es<span class="keyword">)</span>
          <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
          <span class="keyword">var</span> imp<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> types<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2t <span class="keyword">of</span>
            <span class="keyword">|</span> S2RTbas s2tb <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2tb <span class="keyword">of</span>
              <span class="keyword">|</span> S2RTBASimp <span class="keyword">(</span>id<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                  imp := 1<span class="keyword">;</span> <span class="keyword">if</span> id <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_TYPES <span class="keyword">then</span> types := 1
                <span class="keyword">end</span> <span class="comment">// end of [S2RTBASimp]
</span>              <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [_]
</span>              <span class="keyword">end</span>
            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">case+</span> 0 <span class="keyword">of</span>
          <span class="keyword">|</span> _ <span class="keyword">when</span> types <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1es <span class="keyword">of</span>
            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>s2exp_vararg s2e<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
            <span class="keyword">|</span> cons _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
                $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_arrow_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
                prerr ": this static expression must be the last argument."<span class="keyword">;</span>
                prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>            <span class="keyword">end</span> <span class="comment">// end of [_ when types &gt; 0]
</span>          <span class="keyword">|</span> _ <span class="keyword">when</span> <span class="keyword">(</span>imp <span class="keyword">&gt;</span> 0<span class="keyword">)</span> <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> aux <span class="keyword">(</span>s1es<span class="keyword">,</span> wths1es<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
              $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_arrow_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": the static expression needs to be impredicative"<span class="keyword">;</span>
              prerr " but is assigned the sort ["<span class="keyword">;</span>
              prerr s2t<span class="keyword">;</span>
              prerr "]."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [_]
</span>        <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> wths1es := wths1explst_reverse wths1es
  <span class="keyword">val</span> s2e_res <span class="keyword">=</span> s1exp_res_tr_dn_impredicative <span class="keyword">(</span>s1e_res<span class="keyword">,</span> wths1es<span class="keyword">)</span>
  <span class="keyword">val</span> s2t_res <span class="keyword">=</span> s2e_res<span class="keyword">.</span>s2exp_srt
  <span class="keyword">val</span> isprf<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">if</span> isprf <span class="keyword">then</span> isprf <span class="keyword">else</span> s2rt_is_proof s2t_res
  <span class="keyword">val</span> fc <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> ofc <span class="keyword">of</span> <span class="comment">// default is [function]
</span>    <span class="keyword">|</span> Some fc <span class="keyword">=&gt;</span> fc <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>funclo</span>
  <span class="keyword">val</span> s2t_fun <span class="keyword">=</span> s2rt_prf_lin_fc <span class="keyword">(</span>loc0<span class="keyword">,</span> isprf<span class="keyword">,</span> islin<span class="keyword">,</span> fc<span class="keyword">)</span>
  <span class="keyword">val</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">if</span> islin <span class="keyword">then</span> 1 <span class="keyword">else</span> 0
  <span class="keyword">val</span> sf2e <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> oefc <span class="keyword">of</span>
    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> isprf <span class="keyword">then</span> S2EFFnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> S2EFFall <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None]
</span>    <span class="keyword">|</span> Some efc <span class="keyword">=&gt;</span> effcst_tr efc
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2eff</span>
<span class="keyword">in</span>
  s2exp_fun_srt <span class="keyword">(</span>s2t_fun<span class="keyword">,</span> fc<span class="keyword">,</span> lin<span class="keyword">,</span> sf2e<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> s2e_res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_arrow_tr_up]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s1rtext_tr
  <span class="keyword">(</span>s1te0<span class="keyword">:</span> <span class="staexp">s1rtext</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2rtext</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1te0<span class="keyword">.</span>s1rtext_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1TEsrt s1t <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1t<span class="keyword">.</span>s1rt_node <span class="keyword">of</span>
    <span class="keyword">|</span> S1RTqid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> the_s2rtenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2te <span class="keyword">=&gt;</span> s2te <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          prerr_loc_error2 s1t<span class="keyword">.</span>s1rt_loc<span class="keyword">;</span>
          $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1rtext_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
          prerr ": the identifier ["<span class="keyword">;</span>
          $Syn<span class="keyword">.</span>prerr_s0rtq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
          prerr "] refers to an unrecognized sort."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S1RTqid]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> S2TEsrt <span class="keyword">(</span>s1rt_tr s1t<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1TEsrt]
</span>  <span class="keyword">|</span> S1TEsub <span class="keyword">(</span>id<span class="keyword">,</span> s1te<span class="keyword">,</span> s1ps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2te <span class="keyword">=</span> s1rtext_tr s1te
      <span class="keyword">val</span> s2t <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2te <span class="keyword">of</span>
        <span class="keyword">|</span> S2TEsrt s2t <span class="keyword">=&gt;</span> s2t <span class="keyword">|</span> S2TEsub <span class="keyword">(</span>_<span class="keyword">,</span> s2t<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2t
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> s2v <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>id<span class="keyword">,</span> s2t<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_svar s2v
      <span class="keyword">val</span> s2ps <span class="keyword">=</span> s1explst_tr_dn_bool s1ps
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2ps <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> s2te <span class="keyword">of</span>
        <span class="keyword">|</span> S2TEsrt _ <span class="keyword">=&gt;</span> s2ps
        <span class="keyword">|</span> S2TEsub <span class="keyword">(</span>s2v1<span class="keyword">,</span> _<span class="keyword">,</span> s2ps1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            $Lst<span class="keyword">.</span>list_append <span class="keyword">(</span>s2ps<span class="keyword">,</span> s2explst_alpha <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2v<span class="keyword">,</span> s2ps1<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">end</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2explst</span>
    <span class="keyword">in</span>
      S2TEsub <span class="keyword">(</span>s2v<span class="keyword">,</span> s2t<span class="keyword">,</span> s2ps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1TEsub]
</span><span class="keyword">end</span> <span class="comment">// end of [s1rtext_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> s1qualst_tr <span class="keyword">(</span>s1qs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span><span class="keyword">fun</span> loop
  <span class="keyword">(</span>s1qs<span class="keyword">:</span> <span class="staexp">s1qualst</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1qs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s1q<span class="keyword">,</span> s1qs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1q<span class="keyword">.</span>s1qua_node <span class="keyword">of</span>
    <span class="keyword">|</span> S1Qprop s1e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2p <span class="keyword">=</span> s1exp_tr_dn_bool s1e
      <span class="keyword">in</span>
        s2ps := cons <span class="keyword">(</span>s2p<span class="keyword">,</span> s2ps<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>s1qs<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> S1Qvars <span class="keyword">(</span>ids<span class="keyword">,</span> s1te<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1rtext_tr s1te <span class="keyword">of</span>
      <span class="keyword">|</span> S2TEsrt s2t1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">fun</span> aux <span class="keyword">(</span>s2t1<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> ids<span class="keyword">:</span> <span class="staexp">i0delst</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
            <span class="keyword">case+</span> ids <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>id<span class="keyword">,</span> ids<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> s2v <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>id<span class="keyword">.</span>i0de_sym<span class="keyword">,</span> s2t1<span class="keyword">)</span>
              <span class="keyword">in</span>
                the_s2expenv_add_svar s2v<span class="keyword">;</span> s2vs := cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">;</span>
                aux <span class="keyword">(</span>s2t1<span class="keyword">,</span> ids<span class="keyword">,</span> s2vs<span class="keyword">)</span>
              <span class="keyword">end</span>
            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>          
        <span class="keyword">in</span>
          aux <span class="keyword">(</span>s2t1<span class="keyword">,</span> ids<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>s1qs<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> S2TEsub <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2t1<span class="keyword">,</span> s2ps1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">fun</span> aux1 <span class="keyword">(</span>s2ps1<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> s2v<span class="keyword">:</span> <span class="staexp">s2var_t</span><span class="keyword">,</span> s2ps<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">)</span>
            <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2ps1 <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>s2p1<span class="keyword">,</span> s2ps1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_alpha <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2v<span class="keyword">,</span> s2p1<span class="keyword">)</span>
              <span class="keyword">in</span>
                s2ps := cons <span class="keyword">(</span>s2p<span class="keyword">,</span> s2ps<span class="keyword">)</span><span class="keyword">;</span> aux1 <span class="keyword">(</span>s2ps1<span class="keyword">,</span> s2v<span class="keyword">,</span> s2ps<span class="keyword">)</span>
              <span class="keyword">end</span>
            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">fun</span> aux2 <span class="keyword">(</span>ids<span class="keyword">:</span> <span class="staexp">i0delst</span><span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">)</span>
            <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> ids <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>id<span class="keyword">,</span> ids<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> s2v <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>id<span class="keyword">.</span>i0de_sym<span class="keyword">,</span> s2t1<span class="keyword">)</span>
              <span class="keyword">in</span>
                the_s2expenv_add_svar s2v<span class="keyword">;</span>
                s2vs := cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">;</span> aux1 <span class="keyword">(</span>s2ps1<span class="keyword">,</span> s2v<span class="keyword">,</span> s2ps<span class="keyword">)</span><span class="keyword">;</span>
                aux2 <span class="keyword">(</span>ids<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
              <span class="keyword">end</span>
            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          aux2 <span class="keyword">(</span>ids<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span>s1qs<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2TEsub]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S1Qvars]
</span>    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="comment">//
</span><span class="keyword">var</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">and</span> s2ps<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>s1qs<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">in</span> <span class="comment">// in of [let]
</span><span class="comment">//
</span><span class="keyword">(</span>$Lst<span class="keyword">.</span>list_reverse s2vs<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_reverse s2ps<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">end</span> <span class="comment">// end of [s1qualst_tr]
</span>
<span class="keyword">implement</span>
s1qualstlst_tr <span class="keyword">(</span>s1qss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1qss <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1qs<span class="keyword">,</span> s1qss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      list_cons <span class="keyword">(</span>s1qualst_tr s1qs<span class="keyword">,</span> s1qualstlst_tr s1qss<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1qualstlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s1exp_app_unwind
  <span class="keyword">(</span>s1e<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">,</span> s1ess<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s1explstlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s1exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1e<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1Eapp <span class="keyword">(</span>s1e<span class="keyword">,</span> _<span class="comment">(*loc_arg*)</span><span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1ess := s1es :: s1ess<span class="keyword">;</span> s1exp_app_unwind <span class="keyword">(</span>s1e<span class="keyword">,</span> s1ess<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eapp]
</span>  <span class="keyword">|</span> S1Eqid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> q<span class="keyword">.</span>s0taq_node <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>S0TAQnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> the_s2expenv_find id <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
        <span class="keyword">|</span> S2ITEMe1xp e1xp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> s1e_new <span class="keyword">=</span> s1exp_make_e1xp <span class="keyword">(</span>s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> e1xp<span class="keyword">)</span>
          <span class="keyword">in</span>
            s1exp_app_unwind <span class="keyword">(</span>s1e_new<span class="keyword">,</span> s1ess<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [S2ITEMe1xp] *)</span>
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s1e
        <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1e
      <span class="keyword">end</span> <span class="comment">// end of [$Syn.S0TAQnone]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s1e
    <span class="keyword">end</span> <span class="comment">(* end of [S1Eqid] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s1e
<span class="keyword">end</span> <span class="comment">// end of [s1exp_app_unwind]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s2rtlst_of_s2varlst
  <span class="keyword">(</span>s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2rtlst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2var_srt_get<span class="keyword">)</span>
<span class="comment">// end of [s2rtlst_of_s2varlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">fun</span> aux01 <span class="keyword">(</span>
    i<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">,</span> s1es<span class="keyword">:</span> <span class="staexp">s1explst</span>
  <span class="keyword">,</span> lin<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">,</span> prg<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">labs2explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1es <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1e<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> lab <span class="keyword">=</span> $Lab<span class="keyword">.</span>label_make_int i
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn_impredicative s1e
      <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> s2rt_is_linear s2t <span class="keyword">then</span> <span class="keyword">(</span>lin := lin+1<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i &gt;= npf <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">if</span> <span class="keyword">~</span><span class="keyword">(</span>s2rt_is_proof s2t<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span>prg := prg+1<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s2e<span class="keyword">,</span> aux01 <span class="keyword">(</span>i+1<span class="keyword">,</span> npf<span class="keyword">,</span> s1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [list_cons] *)</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
<span class="keyword">end</span> <span class="comment">// end of [aux01]
</span>
<span class="keyword">fun</span> aux23 <span class="keyword">(</span>
    s2t<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">labs2explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s1es <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s1e<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> lab <span class="keyword">=</span> $Lab<span class="keyword">.</span>label_make_int i
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span>
    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s2e<span class="keyword">,</span> aux23 <span class="keyword">(</span>s2t<span class="keyword">,</span> i+1<span class="keyword">,</span> s1es<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [list_cons] *)</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
<span class="keyword">end</span> <span class="comment">// end of [aux23]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">fn</span> s1exp_list_tr_up
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux01 <span class="keyword">(</span>0<span class="keyword">,</span> npf<span class="keyword">,</span> s1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">,</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2t_rec <span class="keyword">=</span> <span class="keyword">begin</span>
    s2rt_lin_prg_boxed_npf_labs2explst <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> 0<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">in</span>
  s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> TYRECKINDflt0 <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_list_tr_up]
</span>
<span class="keyword">fn</span> s1exp_tytup_tr_up
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> tupknd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> tupknd <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 0 &lt;= tupknd andalso tupknd &lt;= 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux01 <span class="keyword">(</span>0<span class="keyword">,</span> 0<span class="keyword">,</span> s1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">,</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> boxed <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> tupknd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
      <span class="keyword">val</span> s2t_rec <span class="keyword">=</span> <span class="keyword">begin</span>
        s2rt_lin_prg_boxed_npf_labs2explst <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> boxed<span class="keyword">,</span> 0<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [s2t_rec] *)</span>
      <span class="keyword">val</span> tyrecknd <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> boxed <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> TYRECKINDflt0 <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">tyreckind</span>
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> tyrecknd<span class="keyword">,</span> 0<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [_ when ...] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 2 &lt;= tupknd andalso tupknd &lt;= 3 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t_elt<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> tupknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_t0ype <span class="keyword">else</span> s2rt_viewt0ype
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux23 <span class="keyword">(</span>s2t_elt<span class="keyword">,</span> 0<span class="keyword">,</span> s1es<span class="keyword">,</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2t_rec<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> tupknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_viewtype
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> 0<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [_ when ...] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": s1exp_tytup_tr_up"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_tytup_tr_up]
</span>
<span class="keyword">fn</span> s1exp_tytup2_tr_up
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> tupknd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1es1<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">,</span> s1es2<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> tupknd <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 0 &lt;= tupknd andalso tupknd &lt;= 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
      <span class="keyword">val</span> npf <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length s1es1        
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> ls2es2 <span class="keyword">=</span> aux01 <span class="keyword">(</span>npf<span class="keyword">,</span> npf<span class="keyword">,</span> s1es2<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">val</span> ls2es12 <span class="keyword">=</span> aux01 <span class="keyword">(</span>0<span class="keyword">,</span> npf<span class="keyword">,</span> s1es1<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">,</span> ls2es2<span class="keyword">)</span>
      <span class="keyword">val</span> boxed <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> tupknd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
      <span class="keyword">val</span> s2t_rec <span class="keyword">=</span> <span class="keyword">begin</span>
        s2rt_lin_prg_boxed_npf_labs2explst <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> boxed<span class="keyword">,</span> 0<span class="keyword">,</span> ls2es2<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val</span> tyrecknd <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> boxed <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> TYRECKINDflt0 <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">tyreckind</span>
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> tyrecknd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es12<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 2 &lt;= tupknd andalso tupknd &lt;= 3 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> npf <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length s1es1
      <span class="keyword">val</span> s2t_elt1<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> tupknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_prop <span class="keyword">else</span> s2rt_view
      <span class="keyword">val</span> s2t_elt2<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> tupknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_t0ype <span class="keyword">else</span> s2rt_viewt0ype
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux23 <span class="keyword">(</span>s2t_elt2<span class="keyword">,</span> npf<span class="keyword">,</span> s1es2<span class="keyword">,</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux23 <span class="keyword">(</span>s2t_elt1<span class="keyword">,</span> 0<span class="keyword">,</span> s1es1<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">val</span> s2t_rec<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> tupknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_viewtype
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": s1exp_tytup2_tr_up"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_tytup2_tr_up]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">fun</span> aux01
  <span class="keyword">(</span>ls1es<span class="keyword">:</span> <span class="staexp">labs1explst</span><span class="keyword">,</span> lin<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> prg<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls1es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS1EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s1e<span class="keyword">,</span> ls1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_up s1e
      <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> s2rt_is_linear s2t <span class="keyword">then</span> <span class="keyword">(</span>lin := lin+1<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">~</span><span class="keyword">(</span>s2rt_is_proof s2t<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span>prg := prg+1<span class="keyword">)</span>
    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s2e<span class="keyword">,</span> aux01 <span class="keyword">(</span>ls1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> LABS1EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [aux01]
</span>
<span class="keyword">fun</span> aux23 <span class="keyword">(</span>
    s2t<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> ls1es<span class="keyword">:</span> <span class="staexp">labs1explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls1es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS1EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s1e<span class="keyword">,</span> ls1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span>
    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>lab<span class="keyword">,</span> s2e<span class="keyword">,</span> aux23 <span class="keyword">(</span>s2t<span class="keyword">,</span> ls1es<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [LABS1EXPLSTcons]
</span>  <span class="keyword">|</span> LABS1EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [aux23]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="comment">(*
// HX-2010-11-01: simplification
fn s1exp_struct_tr_up (
   loc0: loc_t, ls1es: labs1explst
  ) : s2exp = let
  var lin: int = 0 and prg: int = 0      
  val ls2es = aux01 (ls1es, lin, prg)
  val s2t_rec: s2rt = begin
    s2rt_lin_prg_boxed_npf_labs2explst (lin, prg, 0(*boxed*), 0, ls2es)
  end // end of [val]
  val stamp = $Stamp.s2exp_struct_stamp_make ()
in
  s2exp_tyrec_srt (s2t_rec, TYRECKINDflt1 stamp, 0(*npf*), ls2es)
end // end of [s1exp_struct_tr_up]
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_tmpid_tr <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>d0ynq</span>
  <span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">$Sym<span class="keyword">.</span>symbol_t</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2cst_t</span> <span class="keyword">=</span> s2c <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">(*
  val () = begin
    $Loc.print_location loc0;
    print ": s1exp_tmpid_tr: id = "; $Sym.print_symbol id; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">fn</span> err1
    <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2cst_t</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tmpid_tr: err1"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] does not refer to a static constant"<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2cst_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err1]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> err2 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2cst_t</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tmpid_tr: err2"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] is unrecognized."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2cst_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err2]
</span><span class="comment">//
</span>  <span class="keyword">val</span> q_loc <span class="keyword">=</span> q<span class="keyword">.</span>d0ynq_loc
  <span class="keyword">val</span> q_node <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> q<span class="keyword">.</span>d0ynq_node <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>D0YNQnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Syn<span class="keyword">.</span>S0TAQnone <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>D0YNQfildot nam <span class="keyword">=&gt;</span> $Syn<span class="keyword">.</span>S0TAQfildot nam
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>D0YNQsymcolon sym <span class="keyword">=&gt;</span> $Syn<span class="keyword">.</span>S0TAQsymcolon sym
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>D0YNQsymdot sym <span class="keyword">=&gt;</span> $Syn<span class="keyword">.</span>S0TAQsymdot sym
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error2 <span class="keyword">(</span>q_loc<span class="keyword">)</span><span class="keyword">;</span>
        $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tmpid_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": the static qualifier ["<span class="keyword">;</span> $Syn<span class="keyword">.</span>prerr_d0ynq q<span class="keyword">;</span> prerr "] is not supported."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>$Syn<span class="keyword">.</span>s0taq_node<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq_node</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> q <span class="keyword">=</span> $Syn<span class="keyword">.</span>s0taq_make <span class="keyword">(</span>q_loc<span class="keyword">,</span> q_node<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> the_s2expenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span>
  <span class="keyword">val</span> s2c <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> ans <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
      <span class="keyword">|</span> S2ITEMcst s2cs <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
        <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2c <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">//
</span>            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> stacstuseloc_posmark <span class="keyword">(</span>loc0<span class="keyword">,</span> s2c<span class="keyword">)</span>
<span class="comment">//
</span>          <span class="keyword">}</span> <span class="comment">// end of [S2CSTLSTcons]
</span>        <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>loc0<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [S2ITEMcst] *)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>loc0<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err2 <span class="keyword">(</span>loc0<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2cst_t</span>
<span class="keyword">}</span> <span class="comment">// end of [s1exp_tmpid_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1exp_tyrec_tr_up <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> recknd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ls1es<span class="keyword">:</span> <span class="staexp">labs1explst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> recknd <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 0 &lt;= recknd andalso recknd &lt;= 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux01 <span class="keyword">(</span>ls1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">)</span>
      <span class="keyword">val</span> boxed <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> recknd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
      <span class="keyword">val</span> s2t_rec<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        s2rt_lin_prg_boxed_npf_labs2explst <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> boxed<span class="keyword">,</span> 0<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val</span> tyrecknd <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> boxed <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> TYRECKINDflt0 <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">tyreckind</span>
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> tyrecknd<span class="keyword">,</span> 0<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> 2 &lt;= recknd andalso recknd &lt;= 3 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t_rec<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> recknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_viewtype
      <span class="keyword">val</span> s2t_elt<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
        <span class="keyword">if</span> recknd <span class="keyword">=</span> 2 <span class="keyword">then</span> s2rt_t0ype <span class="keyword">else</span> s2rt_viewt0ype
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux23 <span class="keyword">(</span>s2t_elt<span class="keyword">,</span> ls1es<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> 0<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": s1exp_tyrec_tr_up"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exp_tyrec_tr_up]
</span>
<span class="keyword">fn</span> s1exp_tyrec_ext_tr_up
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> name<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">,</span> ls1es<span class="keyword">:</span> <span class="staexp">labs1explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0      
  <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux01 <span class="keyword">(</span>ls1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">)</span>
  <span class="keyword">val</span> s2t_rec<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    s2rt_lin_prg_boxed_npf_labs2explst <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> 0<span class="comment">(*boxed*)</span><span class="keyword">,</span> 0<span class="keyword">,</span> ls2es<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  s2exp_tyrec_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> TYRECKINDflt_ext name<span class="keyword">,</span> 0<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_tyrec_ext_tr_up]
</span>
<span class="keyword">fn</span> s1exp_union_tr_up <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s1e_ind<span class="keyword">:</span> <span class="staexp">s1exp</span><span class="keyword">,</span> ls1es<span class="keyword">:</span> <span class="staexp">labs1explst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e_ind <span class="keyword">=</span> s1exp_tr_dn_int s1e_ind
  <span class="keyword">var</span> lin<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> prg<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> ls2es <span class="keyword">=</span> aux01 <span class="keyword">(</span>ls1es<span class="keyword">,</span> lin<span class="keyword">,</span> prg<span class="keyword">)</span>
  <span class="keyword">val</span> s2t_rec <span class="keyword">=</span> s2rt_lin_prg_boxed <span class="keyword">(</span>lin<span class="keyword">,</span> prg<span class="keyword">,</span> 0<span class="comment">(*boxed*)</span><span class="keyword">)</span>
  <span class="keyword">val</span> stamp <span class="keyword">=</span> $Stamp<span class="keyword">.</span>s2exp_union_stamp_make <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  s2exp_union_srt <span class="keyword">(</span>s2t_rec<span class="keyword">,</span> stamp<span class="keyword">,</span> s2e_ind<span class="keyword">,</span> ls2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_union_tr_up]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exp_tr_up <span class="keyword">(</span>s1e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s1exp_tr_up: s1e0 = "; print s1e0; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s1e0<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1Eann <span class="keyword">(</span>s1e<span class="keyword">,</span> s1t<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">let</span> <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr s1t <span class="keyword">in</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eann]
</span>  <span class="keyword">|</span> S1Eany <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_any_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">)</span>
  <span class="keyword">|</span> S1Eapp <span class="keyword">(</span>s1e<span class="keyword">,</span> _<span class="comment">(*loc_arg*)</span><span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> s1ess_arg<span class="keyword">:</span> <span class="staexp">s1explstlst</span> <span class="keyword">=</span> <span class="keyword">'[</span>s1es<span class="keyword">]</span>
      <span class="keyword">val</span> s1e_opr <span class="keyword">=</span> s1exp_app_unwind <span class="keyword">(</span>s1e<span class="keyword">,</span> s1ess_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s1e_opr<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S1Eqid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> staspecid_of_qid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> SPSIDarrow <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_arrow_tr_up
            <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> false<span class="keyword">,</span> false<span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> s1ess_arg<span class="keyword">)</span>
        <span class="keyword">|</span> SPSIDnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> the_s2expenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> s1exp_qid_app_tr_up
              <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> s1e_opr<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">,</span> s2i<span class="keyword">,</span> s1ess_arg<span class="keyword">)</span>
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error2 s1e<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
              $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tr_up"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": unrecognized static identifier ["<span class="keyword">;</span>
              $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
              prerr "]."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>          <span class="keyword">end</span> <span class="comment">// end of [SPSIDnone]
</span>        <span class="keyword">end</span> <span class="comment">// end of [S1Eqid]
</span>      <span class="keyword">|</span> S1Eimp <span class="keyword">(</span>fc<span class="keyword">,</span> lin<span class="keyword">,</span> prf<span class="keyword">,</span> oefc<span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_arrow_tr_up 
          <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> Some fc<span class="keyword">,</span> lin<span class="keyword">&gt;</span>0<span class="keyword">,</span> prf<span class="keyword">&gt;</span>0<span class="keyword">,</span> oefc<span class="keyword">,</span> <span class="keyword">'[</span>s1es<span class="keyword">]</span><span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2e_opr <span class="keyword">=</span> s1exp_tr_up s1e_opr
        <span class="keyword">in</span>
          s1exp_app_tr_up <span class="keyword">(</span>
            s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> s1e_opr<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> s2e_opr<span class="keyword">,</span> s1ess_arg
          <span class="keyword">)</span> <span class="comment">// end of [s1exp_app_tr_up]
</span>        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="comment">// end of [case]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S1Eapp]
</span>  <span class="keyword">|</span> S1Echar c <span class="keyword">=&gt;</span> s2exp_char c
  <span class="keyword">|</span> S1Eexi <span class="keyword">(</span>knd<span class="keyword">,</span> s1qs<span class="keyword">,</span> s1e_scope<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
      val () = begin
        print "s1exp_tr_up: S1Eexi: s1e0 = "; print s1e0; print_newline ()
      end // end of [val]
*)</span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error2 <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr <span class="keyword">(</span>
          ": The existential quantifier #[...] is used incorrectly."
        <span class="keyword">)</span> <span class="comment">// end of [val]
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span> s1qualst_tr <span class="keyword">(</span>s1qs<span class="keyword">)</span>
      <span class="keyword">val</span> s2e_scope <span class="keyword">=</span> s1exp_tr_dn_impredicative s1e_scope
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_exi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_scope<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eexi]
</span>  <span class="keyword">|</span> S1Eextype <span class="keyword">(</span>name<span class="keyword">,</span> s1ess_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2ess_arg <span class="keyword">=</span>
        s1explstlst_tr_dn_viewt0ype <span class="keyword">(</span>s1ess_arg<span class="keyword">)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      s2exp_extype_srt <span class="keyword">(</span>s2rt_viewt0ype<span class="keyword">,</span> name<span class="keyword">,</span> s2ess_arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eextype]
</span>  <span class="keyword">|</span> S1Eimp _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
      prerr ": s1exp_tr_up: S1Eimp"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eimp]
</span>  <span class="keyword">|</span> S1Eint int<span class="comment">(*string*)</span> <span class="keyword">=&gt;</span> s2exp_intinf <span class="keyword">(</span>$IntInf<span class="keyword">.</span>intinf_make_string<span class="keyword">(</span>int<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> S1Einvar <span class="keyword">(</span>refval<span class="keyword">,</span> s1e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error2 <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr <span class="keyword">(</span>
        ": an invariant type can only be assigned to the argument of a function."
      <span class="keyword">)</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Einvar]
</span>  <span class="keyword">|</span> S1Elam <span class="keyword">(</span>s1as<span class="keyword">,</span> os1t<span class="keyword">,</span> s1e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2vs <span class="keyword">=</span> s1arglst_var_tr s1as<span class="keyword">;</span> <span class="keyword">val</span> s2e_body <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> os1t <span class="keyword">of</span>
        <span class="keyword">|</span> Some s1t <span class="keyword">=&gt;</span> s1exp_tr_dn <span class="keyword">(</span>s1e_body<span class="keyword">,</span> s1rt_tr s1t<span class="keyword">)</span>
        <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_tr_up s1e_body
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2ts_arg <span class="keyword">=</span> s2rtlst_of_s2varlst <span class="keyword">(</span>s2vs<span class="keyword">)</span>
      <span class="keyword">val</span> s2t_res <span class="keyword">=</span> s2e_body<span class="keyword">.</span>s2exp_srt
    <span class="keyword">in</span>
      s2exp_lam_srt <span class="keyword">(</span>s2rt_fun <span class="keyword">(</span>s2ts_arg<span class="keyword">,</span> s2t_res<span class="keyword">)</span><span class="keyword">,</span> s2vs<span class="keyword">,</span> s2e_body<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Elam]
</span>  <span class="keyword">|</span> S1Elist <span class="keyword">(</span>npf<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_list_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> npf<span class="keyword">,</span> s1es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Elist]
</span><span class="comment">(*
// HX-2010-12-04: simplification
  | S1Emod _ =&gt; let
      val () = prerr_loc_interror s1e0.s1exp_loc
      val () = prerr ": s1exp_tr_up: S1Emod: not implemented yet."
      val () = prerr_newline ()
    in
      $Err.abort {s2exp} ()
    end // end of [S1Emod]
*)</span>
<span class="comment">(*
// HX-2010-12-04: inadequate design
  | S1Enamed (name, s1e) =&gt; let
      val s2e = s1exp_tr_up (s1e) in
      s2exp_named (s2e.s2exp_srt, name, s2e)
    end // end of [S1Enamed]
*)</span>
  <span class="keyword">|</span> S1Eqid <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_qid_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
  <span class="keyword">|</span> S1Eread <span class="keyword">(</span>_v<span class="keyword">,</span> s1e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_read_tr_up <span class="keyword">(</span>_v<span class="keyword">,</span> s1e<span class="keyword">)</span>
<span class="comment">(*
// HX-2010-11-01: simplification
  | S1Estruct (ls1es) =&gt; begin
      s1exp_struct_tr_up (s1e0.s1exp_loc, ls1es)
    end // end of [S1Estruct]
*)</span>
  <span class="keyword">|</span> S1Etop <span class="keyword">(</span>knd<span class="keyword">,</span> s1e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s1exp_top_tr_up <span class="keyword">(</span>knd<span class="keyword">,</span> s1e<span class="keyword">)</span>
  <span class="keyword">|</span> S1Etrans _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error2 s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">;</span>
      prerr ": a transitional type can only be assigned to the argument of a function."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etrans]
</span>  <span class="keyword">|</span> S1Etyarr <span class="keyword">(</span>s1e_elt<span class="keyword">,</span> s1ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> s1exp_tr_dn_viewt0ype s1e_elt
      <span class="keyword">val</span> s2ess_dim <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1ess_dim<span class="keyword">,</span> s1explst_tr_dn_int<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_tyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etyarr]
</span>  <span class="keyword">|</span> S1Etyrec <span class="keyword">(</span>recknd<span class="keyword">,</span> ls1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_tyrec_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> recknd<span class="keyword">,</span> ls1es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etyrec]
</span>  <span class="keyword">|</span> S1Etyrec_ext <span class="keyword">(</span>name<span class="keyword">,</span> ls1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_tyrec_ext_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> name<span class="keyword">,</span> ls1es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etyrec_ext]
</span>  <span class="keyword">|</span> S1Etytup <span class="keyword">(</span>tupknd<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_tytup_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> tupknd<span class="keyword">,</span> s1es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etytup]
</span>  <span class="keyword">|</span> S1Etytup2 <span class="keyword">(</span>tupknd<span class="keyword">,</span> s1es1<span class="keyword">,</span> s1es2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_tytup2_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> tupknd<span class="keyword">,</span> s1es1<span class="keyword">,</span> s1es2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Etytup2]
</span>  <span class="keyword">|</span> S1Euni <span class="keyword">(</span>s1qs<span class="keyword">,</span> s1e_scope<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">and</span> s2ps<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">)</span> <span class="keyword">=</span> s1qualst_tr <span class="keyword">(</span>s1qs<span class="keyword">)</span>
      <span class="keyword">val</span> s2e_scope <span class="keyword">=</span> s1exp_tr_dn_impredicative s1e_scope
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_uni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_scope<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Euni]
</span>  <span class="keyword">|</span> S1Eunion <span class="keyword">(</span>s2e_ind<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s1exp_union_tr_up <span class="keyword">(</span>s1e0<span class="keyword">.</span>s1exp_loc<span class="keyword">,</span> s2e_ind<span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eunion]
</span><span class="comment">(*
  | _ =&gt; begin
      prerr_loc_interror s1e0.s1exp_loc;
      prerr ": s1exp_tr: not available yet."; prerr_newine ();
      $Err.abort {s2exp} ()
    end // end of [_]
*)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1exp_tr_up]
</span>
<span class="keyword">implement</span>
s1explst_tr_up <span class="keyword">(</span>s1es<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1es<span class="keyword">,</span> s1exp_tr_up<span class="keyword">)</span>
<span class="keyword">implement</span>
s1explstlst_tr_up <span class="keyword">(</span>s1ess<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1ess<span class="keyword">,</span> s1explst_tr_up<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
tmps1explstlst_tr_up
  <span class="keyword">(</span>ts1ess<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ts1ess <span class="keyword">of</span>
  <span class="keyword">|</span> TMPS1EXPLSTLSTcons
      <span class="keyword">(</span>loc<span class="keyword">,</span> s1es<span class="keyword">,</span> ts1ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s1explst_tr_up s1es
      <span class="keyword">val</span> ts2ess <span class="keyword">=</span> tmps1explstlst_tr_up ts1ess
    <span class="keyword">in</span>
      TMPS2EXPLSTLSTcons <span class="keyword">(</span>loc<span class="keyword">,</span> s2e<span class="keyword">,</span> ts2ess<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [TMPS1EXPLSTLSTcons]
</span>  <span class="keyword">|</span> TMPS1EXPLSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> TMPS2EXPLSTLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmps1explstlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exp_tr_dn <span class="keyword">(</span>s1e0<span class="keyword">,</span> s2t0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1e0<span class="keyword">.</span>s1exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1Eextype <span class="keyword">(</span>name<span class="keyword">,</span> _arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> _arg <span class="keyword">=</span> s1explstlst_tr_dn_viewt0ype <span class="keyword">(</span>_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> s2rt_is_impredicative s2t0 <span class="keyword">then</span>
        s2exp_extype_srt <span class="keyword">(</span>s2t0<span class="keyword">,</span> name<span class="keyword">,</span> _arg<span class="keyword">)</span> <span class="comment">// [s2t0] can even be a view!
</span>      <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error2 s1e0<span class="keyword">.</span>s1exp_loc
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tr_dn"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the external type cannot be assigned the sort ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr s2t0
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "]."
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1Eextype]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s1exp_tr_up <span class="keyword">(</span>s1e0<span class="keyword">)</span>
      <span class="keyword">val</span> s2t0_new <span class="keyword">=</span> s2e0<span class="keyword">.</span>s2exp_srt
    <span class="keyword">in</span>
      <span class="keyword">if</span> s2t0_new &lt;= s2t0 <span class="keyword">then</span> s2e0 <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error2 s1e0<span class="keyword">.</span>s1exp_loc
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1exp_tr_dn"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the static expression is of sort ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2rt <span class="keyword">(</span>s2t0_new<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] but it is expectecd to be of sort ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2rt <span class="keyword">(</span>s2t0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "]."
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [s1exp_tr_dn] *)</span>

<span class="keyword">implement</span>
s1explst_tr_dn <span class="keyword">(</span>s1es<span class="keyword">,</span> s2ts<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1es <span class="keyword">of</span>
  <span class="keyword">|</span> s1e :: s1es <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val+</span> s2t :: s2ts <span class="keyword">=</span> s2ts
    <span class="keyword">in</span>
      s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span> :: s1explst_tr_dn <span class="keyword">(</span>s1es<span class="keyword">,</span> s2ts<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [::]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1explst_tr_dn]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1exparg_tr <span class="keyword">(</span>s1a<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s1a<span class="keyword">.</span>s1exparg_node <span class="keyword">of</span>
  <span class="keyword">|</span> S1EXPARGone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exparg_one <span class="keyword">(</span>s1a<span class="keyword">.</span>s1exparg_loc<span class="keyword">)</span>
  <span class="keyword">|</span> S1EXPARGall <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exparg_all <span class="keyword">(</span>s1a<span class="keyword">.</span>s1exparg_loc<span class="keyword">)</span>
  <span class="keyword">|</span> S1EXPARGseq <span class="keyword">(</span>s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s2exparg_seq <span class="keyword">(</span>s1a<span class="keyword">.</span>s1exparg_loc<span class="keyword">,</span> s1explst_tr_up s2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S1EXPARGseq]
</span><span class="keyword">end</span> <span class="comment">// end of [s1exparg_tr]
</span>
<span class="keyword">implement</span>
s1exparglst_tr <span class="keyword">(</span>s1as<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s1as<span class="keyword">,</span> s1exparg_tr<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1rtdef_tr
  <span class="keyword">(</span>d<span class="keyword">:</span> <span class="staexp">s1rtdef</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> id <span class="keyword">=</span> d<span class="keyword">.</span>s1rtdef_sym <span class="keyword">and</span> s2te <span class="keyword">=</span> s1rtext_tr <span class="keyword">(</span>d<span class="keyword">.</span>s1rtdef_def<span class="keyword">)</span>
<span class="keyword">in</span>
  the_s2rtenv_add <span class="keyword">(</span>id<span class="keyword">,</span> s2te<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1rtdef_tr]
</span>
<span class="keyword">implement</span>
s1rtdeflst_tr <span class="keyword">(</span>ds<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ds <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d<span class="keyword">,</span> ds<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>s1rtdef_tr d<span class="keyword">;</span> s1rtdeflst_tr ds<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1rtdeflst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d1atarg_tr <span class="keyword">(</span>
  d1a<span class="keyword">:</span> <span class="staexp">d1atarg</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d1a<span class="keyword">.</span>d1atarg_node <span class="keyword">of</span>
  <span class="keyword">|</span> D1ATARGsrt s1tp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr <span class="keyword">(</span>s1tp<span class="keyword">.</span>s1rtpol_srt<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">@(</span>None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> s2t<span class="keyword">,</span> s1tp<span class="keyword">.</span>s1rtpol_pol<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D1ATARGsrt]
</span>  <span class="keyword">|</span> D1ATARGidsrt <span class="keyword">(</span>id<span class="keyword">,</span> s1tp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr <span class="keyword">(</span>s1tp<span class="keyword">.</span>s1rtpol_srt<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">@(</span>Some id<span class="keyword">,</span> s2t<span class="keyword">,</span> s1tp<span class="keyword">.</span>s1rtpol_pol<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D1ATARGidsrt]
</span><span class="keyword">end</span> <span class="comment">// end of [d1atarg_tr]
</span>
<span class="keyword">implement</span>
d1atarglst_tr <span class="keyword">(</span>d1as<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d1as <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d1a<span class="keyword">,</span> d1as<span class="keyword">)</span> <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>d1atarg_tr d1a<span class="keyword">,</span> d1atarglst_tr d1as<span class="keyword">)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d1atarglst_tr]
</span>
<span class="keyword">fn</span> s1tacon_tr <span class="keyword">(</span>
  s2t_res<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> d<span class="keyword">:</span> <span class="staexp">s1tacon</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> id <span class="keyword">=</span> d<span class="keyword">.</span>s1tacon_sym
  <span class="keyword">val</span> loc <span class="keyword">=</span> d<span class="keyword">.</span>s1tacon_loc
  <span class="keyword">val</span> argvar <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d<span class="keyword">.</span>s1tacon_arg <span class="keyword">of</span>
    <span class="keyword">|</span> Some d1as <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>d1atarglst_tr d1as<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option <span class="keyword">(</span>List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> s2t_fun <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> argvar <span class="keyword">of</span>
    <span class="keyword">|</span> Some xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2rtlst</span> <span class="keyword">=</span>
          <span class="keyword">case+</span> xs <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> cons <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">,</span> aux xs<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> s2ts_arg <span class="keyword">=</span> aux xs
      <span class="keyword">in</span>
        s2rt_fun <span class="keyword">(</span>s2ts_arg<span class="keyword">,</span> s2t_res<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> None <span class="keyword">=&gt;</span> s2t_res
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2vs_opt <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">let</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>
      xs<span class="keyword">:</span> <span class="staexp">List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span></span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span>
      <span class="keyword">case+</span> xs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2v <span class="keyword">=</span> <span class="keyword">case+</span> x<span class="keyword">.</span>0 <span class="keyword">of</span>
            <span class="keyword">|</span> Some id <span class="keyword">=&gt;</span> s2var_make_id_srt <span class="keyword">(</span>id<span class="keyword">,</span> x<span class="keyword">.</span>1<span class="keyword">)</span>
            <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2var_make_srt <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">)</span>
        <span class="keyword">in</span>
          the_s2expenv_add_svar s2v<span class="keyword">;</span> cons <span class="keyword">(</span>s2v<span class="keyword">,</span> aux xs<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="comment">// end of [aux]
</span>  <span class="keyword">in</span>
    <span class="keyword">case+</span> argvar <span class="keyword">of</span> Some xs <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>aux xs<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span><span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option <span class="keyword">(</span>s2varlst<span class="keyword">)</span></span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> def <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> d<span class="keyword">.</span>s1tacon_def <span class="keyword">of</span>
    <span class="keyword">|</span> Some s1e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e <span class="keyword">=</span> s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t_res<span class="keyword">)</span>
        <span class="keyword">val</span> s2e_def <span class="keyword">=</span> <span class="keyword">case+</span> s2vs_opt <span class="keyword">of</span>
          <span class="keyword">|</span> Some s2vs <span class="keyword">=&gt;</span> s2exp_lam_srt <span class="keyword">(</span>s2t_fun<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">=&gt;</span> s2e
        <span class="comment">// end of [s2e_def]
</span>      <span class="keyword">in</span>
        Some s2e_def
      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2c <span class="keyword">=</span> s2cst_make <span class="keyword">(</span>
      id <span class="comment">// sym
</span>    <span class="keyword">,</span> loc <span class="comment">// location
</span>    <span class="keyword">,</span> s2t_fun <span class="comment">// srt
</span>    <span class="keyword">,</span> Some def <span class="comment">// isabs
</span>    <span class="keyword">,</span> true <span class="comment">// iscon
</span>    <span class="keyword">,</span> false <span class="comment">// isrec
</span>    <span class="keyword">,</span> false <span class="comment">// isasp
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// islst
</span>    <span class="keyword">,</span> argvar <span class="comment">// argvar
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// def
</span>    <span class="keyword">)</span> <span class="comment">// end of [s2cst_make]
</span>  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  the_s2expenv_add_scst s2c
<span class="keyword">end</span> <span class="comment">// end of [s1tacon_tr]
</span>
<span class="keyword">implement</span>
s1taconlst_tr <span class="keyword">(</span>absknd<span class="keyword">,</span> ds<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    s2t<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> ds<span class="keyword">:</span> <span class="staexp">s1taconlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> ds <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>d<span class="keyword">,</span> ds<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>s1tacon_tr <span class="keyword">(</span>s2t<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>s2t<span class="keyword">,</span> ds<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> s2t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> absknd <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDprop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_prop
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDtype <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_type
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDt0ype <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_t0ype
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDview <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_view
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDviewtype <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_viewtype
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>ABSKINDviewt0ype <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2rt_viewt0ype
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>s2t<span class="keyword">,</span> ds<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1taconlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1tacst_tr
  <span class="keyword">(</span>d<span class="keyword">:</span> <span class="staexp">s1tacst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> id <span class="keyword">=</span> d<span class="keyword">.</span>s1tacst_sym
  <span class="keyword">val</span> loc <span class="keyword">=</span> d<span class="keyword">.</span>s1tacst_loc
  <span class="keyword">val</span> s2t_res <span class="keyword">=</span> s1rt_tr <span class="keyword">(</span>d<span class="keyword">.</span>s1tacst_res<span class="keyword">)</span>
  <span class="keyword">val</span> s2t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d<span class="keyword">.</span>s1tacst_arg <span class="keyword">of</span>
    <span class="keyword">|</span> Some s1ts <span class="keyword">=&gt;</span> s2rt_fun <span class="keyword">(</span>s1rtlst_tr s1ts<span class="keyword">,</span> s2t_res<span class="keyword">)</span>
    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2t_res
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> s2c <span class="keyword">=</span> s2cst_make <span class="keyword">(</span>
      id <span class="comment">// sym
</span>    <span class="keyword">,</span> loc <span class="comment">// location
</span>    <span class="keyword">,</span> s2t <span class="comment">// srt
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// isabs
</span>    <span class="keyword">,</span> false <span class="comment">// iscon
</span>    <span class="keyword">,</span> false <span class="comment">// isrec
</span>    <span class="keyword">,</span> false <span class="comment">// isasp
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// islst
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// argvar
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// def
</span>  <span class="keyword">)</span> <span class="comment">// end of [s2cst_make]
</span><span class="keyword">in</span>
  the_s2expenv_add_scst s2c
<span class="keyword">end</span> <span class="comment">// end of [s1tacst_tr]
</span>
<span class="keyword">implement</span>
s1tacstlst_tr <span class="keyword">(</span>ds<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ds <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d<span class="keyword">,</span> ds<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>s1tacst_tr d<span class="keyword">;</span> s1tacstlst_tr ds<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1tacstlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s1tavar_tr
  <span class="keyword">(</span>d<span class="keyword">:</span> <span class="staexp">s1tavar</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2tavar</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t <span class="keyword">=</span> s1rt_tr <span class="keyword">(</span>d<span class="keyword">.</span>s1tavar_srt<span class="keyword">)</span>
  <span class="keyword">val</span> s2v <span class="keyword">=</span> s2var_make_id_srt <span class="keyword">(</span>d<span class="keyword">.</span>s1tavar_sym<span class="keyword">,</span> s2t<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_svar s2v
<span class="keyword">in</span>
  s2tavar_make <span class="keyword">(</span>d<span class="keyword">.</span>s1tavar_loc<span class="keyword">,</span> s2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1tavar_tr]
</span>
<span class="keyword">implement</span>
s1tavarlst_tr <span class="keyword">(</span>ds<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>ds<span class="keyword">,</span> s1tavar_tr<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d1atsrtdec_tr <span class="keyword">(</span>
  res<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> d1c<span class="keyword">:</span> <span class="staexp">d1atsrtdec</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2cstlst</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fn</span> aux <span class="keyword">(</span>
    i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> d1c<span class="keyword">:</span> <span class="staexp">d1atsrtcon</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2cst_t</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> id <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atsrtcon_sym
    <span class="keyword">val</span> loc <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atsrtcon_loc
    <span class="keyword">val</span> arg <span class="keyword">=</span> s1rtlst_tr d1c<span class="keyword">.</span>d1atsrtcon_arg
    <span class="keyword">val</span> s2t <span class="keyword">=</span> s2rt_fun <span class="keyword">(</span>arg<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">val</span> s2c <span class="keyword">=</span> s2cst_make <span class="keyword">(</span>
      id <span class="comment">// sym
</span>    <span class="keyword">,</span> loc <span class="comment">// location
</span>    <span class="keyword">,</span> s2t <span class="comment">// srt
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// isabs
</span>    <span class="keyword">,</span> true <span class="comment">// iscon
</span>    <span class="keyword">,</span> false <span class="comment">// isrec
</span>    <span class="keyword">,</span> false <span class="comment">// isasp
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// islst
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// argvar
</span>    <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// def
</span>    <span class="keyword">)</span> <span class="comment">// end of [s2cst_make]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2cst_tag_set <span class="keyword">(</span>s2c<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">in</span>
    the_s2expenv_add_scst s2c<span class="keyword">;</span> s2c
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> auxlst <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> d1cs<span class="keyword">:</span> <span class="staexp">d1atsrtconlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2cstlst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        S2CSTLSTcons <span class="keyword">(</span>aux <span class="keyword">(</span>i<span class="keyword">,</span> res<span class="keyword">,</span> d1c<span class="keyword">)</span><span class="keyword">,</span> auxlst <span class="keyword">(</span>i+1<span class="keyword">,</span> res<span class="keyword">,</span> d1cs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [auxlst]
</span><span class="comment">//
</span><span class="keyword">in</span>
  auxlst <span class="keyword">(</span>0<span class="keyword">,</span> res<span class="keyword">,</span> d1c<span class="keyword">.</span>d1atsrtdec_con<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d1atsrtdec_tr]
</span>
<span class="keyword">implement</span>
d1atsrtdeclst_tr <span class="keyword">(</span>d1cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="61278"><span class="stacstdec">VT <span class="keyword">=</span> List_vt <span class="keyword">@(</span>d1atsrtdec<span class="keyword">,</span> s2rtdat_t<span class="keyword">,</span> s2rt<span class="keyword">)</span></span></a></span>
<span class="comment">//
</span>  <span class="keyword">fun</span> loop1 <span class="keyword">(</span>xs0<span class="keyword">:</span> <span class="staexp">VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs0 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2cs <span class="keyword">=</span> d1atsrtdec_tr <span class="keyword">(</span>x<span class="keyword">.</span>2<span class="keyword">,</span> x<span class="keyword">.</span>0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2rtdat_conlst_set <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">,</span> s2cs<span class="keyword">)</span>
      <span class="keyword">in</span>
        loop1 xs
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop1]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> loop2 <span class="keyword">(</span>
    d1cs<span class="keyword">:</span> <span class="staexp">d1atsrtdeclst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">VT</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> id <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atsrtdec_sym
        <span class="keyword">val</span> loc <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atsrtdec_loc
        <span class="keyword">val</span> s2td <span class="keyword">=</span> s2rtdat_make id
        <span class="keyword">val</span> s2t <span class="keyword">=</span> S2RTbas <span class="keyword">(</span>S2RTBASdef s2td<span class="keyword">)</span>
        <span class="keyword">val</span> s2t_eq <span class="keyword">=</span> s2rt_fun <span class="keyword">(</span><span class="keyword">'[</span>s2t<span class="keyword">,</span> s2t<span class="keyword">]</span><span class="keyword">,</span> s2rt_bool<span class="keyword">)</span>
        <span class="keyword">val</span> s2c_eq <span class="keyword">=</span> s2cst_make <span class="keyword">(</span>
          $Sym<span class="keyword">.</span>symbol_EQEQ <span class="comment">// sym
</span>        <span class="keyword">,</span> loc <span class="comment">// location
</span>        <span class="keyword">,</span> s2t_eq <span class="comment">// srt
</span>        <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// isabs
</span>        <span class="keyword">,</span> false <span class="comment">// iscon
</span>        <span class="keyword">,</span> false <span class="comment">// isrec
</span>        <span class="keyword">,</span> false <span class="comment">// isasp
</span>        <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// islst
</span>        <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// argvar 
</span>        <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// def
</span>        <span class="keyword">)</span> <span class="comment">// end of [val]
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_scst s2c_eq
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2rtenv_add <span class="keyword">(</span>id<span class="keyword">,</span> S2TEsrt s2t<span class="keyword">)</span>
      <span class="keyword">in</span>
        loop2 <span class="keyword">(</span>d1cs<span class="keyword">,</span> list_vt_cons <span class="keyword">(</span><span class="keyword">@(</span>d1c<span class="keyword">,</span> s2td<span class="keyword">,</span> s2t<span class="keyword">)</span><span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> loop1 res
  <span class="comment">// end of [loop2]
</span><span class="comment">//
</span><span class="keyword">in</span>
  loop2 <span class="keyword">(</span>d1cs<span class="keyword">,</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d1atsrtdeclst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s1expdef_s1aspdec_tr_main <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
<span class="keyword">,</span> s1ass<span class="keyword">:</span> <span class="staexp">s1arglstlst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">s2rtopt</span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">s1exp</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span> 
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2vss <span class="keyword">=</span> <span class="keyword">(</span>s1arglstlst_var_tr s1ass<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2varlstlst</span>
  <span class="keyword">val</span> body <span class="keyword">=</span> <span class="keyword">case+</span> res <span class="keyword">of</span>
    <span class="keyword">|</span> Some s2t <span class="keyword">=&gt;</span> s1exp_tr_dn <span class="keyword">(</span>body<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s1exp_tr_up body
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    body<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> s2vss<span class="keyword">:</span> <span class="staexp">s2varlstlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2vss <span class="keyword">of</span>
    <span class="keyword">|</span> s2vs :: s2vss <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> body <span class="keyword">=</span> aux <span class="keyword">(</span>body<span class="keyword">,</span> s2vss<span class="keyword">)</span>
        <span class="keyword">val</span> s2ts_arg <span class="keyword">=</span> s2rtlst_of_s2varlst s2vs
        <span class="keyword">val</span> s2t_fun <span class="keyword">=</span> s2rt_fun <span class="keyword">(</span>s2ts_arg<span class="keyword">,</span> body<span class="keyword">.</span>s2exp_srt<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_lam_srt <span class="keyword">(</span>s2t_fun<span class="keyword">,</span> s2vs<span class="keyword">,</span> body<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> body
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="comment">//
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>body<span class="keyword">,</span> s2vss<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1expdef_s1aspdec_tr_main]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1expdef_tr <span class="keyword">(</span>res<span class="keyword">,</span> d1c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> err <span class="keyword">(</span>d1c<span class="keyword">:</span> <span class="staexp">s1expdef</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 d1c<span class="keyword">.</span>s1expdef_loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1expdef_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the sort for the definition does not match"<span class="keyword">;</span>
    prerr " the sort assigned to the static constant ["<span class="keyword">;</span>
    $Sym<span class="keyword">.</span>prerr_symbol d1c<span class="keyword">.</span>s1expdef_sym<span class="keyword">;</span>
    prerr "]."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span>  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d1c<span class="keyword">.</span>s1expdef_res <span class="keyword">of</span>
    <span class="keyword">|</span> Some s1t <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2t1 <span class="keyword">=</span> s1rt_tr s1t<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> res <span class="keyword">of</span>
          <span class="keyword">|</span> Some s2t <span class="keyword">=&gt;</span> <span class="keyword">if</span> <span class="keyword">(</span>s2t1 &lt;= s2t<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> err <span class="keyword">(</span>d1c<span class="keyword">)</span>
          <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        Some s2t1
      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rtopt</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s1expdef_s1aspdec_tr_main
    <span class="keyword">(</span>d1c<span class="keyword">.</span>s1expdef_loc<span class="keyword">,</span> d1c<span class="keyword">.</span>s1expdef_arg<span class="keyword">,</span> res<span class="keyword">,</span> d1c<span class="keyword">.</span>s1expdef_def<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  s2cst_make <span class="keyword">(</span>
    d1c<span class="keyword">.</span>s1expdef_sym <span class="comment">// symbol
</span>  <span class="keyword">,</span> d1c<span class="keyword">.</span>s1expdef_loc <span class="comment">// location
</span>  <span class="keyword">,</span> s2e<span class="keyword">.</span>s2exp_srt <span class="comment">// srt
</span>  <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// isabs
</span>  <span class="keyword">,</span> false <span class="comment">// iscon
</span>  <span class="keyword">,</span> false <span class="comment">// isrec
</span>  <span class="keyword">,</span> false <span class="comment">// isasp
</span>  <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// islst
</span>  <span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// argvar
</span>  <span class="keyword">,</span> Some s2e <span class="comment">// def
</span>  <span class="keyword">)</span> <span class="comment">// end of [s2cst_make]
</span><span class="keyword">end</span> <span class="comment">// end of [s1expdef_tr]
</span>
<span class="keyword">implement</span>
s1expdeflst_tr <span class="keyword">(</span>res<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2cs <span class="keyword">=</span> aux <span class="keyword">(</span>res<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux
      <span class="keyword">(</span>res<span class="keyword">:</span> <span class="staexp">s2rtopt</span><span class="keyword">,</span> d1cs<span class="keyword">:</span> <span class="staexp">s1expdeflst</span><span class="keyword">)</span>
      <span class="keyword">:</span> <span class="staexp">List_vt <span class="keyword">(</span>s2cst_t<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2c <span class="keyword">=</span> s1expdef_tr <span class="keyword">(</span>res<span class="keyword">,</span> d1c<span class="keyword">)</span>
        <span class="keyword">in</span>
          list_vt_cons <span class="keyword">(</span>s2c<span class="keyword">,</span> aux <span class="keyword">(</span>res<span class="keyword">,</span> d1cs<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="comment">// end of [aux]
</span>  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux s2cs <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>s2cs<span class="keyword">:</span> <span class="staexp">List_vt s2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
      <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>s2c<span class="keyword">,</span> s2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_scst s2c <span class="keyword">in</span> aux s2cs
        <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>      <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="comment">// end of [aux]
</span>  <span class="keyword">}</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [s1expdeflst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s1aspdec_tr <span class="keyword">(</span>d1c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> err1
    <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">,</span>
     s2t_s2c<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> s2t_s2e<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2aspdec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1aspdec_tr: err1"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": sort mismatch"<span class="keyword">;</span>
    prerr ": the sort of the static constant ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] is ["<span class="keyword">;</span>
    prerr s2t_s2c<span class="keyword">;</span>
    prerr "] while the sort of its definition is ["<span class="keyword">;</span>
    prerr s2t_s2e<span class="keyword">;</span>
    prerr "]."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2aspdec<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err1]
</span>
  <span class="keyword">fn</span> err2 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2aspdec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1aspdec_tr: err2"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static constant ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] is not abstract."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2aspdec<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err2]
</span>
  <span class="keyword">fn</span> err3 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2aspdec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1aspdec_tr: err2"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the static constant referred to by ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] cannot be uniquely resolved."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2aspdec<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err3]
</span>
  <span class="keyword">fn</span> err4 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2aspdec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1aspdec_tr: err4"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] does not refer to a static constant."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2aspdec<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err4]
</span>
  <span class="keyword">fn</span> err5 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> q<span class="keyword">:</span> <span class="staexp">$Syn<span class="keyword">.</span>s0taq</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2aspdec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s1aspdec_tr: err5"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the identifier ["<span class="keyword">;</span>
    $Syn<span class="keyword">.</span>prerr_s0taq q<span class="keyword">;</span> $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span>
    prerr "] is unrecognized."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2aspdec<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err5]
</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d1c<span class="keyword">.</span>s1aspdec_loc
  <span class="keyword">val</span> qid <span class="keyword">=</span> d1c<span class="keyword">.</span>s1aspdec_qid
  <span class="keyword">val</span> q <span class="keyword">=</span> qid<span class="keyword">.</span>sqi0de_qua <span class="keyword">and</span> id <span class="keyword">=</span> qid<span class="keyword">.</span>sqi0de_sym
  <span class="keyword">val</span> os2i <span class="keyword">=</span> the_s2expenv_find_qua <span class="keyword">(</span>q<span class="keyword">,</span> id<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> os2i <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2i <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2i <span class="keyword">of</span>
    <span class="keyword">|</span> S2ITEMcst s2cs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2cs <span class="keyword">=</span> filter s2cs <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">fun</span> filter <span class="keyword">(</span>s2cs<span class="keyword">:</span> <span class="staexp">s2cstlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2cstlst</span> <span class="keyword">=</span>
            <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
            <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> s2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              <span class="keyword">case+</span> 0 <span class="keyword">of</span>
              <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_abstract s2c <span class="keyword">=&gt;</span>
                  S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> filter s2cs<span class="keyword">)</span>
              <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> filter s2cs
              <span class="keyword">end</span> <span class="comment">// end of [S2CSTLSTcons]
</span>            <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">}</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        <span class="keyword">case+</span> s2cs <span class="keyword">of</span>
        <span class="keyword">|</span> S2CSTLSTcons <span class="keyword">(</span>s2c<span class="keyword">,</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> res <span class="keyword">=</span> s1rtopt_tr d1c<span class="keyword">.</span>s1aspdec_res
            <span class="keyword">val</span> s2e <span class="keyword">=</span> s1expdef_s1aspdec_tr_main
              <span class="keyword">(</span>loc<span class="keyword">,</span> d1c<span class="keyword">.</span>s1aspdec_arg<span class="keyword">,</span> res<span class="keyword">,</span> d1c<span class="keyword">.</span>s1aspdec_def<span class="keyword">)</span>
<span class="comment">(*
            // definition binding is to be done in [ats_trans3_dec.dats]
*)</span>
            <span class="keyword">val</span> s2t_s2e <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
            <span class="keyword">val</span> s2t_s2c <span class="keyword">=</span> s2cst_srt_get s2c
          <span class="keyword">in</span>
            <span class="keyword">if</span> s2t_s2e &lt;= s2t_s2c <span class="keyword">then</span> <span class="keyword">begin</span>
              s2aspdec_make <span class="keyword">(</span>loc<span class="keyword">,</span> s2c<span class="keyword">,</span> s2e<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
              err1 <span class="keyword">(</span>loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">,</span> s2t_s2c<span class="keyword">,</span> s2t_s2e<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [if]
</span>          <span class="keyword">end</span>
        <span class="keyword">|</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            err2 <span class="keyword">(</span>loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span> <span class="comment">// [s2c] is not abstract!
</span>          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err3 <span class="keyword">(</span>loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2ITEMcst]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err4 <span class="keyword">(</span>loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err5 <span class="keyword">(</span>loc<span class="keyword">,</span> q<span class="keyword">,</span> id<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s1aspdec_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d1atcon_tr <span class="keyword">(</span>
    s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span>
  <span class="keyword">,</span> islin<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> isprf<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> s2vs0<span class="keyword">:</span> <span class="staexp">s2varlst</span>
  <span class="keyword">,</span> fil<span class="keyword">:</span> <span class="staexp">fil_t</span>
  <span class="keyword">,</span> d1c<span class="keyword">:</span> <span class="staexp">d1atcon</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">d2con_t</span> <span class="keyword">=</span> <span class="keyword">let</span>

  <span class="keyword">fn</span> err1 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explstopt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    prerr ": less indexes are needed for the constructor ["<span class="keyword">;</span>
    $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "]"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2explstopt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err1]
</span>
  <span class="keyword">fn</span> err2 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explstopt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    prerr ": more indexes are needed for the constructor ["<span class="keyword">;</span>
    $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "]"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2explstopt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err2]
</span>
  <span class="keyword">fn</span> err3 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explstopt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    prerr ": no indexes are needed for the constructor ["<span class="keyword">;</span>
    $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "]"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2explstopt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err3]
</span>
  <span class="keyword">fn</span> err4 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> id<span class="keyword">:</span> <span class="staexp">sym_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explstopt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error2 loc<span class="keyword">;</span>
    prerr ": some indexes are needed for the constructor ["<span class="keyword">;</span>
    $Sym<span class="keyword">.</span>prerr_symbol id<span class="keyword">;</span> prerr "]"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2explstopt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err4]
</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atcon_loc <span class="keyword">and</span> id <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atcon_sym
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_svarlst s2vs0
  <span class="keyword">var</span> s2vpslst<span class="keyword">:</span> <span class="staexp">s2qualst</span> <span class="keyword">=</span> s1qualstlst_tr <span class="keyword">(</span>d1c<span class="keyword">.</span>d1atcon_qua<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2vs0 <span class="keyword">of</span>
    <span class="keyword">|</span> cons _ <span class="keyword">=&gt;</span> s2vpslst := cons <span class="keyword">(</span><span class="keyword">@(</span>s2vs0<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> s2vpslst<span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">var</span> os2ts_s2c_ind<span class="keyword">:</span> <span class="staexp">s2rtlstopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2cst_srt_get s2c <span class="keyword">of</span>
    <span class="keyword">|</span> S2RTfun <span class="keyword">(</span>s2ts<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>os2ts_s2c_ind := Some s2ts<span class="keyword">)</span> <span class="keyword">|</span> s2t <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> npf <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atcon_npf <span class="keyword">and</span> s1es_arg <span class="keyword">=</span> d1c<span class="keyword">.</span>d1atcon_arg
  <span class="keyword">val</span> s2es_arg <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> s2t_pfarg <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> islin <span class="keyword">then</span> s2rt_view <span class="keyword">else</span> s2rt_prop
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span>
    <span class="keyword">val</span> s2t_arg <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> isprf <span class="keyword">then</span> s2t_pfarg <span class="keyword">else</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> islin <span class="keyword">then</span> s2rt_viewt0ype <span class="keyword">else</span> s2rt_t0ype
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s1es<span class="keyword">:</span> <span class="staexp">s1explst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> s1es <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>s1e<span class="keyword">,</span> s1es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> i <span class="keyword">&lt;</span> npf <span class="keyword">then</span> s2t_pfarg <span class="keyword">else</span> s2t_arg<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2rt</span>
        <span class="keyword">in</span>
          cons <span class="keyword">(</span>s1exp_tr_dn <span class="keyword">(</span>s1e<span class="keyword">,</span> s2t<span class="keyword">)</span><span class="keyword">,</span> aux <span class="keyword">(</span>i+1<span class="keyword">,</span> s1es<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [nil]
</span>    <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">in</span>
    aux <span class="keyword">(</span>0<span class="keyword">,</span> s1es_arg<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> os2ts_s2c_ind <span class="keyword">=</span> <span class="keyword">(</span>os2ts_s2c_ind<span class="keyword">:</span> <span class="staexp">s2rtlstopt</span><span class="keyword">)</span>
  <span class="keyword">val</span> os2es_ind <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> <span class="keyword">(</span>d1c<span class="keyword">.</span>d1atcon_ind<span class="keyword">,</span> os2ts_s2c_ind<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>Some s1es<span class="keyword">,</span> Some s2ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> n1 <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length <span class="keyword">(</span>s1es<span class="keyword">)</span>
        <span class="keyword">and</span> n2 <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_length <span class="keyword">(</span>s2ts<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">case+</span> compare <span class="keyword">(</span>n1<span class="keyword">,</span> n2<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> 0 <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>s1explst_tr_dn <span class="keyword">(</span>s1es<span class="keyword">,</span> s2ts<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">|</span> 1 <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>loc<span class="keyword">,</span> id<span class="keyword">)</span>
        <span class="keyword">|</span> _ <span class="comment">(*~1*)</span> <span class="keyword">=&gt;</span> err2 <span class="keyword">(</span>loc<span class="keyword">,</span> id<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">(</span>None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">(</span>Some _<span class="keyword">,</span> None _<span class="keyword">)</span> <span class="keyword">=&gt;</span> err3 <span class="keyword">(</span>loc<span class="keyword">,</span> id<span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">(</span>None _<span class="keyword">,</span> Some _<span class="keyword">)</span> <span class="keyword">=&gt;</span> err4 <span class="keyword">(</span>loc<span class="keyword">,</span> id<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2explstopt</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
  <span class="keyword">val</span> vwtp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> isprf <span class="keyword">then</span> 0 <span class="keyword">else</span> <span class="keyword">if</span> islin <span class="keyword">then</span> 1 <span class="keyword">else</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">val</span> d2c <span class="keyword">=</span> d2con_make
    <span class="keyword">(</span>loc<span class="keyword">,</span> fil<span class="keyword">,</span> id<span class="keyword">,</span> s2c<span class="keyword">,</span> vwtp<span class="keyword">,</span> s2vpslst<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> os2es_ind<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_d2expenv_add_dcon d2c<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> isprf <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_datcontyp d2c <span class="comment">// struct
</span>    <span class="keyword">in</span>
      <span class="keyword">if</span> islin <span class="keyword">then</span> the_s2expenv_add_datconptr d2c <span class="comment">// unfold
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  d2c
<span class="keyword">end</span> <span class="comment">// end of [d1atcon_tr]
</span>
<span class="keyword">fun</span> d1atconlst_tr <span class="keyword">(</span>
    s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span>
  <span class="keyword">,</span> islin<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> isprf<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> s2vs0<span class="keyword">:</span> <span class="staexp">s2varlst</span>
  <span class="keyword">,</span> fil<span class="keyword">:</span> <span class="staexp">fil_t</span>
  <span class="keyword">,</span> d1cs<span class="keyword">:</span> <span class="staexp">d1atconlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">d2conlst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> d2c <span class="keyword">=</span> d1atcon_tr <span class="keyword">(</span>s2c<span class="keyword">,</span> islin<span class="keyword">,</span> isprf<span class="keyword">,</span> s2vs0<span class="keyword">,</span> fil<span class="keyword">,</span> d1c<span class="keyword">)</span>
    <span class="keyword">in</span>
      D2CONLSTcons <span class="keyword">(</span>d2c<span class="keyword">,</span> d1atconlst_tr <span class="keyword">(</span>s2c<span class="keyword">,</span> islin<span class="keyword">,</span> isprf<span class="keyword">,</span> s2vs0<span class="keyword">,</span> fil<span class="keyword">,</span> d1cs<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [nil]
</span><span class="keyword">end</span> <span class="comment">// end of [d1atconlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d1atdec_tr <span class="keyword">(</span>
  s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span><span class="keyword">,</span> s2vs0<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">,</span> d1c<span class="keyword">:</span> <span class="staexp">d1atdec</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t_s2c <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2cst_srt_get s2c <span class="keyword">of</span> S2RTfun <span class="keyword">(</span>s2ts<span class="keyword">,</span> s2t<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2t <span class="keyword">|</span> s2t <span class="keyword">=&gt;</span> s2t
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> islin <span class="keyword">=</span> s2rt_is_linear s2t_s2c <span class="keyword">and</span> isprf <span class="keyword">=</span> s2rt_is_proof s2t_s2c
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> d1atconlst_tr
    <span class="keyword">(</span>s2c<span class="keyword">,</span> islin<span class="keyword">,</span> isprf<span class="keyword">,</span> s2vs0<span class="keyword">,</span> d1c<span class="keyword">.</span>d1atdec_fil<span class="keyword">,</span> d1c<span class="keyword">.</span>d1atdec_con<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span> <span class="comment">// assigning tags to dynamic constructors
</span>    <span class="keyword">fun</span> aux <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> d2cs<span class="keyword">:</span> <span class="staexp">d2conlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> d2cs <span class="keyword">of</span>
      <span class="keyword">|</span> D2CONLSTcons <span class="keyword">(</span>d2c<span class="keyword">,</span> d2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>d2con_tag_set <span class="keyword">(</span>d2c<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>i+1<span class="keyword">,</span> d2cs<span class="keyword">)</span><span class="keyword">)</span>
        <span class="comment">// end of [D2CONLSTcons]
</span>      <span class="keyword">|</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="comment">// end of [aux]
</span>  <span class="keyword">in</span>
    aux <span class="keyword">(</span>0<span class="keyword">,</span> d2cs<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> islst <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d2cs <span class="keyword">of</span>
    <span class="keyword">|</span> D2CONLSTcons <span class="keyword">(</span>d2c1<span class="keyword">,</span> D2CONLSTcons <span class="keyword">(</span>d2c2<span class="keyword">,</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> d2con_arity_real_get d2c1 <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d2con_arity_real_get d2c2 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> Some <span class="keyword">@(</span>d2c1<span class="keyword">,</span> d2c2<span class="keyword">)</span>
          <span class="keyword">else</span> None <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d2con_arity_real_get d2c2 <span class="keyword">=</span> 0 <span class="keyword">then</span> Some <span class="keyword">@(</span>d2c2<span class="keyword">,</span> d2c1<span class="keyword">)</span>
          <span class="keyword">else</span> None <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="comment">// end of [D2CONLSTcons (_, D2CONSLSTcons (_, D2CONLSTnil))
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option <span class="keyword">@(</span>d2con_t<span class="keyword">,</span> d2con_t<span class="keyword">)</span></span>
<span class="keyword">in</span>
  s2cst_islst_set <span class="keyword">(</span>s2c<span class="keyword">,</span> islst<span class="keyword">)</span><span class="keyword">;</span> s2cst_conlst_set <span class="keyword">(</span>s2c<span class="keyword">,</span> Some d2cs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d1atdec_tr]
</span>
<span class="keyword">implement</span>
d1atdeclst_tr <span class="keyword">(</span>
  datknd<span class="keyword">,</span> d1cs_dat<span class="keyword">,</span> d1cs_def
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">val</span> s2t_res <span class="keyword">=</span> s2rt_datakind datknd
  <span class="keyword">typedef</span> <span class="staexp"><a name="74187"><span class="stacstdec">T <span class="keyword">=</span> List <span class="keyword">@(</span>d1atdec<span class="keyword">,</span> s2cst_t<span class="keyword">,</span> s2varlst<span class="keyword">)</span></span></a></span>
<span class="comment">//
</span>  <span class="keyword">val</span> d1cs2cs2vslst <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>    <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">T</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span>    <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">.&lt;&gt;.</span></span> <span class="keyword">(</span>
      d1c<span class="keyword">:</span> <span class="staexp">d1atdec</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>T</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">val</span> argvar <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> d1c<span class="keyword">.</span>d1atdec_arg <span class="keyword">of</span>
        <span class="keyword">|</span> Some d1as <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>d1atarglst_tr d1as<span class="keyword">)</span>
        <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span> 
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">Option <span class="keyword">(</span>List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span><span class="keyword">)</span></span>
      <span class="keyword">val</span> s2vs <span class="keyword">=</span> <span class="keyword">let</span>
        <span class="keyword">fun</span> aux
          <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span>
          <span class="keyword">case+</span> xs <span class="keyword">of</span>
          <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> x<span class="keyword">.</span>0 <span class="keyword">of</span>
            <span class="keyword">|</span> Some id <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                list_cons <span class="keyword">(</span>s2var_make_id_srt <span class="keyword">(</span>id<span class="keyword">,</span> x<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">,</span> aux xs<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>            <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux xs
            <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>          <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
        <span class="comment">// end of [aux]
</span>      <span class="keyword">in</span>
        <span class="keyword">case+</span> argvar <span class="keyword">of</span> Some xs <span class="keyword">=&gt;</span> aux xs <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">s2varlst</span>
<span class="comment">//
</span>      <span class="keyword">val</span> os2ts_arg <span class="keyword">=</span> <span class="keyword">let</span>
        <span class="keyword">fun</span> aux
          <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">List <span class="keyword">@(</span>symopt_t<span class="keyword">,</span> s2rt<span class="keyword">,</span> int<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2rtlst</span> <span class="keyword">=</span>
          <span class="keyword">case+</span> xs <span class="keyword">of</span>
          <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> list_cons <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">,</span> aux xs<span class="keyword">)</span>
          <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
        <span class="comment">// end of [aux]
</span>      <span class="keyword">in</span>
        <span class="keyword">case+</span> argvar <span class="keyword">of</span> Some xs <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>aux xs<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">s2rtlstopt</span>
<span class="comment">//
</span>      <span class="keyword">val</span> s2c <span class="keyword">=</span> s2cst_make_dat <span class="keyword">(</span>
        d1c<span class="keyword">.</span>d1atdec_sym<span class="keyword">,</span> d1c<span class="keyword">.</span>d1atdec_loc<span class="keyword">,</span> os2ts_arg<span class="keyword">,</span> s2t_res<span class="keyword">,</span> argvar
      <span class="keyword">)</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_scst s2c
<span class="comment">//
</span>    <span class="keyword">in</span>
      res := cons <span class="keyword">(</span><span class="keyword">@(</span>d1c<span class="keyword">,</span> s2c<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>    <span class="keyword">fun</span> auxlst <span class="keyword">(</span>
      d1cs<span class="keyword">:</span> <span class="staexp">d1atdeclst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>T</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>aux <span class="keyword">(</span>d1c<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> auxlst <span class="keyword">(</span>d1cs<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="comment">// end of [auxlst]
</span><span class="comment">//
</span>  <span class="keyword">in</span>
    auxlst <span class="keyword">(</span>d1cs_dat<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">T</span> <span class="comment">// end of [d1cs2cs2vslst]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>d1cs_def<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>
      d1cs<span class="keyword">:</span> <span class="staexp">s1expdeflst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2c <span class="keyword">=</span> s1expdef_tr <span class="keyword">(</span>None<span class="keyword">,</span> d1c<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_add_scst <span class="keyword">(</span>s2c<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux <span class="keyword">(</span>d1cs<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [aux] *)</span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> aux <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">T</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2cstlst</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        d1atdec_tr <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">,</span> x<span class="keyword">.</span>2<span class="keyword">,</span> x<span class="keyword">.</span>0<span class="keyword">)</span><span class="keyword">;</span> S2CSTLSTcons <span class="keyword">(</span>x<span class="keyword">.</span>1<span class="keyword">,</span> aux xs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> S2CSTLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>d1cs2cs2vslst<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d1atdeclst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* [exn] is considered a viewtype constructor *)</span>
<span class="keyword">fn</span> e1xndec_tr
  <span class="keyword">(</span>s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span><span class="keyword">,</span> d1c<span class="keyword">:</span> <span class="staexp">e1xndec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">d2con_t</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d1c<span class="keyword">.</span>e1xndec_loc
  <span class="keyword">val</span> fil <span class="keyword">=</span> d1c<span class="keyword">.</span>e1xndec_fil <span class="keyword">and</span> id <span class="keyword">=</span> d1c<span class="keyword">.</span>e1xndec_sym
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_push <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2vpslst <span class="keyword">=</span> s1qualstlst_tr <span class="keyword">(</span>d1c<span class="keyword">.</span>e1xndec_qua<span class="keyword">)</span>
  <span class="keyword">val</span> npf <span class="keyword">=</span> d1c<span class="keyword">.</span>e1xndec_npf
  <span class="keyword">val</span> s1es_arg <span class="keyword">=</span> d1c<span class="keyword">.</span>e1xndec_arg
  <span class="keyword">val</span> s2es_arg <span class="keyword">=</span> s1explst_tr_dn_viewt0ype s1es_arg
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_s2expenv_pop <span class="keyword">(</span><span class="prfexp">pf_s2expenv</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
  <span class="keyword">val</span> d2c <span class="keyword">=</span> d2con_make
    <span class="keyword">(</span>loc<span class="keyword">,</span> fil<span class="keyword">,</span> id<span class="keyword">,</span> s2c<span class="keyword">,</span> 1<span class="comment">(*vwtp*)</span><span class="keyword">,</span> s2vpslst<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> None<span class="comment">(*ind*)</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2con_tag_set <span class="keyword">(</span>d2c<span class="keyword">,</span> ~1<span class="keyword">)</span>
<span class="keyword">in</span>
  the_d2expenv_add_dcon d2c<span class="keyword">;</span> d2c
<span class="keyword">end</span> <span class="comment">// end of [e1xndec_tr]
</span>
<span class="keyword">fun</span> d2conlst_revapp
  <span class="keyword">(</span>d2cs1<span class="keyword">:</span> <span class="staexp">d2conlst</span><span class="keyword">,</span> d2cs2<span class="keyword">:</span> <span class="staexp">d2conlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">d2conlst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d2cs1 <span class="keyword">of</span>
  <span class="keyword">|</span> D2CONLSTcons <span class="keyword">(</span>d2c1<span class="keyword">,</span> d2cs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      d2conlst_revapp <span class="keyword">(</span>d2cs1<span class="keyword">,</span> D2CONLSTcons <span class="keyword">(</span>d2c1<span class="keyword">,</span> d2cs2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [D2CONLSTcons] *)</span>
  <span class="keyword">|</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> d2cs2
<span class="keyword">end</span> <span class="comment">// end of [d2conlst_revapp]
</span>
<span class="keyword">implement</span>
e1xndeclst_tr <span class="keyword">(</span>d1cs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>s2c<span class="keyword">:</span> <span class="staexp">s2cst_t</span><span class="keyword">,</span> d1cs<span class="keyword">:</span> <span class="staexp">e1xndeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">d2conlst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> d1cs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>d1c<span class="keyword">,</span> d1cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> d2c <span class="keyword">=</span> e1xndec_tr <span class="keyword">(</span>s2c<span class="keyword">,</span> d1c<span class="keyword">)</span>
      <span class="keyword">in</span>
        D2CONLSTcons <span class="keyword">(</span>d2c<span class="keyword">,</span> aux <span class="keyword">(</span>s2c<span class="keyword">,</span> d1cs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> D2CONLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> s2c <span class="keyword">=</span> s2cstref_cst_get <span class="keyword">(</span>Exception_viewtype<span class="keyword">)</span>
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> aux <span class="keyword">(</span>s2c<span class="keyword">,</span> d1cs<span class="keyword">)</span>
  <span class="keyword">val</span> d2cs0 <span class="keyword">=</span> <span class="keyword">case+</span> s2cst_conlst_get s2c <span class="keyword">of</span>
    <span class="keyword">|</span> Some d2cs0 <span class="keyword">=&gt;</span> d2conlst_revapp <span class="keyword">(</span>d2cs<span class="keyword">,</span> d2cs0<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> d2cs
  <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  s2cst_conlst_set <span class="keyword">(</span>s2c<span class="keyword">,</span> Some d2cs0<span class="keyword">)</span><span class="keyword">;</span> d2cs
<span class="keyword">end</span> <span class="comment">// end of [e1xndeclst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_trans2_sta.dats] *)</span>
</pre>
</body>
</html>
