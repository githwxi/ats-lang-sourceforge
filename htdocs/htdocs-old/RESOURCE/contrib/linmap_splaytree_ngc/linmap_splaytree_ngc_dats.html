<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of functional maps based on AVL trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: August, 2009
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** An implementation of singly-linked (top-down) SPLAY trees 
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">sortdef</span> <span class="staexp">t0p <span class="keyword">=</span> t@ype <span class="keyword">and</span> vt0p <span class="keyword">=</span> viewt@ype</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absviewtype</span> <span class="staexp"><A name="491"><span class="stacstdec">map_vt</span></span></A> <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype+<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="555"><span class="stacstdec">cmp <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> Sgn</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">}</span>
  <A name="621"><span class="dyncstdec">compare_key_key <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></A>
<span class="comment">// end of [compare_key_key]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span> compare_key_key <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> cmp <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="801"><span class="dyncstdec">linmap_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="871"><span class="dyncstdec">linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> &gt;&gt; opt <span class="keyword">(</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span><span class="keyword">,</span> tag<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_empty_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="1051"><span class="dyncstdec">linmap_is_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="1132"><span class="dyncstdec">linmap_isnot_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// this is O(n)-time // but hopefully O(log n)-time
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1305"><span class="dyncstdec">linmap_height <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">// this is O(n)-time
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1401"><span class="dyncstdec">linmap_size <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1478"><span class="stacstdec">node <span class="keyword">(</span>
  key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> left<span class="keyword">:</span>addr<span class="keyword">,</span> right<span class="keyword">:</span>addr
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  key<span class="keyword">=</span> key<span class="keyword">,</span> itm<span class="keyword">=</span> itm<span class="keyword">,</span> left<span class="keyword">=</span> ptr left<span class="keyword">,</span> right<span class="keyword">=</span> ptr right
<span class="keyword">}</span></span></span></A> <span class="comment">// end of [node]
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1629"><span class="stacstdec">node <span class="keyword">(</span>
  key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  key<span class="keyword">=</span> key<span class="keyword">,</span> itm<span class="keyword">=</span> itm
<span class="keyword">,</span> left<span class="keyword">=</span> ptr?<span class="keyword">,</span> right<span class="keyword">=</span> ptr?
<span class="keyword">}</span></span></span></A> <span class="comment">// end of [node]
</span>
<span class="keyword">typedef</span>
<span class="staexp"><A name="1745"><span class="stacstdec">node0 <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span>?</span></span></A>
<span class="comment">// end of [node0]
</span>
<span class="keyword">dataview</span>
<span class="prfexp"><span class="staexp"><A name="1824"><span class="stacstdec">tree_v <span class="keyword">(</span>
  key <span class="keyword">:</span> t@ype
<span class="keyword">,</span> itm <span class="keyword">:</span> viewt@ype+
<span class="keyword">,</span> int  <span class="comment">// size
</span><span class="keyword">,</span> addr <span class="comment">// self
</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span> <span class="comment">(* view for singly linked binary trees *)</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    B <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl+nr+1<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<span class="keyword">,</span> lft<span class="keyword">)</span><span class="keyword">,</span> tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nr<span class="keyword">,</span> rgh<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B]
</span>  <span class="keyword">|</span> E <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">,</span> null<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [dataview tree_v]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
  tree_height_get <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> hl <span class="keyword">=</span> tree_height_get <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span>
    <span class="keyword">val</span> hr <span class="keyword">=</span> tree_height_get <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
     <span class="keyword">if</span> hl &gt;= hr <span class="keyword">then</span> 1+hl <span class="keyword">else</span> 1+hr
  <span class="keyword">end</span> <span class="keyword">else</span>
    0 <span class="comment">// the height of empty tree
</span>  <span class="comment">// end of [if]
</span><span class="comment">// end of [tree_height_get]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataview</span>
<span class="prfexp"><span class="staexp"><A name="2717"><span class="stacstdec">ldiff_v <span class="keyword">(</span>
  key <span class="keyword">:</span> t@ype
<span class="keyword">,</span> itm <span class="keyword">:</span> viewt@ype+
<span class="keyword">,</span> int  <span class="comment">// size
</span><span class="keyword">,</span> addr <span class="comment">// the root of missing left child
</span><span class="keyword">,</span> addr <span class="comment">// root
</span><span class="keyword">,</span> addr <span class="comment">// self
</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span> <span class="comment">(* view for a binary tree where a subtree is missing *)</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">rt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    LB1 <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2+1<span class="keyword">,</span> lft<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> slf<span class="keyword">,</span> rt<span class="keyword">,</span> pnt<span class="keyword">)</span><span class="keyword">,</span> tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> rgh<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B]
</span>  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">chld<span class="keyword">:</span>addr</span><span class="keyword">}</span> LE1 <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">,</span> chld<span class="keyword">,</span> chld<span class="keyword">,</span> null<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [dataview ldiff_v]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> ldiff_child_set
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> chld0<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span> &gt;&gt; ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> chld1<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>rt<span class="keyword">:</span>addr<span class="keyword">]</span> ptr rt</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    pt
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">LE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := LE1 <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> pc1
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [ldiff_child_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> ldiff_tree_join
  <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> 
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> chld0<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span><span class="keyword">prfun</span> <span class="prfexp">lemma_ldiff_tree_join
  <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    fpf<span class="keyword">:</span> <span class="staexp">ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> chld<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span><span class="keyword">,</span> pf0<span class="keyword">:</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> chld<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2<span class="keyword">,</span> rt<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> fpf <span class="keyword">of</span>
  <span class="keyword">|</span> LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma_ldiff_tree_join <span class="keyword">(</span>fpf_l<span class="keyword">,</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> LE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> pf0</span>
<span class="comment">//
</span><span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> lemma_ldiff_tree_join <span class="keyword">(</span>LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span><span class="keyword">,</span> pf0<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">LE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* ldiff_tree_join *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataview</span>
<span class="prfexp"><span class="staexp"><A name="4753"><span class="stacstdec">rdiff_v <span class="keyword">(</span>
  key <span class="keyword">:</span> t@ype
<span class="keyword">,</span> itm <span class="keyword">:</span> viewt@ype+
<span class="keyword">,</span> int  <span class="comment">// size
</span><span class="keyword">,</span> addr <span class="comment">// the root of missing left child
</span><span class="keyword">,</span> addr <span class="comment">// root
</span><span class="keyword">,</span> addr <span class="comment">// self
</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span> <span class="comment">(* view for a binary tree where a subtree is missing *)</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">rt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    RB1 <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2+1<span class="keyword">,</span> rgh<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> lft<span class="keyword">)</span><span class="keyword">,</span> rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> slf<span class="keyword">,</span> rt<span class="keyword">,</span> pnt<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B]
</span>  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">chld<span class="keyword">:</span>addr</span><span class="keyword">}</span> RE1 <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">,</span> chld<span class="keyword">,</span> chld<span class="keyword">,</span> null<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [dataview ldiff_v]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rdiff_child_set
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> chld0<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span> &gt;&gt; rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> chld1<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>rt<span class="keyword">:</span>addr<span class="keyword">]</span> ptr rt</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    pt
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">RE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := RE1 <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> pc1
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [rdiff_child_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rdiff_tree_join
  <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> 
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> chld0<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span><span class="keyword">prfun</span> <span class="prfexp">lemma_rdiff_tree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    fpf<span class="keyword">:</span> <span class="staexp">rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1<span class="keyword">,</span> chld<span class="keyword">,</span> rt<span class="keyword">,</span> slf<span class="keyword">)</span></span><span class="keyword">,</span> pf0<span class="keyword">:</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n2<span class="keyword">,</span> chld<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n1+n2<span class="keyword">,</span> rt<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> fpf <span class="keyword">of</span>
  <span class="keyword">|</span> RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span> lemma_rdiff_tree_join <span class="keyword">(</span>fpf_r<span class="keyword">,</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf0<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> RE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> pf0</span>
<span class="comment">//
</span><span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> lemma_rdiff_tree_join <span class="keyword">(</span>RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span><span class="keyword">,</span> pf0<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">RE1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [rdiff_tree_join]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> tree_splay_loop
  <span class="staexp"><span class="keyword">{</span>ln<span class="keyword">:</span>nat<span class="keyword">;</span>lchld<span class="keyword">,</span>lrt<span class="keyword">,</span>lslf<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>rn<span class="keyword">:</span>nat<span class="keyword">;</span>rchld<span class="keyword">,</span>rrt<span class="keyword">,</span>rslf<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">lfpf<span class="keyword">:</span> <span class="staexp">rdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> ln<span class="keyword">,</span> lchld<span class="keyword">,</span> lrt<span class="keyword">,</span> lslf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">rfpf<span class="keyword">:</span> <span class="staexp">ldiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> rn<span class="keyword">,</span> rchld<span class="keyword">,</span> rrt<span class="keyword">,</span> rslf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span> &gt;&gt; tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> ln+n+rn<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> lpt<span class="keyword">:</span> <span class="staexp">ptr lrt</span><span class="keyword">,</span> lp<span class="keyword">:</span> <span class="staexp">ptr lslf</span>
  <span class="keyword">,</span> rpt<span class="keyword">:</span> <span class="staexp">ptr rrt</span><span class="keyword">,</span> rp<span class="keyword">:</span> <span class="staexp">ptr rslf</span>
  <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">]</span> ptr slf</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> p<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left
  <span class="keyword">in</span>
    <span class="keyword">if</span> p_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l<span class="keyword">-&gt;</span>right
      <span class="keyword">val</span> sgn1 <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> p_l<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn1 <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// zig-zig-rotation
</span>        <span class="keyword">val</span> p_l_l <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>left
      <span class="keyword">in</span>
        <span class="keyword">if</span> p_l_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_l_l</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p
          <span class="keyword">val</span> rpt <span class="keyword">=</span> ldiff_child_set <span class="keyword">(</span><span class="prfexp">rfpf</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p_l<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp">rfpf <span class="keyword">=</span> LB1 <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> rfpf<span class="keyword">,</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l_r<span class="keyword">,</span> pf_r<span class="keyword">)</span><span class="keyword">)</span></span>
        <span class="keyword">in</span>
          tree_splay_loop <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> rpt<span class="keyword">,</span> p_l<span class="keyword">,</span> p_l_l<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l_l</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l_r<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">)</span> <span class="keyword">=</span> rdiff_tree_join <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> null<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">)</span> <span class="keyword">=</span> ldiff_tree_join <span class="keyword">(</span><span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>left := lpt
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := rpt
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          p_l <span class="comment">// the key [k0] is not found
</span>        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// sgn1 &gt;= 0: zig-rotation
</span>        <span class="keyword">val</span> rpt <span class="keyword">=</span> ldiff_child_set <span class="keyword">(</span><span class="prfexp">rfpf</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp">rfpf <span class="keyword">=</span> LB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> rfpf<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        tree_splay_loop <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> rpt<span class="keyword">,</span> p<span class="keyword">,</span> p_l<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">)</span> <span class="keyword">=</span> rdiff_tree_join <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">)</span> <span class="keyword">=</span> ldiff_tree_join <span class="keyword">(</span><span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := lpt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := rpt
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      p <span class="comment">// the key [k0] is not found
</span>    <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right
  <span class="keyword">in</span>
    <span class="keyword">if</span> p_r &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r<span class="keyword">-&gt;</span>left
      <span class="keyword">val</span> sgn1 <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> p_r<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> sgn1 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// zag-zag-rotation
</span>        <span class="keyword">val</span> p_r_r <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>right
      <span class="keyword">in</span>
        <span class="keyword">if</span> p_r_r &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_r_r</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p
          <span class="keyword">val</span> lpt <span class="keyword">=</span> rdiff_child_set <span class="keyword">(</span><span class="prfexp">lfpf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p_r<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp">lfpf <span class="keyword">=</span> RB1 <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_l<span class="keyword">)</span><span class="keyword">,</span> lfpf<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          tree_splay_loop <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> p_r<span class="keyword">,</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p_r_r<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_r_r</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_l<span class="keyword">)</span></span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">)</span> <span class="keyword">=</span> rdiff_tree_join <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">)</span> <span class="keyword">=</span> ldiff_tree_join <span class="keyword">(</span><span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> null<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := lpt
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>right := rpt
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          p_r <span class="comment">// the key [k0] is not found
</span>        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// sgn1 &lt;= 0: zag-rotation
</span>        <span class="keyword">val</span> lpt <span class="keyword">=</span> rdiff_child_set <span class="keyword">(</span><span class="prfexp">lfpf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp">lfpf <span class="keyword">=</span> RB1 <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> lfpf<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        tree_splay_loop <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> p<span class="keyword">,</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p_r<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">)</span> <span class="keyword">=</span> rdiff_tree_join <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">)</span> <span class="keyword">=</span> ldiff_tree_join <span class="keyword">(</span><span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := lpt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := rpt
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      p <span class="comment">// the key [k0] is not found
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// sgn = 0
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">)</span> <span class="keyword">=</span> rdiff_tree_join <span class="keyword">(</span><span class="prfexp">lfpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> lpt<span class="keyword">,</span> lp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">)</span> <span class="keyword">=</span> ldiff_tree_join <span class="keyword">(</span><span class="prfexp">rfpf</span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> rpt<span class="keyword">,</span> rp<span class="keyword">,</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := lpt
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := rpt
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    p <span class="comment">// the key [k0] is found
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [tree_splay_loop] *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> tree_splay
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span> &gt;&gt; tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">]</span> ptr slf</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  tree_splay_loop <span class="keyword">(</span>
    <span class="prfexp">RE1 <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">LE1 <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> null<span class="comment">(*lpt*)</span><span class="keyword">,</span> null<span class="comment">(*lp*)</span><span class="keyword">,</span> null<span class="comment">(*rpt*)</span><span class="keyword">,</span> null<span class="comment">(*rp*)</span><span class="keyword">,</span> p<span class="keyword">,</span> k0<span class="keyword">,</span> cmp
  <span class="keyword">)</span> <span class="comment">// end of [tree_splay_loop]
</span><span class="keyword">end</span> <span class="comment">// end of [tree_splay]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">:</span>t0p<span class="keyword">,</span> itm<span class="keyword">:</span>vt0p<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">;</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span>
<span class="comment">// end of [map_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="prfexp">E <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
  linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="11841"><span class="stacstdec">map_vt <span class="keyword">=</span> map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A> <span class="keyword">in</span>
  <span class="keyword">if</span> m<span class="keyword">.</span>1 &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_some <span class="staexp"><span class="keyword">{</span>map_vt<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span> <span class="keyword">in</span> 1
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_none <span class="staexp"><span class="keyword">{</span>map_vt<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span> <span class="keyword">in</span> 0
  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [linmap_empty_free] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_is_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>m<span class="keyword">.</span>1 <span class="keyword">=</span> null<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_isnot_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>m<span class="keyword">.</span>1 &lt;&gt; null<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> <span class="comment">// not tail-recursive
</span>  linmap_height <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> tree_height_get <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="comment">// end of [linmap_height]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> <span class="comment">// not tail-recursive
</span>  linmap_size <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span><span class="prfexp">t<span class="keyword">.</span>0</span> <span class="keyword">|</span> t<span class="keyword">.</span>1<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">val</span> res <span class="keyword">=</span> aux <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span> + 1 + aux <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      res
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> 0
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [linmap_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p</span><span class="keyword">}</span>
  <A name="12911"><span class="dyncstdec">linmap_search <span class="staexp"><span class="keyword">{</span>l_res<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_res<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>itm? @ l_res &gt;&gt; disj_v <span class="keyword">(</span>itm? @ l_res<span class="keyword">,</span> itm @ l_res<span class="keyword">,</span> tag<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span>
  <span class="keyword">,</span> p_res<span class="keyword">:</span> <span class="staexp">ptr l_res</span>
  <span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_search]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> linmap_search
  <span class="staexp"><span class="keyword">{</span>l_res<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_res</span> <span class="keyword">|</span> m<span class="keyword">,</span> k0<span class="keyword">,</span> p_res<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewdef</span> <span class="staexp"><A name="13227"><span class="stacstdec">V0 <span class="keyword">=</span> itm? @ l_res</span></span></A> <span class="keyword">and</span> <span class="staexp"><A name="13249"><span class="stacstdec">V1 <span class="keyword">=</span> itm @ l_res</span></span></A>
  <span class="keyword">val</span> pt <span class="keyword">=</span> m<span class="keyword">.</span>1
<span class="keyword">in</span>
  <span class="keyword">if</span> pt &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> pt <span class="keyword">=</span> tree_splay&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> pt<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := pt
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span>
    <span class="keyword">val</span> k1 <span class="keyword">=</span> pt<span class="keyword">-&gt;</span>key
    <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k1<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> sgn <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_res := pt<span class="keyword">-&gt;</span>itm
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_res := InsRight_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">,</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_res<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      1 <span class="comment">// item associated with the given key [k0] is found
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_res := InsLeft_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">,</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_res<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      0 <span class="comment">// item associated with the given key [k0] is found
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_res := InsLeft_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">,</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_res<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    0 <span class="comment">// item associated with the given key [k0] is not found
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_search] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
<A name="14164"><span class="dyncstdec">linmap_insert <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at &gt;&gt; option_v <span class="keyword">(</span>node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at<span class="keyword">,</span> tag <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> p_at<span class="keyword">:</span> <span class="staexp">ptr l_at</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_insert]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_insert <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> m<span class="keyword">,</span> p_at<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma <span class="keyword">(</span>pf_at<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="14509"><span class="dyncstdec">lemma <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at &lt;&gt; null<span class="keyword">]</span> void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span><span class="comment">//
</span>  <span class="keyword">viewdef</span> <span class="staexp"><A name="14606"><span class="stacstdec">V <span class="keyword">=</span> node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at</span></span></A>
  <span class="keyword">val</span> pt <span class="keyword">=</span> m<span class="keyword">.</span>1
<span class="keyword">in</span>
  <span class="keyword">if</span> pt &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> k0 <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>key
    <span class="keyword">val</span> pt <span class="keyword">=</span> tree_splay&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> pt<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span>
    <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> pt<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>left := pt<span class="keyword">-&gt;</span>left
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>right := pt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pt<span class="keyword">-&gt;</span>left := null
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf1_r<span class="keyword">)</span><span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := p_at
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := None_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      0 <span class="comment">// insertion is performed
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>left := pt
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>right := pt<span class="keyword">-&gt;</span>right
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pt<span class="keyword">-&gt;</span>right := null
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> pf1_r<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := p_at
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := None_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      0 <span class="comment">// insertion is performed
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := pt
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := Some_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      1 <span class="comment">// insertion is not performed
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := p_at
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>left := null
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>right := null
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := None_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    0 <span class="comment">// insertion is performed
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_insert] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
<A name="16052"><span class="dyncstdec">linmap_remove <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    option_v <span class="keyword">(</span>node <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at<span class="keyword">,</span> l_at &lt;&gt; null<span class="keyword">)</span> <span class="keyword">|</span> ptr l_at
  <span class="keyword">)</span></span></span></A>
<span class="comment">// end of [linmap_remove]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_remove <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">viewdef</span> <span class="staexp"><A name="16318"><span class="stacstdec">V0 <span class="keyword">=</span> node <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span> @ null</span></span></A>
  <span class="keyword">val</span> pt <span class="keyword">=</span> m<span class="keyword">.</span>1
<span class="keyword">in</span>
  <span class="keyword">if</span> pt &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> pt <span class="keyword">=</span> tree_splay&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> pt<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">stavar</span> <span class="staexp">rt<span class="keyword">:</span> addr</span>
    <span class="keyword">viewdef</span> <span class="staexp"><A name="16473"><span class="stacstdec">V1 <span class="keyword">=</span> node <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span> @ rt</span></span></A>
    <span class="keyword">val</span> _<span class="comment">(*dummy*)</span> <span class="keyword">=</span> pt <span class="keyword">:</span> <span class="staexp">ptr rt</span> <span class="comment">// for typeckecking only
</span>    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span>
    <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> pt<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> sgn <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// the key [k0] is found
</span>      <span class="keyword">val</span> pt_l <span class="keyword">=</span> pt<span class="keyword">-&gt;</span>left
    <span class="keyword">in</span>
      <span class="keyword">if</span> pt_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> pt_l <span class="keyword">=</span> tree_splay&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> pt_l<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_exn</span> <span class="keyword">(</span>assert <span class="keyword">(</span>pt_l<span class="keyword">-&gt;</span>right <span class="keyword">=</span> null<span class="keyword">)</span><span class="keyword">)</span> <span class="comment">// lhs &lt;= k0 &lt; rhs !!!
</span><span class="comment">//
</span>        <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l_r</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pt_l<span class="keyword">-&gt;</span>right := pt<span class="keyword">-&gt;</span>right
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := pt_l
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">Some_v <span class="staexp"><span class="keyword">{</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">)</span></span> <span class="keyword">|</span> pt<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := pf_r</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := pt<span class="keyword">-&gt;</span>right
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">Some_v <span class="staexp"><span class="keyword">{</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_at<span class="keyword">)</span></span> <span class="keyword">|</span> pt<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// the key [k0] is not found
</span>      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0 := B <span class="keyword">(</span>pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>1 := pt
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">None_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span>
    <span class="keyword">(</span><span class="prfexp">None_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span> <span class="comment">// the key [k0] is not found
</span>  <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_remove] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// infix order foreach
</span><span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> tree_foreach_inf
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tree_v <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>n<span class="keyword">,</span>slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf2<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span>
  <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span> <span class="keyword">=</span> pf1</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tree_foreach_inf <span class="keyword">(</span><span class="prfexp">pf1_l</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>key<span class="keyword">,</span> p<span class="keyword">-&gt;</span>itm<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tree_foreach_inf <span class="keyword">(</span><span class="prfexp">pf1_r</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := B <span class="keyword">(</span>pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [bst_foreach_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="18321"><span class="dyncstdec">linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> m<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="18505"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><A name="18594"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></span></A>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>itm</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> view@ f</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tree_foreach_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf1 := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ f := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [linmap_foreach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*

// for the purpose of debugging

extern
fun{key:t0p;itm:vt0p}
print_tree {n:nat} {slf:addr}
  (pf: !tree_v (key,itm,n,slf) | p: ptr slf): void
  = "print_tree"

extern
fun{key:t0p;itm:vt0p}
print_tree_dummy {slf:addr} (p: ptr slf): void
  = "print_tree"

extern fun{key:t0p;itm:vt0p} print_linmap (map: !map_vt (key,itm)): void

implement{key,itm} print_linmap (map) = print_tree (map.0 | map.1)

*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [linmap_splaytree_ngc.dats] *)</span>
</PRE>
</BODY>
</HTML>
