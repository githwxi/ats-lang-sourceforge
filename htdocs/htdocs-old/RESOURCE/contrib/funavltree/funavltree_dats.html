<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">(*
**
** An implementation of functional arrays based on Braun trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</FONT>

<FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</FONT><FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">// Various operations on AVL trees are implemented here. Note that these
</FONT><FONT COLOR="#787878">// operations may need to be modified when sets, multisets and associative
</FONT><FONT COLOR="#787878">// maps are implemented based on AVL trees.
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">cmp <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">:</FONT>t@ype<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> elt<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">-&gt;</FONT> bool</FONT>
<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> compare_elt_elt <FONT COLOR="#000000">(</FONT>x1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">cmp elt</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Sgn</FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">:</FONT>t@ype+<FONT COLOR="#000000">,</FONT> int<FONT COLOR="#787878">(*height*)</FONT><FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">:</FONT>nat</FONT> <FONT COLOR="#000000">|</FONT> <FONT COLOR="#0000FF">hl &lt;= hr+1</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#0000FF">hr &lt;= hl+1</FONT><FONT COLOR="#000000">}</FONT>
    B <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT>
      <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>int <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hl<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> elt<FONT COLOR="#000000">,</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">fn</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_height <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int h</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>h<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> h <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> 0
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_height]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_member
  <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">cmp elt</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT>

<FONT COLOR="#000000">implement</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">}</FONT> avltree_member <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> member <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> member <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> sgn <FONT COLOR="#000000">=</FONT> compare_elt_elt <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&lt;</FONT> 0 <FONT COLOR="#000000">then</FONT> member tl <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> member tr <FONT COLOR="#000000">else</FONT> true
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> false
<FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [avltree_member]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(*
** left rotation for restoring height invariant
*)</FONT>
<FONT COLOR="#000000">fn</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_lrotate <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hl+2 == hr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hl<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hr &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= hr+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>hr<FONT COLOR="#000000">,</FONT> trl<FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> tr
  <FONT COLOR="#000000">val</FONT> hrl <FONT COLOR="#000000">=</FONT> avltree_height trl <FONT COLOR="#000000">and</FONT> hrr <FONT COLOR="#000000">=</FONT> avltree_height trr
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> hrl &lt;= hrr <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hr = 1+hlr
</FONT>    B <FONT COLOR="#000000">(</FONT>hrl+2<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hrl+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> trl<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#787878">// [hrl &gt; hrr]: deep rotation
</FONT>    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#787878">(*hrl*)</FONT><FONT COLOR="#000000">,</FONT> trll<FONT COLOR="#000000">,</FONT> xrl<FONT COLOR="#000000">,</FONT> trlr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> trl
  <FONT COLOR="#000000">in</FONT>
    B <FONT COLOR="#000000">(</FONT>hr<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hrl<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> trll<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> xrl<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hrl<FONT COLOR="#000000">,</FONT> trlr<FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_lrotate]
</FONT>
<FONT COLOR="#787878">(*
** right rotation for restoring height invariant
*)</FONT>
<FONT COLOR="#000000">fn</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_rrotate <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hl == hr+2<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hl<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hl &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= hl+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT> tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> tlr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> tl
  <FONT COLOR="#000000">val</FONT> hll <FONT COLOR="#000000">=</FONT> avltree_height tll <FONT COLOR="#000000">and</FONT> hlr <FONT COLOR="#000000">=</FONT> avltree_height tlr
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> hll &gt;= hlr <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl = 1+hll
</FONT>    B <FONT COLOR="#000000">(</FONT>hlr+2<FONT COLOR="#000000">,</FONT> tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hlr+1<FONT COLOR="#000000">,</FONT> tlr<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#787878">// [hll &lt; hlr]: deep rotation
</FONT>    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#787878">(*hlr*)</FONT><FONT COLOR="#000000">,</FONT> tlrl<FONT COLOR="#000000">,</FONT> xlr<FONT COLOR="#000000">,</FONT> tlrr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> tlr
  <FONT COLOR="#000000">in</FONT>
    B <FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hlr<FONT COLOR="#000000">,</FONT> tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> tlrl<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> xlr<FONT COLOR="#000000">,</FONT> B <FONT COLOR="#000000">(</FONT>hlr<FONT COLOR="#000000">,</FONT> tlrr<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_rrotate]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">exception</FONT> ElementFoundException <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_insert
  <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">cmp elt</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h1<FONT COLOR="#000000">:</FONT> nat <FONT COLOR="#000000">|</FONT> h &lt;= h1<FONT COLOR="#000000">;</FONT> h1 &lt;= h+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">implement</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">}</FONT> avltree_insert <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> ins <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> inserted<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">&amp;</FONT>int? &gt;&gt; int</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloref1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h1<FONT COLOR="#000000">:</FONT> nat <FONT COLOR="#000000">|</FONT> h &lt;= h1<FONT COLOR="#000000">;</FONT> h1 &lt;= h+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#787878">(*h*)</FONT><FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> sgn <FONT COLOR="#000000">=</FONT> compare_elt_elt <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&lt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> tl <FONT COLOR="#000000">=</FONT> ins <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> inserted<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">if</FONT> hl - hr &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
            B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT> + 1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl = hr+2
</FONT>            avltree_rrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> tr <FONT COLOR="#000000">=</FONT> ins <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> inserted<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">if</FONT> hr - hl &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
            B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl+1 = hr
</FONT>            avltree_lrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
          inserted := 0<FONT COLOR="#000000">;</FONT>  t <FONT COLOR="#787878">// no insertion
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>inserted := 1<FONT COLOR="#000000">;</FONT> B <FONT COLOR="#000000">(</FONT>1<FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [ins]
</FONT>  <FONT COLOR="#000000">var</FONT> inserted<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#787878">// uninitialized
</FONT>  <FONT COLOR="#000000">val</FONT> t1 <FONT COLOR="#000000">=</FONT> ins <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> inserted<FONT COLOR="#000000">)</FONT> <FONT COLOR="#787878">// size (t1) = 1 + size (t) - inserted
</FONT>  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> inserted <FONT COLOR="#000000">=</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">$raise</FONT> ElementFoundException <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  t1 <FONT COLOR="#787878">// size (t1) = 1 + size (t)
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_insert]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_takeout_min <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>pos<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">&amp;</FONT>elt? &gt;&gt; elt</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h1<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> h1 &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= h1+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> B _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> tl <FONT COLOR="#000000">=</FONT> avltree_takeout_min&lt;<FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> hr - hl &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl+2 = hr
</FONT>       avltree_lrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>  <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>x0 := x<FONT COLOR="#000000">;</FONT> tr<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_takeout_min]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">exception</FONT> ElementNotFoundException <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_remove
  <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">cmp elt</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h1<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> h1 &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= h1+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">implement</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">}</FONT> avltree_remove <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> removed<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#787878">// uninitialized
</FONT>  <FONT COLOR="#000000">fun</FONT> rmv <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>h<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> removed<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">&amp;</FONT>int? &gt;&gt; int</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloref1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h1<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> h1 &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= h1+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#787878">(*h*)</FONT><FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> sgn <FONT COLOR="#000000">=</FONT> compare_elt_elt <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> cmp<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&lt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> tl <FONT COLOR="#000000">=</FONT> rmv <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> removed<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height tl <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height tr
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">if</FONT> hr - hl &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
            B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl+2 == hr
</FONT>            avltree_lrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">if</FONT> sgn <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> tr <FONT COLOR="#000000">=</FONT> rmv <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> removed<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height tl <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height tr
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">if</FONT> hl - hr &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
            B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl = hr+2
</FONT>            avltree_rrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> removed := 1
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
          <FONT COLOR="#000000">|</FONT> B _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
              <FONT COLOR="#000000">var</FONT> x_min<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT>
              <FONT COLOR="#000000">val</FONT> tl <FONT COLOR="#000000">=</FONT> avltree_takeout_min&lt;<FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x_min<FONT COLOR="#000000">)</FONT>
              <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height tl <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height tr
            <FONT COLOR="#000000">in</FONT>
              <FONT COLOR="#000000">if</FONT> hr - hl &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
                B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x_min<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
              <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hl+2 = hr
</FONT>                avltree_lrotate <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x_min<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
              <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>            <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>          <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> tr
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>removed := 0<FONT COLOR="#000000">;</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [rmv]
</FONT>  <FONT COLOR="#000000">val</FONT> t1 <FONT COLOR="#000000">=</FONT> rmv <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> removed<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> removed <FONT COLOR="#000000">=</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">$raise</FONT> ElementNotFoundException <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  t1 <FONT COLOR="#787878">// size (t1) = size (t) - 1
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_remove]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(*
** left join: height(tl) &gt;= height(tr)
*)</FONT>
<FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_ljoin <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hl &gt;= hr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hl<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> hl &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= hl+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> hl - hr &gt;= 2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> tlr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> tl
    <FONT COLOR="#000000">val</FONT> tlr <FONT COLOR="#000000">=</FONT> avltree_ljoin&lt;<FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>tlr<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">val</FONT> hll <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tll<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hlr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tlr<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">if</FONT> hlr - hll &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
      B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hll<FONT COLOR="#000000">,</FONT>hlr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> tlr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hll+2 = hlr
</FONT>      avltree_lrotate <FONT COLOR="#000000">(</FONT>tll<FONT COLOR="#000000">,</FONT> xl<FONT COLOR="#000000">,</FONT> tlr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
    B <FONT COLOR="#000000">(</FONT>hl+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_ljoin]
</FONT>
<FONT COLOR="#787878">(*
** right join: height(tl) &lt;= height(tr)
*)</FONT>
<FONT COLOR="#000000">fun</FONT><FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">elt<FONT COLOR="#000000">:</FONT>t@ype</FONT><FONT COLOR="#000000">}</FONT> avltree_rjoin <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>hl<FONT COLOR="#000000">,</FONT>hr<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> hl &lt;= hr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hl<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> hr<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>h<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> hr &lt;= h<FONT COLOR="#000000">;</FONT> h &lt;= hr+1<FONT COLOR="#000000">]</FONT> avltree <FONT COLOR="#000000">(</FONT>elt<FONT COLOR="#000000">,</FONT> h<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> hl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> hr - hl &gt;= 2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> trl<FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> tr
    <FONT COLOR="#000000">val</FONT> trl <FONT COLOR="#000000">=</FONT> avltree_rjoin&lt;<FONT COLOR="#0000FF">elt</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> trl<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">val</FONT> hrl <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>trl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> hrr <FONT COLOR="#000000">=</FONT> avltree_height <FONT COLOR="#000000">(</FONT>trr<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">if</FONT> hrl - hrr &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
      B <FONT COLOR="#000000">(</FONT>max<FONT COLOR="#000000">(</FONT>hrl<FONT COLOR="#000000">,</FONT>hrr<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> trl<FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#787878">// hrl = hrr+2
</FONT>      avltree_rrotate <FONT COLOR="#000000">(</FONT>trl<FONT COLOR="#000000">,</FONT> xr<FONT COLOR="#000000">,</FONT> trr<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
    B <FONT COLOR="#000000">(</FONT>hr+1<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [avltree_rjoin]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [funavltree.dats] *)</FONT>
</PRE></BODY>
