<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: October 2007
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="1525"><span class="stacstdec">cmp_t <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> Sgn</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="1592"><span class="stacstdec">avl <span class="keyword">(</span>a<span class="keyword">:</span>t@ype+<span class="keyword">,</span> int <span class="comment">(*height*)</span><span class="keyword">,</span> int <span class="comment">(*size*)</span><span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> E <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">rh &lt;= lh</span><span class="keyword">;</span> <span class="staexp">lh &lt;= rh+1</span><span class="keyword">}</span>
      Bl<span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 1+lh<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> int<span class="keyword">(</span>1+lh<span class="keyword">)</span><span class="keyword">,</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span><span class="keyword">,</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">lh &lt;= rh</span><span class="keyword">;</span> <span class="staexp">rh &lt;= lh+1</span><span class="keyword">}</span>
      Br<span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 1+rh<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> int<span class="keyword">(</span>1+rh<span class="keyword">)</span><span class="keyword">,</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span><span class="keyword">,</span>  avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="keyword">typedef</span> <span class="staexp"><a name="1913"><span class="stacstdec">avl_dec <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> h<span class="keyword">:</span>int<span class="keyword">,</span> s<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>h1<span class="keyword">:</span>nat <span class="keyword">|</span> h1 &lt;= h<span class="keyword">;</span> h &lt;= h1+1<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s<span class="keyword">)</span></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="2000"><span class="stacstdec">avl_inc <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> h<span class="keyword">:</span>int<span class="keyword">,</span> s<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>h1<span class="keyword">:</span>nat <span class="keyword">|</span> h &lt;= h1<span class="keyword">;</span> h1 &lt;= h+1<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s<span class="keyword">)</span></span></a></span>

<span class="keyword">typedef</span> <span class="staexp"><a name="2088"><span class="stacstdec">avl <span class="keyword">=</span> <span class="keyword">[</span>a<span class="keyword">:</span>t@ype<span class="keyword">]</span> <span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>int<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="2170"><span class="dyncstdec">avl_size <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int s</span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_size <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> 1 + <span class="keyword">(</span>avl_size l + avl_size r<span class="keyword">)</span>
  <span class="keyword">|</span> Br <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> 1 + <span class="keyword">(</span>avl_size l + avl_size r<span class="keyword">)</span>
  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0
<span class="comment">// end of [avl_size]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="2417"><span class="dyncstdec">avl_height <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int h</span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_height <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0 <span class="keyword">|</span> Bl <span class="keyword">(</span>_<span class="keyword">,</span> h<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> h <span class="keyword">|</span> Br <span class="keyword">(</span>_<span class="keyword">,</span> h<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> h
<span class="comment">// end of [avl_height]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="2631"><span class="dyncstdec">avl_member
  <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> e0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_member <span class="keyword">(</span>t<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>e0<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> avl_member <span class="keyword">(</span>l<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> avl_member <span class="keyword">(</span>r<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> true
    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>e0<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> avl_member <span class="keyword">(</span>l<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> avl_member <span class="keyword">(</span>r<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> true
    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span>  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [avl_member]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="3149"><span class="dyncstdec">avl_search
  <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> pred<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>a <span class="keyword">-&lt;</span>cloptr1<span class="keyword">&gt;</span> Sgn</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option a</span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_search <span class="keyword">(</span>t<span class="keyword">,</span> pred<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> pred e <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> avl_search <span class="keyword">(</span>l<span class="keyword">,</span> pred<span class="keyword">)</span>
    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> avl_search <span class="keyword">(</span>r<span class="keyword">,</span> pred<span class="keyword">)</span>
    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> Some e
    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> pred e <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> avl_search <span class="keyword">(</span>l<span class="keyword">,</span> pred<span class="keyword">)</span>
    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> avl_search <span class="keyword">(</span>r<span class="keyword">,</span> pred<span class="keyword">)</span>
    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> Some e
    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span>  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_search]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="3656"><span class="dyncstdec">avl_foreach <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_foreach <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> t<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      avl_foreach <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> l<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> e<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> avl_foreach <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> r<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      avl_foreach <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> l<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> e<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> avl_foreach <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> r<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span>  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_foreach]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="4201"><span class="dyncstdec">avl_rotate_l <span class="staexp"><span class="keyword">{</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh+2<span class="keyword">,</span> ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">avl_inc <span class="keyword">(</span>a<span class="keyword">,</span> rh+2<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_rotate_l <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> l <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>le<span class="keyword">,</span> lh<span class="keyword">,</span> ll<span class="keyword">,</span> lr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> lrh <span class="keyword">=</span> avl_height <span class="keyword">(</span>lr<span class="keyword">)</span>
    <span class="keyword">in</span>
      Br <span class="keyword">(</span>le<span class="keyword">,</span> lrh+2<span class="keyword">,</span> ll<span class="keyword">,</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lrh+1<span class="keyword">,</span> lr<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>le<span class="keyword">,</span> lh<span class="keyword">,</span> ll<span class="keyword">,</span> lr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> llh <span class="keyword">=</span> avl_height ll <span class="keyword">and</span> lrh <span class="keyword">=</span> avl_height lr
    <span class="keyword">in</span>
      <span class="keyword">if</span> llh <span class="keyword">&lt;</span> lrh <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> lr <span class="keyword">of</span> <span class="comment">// rh = llh: deep rotation
</span>        <span class="keyword">|</span> Bl <span class="keyword">(</span>lre<span class="keyword">,</span> _<span class="keyword">,</span> lrl<span class="keyword">,</span> lrr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
            Br <span class="keyword">(</span>lre<span class="keyword">,</span> lh<span class="keyword">,</span> Bl <span class="keyword">(</span>le<span class="keyword">,</span> llh+1<span class="keyword">,</span> ll<span class="keyword">,</span> lrl<span class="keyword">)</span><span class="keyword">,</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> lh-1<span class="keyword">,</span> lrr<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">|</span> Br <span class="keyword">(</span>lre<span class="keyword">,</span> _<span class="keyword">,</span> lrl<span class="keyword">,</span> lrr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
            Br <span class="keyword">(</span>lre<span class="keyword">,</span> lh<span class="keyword">,</span> Bl <span class="keyword">(</span>le<span class="keyword">,</span> llh+1<span class="keyword">,</span> ll<span class="keyword">,</span> lrl<span class="keyword">)</span><span class="keyword">,</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> lh-1<span class="keyword">,</span> lrr<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        Br <span class="keyword">(</span>le<span class="keyword">,</span> lrh+2<span class="keyword">,</span> ll<span class="keyword">,</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lrh+1<span class="keyword">,</span> lr<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_rotate_l]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="5049"><span class="dyncstdec">avl_rotate_r <span class="staexp"><span class="keyword">{</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rs<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh+2<span class="keyword">,</span> rs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">avl_inc <span class="keyword">(</span>a<span class="keyword">,</span> lh+2<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_rotate_r <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>re<span class="keyword">,</span> rh<span class="keyword">,</span> rl<span class="keyword">,</span> rr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> rlh <span class="keyword">=</span> avl_height rl <span class="keyword">and</span> rrh <span class="keyword">=</span> avl_height rr
    <span class="keyword">in</span>
      <span class="keyword">if</span> rlh <span class="keyword">&gt;</span> rrh <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> rl <span class="keyword">of</span> <span class="comment">// lh = rrh: deep rotation
</span>        <span class="keyword">|</span> Bl <span class="keyword">(</span>rle<span class="keyword">,</span> _<span class="keyword">,</span> rll<span class="keyword">,</span> rlr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
            Bl <span class="keyword">(</span>rle<span class="keyword">,</span> rh<span class="keyword">,</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> rh-1<span class="keyword">,</span> l<span class="keyword">,</span> rll<span class="keyword">)</span><span class="keyword">,</span> Br <span class="keyword">(</span>re<span class="keyword">,</span> rrh+1<span class="keyword">,</span> rlr<span class="keyword">,</span> rr<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">|</span> Br <span class="keyword">(</span>rle<span class="keyword">,</span> _<span class="keyword">,</span> rll<span class="keyword">,</span> rlr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
            Bl <span class="keyword">(</span>rle<span class="keyword">,</span> rh<span class="keyword">,</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> rh-1<span class="keyword">,</span> l<span class="keyword">,</span> rll<span class="keyword">)</span><span class="keyword">,</span> Br <span class="keyword">(</span>re<span class="keyword">,</span> rrh+1<span class="keyword">,</span> rlr<span class="keyword">,</span> rr<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        Bl <span class="keyword">(</span>re<span class="keyword">,</span> rlh+2<span class="keyword">,</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rlh+1<span class="keyword">,</span> l<span class="keyword">,</span> rl<span class="keyword">)</span><span class="keyword">,</span> rr<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>re<span class="keyword">,</span> rh<span class="keyword">,</span> rl<span class="keyword">,</span> rr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> rlh <span class="keyword">=</span> avl_height <span class="keyword">(</span>rl<span class="keyword">)</span>
    <span class="keyword">in</span>
      Bl <span class="keyword">(</span>re<span class="keyword">,</span> rlh+2<span class="keyword">,</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rlh+1<span class="keyword">,</span> l<span class="keyword">,</span> rl<span class="keyword">)</span><span class="keyword">,</span> rr<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_rotate_r]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="5903"><span class="dyncstdec">avl_insert <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> ne<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>s'<span class="keyword">,</span>h'<span class="keyword">:</span> nat <span class="keyword">|</span> s &lt;= s'<span class="keyword">;</span> s' &lt;= s+1<span class="keyword">;</span> h &lt;= h'<span class="keyword">;</span> h' &lt;= h+1<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h'<span class="keyword">,</span> s'<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="6061"><span class="dyncstdec">avl_insert_br
  <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat <span class="keyword">|</span> lh-1 &lt;= rh<span class="keyword">;</span> rh &lt;= lh+1<span class="keyword">;</span> max_r<span class="keyword">(</span>lh<span class="keyword">,</span> rh<span class="keyword">,</span> h-1<span class="keyword">)</span><span class="keyword">}</span></span>
  <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> h<span class="keyword">:</span> <span class="staexp">int h</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span>lh<span class="keyword">,</span>ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">)</span></span><span class="keyword">,</span> ne<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>s<span class="keyword">:</span>int <span class="keyword">|</span> ls+rs+1 &lt;= s<span class="keyword">;</span> s &lt;= ls+rs+2<span class="keyword">]</span> avl_inc <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_insert <span class="keyword">(</span>t<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> Bl <span class="keyword">(</span>ne<span class="keyword">,</span> 1<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_insert_br <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_insert_br <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_insert]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_insert_br
  <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> sgn <span class="keyword">=</span> cmp <span class="keyword">(</span>ne<span class="keyword">,</span> e<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> l' <span class="keyword">=</span> avl_insert&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">val</span> lh' <span class="keyword">=</span> avl_height l' <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
  <span class="keyword">in</span>
    <span class="keyword">if</span> lh' &lt;= rh <span class="keyword">then</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> lh' &lt;= rh+1 <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh'+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
    <span class="keyword">else</span> avl_rotate_l <span class="keyword">(</span>e<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r' <span class="keyword">=</span> avl_insert&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>r<span class="keyword">,</span> ne<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh' <span class="keyword">=</span> avl_height r'
  <span class="keyword">in</span>
    <span class="keyword">if</span> rh' &lt;= lh <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> rh' &lt;= lh + 1 <span class="keyword">then</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh'+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
    <span class="keyword">else</span> avl_rotate_r <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
  <span class="keyword">in</span>
    <span class="keyword">if</span> lh &gt;= rh <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_insert_br]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="7313"><span class="dyncstdec">avl_takeout_min <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s <span class="keyword">&gt;</span> 0<span class="keyword">}</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>a?<span class="keyword">)</span> &gt;&gt; a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">avl_dec <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s-1<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_takeout_min <span class="keyword">(</span>t<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">:</span> <span class="keyword">(</span>x<span class="keyword">:</span> a<span class="keyword">)</span> <span class="keyword">=&gt;</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">:</span> <span class="keyword">(</span>x<span class="keyword">:</span> a<span class="keyword">)</span> <span class="keyword">=&gt;</span> l <span class="keyword">of</span>
    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>x := e<span class="keyword">;</span> r<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l' <span class="keyword">=</span> avl_takeout_min&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> x<span class="keyword">)</span>
        <span class="keyword">val</span> lh' <span class="keyword">=</span> avl_height l' <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
      <span class="keyword">in</span>
        <span class="keyword">if</span> rh &lt;= lh' <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh'+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">:</span> <span class="keyword">(</span>x<span class="keyword">:</span> a<span class="keyword">)</span> <span class="keyword">=&gt;</span> l <span class="keyword">of</span>
    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>x := e<span class="keyword">;</span> r<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l' <span class="keyword">=</span> avl_takeout_min&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> x<span class="keyword">)</span>
        <span class="keyword">val</span> lh' <span class="keyword">=</span> avl_height l' <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
      <span class="keyword">in</span>
        <span class="keyword">if</span> rh &lt;= lh' <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh'+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">if</span> rh &lt;= lh'+1 <span class="keyword">then</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
        <span class="keyword">else</span> avl_rotate_r <span class="keyword">(</span>e<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_takeout_min]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="8251"><span class="dyncstdec">avl_join_l <span class="staexp"><span class="keyword">{</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat <span class="keyword">|</span> lh &gt;= rh<span class="keyword">}</span></span>
  <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">avl_inc <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_join_l <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
<span class="keyword">in</span>
  <span class="keyword">if</span> lh <span class="keyword">&gt;</span> rh+1 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> l <span class="keyword">of</span>
    <span class="keyword">|</span> Bl <span class="keyword">(</span>le<span class="keyword">,</span> _<span class="keyword">,</span> ll<span class="keyword">,</span> lr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> lr' <span class="keyword">=</span> avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> lr<span class="keyword">,</span> r<span class="keyword">)</span>
        <span class="keyword">val</span> llh <span class="keyword">=</span> avl_height ll <span class="keyword">and</span> lrh' <span class="keyword">=</span> avl_height lr'
      <span class="keyword">in</span>
        <span class="keyword">if</span> lrh' &lt;= llh <span class="keyword">then</span> Bl <span class="keyword">(</span>le<span class="keyword">,</span> llh+1<span class="keyword">,</span> ll<span class="keyword">,</span> lr'<span class="keyword">)</span>
        <span class="keyword">else</span> Br <span class="keyword">(</span>le<span class="keyword">,</span> lrh'+1<span class="keyword">,</span> ll<span class="keyword">,</span> lr'<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>    <span class="keyword">|</span> Br <span class="keyword">(</span>le<span class="keyword">,</span> _<span class="keyword">,</span> ll<span class="keyword">,</span> lr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> lr' <span class="keyword">=</span> avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> lr<span class="keyword">,</span> r<span class="keyword">)</span>
        <span class="keyword">val</span> llh <span class="keyword">=</span> avl_height ll <span class="keyword">and</span> lrh' <span class="keyword">=</span> avl_height lr'
      <span class="keyword">in</span>
        <span class="keyword">if</span> lrh' &lt;= llh+1 <span class="keyword">then</span> Br <span class="keyword">(</span>le<span class="keyword">,</span> lrh'+1<span class="keyword">,</span> ll<span class="keyword">,</span> lr'<span class="keyword">)</span>
        <span class="keyword">else</span> avl_rotate_r <span class="keyword">(</span>le<span class="keyword">,</span> ll<span class="keyword">,</span> lr'<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Br]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_join_l]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="9121"><span class="dyncstdec">avl_join_r <span class="staexp"><span class="keyword">{</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat <span class="keyword">|</span> lh &lt;= rh<span class="keyword">}</span></span>
  <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">avl_inc <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> 1+ls+rs<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_join_r <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
<span class="keyword">in</span>
  <span class="keyword">if</span> lh+1 <span class="keyword">&lt;</span> rh <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> Bl <span class="keyword">(</span>re<span class="keyword">,</span> _<span class="keyword">,</span> rl<span class="keyword">,</span> rr<span class="keyword">)</span> <span class="keyword">=&gt;</span>  <span class="keyword">let</span>
        <span class="keyword">val</span> rl' <span class="keyword">=</span> avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> rl<span class="keyword">)</span>
        <span class="keyword">val</span> rlh' <span class="keyword">=</span> avl_height rl' <span class="keyword">and</span> rrh <span class="keyword">=</span> avl_height rr
      <span class="keyword">in</span>
        <span class="keyword">if</span> rlh' &lt;= rrh+1 <span class="keyword">then</span> Bl <span class="keyword">(</span>re<span class="keyword">,</span> rlh'+1<span class="keyword">,</span> rl'<span class="keyword">,</span> rr<span class="keyword">)</span>
        <span class="keyword">else</span> avl_rotate_l <span class="keyword">(</span>re<span class="keyword">,</span> rl'<span class="keyword">,</span> rr<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>    <span class="keyword">|</span> Br <span class="keyword">(</span>re<span class="keyword">,</span> _<span class="keyword">,</span> rl<span class="keyword">,</span> rr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> rl' <span class="keyword">=</span> avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> rl<span class="keyword">)</span>
        <span class="keyword">val</span> rlh' <span class="keyword">=</span> avl_height rl' <span class="keyword">and</span> rrh <span class="keyword">=</span> avl_height rr
      <span class="keyword">in</span>
        <span class="keyword">if</span> rlh' &lt;= rrh <span class="keyword">then</span> Br <span class="keyword">(</span>re<span class="keyword">,</span> rrh+1<span class="keyword">,</span> rl'<span class="keyword">,</span> rr<span class="keyword">)</span>
        <span class="keyword">else</span> Bl <span class="keyword">(</span>re<span class="keyword">,</span> rlh'+1<span class="keyword">,</span> rl'<span class="keyword">,</span> rr<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Br]
</span>   <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
     Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
   <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_join_r]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="10016"><span class="dyncstdec">avl_concat <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>s1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s1<span class="keyword">)</span></span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">:</span>nat<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s1+s2<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_concat <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> t2
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t1
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> x<span class="keyword">:</span> <span class="staexp">a</span>
      <span class="keyword">val</span> t2 <span class="keyword">=</span> avl_takeout_min&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>t2<span class="keyword">,</span> x<span class="keyword">)</span>
      <span class="keyword">val</span> h1 <span class="keyword">=</span> avl_height t1 <span class="keyword">and</span> h2 <span class="keyword">=</span> avl_height t2
    <span class="keyword">in</span>
      <span class="keyword">if</span> h1 &lt;= h2 <span class="keyword">then</span> avl_join_r <span class="keyword">(</span>x<span class="keyword">,</span> t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">else</span> avl_join_l <span class="keyword">(</span>x<span class="keyword">,</span> t1<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_, _]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_concat]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="10514"><span class="stacstdec">avl_split_vt
  <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> h<span class="keyword">:</span>int<span class="keyword">,</span> s<span class="keyword">:</span>int<span class="keyword">,</span> lp<span class="keyword">:</span> addr<span class="keyword">,</span> rp<span class="keyword">:</span> addr<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat<span class="keyword">;</span> b<span class="keyword">:</span>two <span class="keyword">|</span> lh &lt;= h<span class="keyword">;</span> rh &lt;= h<span class="keyword">;</span> s==b+ls+rs<span class="keyword">]</span>
    <span class="keyword">(</span>avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span> @ lp<span class="keyword">,</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span> @ rp <span class="keyword">|</span> int b<span class="keyword">)</span></span></a></span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="10711"><span class="dyncstdec">avl_split <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>lp<span class="keyword">,</span>rp<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">lpf<span class="keyword">:</span> <span class="staexp">avl? @ lp</span></span><span class="keyword">,</span> <span class="prfexp">rpf<span class="keyword">:</span> <span class="staexp">avl? @ rp</span></span> <span class="keyword">|</span>
   t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> pred<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>a <span class="keyword">-&lt;</span>cloptr1<span class="keyword">&gt;</span> Sgn</span><span class="keyword">,</span> lp<span class="keyword">:</span> <span class="staexp">ptr lp</span><span class="keyword">,</span> rp<span class="keyword">:</span> <span class="staexp">ptr rp</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">avl_split_vt <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="10906"><span class="dyncstdec">avl_split_br
  <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>lh<span class="keyword">,</span>ls<span class="keyword">,</span>rh<span class="keyword">,</span>rs<span class="keyword">:</span>nat <span class="keyword">|</span> lh-1 &lt;= rh<span class="keyword">;</span> rh &lt;= lh+1<span class="keyword">;</span> max_r<span class="keyword">(</span>lh<span class="keyword">,</span> rh<span class="keyword">,</span> h-1<span class="keyword">)</span><span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>lp<span class="keyword">,</span>rp<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">lpf<span class="keyword">:</span> <span class="staexp">avl? @ lp</span></span><span class="keyword">,</span> <span class="prfexp">rpf<span class="keyword">:</span> <span class="staexp">avl? @ rp</span></span> <span class="keyword">|</span>
   e<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> h<span class="keyword">:</span> <span class="staexp">int h</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh<span class="keyword">,</span> ls<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh<span class="keyword">,</span> rs<span class="keyword">)</span></span><span class="keyword">,</span> pred<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>a <span class="keyword">-&lt;</span>cloptr1<span class="keyword">&gt;</span> Sgn</span><span class="keyword">,</span>
   lp<span class="keyword">:</span> <span class="staexp">ptr lp</span><span class="keyword">,</span> rp<span class="keyword">:</span> <span class="staexp">ptr rp</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">avl_split_vt <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> ls+rs+1<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_split <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> t<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_split_br <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span>
  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_split_br <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span>
  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">!</span>lp := E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>rp := E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> 0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [E]
</span><span class="comment">// end of [avl_split]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_split_br
  <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> e<span class="keyword">,</span> h<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> pred e <span class="keyword">of</span>
  <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span> <span class="keyword">=</span> avl_split <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> l<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span>
      <span class="keyword">val</span> lrh' <span class="keyword">=</span> avl_height <span class="keyword">!</span>rp <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
    <span class="keyword">in</span>
      <span class="keyword">if</span> lrh' &lt;= rh <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>rp := avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> <span class="keyword">!</span>rp<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>rp := avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> <span class="keyword">!</span>rp<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [~]
</span>  <span class="keyword">|</span> 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span> <span class="keyword">=</span> avl_split <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> r<span class="keyword">,</span> pred<span class="keyword">,</span> lp<span class="keyword">,</span> rp<span class="keyword">)</span>
      <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rlh' <span class="keyword">=</span> avl_height <span class="keyword">!</span>lp
    <span class="keyword">in</span>
      <span class="keyword">if</span> lh &lt;= rlh' <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>lp := avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> <span class="keyword">!</span>lp<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>lp := avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> <span class="keyword">!</span>lp<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [ 1]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">|</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">!</span>lp := l<span class="keyword">;</span> <span class="keyword">!</span>rp := r<span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> 1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [0]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_split_br]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// difference operation
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="12499"><span class="dyncstdec">avl_diff <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>s1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s1<span class="keyword">)</span></span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s &lt;= s1<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="12644"><span class="dyncstdec">avl_diff_br
  <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>lh1<span class="keyword">,</span>ls1<span class="keyword">,</span>rh1<span class="keyword">,</span>rs1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat <span class="keyword">|</span>
   lh1-1 &lt;= rh1<span class="keyword">;</span> rh1 &lt;= lh1+1<span class="keyword">;</span> max_r<span class="keyword">(</span>lh1<span class="keyword">,</span> rh1<span class="keyword">,</span> h1-1<span class="keyword">)</span><span class="keyword">}</span></span>
  <span class="keyword">(</span>e1<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> h1<span class="keyword">:</span> <span class="staexp">int h1</span><span class="keyword">,</span> l1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh1<span class="keyword">,</span> ls1<span class="keyword">)</span></span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh1<span class="keyword">,</span> rs1<span class="keyword">)</span></span><span class="keyword">,</span> 
   t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s &lt;= 1+ls1+rs1<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_diff <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> E <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t1
  <span class="keyword">|</span> <span class="keyword">(</span>Bl <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_diff_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>Br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_diff_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_diff]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_diff_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> l2<span class="keyword">:</span> <span class="staexp">avl?</span> <span class="keyword">and</span> r2<span class="keyword">:</span> <span class="staexp">avl?</span>
  <span class="keyword">val</span> pred <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>e2<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Sgn</span> <span class="keyword">=&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> cmp <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span> <span class="keyword">=</span>
    avl_split <span class="keyword">(</span><span class="prfexp">view@ l2</span><span class="keyword">,</span> <span class="prfexp">view@ r2</span> <span class="keyword">|</span> t2<span class="keyword">,</span> pred<span class="keyword">,</span> <span class="keyword">&amp;</span>l2<span class="keyword">,</span> <span class="keyword">&amp;</span>r2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cloptr_free <span class="keyword">(</span>pred<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>view@ l2 := lpf<span class="keyword">;</span> view@ r2 := rpf<span class="keyword">)</span></span>
  <span class="keyword">val</span> l <span class="keyword">=</span> avl_diff <span class="keyword">(</span>l1<span class="keyword">,</span> l2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">and</span> r <span class="keyword">=</span> avl_diff <span class="keyword">(</span>r1<span class="keyword">,</span> r2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
<span class="keyword">in</span>
  <span class="keyword">if</span> tag <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> avl_concat&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">else</span> <span class="keyword">if</span> lh &lt;= rh <span class="keyword">then</span> avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">else</span> avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_diff_br]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// intersection operation
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="13797"><span class="dyncstdec">avl_inter <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>s1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s1<span class="keyword">)</span></span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s &lt;= s1<span class="keyword">;</span> s &lt;= s2<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="13952"><span class="dyncstdec">avl_inter_br
  <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>lh1<span class="keyword">,</span>ls1<span class="keyword">,</span>rh1<span class="keyword">,</span>rs1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat <span class="keyword">|</span>
   lh1-1 &lt;= rh1<span class="keyword">;</span> rh1 &lt;= lh1+1<span class="keyword">;</span> max_r<span class="keyword">(</span>lh1<span class="keyword">,</span> rh1<span class="keyword">,</span> h1-1<span class="keyword">)</span><span class="keyword">}</span></span>
  <span class="keyword">(</span>e1<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> h1<span class="keyword">:</span> <span class="staexp">int h1</span><span class="keyword">,</span> l1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh1<span class="keyword">,</span> ls1<span class="keyword">)</span></span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh1<span class="keyword">,</span> rs1<span class="keyword">)</span></span><span class="keyword">,</span> 
   t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s &lt;= ls1+rs1+1<span class="keyword">;</span> s &lt;= s2<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_inter <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> E <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> E <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>Bl <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_inter_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>Br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_inter_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_inter]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_inter_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> l2<span class="keyword">:</span> <span class="staexp">avl?</span> <span class="keyword">and</span> r2<span class="keyword">:</span> <span class="staexp">avl?</span>
  <span class="keyword">val</span> pred <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>e2<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Sgn</span> <span class="keyword">=&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> cmp <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> tag<span class="keyword">)</span> <span class="keyword">=</span>
    avl_split <span class="keyword">(</span><span class="prfexp">view@ l2</span><span class="keyword">,</span> <span class="prfexp">view@ r2</span> <span class="keyword">|</span> t2<span class="keyword">,</span> pred<span class="keyword">,</span> <span class="keyword">&amp;</span>l2<span class="keyword">,</span> <span class="keyword">&amp;</span>r2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cloptr_free <span class="keyword">(</span>pred<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>view@ l2 := lpf<span class="keyword">;</span> view@ r2 := rpf<span class="keyword">)</span></span>
  <span class="keyword">val</span> l <span class="keyword">=</span> avl_inter <span class="keyword">(</span>l1<span class="keyword">,</span> l2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">and</span> r <span class="keyword">=</span> avl_inter <span class="keyword">(</span>r1<span class="keyword">,</span> r2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
<span class="keyword">in</span>
  <span class="keyword">if</span> tag <span class="keyword">&gt;</span> 0 <span class="keyword">then</span>
    <span class="keyword">if</span> lh &lt;= rh <span class="keyword">then</span> avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">else</span> avl_concat&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_inter_br]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="15100"><span class="dyncstdec">avl_union <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>s1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h1<span class="keyword">,</span> s1<span class="keyword">)</span></span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s1 &lt;= s<span class="keyword">;</span> s2 &lt;= s<span class="keyword">;</span> s &lt;= s1+s2<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="15267"><span class="dyncstdec">avl_union_br
  <span class="staexp"><span class="keyword">{</span>h1<span class="keyword">,</span>lh1<span class="keyword">,</span>ls1<span class="keyword">,</span>rh1<span class="keyword">,</span>rs1<span class="keyword">,</span>h2<span class="keyword">,</span>s2<span class="keyword">:</span>nat <span class="keyword">|</span>
   lh1-1 &lt;= rh1<span class="keyword">;</span> rh1 &lt;= lh1+1<span class="keyword">;</span> max_r<span class="keyword">(</span>lh1<span class="keyword">,</span> rh1<span class="keyword">,</span> h1-1<span class="keyword">)</span><span class="keyword">}</span></span>
  <span class="keyword">(</span>e1<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> h1<span class="keyword">:</span> <span class="staexp">int h1</span><span class="keyword">,</span> l1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> lh1<span class="keyword">,</span> ls1<span class="keyword">)</span></span><span class="keyword">,</span> r1<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> rh1<span class="keyword">,</span> rs1<span class="keyword">)</span></span><span class="keyword">,</span> 
   t2<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h2<span class="keyword">,</span> s2<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> 1+ls1+rs1 &lt;= s<span class="keyword">;</span> s2 &lt;= s<span class="keyword">;</span> s &lt;= 1+ls1+rs1+s2<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_union <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> t2
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t1
  <span class="keyword">|</span> <span class="keyword">(</span>Bl <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_union_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>Br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> avl_union_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_union_br <span class="keyword">(</span>e1<span class="keyword">,</span> h1<span class="keyword">,</span> l1<span class="keyword">,</span> r1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> l2<span class="keyword">:</span> <span class="staexp">avl?</span> <span class="keyword">and</span> r2<span class="keyword">:</span> <span class="staexp">avl?</span>
  <span class="keyword">val</span> pred <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>e2<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Sgn</span> <span class="keyword">=&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> cmp <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">lpf</span><span class="keyword">,</span> <span class="prfexp">rpf</span> <span class="keyword">|</span> _<span class="keyword">)</span> <span class="keyword">=</span>
    avl_split <span class="keyword">(</span><span class="prfexp">view@ l2</span><span class="keyword">,</span> <span class="prfexp">view@ r2</span> <span class="keyword">|</span> t2<span class="keyword">,</span> pred<span class="keyword">,</span> <span class="keyword">&amp;</span>l2<span class="keyword">,</span> <span class="keyword">&amp;</span>r2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cloptr_free <span class="keyword">(</span>pred<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>view@ l2 := lpf<span class="keyword">;</span> view@ r2 := rpf<span class="keyword">)</span></span>
  <span class="keyword">val</span> l <span class="keyword">=</span> avl_union <span class="keyword">(</span>l1<span class="keyword">,</span> l2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">and</span> r <span class="keyword">=</span> avl_union <span class="keyword">(</span>r1<span class="keyword">,</span> r2<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
<span class="keyword">in</span>
  <span class="keyword">if</span> lh &lt;= rh <span class="keyword">then</span> avl_join_r&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> avl_join_l&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>e1<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [avl_union_br]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// removal operation
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="16368"><span class="dyncstdec">avl_remove <span class="staexp"><span class="keyword">{</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span><span class="keyword">,</span> e0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp_t a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>s1<span class="keyword">:</span>nat <span class="keyword">|</span> s1 &lt;= s<span class="keyword">]</span> avl_dec <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s1<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> avl_remove <span class="keyword">(</span>t<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> E <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>e0<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l' <span class="keyword">=</span> avl_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val</span> lh' <span class="keyword">=</span> avl_height l' <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
      <span class="keyword">in</span>
        <span class="keyword">if</span> rh &lt;= lh' <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh'+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>    <span class="keyword">|</span> 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> r' <span class="keyword">=</span> avl_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>r<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh' <span class="keyword">=</span> avl_height r'
      <span class="keyword">in</span>
        <span class="keyword">if</span> lh &lt;= rh'+1 <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span> <span class="keyword">else</span> avl_rotate_l <span class="keyword">(</span>e<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [1]
</span>    <span class="keyword">|</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
      <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> l
      <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
          <span class="keyword">var</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">;</span> <span class="keyword">val</span> r' <span class="keyword">=</span> avl_takeout_min&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>r<span class="keyword">,</span> x<span class="keyword">)</span>
          <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh' <span class="keyword">=</span> avl_height r'
        <span class="keyword">in</span>
          <span class="keyword">if</span> lh &lt;= rh'+1 <span class="keyword">then</span> Bl <span class="keyword">(</span>x<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span> <span class="keyword">else</span> avl_rotate_l <span class="keyword">(</span>x<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">end</span> <span class="comment">// end of [0]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Bl]
</span>  <span class="keyword">|</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>e0<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l' <span class="keyword">=</span> avl_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>l<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val</span> lh' <span class="keyword">=</span> avl_height l' <span class="keyword">and</span> rh <span class="keyword">=</span> avl_height r
      <span class="keyword">in</span>
        <span class="keyword">if</span> rh &lt;= lh'+1 <span class="keyword">then</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh+1<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">else</span> avl_rotate_r <span class="keyword">(</span>e<span class="keyword">,</span> l'<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>    <span class="keyword">|</span> 1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> r' <span class="keyword">=</span> avl_remove&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>r<span class="keyword">,</span> e0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh' <span class="keyword">=</span> avl_height r'
      <span class="keyword">in</span>
        <span class="keyword">if</span> rh' &lt;= lh <span class="keyword">then</span> Bl <span class="keyword">(</span>e<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span> <span class="keyword">else</span> Br <span class="keyword">(</span>e<span class="keyword">,</span> rh'+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [1]
</span>    <span class="keyword">|</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
      <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> l
      <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
          <span class="keyword">var</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">;</span> <span class="keyword">val</span> r' <span class="keyword">=</span> avl_takeout_min&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>r<span class="keyword">,</span> x<span class="keyword">)</span>
          <span class="keyword">val</span> lh <span class="keyword">=</span> avl_height l <span class="keyword">and</span> rh' <span class="keyword">=</span> avl_height r'
        <span class="keyword">in</span>
          <span class="keyword">if</span> rh' &lt;= lh <span class="keyword">then</span> Bl <span class="keyword">(</span>x<span class="keyword">,</span> lh+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span> <span class="keyword">else</span> Br <span class="keyword">(</span>x<span class="keyword">,</span> rh'+1<span class="keyword">,</span> l<span class="keyword">,</span> r'<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">end</span>  <span class="comment">// end of [0]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Br]
</span><span class="keyword">end</span> <span class="comment">// end of [avl_remove]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_set_fun.sats"</span>

<span class="keyword">assume</span> <span class="staexp">set_t <span class="keyword">(</span>a<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>h<span class="keyword">,</span>s<span class="keyword">:</span>nat<span class="keyword">]</span> avl <span class="keyword">(</span>a<span class="keyword">,</span> h<span class="keyword">,</span> s<span class="keyword">)</span></span>

<span class="keyword">implement</span> set_nil <span class="keyword">=</span> E <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_member <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> avl_member <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_insert <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> avl_insert <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_remove <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> avl_remove <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_inter <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> avl_inter <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_union <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> avl_union <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> cmp<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_foreach_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span>
  avl_foreach&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> set_foreach_cloptr <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="18826"><span class="stacstdec">cloptr_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> avl_foreach&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [set_foreach_cloptr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_set_fun.dats] *)</span>
</pre>
</body>
</html>
