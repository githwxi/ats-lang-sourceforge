<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Start Time: March 2008
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="comment">(* high-level intermediate representation *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Map <span class="keyword">=</span> "ats_map_lin.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_hiexp.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_map_lin.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THISFILENAME "ats_hiexp_util.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">nil list_nil</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">cons list_cons</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">:: list_cons</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ABS_TYPE_NAME "ats_abs_type"</span>
<span class="keyword">#define</span> <span class="neuexp">VAR_TYPE_NAME "ats_var_type"</span>
<span class="keyword">#define</span> <span class="neuexp">VOID_TYPE_NAME "ats_void_type"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_hiexp_util)"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
hityp_is_void <span class="keyword">(</span>hit0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit0<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HITextype <span class="keyword">(</span>name<span class="keyword">,</span> _<span class="comment">(*arglst*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> name <span class="keyword">=</span> ABS_TYPE_NAME <span class="keyword">=&gt;</span> true
    <span class="keyword">|</span> _ <span class="keyword">when</span> name <span class="keyword">=</span> VAR_TYPE_NAME <span class="keyword">=&gt;</span> true
    <span class="keyword">|</span> _ <span class="keyword">when</span> name <span class="keyword">=</span> VOID_TYPE_NAME <span class="keyword">=&gt;</span> true
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">(* end of [HITextype] *)</span>
  <span class="keyword">|</span> HITs2var s2v <span class="keyword">when</span> s2var_is_unboxed s2v <span class="keyword">=&gt;</span> true <span class="comment">// problematic?
</span>  <span class="keyword">|</span> HITtyrecsin hit <span class="keyword">=&gt;</span> hityp_is_void hit
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_void]
</span>
<span class="keyword">implement</span>
hityp_fun_is_void <span class="keyword">(</span>hit_fun<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "hityp_fun_is_void: hit_fun = "; print hit_fun; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> hit_fun<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HITfun <span class="keyword">(</span>_<span class="comment">(*fc*)</span><span class="keyword">,</span> _<span class="comment">(*arg*)</span><span class="keyword">,</span> hit_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_is_void <span class="keyword">(</span>hit_res<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": hityp_fun_is_void: hit_fun = "<span class="keyword">;</span> prerr_hityp hit_fun<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>bool<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [hityp_fun_is_void]
</span>
<span class="keyword">implement</span>
hityp_is_vararg <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit<span class="keyword">.</span>hityp_node <span class="keyword">of</span> HITvararg _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_vararg]
</span>
<span class="keyword">implement</span>
hityp_fun_is_vararg <span class="keyword">(</span>hit_fun<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>hit<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> hits<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">case+</span> hits <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_is_vararg hit
  <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> hit_fun<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HITfun <span class="keyword">(</span>_<span class="comment">(*fc*)</span><span class="keyword">,</span> arg<span class="keyword">,</span> _<span class="comment">(*res*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> arg <span class="keyword">of</span> cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [HITfun]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": hityp_fun_is_vararg: hit_fun = "
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_hityp <span class="keyword">(</span>hit_fun<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>bool<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [hityp_fun_is_vararg]
</span>
<span class="keyword">implement</span>
hityp_is_tyarr <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit_rec<span class="keyword">.</span>hityp_node <span class="keyword">of</span> HITtyarr _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_tyarr]
</span>
<span class="keyword">implement</span>
hityp_is_tyrecbox <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit_rec<span class="keyword">.</span>hityp_node <span class="keyword">of</span> HITtyrec <span class="keyword">(</span>knd<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_tyrecbox]
</span>
<span class="keyword">implement</span>
hityp_is_tyrecext <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit_rec<span class="keyword">.</span>hityp_node <span class="keyword">of</span> HITtyrec <span class="keyword">(</span>knd<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> knd <span class="keyword">&lt;</span> 0 <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_tyrecext]
</span>
<span class="keyword">implement</span>
hityp_is_tyrecsin <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hit_rec<span class="keyword">.</span>hityp_node <span class="keyword">of</span> HITtyrecsin _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityp_is_tyrecsim]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
hipatlst_is_unused
  <span class="keyword">(</span>hips<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hips <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>hip<span class="keyword">,</span> hips<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> hip<span class="keyword">.</span>hipat_node <span class="keyword">of</span>
    <span class="keyword">|</span> HIPany <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hipatlst_is_unused hips <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [hipatlst_is_unused]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="5033"><span class="stacstdec">hiexplst_vt <span class="keyword">=</span> List_vt hiexp</span></a></span>

<span class="keyword">implement</span>
hiexp_is_empty <span class="keyword">(</span>hie0<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> hie0<span class="keyword">.</span>hiexp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HIEempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIErec <span class="keyword">(</span>
      knd<span class="keyword">,</span> _<span class="comment">(*hit_rec*)</span><span class="keyword">,</span> lhies
    <span class="keyword">)</span> <span class="keyword">when</span> knd <span class="keyword">=</span> 0 <span class="comment">(*flt*)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> lhies <span class="keyword">of</span>
    <span class="keyword">|</span> LABHIEXPLSTcons <span class="keyword">(</span>_<span class="comment">(*lab*)</span><span class="keyword">,</span> hie<span class="keyword">,</span> LABHIEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
        hiexp_is_empty hie
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="comment">// end of [hiexp_is_empty]
</span>
<span class="keyword">implement</span>
hiexp_seq_simplify <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> hit0<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> hies<span class="keyword">:</span> <span class="staexp">hiexplst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>hiexplst_vt</span><span class="keyword">,</span> hies<span class="keyword">:</span> <span class="staexp">hiexplst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> hies <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>hie<span class="keyword">,</span> hies<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> not <span class="keyword">(</span>hiexp_is_empty hie<span class="keyword">)</span> <span class="keyword">then</span> res := list_vt_cons <span class="keyword">(</span>hie<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        aux <span class="keyword">(</span>res<span class="keyword">,</span> hies<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [cons] *)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">hiexplst_vt</span> <span class="keyword">=</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>res<span class="keyword">,</span> hies<span class="keyword">)</span>
  <span class="keyword">val</span> hies_new <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_vt_reverse_list <span class="keyword">(</span>res<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> hies_new <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>hie1<span class="keyword">,</span> hies1_new<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> hies1_new <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> hiexp_seq <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hies_new<span class="keyword">)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hie1
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hiexp_seq_simplify]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> hiexplst_is_value
  <span class="keyword">(</span>hies<span class="keyword">:</span> <span class="staexp">hiexplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hies <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>hie<span class="keyword">,</span> hies<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> hiexp_is_value hie <span class="keyword">then</span> hiexplst_is_value hies <span class="keyword">else</span> false
    <span class="keyword">end</span> <span class="comment">(* end of [cons] *)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [hiexplst_is_value]
</span>
<span class="keyword">fun</span> labhiexplst_is_value
  <span class="keyword">(</span>lhies<span class="keyword">:</span> <span class="staexp">labhiexplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> lhies <span class="keyword">of</span>
  <span class="keyword">|</span> LABHIEXPLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> hie<span class="keyword">,</span> lhies<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> hiexp_is_value hie <span class="keyword">then</span> labhiexplst_is_value lhies <span class="keyword">else</span> false
    <span class="keyword">end</span> <span class="comment">(* end of [LABHIEXPLSTcons] *)</span>
  <span class="keyword">|</span> LABHIEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [labhiexplst_is_value]
</span>
<span class="keyword">implement</span>
hiexp_is_value
  <span class="keyword">(</span>hie0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> hie0<span class="keyword">.</span>hiexp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HIEbool _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEchar _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> hies<span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexplst_is_value hies
  <span class="keyword">|</span> HIEcst _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEempty _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> hie<span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexp_is_value hie
  <span class="keyword">|</span> HIEfloat _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIElam _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIElaminit _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIElst <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> hies<span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexplst_is_value hies
  <span class="keyword">|</span> HIEint _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIErec <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> lhies<span class="keyword">)</span> <span class="keyword">=&gt;</span> labhiexplst_is_value lhies
  <span class="keyword">|</span> HIEseq hies <span class="keyword">=&gt;</span> hiexplst_is_value hies
  <span class="keyword">|</span> HIEstring _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEtmpcst _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEtmpvar _ <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> HIEvar d2v <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> d2var_isfix_get d2v <span class="keyword">then</span> false <span class="keyword">else</span> true
    <span class="keyword">end</span> <span class="comment">// end of [HIEvar]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="comment">// end of [hiexp_is_value]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hiclau_is_bool_fst
  <span class="keyword">(</span>hicl<span class="keyword">:</span> <span class="staexp">hiclau</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt <span class="keyword">@(</span>bool<span class="keyword">,</span> hiexp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hicl<span class="keyword">.</span>hiclau_pat <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>hip<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hip<span class="keyword">.</span>hipat_node <span class="keyword">of</span>
    <span class="keyword">|</span> HIPbool b <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hicl<span class="keyword">.</span>hiclau_gua <span class="keyword">of</span>
      <span class="keyword">|</span> cons _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> nil _ <span class="keyword">=&gt;</span> Some_vt <span class="keyword">@(</span>b<span class="keyword">,</span> hicl<span class="keyword">.</span>hiclau_exp<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [HIPbool] *)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [cons (_, nil)] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [hiclau_is_bool_fst]
</span>
<span class="keyword">fn</span> hiclau_is_bool_snd
  <span class="keyword">(</span>hicl<span class="keyword">:</span> <span class="staexp">hiclau</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt hiexp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hicl<span class="keyword">.</span>hiclau_pat <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>hip<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hicl<span class="keyword">.</span>hiclau_gua <span class="keyword">of</span>
    <span class="keyword">|</span> cons _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> nil _ <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>hicl<span class="keyword">.</span>hiclau_exp<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [cons] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hiclau_is_bool_snd]
</span>
<span class="keyword">implement</span>
hiexp_caseof_if
  <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> hies<span class="keyword">,</span> hicls<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">hiexp_caseof_mac <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    hiexp_caseof <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> hies<span class="keyword">,</span> hicls<span class="keyword">)</span></span>
  <span class="comment">// end of [macdef]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> hies <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>hie<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hicls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>hicl1<span class="keyword">,</span> cons <span class="keyword">(</span>hicl2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> hiclau_is_bool_fst hicl1 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt bhie1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> hiclau_is_bool_snd hicl2 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt hie2 <span class="keyword">=&gt;</span>
            <span class="keyword">if</span> bhie1<span class="keyword">.</span>0 <span class="keyword">then</span> <span class="keyword">begin</span>
              hiexp_if <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie<span class="keyword">,</span> bhie1<span class="keyword">.</span>1<span class="keyword">,</span> hie2<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
              hiexp_if <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie<span class="keyword">,</span> hie2<span class="keyword">,</span> bhie1<span class="keyword">.</span>1<span class="keyword">)</span>
            <span class="keyword">end</span>
        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexp_caseof_mac <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexp_caseof_mac <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons (_, cons (_, nil _))]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hiexp_caseof_mac <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [cons (_, nil)]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hiexp_caseof_mac <span class="keyword">(</span><span class="keyword">)</span> 
<span class="keyword">end</span> <span class="comment">// end of [hiexp_case_if]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="9166"><span class="stacstdec">hibind</span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> HIBINDnone
  <span class="keyword">|</span> HIBINDsome_any <span class="keyword">of</span> <span class="staexp">hiexp</span>
  <span class="keyword">|</span> HIBINDsome_emp <span class="keyword">of</span> <span class="staexp">hiexp</span>
  <span class="keyword">|</span> HIBINDsome_var <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>d2var_t<span class="keyword">,</span> hiexp<span class="keyword">)</span></span>

<span class="keyword">fn</span> hidec_valdecs_is_singular <span class="keyword">(</span>hid<span class="keyword">:</span> <span class="staexp">hidec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hibind</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "hidec_is_singular_var: entering"; print_newline ()
  end
*)</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>hie_def<span class="keyword">:</span> <span class="staexp">hiexp</span><span class="keyword">,</span> hip<span class="keyword">:</span> <span class="staexp">hipat</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hibind</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
    val () = begin
      print "hidec_is_singular_var: hip = "; print hip; print_newline ()
    end
*)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> hip<span class="keyword">.</span>hipat_node <span class="keyword">of</span>
    <span class="keyword">|</span> HIPany <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> HIBINDsome_any hie_def
    <span class="keyword">|</span> HIPempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> HIBINDsome_emp <span class="keyword">(</span>hie_def<span class="keyword">)</span>
    <span class="keyword">|</span> HIPvar <span class="keyword">(</span>_<span class="comment">(*refknd=0*)</span><span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> HIBINDsome_var <span class="keyword">(</span>d2v<span class="keyword">,</span> hie_def<span class="keyword">)</span>
    <span class="keyword">|</span> HIPrec <span class="keyword">(</span>knd<span class="keyword">,</span> lhips<span class="keyword">,</span> _<span class="comment">(*hit_rec*)</span><span class="keyword">)</span> <span class="keyword">when</span> knd <span class="keyword">=</span> 0 <span class="comment">(*flt*)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> lhips <span class="keyword">of</span>
      <span class="keyword">|</span> LABHIPATLSTcons <span class="keyword">(</span>_<span class="comment">(*lab*)</span><span class="keyword">,</span> hip<span class="keyword">,</span> LABHIPATLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
          aux <span class="keyword">(</span>hie_def<span class="keyword">,</span> hip<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIBINDnone <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [HIPrec]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIBINDnone <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> hid<span class="keyword">.</span>hidec_node <span class="keyword">of</span>
  <span class="keyword">|</span> HIDvaldecs <span class="keyword">(</span>_<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>valdec<span class="keyword">.</span>hivaldec_def<span class="keyword">,</span> valdec<span class="keyword">.</span>hivaldec_pat<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIBINDnone <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIBINDnone <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hidec_valdecs_is_singular]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="10355"><span class="stacstdec">hiempvar</span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> HIEMPVARnone <span class="keyword">|</span> HIEMPVARsome_emp <span class="keyword">|</span> HIEMPVARsome_var <span class="keyword">of</span> <span class="staexp">d2var_t</span>
<span class="comment">// end of [hiempvar]
</span>
<span class="keyword">fun</span> hiexp_is_empvar
  <span class="keyword">(</span>hie<span class="keyword">:</span> <span class="staexp">hiexp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hiempvar</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> hie<span class="keyword">.</span>hiexp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HIEempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> HIEMPVARsome_emp
  <span class="keyword">|</span> HIEvar d2v <span class="keyword">=&gt;</span> HIEMPVARsome_var d2v
  <span class="keyword">|</span> HIErec <span class="keyword">(</span>knd<span class="keyword">,</span> hit_rec<span class="keyword">,</span> lhies<span class="keyword">)</span> <span class="keyword">when</span> knd <span class="keyword">=</span> 0 <span class="comment">(* flat *)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> lhies <span class="keyword">of</span>
    <span class="keyword">|</span> LABHIEXPLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> hie<span class="keyword">,</span> LABHIEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hiexp_is_empvar hie
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIEMPVARnone <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [HIErec]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> HIEMPVARnone <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [hiexp_is_empvar]
</span>
<span class="keyword">implement</span>
hiexp_let_simplify
  <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hids0<span class="keyword">,</span> hie0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">hie0_let <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> hiexp_let <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hids0<span class="keyword">,</span> hie0<span class="keyword">)</span></span>
  <span class="keyword">fun</span> aux_simplify
    <span class="keyword">(</span>hid0<span class="keyword">:</span> <span class="staexp">hidec</span><span class="keyword">,</span> hids<span class="keyword">:</span> <span class="staexp">hideclst</span><span class="keyword">,</span> hie0<span class="keyword">:</span> <span class="staexp">hiexp</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>    <span class="keyword">fun</span> aux_init_main
      <span class="keyword">(</span>hid0<span class="keyword">:</span> <span class="staexp">hidec</span><span class="keyword">,</span> hids<span class="keyword">:</span> <span class="staexp">hideclst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>hideclst? &gt;&gt; hideclst</span><span class="keyword">)</span>
      <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hids <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>hid<span class="keyword">,</span> hids<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := cons <span class="staexp"><span class="keyword">{</span>hidec<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>hid0<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">val+</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span> <span class="keyword">=</span> res
        <span class="keyword">in</span>
          aux_init_main <span class="keyword">(</span>hid<span class="keyword">,</span> hids<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span><span class="keyword">;</span> fold@ res
        <span class="keyword">end</span>
      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [aux_init_main]
</span><span class="comment">//
</span>    <span class="keyword">fun</span> aux_init <span class="keyword">(</span>
      hid0<span class="keyword">:</span> <span class="staexp">hidec</span><span class="keyword">,</span> hids<span class="keyword">:</span> <span class="staexp">hideclst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hideclst</span> <span class="keyword">=</span> res <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">hideclst</span> <span class="comment">// uninitialized
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_init_main <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [aux_init]
</span><span class="comment">//
</span>    <span class="keyword">fun</span> aux_last <span class="keyword">(</span>hid0<span class="keyword">:</span> <span class="staexp">hidec</span><span class="keyword">,</span> hids<span class="keyword">:</span> <span class="staexp">hideclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hidec</span> <span class="keyword">=</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> hids <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>hid<span class="keyword">,</span> hids<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_last <span class="keyword">(</span>hid<span class="keyword">,</span> hids<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hid0
    <span class="keyword">end</span> <span class="comment">// end of [aux_last]
</span><span class="comment">//
</span>  <span class="keyword">in</span>
    <span class="keyword">case+</span> hiexp_is_empvar hie0 <span class="keyword">of</span>
    <span class="keyword">|</span> HIEMPVARsome_emp <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hid_last <span class="keyword">=</span> aux_last <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
        <span class="keyword">val</span> bind <span class="keyword">=</span> hidec_valdecs_is_singular hid_last
      <span class="keyword">in</span>
        <span class="keyword">case+</span> bind <span class="keyword">of</span>
        <span class="keyword">|</span> HIBINDsome_any hie1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
          <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_is_void <span class="keyword">(</span>hie1<span class="keyword">.</span>hiexp_typ<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> init <span class="keyword">=</span> aux_init <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
            <span class="keyword">in</span>
              hiexp_let <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> init<span class="keyword">,</span> hie1<span class="keyword">)</span>
            <span class="keyword">end</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hie0_let <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [HIBINDsome_any]
</span>        <span class="keyword">|</span> HIBINDsome_emp hie1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> init <span class="keyword">=</span> aux_init <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
          <span class="keyword">in</span>
            hiexp_let <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> init<span class="keyword">,</span> hie1<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [HIBINDsome_emp]
</span>        <span class="keyword">|</span> HIBINDsome_var <span class="keyword">(</span>_<span class="keyword">,</span> hie1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
          <span class="keyword">|</span> _ <span class="keyword">when</span> hityp_is_void <span class="keyword">(</span>hie1<span class="keyword">.</span>hiexp_typ<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> init <span class="keyword">=</span> aux_init <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
            <span class="keyword">in</span>
              hiexp_let <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> init<span class="keyword">,</span> hie1<span class="keyword">)</span>
            <span class="keyword">end</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hie0_let <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [HIBINDsome_var]
</span>        <span class="keyword">|</span> HIBINDnone <span class="keyword">=&gt;</span> hie0_let <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [HIEMPVARsome_emp]
</span>    <span class="keyword">|</span> HIEMPVARsome_var d2v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hid_last <span class="keyword">=</span> aux_last <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
        <span class="keyword">val</span> bind <span class="keyword">=</span> hidec_valdecs_is_singular hid_last
      <span class="keyword">in</span>
        <span class="keyword">case+</span> bind <span class="keyword">of</span>
        <span class="keyword">|</span> HIBINDsome_var <span class="keyword">(</span>d2v1<span class="keyword">,</span> hie1<span class="keyword">)</span>
            <span class="keyword">when</span> <span class="keyword">(</span>eq_d2var_d2var <span class="keyword">(</span>d2v1<span class="keyword">,</span> d2v2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> init <span class="keyword">=</span> aux_init <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span>
          <span class="keyword">in</span>
            hiexp_let <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> init<span class="keyword">,</span> hie1<span class="keyword">)</span>
          <span class="keyword">end</span>
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hie0_let <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [HIEMPVARsome_var]
</span>    <span class="keyword">|</span> HIEMPVARnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hie0_let <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux_simplify]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> hids0 <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_simplify <span class="keyword">(</span>hid0<span class="keyword">,</span> hids<span class="keyword">,</span> hie0<span class="keyword">)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hie0
<span class="keyword">end</span> <span class="comment">// end of [hiexp_let_simplify]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">hityp_t <span class="keyword">=</span> hityp</span>
<span class="keyword">assume</span> <span class="staexp">hityplst_t <span class="keyword">=</span> hityplst</span>
<span class="keyword">assume</span> <span class="staexp">hityplstlst_t <span class="keyword">=</span> hityplstlst</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> hityp_encode <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> hit
<span class="keyword">implement</span> hityp_decode <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> hit

<span class="keyword">implement</span> hityplst_encode <span class="keyword">(</span>hits<span class="keyword">)</span> <span class="keyword">=</span> hits
<span class="keyword">implement</span> hityplst_decode <span class="keyword">(</span>hits<span class="keyword">)</span> <span class="keyword">=</span> hits

<span class="keyword">implement</span> hityplstlst_encode <span class="keyword">(</span>hitss<span class="keyword">)</span> <span class="keyword">=</span> hitss
<span class="keyword">implement</span> hityplstlst_decode <span class="keyword">(</span>hitss<span class="keyword">)</span> <span class="keyword">=</span> hitss

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> print_hityp_t <span class="keyword">(</span>hit<span class="keyword">)</span><span class="keyword">=</span>  print_hityp <span class="keyword">(</span>hit<span class="keyword">)</span>
<span class="keyword">implement</span> prerr_hityp_t <span class="keyword">(</span>hit<span class="keyword">)</span><span class="keyword">=</span>  prerr_hityp <span class="keyword">(</span>hit<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
hityplst_is_nil <span class="keyword">(</span>hits<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hits <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> false <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [hityplst_is_nil]
</span>
<span class="keyword">implement</span>
hityplst_is_cons <span class="keyword">(</span>hits<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hits <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityplst_is_cons]
</span>
<span class="keyword">implement</span>
hityplstlst_is_nil <span class="keyword">(</span>hitss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hitss <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> false <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [hityplstlst_is_nil]
</span>
<span class="keyword">implement</span>
hityplstlst_is_cons <span class="keyword">(</span>hitss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hitss <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [hityplstlst_is_cons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
// HX: this file must be loaded after [hityp_void] is defined
*)</span>
<span class="keyword">implement</span> hityp_t_ptr <span class="keyword">=</span> hityp_ptr
<span class="keyword">implement</span> hityp_t_void <span class="keyword">=</span> hityp_void <span class="comment">// so this file must be loaded
</span><span class="comment">//
</span><span class="keyword">implement</span> hityp_t_s2var <span class="keyword">(</span>s2v<span class="keyword">)</span> <span class="keyword">=</span> hityp_s2var <span class="keyword">(</span>s2v<span class="keyword">)</span>
<span class="keyword">implement</span> hityp_t_name_get <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> hit<span class="keyword">.</span>hityp_name
<span class="comment">//
</span><span class="keyword">implement</span> hityp_t_is_void <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> hityp_is_void <span class="keyword">(</span>hit<span class="keyword">)</span>
<span class="keyword">implement</span> hityp_t_fun_is_void <span class="keyword">(</span>hit_fun<span class="keyword">)</span> <span class="keyword">=</span> hityp_fun_is_void <span class="keyword">(</span>hit_fun<span class="keyword">)</span> 
<span class="keyword">implement</span> hityp_t_is_tyrecbox <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> hityp_is_tyrecbox <span class="keyword">(</span>hit_rec<span class="keyword">)</span>
<span class="keyword">implement</span> hityp_t_is_tyrecext <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> hityp_is_tyrecext <span class="keyword">(</span>hit_rec<span class="keyword">)</span>
<span class="keyword">implement</span> hityp_t_is_tyrecsin <span class="keyword">(</span>hit_rec<span class="keyword">)</span> <span class="keyword">=</span> hityp_is_tyrecsin <span class="keyword">(</span>hit_rec<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hityp_name_get <span class="keyword">(</span>hit<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> HITNAM <span class="keyword">(</span>knd<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> hit<span class="keyword">.</span>hityp_name
<span class="keyword">in</span>
  <span class="keyword">case+</span> 0 <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> knd &lt;= 0 <span class="keyword">=&gt;</span> name <span class="comment">(* flt_ext: ~1; flt: 0 *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> name <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> HITNAM <span class="keyword">(</span>_<span class="keyword">,</span> name<span class="keyword">)</span> <span class="keyword">=</span> hityp_ptr<span class="keyword">.</span>hityp_name
    <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [hityp_name_get]
</span>
<span class="keyword">implement</span>
hityp_tyrec_make
  <span class="keyword">(</span>recknd<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> lnames <span class="keyword">=</span> aux lhits <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> aux <span class="keyword">(</span>lhits<span class="keyword">:</span> <span class="staexp">labhityplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labstrlst</span> <span class="keyword">=</span> <span class="keyword">case+</span> lhits <span class="keyword">of</span>
      <span class="keyword">|</span> LABHITYPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hit<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          LABSTRLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hityp_name_get hit<span class="keyword">,</span> aux lhits<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [LABHITYPLSTcons]
</span>      <span class="keyword">|</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABSTRLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> name_rec <span class="keyword">=</span> typdefmap_find <span class="keyword">(</span>TYPKEYrec lnames<span class="keyword">)</span>
  <span class="keyword">val</span> fltboxknd <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> recknd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">val</span> hit_rec <span class="keyword">=</span> hityp_tyrec <span class="keyword">(</span>fltboxknd<span class="keyword">,</span> name_rec<span class="keyword">,</span> lhits<span class="keyword">)</span>
<span class="keyword">in</span>
  hityp_encode <span class="keyword">(</span>hit_rec<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hityp_tyrec_make]
</span>
<span class="keyword">implement</span>
hityp_tysum_make
  <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> hits_arg <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
      val () = begin
        print "hityp_tysum_make: d2c = "; print d2c; print_newline ();
        print "hityp_tysum_make: hits_arg = "; print hits_arg; print_newline ()
      end // end of [val]
*)</span>
      <span class="keyword">val</span> names_arg <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>hits_arg<span class="keyword">,</span> hityp_name_get<span class="keyword">)</span>
      <span class="keyword">val</span> s2c <span class="keyword">=</span> d2con_scst_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
      <span class="keyword">val</span> tag <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d2c <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_singular s2c <span class="keyword">=&gt;</span> 0
        <span class="keyword">|</span> _ <span class="keyword">when</span> s2cst_is_listlike s2c <span class="keyword">=&gt;</span> 0
        <span class="keyword">|</span> _ <span class="keyword">when</span> d2con_is_exn d2c <span class="keyword">=&gt;</span> ~1
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> 1
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span>
      <span class="keyword">val</span> name_sum <span class="keyword">=</span> typdefmap_find <span class="keyword">(</span>TYPKEYsum <span class="keyword">(</span>tag<span class="keyword">,</span> names_arg<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> hit_sum <span class="keyword">=</span> hityp_tysum <span class="keyword">(</span>name_sum<span class="keyword">,</span> d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      hityp_encode <span class="keyword">(</span>hit_sum<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      hityp_encode <span class="keyword">(</span>hityp_tysum_ptr<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [hityp_tysum_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> hityp_normalize_flag
  <span class="keyword">(</span>hit0<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hityp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "hityp_normalize_flag: hit0 = "; print_hityp hit0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> hit0_new <span class="keyword">=</span> <span class="keyword">case+</span> hit0<span class="keyword">.</span>hityp_node <span class="keyword">of</span>
  <span class="keyword">|</span> HITfun <span class="keyword">(</span>fc<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hityplst_normalize_flag <span class="keyword">(</span>hits_arg<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> hit_res <span class="keyword">=</span> hityp_normalize_flag <span class="keyword">(</span>hit_res<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> hityp_fun <span class="keyword">(</span>fc<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span> <span class="keyword">else</span> hit0
    <span class="keyword">end</span> <span class="comment">// end of [HITfun]
</span>  <span class="keyword">|</span> HITtyrectemp <span class="keyword">(</span>fltboxknd<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> lhits <span class="keyword">=</span> labhityplst_normalize_flag <span class="keyword">(</span>lhits<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      flag := flag + 1<span class="keyword">;</span> hityp_tyrec_make <span class="keyword">(</span>fltboxknd<span class="keyword">,</span> lhits<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [HITtyrectemp]
</span>  <span class="keyword">|</span> HITtysumtemp <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hityplst_normalize_flag <span class="keyword">(</span>hits_arg<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      flag := flag + 1<span class="keyword">;</span> hityp_tysum_make <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [HITtysumtemp]
</span>  <span class="keyword">|</span> HITtyrecsin hit <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> hit <span class="keyword">=</span> hityp_normalize_flag <span class="keyword">(</span>hit<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> hityp_tyrecsin hit <span class="keyword">else</span> hit0
    <span class="keyword">end</span> <span class="comment">// end of [HITtyrecsin]
</span>  <span class="keyword">|</span> HITrefarg <span class="keyword">(</span>refval<span class="keyword">,</span> hit_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="keyword">if</span> refval <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// call-by-value
</span>        <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
        <span class="keyword">val</span> hit_arg <span class="keyword">=</span> hityp_normalize_flag <span class="keyword">(</span>hit_arg<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> hityp_refarg <span class="keyword">(</span>0<span class="keyword">,</span> hit_arg<span class="keyword">)</span> <span class="keyword">else</span> hit0
      <span class="keyword">end</span> <span class="keyword">else</span> hit0
    <span class="comment">// end of [HITrefarg]
</span>  <span class="keyword">|</span> HITs2var s2v <span class="keyword">=&gt;</span> hit0_new <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> hit0_new <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> hityp_s2var_normalize <span class="keyword">(</span>s2v<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt hit <span class="keyword">=&gt;</span> <span class="keyword">(</span>flag := flag + 1<span class="keyword">;</span> hit<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hit0
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span>
    <span class="keyword">}</span> <span class="comment">// end of [HITs2var]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hit0 <span class="comment">// end of [_]
</span><span class="comment">(*
  val () = begin
    print "hityp_normalize: hit0_new = "; print_hityp hit0_new; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  hit0_new
<span class="keyword">end</span> <span class="comment">// end of [hityp_normalize_flag]
</span>
<span class="keyword">and</span> hityplst_normalize_flag <span class="keyword">(</span>
  hits0<span class="keyword">:</span> <span class="staexp">hityplst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> hits0 <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> hit <span class="keyword">=</span> hityp_normalize_flag <span class="keyword">(</span>hit<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> hits <span class="keyword">=</span> hityplst_normalize_flag <span class="keyword">(</span>hits<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> hits<span class="keyword">)</span> <span class="keyword">else</span> hits0
    <span class="keyword">end</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hityplst_normalize_flag]
</span>  
<span class="keyword">and</span> labhityplst_normalize_flag <span class="keyword">(</span>
  lhits0<span class="keyword">:</span> <span class="staexp">labhityplst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhityplst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> lhits0 <span class="keyword">of</span>
  <span class="keyword">|</span> LABHITYPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hit<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> hit <span class="keyword">=</span> hityp_normalize_flag <span class="keyword">(</span>hit<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> lhits <span class="keyword">=</span> labhityplst_normalize_flag <span class="keyword">(</span>lhits<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> LABHITYPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hit<span class="keyword">,</span> lhits<span class="keyword">)</span> <span class="keyword">else</span> lhits0
    <span class="keyword">end</span> <span class="comment">// end of [LABHITYPLSTcons]
</span>  <span class="keyword">|</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labhityplst_normalize_flag]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
hityp_normalize <span class="keyword">(</span>hit<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">in</span> hityp_normalize_flag <span class="keyword">(</span>hit<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [hityp_normalize]
</span>
<span class="keyword">implement</span>
hityplst_normalize <span class="keyword">(</span>hits<span class="keyword">)</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>hits<span class="keyword">,</span> hityp_normalize<span class="keyword">)</span>
<span class="comment">// end of [hityplst_normalize]
</span>
<span class="keyword">implement</span>
hityplstlst_normalize <span class="keyword">(</span>hitss<span class="keyword">)</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>hitss<span class="keyword">,</span> hityplst_normalize<span class="keyword">)</span>
<span class="comment">// end of [hityplstlst_normalize]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d2cst_hityp_get_some
  <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hitopt <span class="keyword">=</span> d2cst_hityp_get <span class="keyword">(</span>d2c<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> hitopt <span class="keyword">of</span>
  <span class="keyword">|</span> Some hit <span class="keyword">=&gt;</span> hit
  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": d2cst_hityp_get_some: d2c = "
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_d2cst <span class="keyword">(</span>d2c<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hityp_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None]
</span><span class="keyword">end</span> <span class="comment">// end of [d2cst_hityp_get_some]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="20691"><span class="stacstdec">tmpdef <span class="keyword">=</span> <span class="keyword">'{</span>
  tmpdef_arg<span class="keyword">=</span> s2qualst<span class="keyword">,</span> tmpdef_exp<span class="keyword">=</span> hiexp
<span class="keyword">}</span></span></a></span> <span class="comment">// end of [tmpdef]
</span>
<span class="keyword">assume</span> <span class="staexp">tmpdef_t <span class="keyword">=</span> tmpdef</span>

<span class="keyword">fn</span> _tmpdef_make
  <span class="keyword">(</span>arg<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">,</span> hie<span class="keyword">:</span> <span class="staexp">hiexp</span><span class="keyword">)</span>
<span class="keyword">:</span> <span class="staexp">tmpdef</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  tmpdef_arg<span class="keyword">=</span> arg<span class="keyword">,</span> tmpdef_exp<span class="keyword">=</span> hie
<span class="keyword">}</span> <span class="comment">// end of [tmpdef_make]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span> tmpdef_make
  <span class="keyword">(</span>arg<span class="keyword">,</span> hie<span class="keyword">)</span> <span class="keyword">=</span> _tmpdef_make <span class="keyword">(</span>arg<span class="keyword">,</span> hie<span class="keyword">)</span>
<span class="comment">// end of [tmpdef_make]
</span>
<span class="keyword">implement</span> tmpdef_arg_get <span class="keyword">(</span>def<span class="keyword">)</span> <span class="keyword">=</span> def<span class="keyword">.</span>tmpdef_arg
<span class="keyword">implement</span> tmpdef_exp_get <span class="keyword">(</span>def<span class="keyword">)</span> <span class="keyword">=</span> def<span class="keyword">.</span>tmpdef_exp

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span>
<span class="staexp"><a name="21182"><span class="stacstdec">tmpcstmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>d2cst_t<span class="keyword">,</span> tmpdef_t<span class="keyword">)</span></span></a></span>

<span class="keyword">fn</span> tmpcstmap_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">tmpcstmap</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_make <span class="keyword">(</span>compare_d2cst_d2cst<span class="keyword">)</span>
<span class="comment">// end of [tmpcstmap_nil]
</span>
<span class="keyword">val</span> the_tmpcstmap <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">tmpcstmap</span><span class="keyword">&gt;</span> <span class="keyword">(</span>tmpcstmap_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span>
tmpcstmap_add
  <span class="keyword">(</span>d2c<span class="keyword">,</span> decarg<span class="keyword">,</span> hie_def<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tmpdef <span class="keyword">=</span> tmpdef_make <span class="keyword">(</span>decarg<span class="keyword">,</span> hie_def<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_tmpcstmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> d2c<span class="keyword">,</span> tmpdef<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpcstmap_add]
</span>
<span class="keyword">implement</span>
tmpcstmap_find <span class="keyword">(</span>d2c<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_tmpcstmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_search <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> d2c<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpcstmap_find]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">viewtypedef</span>
<span class="staexp"><a name="21872"><span class="stacstdec">tmpvarmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>d2var_t<span class="keyword">,</span> tmpdef_t<span class="keyword">)</span></span></a></span>

<span class="keyword">fn</span> tmpvarmap_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">tmpvarmap</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_make <span class="keyword">(</span>compare_d2var_d2var<span class="keyword">)</span>
<span class="comment">// end of [tmpvarmap_nil]
</span>
<span class="keyword">val</span> the_tmpvarmap <span class="keyword">=</span>
  ref_make_elt&lt;<span class="staexp">tmpvarmap</span><span class="keyword">&gt;</span> <span class="keyword">(</span>tmpvarmap_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [val]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span>
tmpvarmap_add <span class="keyword">(</span>
  d2v<span class="keyword">,</span> decarg<span class="keyword">,</span> hie_def
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tmpdef <span class="keyword">=</span> tmpdef_make <span class="keyword">(</span>decarg<span class="keyword">,</span> hie_def<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_tmpvarmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> d2v<span class="keyword">,</span> tmpdef<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpvarmap_add]
</span>
<span class="keyword">implement</span>
tmpvarmap_find <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> ref_get_view_ptr <span class="keyword">(</span>the_tmpvarmap<span class="keyword">)</span>
<span class="keyword">in</span>
  $Map<span class="keyword">.</span>map_search <span class="keyword">(</span><span class="keyword">!</span>p<span class="keyword">,</span> d2v<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpvarmap_find]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_hiexp_util.dats] *)</span>
</pre>
</body>
</html>
