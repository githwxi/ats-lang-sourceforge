<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of linear queues based on lists
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// staload "prelude/SATS/slseg.sats" // automatically loaded
</span><span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "prelude/DATS/slseg.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absviewtype</span> <span class="staexp"><A name="466"><span class="stacstdec">linqueuelst_vt</span></span></A>
  <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype <span class="comment">(*element*)</span><span class="keyword">,</span> n<span class="keyword">:</span>int <span class="comment">(*size*)</span><span class="keyword">)</span>

<span class="keyword">stadef</span> <span class="staexp"><A name="533"><span class="stacstdec">queue <span class="keyword">=</span> linqueuelst_vt</span></span></A> <span class="comment">// an abbreviation
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// always inline
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="627"><span class="dyncstdec">linqueuelst_nil <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">queue <span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">)</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// always inline
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="728"><span class="dyncstdec">linqueuelst_is_nil <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>n==0<span class="keyword">)</span></span></span></A>

<span class="comment">// always inline
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="837"><span class="dyncstdec">linqueuelst_is_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>n <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="963"><span class="dyncstdec">linqueuelst_enqueue <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="comment">// O(1)
</span>  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span> &gt;&gt; queue <span class="keyword">(</span>a<span class="keyword">,</span> n+1<span class="keyword">)</span></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1078"><span class="dyncstdec">linqueuelst_dequeue <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="comment">// O(1)
</span>  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span> &gt;&gt; queue <span class="keyword">(</span>a<span class="keyword">,</span> n-1<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// only allowed for a queue storing nonlinear elements.
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1259"><span class="dyncstdec">linqueuelst_fst <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1356"><span class="dyncstdec">linqueuelst_size <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1454"><span class="dyncstdec">linqueuelst_free <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">//
</span><span class="comment">// [list_vt_of_linqueuelst] is O(1)-time
</span><span class="comment">//
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1601"><span class="dyncstdec">list_vt_of_linqueuelst <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [extern]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1736"><span class="dyncstdec">linqueuelst_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo1<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  <A name="1877"><span class="dyncstdec">linqueuelst_foreach_cloref <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>queue <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref1<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><A name="2032"><span class="stacstdec">queuelst_vt <span class="keyword">(</span>a<span class="keyword">:</span>viewt@ype+<span class="keyword">,</span> int<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">l1<span class="keyword">,</span>l2<span class="keyword">,</span>l3<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    queuelst_vt_some <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      slseg_v <span class="keyword">(</span>a<span class="keyword">,</span> l1<span class="keyword">,</span> l2<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">,</span> free_gc_v <span class="keyword">(</span><span class="keyword">@(</span>a<span class="keyword">,</span> ptr<span class="keyword">)</span><span class="keyword">,</span> l2<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">(</span>a<span class="keyword">,</span> ptr?<span class="keyword">)</span> @ l2 <span class="keyword">|</span> int n<span class="keyword">,</span> ptr l1<span class="keyword">,</span> ptr l2
    <span class="keyword">)</span></span> <span class="comment">// end of [queuelst_vt_some]
</span>  <span class="keyword">|</span> queuelst_vt_none <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span>

<span class="keyword">assume</span> <span class="staexp">linqueuelst_vt <span class="keyword">(</span>a<span class="keyword">:</span> viewt@ype<span class="keyword">,</span> n<span class="keyword">:</span> int<span class="keyword">)</span> <span class="keyword">=</span> queuelst_vt <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linqueuelst_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linqueuelst_is_nil <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> queuelst_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="keyword">|</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> false<span class="keyword">)</span>
  <span class="keyword">|</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> true<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linqueuelst_is_nil]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linqueuelst_is_cons <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> queuelst_vt_some <span class="keyword">(</span><span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp">_</span> <span class="keyword">|</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> true<span class="keyword">)</span>
  <span class="keyword">|</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> false<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linqueuelst_is_cons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> linqueuelst_size <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> queuelst_vt_some
      <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_seg</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="comment">(*pf_gc*)</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="comment">(*pf_at*)</span> <span class="keyword">|</span> n<span class="keyword">,</span> _<span class="comment">(*p1*)</span><span class="keyword">,</span> _<span class="comment">(*p2*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> n + 1<span class="keyword">)</span>
  <span class="keyword">|</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ xs<span class="keyword">;</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linqueuelst_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> linqueuelst_enqueue <span class="keyword">(</span>xs<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="3171"><span class="stacstdec">VT <span class="keyword">=</span> <span class="keyword">@(</span>a<span class="keyword">,</span> ptr<span class="keyword">)</span></span></span></A> <span class="keyword">and</span> <span class="staexp"><A name="3190"><span class="stacstdec">VT0 <span class="keyword">=</span> <span class="keyword">@(</span>a<span class="keyword">,</span> ptr?<span class="keyword">)</span></span></span></A>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_gc_new</span><span class="keyword">,</span> <span class="prfexp">pf_at_new</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span> ptr_alloc&lt;<span class="staexp">VT</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_new<span class="keyword">-&gt;</span>0 := x
<span class="keyword">in</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> queuelst_vt_some
      <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_seg_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_gc_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_at_r</span> <span class="keyword">|</span> <span class="keyword">!</span>n_r<span class="keyword">,</span> p1<span class="keyword">,</span> <span class="keyword">!</span>p2_r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">stavar</span> <span class="staexp">l2<span class="keyword">:</span> addr</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_seg <span class="keyword">=</span> <span class="keyword">!</span>pf_seg_r</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_gc <span class="keyword">=</span> <span class="keyword">!</span>pf_gc_r <span class="keyword">and</span> pf_at <span class="keyword">=</span> <span class="keyword">!</span>pf_at_r<span class="keyword">:</span> <span class="staexp">VT0 @ l2</span></span>
      <span class="keyword">val</span> p2 <span class="keyword">=</span> <span class="keyword">!</span>p2_r<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p2<span class="keyword">-&gt;</span>1 := p_new
      <span class="keyword">prval</span> <span class="prfexp">pf_seg_new <span class="keyword">=</span> slseg_v_extend <span class="keyword">(</span>pf_seg<span class="keyword">,</span> pf_gc<span class="keyword">,</span> pf_at<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>pf_seg_r := pf_seg_new<span class="keyword">;</span> <span class="keyword">!</span>pf_gc_r := pf_gc_new<span class="keyword">;</span> <span class="keyword">!</span>pf_at_r := pf_at_new
      <span class="keyword">end</span></span> <span class="comment">// end of [prval]
</span>    <span class="keyword">in</span>
      <span class="keyword">!</span>n_r := <span class="keyword">!</span>n_r + 1<span class="keyword">;</span> <span class="keyword">!</span>p2_r := p_new<span class="keyword">;</span> fold@ xs
    <span class="keyword">end</span> <span class="comment">// end of [queuelst_vt_some]
</span>  <span class="keyword">|</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      xs := queuelst_vt_some <span class="keyword">(</span><span class="prfexp">slseg_v_nil <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf_gc_new</span><span class="keyword">,</span> <span class="prfexp">pf_at_new</span> <span class="keyword">|</span> 0<span class="keyword">,</span> p_new<span class="keyword">,</span> p_new<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [queuelst_vt_none]
</span><span class="keyword">end</span> <span class="comment">// end of [linqueuelst_enqueue]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> linqueuelst_dequeue <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="4084"><span class="stacstdec">VT <span class="keyword">=</span> <span class="keyword">@(</span>a<span class="keyword">,</span> ptr<span class="keyword">)</span></span></span></A>
  <span class="keyword">val+</span> queuelst_vt_some <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_seg_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_gc_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_at_r</span> <span class="keyword">|</span> <span class="keyword">!</span>n_r<span class="keyword">,</span> <span class="keyword">!</span>p1_r<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> xs
  <span class="keyword">prval</span> <span class="prfexp">pf_seg <span class="keyword">=</span> <span class="keyword">!</span>pf_seg_r</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>n_r <span class="keyword">and</span> p1 <span class="keyword">=</span> <span class="keyword">!</span>p1_r
<span class="keyword">in</span>
  <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">slseg_v_cons <span class="keyword">(</span>pf_gc<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_seg<span class="keyword">)</span> <span class="keyword">=</span> pf_seg</span>
    <span class="keyword">val</span> x <span class="keyword">=</span> p1<span class="keyword">-&gt;</span>0<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p1_r := p1<span class="keyword">-&gt;</span>1
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ptr_free <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> p1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">!</span>pf_seg_r := pf_seg<span class="keyword">;</span> <span class="keyword">!</span>n_r := n - 1<span class="keyword">;</span> fold@ xs<span class="keyword">;</span> x
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">slseg_v_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_seg</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_gc <span class="keyword">=</span> <span class="keyword">!</span>pf_gc_r <span class="keyword">and</span> pf_at <span class="keyword">=</span> <span class="keyword">!</span>pf_at_r</span>
    <span class="keyword">val</span> x <span class="keyword">=</span> p2<span class="keyword">-&gt;</span>0<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ptr_free <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> p2<span class="keyword">)</span>
  <span class="keyword">in</span>
    free@ <span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span> <span class="keyword">{</span>0<span class="keyword">}</span> <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">;</span> xs := queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> x
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [linqueuelst_deqeue]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> linqueuelst_fst <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> queuelst_vt_some <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_seg_r</span><span class="keyword">,</span> <span class="prfexp">_</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_at_r</span> <span class="keyword">|</span> n<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> xs
<span class="keyword">in</span>
  <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">slseg_v_cons <span class="keyword">(</span>pf1_gc<span class="keyword">,</span> pf1_at<span class="keyword">,</span> pf1_seg<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>pf_seg_r</span><span class="keyword">;</span> <span class="keyword">val</span> x <span class="keyword">=</span> p1<span class="keyword">-&gt;</span>0
  <span class="keyword">in</span>
    <span class="keyword">!</span>pf_seg_r := slseg_v_cons <span class="keyword">(</span>pf1_gc<span class="keyword">,</span> pf1_at<span class="keyword">,</span> pf1_seg<span class="keyword">)</span><span class="keyword">;</span> fold@ xs<span class="keyword">;</span> x
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_at <span class="keyword">=</span> <span class="keyword">!</span>pf_at_r</span><span class="keyword">;</span> <span class="keyword">val</span> x <span class="keyword">=</span> p2<span class="keyword">-&gt;</span>0 <span class="keyword">in</span> <span class="keyword">!</span>pf_at_r := pf_at<span class="keyword">;</span> fold@ xs<span class="keyword">;</span> x
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [linqueuelst_fst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> linqueuelst_free <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>queuelst_vt_some <span class="keyword">(</span><span class="prfexp">pf_seg</span><span class="keyword">,</span> <span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> n<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">typedef</span> <span class="staexp"><A name="5334"><span class="stacstdec">T <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> ptr?<span class="keyword">)</span></span></span></A>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ptr_free <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> p2<span class="keyword">)</span>
    <span class="keyword">in</span>     
        slseg_free&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_seg</span> <span class="keyword">|</span> p1<span class="keyword">,</span> n<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [queuelst_vt_some]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [linqueuelst_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> list_vt_of_linqueuelst <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>queuelst_vt_some <span class="keyword">(</span><span class="prfexp">pf_seg</span><span class="keyword">,</span> <span class="prfexp">pf_gc</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> _<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">viewtypedef</span> <span class="staexp"><A name="5703"><span class="stacstdec">VT <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> ptr?<span class="keyword">)</span></span></span></A>
      <span class="keyword">stavar</span> <span class="staexp">l2<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp">pf_at <span class="keyword">=</span> pf_at<span class="keyword">:</span> <span class="staexp">VT @ l2</span></span>
    <span class="keyword">in</span>
      p2<span class="keyword">-&gt;</span>1 := null<span class="keyword">;</span> list_vt_of_sllst <span class="keyword">(</span><span class="prfexp">slseg_v_extend <span class="keyword">(</span>pf_seg<span class="keyword">,</span> pf_gc<span class="keyword">,</span> pf_at<span class="keyword">)</span></span> <span class="keyword">|</span> p1<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">~</span>queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [list_vt_of_linqueuelst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> linqueuelst_foreach_clo <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> queuelst_vt_some <span class="keyword">(</span><span class="prfexp"><span class="keyword">!</span>pf_seg_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_gc_r</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_at_r</span> <span class="keyword">|</span> n<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_at <span class="keyword">=</span> <span class="keyword">!</span>pf_at_r</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> slseg_foreach_clo&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp"><span class="keyword">!</span>pf_seg_r</span> <span class="keyword">|</span> p1<span class="keyword">,</span> n<span class="keyword">,</span> f<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p2<span class="keyword">-&gt;</span>0<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">!</span>pf_at_r := pf_at<span class="keyword">;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> queuelst_vt_none <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ <span class="keyword">(</span>xs<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linqueuelst_foreach_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
  linqueuelst_foreach_cloref <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><A name="6448"><span class="stacstdec">clo_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> <span class="keyword">&amp;</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo1<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_f</span> <span class="keyword">|</span> p_f<span class="keyword">)</span> <span class="keyword">=</span> cloref_get_view_ptr <span class="staexp"><span class="keyword">{</span>clo_type<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>linqueuelst_foreach_clo&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> <span class="keyword">!</span>p_f<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linqueuelst_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [linqueuelst.dats] *)</span>
</PRE>
</BODY>
</HTML>
