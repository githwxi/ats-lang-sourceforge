<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: October 2008
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// HX: A linear map implementation based on randomized binary search trees
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#include &lt;stdlib.h&gt;
%}</span> <span class="comment">// end of [%{^]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_map_lin.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="1745"><span class="stacstdec">bst <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>t@ype+<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat</span><span class="keyword">}</span> BSTcons <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 1<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nl<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nr<span class="keyword">)</span></span> <span class="keyword">of</span>
      <span class="staexp"><span class="keyword">(</span><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> <span class="keyword">(</span>1<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nl<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nr<span class="keyword">)</span><span class="keyword">,</span> key<span class="keyword">,</span> itm<span class="keyword">,</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<span class="keyword">)</span><span class="keyword">,</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nr<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> BSTnil <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">)</span></span>
<span class="comment">// end of [bst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> bst_free <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> tl<span class="keyword">,</span> tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bst_free tl<span class="keyword">;</span> bst_free tr<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [bst_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  bst_size <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> n</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>n<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> n<span class="keyword">)</span> <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> 0<span class="keyword">)</span> 
<span class="comment">// end of [bst_size]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_is_empty <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#14947"><span class="stacstuse">bool</span></a> <span class="keyword">(</span>n <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7896"><span class="stacstuse">==</span></a> 0<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#4371"><span class="dyncstuse">false</span></a><span class="keyword">)</span> <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#4327"><span class="dyncstuse">true</span></a><span class="keyword">)</span>
<span class="comment">// end of [bst_is_empty]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_insert_atroot <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  t<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
<span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span>
<span class="keyword">,</span> i0<span class="keyword">:</span> <span class="staexp">itm</span>
<span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> _<span class="comment">(*i*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> cmp <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">)</span> &lt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> tl_new <span class="keyword">=</span> bst_insert_atroot <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val+</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> kl<span class="keyword">,</span> _<span class="comment">(*il*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tll<span class="keyword">,</span> <span class="keyword">!</span>p_tlr<span class="keyword">)</span> <span class="keyword">=</span> tl_new
        <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_n<span class="keyword">;</span> <span class="keyword">val</span> nll <span class="keyword">=</span> bst_size <span class="keyword">!</span>p_tll
      <span class="keyword">in</span>
        <span class="keyword">!</span>p_tl := <span class="keyword">!</span>p_tlr<span class="keyword">;</span> <span class="keyword">!</span>p_n := n - nll<span class="keyword">;</span> fold@ t<span class="keyword">;</span>
        <span class="keyword">!</span>p_tlr := t<span class="keyword">;</span> <span class="keyword">!</span>p_nl := n + 1<span class="keyword">;</span> fold@ tl_new<span class="keyword">;</span> tl_new
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> tr_new <span class="keyword">=</span> bst_insert_atroot <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span>
        <span class="keyword">val+</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nr<span class="keyword">,</span> kr<span class="keyword">,</span> _<span class="comment">(*ir*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">,</span> <span class="keyword">!</span>p_trr<span class="keyword">)</span> <span class="keyword">=</span> tr_new
        <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_n<span class="keyword">;</span> <span class="keyword">val</span> nrr <span class="keyword">=</span> bst_size <span class="keyword">!</span>p_trr
      <span class="keyword">in</span>
        <span class="keyword">!</span>p_tr := <span class="keyword">!</span>p_trl<span class="keyword">;</span> <span class="keyword">!</span>p_n := n - nrr<span class="keyword">;</span> fold@ t<span class="keyword">;</span>
        <span class="keyword">!</span>p_trl := t<span class="keyword">;</span> <span class="keyword">!</span>p_nr := n + 1<span class="keyword">;</span> fold@ tr_new<span class="keyword">;</span> tr_new
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      BSTcons <span class="keyword">(</span>1<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [BSTnil] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [bst_insert_atroot] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_search <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> itm</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> ans <span class="keyword">=</span> bst_search <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans <span class="keyword">end</span>
    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> ans <span class="keyword">=</span> bst_search <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans <span class="keyword">end</span>
    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> ans <span class="keyword">=</span> Some_vt i <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [bst_search] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^

ats_bool_type
atsopt_map_lin_dice (
  ats_int_type m, ats_int_type n
) {
  double r = drand48 ();
  return ((m+n)*r &lt; m) ? ats_true_bool : ats_false_bool ;
} // end of [ats_map_lin_dice]

%}</span> <span class="comment">// end of [%{^]
</span><span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="4404"><span class="dyncstdec">dice <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>int <span class="keyword">|</span> m <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7606"><span class="stacstuse"><span class="keyword">&gt;</span></span></a> 0<span class="keyword">;</span> n <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7606"><span class="stacstuse"><span class="keyword">&gt;</span></span></a> 0<span class="keyword">}</span></span>
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> n</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#14977"><span class="stacstuse">bool</span></a></span></span></a> <span class="keyword">=</span> "atsopt_map_lin_dice"
<span class="comment">// end of [dice]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_insert_random <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  t<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
<span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span>
<span class="keyword">,</span> i0<span class="keyword">:</span> <span class="staexp">itm</span>
<span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> _<span class="comment">(*i*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
    <span class="keyword">if</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#4404"><span class="dyncstuse">dice</span></a> <span class="keyword">(</span>1<span class="keyword">,</span> <span class="keyword">!</span>p_n<span class="keyword">)</span> <span class="keyword">then</span>
      <span class="keyword">(</span>fold@ t<span class="keyword">;</span> bst_insert_atroot <span class="keyword">(</span>t<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> cmp <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">)</span> &lt;= 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_tl := bst_insert_random <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n + 1<span class="keyword">;</span> fold@ t<span class="keyword">;</span> t
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_tr := bst_insert_random <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n + 1<span class="keyword">;</span> fold@ t<span class="keyword">;</span> t
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      BSTcons <span class="keyword">(</span>1<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [BSTnil] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [bst_insert_random] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_join_random
  <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>nl<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nr<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  tl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<span class="keyword">)</span></span>
<span class="keyword">,</span> tr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nr<span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>nr<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> tl <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> kl<span class="keyword">,</span> il<span class="keyword">,</span> <span class="keyword">!</span>p_tll<span class="keyword">,</span> <span class="keyword">!</span>p_tlr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> tr <span class="keyword">of</span>
    <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nr<span class="keyword">,</span> kr<span class="keyword">,</span> ir<span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">,</span> <span class="keyword">!</span>p_trr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_nl + <span class="keyword">!</span>p_nr
      <span class="keyword">in</span>
        <span class="keyword">if</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#4404"><span class="dyncstuse">dice</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> <span class="keyword">!</span>p_nr<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
          fold@ tr<span class="keyword">;</span> <span class="keyword">!</span>p_tlr := bst_join_random <span class="keyword">(</span><span class="keyword">!</span>p_tlr<span class="keyword">,</span> tr<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">!</span>p_nl := n<span class="keyword">;</span> fold@ tl<span class="keyword">;</span> tl
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          fold@ tl<span class="keyword">;</span> <span class="keyword">!</span>p_trl := bst_join_random <span class="keyword">(</span>tl<span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">!</span>p_nr := n<span class="keyword">;</span> fold@ tr<span class="keyword">;</span> tr
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ tl<span class="keyword">;</span> tl<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> tr
<span class="keyword">end</span> <span class="comment">// end of [bst_join_random]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// the function [bst_remove_random] can be implemented more elegantly by
</span><span class="comment">// exploiting the existential quantifier #[...] as follows:
</span><span class="comment">// {n:nat} (
</span><span class="comment">//   t: bst (key, itm, n)
</span><span class="comment">// , k0: key
</span><span class="comment">// , r1: &amp;Int? &gt;&gt; int i
</span><span class="comment">// , r2: &amp;Option_vt itm? &gt;&gt; option_vt (itm, i &gt; 0)
</span><span class="comment">// ) : #[i:two | i &lt;= n] bst (key, itm, n-i)
</span><span class="comment">//
</span><span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_remove_random
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l1<span class="keyword">,</span>l2<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#16501"><span class="stacstuse">Int</span></a>? <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l1</span></span>
<span class="keyword">,</span> <span class="prfexp">pf2<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> <span class="keyword">(</span>itm<span class="keyword">)</span>? <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l2</span></span>
<span class="keyword">|</span> t<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
<span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> p1<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> l1</span>
<span class="keyword">,</span> p2<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> l2</span>
<span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>i<span class="keyword">:</span>two <span class="keyword">|</span> i <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7823"><span class="stacstuse">&lt;=</span></a> n<span class="keyword">]</span> <span class="keyword">(</span>
  <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> i <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l1<span class="keyword">,</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22973"><span class="stacstuse">option_vt</span></a> <span class="keyword">(</span>itm<span class="keyword">,</span> i <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7606"><span class="stacstuse"><span class="keyword">&gt;</span></span></a> 0<span class="keyword">)</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l2 <span class="keyword">|</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#5059"><span class="stacstuse">-</span></a>i<span class="keyword">)</span>
<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">}</span></span>
      <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> cmp <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">i<span class="keyword">:</span>int</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> tl_new<span class="keyword">)</span> <span class="keyword">=</span>
          bst_remove_random <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n - <span class="keyword">!</span>p1<span class="keyword">;</span> <span class="keyword">!</span>p_tl := tl_new<span class="keyword">;</span> fold@ t<span class="keyword">;</span> <span class="staexp"><span class="keyword">#[</span>i <span class="keyword">|</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> t<span class="keyword">)</span><span class="keyword">]</span>
      <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>    <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">i<span class="keyword">:</span>int</span><span class="keyword">]</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> tr_new<span class="keyword">)</span> <span class="keyword">=</span>
          bst_remove_random <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> <span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> p1<span class="keyword">,</span> p2<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n - <span class="keyword">!</span>p1<span class="keyword">;</span> <span class="keyword">!</span>p_tr := tr_new<span class="keyword">;</span> fold@ t<span class="keyword">;</span> <span class="staexp"><span class="keyword">#[</span>i <span class="keyword">|</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> t<span class="keyword">)</span><span class="keyword">]</span>
      <span class="keyword">end</span> <span class="comment">// end of [1]
</span>    <span class="keyword">|</span>  0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> t_new <span class="keyword">=</span> bst_join_random <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">!</span>p1 := 1<span class="keyword">;</span> <span class="keyword">!</span>p2 := Some_vt i<span class="keyword">;</span> free@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">}</span> <span class="keyword">(</span>t<span class="keyword">)</span><span class="keyword">;</span>
        <span class="staexp"><span class="keyword">#[</span>1 <span class="keyword">|</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> t_new<span class="keyword">)</span><span class="keyword">]</span>
      <span class="keyword">end</span> <span class="comment">// end of [0]
</span>    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">!</span>p1 := 0<span class="keyword">;</span> <span class="keyword">!</span>p2 := None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> fold@ t<span class="keyword">;</span> <span class="staexp"><span class="keyword">#[</span>0 <span class="keyword">|</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> t<span class="keyword">)</span><span class="keyword">]</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTnil]
</span><span class="keyword">end</span> <span class="comment">// end of [bst_remove_random]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_select
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>s<span class="keyword">:</span>nat <span class="keyword">|</span> s <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#7751"><span class="stacstuse"><span class="keyword">&lt;</span></span></a> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> s<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> s</span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">itm</span> <span class="keyword">=</span> <span class="keyword">let</span> 
  <span class="keyword">val</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=</span> t
  <span class="keyword">val</span> nl <span class="keyword">=</span> bst_size <span class="keyword">!</span>p_tl
<span class="keyword">in</span>
  <span class="keyword">case+</span> compare <span class="keyword">(</span>s<span class="keyword">,</span> nl<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> bst_select&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> s<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">(</span>t<span class="keyword">)</span><span class="keyword">;</span> ans
    <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>  <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> bst_select&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> s-nl-1<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">(</span>t<span class="keyword">)</span><span class="keyword">;</span> ans
    <span class="keyword">end</span> <span class="comment">// end of [ 1]
</span>  <span class="keyword">|</span>  _ <span class="comment">(* 0 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">(</span>t<span class="keyword">)</span><span class="keyword">;</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [bst_select]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// infix order listing
</span><span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_list_inf <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
  t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a> <span class="keyword">(</span><span class="keyword">@(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span><span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="8345"><span class="stacstdec">ki <span class="keyword">=</span> <span class="keyword">@(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></a></span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#8345"><span class="stacstuse">ki</span></a><span class="keyword">,</span> j<span class="keyword">)</span></span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#8345"><span class="stacstuse">ki</span></a><span class="keyword">,</span> i<a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#4972"><span class="stacstuse">+</span></a>j<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ki <span class="keyword">=</span> <span class="keyword">(</span>k<span class="keyword">,</span> i<span class="keyword">)</span>
        <span class="keyword">val</span> res <span class="keyword">=</span> aux <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> list_vt_cons <span class="keyword">(</span>ki<span class="keyword">,</span> aux <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        fold@ t<span class="keyword">;</span> res
      <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>    <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> res<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>t<span class="keyword">,</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [bst_list_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// infix order foreach
</span><span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
bst_foreach_inf
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
<span class="keyword">|</span> t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a></span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
<span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> itm<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span>
<span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
<span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> k<span class="keyword">,</span> i<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_tr<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ t
    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ t
<span class="keyword">end</span> <span class="comment">// end of [bst_foreach_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span>
<span class="staexp"><a name="9361"><span class="stacstdec">map <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>t@ype+<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> MAP <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a><span class="keyword">,</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">assume</span> <span class="staexp">map_vt <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#9361"><span class="stacstuse">map</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1706"><span class="dyncstimp">map_make</span></a> <span class="keyword">(</span>cmp<span class="keyword">)</span> <span class="keyword">=</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">item</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1870"><span class="dyncstimp">map_free</span></a> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">let</span> <span class="keyword">val+</span> <span class="keyword">~</span>MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> bst<span class="keyword">)</span> <span class="keyword">=</span> m <span class="keyword">in</span> bst_free bst <span class="keyword">end</span>
<span class="comment">// end of [map_free]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">item</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1981"><span class="dyncstimp">map_cleanup</span></a> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m <span class="keyword">in</span>
  bst_free <span class="keyword">!</span>p_bst<span class="keyword">;</span> <span class="keyword">!</span>p_bst := BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> fold@ m
<span class="keyword">end</span> <span class="comment">// end of [map_cleanup]
</span>  
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2271"><span class="dyncstimp">map_search</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m
  <span class="keyword">val</span> ans <span class="keyword">=</span> bst_search&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_bst<span class="keyword">,</span> k<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">in</span>
  fold@ m<span class="keyword">;</span> ans
<span class="keyword">end</span> <span class="comment">// end of [map_search]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2066"><span class="dyncstimp">map_insert</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m <span class="keyword">in</span>
  <span class="keyword">!</span>p_bst := bst_insert_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_bst<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> cmp<span class="keyword">)</span><span class="keyword">;</span> fold@ m
<span class="keyword">end</span> <span class="comment">// end of [map_insert]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2168"><span class="dyncstimp">map_remove</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m
  <span class="keyword">var</span> status<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15410"><span class="stacstuse">int</span></a></span> <span class="keyword">and</span> itmopt<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> itm</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> bst_new<span class="keyword">)</span> <span class="keyword">=</span> bst_remove_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
    <span class="keyword">(</span><span class="prfexp">view@ status</span><span class="keyword">,</span> <span class="prfexp">view@ itmopt</span> <span class="keyword">|</span> <span class="keyword">!</span>p_bst<span class="keyword">,</span> k<span class="keyword">,</span> <span class="keyword">&amp;</span>status<span class="keyword">,</span> <span class="keyword">&amp;</span>itmopt<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ status := pf1 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ itmopt := pf2</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p_bst := bst_new<span class="keyword">;</span> fold@ m<span class="keyword">;</span> itmopt
<span class="keyword">end</span> <span class="comment">// end of [map_remove]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2374"><span class="dyncstimp">map_join</span></a> <span class="keyword">(</span>m1<span class="keyword">,</span> m2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="10638"><span class="stacstdec">cmp_t <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#17046"><span class="stacstuse">Sgn</span></a></span></a></span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>t0<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> m<span class="keyword">)</span></span><span class="keyword">,</span> t<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#10638"><span class="stacstuse">cmp_t</span></a></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>m<span class="keyword">:</span>nat<span class="keyword">]</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2edats.html#1745"><span class="stacstuse">bst</span></a> <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> m<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> t <span class="keyword">of</span> <span class="comment">// it is done in infix order
</span>    <span class="keyword">|</span> <span class="keyword">~</span>BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> tl<span class="keyword">,</span> tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> t0 <span class="keyword">where</span> <span class="keyword">{</span>
         <span class="keyword">val</span> t0 <span class="keyword">=</span> aux <span class="keyword">(</span>t0<span class="keyword">,</span> tl<span class="keyword">,</span> cmp<span class="keyword">)</span>
         <span class="keyword">var</span> status<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#15410"><span class="stacstuse">int</span></a></span> <span class="keyword">and</span> itmopt<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> itm</span>
         <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> t0<span class="keyword">)</span> <span class="keyword">=</span> bst_remove_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
           <span class="keyword">(</span><span class="prfexp">view@ status</span><span class="keyword">,</span> <span class="prfexp">view@ itmopt</span> <span class="keyword">|</span> t0<span class="keyword">,</span> k<span class="keyword">,</span> <span class="keyword">&amp;</span>status<span class="keyword">,</span> <span class="keyword">&amp;</span>itmopt<span class="keyword">,</span> cmp<span class="keyword">)</span>
         <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ status := pf1 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ itmopt := pf2</span>
         <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> itmopt <span class="keyword">of</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
         <span class="keyword">val</span> t0 <span class="keyword">=</span> bst_insert_random <span class="keyword">(</span>t0<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">,</span> cmp<span class="keyword">)</span>
         <span class="keyword">val</span> t0 <span class="keyword">=</span> aux <span class="keyword">(</span>t0<span class="keyword">,</span> tr<span class="keyword">,</span> cmp<span class="keyword">)</span>
       <span class="keyword">}</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t0
  <span class="comment">// end of [aux]
</span>  <span class="keyword">val+</span> MAP <span class="keyword">(</span>cmp<span class="keyword">,</span> <span class="keyword">!</span>p_t1<span class="keyword">)</span> <span class="keyword">=</span> m1<span class="keyword">;</span> <span class="keyword">val+</span> <span class="keyword">~</span>MAP <span class="keyword">(</span>_<span class="comment">(*cmp*)</span><span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=</span> m2
<span class="keyword">in</span>
  <span class="keyword">!</span>p_t1 := aux <span class="keyword">(</span><span class="keyword">!</span>p_t1<span class="keyword">,</span> t2<span class="keyword">,</span> cmp<span class="keyword">)</span><span class="keyword">;</span> fold@ m1<span class="keyword">;</span> m1
<span class="keyword">end</span> <span class="comment">// end of [map_join]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2546"><span class="dyncstimp">map_list_inf</span></a> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>_<span class="comment">(*cmp*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> bst_list_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">!</span>p_bst
<span class="keyword">in</span>
  fold@ <span class="keyword">(</span>m<span class="keyword">)</span><span class="keyword">;</span> ans
<span class="keyword">end</span> <span class="comment">// end of [map_list_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2663"><span class="dyncstimp">map_foreach_inf</span></a> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> MAP <span class="keyword">(</span>_<span class="comment">(*cmp*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_bst<span class="keyword">)</span> <span class="keyword">=</span> m
  <span class="keyword">val</span> ans <span class="keyword">=</span> bst_foreach_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>p_bst<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">in</span>
  fold@ <span class="keyword">(</span>m<span class="keyword">)</span><span class="keyword">;</span> ans
<span class="keyword">end</span> <span class="comment">// end of [map_foreach_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_map_lin.dats] *)</span>
</pre>
</body>
</html>
