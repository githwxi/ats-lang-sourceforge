<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: January 2008
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">SOL <span class="keyword">=</span> "ats_staexp2_solve.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_stadyncst2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp3.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_trans3_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_trans3.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">overload</span> prerr <span class="keyword">with</span> $Loc<span class="keyword">.</span>prerr_location</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_loc_error3 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">(</span>$Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(3)"<span class="keyword">)</span>
<span class="comment">// end of [prerr_loc_error3]
</span>
<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_trans3_view)"

<span class="keyword">fn</span> prerr_loc_interror <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": INTERNAL ERROR (ats_trans3_view)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_interror]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_addr_viewat_slablst_try
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0_addr<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0_ft<span class="keyword">)</span> <span class="keyword">=</span> s2exp_addr_normalize s2e0_addr
  <span class="keyword">val</span> s2ls0 <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_append <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls0<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> the_d2varset_env_find_viewat <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ans <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>d2v_view<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2e_addr<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">)</span> <span class="keyword">=</span> ans
      <span class="keyword">var</span> cstr<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2ls_bk <span class="keyword">=</span> s2exp_slablst_lintry_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> cstr<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2lablst_trim_s2lablst_s2lablst <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">fun</span> aux <span class="keyword">(</span>s2ls<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
        <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>prerr "."<span class="keyword">;</span> prerr_s2lab s2l<span class="keyword">;</span> aux s2ls<span class="keyword">)</span>
        <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="comment">// end of [aux]
</span>    <span class="keyword">in</span>
      prerr_loc_error3 loc0<span class="keyword">;</span>
      prerr ": there is no view at ["<span class="keyword">;</span> prerr s2r0<span class="keyword">;</span> aux s2ls0<span class="keyword">;</span> prerr "]"<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_addr_viewat_slablst_try]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_addr_viewat_slablst_get
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0_addr<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0_ft<span class="keyword">)</span> <span class="keyword">=</span> s2exp_addr_normalize s2e0_addr
  <span class="keyword">val</span> s2ls0 <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_append <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls0<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> the_d2varset_env_find_viewat <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ans <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>d2v_view<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2e_addr<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">)</span> <span class="keyword">=</span> ans
      <span class="keyword">var</span> cstr<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span>s2e_out<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        s2exp_slablst_lindel_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_typ_reset_at <span class="keyword">(</span>d2v_view<span class="keyword">,</span> s2e_vt<span class="keyword">,</span> s2e_addr<span class="keyword">)</span>
      <span class="keyword">val</span> s2ls0_bk <span class="keyword">=</span> <span class="keyword">begin</span>
        s2lablst_trim_s2lablst_s2lablst <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> s2e_at <span class="keyword">=</span> <span class="keyword">begin</span>
        s2exp_at_viewt0ype_addr_view <span class="keyword">(</span>s2e_out<span class="keyword">,</span> s2exp_projlst <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0_bk<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="keyword">@(</span>s2e_at<span class="keyword">,</span> s2ls0_bk<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">fun</span> aux <span class="keyword">(</span>s2ls<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
        <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>prerr "."<span class="keyword">;</span> prerr_s2lab s2l<span class="keyword">;</span> aux s2ls<span class="keyword">)</span>
        <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="comment">// end of [aux]
</span>    <span class="keyword">in</span>
      prerr_loc_error3 loc0<span class="keyword">;</span>
      prerr ": there is no view at ["<span class="keyword">;</span> prerr s2r0<span class="keyword">;</span> aux s2ls0<span class="keyword">;</span> prerr "]"<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_addr_viewat_slablst_get]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_addr_viewat_slablst_set
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0_addr<span class="keyword">,</span> s2ls0<span class="keyword">,</span> s2e_new_at<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">@(</span>s2e_new<span class="keyword">,</span> s2e_new_addr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> un_s2exp_at_viewt0ype_addr_view s2e_new_at <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>s2ts2a<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2ts2a
    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the view ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr s2e_new_at
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] is expected to be an @-view"
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="keyword">,</span> s2exp<span class="keyword">)</span></span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0_ft<span class="keyword">)</span> <span class="keyword">=</span> s2exp_addr_normalize s2e0_addr
  <span class="keyword">val</span> s2ls0 <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_append <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls0<span class="keyword">)</span>
  <span class="keyword">val</span> ansopt <span class="keyword">=</span> the_d2varset_env_find_viewat <span class="keyword">(</span>s2r0<span class="keyword">,</span> s2ls0<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> ansopt <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt <span class="keyword">(</span>ans<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>
        d2v_view<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e_addr<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk_nt
      <span class="keyword">)</span> <span class="keyword">=</span> ans
      <span class="keyword">val</span> _<span class="comment">(*is_local_llam*)</span> <span class="keyword">=</span>
        the_d2varset_env_d2var_is_llam_local <span class="keyword">(</span>d2v_view<span class="keyword">)</span>
      <span class="comment">// end of [val]
</span><span class="comment">//
</span>      <span class="keyword">var</span> cstr<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">@(</span>s2e_old<span class="keyword">,</span> s2e<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        s2exp_slablst_linset_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e<span class="keyword">,</span> s2ls_bk_nt<span class="keyword">,</span> s2e_new<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> cstr<span class="keyword">)</span>
<span class="comment">//
</span>      <span class="keyword">val</span> s2e_old_addr <span class="keyword">=</span> s2exp_projlst <span class="keyword">(</span>s2e_addr<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> s2exp_syneq <span class="keyword">(</span>
           s2e_old_addr<span class="keyword">,</span> s2e_new_addr
        <span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": address mismatch for @-view assignment: ["<span class="keyword">;</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp s2e_old_addr
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] &lt;&gt; ["
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp s2e_new_addr
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "]."
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> s2ls0_bk <span class="keyword">=</span> <span class="keyword">begin</span>
        s2lablst_trim_s2lablst_s2lablst <span class="keyword">(</span>s2ls0_ft<span class="keyword">,</span> s2ls_ft<span class="keyword">,</span> s2ls_bk<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_typ_reset_at <span class="keyword">(</span>d2v_view<span class="keyword">,</span> s2e<span class="keyword">,</span> s2e_addr<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $SOL<span class="keyword">.</span>s2exp_out_void_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_old<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2ls0_bk
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>  prerr ": the @-view associated with the location ["
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr s2r0
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] cannot be found."
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2lablst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_addr_viewat_slablst_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d2var_view_viewat_slablst_set_main
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span>
   d2v_view<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span>
   s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span>
   s2e0_addr<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span>
   s2ls_view<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">,</span>
   s2e_new_at<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="comment">(*old*)</span><span class="keyword">,</span> s2lablst<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e_new_at <span class="keyword">=</span> s2exp_whnf s2e_new_at
  <span class="keyword">typedef</span> <span class="staexp"><a name="7370"><span class="stacstdec">s2exp2 <span class="keyword">=</span> <span class="keyword">@(</span>s2exp<span class="keyword">,</span> s2exp<span class="keyword">)</span></span></a></span>
  <span class="keyword">val</span> <span class="keyword">@(</span>s2e_new<span class="keyword">,</span> s2e_new_addr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span>
    un_s2exp_at_viewt0ype_addr_view s2e_new_at <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2ts2a <span class="keyword">=&gt;</span> s2ts2a
    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the view ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr s2e_new_at
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] is expected to be an @-view"
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp2<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp2</span> <span class="comment">// end of [val]
</span>  <span class="keyword">var</span> cstr<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">@(</span>s2e_old<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span>
    s2exp_slablst_linset_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls_view<span class="keyword">,</span> s2e_new<span class="keyword">,</span> cstr<span class="keyword">)</span>
  <span class="keyword">val</span> s2e_old_addr <span class="keyword">=</span> s2exp_projlst <span class="keyword">(</span>s2e0_addr<span class="keyword">,</span> s2ls<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> trans3_env_add_proplst <span class="keyword">(</span>loc0<span class="keyword">,</span> cstr<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>  <span class="keyword">if</span> s2exp_syneq
    <span class="keyword">(</span>s2e_old_addr<span class="keyword">,</span> s2e_new_addr<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": address mismatch for @-view restoration: ["
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp s2e_old_addr
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] &lt;&gt; ["
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp s2e_new_addr
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "]."
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_typ_reset_at <span class="keyword">(</span>d2v_view<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2e0_addr<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>s2e_old<span class="keyword">,</span> s2ls<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end [d2var_view_viewat_slablst_set_main]
</span>
<span class="keyword">fn</span> d2var_view_viewat_slablst_set
  <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2v_view<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">s2lablst</span><span class="keyword">,</span> s2e_new_at<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>s2exp <span class="comment">(*old*)</span><span class="keyword">,</span> s2lablst<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> d2var_typ_get d2v_view <span class="keyword">of</span>
  <span class="keyword">|</span> Some s2e_at <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">case+</span>
    un_s2exp_at_viewt0ype_addr_view s2e_at <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2ts2a <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        d2var_view_viewat_slablst_set_main
          <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ts2a<span class="keyword">.</span>0<span class="keyword">,</span> s2ts2a<span class="keyword">.</span>1<span class="keyword">,</span> s2ls<span class="keyword">,</span> s2e_new_at<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error3 loc0
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the view of ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_d2var d2v_view
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] is expected to be an @-view but it is ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp s2e_at
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] instead."
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>    <span class="keyword">)</span> <span class="comment">// end [Some]
</span>  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_void_t0ype <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> s2e0_addr <span class="keyword">=</span> d2var_addr_get_some <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v_view<span class="keyword">)</span>
    <span class="keyword">in</span>
      d2var_view_viewat_slablst_set_main
        <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2e0_addr<span class="keyword">,</span> s2ls<span class="keyword">,</span> s2e_new_at<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None]
</span><span class="keyword">end</span> <span class="comment">// end of [d2var_view_viewat_slablst_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2lab0lst_of_d3lab1lst <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>d3ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>d3lab1<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">case+</span> d3ls <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>d3l<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2l <span class="keyword">=</span> <span class="keyword">case+</span> d3l<span class="keyword">.</span>d3lab1_node <span class="keyword">of</span>
        <span class="keyword">|</span> D3LAB1ind <span class="keyword">(</span>d3ess<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> S2LAB0ind <span class="keyword">(</span>d3explstlst_ind_get d3ess<span class="keyword">)</span>
        <span class="keyword">|</span> D3LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> S2LAB0lab l
    <span class="keyword">in</span>
      list_cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2lab0lst_of_d3lab1lst d3ls<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d3exp_lval_typ_set
  <span class="keyword">(</span>loc0<span class="keyword">,</span> refval<span class="keyword">,</span> d3e0<span class="keyword">,</span> s2e_new<span class="keyword">,</span> err<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "d3exp_lval_typ_set: d3e0 = "; print d3e0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">fn</span> refval_check <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> refval<span class="keyword">:</span> <span class="staexp">int</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> 
    <span class="keyword">if</span> refval <span class="keyword">&gt;</span> 1 <span class="keyword">then</span> <span class="keyword">begin</span>
      prerr_loc_error3 loc0<span class="keyword">;</span>
      prerr ": the dynamic variable ["<span class="keyword">;</span> prerr d2v<span class="keyword">;</span>
      prerr "] is required to be mutable in order to support call-by-reference."<span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [refval_check]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> d3e0<span class="keyword">.</span>d3exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> D3Eann_type <span class="keyword">(</span>d3e<span class="keyword">,</span> _<span class="comment">(*s2e_ann*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      d3exp_lval_typ_set <span class="keyword">(</span>loc0<span class="keyword">,</span> refval<span class="keyword">,</span> d3e<span class="keyword">,</span> s2e_new<span class="keyword">,</span> err<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eann_type]
</span>  <span class="keyword">|</span> D3Esel_ptr <span class="keyword">(</span>d3e<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> un_s2exp_ptr_addr_type d3e<span class="keyword">.</span>d3exp_typ <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e_addr <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2ls_nt <span class="keyword">=</span> s2lab0lst_of_d3lab1lst d3ls
        <span class="keyword">val</span> _<span class="comment">(* s2lablst *)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
          s2exp_addr_slablst_assgn <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_addr<span class="keyword">,</span> s2ls_nt<span class="keyword">,</span> s2e_new<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        <span class="comment">(* empty *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_interror loc0<span class="keyword">;</span>
        prerr ": d3exp_lval_typ_set: D3Esel_ptr"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Esel_ptr]
</span>  <span class="keyword">|</span> D3Esel_var <span class="keyword">(</span>d2v<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">when</span> d2var_is_linear d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> refval_check <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> refval<span class="keyword">)</span>
      <span class="keyword">val</span> s2ls_nt <span class="keyword">=</span> s2lab0lst_of_d3lab1lst d3ls
      <span class="keyword">val</span> _<span class="comment">(* s2lablst *)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_lin_slablst_assgn <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> s2ls_nt<span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">(* empty *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esel_var when d2var_is_linear]
</span>  <span class="keyword">|</span> D3Esel_var <span class="keyword">(</span>d2v<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">when</span> d2var_is_mutable d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2ls_nt <span class="keyword">=</span> s2lab0lst_of_d3lab1lst d3ls
      <span class="keyword">val</span> _<span class="comment">(* s2lablst *)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_mut_slablst_assgn <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> s2ls_nt<span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">(* empty *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esel_var when d2var_is_mutable]
</span><span class="comment">//
</span>  <span class="keyword">|</span> D3Evar d2v <span class="keyword">when</span> d2var_isfix_get <span class="keyword">(</span>d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := err + 1<span class="keyword">)</span> 
  <span class="keyword">|</span> D3Evar d2v <span class="keyword">when</span> d2var_is_mutable d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> _ <span class="comment">(* nil *)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_mut_slablst_assgn <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">(* empty *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D2Evar when d2var_is_mutable]
</span><span class="comment">(*
//
// HX-2010-10-20:
// there is no need for checking that [d2v] is linear:
// if [d2v] is not linear, then it cannot be updated!!!
//
*)</span>
  <span class="keyword">|</span> D3Evar d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> refval_check <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> refval<span class="keyword">)</span>
      <span class="keyword">val</span> _<span class="comment">(* nil *)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_lin_slablst_assgn <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="comment">(* empty *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D2Evar]
</span><span class="comment">//
</span>  <span class="keyword">|</span> D3Eviewat_ptr <span class="keyword">(</span>d3e<span class="keyword">,</span> d3ls<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ls_nt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span>s2e_old<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_view_viewat_slablst_set <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ls_nt<span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      $SOL<span class="keyword">.</span>s2exp_out_void_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_old<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_ptr]
</span>  <span class="keyword">|</span> D3Eviewat_var <span class="keyword">(</span>d2v<span class="keyword">,</span> d3ls<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ls_nt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span>s2e_old<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        d2var_view_viewat_slablst_set <span class="keyword">(</span>loc0<span class="keyword">,</span> d2v_view<span class="keyword">,</span> s2ls_nt<span class="keyword">,</span> s2e_new<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      $SOL<span class="keyword">.</span>s2exp_out_void_solve <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e_old<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_var]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := err + 1<span class="keyword">)</span>
  <span class="comment">// end of [case]
</span><span class="keyword">end</span> <span class="comment">(* end of [d3exp_lval_typ_set] *)</span>

<span class="keyword">fn</span> s2exp_fun_is_freeptr
  <span class="keyword">(</span>s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Efun <span class="keyword">(</span>fc<span class="keyword">,</span> lin<span class="keyword">,</span> _<span class="comment">(*s2fe*)</span><span class="keyword">,</span> _<span class="comment">(*npf*)</span><span class="keyword">,</span> _<span class="comment">(*arg*)</span><span class="keyword">,</span> _<span class="comment">(*res*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> fc <span class="keyword">of</span>
    <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo knd <span class="keyword">when</span> knd &lt;&gt; 0 <span class="keyword">=&gt;</span> <span class="keyword">if</span> lin <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> false <span class="keyword">else</span> true
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Efun]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [s2exp_fun_is_freeptr]
</span>
<span class="keyword">implement</span>
d3exp_lval_typ_set_arg
  <span class="keyword">(</span>refval<span class="keyword">,</span> d3e0<span class="keyword">,</span> s2e_new<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> d3e0<span class="keyword">.</span>d3exp_loc<span class="keyword">;</span> <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> freeknd<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="comment">// free the expression if it is set to 1
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_lval_typ_set <span class="keyword">(</span>loc0<span class="keyword">,</span> refval<span class="keyword">,</span> d3e0<span class="keyword">,</span> s2e_new<span class="keyword">,</span> err<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> s2exp_is_nonlin <span class="keyword">(</span>s2e_new<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// HX: safely discarded!
</span>    <span class="keyword">|</span> _ <span class="keyword">when</span> s2exp_fun_is_freeptr s2e_new <span class="keyword">=&gt;</span> <span class="keyword">(</span>freeknd := 1<span class="keyword">)</span>
      <span class="comment">// end of [_ when ...]
</span>    <span class="keyword">|</span> _  <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the dynamic expression needs to be a left-value but it is not."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">end</span><span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  freeknd <span class="comment">// a linear value must be freed (freeknd = 1) if it cannot be returned
</span><span class="keyword">end</span> <span class="comment">(* end of [d3exp_lval_typ_set_arg] *)</span>

<span class="keyword">implement</span>
d3exp_lval_typ_set_pat <span class="keyword">(</span>d3e0<span class="keyword">,</span> p3t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> p3t<span class="keyword">.</span>p3at_typ_lft <span class="keyword">of</span>
  <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> loc0 <span class="keyword">=</span> d3e0<span class="keyword">.</span>d3exp_loc<span class="keyword">;</span> <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_lval_typ_set <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*val*)</span><span class="keyword">,</span> d3e0<span class="keyword">,</span> s2e<span class="keyword">,</span> err<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": the dynamic expression needs to be a left-value but it is not."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [None]
</span><span class="keyword">end</span> <span class="comment">// end of [d3exp_lval_typ_set_pat]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_trans3_view.dats] *)</span>
</pre>
</body>
</html>
