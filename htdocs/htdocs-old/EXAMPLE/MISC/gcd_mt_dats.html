<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">//
</span><span class="comment">// A multithreaded implementation of GCD in coroutine-style
</span><span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: March 10, 2008
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/SATS/pthread.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "libc/DATS/pthread.dats"</span>
<span class="keyword">staload</span> <span class="staexp">"libc/SATS/pthread_uplock.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">abstype</span> <span class="staexp"><a name="318"><span class="stacstdec">pthread_mutexref_viewt0ype_type</span></a></span> <span class="keyword">(</span>a<span class="keyword">:</span> viewt@ype<span class="keyword">)</span>

<span class="keyword">stadef</span> <span class="staexp"><a name="373"><span class="stacstdec">mutexref_t <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#318"><span class="stacstuse">pthread_mutexref_viewt0ype_type</span></a></span></a></span>

<span class="keyword">absview</span> <span class="staexp"><a name="427"><span class="stacstdec">pthread_mutexref_unlock_ticket_viewt0ype_addr_view</span></a></span>
  <span class="keyword">(</span>viewt@ype<span class="keyword">,</span> addr<span class="keyword">)</span>

<span class="keyword">stadef</span> <span class="staexp"><a name="506"><span class="stacstdec">mutexref_unlock_ticket <span class="keyword">=</span> 
  <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#427"><span class="stacstuse">pthread_mutexref_unlock_ticket_viewt0ype_addr_view</span></a></span></a></span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <a name="610"><span class="dyncstdec">pthread_mutexref_create <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#373"><span class="stacstuse">mutexref_t</span></a> a</span></span></a>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="667"><span class="dyncstdec">pthread_mutexref_create_tsz <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>a <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l &gt;&gt; a? <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> l</span><span class="keyword">,</span> tsz<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#17306"><span class="stacstuse">sizeof_t</span></a> a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#373"><span class="stacstuse">mutexref_t</span></a> a</span></span></a>
  <span class="keyword">=</span> "atslib_pthread_mutexref_create_tsz"

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="838"><span class="dyncstdec">pthread_mutexref_lock
  <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>mtxrf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#373"><span class="stacstuse">mutexref_t</span></a> a</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>l<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#506"><span class="stacstuse">mutexref_unlock_ticket</span></a> <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span><span class="keyword">,</span> a <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l <span class="keyword">|</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> l<span class="keyword">)</span></span></span></a>
  <span class="keyword">=</span> "atslib_pthread_mutexref_lock"

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1005"><span class="dyncstdec">pthread_mutexref_unlock <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">_tick<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#506"><span class="stacstuse">mutexref_unlock_ticket</span></a> <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">_at<span class="keyword">:</span> <span class="staexp">a <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> l</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> l</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span></span></a>
  <span class="keyword">=</span> "atslib_pthread_mutexref_unlock"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
<a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#610"><span class="dyncstimp">pthread_mutexref_create</span></a> <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> x <span class="keyword">=</span> x
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#667"><span class="dyncstuse">pthread_mutexref_create_tsz</span></a> <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">view@ <span class="keyword">(</span>x<span class="keyword">)</span></span> <span class="keyword">|</span> <span class="keyword">&amp;</span>x<span class="keyword">,</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#4021"><span class="dyncstuse">sizeof&lt;</span></a><span class="staexp">a</span><span class="keyword">&gt;</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [pthread_mutexref_create]
</span>
<span class="extern">%{^

//
// HX-2010-03-28: this style cannot safely support GC
//
typedef struct {
  pthread_mutex_t mutex ; void* value[0] ;
} pthread_mutexref_struct ;

/* ****** ****** */

static inline
ats_ptr_type
atslib_pthread_mutexref_create_tsz
  (ats_ptr_type p_x, ats_size_type tsz) {
  pthread_mutexref_struct *p ;
  p = ATS_MALLOC(sizeof (pthread_mutexref_struct) + tsz) ;
  pthread_mutex_init (&amp;(p-&gt;mutex), NULL) ;
  memcpy (&amp;(p-&gt;value), p_x, (size_t)tsz) ;
  return p ;
} // end of [atslib_pthread_mutexref_create_tsz]

static inline
ats_ptr_type
atslib_pthread_mutexref_lock
  (ats_ptr_type p0) {
  pthread_mutexref_struct *p = p0 ;
  pthread_mutex_lock (&amp;(p-&gt;mutex)) ;
  return &amp;(p-&gt;value) ;
} // end of [atslib_pthread_mutexref_lock]

static inline
ats_void_type
atslib_pthread_mutexref_unlock
  (ats_ptr_type p_value) {
  pthread_mutex_unlock (
    (pthread_mutex_t*)((char*)p_value - sizeof(pthread_mutexref_struct))
  ) ;
  return ;
} // end of [atslib_pthread_mutexref_unlock]

%}</span> <span class="comment">// end of [%{^]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2383"><span class="dyncstdec"><span class="prfexp">gcd_lemma0 <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>z<span class="keyword">:</span>nat<span class="keyword">]</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2448"><span class="dyncstdec"><span class="prfexp">gcd_lemma1 <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">,</span>z<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#5059"><span class="stacstuse">-</span></a> y<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2528"><span class="dyncstdec"><span class="prfexp">gcd_lemma2 <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">,</span>z<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#5059"><span class="stacstuse">-</span></a> x<span class="keyword">,</span> z<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2608"><span class="dyncstdec"><span class="prfexp">gcd_lemma3 <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>nat<span class="keyword">;</span>z<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> x<span class="keyword">,</span> z<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>x <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#7896"><span class="stacstuse">==</span></a> z<span class="keyword">]</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span></span></span></a>

<span class="comment">//
</span>
<span class="keyword">viewdef</span> <span class="staexp"><a name="2686"><span class="stacstdec">gcd_v <span class="keyword">(</span>a<span class="keyword">:</span>addr<span class="keyword">,</span> b<span class="keyword">:</span>addr<span class="keyword">,</span> z<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>x<span class="keyword">,</span>y<span class="keyword">:</span>pos<span class="keyword">]</span> <span class="keyword">@(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> x <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> a<span class="keyword">,</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> y <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#9893"><span class="stacstuse">@</span></a> b<span class="keyword">,</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span><span class="keyword">)</span></span></a></span>

<span class="comment">//
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><a name="2786"><span class="stacstdec">upticket0 <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#1984"><span class="stacstuse">upticket</span></a> <span class="keyword">(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a><span class="keyword">)</span></span></a></span>

<span class="keyword">fun</span> gcd_flag <span class="staexp"><span class="keyword">{</span>a<span class="keyword">,</span>b<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>z<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2686"><span class="stacstuse"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2686"><span class="stacstuse">gcd_v</span></a></span></a> <span class="keyword">(</span>a<span class="keyword">,</span> b<span class="keyword">,</span> z<span class="keyword">)</span></span></span> <span class="keyword">|</span> flag<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15410"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> a<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> a</span><span class="keyword">,</span> b<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15783"><span class="stacstuse">ptr</span></a> b</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#14977"><span class="stacstuse">bool</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> pfgcd<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">val</span> x <span class="keyword">=</span> <span class="keyword">!</span>a <span class="keyword">and</span> y <span class="keyword">=</span> <span class="keyword">!</span>b
<span class="keyword">in</span>
  <span class="keyword">if</span> x <span class="keyword">&gt;</span> y <span class="keyword">then</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> flag <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>a := x - y<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf := <span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2448"><span class="dyncstuse">gcd_lemma1</span></a> pfgcd<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      gcd_flag <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> flag<span class="keyword">,</span> a<span class="keyword">,</span> b<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      pf := <span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> pfgcd<span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#4371"><span class="dyncstuse">false</span></a> <span class="comment">// not done
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> x <span class="keyword">&lt;</span> y <span class="keyword">then</span> <span class="keyword">begin</span>
    <span class="keyword">if</span> flag <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>b := y - x<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf := <span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2528"><span class="dyncstuse">gcd_lemma2</span></a> pfgcd<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      gcd_flag <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> flag<span class="keyword">,</span> a<span class="keyword">,</span> b<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      pf := <span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> pfgcd<span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#4371"><span class="dyncstuse">false</span></a> <span class="comment">// not done
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    pf := <span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> pfgcd<span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#4327"><span class="dyncstuse">true</span></a> <span class="comment">// is done!
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [gcd_flag]
</span>
<span class="keyword">fun</span> gcd_mt <span class="staexp"><span class="keyword">{</span>x0<span class="keyword">,</span>y0<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>z<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pfgcd<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x0<span class="keyword">,</span> y0<span class="keyword">,</span> z<span class="keyword">)</span></span></span> <span class="keyword">|</span> x0<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> x0</span><span class="keyword">,</span> y0<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> y0</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> z</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> x <span class="keyword">=</span> x0 <span class="keyword">and</span> y <span class="keyword">=</span> y0
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="3710"><span class="stacstdec">VT <span class="keyword">=</span> <span class="keyword">@(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2686"><span class="stacstuse">gcd_v</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span> <span class="keyword">|</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15410"><span class="stacstuse">int</span></a><span class="keyword">)</span></span></a></span>
  <span class="keyword">val</span> ini <span class="keyword">=</span> <span class="keyword">@(</span><span class="prfexp"><span class="keyword">(</span>view@ x<span class="keyword">,</span> view@ y<span class="keyword">,</span> pfgcd<span class="keyword">)</span></span> <span class="keyword">|</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> mut <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#610"><span class="dyncstuse">pthread_mutexref_create&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#3710"><span class="stacstuse">VT</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>ini<span class="keyword">)</span>
  <span class="keyword">fun</span> gcd_worker <span class="keyword">(</span>ticket<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2786"><span class="stacstuse">upticket0</span></a></span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15410"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_ticket</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> ptr<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#838"><span class="dyncstuse">pthread_mutexref_lock</span></a> <span class="keyword">(</span>mut<span class="keyword">)</span>
    <span class="keyword">val</span> done <span class="keyword">=</span> gcd_flag <span class="keyword">(</span><span class="prfexp">ptr<span class="keyword">-&gt;</span>0</span> <span class="keyword">|</span> flag<span class="keyword">,</span> <span class="keyword">&amp;</span>x<span class="keyword">,</span> <span class="keyword">&amp;</span>y<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#1005"><span class="dyncstuse">pthread_mutexref_unlock</span></a> <span class="keyword">(</span><span class="prfexp">pf_ticket</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> ptr<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> done <span class="keyword">then</span> <span class="keyword">begin</span>
      <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2694"><span class="dyncstuse">pthread_upticket_upload_and_destroy</span></a> <span class="keyword">(</span><span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> ticket<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      gcd_worker <span class="keyword">(</span>ticket<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [gcd_worker]
</span>  <span class="keyword">val</span> uplock1 <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2044"><span class="dyncstuse">pthread_uplock_create</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> upticket1 <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2529"><span class="dyncstuse">pthread_upticket_create</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>uplock1<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_2esats.html#3764"><span class="dyncstuse">pthread_create_detached_cloptr</span></a> <span class="keyword">(</span><span class="keyword">llam</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> gcd_worker <span class="keyword">(</span>upticket1<span class="keyword">,</span>  1<span class="keyword">)</span><span class="keyword">)</span>

  <span class="keyword">val</span> uplock2 <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2044"><span class="dyncstuse">pthread_uplock_create</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> upticket2 <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2529"><span class="dyncstuse">pthread_upticket_create</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>uplock2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_2esats.html#3764"><span class="dyncstuse">pthread_create_detached_cloptr</span></a> <span class="keyword">(</span><span class="keyword">llam</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> gcd_worker <span class="keyword">(</span>upticket2<span class="keyword">,</span> ~1<span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">_</span><span class="comment">(*void*)</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2152"><span class="dyncstuse">pthread_uplock_download</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>uplock1<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2308"><span class="dyncstuse">pthread_uplock_destroy</span></a> <span class="keyword">(</span>uplock1<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">_</span><span class="comment">(*void*)</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2152"><span class="dyncstuse">pthread_uplock_download</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>uplock2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2flibc_2fSATS_2fpthread_5fuplock_2esats.html#2308"><span class="dyncstuse">pthread_uplock_destroy</span></a> <span class="keyword">(</span>uplock2<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_ticket</span><span class="keyword">,</span> <span class="prfexp">pf_at</span> <span class="keyword">|</span> ptr<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#838"><span class="dyncstuse">pthread_mutexref_lock</span></a> <span class="keyword">(</span>mut<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pfa<span class="keyword">,</span> pfb<span class="keyword">,</span> pfgcd<span class="keyword">)</span> <span class="keyword">=</span> ptr<span class="keyword">-&gt;</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ x := pfa</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ y := pfb</span>
  <span class="keyword">val</span> z1 <span class="keyword">=</span> x <span class="keyword">and</span> z2 <span class="keyword">=</span> y
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="comment">// this is a serious problem with persistent locks!
</span>    <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#5156"><span class="dyncstuse">discard</span></a> <span class="keyword">(</span>pf_ticket<span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#5156"><span class="dyncstuse">discard</span></a> <span class="keyword">(</span>pf_at<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prval</span> <a name="5156"><span class="dyncstdec"><span class="prfexp">discard <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">v</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span></span></span></a>
  <span class="keyword">}</span></span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert <span class="keyword">(</span>z1 <span class="keyword">=</span> z2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2608"><span class="dyncstuse">gcd_lemma3</span></a> <span class="keyword">(</span>pfgcd<span class="keyword">)</span></span>
<span class="keyword">in</span>
  z1
<span class="keyword">end</span> <span class="comment">// end of [gcd_mt]
</span>
<span class="keyword">fun</span> gcd_main <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">:</span> pos<span class="keyword">}</span></span>
  <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> x</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> y</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>z<span class="keyword">:</span>nat<span class="keyword">]</span> <span class="keyword">@(</span><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2farith_2esats.html#5213"><span class="stacstuse">GCD</span></a> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span> <span class="keyword">|</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15383"><span class="stacstuse">int</span></a> z<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fdoc_2fEXAMPLE_2fMISC_2fgcd_5fmt_2edats.html#2383"><span class="dyncstuse">gcd_lemma0</span></a> <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span> y<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">@(</span><span class="prfexp">pf</span> <span class="keyword">|</span> gcd_mt <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [gcd_main]
</span>
<span class="comment">//
</span>
<span class="comment">// This example shows clearly the superiority of multicore over
</span><span class="comment">// singlecore in case of busy waiting.
</span>
<span class="keyword">fn</span> usage <span class="keyword">(</span>cmd<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#15989"><span class="stacstuse">string</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2fprintf_2esats.html#2583"><span class="dyncstuse">prerrf</span></a> <span class="keyword">(</span>"Usage: %s [positive integer] [positive integer]\n"<span class="keyword">,</span> <span class="keyword">@(</span>cmd<span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#6808"><span class="dyncstimp">main</span></a> <span class="keyword">(</span>argc<span class="keyword">,</span> argv<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> argc <span class="keyword">&lt;</span> 3 <span class="keyword">then</span> <span class="keyword">(</span>usage <span class="keyword">(</span>argv<span class="keyword">.</span><span class="keyword">[</span><span class="prfexp">0</span><span class="keyword">]</span><span class="keyword">)</span><span class="keyword">;</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#4651"><span class="dyncstuse">exit</span></a> <span class="keyword">(</span>1<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert <span class="keyword">(</span>argc &gt;= 3<span class="keyword">)</span>
  <span class="keyword">val</span> x <span class="keyword">=</span> int1_of <span class="keyword">(</span>argv<span class="keyword">.</span><span class="keyword">[</span><span class="prfexp">1</span><span class="keyword">]</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#5696"><span class="dyncstuse">assert_errmsg_bool1</span></a> <span class="keyword">(</span>x <span class="keyword">&gt;</span> 0<span class="keyword">,</span> "The 1st integer argument is not positive.\n"<span class="keyword">)</span>
  <span class="keyword">val</span> y <span class="keyword">=</span> int1_of <span class="keyword">(</span>argv<span class="keyword">.</span><span class="keyword">[</span><span class="prfexp">2</span><span class="keyword">]</span><span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fbasics_5fdyn_2esats.html#5696"><span class="dyncstuse">assert_errmsg_bool1</span></a> <span class="keyword">(</span>y <span class="keyword">&gt;</span> 0<span class="keyword">,</span> "The 2nd integer argument is not positive.\n"<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">@(</span><span class="prfexp">pf</span> <span class="keyword">|</span> z<span class="keyword">)</span> <span class="keyword">=</span> gcd_main <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2ffac2_2fhwxi_2fresearch_2fATS_2fIMPLEMENT_2fGeizella_2fAnairiats_2fsvn_2fats_2dlang_2fprelude_2fSATS_2fprintf_2esats.html#2494"><span class="dyncstuse">printf</span></a> <span class="keyword">(</span>
    "The greatest common divisor of (%i, %i) is %i.\n"<span class="keyword">,</span> <span class="keyword">@(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> z<span class="keyword">)</span>
  <span class="keyword">)</span> <span class="comment">// end of [printf]
</span><span class="keyword">end</span> <span class="comment">// end of [main]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [gcd_mt.dats] *)</span>
</pre>
</body>
</html>
