<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(*
//
// A verified implementation of quicksort on lists
//
// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
// Time: Saturday, September 27, 2008
//

//
// How to compile:
//   atscc -o quicksort_list quicksort_list.dats
// How to test:
//   ./quicksort_list
//
*)</span>

<span class="comment">(*

This is a milestone example in the development of ATS.

A list quicksort implementation given below is proven to be terminating
and its return is guaranteed to be a sorted permutation of its input list.

An implementation of list quicksort in DML was given in 1998 that can
guarantee based on its type that it always returns a list of the same
length as its input. Since then, a question that has been asked frequently
by many people is whether it can be done in DML to give an implementation
of list quicksort that can guarantee based on its type that it always
returns a list that is a sorted permutation of its input.

This is finally done now in ATS, which succeeds DML as well as extends it.

*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libats/SATS/ilistp.sats"</span>
<span class="keyword">stadef</span> <span class="staexp"><a name="1036"><span class="stacstdec">nil <span class="keyword">=</span> ilist_nil</span></a></span>
<span class="keyword">stadef</span> <span class="staexp"><a name="1059"><span class="stacstdec">cons <span class="keyword">=</span> ilist_cons</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">sortdef</span> <span class="staexp">nats <span class="keyword">=</span> nat</span>
<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><a name="1127"><span class="stacstdec">MSET <span class="keyword">(</span>ilist<span class="keyword">,</span> int<span class="comment">(*nats*)</span><span class="keyword">)</span></span></a></span> <span class="keyword">=</span> 
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">x<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">xs<span class="keyword">:</span>ilist</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nats</span><span class="keyword">}</span>
    MSETcons <span class="staexp"><span class="keyword">(</span>cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">,</span> x + n<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">|</span> MSETnil <span class="staexp"><span class="keyword">(</span>nil<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
<span class="comment">// end of [MSET]
</span>
<span class="keyword">extern</span> <span class="keyword">praxi</span> <a name="1291"><span class="dyncstdec"><span class="prfexp">MSET_istot <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">[</span>n<span class="keyword">:</span>nats<span class="keyword">]</span> MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span></span></span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><a name="1370"><span class="stacstdec">LB <span class="keyword">(</span>int<span class="keyword">,</span> ilist<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">l<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">x<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">l &lt;= x</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">xs<span class="keyword">:</span>ilist</span><span class="keyword">}</span> LBcons <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">LB <span class="keyword">(</span>l<span class="keyword">,</span> xs<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">l<span class="keyword">:</span>nat</span><span class="keyword">}</span> LBnil <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> nil<span class="keyword">)</span></span></span>
<span class="comment">// end of [LB]
</span>
<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><a name="1519"><span class="stacstdec">UB <span class="keyword">(</span>ilist<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">u<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">x<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">x &lt;= u</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">xs<span class="keyword">:</span>ilist</span><span class="keyword">}</span> UBcons <span class="staexp"><span class="keyword">(</span>cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">,</span> u<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">UB <span class="keyword">(</span>xs<span class="keyword">,</span> u<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">u<span class="keyword">:</span>nat</span><span class="keyword">}</span> UBnil <span class="staexp"><span class="keyword">(</span>nil<span class="keyword">,</span> u<span class="keyword">)</span></span></span>
<span class="comment">// end of [UB]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">praxi</span> <a name="1693"><span class="dyncstdec"><span class="prfexp">LB_MSET_lemma <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs1<span class="keyword">,</span>xs2<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nats<span class="keyword">}</span></span>
  <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs1<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> _<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs2<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> _lb<span class="keyword">:</span> <span class="staexp">LB <span class="keyword">(</span>x<span class="keyword">,</span> xs1<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">LB <span class="keyword">(</span>x<span class="keyword">,</span> xs2<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">praxi</span> <a name="1828"><span class="dyncstdec"><span class="prfexp">UB_MSET_lemma <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs1<span class="keyword">,</span>xs2<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nats<span class="keyword">}</span></span>
  <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs1<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> _<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs2<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> _ub<span class="keyword">:</span> <span class="staexp">UB <span class="keyword">(</span>xs1<span class="keyword">,</span> x<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">UB <span class="keyword">(</span>xs2<span class="keyword">,</span> x<span class="keyword">)</span></span></span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="1985"><span class="dyncstdec"><span class="prfexp">LB_lemma_monotone
  <span class="staexp"><span class="keyword">{</span>l1<span class="keyword">,</span>l2<span class="keyword">:</span>nat <span class="keyword">|</span> l1 &lt;= l2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span> ilist<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">LB <span class="keyword">(</span>l2<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">LB <span class="keyword">(</span>l1<span class="keyword">,</span> xs<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2089"><span class="dyncstdec"><span class="prfexp">UB_lemma_monotone
  <span class="staexp"><span class="keyword">{</span>u1<span class="keyword">,</span>u2<span class="keyword">:</span>nat <span class="keyword">|</span> u1 &gt;= u2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span> ilist<span class="keyword">}</span></span> <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">UB <span class="keyword">(</span>xs<span class="keyword">,</span> u2<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">UB <span class="keyword">(</span>xs<span class="keyword">,</span> u1<span class="keyword">)</span></span></span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absprop</span> <span class="staexp"><a name="2210"><span class="stacstdec">ISORD</span></a></span> <span class="keyword">(</span>ilist<span class="keyword">)</span>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2237"><span class="dyncstdec"><span class="prfexp">isord_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ISORD <span class="keyword">(</span>nil<span class="keyword">)</span></span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">prfun</span> <a name="2276"><span class="dyncstdec"><span class="prfexp">isord_cons <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span>ilist<span class="keyword">}</span></span>
  <span class="keyword">(</span>pf1<span class="keyword">:</span> <span class="staexp">LB <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">,</span> pf2<span class="keyword">:</span> <span class="staexp">ISORD <span class="keyword">(</span>xs<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ISORD <span class="keyword">(</span>cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span></span></span></a>
<span class="comment">// end of [isord_cons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">prfun</span> <a name="2423"><span class="dyncstdec"><span class="prfexp">APPEND_MSET_lemma <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">,</span>ys<span class="keyword">,</span>zs<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nats<span class="keyword">}</span></span>
  <span class="keyword">(</span>pf1<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n1<span class="keyword">)</span></span><span class="keyword">,</span> pf2<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>ys<span class="keyword">,</span> n2<span class="keyword">)</span></span><span class="keyword">,</span> pf3<span class="keyword">:</span> <span class="staexp">APPEND <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> zs<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">MSET <span class="keyword">(</span>zs<span class="keyword">,</span> n1 + n2<span class="keyword">)</span></span></span></span></a>
<span class="comment">// end of [APPEND_MSET_lemma]
</span>
<span class="keyword">extern</span>
<span class="keyword">prfun</span> <a name="2612"><span class="dyncstdec"><span class="prfexp">APPEND_ISORD_lemma
  <span class="staexp"><span class="keyword">{</span>xs1<span class="keyword">,</span>xs2<span class="keyword">,</span>xs<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
    pf1<span class="keyword">:</span> <span class="staexp">ISORD xs1</span>
  <span class="keyword">,</span> pf2<span class="keyword">:</span> <span class="staexp">ISORD xs2</span>
  <span class="keyword">,</span> pf3<span class="keyword">:</span> <span class="staexp">UB <span class="keyword">(</span>xs1<span class="keyword">,</span> x<span class="keyword">)</span></span>
  <span class="keyword">,</span> pf4<span class="keyword">:</span> <span class="staexp">LB <span class="keyword">(</span>x<span class="keyword">,</span> xs2<span class="keyword">)</span></span>
  <span class="keyword">,</span> pf5<span class="keyword">:</span> <span class="staexp">APPEND <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> xs<span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">ISORD <span class="keyword">(</span>xs<span class="keyword">)</span></span></span></span></a> <span class="comment">// end of [APPEND_ISORD_lemma]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">abst@ype</span> <span class="staexp"><a name="2855"><span class="stacstdec">E <span class="keyword">(</span>a<span class="keyword">:</span> t@ype<span class="keyword">,</span> x<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span> a</span></a></span>
<span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="2893"><span class="dyncstdec">eltencode <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t@ype<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>x<span class="keyword">:</span>pos<span class="keyword">]</span> E <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="2954"><span class="dyncstdec">eltdecode <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>t@ype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">E <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></a>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
<a name="3043"><span class="dyncstdec">lte_elt_elt <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">E<span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">)</span></span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">E <span class="keyword">(</span>a<span class="keyword">,</span> y<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>x &lt;= y<span class="keyword">)</span></span></span></a>
<span class="neuexp"><span class="keyword">overload</span> &lt;= <span class="keyword">with</span> lte_elt_elt</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="3147"><span class="stacstdec">list <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> ilist<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> nil <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> nil<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">x<span class="keyword">:</span>pos</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">xs<span class="keyword">:</span> ilist</span><span class="keyword">}</span> cons <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>E <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">,</span> list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="comment">// end of [list]
</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="3295"><span class="stacstdec">list <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>xs<span class="keyword">:</span>ilist<span class="keyword">]</span> list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <a name="3378"><span class="dyncstdec">append <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">,</span>ys<span class="keyword">:</span>ilist<span class="keyword">}</span></span>
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> ys<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>zs<span class="keyword">:</span>ilist<span class="keyword">]</span> <span class="keyword">(</span>APPEND <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> zs<span class="keyword">)</span> <span class="keyword">|</span> list <span class="keyword">(</span>a<span class="keyword">,</span> zs<span class="keyword">)</span><span class="keyword">)</span></span></span></a>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
append <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">,</span>ys<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>xs<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> ys<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>zs<span class="keyword">:</span>ilist<span class="keyword">]</span> <span class="keyword">(</span>APPEND <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> zs<span class="keyword">)</span> <span class="keyword">|</span> list <span class="keyword">(</span>a<span class="keyword">,</span> zs<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> zs<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">APPENDcons pf</span> <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> zs<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="prfexp">APPENDnil <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> ys<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [append]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
qsrt <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nats<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">,</span>0<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span></span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>xs<span class="keyword">:</span> ilist<span class="keyword">]</span> <span class="keyword">(</span>MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">,</span> ISORD <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">|</span> list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">MSETcons pf <span class="keyword">=</span> pf</span> <span class="keyword">in</span> part <span class="keyword">(</span>
      <span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">MSETnil <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">MSETnil <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">UBnil <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">LBnil <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> x<span class="keyword">,</span> xs<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">MSETnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">MSETnil <span class="keyword">(</span><span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">isord_nil <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [qsrt]
</span>
<span class="keyword">and</span> part <span class="staexp"><span class="keyword">{</span>x<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>xs0<span class="keyword">,</span>xs1<span class="keyword">,</span>xs2<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n0<span class="keyword">,</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nats<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n0+n1+n2<span class="keyword">,</span>n0+1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs0<span class="keyword">,</span> n0<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs1<span class="keyword">,</span> n1<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf2<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs2<span class="keyword">,</span> n2<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_ub<span class="keyword">:</span> <span class="staexp">UB <span class="keyword">(</span>xs1<span class="keyword">,</span> x<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_lb<span class="keyword">:</span> <span class="staexp">LB <span class="keyword">(</span>x<span class="keyword">,</span> xs2<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">E <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">)</span></span><span class="keyword">,</span> xs0<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs0<span class="keyword">)</span></span><span class="keyword">,</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs1<span class="keyword">)</span></span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs2<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>xs<span class="keyword">:</span> ilist<span class="keyword">]</span> <span class="keyword">(</span>MSET <span class="keyword">(</span>xs<span class="keyword">,</span> x+n0+n1+n2<span class="keyword">)</span><span class="keyword">,</span> ISORD <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">|</span> list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs0 <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs0<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">MSETcons <span class="keyword">(</span>pf0<span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> x0 &lt;= x <span class="keyword">then</span> part <span class="keyword">(</span>
        <span class="prfexp">pf0</span><span class="keyword">,</span> <span class="prfexp">MSETcons pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span><span class="keyword">,</span> <span class="prfexp">UBcons <span class="keyword">(</span>pf_ub<span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf_lb</span>
      <span class="keyword">|</span> x<span class="keyword">,</span> xs0<span class="keyword">,</span> cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs1<span class="keyword">)</span><span class="keyword">,</span> xs2
      <span class="keyword">)</span> <span class="keyword">else</span> part <span class="keyword">(</span>
        <span class="prfexp">pf0</span><span class="keyword">,</span> <span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">MSETcons pf2</span><span class="keyword">,</span> <span class="prfexp">pf_ub</span><span class="keyword">,</span> <span class="prfexp">LBcons <span class="keyword">(</span>pf_lb<span class="keyword">)</span></span>
      <span class="keyword">|</span> x<span class="keyword">,</span> xs0<span class="keyword">,</span> xs1<span class="keyword">,</span> cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs2<span class="keyword">)</span>
      <span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">MSETnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1_set</span><span class="keyword">,</span> <span class="prfexp">pf1_ord</span> <span class="keyword">|</span> xs1<span class="keyword">)</span> <span class="keyword">=</span> qsrt <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf2_set</span><span class="keyword">,</span> <span class="prfexp">pf2_ord</span> <span class="keyword">|</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> qsrt <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> xs2<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_ub <span class="keyword">=</span> UB_MSET_lemma <span class="keyword">(</span>pf1<span class="keyword">,</span> pf1_set<span class="keyword">,</span> pf_ub<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf_lb <span class="keyword">=</span> LB_MSET_lemma <span class="keyword">(</span>pf2<span class="keyword">,</span> pf2_set<span class="keyword">,</span> pf_lb<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf2_ord1 <span class="keyword">=</span> isord_cons <span class="keyword">(</span>pf_lb<span class="keyword">,</span> pf2_ord<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_app</span> <span class="keyword">|</span> xs<span class="keyword">)</span> <span class="keyword">=</span> append <span class="keyword">(</span>xs1<span class="keyword">,</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs2<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_set <span class="keyword">=</span> APPEND_MSET_lemma <span class="keyword">(</span>pf1_set<span class="keyword">,</span> MSETcons pf2_set<span class="keyword">,</span> pf_app<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf_ord <span class="keyword">=</span> APPEND_ISORD_lemma <span class="keyword">(</span>
        pf1_ord<span class="keyword">,</span> pf2_ord1<span class="keyword">,</span> pf_ub<span class="keyword">,</span> LBcons <span class="staexp"><span class="keyword">{</span>x<span class="keyword">}</span></span> <span class="keyword">(</span>pf_lb<span class="keyword">)</span><span class="keyword">,</span> pf_app
      <span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf_set</span><span class="keyword">,</span> <span class="prfexp">pf_ord</span> <span class="keyword">|</span> xs<span class="keyword">)</span>      
    <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [part]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
<a name="5696"><span class="dyncstdec">quicksort <span class="staexp"><span class="keyword">{</span>xs<span class="keyword">:</span>ilist<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nats<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span></span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>xs<span class="keyword">:</span> ilist<span class="keyword">]</span> <span class="keyword">(</span>MSET <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">,</span> ISORD <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">|</span> list <span class="keyword">(</span>a<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">)</span></span></span></a>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> quicksort <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">)</span> <span class="keyword">=</span> qsrt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/SATS/random.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
lte_elt_elt&lt;<span class="staexp">double</span><span class="keyword">&gt;</span>
  <span class="staexp"><span class="keyword">{</span>x<span class="keyword">,</span>y<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> x <span class="keyword">=</span> eltdecode <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">and</span> y <span class="keyword">=</span> eltdecode<span class="keyword">(</span>y<span class="keyword">)</span>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="6067"><span class="dyncstdec">__cast <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>x &lt;= y<span class="keyword">)</span></span></span></a>
<span class="keyword">in</span>
  __cast <span class="keyword">(</span>lte_double_double <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [lte_elt_elt]
</span>
<span class="keyword">fn</span> print_list <span class="keyword">(</span>
  xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>double<span class="keyword">)</span></span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>double<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> x <span class="keyword">=</span> eltdecode <span class="keyword">(</span>x<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> print ", "<span class="keyword">;</span> printf <span class="keyword">(</span>"%.2f"<span class="keyword">,</span> <span class="keyword">@(</span>x<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> aux <span class="keyword">(</span>xs<span class="keyword">,</span> i+1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>xs<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [print_list]
</span>
<span class="keyword">fun</span> randgen_list
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>double<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> x <span class="keyword">=</span> drand48 <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">val</span> x <span class="keyword">=</span> eltencode <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">in</span>
    cons <span class="staexp"><span class="keyword">{</span>double<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> randgen_list <span class="keyword">(</span>n-1<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [randgen_list]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> main <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> srand48_with_time <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> xs <span class="keyword">=</span> randgen_list <span class="keyword">(</span>20<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>print "xs = "<span class="keyword">;</span> print_list xs<span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pfmset <span class="keyword">=</span> MSET_istot <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pford</span><span class="keyword">,</span> <span class="prfexp">pfmset</span> <span class="keyword">|</span> ys<span class="keyword">)</span> <span class="keyword">=</span> quicksort <span class="keyword">(</span><span class="prfexp">pfmset</span> <span class="keyword">|</span> xs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>print "ys = "<span class="keyword">;</span> print_list ys<span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// nothing
</span><span class="keyword">end</span> <span class="comment">// end of [main]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [quicksort_list.dats] *)</span>
</pre>
</body>
</html>
