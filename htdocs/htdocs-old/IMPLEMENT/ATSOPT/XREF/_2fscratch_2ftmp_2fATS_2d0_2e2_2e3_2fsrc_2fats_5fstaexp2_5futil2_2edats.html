<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: October 2007
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="extern">%{^
#include "ats_counter.cats" /* only needed for [ATS/Geizella] */
#include "ats_intinf.cats"  /* only needed for [ATS/Geizella] */
%}</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">IntInf <span class="keyword">=</span> "ats_intinf.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lab <span class="keyword">=</span> "ats_label.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Loc <span class="keyword">=</span> "ats_location.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_stadyncst2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_trans3_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THISFILENAME "ats_staexp2_util2.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">nil list_nil</span>
<span class="keyword">#define</span> <span class="neuexp">:: list_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list_cons</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">overload</span> <span class="keyword">=</span> <span class="keyword">with</span> $Lab<span class="keyword">.</span>eq_label_label</span>
<span class="neuexp"><span class="keyword">overload</span> prerr <span class="keyword">with</span> $Lab<span class="keyword">.</span>prerr_label</span>
<span class="neuexp"><span class="keyword">overload</span> prerr <span class="keyword">with</span> $Loc<span class="keyword">.</span>prerr_location</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_loc_error3 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">(</span>$Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(3)"<span class="keyword">)</span>
<span class="comment">// end of [prerr_loc_error3]
</span>
<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_staexp2_util2)"
<span class="keyword">fn</span> prerr_loc_interror <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": INTERNAL ERROR (ats_staexp2_util2)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_interror]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2exp_link_remove_flag
  <span class="keyword">(</span>s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_link_remove_flag: s2e0 = "; print s2e0; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Ecst s2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> s2cst_isrec_get s2c <span class="keyword">then</span> s2e0
      <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2cst_def_get s2c <span class="keyword">of</span>
        <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            flag := flag + 1<span class="keyword">;</span> s2exp_link_remove_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>        <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0
      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Ecst]
</span>    <span class="comment">// the link of s2V should not be updated!!!
</span>  <span class="keyword">|</span> S2EVar s2V <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2Var_link_get <span class="keyword">(</span>s2V<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        flag := flag + 1<span class="keyword">;</span> s2exp_link_remove_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2EVar]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_link_remove_flag] *)</span>

<span class="keyword">implement</span>
s2exp_link_remove <span class="keyword">(</span>s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">in</span> s2exp_link_remove_flag <span class="keyword">(</span>s2e0<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_link_remove]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> labs2explst_readize
  <span class="keyword">(</span>_v<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_readize <span class="keyword">(</span>_v<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_readize <span class="keyword">(</span>_v<span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_readize]
</span>
<span class="keyword">implement</span>
s2exp_readize <span class="keyword">(</span>_v<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t_s2e <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
<span class="keyword">in</span>
  <span class="keyword">if</span> s2rt_is_linear s2t_s2e <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> s2t <span class="keyword">=</span> s2rt_readize s2t_s2e <span class="keyword">in</span>
    <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_readize <span class="keyword">(</span>_v<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_tyrec_srt <span class="keyword">(</span>s2t<span class="keyword">,</span> knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>    <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_readize <span class="keyword">(</span>_v<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_union_srt <span class="keyword">(</span>s2t<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2exp_read_srt <span class="keyword">(</span>s2t<span class="keyword">,</span> _v<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    s2e <span class="comment">(* [r@ead] is identity on nonlinear types *)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [s2exp_readize] *)</span>

<span class="keyword">implement</span>
s2expopt_readize <span class="keyword">(</span>_v<span class="keyword">,</span> os2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> os2e <span class="keyword">of</span>
  <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">if</span> s2exp_is_linear s2e
      <span class="keyword">then</span> Some <span class="keyword">(</span>s2exp_readize <span class="keyword">(</span>_v<span class="keyword">,</span> s2e<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> os2e
    <span class="comment">// end of [Some]
</span>  <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> os2e
<span class="keyword">end</span> <span class="comment">(* end of [s2expopt_readize] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> labs2explst_topize
  <span class="keyword">(</span>knd<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_topize <span class="keyword">(</span>knd<span class="keyword">,</span> s2e<span class="keyword">)</span>
    <span class="keyword">in</span>
      LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> labs2explst_topize <span class="keyword">(</span>knd<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [labs2explst_topize] *)</span>

<span class="keyword">implement</span>
s2exp_topize <span class="keyword">(</span>knd<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2t <span class="keyword">=</span> s2e<span class="keyword">.</span>s2exp_srt
  <span class="keyword">val</span> isdone <span class="keyword">=</span> <span class="keyword">(</span>
    <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="comment">(*typization*)</span> <span class="keyword">then</span>
      <span class="keyword">(</span><span class="keyword">if</span> s2rt_is_linear s2t <span class="keyword">then</span> false <span class="keyword">else</span> true<span class="keyword">)</span>
    <span class="keyword">else</span> false
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf s2e
<span class="keyword">in</span>
  <span class="keyword">if</span> isdone <span class="keyword">then</span> <span class="keyword">begin</span> 
    s2e <span class="comment">// there is no need for any change
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> s2t_new <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">if</span> s2rt_is_proof s2t <span class="keyword">then</span> s2rt_prop <span class="keyword">else</span>
        <span class="keyword">(</span><span class="keyword">if</span> s2rt_is_boxed s2t <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_t0ype<span class="keyword">)</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> s2exp_topize <span class="keyword">(</span>knd<span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_tyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>    <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>recknd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> recknd <span class="keyword">of</span>
      <span class="keyword">|</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_top_srt <span class="keyword">(</span>s2t_new<span class="keyword">,</span> knd<span class="keyword">,</span> s2e<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="comment">(* flat record *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_topize <span class="keyword">(</span>knd<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">in</span>
          s2exp_tyrec_srt <span class="keyword">(</span>s2t_new<span class="keyword">,</span> recknd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>    <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> _<span class="comment">(*ind*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2i <span class="keyword">=</span> s2exp_int <span class="keyword">(</span>~1<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_union_srt <span class="keyword">(</span>s2t_new<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2exp_top_srt <span class="keyword">(</span>s2t_new<span class="keyword">,</span> knd<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [s2exp_topize] *)</span>

<span class="keyword">implement</span> s2exp_topize_0 <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> s2exp_topize <span class="keyword">(</span>0<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">implement</span> s2exp_topize_1 <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> s2exp_topize <span class="keyword">(</span>1<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2exp_whnf_flag
  <span class="keyword">(</span>s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_whnf_flag(0): s2e0 = "; print s2e0; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_link_remove_flag <span class="keyword">(</span>s2e0<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "s2exp_whnf_flag(1): s2e0 = "; print s2e0; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e_fun <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e_fun<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e_fun<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Elam <span class="keyword">(</span>s2vs_arg<span class="keyword">,</span> s2e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">fun</span> aux
            <span class="keyword">(</span>s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">stasub_t</span> <span class="keyword">=</span>
            <span class="keyword">case+</span> <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">(</span>s2v :: s2vs<span class="keyword">,</span> s2e :: s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span>
                stasub_add <span class="keyword">(</span>aux <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span><span class="keyword">,</span> s2v<span class="keyword">,</span> s2e<span class="keyword">)</span>
            <span class="keyword">|</span> <span class="keyword">(</span>nil _<span class="keyword">,</span> nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> stasub_nil
            <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                prerr ": s2exp_whnf_flag: S2Eapp: arity error"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>stasub_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_,_]
</span>          <span class="comment">// end of [aux]
</span>          <span class="keyword">val</span> sub <span class="keyword">=</span> aux <span class="keyword">(</span>s2vs_arg<span class="keyword">,</span> s2es_arg<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> flag := flag + 1
        <span class="keyword">in</span>
          s2exp_whnf_flag <span class="keyword">(</span>s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e_body<span class="keyword">)</span><span class="keyword">,</span> flag<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Elam]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0
          <span class="keyword">then</span> <span class="keyword">begin</span>
            s2exp_app_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            s2e0 <span class="comment">(* there is no change *)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
        <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>  <span class="keyword">|</span> S2Eclo <span class="keyword">(</span>knd<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Efun <span class="keyword">(</span>_<span class="comment">(*fc*)</span><span class="keyword">,</span> lin<span class="keyword">,</span> s2fe<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> s2e_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> fc1 <span class="keyword">=</span> $Syn<span class="keyword">.</span>FUNCLOclo knd
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> flag := flag + 1
          <span class="keyword">val</span> s2t1 <span class="keyword">=</span> <span class="keyword">(</span>
            <span class="keyword">if</span> knd <span class="keyword">=</span> 0 <span class="keyword">then</span>
              <span class="keyword">if</span> lin <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> s2rt_viewt0ype <span class="keyword">else</span> s2rt_t0ype
            <span class="keyword">else</span> <span class="keyword">begin</span>
              s2e0<span class="keyword">.</span>s2exp_srt
            <span class="keyword">end</span> <span class="comment">// end o [if]
</span>          <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2rt</span>
        <span class="keyword">in</span>
          s2exp_fun_srt <span class="keyword">(</span>s2t1<span class="keyword">,</span> fc1<span class="keyword">,</span> lin<span class="keyword">,</span> s2fe<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> s2e_res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Efun]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0
          <span class="keyword">then</span> s2exp_clo_srt <span class="keyword">(</span>s2e<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">else</span> s2e0
        <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2Eclo]
</span>  <span class="keyword">|</span> S2Ecrypt <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_scope<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_exi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2exp_crypt s2e_scope<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Eexi]
</span>      <span class="keyword">|</span> S2Euni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_scope<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_uni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2exp_crypt s2e_scope<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Euni]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Ecrypt]
</span>  <span class="keyword">|</span> S2Eread <span class="keyword">(</span>_v<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_readize <span class="keyword">(</span>_v<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">in</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_tyrec_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>      <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_readize <span class="keyword">(</span>_v<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">in</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_union_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0
          <span class="keyword">then</span> s2exp_read_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> _v<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">else</span> s2e0
        <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2Eread]
</span>  <span class="keyword">|</span> S2Esel <span class="keyword">(</span>s2e_tup<span class="keyword">,</span> ind<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e_tup <span class="keyword">=</span> s2exp_whnf s2e_tup
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e_tup<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Etup s2es <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">fun</span> aux <span class="keyword">(</span>s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="comment">// the [nth] function
</span>            <span class="keyword">case+</span> s2es <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> aux <span class="keyword">(</span>s2es<span class="keyword">,</span> n-1<span class="keyword">)</span> <span class="keyword">else</span> s2e<span class="keyword">)</span>
            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                prerr ": s2exp_whnf: S2Etup: subscript error"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [nil]
</span>          <span class="comment">// end of [aux]
</span>          <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> aux <span class="keyword">(</span>s2es<span class="keyword">,</span> ind<span class="keyword">)</span>
        <span class="keyword">in</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_whnf_flag <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> flag<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Etup]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0
          <span class="keyword">then</span> <span class="keyword">begin</span>
            s2exp_sel_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> s2e_tup<span class="keyword">,</span> ind<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            s2e0 <span class="comment">// there is no change
</span>          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [S2Esel]
</span>  <span class="keyword">|</span> S2Esizeof s2e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> flag := flag + 1<span class="keyword">;</span> <span class="keyword">val</span> s2ze <span class="keyword">=</span> s2zexp_make_s2exp s2e
    <span class="keyword">in</span>
      s2exp_size s2ze
    <span class="keyword">end</span> <span class="comment">// end of [S2Esizeof]
</span>  <span class="keyword">|</span> S2Etop <span class="keyword">(</span>knd<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag<span class="keyword">;</span> <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Etop <span class="keyword">(</span>knd1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> flag := flag + 1
          <span class="keyword">val</span> knd1<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> knd1 <span class="keyword">else</span> 0
        <span class="keyword">in</span>
          s2exp_topize <span class="keyword">(</span>knd1<span class="keyword">,</span> s2e1<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Etop]
</span>      <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> s2exp_topize <span class="keyword">(</span>knd<span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
        <span class="keyword">in</span>
          flag := flag + 1<span class="keyword">;</span> s2exp_tyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>      <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>recknd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> recknd <span class="keyword">of</span>
        <span class="keyword">|</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> s2exp_top_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> s2e<span class="keyword">)</span>
            <span class="keyword">else</span> s2e0
          <span class="keyword">end</span> <span class="comment">// end of [TYRECKINDbox]
</span>        <span class="keyword">|</span> _ <span class="comment">(* flat record *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_topize <span class="keyword">(</span>knd<span class="keyword">,</span> ls2es<span class="keyword">)</span>
          <span class="keyword">in</span>
            flag := flag + 1<span class="keyword">;</span>
            s2exp_tyrec_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> recknd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [_]
</span>        <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>      <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> _<span class="comment">(*ind*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2i <span class="keyword">=</span> s2exp_int <span class="keyword">(</span>~1<span class="keyword">)</span>
        <span class="keyword">in</span>
          flag := flag + 1<span class="keyword">;</span>
          s2exp_union_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> cond <span class="keyword">=</span>
            <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="comment">(*typization*)</span>
              <span class="keyword">if</span> s2exp_is_linear s2e <span class="keyword">then</span> false <span class="keyword">else</span> true
            <span class="keyword">else</span> false
        <span class="keyword">in</span>
          <span class="keyword">if</span> cond <span class="keyword">then</span> <span class="keyword">begin</span>
            flag := flag + 1<span class="keyword">;</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0
              <span class="keyword">then</span> s2exp_top_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">else</span> s2e0
            <span class="comment">// end of [if]
</span>          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Etop]
</span>  <span class="keyword">|</span> S2Evar s2v <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> the_s2varbindmap_find s2v <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e <span class="keyword">=&gt;</span> <span class="keyword">(</span>flag := flag + 1<span class="keyword">;</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Evar]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end of [s2exp_whnf_flag]
</span>
<span class="keyword">and</span> s2explst_whnf_flag
  <span class="keyword">(</span>s2es0<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2es0 <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> s2es <span class="keyword">=</span> s2explst_whnf_flag <span class="keyword">(</span>s2es<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">else</span> s2es0
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_whnf_flag]
</span>
<span class="keyword">implement</span>
s2exp_whnf <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">let</span> <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">in</span> s2exp_whnf_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span> <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_whnf]
</span>
<span class="keyword">implement</span>
s2explst_whnf <span class="keyword">(</span>s2es<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>s2es<span class="keyword">,</span> s2exp_whnf<span class="keyword">)</span>
<span class="comment">// end of [s2explst_whnf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">s2exp_whnf_t <span class="keyword">=</span> s2exp</span>

<span class="keyword">in</span> <span class="comment">// end of [local]
</span>
<span class="keyword">implement</span> s2exp_of_s2exp_whnf <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> s2e
<span class="keyword">implement</span> s2exp_whnf_of_s2exp <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> s2e

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// application normalization
</span>
<span class="keyword">fun</span> s2exp_nfapp_flag
  <span class="keyword">(</span>s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf_flag <span class="keyword">(</span>s2e0<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2es_arg <span class="keyword">=</span> s2explst_nfapp_flag <span class="keyword">(</span>s2es_arg<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span>
        s2exp_app_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">)</span>
      <span class="keyword">else</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>  <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> s2exp_nfapp_flag <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> s2exp_tyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span>
      <span class="keyword">else</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_nfapp_flag <span class="keyword">(</span>ls2es<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span>
        s2exp_tyrec_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">else</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> s2e_ind<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_nfapp_flag <span class="keyword">(</span>ls2es<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span>
        s2exp_union_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> stamp<span class="keyword">,</span> s2e_ind<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">else</span> s2e0
    <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end of [s2exp_nfapp_flag]
</span>
<span class="keyword">and</span> s2explst_nfapp_flag <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>s2es0<span class="keyword">:</span> <span class="staexp">s2explst n</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2explst n</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2es0 <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_nfapp_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> s2es <span class="keyword">=</span> s2explst_nfapp_flag <span class="keyword">(</span>s2es<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">else</span> s2es0
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [s2explst_nfapp_flag]
</span>
<span class="keyword">and</span> labs2explst_nfapp_flag
  <span class="keyword">(</span>ls2es0<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> ls2es0 <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_nfapp_flag <span class="keyword">(</span>s2e<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_nfapp_flag <span class="keyword">(</span>ls2es<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">else</span> ls2es0
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [labs2explst_nfapp_flag]
</span>
<span class="keyword">implement</span>
s2exp_nfapp <span class="keyword">(</span>s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">in</span> s2exp_nfapp_flag <span class="keyword">(</span>s2e0<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_nfapp]
</span>
<span class="keyword">implement</span>
s2explst_nfapp <span class="keyword">(</span>s2es0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">in</span> s2explst_nfapp_flag <span class="keyword">(</span>s2es0<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_nfapp]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2eff_syneq <span class="keyword">(</span>s2fe1<span class="keyword">:</span> <span class="staexp">s2eff</span><span class="keyword">,</span> s2fe2<span class="keyword">:</span> <span class="staexp">s2eff</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>s2fe1<span class="keyword">,</span> s2fe2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>S2EFFall <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> S2EFFall <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>S2EFFnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> S2EFFnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>S2EFFset <span class="keyword">(</span>efs1<span class="keyword">,</span> s2es1<span class="keyword">)</span><span class="keyword">,</span> S2EFFset <span class="keyword">(</span>efs2<span class="keyword">,</span> s2es2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      $Eff<span class="keyword">.</span>eq_effset_effset <span class="keyword">(</span>efs1<span class="keyword">,</span> efs2<span class="keyword">)</span> andalso s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2EFFset, S2EFFset]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [s2eff]
</span>
<span class="keyword">fun</span> labs2explst_syneq
  <span class="keyword">(</span>ls2es1<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> ls2es2<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>ls2es1<span class="keyword">,</span> ls2es2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>LABS2EXPLSTcons <span class="keyword">(</span>l1<span class="keyword">,</span> s2e1<span class="keyword">,</span> ls2es1<span class="keyword">)</span><span class="keyword">,</span>
     LABS2EXPLSTcons <span class="keyword">(</span>l2<span class="keyword">,</span> s2e2<span class="keyword">,</span> ls2es2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      l1 <span class="keyword">=</span> l2 andalso
      s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> andalso
      labs2explst_syneq <span class="keyword">(</span>ls2es1<span class="keyword">,</span> ls2es2<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_syneq]
</span>
<span class="keyword">implement</span>
s2exp_syneq <span class="keyword">(</span>s2e10<span class="keyword">,</span> s2e20<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e10 <span class="keyword">=</span> s2exp_whnf s2e10 <span class="keyword">and</span> s2e20 <span class="keyword">=</span> s2exp_whnf s2e20
<span class="comment">(*
  val () = begin
    print "s2exp_syneq: s2e10 = "; print s2e10; print_newline ();
    print "s2exp_syneq: s2e20 = "; print s2e20; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e10<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> eqref_s2exp_s2exp <span class="keyword">(</span>s2e10<span class="keyword">,</span> s2e20<span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>s2e11<span class="keyword">,</span> s2es12<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>s2e21<span class="keyword">,</span> s2es22<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>s2e11<span class="keyword">,</span> s2e21<span class="keyword">)</span> andalso s2explst_syneq <span class="keyword">(</span>s2es12<span class="keyword">,</span> s2es22<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>  <span class="keyword">|</span> S2Echar c1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Echar c2 <span class="keyword">=&gt;</span> eq_char_char <span class="keyword">(</span>c1<span class="keyword">,</span> c2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Echar]
</span>  <span class="keyword">|</span> S2Eclo <span class="keyword">(</span>knd1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eclo <span class="keyword">(</span>knd2<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> knd1 <span class="keyword">=</span> knd2 andalso s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eclo]
</span>  <span class="keyword">|</span> S2Ecst s2c1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Ecst s2c2 <span class="keyword">=&gt;</span> eq_s2cst_s2cst <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Ecst]
</span>  <span class="keyword">|</span> S2Edatconptr <span class="keyword">(</span>d2c1<span class="keyword">,</span> s2es1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Edatconptr <span class="keyword">(</span>d2c2<span class="keyword">,</span> s2es2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        eq_d2con_d2con <span class="keyword">(</span>d2c1<span class="keyword">,</span> d2c2<span class="keyword">)</span> andalso s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Edatconptr]
</span>  <span class="keyword">|</span> S2Edatcontyp <span class="keyword">(</span>d2c1<span class="keyword">,</span> s2es1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Edatcontyp <span class="keyword">(</span>d2c2<span class="keyword">,</span> s2es2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        eq_d2con_d2con <span class="keyword">(</span>d2c1<span class="keyword">,</span> d2c2<span class="keyword">)</span> andalso s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Edatcontyp]
</span>  <span class="keyword">|</span> S2Eeff s2fe1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Eeff s2fe2 <span class="keyword">=&gt;</span> s2eff_syneq <span class="keyword">(</span>s2fe1<span class="keyword">,</span> s2fe2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eeff]
</span>  <span class="keyword">|</span> S2Eeqeq <span class="keyword">(</span>s2e11<span class="keyword">,</span> s2e12<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eeqeq <span class="keyword">(</span>s2e21<span class="keyword">,</span> s2e22<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>s2e11<span class="keyword">,</span> s2e21<span class="keyword">)</span> andalso s2exp_syneq <span class="keyword">(</span>s2e12<span class="keyword">,</span> s2e22<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eeqeq]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eeqeq]
</span><span class="comment">(*
  | S2Eextype (name1, s2ess1) =&gt; begin case+ s2e20.s2exp_node of
    | S2Eextype (name2, s2ess2) =&gt; (
        eq_string_string (name1, name2) andalso s2explstlst_syneq (s2ess1, s2ess2)
      ) // end of [S2Eextyp]
    | _ =&gt; false
    end // end of [S2Eextype]
*)</span>
  <span class="keyword">|</span> S2Efun <span class="keyword">(</span>fc1<span class="keyword">,</span> lin1<span class="keyword">,</span> s2fe1<span class="keyword">,</span> npf1<span class="keyword">,</span> s2es1_arg<span class="keyword">,</span> s2e1_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
      <span class="keyword">|</span> S2Efun <span class="keyword">(</span>fc2<span class="keyword">,</span> lin2<span class="keyword">,</span> s2fe2<span class="keyword">,</span> npf2<span class="keyword">,</span> s2es2_arg<span class="keyword">,</span> s2e2_res<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          $Syn<span class="keyword">.</span>eq_funclo_funclo <span class="keyword">(</span>fc1<span class="keyword">,</span> fc2<span class="keyword">)</span> andalso
          lin1 <span class="keyword">=</span> lin2 andalso
          s2eff_syneq <span class="keyword">(</span>s2fe1<span class="keyword">,</span> s2fe2<span class="keyword">)</span> andalso
          npf1 <span class="keyword">=</span> npf2 andalso
          s2explst_syneq <span class="keyword">(</span>s2es1_arg<span class="keyword">,</span> s2es2_arg<span class="keyword">)</span> andalso
          s2exp_syneq <span class="keyword">(</span>s2e1_res<span class="keyword">,</span> s2e2_res<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Efun]
</span>  <span class="keyword">|</span> S2Eint i1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eint i2 <span class="keyword">=&gt;</span> eq_int_int <span class="keyword">(</span>i1<span class="keyword">,</span> i2<span class="keyword">)</span>
    <span class="keyword">|</span> S2Eintinf i2 <span class="keyword">=&gt;</span> $IntInf<span class="keyword">.</span>eq_int_intinf <span class="keyword">(</span>i1<span class="keyword">,</span> i2<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eint]
</span>  <span class="keyword">|</span> S2Eintinf i1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eint i2 <span class="keyword">=&gt;</span> $IntInf<span class="keyword">.</span>eq_intinf_int <span class="keyword">(</span>i1<span class="keyword">,</span> i2<span class="keyword">)</span>
    <span class="keyword">|</span> S2Eintinf i2 <span class="keyword">=&gt;</span> $IntInf<span class="keyword">.</span>eq_intinf_intinf <span class="keyword">(</span>i1<span class="keyword">,</span> i2<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eintinf]
</span>  <span class="keyword">|</span> S2Eout s2e1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eout s2e2 <span class="keyword">=&gt;</span> s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eout]
</span>  <span class="keyword">|</span> S2Eproj <span class="keyword">(</span>s2e1<span class="comment">(*root*)</span><span class="keyword">,</span> s2l1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eproj <span class="keyword">(</span>s2e2<span class="comment">(*root*)</span><span class="keyword">,</span> s2l2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> andalso s2lab_syneq <span class="keyword">(</span>s2l1<span class="keyword">,</span> s2l2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eproj]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eproj]
</span>  <span class="keyword">|</span> S2Eread <span class="keyword">(</span>_v1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eread <span class="keyword">(</span>_v2<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>_v1<span class="keyword">,</span> _v2<span class="keyword">)</span> andalso s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eread]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eread]
</span>  <span class="keyword">|</span> S2Erefarg <span class="keyword">(</span>refval1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Erefarg <span class="keyword">(</span>refval2<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        refval1 <span class="keyword">=</span> refval2 andalso s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Erefarg]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Erefarg]
</span>  <span class="keyword">|</span> S2Esel <span class="keyword">(</span>s2e1<span class="keyword">,</span> i1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Esel <span class="keyword">(</span>s2e2<span class="keyword">,</span> i2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>i1 <span class="keyword">=</span> i2 andalso s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Esel]
</span>  <span class="keyword">|</span> S2Esize s2ze1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span> 
    <span class="keyword">|</span> S2Esize s2ze2 <span class="keyword">=&gt;</span> s2zexp_syneq <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2ze2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Esize]
</span>  <span class="keyword">|</span> S2Esizeof s2e1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Esizeof s2e2 <span class="keyword">=&gt;</span> s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Esizeof]
</span>  <span class="keyword">|</span> S2Etop <span class="keyword">(</span>knd1<span class="keyword">,</span> s2e1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etop <span class="keyword">(</span>knd2<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>knd1 <span class="keyword">=</span> knd2 andalso s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etop]
</span>  <span class="keyword">|</span> S2Etup s2es1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etup s2es2 <span class="keyword">=&gt;</span> s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etup]
</span>  <span class="keyword">|</span> S2Etylst s2es1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etylst s2es2 <span class="keyword">=&gt;</span> s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etylst]
</span>  <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e1_elt<span class="keyword">,</span> s2ess1_ind<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e2_elt<span class="keyword">,</span> s2ess2_ind<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>s2e1_elt<span class="keyword">,</span> s2e2_elt<span class="keyword">)</span> andalso
        s2explstlst_syneq <span class="keyword">(</span>s2ess1_ind<span class="keyword">,</span> s2ess2_ind<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>  <span class="keyword">|</span> S2Etyleq <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e11<span class="keyword">,</span> s2e12<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etyleq <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e21<span class="keyword">,</span> s2e22<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2exp_syneq <span class="keyword">(</span>s2e11<span class="keyword">,</span> s2e21<span class="keyword">)</span> andalso s2exp_syneq <span class="keyword">(</span>s2e12<span class="keyword">,</span> s2e22<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Etyleq]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyleq]
</span>  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd1<span class="keyword">,</span> npf1<span class="keyword">,</span> ls2es1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd2<span class="keyword">,</span> npf2<span class="keyword">,</span> ls2es2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        knd1 <span class="keyword">=</span> knd2 andalso npf1 <span class="keyword">=</span> npf2 andalso
        labs2explst_syneq <span class="keyword">(</span>ls2es1<span class="keyword">,</span> ls2es2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>s1<span class="keyword">,</span> s2e1_ind<span class="keyword">,</span> ls2es1_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>s2<span class="keyword">,</span> s2e2_ind<span class="keyword">,</span> ls2es2_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        $Stamp<span class="keyword">.</span>eq_stamp_stamp <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span> andalso
        s2exp_syneq <span class="keyword">(</span>s2e1_ind<span class="keyword">,</span> s2e2_ind<span class="keyword">)</span> andalso
        labs2explst_syneq <span class="keyword">(</span>ls2es1_body<span class="keyword">,</span> ls2es2_body<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>  <span class="keyword">|</span> S2Evar s2v1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Evar s2v2 <span class="keyword">=&gt;</span> eq_s2var_s2var <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2v2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2Evar]
</span>  <span class="keyword">|</span> S2EVar s2V1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e20<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2EVar s2V2 <span class="keyword">=&gt;</span> eq_s2Var_s2Var <span class="keyword">(</span>s2V1<span class="keyword">,</span> s2V2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2EVar]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false <span class="comment">(* test accuracy may be increased ... *)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_syneq]
</span>
<span class="keyword">implement</span>
s2explst_syneq <span class="keyword">(</span>s2es10<span class="keyword">,</span> s2es20<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>s2es10<span class="keyword">,</span> s2es20<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>s2e1 :: s2es1<span class="keyword">,</span> s2e2 :: s2es2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> andalso s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">// end of [_,_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2explst_syneq]
</span>
<span class="keyword">implement</span>
s2explstlst_syneq <span class="keyword">(</span>s2ess10<span class="keyword">,</span> s2ess20<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>s2ess10<span class="keyword">,</span> s2ess20<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>s2es1 :: s2ess1<span class="keyword">,</span> s2es2 :: s2ess2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      s2explst_syneq <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2es2<span class="keyword">)</span> andalso s2explstlst_syneq <span class="keyword">(</span>s2ess1<span class="keyword">,</span> s2ess2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">// end of [_,_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2explstlst_syneq]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> labs2zexplst_syneq <span class="keyword">(</span>
    ls2zes1<span class="keyword">:</span> <span class="staexp">labs2zexplst</span><span class="keyword">,</span> ls2zes2<span class="keyword">:</span> <span class="staexp">labs2zexplst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>ls2zes1<span class="keyword">,</span> ls2zes2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>LABS2ZEXPLSTcons <span class="keyword">(</span>l1<span class="keyword">,</span> s2ze1<span class="keyword">,</span> ls2zes1<span class="keyword">)</span><span class="keyword">,</span>
     LABS2ZEXPLSTcons <span class="keyword">(</span>l2<span class="keyword">,</span> s2ze2<span class="keyword">,</span> ls2zes2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      l1 <span class="keyword">=</span> l2 andalso
      s2zexp_syneq <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2ze2<span class="keyword">)</span> andalso
      labs2zexplst_syneq <span class="keyword">(</span>ls2zes1<span class="keyword">,</span> ls2zes2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_cons, _cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>LABS2ZEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> LABS2ZEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">// end of [_,_]
</span><span class="keyword">end</span> <span class="comment">// end of [labs2zexplst_syneq]
</span>
<span class="keyword">fun</span> s2zexplst_syneq
  <span class="keyword">(</span>s2zes1<span class="keyword">:</span> <span class="staexp">s2zexplst</span><span class="keyword">,</span> s2zes2<span class="keyword">:</span> <span class="staexp">s2zexplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>s2zes1<span class="keyword">,</span> s2zes2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2zes1<span class="keyword">)</span><span class="keyword">,</span> cons <span class="keyword">(</span>s2ze2<span class="keyword">,</span> s2zes2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> s2zexp_syneq <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2ze2<span class="keyword">)</span> <span class="keyword">then</span> s2zexplst_syneq <span class="keyword">(</span>s2zes1<span class="keyword">,</span> s2zes2<span class="keyword">)</span>
      <span class="keyword">else</span> false
    <span class="keyword">end</span> <span class="comment">// end of [cons, cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">// end of [_,_]
</span><span class="comment">// end of [s2zexplst_syneq]
</span>
<span class="keyword">implement</span>
s2zexp_syneq <span class="keyword">(</span>s2ze10<span class="keyword">,</span> s2ze20<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2zexp_syneq: s2ze10 = "; print_s2zexp s2ze10; print_newline ()
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2ze10 <span class="keyword">of</span>
  <span class="keyword">|</span> S2ZEapp <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2zes1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEapp <span class="keyword">(</span>s2ze2<span class="keyword">,</span> s2zes2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> s2zexp_syneq <span class="keyword">(</span>s2ze1<span class="keyword">,</span> s2ze2<span class="keyword">)</span>
          <span class="keyword">then</span> s2zexplst_syneq <span class="keyword">(</span>s2zes1<span class="keyword">,</span> s2zes2<span class="keyword">)</span> <span class="keyword">else</span> false
        <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2ZEapp]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEapp]
</span>  <span class="keyword">|</span> S2ZEbot <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false <span class="comment">// [S2ZEbot &lt;&gt; S2ZEbot]!
</span>  <span class="keyword">|</span> S2ZEcst s2c1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEcst s2c2 <span class="keyword">=&gt;</span> eq_s2cst_s2cst <span class="keyword">(</span>s2c1<span class="keyword">,</span> s2c2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEcst]
</span>  <span class="keyword">|</span> S2ZEextype name1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEextype name2 <span class="keyword">=&gt;</span> <span class="keyword">(</span>name1 <span class="keyword">=</span> name2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEextype]
</span>  <span class="keyword">|</span> S2ZEptr <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>
      <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span> S2ZEptr <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">)</span> <span class="comment">// end of [S2ZEptr]
</span>  <span class="keyword">|</span> S2ZEtyarr <span class="keyword">(</span>s2ze1_elt<span class="keyword">,</span> s2ess1_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEtyarr <span class="keyword">(</span>s2ze2_elt<span class="keyword">,</span> s2ess2_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        s2zexp_syneq <span class="keyword">(</span>s2ze1_elt<span class="keyword">,</span> s2ze2_elt<span class="keyword">)</span> andalso
        s2explstlst_syneq <span class="keyword">(</span>s2ess1_dim<span class="keyword">,</span> s2ess2_dim<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2ZEtyarr]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEtyarr]
</span>  <span class="keyword">|</span> S2ZEtyrec <span class="keyword">(</span>knd1<span class="keyword">,</span> ls2zes1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEtyrec <span class="keyword">(</span>knd2<span class="keyword">,</span> ls2zes2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        knd1 <span class="keyword">=</span> knd2 andalso labs2zexplst_syneq <span class="keyword">(</span>ls2zes1<span class="keyword">,</span> ls2zes2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2ZEtyrec]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEtyrec]
</span>  <span class="keyword">|</span> S2ZEunion <span class="keyword">(</span>s1<span class="keyword">,</span> ls2zes1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEunion <span class="keyword">(</span>s2<span class="keyword">,</span> ls2zes2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        $Stamp<span class="keyword">.</span>eq_stamp_stamp <span class="keyword">(</span>s1<span class="keyword">,</span> s2<span class="keyword">)</span> andalso
        labs2zexplst_syneq <span class="keyword">(</span>ls2zes1<span class="keyword">,</span> ls2zes2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2ZEunion]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEunion]
</span>  <span class="keyword">|</span> S2ZEvar s2v1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ze20 <span class="keyword">of</span>
    <span class="keyword">|</span> S2ZEvar s2v2 <span class="keyword">=&gt;</span> eq_s2var_s2var <span class="keyword">(</span>s2v1<span class="keyword">,</span> s2v2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
    <span class="keyword">end</span> <span class="comment">// end of [S2ZEvar]
</span><span class="keyword">end</span> <span class="comment">// end of [s2zexp_syneq]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_projlst <span class="keyword">(</span>s2e<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_projlst <span class="keyword">(</span>s2exp_proj <span class="keyword">(</span>s2e<span class="keyword">,</span> s2l<span class="keyword">)</span><span class="keyword">,</span> s2ls<span class="keyword">)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e
<span class="keyword">end</span> <span class="comment">// end of [s2exp_projlst]
</span>
<span class="keyword">implement</span>
s2exp_addr_normalize <span class="keyword">(</span>s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
    s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">s2lablst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="keyword">,</span> s2lablst<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eproj <span class="keyword">(</span>s2e0<span class="keyword">,</span> s2l<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>s2e0<span class="keyword">,</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>s2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="comment">// end of [_]
</span>  <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>s2e0<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_addr_normalize]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2exp_prenexing <span class="keyword">(</span>
  isexi<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
<span class="keyword">,</span> s2vs_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
<span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0 <span class="keyword">in</span> <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> s2cstref_exp_equ <span class="keyword">(</span>At_viewt0ype_addr_view<span class="keyword">,</span> s2e_fun<span class="keyword">)</span> <span class="keyword">then</span>
          <span class="keyword">case+</span> s2es_arg <span class="keyword">of</span>
          <span class="keyword">|</span> cons <span class="keyword">(</span>s2e_at<span class="keyword">,</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
              <span class="keyword">val</span> s2e_at <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> s2e_at<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
            <span class="keyword">in</span>
              <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> s2exp_app_srt
                <span class="keyword">(</span>s2rt_view<span class="keyword">,</span> s2e_fun<span class="keyword">,</span> cons <span class="keyword">(</span>s2e_at<span class="keyword">,</span> cons<span class="keyword">(</span>s2l<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
              <span class="keyword">else</span> s2e0
            <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              prerr ": s2exp_prenexing: At_viewt0ype_addr_view"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [_]
</span>        <span class="keyword">else</span> s2e0 <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>    <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> isexi <span class="keyword">then</span>
          s2exp_prenexing_main <span class="keyword">(</span>isexi<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_body<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
        <span class="keyword">else</span> s2e0 <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2Eexi]
</span>    <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
        <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> ls2es<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span>
          s2exp_tyrec_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">else</span> s2e0 <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>    <span class="keyword">|</span> S2Euni <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> isexi <span class="keyword">then</span> s2e0 <span class="keyword">else</span>
          s2exp_prenexing_main <span class="keyword">(</span>isexi<span class="keyword">,</span> s2vs<span class="keyword">,</span> s2ps<span class="keyword">,</span> s2e_body<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
        <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [S2Euni]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> s2e0
<span class="keyword">end</span> <span class="comment">// end of [s2exp_prenexing]
</span>
<span class="keyword">and</span> s2exp_prenexing_main <span class="keyword">(</span>
    isexi<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">,</span> s2ps<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> s2e_body<span class="keyword">:</span> <span class="staexp">s2exp</span>
  <span class="keyword">,</span> s2vs_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">@(</span>sub<span class="keyword">,</span> s2vs<span class="keyword">)</span> <span class="keyword">=</span> stasub_extend_svarlst <span class="keyword">(</span>stasub_nil<span class="keyword">,</span> s2vs<span class="keyword">)</span>
  <span class="keyword">val</span> s2ps <span class="keyword">=</span> s2explst_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2ps<span class="keyword">)</span>
  <span class="keyword">val</span> s2e_body <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e_body<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> flag := flag + 1
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2vs_r := $Lst<span class="keyword">.</span>list_revapp <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2vs_r<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> s2ps_r := $Lst<span class="keyword">.</span>list_revapp <span class="keyword">(</span>s2ps<span class="keyword">,</span> s2ps_r<span class="keyword">)</span><span class="keyword">;</span>
  <span class="keyword">val</span> s2e_body <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> s2e_body<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">in</span>
  s2e_body
<span class="keyword">end</span> <span class="comment">// end of [s2exp_prenexing_main]
</span>
<span class="keyword">and</span> s2explst_prenexing <span class="keyword">(</span>
    isexi<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> s2es0<span class="keyword">:</span> <span class="staexp">s2explst</span>
  <span class="keyword">,</span> s2vs_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2es0 <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> s2e<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> s2es <span class="keyword">=</span> s2explst_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> s2es<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">else</span> s2es0
    <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_prenexing]
</span>
<span class="keyword">and</span> labs2explst_prenexing <span class="keyword">(</span>
    isexi<span class="keyword">:</span> <span class="staexp">bool</span>
  <span class="keyword">,</span> ls2es0<span class="keyword">:</span> <span class="staexp">labs2explst</span>
  <span class="keyword">,</span> s2vs_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2varlst</span><span class="keyword">,</span> s2ps_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> flag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls2es0 <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> flag0 <span class="keyword">=</span> flag
      <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> s2e<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
      <span class="keyword">val</span> ls2es <span class="keyword">=</span> labs2explst_prenexing <span class="keyword">(</span>isexi<span class="keyword">,</span> ls2es<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> flag <span class="keyword">&gt;</span> flag0 <span class="keyword">then</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">else</span> ls2es0
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_prenexing]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_absuni <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> s2vs_r<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">and</span> s2ps_r<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>false<span class="comment">(*isexi*)</span><span class="keyword">,</span> s2e<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>$Lst<span class="keyword">.</span>list_reverse s2vs_r<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_reverse s2ps_r<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_absuni]
</span>
<span class="keyword">implement</span>
s2exp_opnexi <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> s2vs_r<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">and</span> s2ps_r<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2e <span class="keyword">=</span> s2exp_prenexing <span class="keyword">(</span>true<span class="comment">(*isexi*)</span><span class="keyword">,</span> s2e<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>$Lst<span class="keyword">.</span>list_reverse s2vs_r<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_reverse s2ps_r<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_opnexi]
</span>
<span class="keyword">implement</span>
s2explst_opnexi <span class="keyword">(</span>s2es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> flag<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">var</span> s2vs_r<span class="keyword">:</span> <span class="staexp">s2varlst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">and</span> s2ps_r<span class="keyword">:</span> <span class="staexp">s2explst</span> <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> s2es <span class="keyword">=</span> s2explst_prenexing <span class="keyword">(</span>true<span class="comment">(*isexi*)</span><span class="keyword">,</span> s2es<span class="keyword">,</span> s2vs_r<span class="keyword">,</span> s2ps_r<span class="keyword">,</span> flag<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>$Lst<span class="keyword">.</span>list_reverse s2vs_r<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_reverse s2ps_r<span class="keyword">,</span> s2es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_opnexi]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
labs2explst_lab_get <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_get <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">s2expopt_vt</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> l0 <span class="keyword">=</span> l <span class="keyword">then</span> Some_vt s2e <span class="keyword">else</span> aux_get ls2es
      <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux_get]
</span><span class="keyword">in</span>
  aux_get ls2es
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_lab_get]
</span>
<span class="keyword">implement</span>
labs2explst_lab_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_set
    <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">Option_vt labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> l0 <span class="keyword">=</span> l <span class="keyword">then</span> <span class="keyword">begin</span>
          Some_vt <span class="keyword">(</span>LABS2EXPLSTcons <span class="keyword">(</span>l0<span class="keyword">,</span> s2e0<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> aux_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ls2es <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [LABS2EXPLSTcons] *)</span>
    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux_set]
</span><span class="keyword">in</span>
  aux_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> s2e0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_lab_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
labs2zexplst_lab_get <span class="keyword">(</span>ls2zes<span class="keyword">,</span> l0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_get
    <span class="keyword">(</span>ls2zes<span class="keyword">:</span> <span class="staexp">labs2zexplst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">s2zexpopt_vt</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> ls2zes <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2ZEXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2ze<span class="keyword">,</span> ls2zes<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> l0 <span class="keyword">=</span> l <span class="keyword">then</span> Some_vt s2ze <span class="keyword">else</span> aux_get ls2zes
      <span class="keyword">end</span> <span class="comment">// end of [LABS2ZEXPLSTcons]
</span>    <span class="keyword">|</span> LABS2ZEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux_get]
</span><span class="keyword">in</span>
  aux_get ls2zes
<span class="keyword">end</span> <span class="comment">// end of [labs2zexplst_lab_get]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> labs2explst_lab_get_ind
  <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> l0<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>int?<span class="keyword">)</span> &gt;&gt; int</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">s2expopt_vt</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_get
    <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">s2expopt_vt</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> l0 <span class="keyword">=</span> l <span class="keyword">then</span> Some_vt s2e <span class="keyword">else</span> <span class="keyword">(</span>i := i+1<span class="keyword">;</span> aux_get <span class="keyword">(</span>i<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>i := ~1<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux_get]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>i := 0<span class="keyword">)</span>
  <span class="keyword">val</span> os2e <span class="keyword">=</span> aux_get <span class="keyword">(</span>i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
<span class="keyword">in</span>
  os2e
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_lab_get_ind]
</span>
<span class="keyword">fn</span> labs2explst_lab_set_ind
  <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> l0<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>int?<span class="keyword">)</span> &gt;&gt; int</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">Option_vt <span class="keyword">(</span>labs2explst<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_set
    <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">Option_vt labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> l0 <span class="keyword">=</span> l <span class="keyword">then</span> <span class="keyword">begin</span>
          Some_vt <span class="keyword">(</span>LABS2EXPLSTcons <span class="keyword">(</span>l0<span class="keyword">,</span> s2e0<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> aux_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> s2e0<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ls2es <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              i := i + 1<span class="keyword">;</span> Some_vt <span class="keyword">(</span>LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span><span class="keyword">)</span>
            <span class="keyword">end</span>
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [LABS2EXPLSTcons] *)</span>
    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>i := ~1<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux_set]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>i := 0<span class="keyword">)</span>
<span class="keyword">in</span>
  aux_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> s2e0<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_lab_set_ind]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_lab_get_restlin_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">,</span> restlin<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
  <span class="keyword">fn</span> err1 <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> l0<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error3 loc0<span class="keyword">;</span>
    prerr ": the label ["<span class="keyword">;</span>
    prerr l0<span class="keyword">;</span>
    prerr "] is not found in ["<span class="keyword">;</span>
    prerr s2e0<span class="keyword">;</span>
    prerr "]."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span>  <span class="keyword">fn</span> err2 <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error3 loc0<span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": [%s]: s2exp_lab_get_restlin_cstr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": the type ["<span class="keyword">;</span>
    prerr s2e0<span class="keyword">;</span>
    prerr "] is expected to be a record or union but it is not."<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err2]
</span>  <span class="keyword">fun</span> aux_restlin
    <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> restlin<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i &lt;&gt; 0 <span class="keyword">then</span> <span class="keyword">begin</span>
          <span class="keyword">(</span><span class="keyword">if</span> s2exp_is_linear s2e <span class="keyword">then</span> restlin := restlin + 1<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        aux_restlin <span class="keyword">(</span>i-1<span class="keyword">,</span> ls2es<span class="keyword">,</span> restlin<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux_restlin]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> _<span class="comment">(*npf*)</span><span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">(* uninitialized *)</span>
      <span class="keyword">val</span> os2e <span class="keyword">=</span> labs2explst_lab_get_ind <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> os2e <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e <span class="keyword">=&gt;</span> <span class="keyword">(</span>aux_restlin <span class="keyword">(</span>i<span class="keyword">,</span> ls2es<span class="keyword">,</span> restlin<span class="keyword">)</span><span class="keyword">;</span> s2e<span class="keyword">)</span>
      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>_<span class="comment">(*stamp*)</span><span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">(* uninitialized *)</span>
      <span class="keyword">val</span> os2e <span class="keyword">=</span> labs2explst_lab_get_ind <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> i<span class="keyword">)</span>
      <span class="keyword">val</span> s2e <span class="keyword">=</span> <span class="keyword">case+</span> os2e <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e <span class="keyword">=&gt;</span> s2e <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err1 <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_restlin <span class="keyword">(</span>i<span class="keyword">,</span> ls2es<span class="keyword">,</span> restlin<span class="keyword">)</span>
      <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_eqeq <span class="keyword">(</span>s2i<span class="keyword">,</span> s2exp_int i<span class="keyword">)</span>
    <span class="keyword">in</span>
      cstr := cons <span class="keyword">(</span>s2p<span class="keyword">,</span> cstr<span class="keyword">)</span><span class="keyword">;</span> s2e
    <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err2 <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_lab_get_restlin_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_slablst_get_restlin_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> restlin<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> i<span class="keyword">)</span></span>
    <span class="keyword">,</span> restlin<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
    <span class="keyword">,</span> s2ls_vt<span class="keyword">:</span> <span class="staexp">list_vt <span class="keyword">(</span>s2lab<span class="keyword">,</span> j<span class="keyword">)</span></span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="keyword">,</span> list <span class="keyword">(</span>s2lab<span class="keyword">,</span> i+j<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l <span class="keyword">=</span> <span class="keyword">case+</span> s2l <span class="keyword">of</span>
          <span class="keyword">|</span> S2LAB0lab l <span class="keyword">=&gt;</span> l
          <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> l <span class="comment">// this should not happen!
</span>          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error3 loc0<span class="keyword">;</span>
              prerr ": the use of array subscription is not supported."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>lab_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
        <span class="keyword">val</span> s2e0_prj <span class="keyword">=</span> <span class="keyword">begin</span>
          s2exp_lab_get_restlin_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> restlin<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [val]
</span>        <span class="keyword">val</span> s2ls_vt <span class="keyword">=</span> list_vt_cons <span class="keyword">(</span>S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">,</span> s2ls_vt<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux <span class="keyword">(</span>s2e0_prj<span class="keyword">,</span> s2ls<span class="keyword">,</span> restlin<span class="keyword">,</span> cstr<span class="keyword">,</span> s2ls_vt<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">@(</span>s2e0<span class="keyword">,</span> $Lst<span class="keyword">.</span>list_vt_reverse_list s2ls_vt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> restlin<span class="keyword">,</span> cstr<span class="keyword">,</span> list_vt_nil<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_slablst_get_restlin_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> s2exp_is_int_0 <span class="keyword">(</span>s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span> S2Eint i <span class="keyword">=&gt;</span> i <span class="keyword">=</span> 0 <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
<span class="comment">// end of [s2exp_is_int]
</span>
<span class="keyword">fn</span> un_s2exp_int <span class="keyword">(</span>s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt int</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span> S2Eint i <span class="keyword">=&gt;</span> Some_vt i <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [un_s2exp_int]
</span>
<span class="keyword">fun</span> labs2explst_nth_get
  <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>lab_t<span class="keyword">,</span> s2exp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> labs2explst_nth_get <span class="keyword">(</span>ls2es<span class="keyword">,</span> i-1<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">@(</span>l<span class="keyword">,</span> s2e<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": labs2explst_nth_get: i = "<span class="keyword">;</span> prerr i<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTnil]
</span><span class="keyword">end</span> <span class="comment">(* end of [labs2explst_nth_get] *)</span>

<span class="keyword">fun</span> labs2explst_nth_set
  <span class="keyword">(</span>ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
  <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> labs2explst_nth_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> i-1<span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        LABS2EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> s2e0<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [LABS2EXPLSTcons] *)</span>
  <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": labs2explst_nth_set: i = "<span class="keyword">;</span> prerr i<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [LABS2EXPLSTnil] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [labs2explst_nth_set] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> array_ind_dim_check_err <span class="keyword">(</span>
    s2ess_ind<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
  <span class="keyword">,</span> s2ess_dim<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
  <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> err<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> auxlstlst
  <span class="keyword">(</span>s2ess_ind<span class="keyword">,</span> s2ess_dim<span class="keyword">,</span> cstr<span class="keyword">,</span> err<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> auxlst <span class="keyword">(</span>
      s2es_ind<span class="keyword">:</span> <span class="staexp">s2explst</span>
    <span class="keyword">,</span> s2es_dim<span class="keyword">:</span> <span class="staexp">s2explst</span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> err<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">(</span>s2es_ind<span class="keyword">,</span> s2es_dim<span class="keyword">)</span> <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>s2e_ind<span class="keyword">,</span> s2es_ind<span class="keyword">)</span><span class="keyword">,</span>
         cons <span class="keyword">(</span>s2e_dim<span class="keyword">,</span> s2es_dim<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> s2p <span class="keyword">=</span>
            s2exp_btw_int_int_int_bool <span class="keyword">(</span>s2exp_int_0<span class="keyword">,</span> s2e_ind<span class="keyword">,</span> s2e_dim<span class="keyword">)</span>
          <span class="comment">// end of [val]
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cstr := cons <span class="keyword">(</span>s2p<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">in</span>
          auxlst <span class="keyword">(</span>s2es_ind<span class="keyword">,</span> s2es_dim<span class="keyword">,</span> cstr<span class="keyword">,</span> err<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [cons, cons]
</span>      <span class="keyword">|</span> <span class="keyword">(</span>nil _<span class="keyword">,</span> nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [auxlst]
</span>  <span class="keyword">fun</span> auxlstlst <span class="keyword">(</span>
      s2ess_ind<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
    <span class="keyword">,</span> s2ess_dim<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span><span class="keyword">,</span> err<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">(</span>s2ess_ind<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>s2es_ind<span class="keyword">,</span> s2ess_ind<span class="keyword">)</span><span class="keyword">,</span>
         cons <span class="keyword">(</span>s2es_dim<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> auxlst <span class="keyword">(</span>s2es_ind<span class="keyword">,</span> s2es_dim<span class="keyword">,</span> cstr<span class="keyword">,</span> err<span class="keyword">)</span>
        <span class="keyword">in</span>
          auxlstlst <span class="keyword">(</span>s2ess_ind<span class="keyword">,</span> s2ess_dim<span class="keyword">,</span> cstr<span class="keyword">,</span> err<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [cons, cons]
</span>      <span class="keyword">|</span> <span class="keyword">(</span>nil _<span class="keyword">,</span> nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>err := 1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [auxlstlst]
</span><span class="keyword">}</span> <span class="comment">// end of [array_ind_dim_check_err]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> <span class="comment">// [s2e0] must be normalized!
</span>s2exp_lab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
<span class="comment">//
</span>  <span class="keyword">fn</span> linear_abandonment_errmsg
    <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> l0<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error3 loc0<span class="keyword">;</span>
    prerr ": the linear union component with the label ["<span class="keyword">;</span>
    prerr l0<span class="keyword">;</span>
    prerr "] is abandoned"<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [linear_abandonment_errmsg]
</span><span class="comment">//
</span>  <span class="keyword">fn</span> label_notfound_errmsg
    <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> l0<span class="keyword">:</span> <span class="staexp">lab_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error3 loc0<span class="keyword">;</span>
    prerr ": the label ["<span class="keyword">;</span>
    prerr l0<span class="keyword">;</span>
    prerr "] is not found in ["<span class="keyword">;</span>
    prerr s2e0<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [label_notfound_errmsg]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> labs2explst_lab_get <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">)</span> <span class="keyword">in</span>
      <span class="keyword">case+</span> ans <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> label_notfound_errmsg <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">)</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e <span class="keyword">=&gt;</span> s2e
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e_res <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span>
      <span class="keyword">var</span> isint<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> s2e_res<span class="keyword">:</span> <span class="staexp">s2exp</span> <span class="comment">(* ? *)</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> labs2explst_lab_get_ind <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> i<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> ans <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">case+</span> un_s2exp_int s2i <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt i0 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
            <span class="keyword">|</span> _ <span class="keyword">when</span> i0 <span class="keyword">=</span> i <span class="keyword">=&gt;</span> <span class="keyword">(</span>isint := 1<span class="keyword">;</span> s2e_res := s2e<span class="keyword">)</span>
            <span class="keyword">|</span> _ <span class="keyword">when</span> i0 &gt;= 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> ls2e <span class="keyword">=</span> labs2explst_nth_get <span class="keyword">(</span>ls2es<span class="keyword">,</span> i0<span class="keyword">)</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="comment">(*linarity checking*)</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span>
                  s2exp_is_linear <span class="keyword">(</span>ls2e<span class="keyword">.</span>1<span class="keyword">)</span> <span class="keyword">then</span> linear_abandonment_errmsg <span class="keyword">(</span>loc0<span class="keyword">,</span> l0<span class="keyword">)</span>
                <span class="comment">// end of [val]
</span>              <span class="keyword">in</span>
                isint := 1<span class="keyword">;</span> s2e_res := s2exp_topize <span class="keyword">(</span>0<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [Some_vt when ...]
</span>            <span class="keyword">|</span> _ <span class="comment">(* i0 = ~1 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                isint := 1<span class="keyword">;</span> s2e_res := s2exp_topize <span class="keyword">(</span>0<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_]
</span>            <span class="keyword">end</span> <span class="comment">(* end of [Some_vt] *)</span>
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e_res := s2e
          <span class="keyword">end</span> <span class="comment">(* end of [Some_vt] *)</span>
        <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            s2e_res := label_notfound_errmsg <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isint <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2i_new <span class="keyword">=</span> s2exp_int i<span class="keyword">;</span> <span class="keyword">val</span> s2p <span class="keyword">=</span> s2exp_eqeq <span class="keyword">(</span>s2i<span class="keyword">,</span> s2i_new<span class="keyword">)</span>
      <span class="keyword">in</span>
        cstr := cons <span class="keyword">(</span>s2p<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">}</span> <span class="comment">// end of [S2Eunion]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error3 loc0<span class="keyword">;</span>
      $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": %s: s2exp_lab_linget_cstr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": the type ["<span class="keyword">;</span>
      prerr s2e0<span class="keyword">;</span>
      prerr "] is expected to be a record or union but it is not."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [s2exp_lab_linget_cstr] *)</span>

<span class="comment">// [s2e0] must be normalized!
</span><span class="keyword">implement</span>
s2exp_ind_linget_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ess_ind<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> err<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> array_ind_dim_check_err <span class="keyword">(</span>s2ess_ind<span class="keyword">,</span> s2ess_dim<span class="keyword">,</span> cstr<span class="keyword">,</span> err<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> err <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        prerr_loc_error3 loc0<span class="keyword">;</span>
        prerr ": array index/dimension mismatch."<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      s2e_elt
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_error3 loc0<span class="keyword">;</span>
      prerr ": the type ["<span class="keyword">;</span> prerr s2e0<span class="keyword">;</span>
      prerr "] is expected to be an array but it is not."<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [s2exp_ind_linget_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// [s2e0] is assumed to have been normalized
</span><span class="keyword">implement</span>
s2exp_slab_linget_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2l<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2l <span class="keyword">of</span>
  <span class="keyword">|</span> S2LAB0lab l <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e_prj <span class="keyword">=</span> s2exp_lab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> cstr<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">@(</span>s2e_prj<span class="keyword">,</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2LAB0lab]
</span>  <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e_prj <span class="keyword">=</span> s2exp_lab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> cstr<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">@(</span>s2e_prj<span class="keyword">,</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2LAB0lab]
</span>  <span class="keyword">|</span> S2LAB0ind <span class="keyword">(</span>s2ess_ind<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2e_elt <span class="keyword">=</span> s2exp_ind_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ess_ind<span class="keyword">,</span> cstr<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">@(</span>s2e_elt<span class="keyword">,</span> S2LAB1ind <span class="keyword">(</span>s2ess_ind<span class="keyword">,</span> s2e_elt<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2LAB0ind]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": s2exp_slab_linget_get: S2LAB1ind"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [s2exp_slab_linget_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// [s2e0] is assumed to have been normalized
</span><span class="keyword">implement</span>
s2exp_lab_linset <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l0<span class="keyword">,</span> s2e_new<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> err <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>type<span class="keyword">}</span></span> <span class="keyword">(</span>loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_interror loc0<span class="keyword">;</span> prerr ": s2exp_slab_set"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>       
    <span class="keyword">case+</span> labs2explst_lab_set <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> s2e_new<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ls2es <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> knd <span class="keyword">of</span>
      <span class="keyword">|</span> TYRECKINDflt0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tyrec <span class="keyword">(</span>0<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          s2exp_tyrec_srt <span class="keyword">(</span>s2e0<span class="keyword">.</span>s2exp_srt<span class="keyword">,</span> knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err <span class="keyword">(</span>loc0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Eunion <span class="keyword">(</span>stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t0 <span class="keyword">=</span> s2e0<span class="keyword">.</span>s2exp_srt
      <span class="keyword">val</span> isbox <span class="keyword">=</span> s2rt_is_boxed s2t0
      <span class="keyword">val</span> istop <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> s2e_new<span class="keyword">.</span>s2exp_node <span class="keyword">of</span> S2Etop _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      <span class="keyword">if</span> istop <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2i <span class="keyword">=</span> s2exp_int <span class="keyword">(</span>~1<span class="keyword">)</span>
        <span class="keyword">val</span> s2t0<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span> <span class="keyword">if</span> isbox <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_t0ype
      <span class="keyword">in</span>
        s2exp_union_srt <span class="keyword">(</span>s2t0<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span>
        <span class="keyword">val</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span> <span class="keyword">=</span> <span class="keyword">case+</span> 
          labs2explst_lab_set_ind <span class="keyword">(</span>ls2es<span class="keyword">,</span> l0<span class="keyword">,</span> s2e_new<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt ls2es <span class="keyword">=&gt;</span> ls2es <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> err <span class="keyword">(</span>loc0<span class="keyword">)</span>
        <span class="keyword">val</span> s2i <span class="keyword">=</span> <span class="keyword">case+</span> un_s2exp_int s2i <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> s2i <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_int i
        <span class="keyword">val</span> s2t0<span class="keyword">:</span> <span class="staexp">s2rt</span> <span class="keyword">=</span>
          <span class="keyword">if</span> s2exp_is_linear s2e_new <span class="keyword">then</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> isbox <span class="keyword">then</span> s2rt_viewtype <span class="keyword">else</span> s2rt_viewt0ype
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> isbox <span class="keyword">then</span> s2rt_type <span class="keyword">else</span> s2rt_t0ype
          <span class="keyword">end</span>
      <span class="keyword">in</span>
        s2exp_union_srt <span class="keyword">(</span>s2t0<span class="keyword">,</span> stamp<span class="keyword">,</span> s2i<span class="keyword">,</span> ls2es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Eunion]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err <span class="keyword">(</span>loc0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_lab_linset] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_slablst_lintry_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
        <span class="keyword">val</span> <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2l<span class="keyword">)</span> <span class="keyword">=</span> s2exp_slab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2l<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> s2ls <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
      <span class="keyword">in</span>
        cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">(* end of [aux] *)</span>
<span class="keyword">in</span>
  aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_slablst_lintry_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_slablst_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
    <span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>s2exp<span class="keyword">,</span> s2expopt_vt<span class="keyword">,</span> list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
        <span class="keyword">val</span> <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2l<span class="keyword">)</span> <span class="keyword">=</span> s2exp_slab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2l<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span>s2e_prj<span class="keyword">,</span> os2e1<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> os2e0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> os2e1 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2l <span class="keyword">of</span>
            <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>s2exp_lab_linset <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> s2e1<span class="keyword">)</span><span class="keyword">)</span>
            <span class="keyword">|</span> S2LAB1ind <span class="keyword">(</span>_<span class="keyword">,</span> s2e_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cstr := cons <span class="keyword">(</span>s2exp_tyleq <span class="keyword">(</span>1<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e_elt<span class="keyword">)</span><span class="keyword">,</span> cstr<span class="keyword">)</span>
              <span class="keyword">}</span> <span class="comment">// end of [S2LAB1ind]
</span>            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_loc_interror loc0<span class="keyword">;</span>
                prerr ": s2exp_slablst_linget_cstr: aux"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2expopt_vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_]
</span>            <span class="keyword">end</span> <span class="comment">(* end of [Some_vt] *)</span>
          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2expopt_vt</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span>s2e_prj<span class="keyword">,</span> os2e0<span class="keyword">,</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> os2e0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> s2exp_is_linear s2e0
          <span class="keyword">then</span> Some_vt <span class="keyword">(</span>s2exp_topize <span class="keyword">(</span>1<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2expopt_vt</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span>s2e0<span class="keyword">,</span> os2e0<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span>  <span class="keyword">val</span> <span class="keyword">(</span>s2e_prj<span class="keyword">,</span> os2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> os2e0 <span class="keyword">of</span> <span class="keyword">~</span>Some_vt s2e0 <span class="keyword">=&gt;</span> s2e0 <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>s2e_prj<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_slablst_linget_cstr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_slablst_linset_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> s2e_new<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
    <span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> s2e_new<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="keyword">,</span> s2expopt_vt<span class="keyword">,</span> list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
        <span class="keyword">val</span> <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2l<span class="keyword">)</span> <span class="keyword">=</span> s2exp_slab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2l<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span>s2e_old<span class="keyword">,</span> os2e1<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2ls<span class="keyword">,</span> s2e_new<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> os2e0 <span class="keyword">=</span> <span class="keyword">(</span>
          <span class="keyword">case+</span> os2e1 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Some_vt s2e1 <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2l <span class="keyword">of</span>
            <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>s2exp_lab_linset <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> s2e1<span class="keyword">)</span><span class="keyword">)</span>
            <span class="keyword">|</span> S2LAB1ind <span class="keyword">(</span>_<span class="keyword">,</span> s2e_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> cstr := cons <span class="keyword">(</span>s2exp_tyleq <span class="keyword">(</span>1<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e1<span class="keyword">,</span> s2e_elt<span class="keyword">)</span><span class="keyword">,</span> cstr<span class="keyword">)</span>
              <span class="keyword">}</span> <span class="comment">// end of [S2LAB1ind]
</span>            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_loc_interror loc0<span class="keyword">;</span>
                prerr ": s2exp_slablst_linset_cstr: aux"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
                $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2expopt_vt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>          <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2expopt_vt</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span>s2e_old<span class="keyword">,</span> os2e0<span class="keyword">,</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>s2e0<span class="keyword">,</span> Some_vt s2e_new<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">(* end of [aux] *)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>s2e_old<span class="keyword">,</span> os2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> s2e_new<span class="keyword">,</span> cstr<span class="keyword">)</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> os2e0 <span class="keyword">of</span> <span class="keyword">~</span>Some_vt s2e0 <span class="keyword">=&gt;</span> s2e0 <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2e0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">s2exp</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>s2e_old<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_slablst_linset_cstr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_slablst_lindel_cstr
  <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
    <span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">,</span> s2ls<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> cstr<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span>s2exp<span class="comment">(*part*)</span><span class="keyword">,</span> s2exp<span class="comment">(*whole*)</span><span class="keyword">,</span> list <span class="keyword">(</span>s2lab<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2ls <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> s2l <span class="keyword">of</span>
          <span class="keyword">|</span> S2LAB0ind _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_error3 loc0<span class="keyword">;</span>
              prerr ": array subscription is not supported (for view extraction)."<span class="keyword">;</span>
              prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [S2LAB0ind]
</span>          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>        <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0
        <span class="keyword">val</span> <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2l<span class="keyword">)</span> <span class="keyword">=</span> s2exp_slab_linget_cstr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2l<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span>s2e_out<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2ls<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e1<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
        <span class="keyword">val</span> s2e0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> s2l <span class="keyword">of</span>
          <span class="keyword">|</span> S2LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_lab_linset <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> l<span class="keyword">,</span> s2e1<span class="keyword">)</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              prerr_loc_interror loc0<span class="keyword">;</span>
              prerr ": s2exp_slablst_linset_cstr: aux"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
              $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>s2exp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [_]
</span>        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">s2exp</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span>s2e_out<span class="keyword">,</span> s2e0<span class="keyword">,</span> cons <span class="keyword">(</span>s2l<span class="keyword">,</span> s2ls<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>s2e0<span class="keyword">,</span> s2exp_out s2e0<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">(* end of [aux] *)</span>
<span class="keyword">in</span>
  aux <span class="keyword">(</span>loc0<span class="keyword">,</span> s2e0<span class="keyword">,</span> s2ls<span class="keyword">,</span> cstr<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">(* end of [s2exp_slablst_lindel_cstr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2explst_subclass_test
  <span class="keyword">(</span>s2es1<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> s2e2<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Sgn</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2es1 <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2es1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> test <span class="keyword">=</span> s2exp_subclass_test <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> test <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> 1 <span class="keyword">else</span> s2explst_subclass_test <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0
<span class="comment">// end of [s2explst_subclass_test]
</span>
<span class="keyword">implement</span>
s2exp_subclass_test <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e1 <span class="keyword">=</span> s2exp_whnf s2e1 <span class="keyword">and</span> s2e2 <span class="keyword">=</span> s2exp_whnf s2e2
<span class="comment">(*
  val () = begin
    print "s2exp_subclass_test: s2e1 = "; print s2e1; print_newline ();
    print "s2exp_subclass_test: s2e2 = "; print s2e2; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">val</span> test <span class="keyword">=</span> s2exp_syneq <span class="keyword">(</span>s2e1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> test <span class="keyword">then</span> 1 <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> s2e1<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
    <span class="keyword">|</span> S2Ecst s2c1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2es1 <span class="keyword">=</span> s2cst_supcls_get s2c1 <span class="keyword">in</span> s2explst_subclass_test <span class="keyword">(</span>s2es1<span class="keyword">,</span> s2e2<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [S2Ecst]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> 0
  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">// end of [subclass_relation_test]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_staexp2_util2.dats] *)</span>
</pre>
</body>
</html>
