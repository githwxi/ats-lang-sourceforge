<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of functional maps based on AVL trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: April, 2009
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// An implementation of linear maps based on randomized binary search trees
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absviewtype</span> <span class="staexp"><A name="435"><span class="stacstdec">map_vt</span></span></A> <span class="keyword">(</span>key<span class="keyword">:</span> t@ype<span class="keyword">,</span> itm<span class="keyword">:</span> viewt@ype+<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="502"><span class="stacstdec">cmp <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> Sgn</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="570"><span class="dyncstdec">compare_key_key <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span> compare_key_key <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> cmp <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(*
implement compare_key_key&lt;int=int&gt; (x1, x2, _) = compare (x1, x2)
implement compare_key_key&lt;string=string&gt; (x1, x2, _) = compare (x1, x2)
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="867"><span class="dyncstdec">linmap_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="944"><span class="dyncstdec">linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span>
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> &gt;&gt; opt <span class="keyword">(</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span><span class="keyword">,</span> tag<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>bool<span class="keyword">]</span> bool tag</span></span></A>
<span class="comment">// end of [linmap_empty_free]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="1131"><span class="dyncstdec">linmap_free <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1209"><span class="dyncstdec">linmap_is_empty
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1298"><span class="dyncstdec">linmap_isnot_empty
  <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t@ype<span class="keyword">;</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1435"><span class="dyncstdec">linmap_size <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">// mostly used for gathering statistics
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1555"><span class="dyncstdec">linmap_height <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1656"><span class="dyncstdec">linmap_search <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt <span class="keyword">(</span>itm<span class="keyword">)</span></span></span></A>

<span class="comment">//
</span>
<span class="comment">// this one is reentrant
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1802"><span class="dyncstdec">linmap_insert
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt itm</span></span></A>

<span class="comment">//
</span>
<span class="comment">// this one is reentrant
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="1957"><span class="dyncstdec">linmap_remove
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt itm</span></span></A>

<span class="comment">//
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="2078"><span class="dyncstdec">linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span> <A name="2221"><span class="dyncstdec">linmap_foreach_cloref
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">ref</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// a dataviewtype for binary search trees
</span><span class="keyword">dataviewtype</span> <span class="staexp"><A name="2390"><span class="stacstdec">bst <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype+<span class="keyword">,</span> int<span class="comment">(*size*)</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat</span><span class="keyword">}</span> BSTcons <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 1+nl+nr<span class="keyword">)</span></span> <span class="keyword">of</span>
      <span class="staexp"><span class="keyword">(</span>int <span class="keyword">(</span>1+nl+nr<span class="keyword">)</span><span class="keyword">,</span> key<span class="keyword">,</span> itm<span class="keyword">,</span> bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<span class="keyword">)</span><span class="keyword">,</span> bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nr<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> BSTnil <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">)</span></span>
<span class="comment">// end of [bst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_size <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>n<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> n<span class="keyword">)</span> <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> 0<span class="keyword">)</span> 
<span class="comment">// end of [bst_size]
</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_height <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> nl <span class="keyword">=</span> bst_height <span class="keyword">!</span>p_tl
      <span class="keyword">and</span> nr <span class="keyword">=</span> bst_height <span class="keyword">!</span>p_tr <span class="keyword">in</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> 1 + max <span class="keyword">(</span>nl<span class="keyword">,</span> nr<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> 0<span class="keyword">)</span> 
<span class="comment">// end of [bst_height]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_is_nil <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span><span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>n == 0<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> false<span class="keyword">)</span> <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> true<span class="keyword">)</span>
<span class="comment">// end of [bst_is_nil]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_is_cons <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span><span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>n <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> true<span class="keyword">)</span> <span class="keyword">|</span> BSTnil _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> false<span class="keyword">)</span>
<span class="comment">// end of [bst_is_cons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  bst_free <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> tl<span class="keyword">,</span> tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bst_free tl<span class="keyword">;</span> bst_free tr<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [bst_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  bst_search <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt itm</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> <span class="keyword">!</span>p_i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> sgn <span class="keyword">of</span>
        <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> ans <span class="keyword">=</span> bst_search <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans
          <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>        <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> ans <span class="keyword">=</span> bst_search <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans
          <span class="keyword">end</span> <span class="comment">// end of [ 1]
</span>        <span class="keyword">|</span>  _ <span class="comment">(*0*)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            <span class="keyword">let</span> <span class="keyword">val</span> ans <span class="keyword">=</span> Some_vt <span class="keyword">(</span><span class="keyword">!</span>p_i<span class="keyword">)</span> <span class="keyword">in</span> fold@ t<span class="keyword">;</span> ans <span class="keyword">end</span>
          <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      fold@ t<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTnil]
</span><span class="keyword">end</span> <span class="comment">(* end of [bst_search] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// infix order foreach
</span><span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_foreach_inf <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
  <span class="keyword">|</span> t<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span>
  <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>_<span class="keyword">,</span> k<span class="keyword">,</span> <span class="keyword">!</span>p_i<span class="keyword">,</span> <span class="keyword">!</span>tl<span class="keyword">,</span> <span class="keyword">!</span>tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>tl<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> k<span class="keyword">,</span> <span class="keyword">!</span>p_i<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">!</span>tr<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ t
    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> fold@ t
<span class="keyword">end</span> <span class="comment">// end of [bst_foreach_inf]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"libc/SATS/random.sats"</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <A name="5115"><span class="dyncstdec">dice
  <span class="staexp"><span class="keyword">{</span>m<span class="keyword">,</span>n<span class="keyword">:</span>int <span class="keyword">|</span> m <span class="keyword">&gt;</span> 0<span class="keyword">;</span> n <span class="keyword">&gt;</span> 0<span class="keyword">}</span></span>
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp">int m</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">,</span> buf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>drand48_data</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>
<span class="comment">// end of [dice]
</span>
<span class="keyword">implement</span> dice <span class="keyword">(</span>m<span class="keyword">,</span> n<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> r<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> randint_r <span class="keyword">(</span>buf<span class="keyword">,</span> m+n<span class="keyword">,</span> r<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">if</span> r <span class="keyword">&lt;</span> m <span class="keyword">then</span> true <span class="keyword">else</span> false
<span class="keyword">end</span> <span class="comment">// end of [dice]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_insert_atroot <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    t<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span> &gt;&gt; bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n+1-i<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i0<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int i</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>i<span class="keyword">:</span>two<span class="keyword">]</span> option_vt <span class="keyword">(</span>itm<span class="keyword">,</span> i <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons
      <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> _<span class="comment">(*i*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span>
      <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> bst_insert_atroot&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> r <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> tl_new <span class="keyword">=</span> <span class="keyword">!</span>p_tl
          <span class="keyword">val+</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> _<span class="comment">(*kl*)</span><span class="keyword">,</span> _<span class="comment">(*il*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tll<span class="keyword">,</span> <span class="keyword">!</span>p_tlr<span class="keyword">)</span> <span class="keyword">=</span> tl_new
          <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_n<span class="keyword">;</span> <span class="keyword">val</span> nll <span class="keyword">=</span> bst_size <span class="keyword">!</span>p_tll
        <span class="keyword">in</span>
          <span class="keyword">!</span>p_tl := <span class="keyword">!</span>p_tlr<span class="keyword">;</span> <span class="keyword">!</span>p_n := n - nll<span class="keyword">;</span> fold@ t<span class="keyword">;</span>
          <span class="keyword">!</span>p_tlr := t<span class="keyword">;</span> <span class="keyword">!</span>p_nl := n + 1<span class="keyword">;</span> fold@ tl_new<span class="keyword">;</span>
          t := tl_new<span class="keyword">;</span> ans
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          fold@ t<span class="keyword">;</span> ans <span class="comment">// [k0] is alreay in the binary search tree
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> bst_insert_atroot&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> r <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> tr_new <span class="keyword">=</span> <span class="keyword">!</span>p_tr
          <span class="keyword">val+</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nr<span class="keyword">,</span> _<span class="comment">(*kr*)</span><span class="keyword">,</span> _<span class="comment">(*ir*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">,</span> <span class="keyword">!</span>p_trr<span class="keyword">)</span> <span class="keyword">=</span> tr_new
          <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_n<span class="keyword">;</span> <span class="keyword">val</span> nrr <span class="keyword">=</span> bst_size <span class="keyword">!</span>p_trr
        <span class="keyword">in</span>
          <span class="keyword">!</span>p_tr := <span class="keyword">!</span>p_trl<span class="keyword">;</span> <span class="keyword">!</span>p_n := n - nrr<span class="keyword">;</span> fold@ t<span class="keyword">;</span>
          <span class="keyword">!</span>p_trl := t<span class="keyword">;</span> <span class="keyword">!</span>p_nr := n + 1<span class="keyword">;</span> fold@ tr_new<span class="keyword">;</span>
          t := tr_new<span class="keyword">;</span> ans
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          fold@ t<span class="keyword">;</span> ans <span class="comment">// [k0] is alreay in the binary search tree
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">(* sgn = 0 *)</span>
        fold@ t<span class="keyword">;</span> r := 1<span class="keyword">;</span> Some_vt <span class="keyword">(</span>i0<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      t := BSTcons <span class="keyword">(</span>1<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> r := 0<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [BSTnil]
</span><span class="keyword">end</span> <span class="comment">(* end of [bst_insert_atroot] *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_insert_random <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    t<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span> &gt;&gt; bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n+1-i<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i0<span class="keyword">:</span> <span class="staexp">itm</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int i</span>
  <span class="keyword">,</span> buf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>drand48_data</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>i<span class="keyword">:</span>two<span class="keyword">]</span> option_vt <span class="keyword">(</span>itm<span class="keyword">,</span> i <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> _<span class="comment">(*i*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span>
    <span class="keyword">if</span> dice <span class="keyword">(</span>1<span class="keyword">,</span> <span class="keyword">!</span>p_n<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
      fold@ t<span class="keyword">;</span> bst_insert_atroot&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>t<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span>
      <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> bst_insert_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">if</span> r <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n + 1<span class="keyword">;</span> fold@ t<span class="keyword">;</span> ans<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> ans<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ans <span class="keyword">=</span> bst_insert_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">if</span> r <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n + 1<span class="keyword">;</span> fold@ t<span class="keyword">;</span> ans<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span>fold@ t<span class="keyword">;</span> ans<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">(* sgn = 0 *)</span>
        fold@ t<span class="keyword">;</span> r := 1<span class="keyword">;</span> Some_vt <span class="keyword">(</span>i0<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      t := BSTcons <span class="keyword">(</span>1<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> r := 0<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [BSTnil] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [bst_insert_random] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_join_random <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>nl+nr<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    tl<span class="keyword">:</span> <span class="staexp">bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl<span class="keyword">)</span></span>
  <span class="keyword">,</span> tr<span class="keyword">:</span> <span class="staexp">bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nr<span class="keyword">)</span></span>
  <span class="keyword">,</span> buf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>drand48_data</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> nl+nr<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> tl <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons
      <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> _<span class="comment">(*kl*)</span><span class="keyword">,</span> _<span class="comment">(*il*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_tll<span class="keyword">,</span> <span class="keyword">!</span>p_tlr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> tr <span class="keyword">of</span>
    <span class="keyword">|</span> BSTcons <span class="keyword">(</span><span class="keyword">!</span>p_nr<span class="keyword">,</span> _<span class="comment">(*kr*)</span><span class="keyword">,</span> _<span class="comment">(*ir*)</span><span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">,</span> <span class="keyword">!</span>p_trr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>p_nl + <span class="keyword">!</span>p_nr
      <span class="keyword">in</span>
        <span class="keyword">if</span> dice <span class="keyword">(</span><span class="keyword">!</span>p_nl<span class="keyword">,</span> <span class="keyword">!</span>p_nr<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
          fold@ tr<span class="keyword">;</span> <span class="keyword">!</span>p_tlr := bst_join_random <span class="keyword">(</span><span class="keyword">!</span>p_tlr<span class="keyword">,</span> tr<span class="keyword">,</span> buf<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">!</span>p_nl := n<span class="keyword">;</span> fold@ tl<span class="keyword">;</span> tl
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          fold@ tl<span class="keyword">;</span> <span class="keyword">!</span>p_trl := bst_join_random <span class="keyword">(</span>tl<span class="keyword">,</span> <span class="keyword">!</span>p_trl<span class="keyword">,</span> buf<span class="keyword">)</span><span class="keyword">;</span>
          <span class="keyword">!</span>p_nr := n<span class="keyword">;</span> fold@ tr<span class="keyword">;</span> tr
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ tl<span class="keyword">;</span> tl<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> tr
<span class="keyword">end</span> <span class="comment">// end of [bst_join_random]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t@ype</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>viewt@ype</span><span class="keyword">}</span>
  bst_remove_random <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l1<span class="keyword">,</span>l2<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    t<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n<span class="keyword">)</span> &gt;&gt; bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> n-i<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int i</span>
  <span class="keyword">,</span> buf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>drand48_data</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>i<span class="keyword">:</span>two <span class="keyword">|</span> i &lt;= n<span class="keyword">]</span> option_vt <span class="keyword">(</span>itm<span class="keyword">,</span> i <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>nl<span class="keyword">,</span>nr<span class="keyword">}</span></span>
      <span class="keyword">(</span><span class="keyword">!</span>p_n<span class="keyword">,</span> k<span class="keyword">,</span> <span class="keyword">!</span>p_i<span class="keyword">,</span> <span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> k<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> sgn <span class="keyword">of</span>
      <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> bst_remove_random <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
          <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n - r<span class="keyword">;</span> fold@ t<span class="keyword">;</span> ans
        <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>      <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> bst_remove_random <span class="keyword">(</span><span class="keyword">!</span>p_tr<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
          <span class="keyword">!</span>p_n := <span class="keyword">!</span>p_n - r<span class="keyword">;</span> fold@ t<span class="keyword">;</span> ans
        <span class="keyword">end</span> <span class="comment">// end of [1]
</span>      <span class="keyword">|</span>  _ <span class="comment">(* 0 *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> Some_vt <span class="keyword">(</span><span class="keyword">!</span>p_i<span class="keyword">)</span>
          <span class="keyword">val</span> t_new <span class="keyword">=</span> bst_join_random <span class="keyword">(</span><span class="keyword">!</span>p_tl<span class="keyword">,</span> <span class="keyword">!</span>p_tr<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
          r := 1<span class="keyword">;</span> free@ <span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span> <span class="keyword">{</span>0<span class="keyword">,</span>0<span class="keyword">}</span> <span class="keyword">(</span>t<span class="keyword">)</span><span class="keyword">;</span> t := t_new<span class="keyword">;</span> ans
        <span class="keyword">end</span> <span class="comment">// end of [0]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [BSTcons] *)</span>
  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>r := 0<span class="keyword">;</span> fold@ t<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [bst_remove_random]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>s<span class="keyword">:</span>nat<span class="keyword">]</span> bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> s<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_empty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_is_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> m <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> false<span class="keyword">)</span> <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> true<span class="keyword">)</span>
<span class="comment">// end of [linmap_is_empty]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_isnot_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> m <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> true<span class="keyword">)</span> <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> false<span class="keyword">)</span>
<span class="comment">// end of [linmap_isnot_empty]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> linmap_size <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> m <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons <span class="keyword">(</span>n<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> n<span class="keyword">)</span> <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ m<span class="keyword">;</span> 0<span class="keyword">)</span>
<span class="comment">// end of [linmap_size]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> linmap_height <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> bst_height <span class="keyword">(</span>m<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
  linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span><span class="comment">// this one is kind of interesting: [x] is essentially
</span><span class="comment">// given two types: a and a?
</span><span class="comment">//
</span><span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="10992"><span class="dyncstdec">takeout <span class="staexp"><span class="keyword">{</span>a<span class="keyword">:</span>viewt@ype<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>a &gt;&gt; a?</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></A>
<span class="comment">//
</span>  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="11050"><span class="stacstdec">map <span class="keyword">=</span> map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="11088"><span class="stacstdec">bst0 <span class="keyword">=</span> bst <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 0<span class="keyword">)</span></span></span></A>
<span class="keyword">in</span>
  <span class="keyword">case+</span> m <span class="keyword">of</span>
  <span class="keyword">|</span> BSTcons _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ m
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_some <span class="staexp"><span class="keyword">{</span>map<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      true <span class="comment">// map is not freed
</span>    <span class="keyword">end</span> <span class="comment">// end of [BSTcons]
</span>  <span class="keyword">|</span> BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ m
      <span class="keyword">val+</span> <span class="keyword">~</span>BSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> takeout <span class="staexp"><span class="keyword">{</span>bst0<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="comment">// no-op
</span>      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_none <span class="staexp"><span class="keyword">{</span>map<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      false <span class="comment">// map is empty and freed
</span>    <span class="keyword">end</span> <span class="comment">// end of [BSTnil]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_empty_free] *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> linmap_free <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> bst_free&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_search <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> bst_search&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="comment">// end of [linmap_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_insert <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> r<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">(* uninitialized *)</span>
  <span class="keyword">var</span> buf<span class="keyword">:</span> <span class="staexp">drand48_data</span> <span class="comment">// uinitialized
</span>  <span class="keyword">val</span> _<span class="comment">(*0*)</span> <span class="keyword">=</span> srand48_r <span class="keyword">(</span>0L<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
  bst_insert_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> i0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linmap_insert]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_remove <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> r<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">(* uninitialized *)</span>
  <span class="keyword">var</span> buf<span class="keyword">:</span> <span class="staexp">drand48_data</span> <span class="comment">// uinitialized
</span>  <span class="keyword">val</span> _<span class="comment">(*0*)</span> <span class="keyword">=</span> srand48_r <span class="keyword">(</span>0L<span class="keyword">,</span> buf<span class="keyword">)</span> <span class="keyword">in</span>
  bst_remove_random&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">,</span> r<span class="keyword">,</span> buf<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [linmap_remove]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> m<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="12348"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><A name="12437"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></span></A>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>itm</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> view@ f</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf1 := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ f := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [linmap_foreach_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_foreach_cloref <span class="keyword">(</span>m<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><A name="12926"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>itm</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>k<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bst_foreach_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [linmap_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [linmap_randbst.dats] *)</span>
</PRE>
</BODY>
</HTML>
