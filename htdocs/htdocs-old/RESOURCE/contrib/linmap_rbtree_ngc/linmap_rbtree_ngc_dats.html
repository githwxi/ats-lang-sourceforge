<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of functional maps based on red-black trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: August, 2009
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** An implementation of doubly-linked red-black trees
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">sortdef</span> <span class="staexp">t0p <span class="keyword">=</span> t@ype <span class="keyword">and</span> vt0p <span class="keyword">=</span> viewt@ype</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absviewtype</span> <span class="staexp"><A name="489"><span class="stacstdec">map_vt</span></span></A> <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype+<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="553"><span class="stacstdec">cmp <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>key<span class="keyword">,</span> key<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> Sgn</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">}</span>
  <A name="619"><span class="dyncstdec">compare_key_key <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></A>
<span class="comment">// end of [compare_key_key]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">}</span> compare_key_key <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> cmp <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="799"><span class="dyncstdec">linmap_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="869"><span class="dyncstdec">linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> &gt;&gt; opt <span class="keyword">(</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span><span class="keyword">,</span> tag<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_empty_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="1049"><span class="dyncstdec">linmap_is_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span>
<A name="1130"><span class="dyncstdec">linmap_isnot_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// this is O(n)-time
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1272"><span class="dyncstdec">linmap_size <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">// this is O(log n)-time
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="1370"><span class="dyncstdec">linmap_black_height <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">RED 1</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">BLK 0</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1506"><span class="stacstdec">rbnode <span class="keyword">(</span>
  key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype<span class="keyword">,</span> color<span class="keyword">:</span>int<span class="keyword">,</span> left<span class="keyword">:</span>addr<span class="keyword">,</span> right<span class="keyword">:</span>addr<span class="keyword">,</span> parent<span class="keyword">:</span>addr
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  key<span class="keyword">=</span> key<span class="keyword">,</span> itm<span class="keyword">=</span> itm
<span class="keyword">,</span> color<span class="keyword">=</span> int color
<span class="keyword">,</span> left<span class="keyword">=</span> ptr left<span class="keyword">,</span> right<span class="keyword">=</span> ptr right
<span class="keyword">,</span> parent<span class="keyword">=</span> ptr parent
<span class="keyword">}</span></span></span></A> <span class="comment">// end of [rbnode]
</span>
<span class="keyword">viewtypedef</span> <span class="staexp"><A name="1726"><span class="stacstdec">rbnode <span class="keyword">(</span>
  key<span class="keyword">:</span>t@ype<span class="keyword">,</span> itm<span class="keyword">:</span>viewt@ype
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">@{</span>
  key<span class="keyword">=</span> key<span class="keyword">,</span> itm<span class="keyword">=</span> itm
<span class="keyword">,</span> color<span class="keyword">=</span> int?
<span class="keyword">,</span> left<span class="keyword">=</span> ptr?<span class="keyword">,</span> right<span class="keyword">=</span> ptr?
<span class="keyword">,</span> parent<span class="keyword">=</span> ptr?
<span class="keyword">}</span></span></span></A> <span class="comment">// end of [rbnode]
</span>
<span class="keyword">typedef</span>
<span class="staexp"><A name="1875"><span class="stacstdec">rbnode0 <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">)</span> <span class="keyword">=</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span>?</span></span></A>
<span class="comment">// end of [rbnode0]
</span>
<span class="keyword">sortdef</span> <span class="staexp">clr <span class="keyword">=</span> <span class="keyword">{</span>c<span class="keyword">:</span> int <span class="keyword">|</span> 0 &lt;= c<span class="keyword">;</span> c &lt;= 1<span class="keyword">}</span></span>

<span class="keyword">dataprop</span> <span class="prfexp"><span class="staexp"><A name="2001"><span class="stacstdec">clr_p
  <span class="keyword">(</span>int<span class="comment">(*c*)</span><span class="keyword">,</span> int<span class="comment">(*c1*)</span><span class="keyword">,</span> int<span class="comment">(*c2*)</span><span class="keyword">,</span> int<span class="comment">(*v*)</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr</span><span class="keyword">}</span> CLRred <span class="staexp"><span class="keyword">(</span>RED<span class="keyword">,</span> c1<span class="keyword">,</span> c2<span class="keyword">,</span> c1+c2<span class="keyword">)</span></span> <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr</span><span class="keyword">}</span> CLRblk <span class="staexp"><span class="keyword">(</span>BLK<span class="keyword">,</span> c1<span class="keyword">,</span> c2<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
<span class="comment">// end of [color_p]
</span>
<span class="keyword">dataview</span>
<span class="prfexp"><span class="staexp"><A name="2166"><span class="stacstdec">rbtree_v <span class="keyword">(</span>
  key <span class="keyword">:</span> t@ype
<span class="keyword">,</span> itm <span class="keyword">:</span> viewt@ype+
<span class="keyword">,</span> int  <span class="comment">// color (red=1/black=0)
</span><span class="keyword">,</span> int  <span class="comment">// black height
</span><span class="keyword">,</span> int  <span class="comment">// color violation
</span><span class="keyword">,</span> addr <span class="comment">// parent
</span><span class="keyword">,</span> addr <span class="comment">// self
</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span> <span class="comment">(* view for doubly-linked red-black trees *)</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c<span class="keyword">,</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">bh<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">v<span class="keyword">:</span>int</span><span class="keyword">}</span>
    <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    B <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh+1-c<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      clr_p <span class="keyword">(</span>c<span class="keyword">,</span> c1<span class="keyword">,</span> c2<span class="keyword">,</span> v<span class="keyword">)</span>
    <span class="keyword">,</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> lft<span class="keyword">)</span>
    <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> rgh<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [R] // black node
</span>  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> E <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> null<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [dataview rbtree_v]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">prfn</span> <span class="prfexp">clr_lemma <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c<span class="keyword">,</span> c1<span class="keyword">,</span> c2<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>c == 0 || c1+c2 == v<span class="keyword">]</span> void</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> pf <span class="keyword">of</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span></span>
<span class="comment">// end of [clr_lemma]
</span>
<span class="keyword">prfn</span> <span class="prfexp">vio_lemma <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int <span class="keyword">|</span> v <span class="keyword">&gt;</span> 0<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c==RED<span class="keyword">]</span> void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">prval</span> <span class="prfexp">CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_clr</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// nothing
</span><span class="keyword">end</span></span> <span class="comment">// end of [vio_lemma]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbtree_color_get
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int c</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> c <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    c
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    BLK
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [rbtree_color_get]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
  rbtree_color_trans_red_blk
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> RED<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span>
           &gt;&gt; rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> bh+1<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := BLK
  <span class="keyword">prval</span> <span class="prfexp">pf_clr <span class="keyword">=</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// nothing
</span><span class="keyword">end</span> <span class="comment">// end of [rbtree_color_trans_red_blk]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbtree_parent_set
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>pnt0<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt0<span class="keyword">,</span> slf<span class="keyword">)</span>
           &gt;&gt; rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt1<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pp1<span class="keyword">:</span> <span class="staexp">ptr pnt1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := pp1
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothin
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt1<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [rbtree_parent_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** left rotation for restoring color invariant
*)</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbtree_lrotate
  <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">:</span>clr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp">rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf</span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_l <span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> lft<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_r <span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> RED<span class="keyword">,</span> bh<span class="keyword">,</span> 1<span class="keyword">,</span> slf<span class="keyword">,</span> rgh<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 1<span class="comment">(*red*)</span><span class="keyword">,</span> bh+1<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_clr<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_clr<span class="keyword">)</span></span>
  <span class="keyword">val</span> p_r_l <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left <span class="keyword">and</span> p_r_r <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>right
  <span class="keyword">val</span> c_r_r <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_r_r</span> <span class="keyword">|</span> p_r_r<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> c_r_r <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// shallow rotation
</span><span class="comment">(*
** T (B, a, x, T (R, b, y, T (R, c, z, d))) =&gt; T (R, T (B, a, x, b), y, T (B, c, z, d))
*)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := p<span class="keyword">-&gt;</span>parent
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l</span> <span class="keyword">|</span> p_r_l<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_r</span> <span class="keyword">|</span> p_r_r<span class="keyword">)</span>
<span class="comment">//
</span>    <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_l<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> pf_r_r</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">B <span class="keyword">(</span>CLRred <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l_r = RED and c_r_r = BLK: deep rotation
</span><span class="comment">(*
** T (B, a, x, T (R, T (R, b, y, c), z, d)) =&gt; T (R, T (B, a, x, b), y, T (B, c, z, d))
*)</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_l_clr<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_r_l_l<span class="keyword">,</span> pf_r_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r_l</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_l_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>    <span class="keyword">val</span> p_r_l_l <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left
    <span class="keyword">val</span> p_r_l_r <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>parent := p<span class="keyword">-&gt;</span>parent
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r_l
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right := p_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := p_r_l
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l_l
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l</span> <span class="keyword">|</span> p_r_l_l<span class="keyword">,</span> p<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_l_l<span class="keyword">)</span></span>
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>color := BLK
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p_r_l_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_r</span> <span class="keyword">|</span> p_r_l_r<span class="keyword">,</span> p_r<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_r_l_r<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">B <span class="keyword">(</span>CLRred <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_r_l<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [rbtree_lrotate] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** right rotation for restoring color invariant
*)</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbtree_rrotate
  <span class="staexp"><span class="keyword">{</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp">rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf</span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_l <span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> RED<span class="keyword">,</span> bh<span class="keyword">,</span> 1<span class="keyword">,</span> slf<span class="keyword">,</span> lft<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_r <span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> rgh<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> 1<span class="comment">(*red*)</span><span class="keyword">,</span> bh+1<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_clr<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_clr<span class="keyword">)</span></span>
  <span class="keyword">val</span> p_l_l <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>left <span class="keyword">and</span> p_l_r <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right
  <span class="keyword">val</span> c_l_l <span class="keyword">=</span> rbtree_color_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_l</span> <span class="keyword">|</span> p_l_l<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> c_l_l <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span> <span class="comment">// shallow rotation
</span><span class="comment">(*
** T(B, T (R, T (R, a, x, b), y, c), z, d) =&gt; T (R, T (B, a, x, b), y, T (B, c, z, d))
*)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := p<span class="keyword">-&gt;</span>parent
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_l</span> <span class="keyword">|</span> p_l_l<span class="keyword">)</span>
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r</span> <span class="keyword">|</span> p_l_r<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>    <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> pf_l_l</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">B <span class="keyword">(</span>CLRred <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_l<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l_l = BLK and c_l_r = RED: deep rotation
</span><span class="comment">(*
** T (B, T (R, a, x, T (R, b, y, c)), z, d) =&gt; T (R, T (B, a, x, b), y, T (B, c, z, d))
*)</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_r_clr<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l_r_l<span class="keyword">,</span> pf_l_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l_r</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_r_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>    <span class="keyword">val</span> p_l_r_l <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left
    <span class="keyword">val</span> p_l_r_r <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>parent := p<span class="keyword">-&gt;</span>parent
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left := p_l
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := p_l_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l_r
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>color := BLK
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p_l_r_l
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_l</span> <span class="keyword">|</span> p_l_r_l<span class="keyword">,</span> p_l<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="keyword">(</span>CLRblk <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r_l<span class="keyword">)</span></span>
<span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r</span> <span class="keyword">|</span> p_l_r_r<span class="keyword">,</span> p<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r_r<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="prfexp">B <span class="keyword">(</span>CLRred <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> p_l_r<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [rbtree_rrotate] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">map_vt <span class="keyword">(</span>key<span class="keyword">:</span>t0p<span class="keyword">,</span> itm<span class="keyword">:</span>vt0p<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>bh<span class="keyword">:</span>nat<span class="keyword">;</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span>
<span class="comment">// end of [map_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_empty <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="prfexp">E <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>null<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
  linmap_empty_free <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="9471"><span class="stacstdec">map_vt <span class="keyword">=</span> map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span></span></A> <span class="keyword">in</span>
  <span class="keyword">if</span> m<span class="keyword">.</span>1 &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_some <span class="staexp"><span class="keyword">{</span>map_vt<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span> <span class="keyword">in</span> 1
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> m<span class="keyword">.</span>0</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> opt_none <span class="staexp"><span class="keyword">{</span>map_vt<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">)</span></span> <span class="keyword">in</span> 0
  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [linmap_empty_free] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_is_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>m<span class="keyword">.</span>1 <span class="keyword">=</span> null<span class="keyword">)</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> linmap_isnot_empty <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>m<span class="keyword">.</span>1 &lt;&gt; null<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_size <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="comment">// non-tail-recursive
</span>    <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh+c+v<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">Nat</span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">,</span>c2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> res <span class="keyword">=</span> aux <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span> + 1 + aux <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      res
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> 0
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [linmap_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_black_height <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="comment">// [loop] is tail-recursive
</span>    <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh+c+v<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">int <span class="keyword">(</span>n + bh<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">val</span> c <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> res <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">,</span> n+1-c<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      res
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := E <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">in</span> n
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [loop]
</span><span class="keyword">}</span> <span class="comment">// end of [linmap_black_height]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">,</span>itm<span class="keyword">:</span>t0p</span><span class="keyword">}</span>
  <A name="11234"><span class="dyncstdec">linmap_search <span class="staexp"><span class="keyword">{</span>l_res<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_res<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>itm? @ l_res &gt;&gt; disj_v <span class="keyword">(</span>itm? @ l_res<span class="keyword">,</span> itm @ l_res<span class="keyword">,</span> tag<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> m<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span>
  <span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span>
  <span class="keyword">,</span> p_res<span class="keyword">:</span> <span class="staexp">ptr l_res</span>
  <span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_search]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> linmap_search <span class="staexp"><span class="keyword">{</span>l_res<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf_res</span> <span class="keyword">|</span> m<span class="keyword">,</span> k0<span class="keyword">,</span> p_res<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> search <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span><span class="keyword">,</span> <span class="prfexp">pf_res</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">itm</span> <span class="comment">// uninitialized
</span>  <span class="keyword">viewdef</span> <span class="staexp"><A name="11613"><span class="stacstdec">V0 <span class="keyword">=</span> itm? @ l_res</span></span></A> <span class="keyword">and</span> <span class="staexp"><A name="11635"><span class="stacstdec">V1 <span class="keyword">=</span> itm @ l_res</span></span></A>
  <span class="keyword">fun</span> search <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh+c+v<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_res<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V0 &gt;&gt; disj_v <span class="keyword">(</span>V0<span class="keyword">,</span> V1<span class="keyword">,</span> tag<span class="keyword">)</span></span></span>
    <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span> <span class="keyword">=</span>
    <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> p<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> sgn <span class="keyword">of</span>
      <span class="keyword">|</span> ~1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> tag <span class="keyword">=</span> search <span class="keyword">(</span><span class="prfexp">pf_l</span><span class="keyword">,</span> <span class="prfexp">pf_res</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          tag
        <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>      <span class="keyword">|</span>  1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> tag <span class="keyword">=</span> search <span class="keyword">(</span><span class="prfexp">pf_r</span><span class="keyword">,</span> <span class="prfexp">pf_res</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">)</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          tag
        <span class="keyword">end</span> <span class="comment">// end of [ 1]
</span>      <span class="keyword">|</span> _ <span class="comment">(*0*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_res := p<span class="keyword">-&gt;</span>itm
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_res := InsRight_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">,</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_res<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          1 <span class="comment">// item associated with the given key [k0] is found
</span>        <span class="keyword">end</span> <span class="comment">// end of [0]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_res := InsLeft_v <span class="staexp"><span class="keyword">{</span>V0<span class="keyword">,</span>V1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_res<span class="keyword">)</span></span> <span class="keyword">in</span> 0
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">}</span> <span class="comment">// end of [linmap_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataview</span> <span class="prfexp"><span class="staexp"><A name="12851"><span class="stacstdec">rbdiff_v <span class="keyword">(</span>
  key <span class="keyword">:</span> t@ype
<span class="keyword">,</span> itm <span class="keyword">:</span> viewt@ype+
<span class="keyword">,</span> int  <span class="comment">// root color
</span><span class="keyword">,</span> int  <span class="comment">// the color of the missing rbtree
</span><span class="keyword">,</span> int  <span class="comment">// root black height
</span><span class="keyword">,</span> int  <span class="comment">// the black height of the missing rbtree
</span><span class="keyword">,</span> addr <span class="comment">// child: the root of the missing rbtree
</span><span class="keyword">,</span> int  <span class="comment">// direction: left(0) or right(1)
</span><span class="keyword">,</span> addr <span class="comment">// root
</span><span class="keyword">,</span> addr <span class="comment">// root parent
</span><span class="keyword">,</span> addr <span class="comment">// self
</span><span class="keyword">)</span></span></span></A> <span class="keyword">=</span> <span class="comment">(* view for an rbtree minus a sub rbtree *)</span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c<span class="keyword">,</span>c1<span class="keyword">,</span>c11<span class="keyword">,</span>c12<span class="keyword">:</span>clr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">bh<span class="keyword">,</span>bh11<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">bh11+1 &lt;= bh+c1</span><span class="keyword">}</span>
    <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">dir<span class="keyword">:</span>two</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">rt<span class="keyword">,</span>rtp<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    B1L <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c11<span class="keyword">,</span> bh<span class="keyword">,</span> bh11<span class="keyword">,</span> lft<span class="keyword">,</span> 0<span class="comment">(*dir*)</span><span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      clr_p <span class="keyword">(</span>c1<span class="keyword">,</span> c11<span class="keyword">,</span> c12<span class="keyword">,</span> 0<span class="keyword">)</span>
    <span class="keyword">,</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh11+1-c1<span class="keyword">,</span> slf<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> pnt<span class="keyword">)</span>
    <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c12<span class="keyword">,</span> bh11<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> rgh<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B1L]
</span>  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c<span class="keyword">,</span>c1<span class="keyword">,</span>c11<span class="keyword">,</span>c12<span class="keyword">:</span>clr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">bh<span class="keyword">,</span>bh11<span class="keyword">:</span>nat</span> <span class="keyword">|</span> <span class="staexp">bh11+1 &lt;= bh+c1</span><span class="keyword">}</span>
    <span class="keyword">{</span><span class="staexp">lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">dir<span class="keyword">:</span>two</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">rt<span class="keyword">,</span>rtp<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span> <span class="keyword">|</span> <span class="staexp">slf &lt;&gt; null</span><span class="keyword">}</span>
    B1R <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c12<span class="keyword">,</span> bh<span class="keyword">,</span> bh11<span class="keyword">,</span> rgh<span class="keyword">,</span> 1<span class="comment">(*dir*)</span><span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>
      clr_p <span class="keyword">(</span>c1<span class="keyword">,</span> c11<span class="keyword">,</span> c12<span class="keyword">,</span> 0<span class="keyword">)</span>
    <span class="keyword">,</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf
    <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c11<span class="keyword">,</span> bh11<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> lft<span class="keyword">)</span>
    <span class="keyword">,</span> rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh11+1-c1<span class="keyword">,</span> slf<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> pnt<span class="keyword">)</span>
    <span class="keyword">)</span></span> <span class="comment">// end of [B1R]
</span>  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c<span class="keyword">:</span>clr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">bh<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">chld<span class="keyword">:</span>addr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">dir<span class="keyword">:</span>two</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">slf<span class="keyword">:</span>addr</span><span class="keyword">}</span>
    E1 <span class="staexp"><span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> bh<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> chld<span class="keyword">,</span> slf<span class="keyword">,</span> slf<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">)</span></span></span>
<span class="comment">// end of [rbdiff_v]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">prfun</span> <span class="prfexp">rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>nat <span class="keyword">|</span> bh1 &lt;= bh<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>two<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">,</span>rtp<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*<span class="keyword">(</span>bh-bh1<span class="keyword">)</span>+1-c1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh1<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span></span>
  <span class="keyword">,</span> pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld<span class="keyword">)</span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> rtp<span class="keyword">,</span> rt<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> fpf <span class="keyword">of</span>
  <span class="keyword">|</span> B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      rbdiff_rbtree_join <span class="keyword">(</span>fpf_l<span class="keyword">,</span> B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [B1L]
</span>  <span class="keyword">|</span> B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      rbdiff_rbtree_join <span class="keyword">(</span>fpf_r<span class="keyword">,</span> B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf0<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [B1R]
</span>  <span class="keyword">|</span> E1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> pf0</span>
<span class="comment">// end of [rbdiff_rbtree_join]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">prfun</span> <span class="prfexp">rbdiff_takeout <span class="staexp"><span class="keyword">{</span>key<span class="keyword">:</span>t0p<span class="keyword">;</span>itm<span class="keyword">:</span>vt0p<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1x<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh11<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">,</span>rtp<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; rtp<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;&gt;.</span></span> <span class="keyword">(</span>
    fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1x<span class="keyword">,</span> bh<span class="keyword">,</span> bh11<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>c1<span class="keyword">:</span>int<span class="keyword">;</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf
  <span class="keyword">,</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span> @ slf
      <span class="keyword">-&lt;</span>lin<span class="keyword">&gt;</span> rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1x<span class="keyword">,</span> bh<span class="keyword">,</span> bh11<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span>
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">case+</span> fpf <span class="keyword">of</span>
  <span class="keyword">|</span> B1L <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>_1<span class="keyword">,</span>c1<span class="keyword">,</span>_2<span class="keyword">,</span>_3<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="staexp"><span class="keyword">#[</span>c1<span class="keyword">,</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt <span class="keyword">|</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> <span class="keyword">llam</span> <span class="keyword">(</span>pf_at<span class="keyword">)</span> <span class="keyword">=&gt;</span> B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">]</span>
    <span class="comment">// end of [B1L]
</span>  <span class="keyword">|</span> B1R <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>_1<span class="keyword">,</span>c1<span class="keyword">,</span>_2<span class="keyword">,</span>_3<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="staexp"><span class="keyword">#[</span>c1<span class="keyword">,</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt <span class="keyword">|</span></span> <span class="keyword">(</span>pf_at<span class="keyword">,</span> <span class="keyword">llam</span> <span class="keyword">(</span>pf_at<span class="keyword">)</span> <span class="keyword">=&gt;</span> B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">]</span></span>
    <span class="comment">// end of [B1R]
</span><span class="comment">(* end of [rbdiff_takeout] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbdiff_dir_get
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr <span class="keyword">|</span> chld &lt;&gt; null<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh1<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> pc<span class="keyword">:</span> <span class="staexp">ptr chld</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">int dir</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> dir <span class="keyword">=</span> <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf_at<span class="keyword">,</span> ffpf<span class="keyword">)</span> <span class="keyword">=</span> rbdiff_takeout <span class="keyword">(</span>fpf<span class="keyword">)</span></span>
    <span class="keyword">val</span> dir <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> pc <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left <span class="keyword">then</span> 0<span class="comment">(*left*)</span> <span class="keyword">else</span> 1<span class="comment">(*right*)</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := ffpf <span class="keyword">(</span>pf_at<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    dir
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    0 <span class="comment">// it is arbitrarily chosen (from {0,1})
</span>  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">int</span>
<span class="keyword">in</span>
  __cast <span class="keyword">(</span>dir<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="16440"><span class="dyncstdec">__cast <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int dir</span></span></A> <span class="keyword">}</span>
<span class="keyword">end</span> <span class="comment">// end of [rbdiff_dir_get]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbdiff_child_set
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">,</span>rtp<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; rtp<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh1<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span>
           &gt;&gt; rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh1<span class="keyword">,</span> chld1<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> rtp<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
    <span class="comment">// end of [fpf]
</span>  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp">int dir</span><span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">if</span> dir <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> fpf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf := B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> fpf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [rbdiff_child_set]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
  <A name="17331"><span class="dyncstdec">rbtree_split <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> null<span class="keyword">,</span> rt<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>ptr rt &gt;&gt; ptr slf</span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int 0 &gt;&gt; int dir</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>dir<span class="keyword">:</span>two<span class="keyword">;</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span>
    <span class="keyword">[</span>c0<span class="keyword">:</span>clr<span class="keyword">;</span>bh0<span class="keyword">:</span>nat<span class="keyword">;</span>chld<span class="keyword">:</span>addr <span class="keyword">|</span> bh0 &lt;= bh<span class="keyword">]</span> <span class="keyword">(</span>
    rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh0<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span>
  <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c0<span class="keyword">,</span> bh0<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld<span class="keyword">)</span>
  <span class="keyword">|</span> ptr chld
  <span class="keyword">)</span></span></span></A>
<span class="comment">// end of [rbtree_split]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> rbtree_split
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p<span class="keyword">,</span> k0<span class="keyword">,</span> dir<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>c0<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh0<span class="keyword">:</span>nat <span class="keyword">|</span> bh0 &lt;= bh<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>two<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh0+c0<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh0<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span><span class="keyword">,</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c0<span class="keyword">,</span> bh0<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld<span class="keyword">)</span></span></span>
    <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>ptr slf &gt;&gt; ptr slf</span><span class="keyword">,</span> pc<span class="keyword">:</span> <span class="staexp">ptr chld</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int dir &gt;&gt; int dir</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">#[</span>dir<span class="keyword">:</span>two<span class="keyword">;</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span>
    <span class="keyword">[</span>c1<span class="keyword">:</span>clr<span class="keyword">]</span> <span class="keyword">[</span>bh1<span class="keyword">:</span>nat <span class="keyword">|</span> bh1 &lt;= bh0<span class="keyword">]</span> <span class="keyword">[</span>chld<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> bh1<span class="keyword">,</span> chld<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span>
  <span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld<span class="keyword">)</span>
  <span class="keyword">|</span> ptr chld
  <span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">if</span> pc &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_key_key <span class="keyword">(</span>k0<span class="keyword">,</span> pc<span class="keyword">-&gt;</span>key<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p := pc
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> dir := 0<span class="comment">(*left*)</span>
      <span class="keyword">val</span> pc_l <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>left
    <span class="keyword">in</span>
      loop <span class="keyword">(</span><span class="prfexp">B1L <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf<span class="keyword">,</span> pf_r<span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> p<span class="keyword">,</span> pc_l<span class="keyword">,</span> dir<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p := pc
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> dir := 1<span class="comment">(*right*)</span>
      <span class="keyword">val</span> pc_r <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>right
    <span class="keyword">in</span>
      loop <span class="keyword">(</span><span class="prfexp">B1R <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf<span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> p<span class="keyword">,</span> pc_r<span class="keyword">,</span> dir<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="comment">// sgn = 0
</span>      <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">B <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span> <span class="keyword">|</span> pc<span class="keyword">)</span>
    <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span>
    <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> pc<span class="keyword">)</span>
  <span class="comment">(* end of [if] *)</span>
  <span class="keyword">val</span> pc <span class="keyword">=</span> p
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p := null
  <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> E1 <span class="keyword">(</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> p<span class="keyword">,</span> pc<span class="keyword">,</span> dir<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [rbtree_split]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="19157"><span class="dyncstdec">balanceIns
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">,</span>c1<span class="keyword">:</span>clr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh0<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v0<span class="keyword">:</span>nat <span class="keyword">|</span> v0 &lt;= c0<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>two<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh0<span class="keyword">,</span> chld0<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh0<span class="keyword">,</span> v0<span class="keyword">,</span> slf<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">|</span> c0<span class="keyword">:</span> <span class="staexp">int c0</span><span class="keyword">,</span> v0<span class="keyword">:</span> <span class="staexp">int v0</span><span class="keyword">,</span> pc0<span class="keyword">:</span> <span class="staexp">ptr chld0</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp">int dir</span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>bh'<span class="keyword">:</span>nat<span class="keyword">;</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> bh &lt;= bh'<span class="keyword">;</span> bh' &lt;= bh+1<span class="keyword">]</span>
    <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> bh'<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [balanceIns]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> balanceIns
  <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> v0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> c1 <span class="keyword">=</span> rbtree_color_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> dir <span class="keyword">=</span> 0<span class="comment">(*left*)</span> <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> pp <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent
      <span class="keyword">val</span> c0p <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color
      <span class="keyword">val</span> dirp <span class="keyword">=</span> rbdiff_dir_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf1</span> <span class="keyword">|</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
    <span class="keyword">in</span>
      <span class="keyword">if</span> c0 <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> v0 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vio_lemma <span class="keyword">(</span>pf0<span class="keyword">)</span></span> <span class="comment">// c1 == RED
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span> rbtree_rrotate&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_at</span><span class="keyword">,</span> <span class="prfexp">pf0</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">)</span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf1</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_new<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> c1 <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> B1L <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
          <span class="keyword">in</span>
            <span class="keyword">(</span><span class="prfexp">rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf<span class="keyword">,</span> pf0<span class="keyword">)</span></span> <span class="keyword">|</span> pt<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := BLK
            <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
          <span class="keyword">in</span>
            balanceIns <span class="keyword">(</span><span class="prfexp">fpf1</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">// c0 = BLK
</span>        <span class="keyword">if</span> c0p <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf1</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> c1<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf1</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span>  0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// dir = 1(*right*)
</span>      <span class="keyword">prval</span> <span class="prfexp">B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> fpf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> pp <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent
      <span class="keyword">val</span> c0p <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color
      <span class="keyword">val</span> dirp <span class="keyword">=</span> rbdiff_dir_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf2</span> <span class="keyword">|</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
    <span class="keyword">in</span>
      <span class="keyword">if</span> c0 <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> v0 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> vio_lemma <span class="keyword">(</span>pf0<span class="keyword">)</span></span> <span class="comment">// c1 == RED
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span> rbtree_lrotate&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_at</span><span class="keyword">,</span> <span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> p<span class="keyword">)</span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf2</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_new<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> c1 <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> fpf2<span class="keyword">)</span></span>
          <span class="keyword">in</span>
            <span class="keyword">(</span><span class="prfexp">rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf<span class="keyword">,</span> pf0<span class="keyword">)</span></span> <span class="keyword">|</span> pt<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := BLK
            <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
          <span class="keyword">in</span>
            balanceIns <span class="keyword">(</span><span class="prfexp">fpf2</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">// c0 = BLK
</span>        <span class="keyword">if</span> c0p <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf2</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> c1<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">prval</span> <span class="prfexp">pf_new <span class="keyword">=</span> B <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
        <span class="keyword">in</span>
          balanceIns <span class="keyword">(</span><span class="prfexp">fpf2</span><span class="keyword">,</span> <span class="prfexp">pf_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span>  0<span class="comment">(*violation*)</span><span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> v0 <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf0_at<span class="keyword">,</span> pf0_l<span class="keyword">,</span> pf0_r<span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma pf0_clr</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pc1<span class="keyword">-&gt;</span>color := BLK
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf0 := B <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf0_at<span class="keyword">,</span> pf0_l<span class="keyword">,</span> pf0_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>      
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [balanceIns]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
<A name="23159"><span class="dyncstdec">linmap_insert <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_at<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at
             &gt;&gt; option_v <span class="keyword">(</span>rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at<span class="keyword">,</span> tag <span class="keyword">&gt;</span> 0<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> p_at<span class="keyword">:</span> <span class="staexp">ptr l_at</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>tag<span class="keyword">:</span>two<span class="keyword">]</span> int tag</span></span></A>
<span class="comment">// end of [linmap_insert]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_insert <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf_at</span> <span class="keyword">|</span> m<span class="keyword">,</span> p_at<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> lemma <span class="keyword">(</span>pf_at<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">prfun</span> <span class="prfexp"><A name="23521"><span class="dyncstdec">lemma <span class="keyword">(</span>pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">prf</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at &lt;&gt; null<span class="keyword">]</span> void</span></span></span></A>
  <span class="keyword">}</span></span> <span class="comment">// end of [prval]
</span><span class="comment">//
</span>  <span class="keyword">val</span> pt <span class="keyword">=</span> m<span class="keyword">.</span>1
  <span class="keyword">var</span> p <span class="keyword">=</span> pt
  <span class="keyword">val</span> k0 <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>key
  <span class="keyword">var</span> dir<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> pc0<span class="keyword">)</span> <span class="keyword">=</span> rbtree_split <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> p<span class="keyword">,</span> k0<span class="keyword">,</span> dir<span class="keyword">,</span> cmp<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> pc0 &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := Some_v <span class="keyword">(</span>pf_at<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    m<span class="keyword">.</span>0 := pf<span class="keyword">;</span> 1 <span class="comment">(*tag*)</span> <span class="comment">// no insertion is performed
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>color := RED
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>parent := p
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>left := null
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>right := null
    <span class="keyword">prval</span> <span class="prfexp">pf0 <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> E <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_at := None_v <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> p_new<span class="keyword">)</span> <span class="keyword">=</span> balanceIns&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> BLK<span class="keyword">,</span> 0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> p_at<span class="keyword">)</span>
  <span class="keyword">in</span>
    m<span class="keyword">.</span>0 := pf<span class="keyword">;</span> m<span class="keyword">.</span>1 := p_new<span class="keyword">;</span> 0 <span class="comment">(*tag*)</span> <span class="comment">// insertion is performed
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_insert] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="24437"><span class="dyncstdec">balanceRem0
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">,</span>c1<span class="keyword">:</span>clr <span class="keyword">|</span> c1 &lt;= c0<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh0<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>two<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh0<span class="keyword">,</span> chld0<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c1<span class="keyword">,</span> bh0<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">|</span> c0<span class="keyword">:</span> <span class="staexp">int c0</span><span class="keyword">,</span> pc0<span class="keyword">:</span> <span class="staexp">ptr chld0</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp">int dir</span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c'<span class="keyword">:</span>clr<span class="keyword">;</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> c' &lt;= c<span class="keyword">]</span>
    <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c'<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [balanceRem0]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> balanceRem0
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">,</span>c1<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh0<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
<span class="comment">(*
** // nothing    
*)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> dir <span class="keyword">=</span> 0<span class="comment">(*left*)</span> <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B1L <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0p<span class="keyword">,</span>c_l<span class="keyword">,</span>c_r<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
      <span class="keyword">prval</span> <span class="prfexp">pf_clr_new <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> pf_clr <span class="keyword">of</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRred <span class="keyword">|</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRblk
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c0p<span class="keyword">,</span> c1<span class="keyword">,</span> c_r<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf1<span class="keyword">,</span> B <span class="keyword">(</span>pf_clr_new<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf2<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// dir = 1(*right*)
</span>      <span class="keyword">prval</span> <span class="prfexp">B1R <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0p<span class="keyword">,</span>c_l<span class="keyword">,</span>c_r<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> fpf2<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
      <span class="keyword">prval</span> <span class="prfexp">pf_clr_new <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> pf_clr <span class="keyword">of</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRred <span class="keyword">|</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRblk
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c0p<span class="keyword">,</span> c_l<span class="keyword">,</span> c1<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf2<span class="keyword">,</span> B <span class="keyword">(</span>pf_clr_new<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf1<span class="keyword">,</span> pf0<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span> <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">// end of [balanceRem0]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="26086"><span class="dyncstdec">balanceRem1
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">:</span>clr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>dir<span class="keyword">:</span>two<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh1+1<span class="keyword">,</span> chld0<span class="keyword">,</span> dir<span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">|</span> c0<span class="keyword">:</span> <span class="staexp">int c0</span><span class="keyword">,</span> pc0<span class="keyword">:</span> <span class="staexp">ptr chld0</span><span class="keyword">,</span> dir<span class="keyword">:</span> <span class="staexp">int dir</span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bh-bh'<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>c'<span class="keyword">:</span>clr<span class="keyword">;</span>bh'<span class="keyword">:</span>nat <span class="keyword">|</span> c' &lt;= c<span class="keyword">;</span> bh' &lt;= bh<span class="keyword">;</span> bh &lt;= bh'+1-c'<span class="keyword">]</span>
    <span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c'<span class="keyword">,</span> bh'<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [balanceRem1]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="26658"><span class="dyncstdec">balanceRem1_left
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh1+1<span class="keyword">,</span> chld0<span class="keyword">,</span> 0<span class="comment">(*left*)</span><span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">|</span> c0<span class="keyword">:</span> <span class="staexp">int c0</span><span class="keyword">,</span> pc0<span class="keyword">:</span> <span class="staexp">ptr chld0</span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bh-bh'<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>c'<span class="keyword">:</span>clr<span class="keyword">;</span>bh'<span class="keyword">:</span>nat <span class="keyword">|</span> c' &lt;= c<span class="keyword">;</span> bh' &lt;= bh<span class="keyword">;</span> bh &lt;= bh'+1-c'<span class="keyword">]</span>
    <span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c'<span class="keyword">,</span> bh'<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [balanceRem1_left]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="27234"><span class="dyncstdec">balanceRem1_right
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c0<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">,</span>bh1<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>chld0<span class="keyword">,</span>chld1<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh1+1<span class="keyword">,</span> chld0<span class="keyword">,</span> 1<span class="comment">(*right*)</span><span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> BLK<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld1<span class="keyword">)</span></span></span> <span class="comment">// view for the missing rbtree
</span>  <span class="keyword">|</span> c0<span class="keyword">:</span> <span class="staexp">int c0</span><span class="keyword">,</span> pc0<span class="keyword">:</span> <span class="staexp">ptr chld0</span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> pc1<span class="keyword">:</span> <span class="staexp">ptr chld1</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bh-bh'<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>c'<span class="keyword">:</span>clr<span class="keyword">;</span>bh'<span class="keyword">:</span>nat <span class="keyword">|</span> c' &lt;= c<span class="keyword">;</span> bh' &lt;= bh<span class="keyword">;</span> bh &lt;= bh'+1-c'<span class="keyword">]</span>
    <span class="keyword">[</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c'<span class="keyword">,</span> bh'<span class="keyword">,</span> 0<span class="comment">(*violation*)</span><span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [balanceRem1_right]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  balanceRem1 <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">,</span> bhdf<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">(</span>
    <span class="keyword">if</span> dir <span class="keyword">=</span> 0 <span class="keyword">then</span> 
      balanceRem1_left&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="keyword">else</span>
      balanceRem1_right&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="comment">// end of [if]
</span>  <span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span>
    <span class="keyword">let</span> <span class="keyword">prval</span> <span class="prfexp">E1 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fpf</span><span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 1 <span class="keyword">in</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc1<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">)</span> <span class="comment">// end of [if]
</span><span class="comment">(* end of [balanceRem1] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> balanceRem1_left
  <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">,</span> bhdf<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">B1L <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> fpf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">val</span> pp <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent
  <span class="keyword">stavar</span> <span class="staexp">c0p<span class="keyword">:</span> int</span>
  <span class="keyword">val</span> c0p <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color <span class="keyword">:</span> <span class="staexp">int c0p</span>
  <span class="keyword">val</span> dirp <span class="keyword">=</span> rbdiff_dir_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf_l</span> <span class="keyword">|</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> p_r <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_clr<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_clr<span class="keyword">)</span></span>
  <span class="keyword">val</span> c_r <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>color
  <span class="keyword">val</span> p_r_l <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left
<span class="keyword">in</span>
  <span class="keyword">if</span> c_r <span class="keyword">=</span> BLK <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> c_r_l <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_r_l</span> <span class="keyword">|</span> p_r_l<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> c_r_l <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_l_clr<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_r_l_l<span class="keyword">,</span> pf_r_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r_l</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_l_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> p_r_l_l <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left
      <span class="keyword">val</span> p_r_l_r <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>color := c0p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right := p_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := p_r_l
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := BLK
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l</span> <span class="keyword">|</span> p_r_l_l<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r_l_l<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p_r_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_r</span> <span class="keyword">|</span> p_r_l_r<span class="keyword">,</span> p_r<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_r_l_r<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">prval</span> <span class="prfexp">pf0_clr <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> pf_clr <span class="keyword">of</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRblk
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c0p<span class="keyword">,</span> BLK<span class="keyword">,</span> BLK<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>    <span class="keyword">in</span>
      balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r_l<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_r_l = BLK
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := RED
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l</span> <span class="keyword">|</span> p_r_l<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r_l<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> c0p <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span>
        balanceRem1 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r<span class="keyword">,</span> bhdf<span class="keyword">)</span>
      <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_r = RED
</span>    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_l_clr<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_r_l_l<span class="keyword">,</span> pf_r_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r_l</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_l_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> p_r_l_l <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left
    <span class="keyword">val</span> p_r_l_r <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right
    <span class="keyword">val</span> c_r_l_r <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_r_l_r</span> <span class="keyword">|</span> p_r_l_r<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> c_r_l_r <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>right := p_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := p_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l</span> <span class="keyword">|</span> p_r_l_l<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r_l_l<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p_r_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_r</span> <span class="keyword">|</span> p_r_l_r<span class="keyword">,</span> p_r<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk <span class="keyword">(</span><span class="prfexp">pf_r_l_r</span> <span class="keyword">|</span> p_r_l_r<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_r_l_r<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>    <span class="keyword">in</span>
      balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r_l<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_r_l_r = BLK
</span>      <span class="keyword">val</span> c_r_l_l <span class="keyword">=</span> rbtree_color_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l</span> <span class="keyword">|</span> p_r_l_l<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> c_r_l_l <span class="keyword">=</span> BLK <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := pp
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>parent := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">prval</span> <span class="prfexp">pf_r_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_r_l_l<span class="keyword">,</span> pf_r_l_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r_l<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_r_l_l = RED
</span>        <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_r_l_l_clr<span class="keyword">,</span> pf_r_l_l_at<span class="keyword">,</span> pf_r_l_l_l<span class="keyword">,</span> pf_r_l_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_r_l_l</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_r_l_l_clr<span class="keyword">)</span></span>
        <span class="keyword">val</span> p_r_l_l_l <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>left <span class="keyword">and</span> p_r_l_l_r <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>right
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>parent := pp
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r<span class="keyword">-&gt;</span>left := p_r_l_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>parent := p_r
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>left := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_r_l_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l_l<span class="keyword">-&gt;</span>right := p_r_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>parent := p_r_l_l
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := pc1
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := p_r_l_l_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l_l</span> <span class="keyword">|</span> p_r_l_l_l<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_r_l<span class="keyword">-&gt;</span>left := p_r_l_l_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r_l_l_r</span> <span class="keyword">|</span> p_r_l_l_r<span class="keyword">,</span> p_r_l<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">prval</span> <span class="prfexp">pf_l_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf0<span class="keyword">,</span> pf_r_l_l_l<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_l_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_r_l_at<span class="keyword">,</span> pf_r_l_l_r<span class="keyword">,</span> pf_r_l_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_l_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_l</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_r<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if c_r_l_l = BLK]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if c_r_l_r = RED]
</span>  <span class="keyword">end</span> <span class="comment">// end of [if c_r = BLK]
</span><span class="keyword">end</span> <span class="comment">(* end of [balanceRem1_left] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> balanceRem1_right
  <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc1<span class="keyword">,</span> bhdf<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp">B1R <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> fpf_r<span class="keyword">)</span> <span class="keyword">=</span> fpf</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">val</span> pp <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent
  <span class="keyword">stavar</span> <span class="staexp">c0p<span class="keyword">:</span> int</span>
  <span class="keyword">val</span> c0p <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color <span class="keyword">:</span> <span class="staexp">int c0p</span>
  <span class="keyword">val</span> dirp <span class="keyword">=</span> rbdiff_dir_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf_r</span> <span class="keyword">|</span> pp<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">val</span> p_l <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left
  <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_clr<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_clr<span class="keyword">)</span></span>
  <span class="keyword">val</span> c_l <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>color
  <span class="keyword">val</span> p_l_r <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right
<span class="keyword">in</span>
  <span class="keyword">if</span> c_l <span class="keyword">=</span> BLK <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> c_l_r <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_l_r</span> <span class="keyword">|</span> p_l_r<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> c_l_r <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_r_clr<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l_r_l<span class="keyword">,</span> pf_l_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l_r</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_r_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> p_l_r_l <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left
      <span class="keyword">val</span> p_l_r_r <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>color := c0p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left := p_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := p_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l_r
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p_l_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_l</span> <span class="keyword">|</span> p_l_r_l<span class="keyword">,</span> p_l<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r_l<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := BLK
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r</span> <span class="keyword">|</span> p_l_r_r<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
      <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r_r<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">prval</span> <span class="prfexp">pf0_clr <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> pf_clr <span class="keyword">of</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRred <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> CLRblk <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> CLRblk
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c0p<span class="keyword">,</span> BLK<span class="keyword">,</span> BLK<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>    <span class="keyword">in</span>
      balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l_r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l_r = BLK
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := RED
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r</span> <span class="keyword">|</span> p_l_r<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
<span class="comment">//
</span>      <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> c0p <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span>
        balanceRem1 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l<span class="keyword">,</span> bhdf<span class="keyword">)</span>
      <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l = RED
</span>    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_r_clr<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l_r_l<span class="keyword">,</span> pf_l_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l_r</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_r_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> p_l_r_l <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left
    <span class="keyword">val</span> p_l_r_r <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right
    <span class="keyword">val</span> c_l_r_l <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_l_r_l</span> <span class="keyword">|</span> p_l_r_l<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> c_l_r_l <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>parent := pp
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>left := p_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := p_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right := p
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r_r
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r</span> <span class="keyword">|</span> p_l_r_r<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p_l_r_l
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_l</span> <span class="keyword">|</span> p_l_r_l<span class="keyword">,</span> p_l<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk <span class="keyword">(</span><span class="prfexp">pf_l_r_l</span> <span class="keyword">|</span> p_l_r_l<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">pf_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_l_r_l<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r_r<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>    <span class="keyword">in</span>
      balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l_r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l_r_l = BLK
</span>      <span class="keyword">val</span> c_l_r_r <span class="keyword">=</span> rbtree_color_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r</span> <span class="keyword">|</span> p_l_r_r<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> c_l_r_r <span class="keyword">=</span> BLK <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := pp
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>parent := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">prval</span> <span class="prfexp">pf_l_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l_r_l<span class="keyword">,</span> pf_l_r_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_l_r_r = RED
</span>        <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf_l_r_r_clr<span class="keyword">,</span> pf_l_r_r_at<span class="keyword">,</span> pf_l_r_r_l<span class="keyword">,</span> pf_l_r_r_r<span class="keyword">)</span> <span class="keyword">=</span> pf_l_r_r</span>
        <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_l_r_r_clr<span class="keyword">)</span></span>
        <span class="keyword">val</span> p_l_r_r_l <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>left <span class="keyword">and</span> p_l_r_r_r <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>right
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>parent := pp
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l<span class="keyword">-&gt;</span>right := p_l_r_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>parent := p_l
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>color := BLK
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>left := p_l_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>parent := p_l_r_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r_r<span class="keyword">-&gt;</span>right := p
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>parent := p_l_r_r
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_l_r<span class="keyword">-&gt;</span>right := p_l_r_r_l
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r_l</span> <span class="keyword">|</span> p_l_r_r_l<span class="keyword">,</span> p_l_r<span class="keyword">)</span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>color := RED
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>left := p_l_r_r_r
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_l_r_r_r</span> <span class="keyword">|</span> p_l_r_r_r<span class="keyword">,</span> p<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p<span class="keyword">-&gt;</span>right := pc1
<span class="comment">//
</span>        <span class="keyword">prval</span> <span class="prfexp">pf_r_l <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_l_r_at<span class="keyword">,</span> pf_l_r_l<span class="keyword">,</span> pf_l_r_r_l<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_r_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRred<span class="keyword">,</span> pf_at<span class="keyword">,</span> pf_l_r_r_r<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf_r <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_r_r_at<span class="keyword">,</span> pf_r_l<span class="keyword">,</span> pf_r_r<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf0_new <span class="keyword">=</span> B <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>CLRblk<span class="keyword">,</span> pf_l_at<span class="keyword">,</span> pf_l_l<span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
<span class="comment">//
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
<span class="comment">//
</span>      <span class="keyword">in</span>
        balanceRem0 <span class="keyword">(</span><span class="prfexp">fpf_r</span><span class="keyword">,</span> <span class="prfexp">pf0_new</span> <span class="keyword">|</span> c0p<span class="keyword">,</span> p<span class="keyword">,</span> dirp<span class="keyword">,</span> pt<span class="keyword">,</span> pp<span class="keyword">,</span> p_l<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if c_l_r_r = BLK]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if c_l_r_l = RED]
</span>  <span class="keyword">end</span> <span class="comment">// end of [if c_r = BLK]
</span><span class="keyword">end</span> <span class="comment">(* end of [balanceRem1_right] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*

extern
fun{key:t0p;itm:vt0p}
rbtree_remove_min
  {c:clr} {bh:nat} {rt:addr | rt &lt;&gt; null} (
    pf: rbtree_v (key, itm, c, bh, 0, null, rt)
  | pt: &amp;ptr rt &gt;&gt; ptr rt, bhdf: &amp;int? &gt;&gt; int (bh-bh')
  ) :&lt;&gt; #[ 
    c':clr;bh':nat;rt:addr | c' &lt;= c; bh' &lt;= bh; bh &lt;= bh'+1-c'
  ] [slf:addr | slf &lt;&gt; null] (
    rbnode (key, itm) @ slf, rbtree_v (key, itm, c', bh', 0, null, rt) | ptr slf
  )
// end of [rbtree_remove_min]

implement{key,itm}
  rbtree_remove_min {c} {bh} {rt} (pf | pt, bhdf) = let
  fun loop {c0:clr}
    {bh0:nat | bh0 &lt;= bh}
    {chld:addr | chld &lt;&gt; null}
    {slf:addr} .&lt;2*bh0+c0&gt;. (
    fpf: rbdiff_v (key, itm, c, c0, bh, bh0, chld, 0(*left*), rt, null, slf)
  , pf0: rbtree_v (key, itm, c0, bh0, 0, slf, chld)
  | pc: ptr (chld), pt: &amp;ptr rt &gt;&gt; ptr rt, p: ptr slf, bhdf: &amp;int? &gt;&gt; int (bh-bh')
  ) :&lt;&gt; #[c':clr;bh':nat;rt:addr
    | c' &lt;= c; bh' &lt;= bh; bh &lt;= bh'+1-c'
  ] [slf:addr | slf &lt;&gt; null] (
    rbnode (key, itm) @ slf, rbtree_v (key, itm, c', bh', 0, null, rt) | ptr slf
  ) = let
    prval B (pf0_clr, pf0_at, pf0_l, pf0_r) = pf0
    prval () = clr_lemma (pf0_clr)
    val pc_l = pc-&gt;left
  in
    if pc_l &lt;&gt; null then let
      prval fpf = B1L (pf0_clr, pf0_at, fpf, pf0_r)
    in
      loop (fpf, pf0_l | pc_l, pt, pc, bhdf)
    end else let
      prval E () = pf0_l
      val pc_r = pc-&gt;right
      val () = rbtree_parent_set&lt;key,itm&gt; (pf0_r | pc_r, p)
      val c0_r = rbtree_color_get&lt;key,itm&gt; (pf0_r | pc_r)
    in
      if c0_r = RED then let
        val () = rbtree_color_trans_red_blk&lt;key,itm&gt; (pf0_r | pc_r)
        val () = bhdf := 0
        val (pf | pt_new) = balanceRem0&lt;key,itm&gt; (fpf, pf0_r | BLK, pc, 0(*left*), pt, p, pc_r)
        val () = pt := pt_new
      in
        (pf0_at, pf | pc)
      end else let // c0_r = BLK
        val c0 = pc-&gt;color
      in
        if c0 = RED then let
          val () = bhdf := 0
          val (pf | pt_new) = balanceRem0&lt;key,itm&gt; (fpf, pf0_r | RED, pc, 0(*left*), pt, p, pc_r)
          val () = pt := pt_new
        in
          (pf0_at, pf | pc)
        end else let
          val (pf | pt_new) = balanceRem1&lt;key,itm&gt; (fpf, pf0_r | BLK, pc, 0(*left*), pt, p, pc_r, bhdf)
          val () = pt := pt_new
        in
          (pf0_at, pf | pc)
        end // end of [if]
      end // end of [if]
    end // end of [if]
  end // end of [loop]
  val pc = pt
in
  loop (E1 (), pf | pc, pt, null, bhdf)
end (* end of [rbtree_remove_min] *)

*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*

extern
fun{key:t0p;itm:vt0p}
rbtree_remove_max
  {c:clr} {bh:nat} {rt:addr | rt &lt;&gt; null} (
    pf: rbtree_v (key, itm, c, bh, 0, null, rt)
  | pt: &amp;ptr rt &gt;&gt; ptr rt, bhdf: &amp;int? &gt;&gt; int (bh-bh')
  ) :&lt;&gt; #[ 
    c':clr;bh':nat;rt:addr | c' &lt;= c; bh' &lt;= bh; bh &lt;= bh'+1-c'
  ] [slf:addr | slf &lt;&gt; null] (
    rbnode (key, itm) @ slf, rbtree_v (key, itm, c', bh', 0, null, rt) | ptr slf
  )
// end of [rbtree_remove_max]

implement{key,itm}
  rbtree_remove_max {c} {bh} {rt} (pf | pt, bhdf) = let
  fun loop {c0:clr}
    {bh0:nat | bh0 &lt;= bh}
    {chld:addr | chld &lt;&gt; null}
    {slf:addr} .&lt;2*bh0+c0&gt;. (
    fpf: rbdiff_v (key, itm, c, c0, bh, bh0, chld, 1(*right*), rt, null, slf)
  , pf0: rbtree_v (key, itm, c0, bh0, 0, slf, chld)
  | pc: ptr (chld), pt: &amp;ptr rt &gt;&gt; ptr rt, p: ptr slf, bhdf: &amp;int? &gt;&gt; int (bh-bh')
  ) :&lt;&gt; #[c':clr;bh':nat;rt:addr
    | c' &lt;= c; bh' &lt;= bh; bh &lt;= bh'+1-c'
  ] [slf:addr | slf &lt;&gt; null] (
    rbnode (key, itm) @ slf, rbtree_v (key, itm, c', bh', 0, null, rt) | ptr slf
  ) = let
    prval B (pf0_clr, pf0_at, pf0_l, pf0_r) = pf0
    prval () = clr_lemma (pf0_clr)
    val pc_r = pc-&gt;right
  in
    if pc_r &lt;&gt; null then let
      prval fpf = B1R (pf0_clr, pf0_at, pf0_l, fpf)
    in
      loop (fpf, pf0_r | pc_r, pt, pc, bhdf)
    end else let
      prval E () = pf0_r
      val pc_l = pc-&gt;left
      val () = rbtree_parent_set&lt;key,itm&gt; (pf0_l | pc_l, p)
      val c0_l = rbtree_color_get&lt;key,itm&gt; (pf0_l | pc_l)
    in
      if c0_l = RED then let
        val () = rbtree_color_trans_red_blk&lt;key,itm&gt; (pf0_l | pc_l)
        val () = bhdf := 0
        val (pf | pt_new) = balanceRem0&lt;key,itm&gt; (fpf, pf0_l | BLK, pc, 1(*right*), pt, p, pc_l)
        val () = pt := pt_new
      in
        (pf0_at, pf | pc)
      end else let // c0_l = BLK
        val c0 = pc-&gt;color
      in
        if c0 = RED then let
          val () = bhdf := 0
          val (pf | pt_new) = balanceRem0&lt;key,itm&gt; (fpf, pf0_l | RED, pc, 1(*right*), pt, p, pc_l)
          val () = pt := pt_new
        in
          (pf0_at, pf | pc)
        end else let
          val (pf | pt_new) = balanceRem1&lt;key,itm&gt; (fpf, pf0_l | BLK, pc, 1(*right*), pt, p, pc_l, bhdf)
          val () = pt := pt_new
        in
          (pf0_at, pf | pc)
        end // end of [if]
      end // end of [if]
    end // end of [if]
  end // end of [loop]
  val pc = pt
in
  loop (E1 (), pf | pc, pt, null, bhdf)
end (* end of [rbtree_remove_max] *)

*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="44328"><span class="dyncstdec">rbtree_rbtree_join
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c_l<span class="keyword">,</span>c_r<span class="keyword">:</span>clr<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt1<span class="keyword">,</span>pnt2<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_clr<span class="keyword">:</span> <span class="staexp">clr_p <span class="keyword">(</span>c<span class="keyword">,</span> c_l<span class="keyword">,</span> c_r<span class="keyword">,</span> 0<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_l<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c_l<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> pnt1<span class="keyword">,</span> lft<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_r<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c_r<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">,</span> pnt2<span class="keyword">,</span> rgh<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> c<span class="keyword">:</span> <span class="staexp">int c</span><span class="keyword">,</span> p_l<span class="keyword">:</span> <span class="staexp">ptr lft</span><span class="keyword">,</span> p_r<span class="keyword">:</span> <span class="staexp">ptr rgh</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bh+1-c-bh'<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>c'<span class="keyword">:</span>clr<span class="keyword">;</span>bh'<span class="keyword">:</span>nat <span class="keyword">|</span> c' &lt;= c<span class="keyword">;</span> bh' &lt;= bh+1-c<span class="keyword">;</span> bh+1-c &lt;= bh'+1-c'<span class="keyword">]</span>
    <span class="keyword">[</span>pnt<span class="keyword">,</span>slf<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c'<span class="keyword">,</span> bh'<span class="keyword">,</span> 0<span class="keyword">,</span> pnt<span class="keyword">,</span> slf<span class="keyword">)</span> <span class="keyword">|</span> ptr slf<span class="keyword">)</span></span></span></A>
<span class="comment">// end of [rbtree_rbtree_join]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span> rbtree_rbtree_join
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c_l<span class="keyword">,</span>c_r<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>lft<span class="keyword">,</span>rgh<span class="keyword">,</span>pnt1<span class="keyword">,</span>pnt2<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf_clr</span><span class="keyword">,</span> <span class="prfexp">pf_l</span><span class="keyword">,</span> <span class="prfexp">pf_r</span> <span class="keyword">|</span> c<span class="keyword">,</span> p_l<span class="keyword">,</span> p_r<span class="keyword">,</span> bhdf<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf_clr<span class="keyword">)</span></span>
<span class="comment">//
</span>  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="44969"><span class="stacstdec">rbnode
    <span class="keyword">(</span>key<span class="keyword">:</span>t@ype<span class="keyword">,</span>itm<span class="keyword">:</span>viewt@ype<span class="keyword">,</span>lft<span class="keyword">:</span>addr<span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>rgh<span class="keyword">,</span>pnt<span class="keyword">:</span>addr<span class="keyword">]</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c<span class="keyword">,</span> lft<span class="keyword">,</span> rgh<span class="keyword">,</span> pnt<span class="keyword">)</span></span></span></A>
  <span class="comment">(* end of [viewtypedef rbnode] *)</span>
<span class="comment">//
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>c0<span class="keyword">:</span>clr<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>bh0<span class="keyword">:</span>nat <span class="keyword">|</span> bh0 &lt;= bh<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>chld<span class="keyword">:</span>addr <span class="keyword">|</span> chld &lt;&gt; null<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>rt<span class="keyword">:</span>addr<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh0+c0<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">fpf<span class="keyword">:</span> <span class="staexp">rbdiff_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c_l<span class="keyword">,</span> c0<span class="keyword">,</span> bh<span class="keyword">,</span> bh0<span class="keyword">,</span> chld<span class="keyword">,</span> 1<span class="comment">(*right*)</span><span class="keyword">,</span> rt<span class="keyword">,</span> null<span class="keyword">,</span> slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp">rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c0<span class="keyword">,</span> bh0<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> chld<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> pc<span class="keyword">:</span> <span class="staexp">ptr <span class="keyword">(</span>chld<span class="keyword">)</span></span><span class="keyword">,</span> pt<span class="keyword">:</span> <span class="staexp">ptr rt</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bh-bh1<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>c_l1<span class="keyword">:</span>clr<span class="keyword">;</span>bh1<span class="keyword">:</span>nat
    <span class="keyword">|</span> c_l1 &lt;= c_l<span class="keyword">;</span> bh1 &lt;= bh<span class="keyword">;</span> bh &lt;= bh1+1-c_l1
    <span class="keyword">]</span> <span class="keyword">[</span>slf<span class="keyword">:</span>addr <span class="keyword">|</span> slf &lt;&gt; null<span class="keyword">]</span> <span class="keyword">[</span>lft<span class="keyword">,</span>pnt<span class="keyword">:</span>addr<span class="keyword">]</span>  <span class="keyword">(</span>
    rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> lft<span class="keyword">)</span> @ slf<span class="keyword">,</span> rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">,</span> c_l1<span class="keyword">,</span> bh1<span class="keyword">,</span> 0<span class="keyword">,</span> slf<span class="keyword">,</span> lft<span class="keyword">)</span> <span class="keyword">|</span> ptr slf
  <span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf0_at<span class="keyword">,</span> pf0_l<span class="keyword">,</span> pf0_r<span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf0_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> pc_r <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>right
  <span class="keyword">in</span>
    <span class="keyword">if</span> pc_r &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> B1R <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf0_at<span class="keyword">,</span> pf0_l<span class="keyword">,</span> fpf<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      loop <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0_r</span> <span class="keyword">|</span> pc_r<span class="keyword">,</span> pt<span class="keyword">,</span> pc<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf0_r</span>
      <span class="keyword">val</span> pc_l <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>left
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0_l</span> <span class="keyword">|</span> pc_l<span class="keyword">,</span> p<span class="keyword">)</span>
      <span class="keyword">val</span> c0_l <span class="keyword">=</span> rbtree_color_get&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0_l</span> <span class="keyword">|</span> pc_l<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> c0_l <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0_l</span> <span class="keyword">|</span> pc_l<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
        <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span> <span class="keyword">=</span> balanceRem0&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0_l</span> <span class="keyword">|</span> BLK<span class="keyword">,</span> pc<span class="keyword">,</span> 1<span class="comment">(*right*)</span><span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc_l<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>left := pt
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">,</span> pc<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">pf0_at</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> pc<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c0_l = BLK
</span>        <span class="keyword">val</span> c0 <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>color
      <span class="keyword">in</span>
        <span class="keyword">if</span> c0 <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span> <span class="keyword">=</span> balanceRem0&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0_l</span> <span class="keyword">|</span> RED<span class="keyword">,</span> pc<span class="keyword">,</span> 1<span class="comment">(*right*)</span><span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc_l<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>left := pt
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">,</span> pc<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">pf0_at</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> pc<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">)</span> <span class="keyword">=</span> balanceRem1&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0_l</span> <span class="keyword">|</span> BLK<span class="keyword">,</span> pc<span class="keyword">,</span> 1<span class="comment">(*right*)</span><span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc_l<span class="keyword">,</span> bhdf<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pc<span class="keyword">-&gt;</span>left := pt
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> pt<span class="keyword">,</span> pc<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">(</span><span class="prfexp">pf0_at</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> pc<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  <span class="keyword">if</span> p_l &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> E1 <span class="keyword">(</span><span class="keyword">)</span></span>
    <span class="keyword">val</span> c_l <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p_l<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set <span class="keyword">(</span><span class="prfexp">pf_l</span> <span class="keyword">|</span> p_l<span class="keyword">,</span> null<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_at</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> p_at<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> p_l<span class="keyword">,</span> p_l<span class="keyword">,</span> null<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>parent := null
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>color := c
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>right := p_r
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p_r<span class="keyword">,</span> p_at<span class="keyword">)</span>
    <span class="keyword">val</span> p_l <span class="keyword">=</span> p_at<span class="keyword">-&gt;</span>left
    <span class="keyword">prval</span> <span class="prfexp">fpf <span class="keyword">=</span> B1L <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>pf_clr<span class="keyword">,</span> pf_at<span class="keyword">,</span> E1 <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh+1-c<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> pf_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">in</span>
      balanceRem0&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> c_l<span class="keyword">,</span> p_l<span class="keyword">,</span> 0<span class="comment">(*left*)</span><span class="keyword">,</span> p_at<span class="keyword">,</span> p_at<span class="keyword">,</span> p_l<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// bhdf &gt; 0
</span>    <span class="keyword">in</span>
      balanceRem1&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf_l</span> <span class="keyword">|</span> c_l<span class="keyword">,</span> p_l<span class="keyword">,</span> 0<span class="comment">(*left*)</span><span class="keyword">,</span> p_at<span class="keyword">,</span> p_at<span class="keyword">,</span> p_l<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_l</span>
    <span class="keyword">val</span> c_r <span class="keyword">=</span> rbtree_color_get <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> c_r <span class="keyword">=</span> RED <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_color_trans_red_blk&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// c_r = BLK
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 1-c
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf_r</span> <span class="keyword">|</span> p_r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [rbtree_rbtree_join] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span>
<A name="48343"><span class="dyncstdec">linmap_remove <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> k0<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp key</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>l_at<span class="keyword">:</span>addr<span class="keyword">]</span> <span class="keyword">(</span>
    option_v <span class="keyword">(</span>rbnode <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span> @ l_at<span class="keyword">,</span> l_at &lt;&gt; null<span class="keyword">)</span> <span class="keyword">|</span> ptr l_at
  <span class="keyword">)</span></span></span></A>
<span class="comment">// end of [linmap_remove]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_remove <span class="staexp"><span class="keyword">{</span>l_at<span class="keyword">}</span></span> <span class="keyword">(</span>m<span class="keyword">,</span> k0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = $effmask_all begin
    print "linmap_remove: m=\n"; print_linmap (m); print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> pt <span class="keyword">=</span> m<span class="keyword">.</span>1
  <span class="keyword">var</span> p <span class="keyword">=</span> pt
  <span class="keyword">var</span> dir<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c0<span class="keyword">:</span>int</span><span class="keyword">,</span><span class="staexp">bh0<span class="keyword">:</span>int</span><span class="keyword">,</span><span class="staexp">chld<span class="keyword">:</span>addr</span><span class="keyword">]</span>
    <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> pc0<span class="keyword">)</span> <span class="keyword">=</span> rbtree_split <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span> <span class="keyword">|</span> p<span class="keyword">,</span> k0<span class="keyword">,</span> dir<span class="keyword">,</span> cmp<span class="keyword">)</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">viewdef</span> <span class="staexp"><A name="48893"><span class="stacstdec">V <span class="keyword">=</span> rbnode <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">)</span> @ chld</span></span></A>
<span class="keyword">in</span>
  <span class="keyword">if</span> pc0 &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf0_clr<span class="keyword">,</span> pf0_at<span class="keyword">,</span> pf0_l<span class="keyword">,</span> pf0_r<span class="keyword">)</span> <span class="keyword">=</span> pf0</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf0_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> c0 <span class="keyword">=</span> pc0<span class="keyword">-&gt;</span>color
    <span class="keyword">var</span> bhdf <span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninitalized
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc0_new<span class="keyword">)</span> <span class="keyword">=</span> rbtree_rbtree_join&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span>
      <span class="keyword">(</span><span class="prfexp">pf0_clr</span><span class="keyword">,</span> <span class="prfexp">pf0_l</span><span class="keyword">,</span> <span class="prfexp">pf0_r</span> <span class="keyword">|</span> pc0<span class="keyword">-&gt;</span>color<span class="keyword">,</span> pc0<span class="keyword">-&gt;</span>left<span class="keyword">,</span> pc0<span class="keyword">-&gt;</span>right<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="comment">// end of [val]
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_parent_set <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> pc0_new<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> pt_new<span class="keyword">)</span> <span class="keyword">=</span>
        balanceRem0&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc0_new<span class="keyword">)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      m<span class="keyword">.</span>0 := pf_new<span class="keyword">;</span> m<span class="keyword">.</span>1 := pt_new<span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">Some_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span>pf0_at<span class="keyword">)</span></span> <span class="keyword">|</span> pc0<span class="keyword">)</span> <span class="comment">// removal
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> pt_new<span class="keyword">)</span> <span class="keyword">=</span>
        balanceRem1&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">fpf</span><span class="keyword">,</span> <span class="prfexp">pf0</span> <span class="keyword">|</span> c0<span class="keyword">,</span> pc0<span class="keyword">,</span> dir<span class="keyword">,</span> pt<span class="keyword">,</span> p<span class="keyword">,</span> pc0_new<span class="keyword">,</span> bhdf<span class="keyword">)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      m<span class="keyword">.</span>0 := pf_new<span class="keyword">;</span> m<span class="keyword">.</span>1 := pt_new<span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">Some_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span>pf0_at<span class="keyword">)</span></span> <span class="keyword">|</span> pc0<span class="keyword">)</span> <span class="comment">// removal
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> rbdiff_rbtree_join <span class="staexp"><span class="keyword">{</span>key<span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>fpf<span class="keyword">,</span> pf0<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    m<span class="keyword">.</span>0 := pf<span class="keyword">;</span> <span class="keyword">(</span><span class="prfexp">None_v <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span></span> <span class="keyword">|</span> null<span class="keyword">)</span> <span class="comment">// no removal is performed
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">(* end of [linmap_remove] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// infix order foreach
</span><span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> rbtree_foreach_inf
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>pnt<span class="keyword">,</span>slf<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>2*bh+c<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>rbtree_v <span class="keyword">(</span>key<span class="keyword">,</span>itm<span class="keyword">,</span>c<span class="keyword">,</span>bh<span class="keyword">,</span>0<span class="keyword">,</span>pnt<span class="keyword">,</span>slf<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf2<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr slf</span>
  <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span>
  <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> p &lt;&gt; null <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">B <span class="keyword">(</span>pf1_clr<span class="keyword">,</span> pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span> <span class="keyword">=</span> pf1</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> clr_lemma <span class="keyword">(</span>pf1_clr<span class="keyword">)</span></span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_foreach_inf <span class="keyword">(</span><span class="prfexp">pf1_l</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>left<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>key<span class="keyword">,</span> p<span class="keyword">-&gt;</span>itm<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_foreach_inf <span class="keyword">(</span><span class="prfexp">pf1_r</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> p<span class="keyword">-&gt;</span>right<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := B <span class="keyword">(</span>pf1_clr<span class="keyword">,</span> pf1_at<span class="keyword">,</span> pf1_l<span class="keyword">,</span> pf1_r<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="keyword">end</span> <span class="comment">// end of [bst_foreach_inf]
</span>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">key<span class="keyword">:</span>t0p</span><span class="keyword">;</span><span class="staexp">itm<span class="keyword">:</span>vt0p</span><span class="keyword">}</span> <A name="50720"><span class="dyncstdec">linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>map_vt <span class="keyword">(</span>key<span class="keyword">,</span> itm<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">}</span>
  linmap_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> m<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><A name="50904"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> key<span class="keyword">,</span> <span class="keyword">&amp;</span>itm<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><A name="50993"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></span></A>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> k<span class="keyword">:</span> <span class="staexp">key</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>itm</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> view@ f</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> rbtree_foreach_inf&lt;<span class="staexp">key</span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">m<span class="keyword">.</span>0</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> m<span class="keyword">.</span>1<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf1 := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ f := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [linmap_foreach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*

// for the purpose of debugging

extern
fun{key:t0p;itm:vt0p}
print_rbtree {c:clr} {bh:nat} {v:nat} {pnt,slf:addr}
  (pf: !rbtree_v (key,itm,c,bh,v,pnt,slf) | p: ptr slf): void
  = "print_rbtree"

extern
fun{key:t0p;itm:vt0p}
print_rbtree_dummy {slf:addr} (p: ptr slf): void
  = "print_rbtree"

extern fun{key:t0p;itm:vt0p} print_linmap (map: !map_vt (key,itm)): void

implement{key,itm} print_linmap (map) = print_rbtree (map.0 | map.1)

*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [linmap_rbtree_ngc.dats] *)</span>
</PRE>
</BODY>
</HTML>
