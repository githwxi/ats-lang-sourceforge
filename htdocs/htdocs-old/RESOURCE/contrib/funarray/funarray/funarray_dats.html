<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">(*
**
** An implementation of functional arrays based on Braun trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</FONT>

<FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt
</FONT><FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">"funarray.sats"</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">brauntree <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">:</FONT>t@ype+<FONT COLOR="#000000">,</FONT> int<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">n1<FONT COLOR="#000000">,</FONT>n2<FONT COLOR="#000000">:</FONT>nat</FONT> <FONT COLOR="#000000">|</FONT> <FONT COLOR="#0000FF">n2 &lt;= n1</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#0000FF">n1 &lt;= n2+1</FONT><FONT COLOR="#000000">}</FONT>
    B <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n1+n2+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> brauntree <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> brauntree <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">stadef</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">=</FONT> brauntree</FONT> <FONT COLOR="#787878">// an abbreviation
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">assume</FONT> <FONT COLOR="#0000FF">funarray_t <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">:</FONT> t@ype<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> brauntree <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_nil <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>a<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_length&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> size <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#787878">// this algorithm is taken from a paper by Okasaki
</FONT>  <FONT COLOR="#000000">fun</FONT> diff <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>nl<FONT COLOR="#000000">,</FONT>nr<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> nr &lt;= nl &amp;&amp; nl &lt;= nr+1<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>nr<FONT COLOR="#000000">&gt;.</FONT></FONT> 
    <FONT COLOR="#000000">(</FONT>nr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int nr</FONT><FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> nl<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">int <FONT COLOR="#000000">(</FONT>nl-nr<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#000000">if</FONT> nr <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> nr2 <FONT COLOR="#000000">=</FONT> nr / 2
        <FONT COLOR="#000000">in</FONT>
          <FONT COLOR="#000000">if</FONT> nr <FONT COLOR="#000000">&gt;</FONT> nr2 + nr2 <FONT COLOR="#000000">then</FONT> diff <FONT COLOR="#000000">(</FONT>nr2<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> diff <FONT COLOR="#000000">(</FONT>nr2-1<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
          1 <FONT COLOR="#787878">// return value
</FONT>        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>     <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> 0
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [diff]
</FONT>
  <FONT COLOR="#000000">fun</FONT> size <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">int n</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val</FONT> nr <FONT COLOR="#000000">=</FONT> size tr <FONT COLOR="#000000">in</FONT> 1 + nr + nr + diff <FONT COLOR="#000000">(</FONT>nr<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> 0
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [size]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_length]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_get_elt_at&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> get_at <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> get_at <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">a</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> i2 <FONT COLOR="#000000">=</FONT> i / 2
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> i2 + i2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t <FONT COLOR="#000000">in</FONT> get_at <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> i2<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t <FONT COLOR="#000000">in</FONT> get_at <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> i2-1<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t <FONT COLOR="#000000">in</FONT> x
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_get_at]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_set_elt_at&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> set_at <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> set_at <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> i2 <FONT COLOR="#000000">=</FONT> i / 2
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> i2 + i2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> set_at <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> i2<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> set_at <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> i2-1<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t <FONT COLOR="#000000">in</FONT> B <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_set_at]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_xch_elt_at&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xch_at <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> xch_at <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">&amp;</FONT>a &gt;&gt; a</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> i2 <FONT COLOR="#000000">=</FONT> i / 2
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> i2 + i2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> xch_at <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> i2<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> xch_at <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> i2-1<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> x0_val <FONT COLOR="#000000">=</FONT> x0<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> x0 := x
    <FONT COLOR="#000000">in</FONT>
      B <FONT COLOR="#000000">(</FONT>x0_val<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_xch_at]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_loadd&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> loadd <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> loadd <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">case+</FONT> t <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> B <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> loadd <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> B <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [loadd]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_loadd]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_lorem&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> lorem <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> lorem <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> n <FONT COLOR="#000000">&gt;</FONT> 0<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>xl<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> B <FONT COLOR="#000000">(</FONT>xl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">,</FONT> lorem tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [lorem]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [brauntree_lorem]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_lorem_get&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>x := x0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> B <FONT COLOR="#000000">(</FONT>xl<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> B <FONT COLOR="#000000">(</FONT>xl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">,</FONT> funarray_lorem&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> tl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [funarray_lorem_get]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_hiadd&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> hiadd <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> hiadd <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> n <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> n2 <FONT COLOR="#000000">=</FONT> n / 2
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> n <FONT COLOR="#000000">&gt;</FONT> n2 + n2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> hiadd <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
        B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> hiadd <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> n2-1<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      B <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_hiadd]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_hirem&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> hirem <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> hirem <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>pos<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> n2 <FONT COLOR="#000000">=</FONT> n / 2
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#000000">if</FONT> n <FONT COLOR="#000000">&gt;</FONT> n2 + n2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
          B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> hirem <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
          B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> hirem <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [hirem]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_hirem]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_hirem_get&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT>
  <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> hirem_get <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fun</FONT> hirem_get <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>pos<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">&amp;</FONT>a? &gt;&gt; a</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">bt <FONT COLOR="#000000">(</FONT>a<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> t<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> n2 <FONT COLOR="#000000">=</FONT> n / 2
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">case+</FONT> tl <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> B _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#000000">if</FONT> n <FONT COLOR="#000000">&gt;</FONT> n2 + n2 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
          B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> tl<FONT COLOR="#000000">,</FONT> hirem_get <FONT COLOR="#000000">(</FONT>tr<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
          B <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> hirem_get <FONT COLOR="#000000">(</FONT>tl<FONT COLOR="#000000">,</FONT> n2<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tr<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [B]
</FONT>    <FONT COLOR="#000000">|</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>x0 := x<FONT COLOR="#000000">;</FONT> E <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#787878">// end of [hirem_get]
</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [funarray_hirem_get]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_foreach_cloptr&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>f<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> f<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte n</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">for*</FONT> <FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT> <FONT COLOR="#787878">// termination metric
</FONT>    <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> int i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>i := 0<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT> f <FONT COLOR="#000000">(</FONT>A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [funarray_foreach]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_foreach_cloref&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>f<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> f<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte n</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">for*</FONT> <FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT> <FONT COLOR="#787878">// termination metric
</FONT>    <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> int i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>i := 0<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT> f <FONT COLOR="#000000">(</FONT>A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [funarray_foreach]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> funarray_iforeach_cloptr&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>f<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> f<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte n</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">for*</FONT> <FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT> <FONT COLOR="#787878">// termination metric
</FONT>    <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> int i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>i := 0<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT> f <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [funarray_foreach]
</FONT>
<FONT COLOR="#000000">implement</FONT> funarray_iforeach_cloref&lt;<FONT COLOR="#0000FF">a</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>f<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> f<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte n</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">for*</FONT> <FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT> <FONT COLOR="#787878">// termination metric
</FONT>    <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> int i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>i := 0<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT> f <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [funarray_foreach]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [funarray.dats] *)</FONT>
</PRE></BODY>
