<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of functional arrays based on Braun trees.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: October, 2008
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** A red-black tree implementation
**
** The insertion operation is based on the algorithm in the following
** paper by Chris Okasaki:
**
** Red-Black Trees in a Functional Setting (Functional Pearls)
**
** J. of Functional Programming, vol. 9 (4), pp. 471-477, January, 1993
**
** The removal operation, which seems novel in its implementation, is by
** Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="745"><span class="dyncstdec">print_elt <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A> <span class="comment">// for debugging
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="815"><span class="stacstdec">cmp <span class="keyword">(</span>a<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> Sgn</span></span></A>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="873"><span class="dyncstdec">compare_elt_elt <span class="keyword">(</span>x1<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> compare_elt_elt <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> cmp <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">BLK 0</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">RED 1</span>
<span class="keyword">sortdef</span> <span class="staexp">clr <span class="keyword">=</span> <span class="keyword">{</span>c<span class="keyword">:</span>nat <span class="keyword">|</span> c <span class="keyword">&lt;</span> 2<span class="keyword">}</span></span>
<span class="keyword">typedef</span> <span class="staexp"><A name="1073"><span class="stacstdec">color <span class="keyword">=</span> <span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">]</span> int c</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datatype</span> <span class="staexp"><A name="1126"><span class="stacstdec">rbtree <span class="keyword">(</span>
  elt<span class="keyword">:</span>t@ype<span class="keyword">,</span> int<span class="comment">(*color*)</span><span class="keyword">,</span> int<span class="comment">(*blackheight*)</span><span class="keyword">,</span> int<span class="comment">(*violation*)</span>
<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> E <span class="staexp"><span class="keyword">(</span>elt<span class="keyword">,</span> BLK<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">c<span class="keyword">,</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">bh<span class="keyword">:</span>nat</span><span class="keyword">}</span> <span class="keyword">{</span><span class="staexp">v<span class="keyword">:</span>int</span><span class="keyword">}</span>
      <span class="keyword">{</span><span class="staexp">c == BLK &amp;&amp; v == 0 || c == RED &amp;&amp; v == c1+c2</span><span class="keyword">}</span>
    T <span class="staexp"><span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh+1-c<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>int c<span class="keyword">,</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">)</span><span class="keyword">,</span> elt<span class="keyword">,</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">// rbtree0: for trees of no violations
</span><span class="keyword">where</span> <span class="staexp"><A name="1448"><span class="stacstdec">rbtree0 <span class="keyword">(</span>elt<span class="keyword">:</span>t@ype<span class="keyword">,</span>c<span class="keyword">:</span>int<span class="keyword">,</span>bh<span class="keyword">:</span>int<span class="keyword">)</span> <span class="keyword">=</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="comment">(*vio*)</span><span class="keyword">)</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="keyword">}</span> <A name="1548"><span class="dyncstdec">rbtree_nil
  <span class="staexp"><span class="keyword">{</span>elt<span class="keyword">:</span>t@ype<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">)</span></span></span></A> <span class="comment">// always inline
</span><span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="1636"><span class="dyncstdec">rbtree_black_height
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int bh</span></span></A>
<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="1741"><span class="dyncstdec">rbtree_size
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Nat</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span> rbtree_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> E <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> rbtree_black_height <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>t<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>r<span class="keyword">:</span>nat<span class="keyword">}</span></span>
    <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">int r</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int <span class="keyword">(</span>r+bh<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> t <span class="keyword">of</span> T <span class="keyword">(</span>c<span class="keyword">,</span> tl<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>tl<span class="keyword">,</span> res+1-c<span class="keyword">)</span> <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
<span class="keyword">}</span> <span class="comment">// end of [rbtree_black_right]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> rbtree_size <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> aux t <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span>
    <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Nat</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> T <span class="keyword">(</span>_<span class="keyword">,</span> tl<span class="keyword">,</span> _<span class="keyword">,</span> tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> 1 + rbtree_size <span class="keyword">(</span>tl<span class="keyword">)</span> + rbtree_size <span class="keyword">(</span>tr<span class="keyword">)</span>
    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> 0
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [rbtree_size]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="2410"><span class="stacstdec">set_t <span class="keyword">(</span>elt<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>bh<span class="keyword">:</span>nat<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="2510"><span class="dyncstdec">print_rbtree
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> print_rbtree <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>2 * bh<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> bh <span class="keyword">=</span> rbtree_black_height <span class="keyword">(</span>t<span class="keyword">)</span>
  <span class="keyword">fun</span> indent <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">(</span>print_char ' '<span class="keyword">;</span> indent <span class="keyword">(</span>n-1<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [indent]
</span>  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span>
    <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> T <span class="keyword">(</span>c<span class="keyword">,</span> tl<span class="keyword">,</span> x<span class="keyword">,</span> tr<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>n-1<span class="keyword">,</span> tl<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> indent <span class="keyword">(</span>n<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> c <span class="keyword">=</span> 0 <span class="keyword">then</span> print_string "B:" <span class="keyword">else</span> print_string "R:"
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print_elt <span class="keyword">(</span>x<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print_newline <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>n-1<span class="keyword">,</span> tr<span class="keyword">)</span>
      <span class="keyword">}</span> <span class="comment">// end of [T]
</span><span class="comment">(*
    | E () =&gt; (indent n; print_char 'E'; print_newline ())
*)</span>
    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [print_rbtree]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="3337"><span class="dyncstdec">rbtree_member
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span></span></A>
<span class="comment">// end of [rbtree_member]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> rbtree_member <span class="keyword">(</span>t<span class="keyword">,</span> x0<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span> nat<span class="keyword">}</span></span>
    <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> T <span class="keyword">(</span>_<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt <span class="keyword">(</span>x0<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> aux t1 <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> aux t2 <span class="keyword">else</span> true
      <span class="keyword">end</span> <span class="comment">// end of [T]
</span>    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">}</span> <span class="comment">// end of [rbtree_member]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> balinc_l <span class="comment">// right rotatio
</span>  <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh+1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">#define</span> <span class="neuexp">B BLK</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">R RED</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> y<span class="keyword">,</span> c<span class="keyword">)</span><span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span> <span class="keyword">=&gt;</span> T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> y<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> c<span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T <span class="keyword">(</span>R<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> b<span class="keyword">,</span> y<span class="keyword">,</span> c<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span> <span class="keyword">=&gt;</span> T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> y<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> c<span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span> <span class="keyword">=&gt;&gt;</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [balinc_l]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> balinc_r <span class="comment">// left rotation
</span>  <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">)</span></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh+1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">#define</span> <span class="neuexp">B BLK</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">R RED</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> b<span class="keyword">,</span> y<span class="keyword">,</span> c<span class="keyword">)</span><span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> y<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> c<span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> b<span class="keyword">,</span> y<span class="keyword">,</span> T <span class="keyword">(</span>R<span class="keyword">,</span> c<span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> T <span class="keyword">(</span>R<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> y<span class="keyword">,</span> T <span class="keyword">(</span>B<span class="keyword">,</span> c<span class="keyword">,</span> z<span class="keyword">,</span> d<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span> <span class="keyword">=&gt;&gt;</span> T <span class="keyword">(</span>B<span class="keyword">,</span> a<span class="keyword">,</span> x<span class="keyword">,</span> b<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [balinc_r]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="4824"><span class="dyncstdec">rbtree_insert
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span> <span class="comment">// tag = 0/1 : inserted / not inserted
</span>    t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> tag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>bh1<span class="keyword">:</span>nat<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> 0<span class="comment">(*black*)</span><span class="keyword">,</span> bh1<span class="keyword">)</span></span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> rbtree_insert <span class="keyword">(</span>t<span class="keyword">,</span> x0<span class="keyword">,</span> tag<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> ins <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>bh<span class="keyword">,</span>c<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> tag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>c1<span class="keyword">:</span>clr<span class="keyword">]</span><span class="keyword">[</span>v<span class="keyword">:</span>nat <span class="keyword">|</span> v &lt;= c<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> T <span class="keyword">(</span>c<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt <span class="keyword">(</span>x0<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">case+</span> sgn <span class="keyword">of</span>
        <span class="keyword">|</span> ~1 <span class="comment">(* x0 &lt; x *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c1<span class="keyword">:</span>int</span><span class="keyword">]</span> t1 <span class="keyword">=</span> ins <span class="keyword">(</span>t1<span class="keyword">,</span> x0<span class="keyword">,</span> tag<span class="keyword">)</span> <span class="keyword">in</span>
            <span class="keyword">if</span> c <span class="keyword">=</span> BLK <span class="keyword">then</span> balinc_l <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">else</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [~1]
</span>        <span class="keyword">|</span>  1 <span class="comment">(* x0 &gt; x *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c1<span class="keyword">:</span>int</span><span class="keyword">]</span> t2 <span class="keyword">=</span> ins <span class="keyword">(</span>t2<span class="keyword">,</span> x0<span class="keyword">,</span> tag<span class="keyword">)</span> <span class="keyword">in</span>
            <span class="keyword">if</span> c <span class="keyword">=</span> BLK <span class="keyword">then</span> balinc_r <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">else</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [ 1]
</span>      <span class="keyword">|</span>  _ <span class="comment">(* x0 = x *)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>tag := 1<span class="keyword">;</span> t<span class="keyword">)</span> <span class="comment">// no insertion
</span>      <span class="keyword">end</span> <span class="comment">// end of [T]
</span>    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>tag := 0<span class="keyword">;</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> E<span class="keyword">,</span> x0<span class="keyword">,</span> E<span class="keyword">)</span><span class="keyword">)</span>
  <span class="comment">// end of [ins]
</span>  <span class="keyword">val</span> t <span class="keyword">=</span> ins <span class="keyword">(</span>t<span class="keyword">,</span> x0<span class="keyword">,</span> tag<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> t
<span class="keyword">end</span> <span class="comment">// end of [rbtree_insert]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> rbtree_clr_trans_red_blk <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>int<span class="keyword">}</span></span>
  <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> RED<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> BLK<span class="keyword">,</span> bh+1<span class="keyword">,</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=</span> t <span class="keyword">in</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [rbtree_clr_trans_red_blk]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> rbtree_clr_trans_blk_red
  <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> BLK<span class="keyword">,</span> bh<span class="keyword">,</span> 0<span class="keyword">)</span></span><span class="keyword">)</span>
  <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>v<span class="keyword">:</span>nat<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> RED<span class="keyword">,</span> bh-1<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c<span class="keyword">,</span>c1<span class="keyword">,</span>c2<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=</span> t <span class="keyword">in</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1+c2<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [rbtree_clr_trans_blk_red]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> balrem_l
  <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
    t1<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span>
  <span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">elt</span>
  <span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh+1<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>v<span class="keyword">:</span>nat <span class="keyword">|</span> v &lt;= c2<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh+1<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
** // nothing
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t1 <span class="keyword">of</span>
  <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c2<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1r<span class="keyword">)</span><span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="comment">// end of [T (RED, ...)]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t2 <span class="keyword">of</span>
      <span class="keyword">|</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c2<span class="keyword">,</span>c2l<span class="keyword">,</span>c2r<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t2l<span class="keyword">,</span> x2<span class="keyword">,</span> t2r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
          balinc_r <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c2l+c2r<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t2l<span class="keyword">,</span> x2<span class="keyword">,</span> t2r<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t2l<span class="keyword">,</span> x2<span class="keyword">,</span> t2r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val+</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t2ll<span class="keyword">,</span> x2l<span class="keyword">,</span> t2lr<span class="keyword">)</span> <span class="keyword">=</span> t2l
          <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c_new<span class="keyword">:</span>int</span><span class="keyword">]</span> t_new <span class="keyword">=</span> balinc_r <span class="keyword">(</span>t2lr<span class="keyword">,</span> x2<span class="keyword">,</span> rbtree_clr_trans_blk_red t2r<span class="keyword">)</span>
        <span class="keyword">in</span>
          T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c_new<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2ll<span class="keyword">)</span><span class="keyword">,</span> x2l<span class="keyword">,</span> t_new<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [T (RED, ...)]
</span>    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [balrem_l]
</span>
<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> balrem_r
  <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
    t1<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh+1<span class="keyword">)</span></span>
  <span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">elt</span>
  <span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>v<span class="keyword">:</span>nat <span class="keyword">|</span> v &lt;= c1<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh+1<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
** // nothing
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t2 <span class="keyword">of</span>
  <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t2l<span class="keyword">,</span> x2<span class="keyword">,</span> t2r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t2l<span class="keyword">,</span> x2<span class="keyword">,</span> t2r<span class="keyword">)</span><span class="keyword">)</span>
    <span class="comment">// end of [T (RED, ...)]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t1 <span class="keyword">of</span>
      <span class="keyword">|</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c1l<span class="keyword">,</span>c1r<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1r<span class="keyword">)</span> <span class="keyword">=&gt;</span>
          balinc_l <span class="keyword">(</span>T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1l+c1r<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1r<span class="keyword">)</span><span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
      <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1r<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val+</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1rl<span class="keyword">,</span> x1r<span class="keyword">,</span> t1rr<span class="keyword">)</span> <span class="keyword">=</span> t1r
          <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c_new<span class="keyword">:</span>int</span><span class="keyword">]</span> t_new <span class="keyword">=</span> balinc_l <span class="keyword">(</span>rbtree_clr_trans_blk_red t1l<span class="keyword">,</span> x1<span class="keyword">,</span> t1rl<span class="keyword">)</span>
        <span class="keyword">in</span>
          T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c_new<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t_new<span class="keyword">,</span> x1r<span class="keyword">,</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1rr<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [T (RED, ...)]
</span>    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [balrem_r]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> rbtree_remove_min
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat <span class="keyword">|</span> bh+c <span class="keyword">&gt;</span> 0<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>bh<span class="keyword">,</span>c<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> rx<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>elt? &gt;&gt; elt</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int <span class="keyword">(</span>bhdf<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>bhdf<span class="keyword">:</span>two <span class="keyword">|</span> bhdf &lt;= bh<span class="keyword">]</span>
    <span class="keyword">[</span>c1<span class="keyword">:</span>clr <span class="keyword">|</span> c1 &lt;= c+bhdf<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh-bhdf<span class="keyword">,</span> 0<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
** // nothing
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t1 <span class="keyword">of</span>
    <span class="keyword">|</span> T _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> t1 <span class="keyword">=</span> rbtree_remove_min <span class="keyword">(</span>t1<span class="keyword">,</span> rx<span class="keyword">,</span> bhdf<span class="keyword">)</span> <span class="keyword">in</span>
        <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
          T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t <span class="keyword">=</span> balrem_l <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">case+</span> t <span class="keyword">of</span>
          <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bhdf := 0<span class="keyword">;</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> t
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [T]
</span>    <span class="keyword">|</span> E _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>rx := x<span class="keyword">;</span> bhdf := 1<span class="keyword">;</span> t2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [T (BLK, ...)] *)</span> 
  <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> t1 <span class="keyword">of</span>
    <span class="keyword">|</span> T _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> t1 <span class="keyword">=</span> rbtree_remove_min <span class="keyword">(</span>t1<span class="keyword">,</span> rx<span class="keyword">,</span> bhdf<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
          T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">begin</span> <span class="comment">// bhdf = 1
</span>          bhdf := 0<span class="keyword">;</span> balinc_r <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> rbtree_clr_trans_blk_red t2<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [T (BLK, ...)]
</span>    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>rx := x<span class="keyword">;</span> bhdf := 0<span class="keyword">;</span> t2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [T (RED, ...)] *)</span>
<span class="keyword">end</span> <span class="comment">// end of [rbtree_remove_min]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> rbtree_join <span class="staexp"><span class="keyword">{</span>c1<span class="keyword">,</span>c2<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>
    t1<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c2<span class="keyword">,</span> bh<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c<span class="keyword">:</span>clr<span class="keyword">;</span>v<span class="keyword">:</span>nat <span class="keyword">|</span> v &lt;= c1+c2<span class="keyword">]</span> rbtree <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">,</span> v<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> t2 <span class="keyword">of</span>
  <span class="keyword">|</span> T _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> rx<span class="keyword">:</span> <span class="staexp">elt</span> <span class="keyword">and</span> bhdf<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninmitialized
</span>      <span class="keyword">val</span> <span class="keyword">[</span><span class="staexp">c2<span class="keyword">:</span>int</span><span class="keyword">]</span> t2 <span class="keyword">=</span> rbtree_remove_min <span class="keyword">(</span>t2<span class="keyword">,</span> rx<span class="keyword">,</span> bhdf<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span> T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>c1+c2<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="comment">(*red*)</span><span class="keyword">,</span> t1<span class="keyword">,</span> rx<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">else</span> balrem_r <span class="keyword">(</span>t1<span class="keyword">,</span> rx<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [T]
</span>  <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t1
<span class="comment">// end of [rbtree_join]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">elt<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="10000"><span class="dyncstdec">rbtree_remove
  <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span> <span class="comment">// tag = 0/1 : not removed / removed
</span>    t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">elt</span><span class="keyword">,</span> tag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int</span><span class="keyword">,</span> cmp<span class="keyword">:</span> <span class="staexp">cmp elt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>c1<span class="keyword">:</span>clr<span class="keyword">;</span>bh1<span class="keyword">:</span>nat<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh1<span class="keyword">)</span></span></span></A>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">elt</span><span class="keyword">}</span> rbtree_remove <span class="keyword">(</span>t<span class="keyword">,</span> x0<span class="keyword">,</span> tag<span class="keyword">,</span> cmp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> rem <span class="staexp"><span class="keyword">{</span>c<span class="keyword">:</span>clr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>bh<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>bh<span class="keyword">,</span>c<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c<span class="keyword">,</span> bh<span class="keyword">)</span></span><span class="keyword">,</span> tag<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int</span><span class="keyword">,</span> bhdf<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int? &gt;&gt; int bhdf</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">#[</span>bhdf<span class="keyword">:</span>two <span class="keyword">|</span> bhdf &lt;= bh<span class="keyword">]</span> <span class="keyword">[</span>c1<span class="keyword">:</span>clr <span class="keyword">|</span> c1 &lt;= c+bhdf<span class="keyword">]</span> rbtree0 <span class="keyword">(</span>elt<span class="keyword">,</span> c1<span class="keyword">,</span> bh-bhdf<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> t <span class="keyword">of</span>
    <span class="keyword">|</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt <span class="keyword">(</span>x0<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t1 <span class="keyword">=</span> rem <span class="keyword">(</span>t1<span class="keyword">,</span> tag<span class="keyword">,</span> bhdf<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
            T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// bhdf = 1
</span>            <span class="keyword">val</span> t <span class="keyword">=</span> balrem_l <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
            <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bhdf := 0<span class="keyword">;</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> t
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t2 <span class="keyword">=</span> rem <span class="keyword">(</span>t2<span class="keyword">,</span> tag<span class="keyword">,</span> bhdf<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
            T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// bhdf = 1
</span>            <span class="keyword">val</span> t <span class="keyword">=</span> balrem_r <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> t <span class="keyword">of</span>
            <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bhdf := 0<span class="keyword">;</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> t
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// x0 = x
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tag := 1 <span class="comment">// ; val () = rx := x
</span>          <span class="keyword">val</span> t <span class="keyword">=</span> rbtree_join <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">case+</span> t <span class="keyword">of</span>
          <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>bhdf := 0<span class="keyword">;</span> T <span class="keyword">(</span>BLK<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">(</span>bhdf := 1<span class="keyword">;</span> t<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [T (BLK, ...)]
</span>    <span class="keyword">|</span> T <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> sgn <span class="keyword">=</span> compare_elt_elt <span class="keyword">(</span>x0<span class="keyword">,</span> x<span class="keyword">,</span> cmp<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> sgn <span class="keyword">&lt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t1 <span class="keyword">=</span> rem <span class="keyword">(</span>t1<span class="keyword">,</span> tag<span class="keyword">,</span> bhdf<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
            T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// bhdf = 1
</span>             <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0 <span class="keyword">in</span> balrem_l <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> sgn <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t2 <span class="keyword">=</span> rem <span class="keyword">(</span>t2<span class="keyword">,</span> tag<span class="keyword">,</span> bhdf<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> bhdf <span class="keyword">=</span> 0 <span class="keyword">then</span>
            T <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span><span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>RED<span class="keyword">,</span> t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// bhdf = 1
</span>             <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> bhdf := 0 <span class="keyword">in</span> balrem_r <span class="keyword">(</span>t1<span class="keyword">,</span> x<span class="keyword">,</span> t2<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// x0 = x
</span>          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tag := 1 <span class="comment">// ; val () = rx := x
</span>        <span class="keyword">in</span>
          bhdf := 0<span class="keyword">;</span> rbtree_join <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [T (RED, ...)]
</span>    <span class="keyword">|</span> E <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>tag := 0<span class="keyword">;</span> bhdf := 0<span class="keyword">;</span> t<span class="keyword">)</span>
  <span class="comment">// end of [rem]
</span>  <span class="keyword">var</span> bhdf<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">// uninitialized
</span><span class="keyword">in</span>
  rem <span class="keyword">(</span>t<span class="keyword">,</span> tag<span class="keyword">,</span> bhdf<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [rbtree_remove]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funrbtree.dats] *)</span>
</PRE>
</BODY>
</HTML>
