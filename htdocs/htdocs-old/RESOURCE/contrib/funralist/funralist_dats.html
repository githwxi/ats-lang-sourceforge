<HTML>
<HEAD>
<STYLE TYPE="text/css">
span.comment {color:787878;font-style:italic}
span.extern  {color:A52A2A}
span.keyword {color:000000;font-weight:bold}
span.neuexp  {color:800080}
span.staexp  {color:0000FF}
span.dynexp  {color:E80000}
span.prfexp  {color:009000}
span.stacstdec  {text-decoration:none}
span.stacstuse  {color:0000CF;text-decoration:underline}
span.dyncstdec  {text-decoration:none}
span.dyncstimp  {color:B80000;text-decoration:underline}
span.dyncstuse  {color:B80000;text-decoration:underline}
</STYLE>
</HEAD>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000">
<PRE>
<span class="comment">(*
**
** An implementation of functional random-access list based on
** a nested datatype. Please see Okasaki's book for more details
** on this interesting data structure.
**
** Contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
** Time: November, 2008
**
*)</span>

<span class="comment">//
</span><span class="comment">// License: LGPL 3.0 (available at http://www.gnu.org/licenses/lgpl.txt)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// no dynamic loading
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><A name="443"><span class="stacstdec">P <span class="keyword">(</span>a1<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">(</span>a2<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span></span></span></A>

<span class="keyword">datatype</span> <span class="staexp"><A name="489"><span class="stacstdec">ralist <span class="keyword">(</span>a<span class="keyword">:</span>t@ype+<span class="keyword">,</span> int<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">|</span> RAnil <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>nat</span><span class="keyword">}</span> RAodd <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> n+n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> ralist <span class="keyword">(</span>P a a<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">n<span class="keyword">:</span>pos</span><span class="keyword">}</span> RAevn <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> n+n<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp">ralist <span class="keyword">(</span>P a a<span class="keyword">,</span> n<span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="676"><span class="dyncstdec">ralist_length <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="748"><span class="dyncstdec">ralist_head <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="814"><span class="dyncstdec">ralist_tail <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n-1<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="894"><span class="dyncstdec">ralist_cons <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n+1<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="980"><span class="dyncstdec">ralist_uncons <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span>
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> x_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a? &gt;&gt; a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n-1<span class="keyword">)</span></span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="1079"><span class="dyncstdec">ralist_lookup <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> <A name="1159"><span class="dyncstdec">ralist_update <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span>
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span></span></A>
  
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1284"><span class="dyncstdec">ralist_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="keyword">extern</span> <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  <A name="1419"><span class="dyncstdec">ralist_foreach_cloref <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span></span></A>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">macdef</span> <span class="neuexp">P x1 x2 <span class="keyword">=</span> <span class="keyword">'(</span><span class="keyword">,(</span>x1<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">,(</span>x2<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_length <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> length <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> length <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int n</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAnil _ <span class="keyword">=&gt;</span> 0
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>_<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=&gt;</span> 2 * ralist_length <span class="keyword">(</span>ys<span class="keyword">)</span> + 1
    <span class="keyword">|</span> RAevn xs <span class="keyword">=&gt;</span> 2 * ralist_length <span class="keyword">(</span>xs<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [ralist_length]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> cons <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAnil _ <span class="keyword">=&gt;</span> RAodd <span class="keyword">(</span>x0<span class="keyword">,</span> RAnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> RAevn <span class="keyword">(</span>ralist_cons <span class="keyword">(</span>P x0 x<span class="keyword">,</span> xxs<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> RAodd <span class="keyword">(</span>x0<span class="keyword">,</span> xxs<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [ralist_cons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_head <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> head <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> head <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> x
    <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">let</span> <span class="keyword">val</span> xx <span class="keyword">=</span> ralist_head&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> xxs <span class="keyword">in</span> xx<span class="keyword">.</span>0 <span class="keyword">end</span>
      <span class="keyword">end</span>
<span class="keyword">}</span> <span class="comment">// end of [ralist_head]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_uncons <span class="keyword">(</span>xs<span class="keyword">,</span> x_r<span class="keyword">)</span> <span class="keyword">=</span> uncons <span class="keyword">(</span>xs<span class="keyword">,</span> x_r<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> uncons <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> x_r<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>a? &gt;&gt; a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n-1<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        x_r := x<span class="keyword">;</span> <span class="keyword">case+</span> xxs <span class="keyword">of</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> RAevn xxs
      <span class="keyword">end</span> <span class="comment">// end of [RAodd]
</span>    <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">var</span> xx_r<span class="keyword">:</span> <span class="staexp">P a a</span> <span class="comment">// uninitialized
</span>        <span class="keyword">val</span> xxs <span class="keyword">=</span> ralist_uncons&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> xx_r<span class="keyword">)</span>
      <span class="keyword">in</span>
        x_r := xx_r<span class="keyword">.</span>0<span class="keyword">;</span> RAodd <span class="keyword">(</span>xx_r<span class="keyword">.</span>1<span class="keyword">,</span> xxs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [RAevn]
</span><span class="keyword">}</span> <span class="comment">// end of [ralist_uncons]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_tail <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> tail <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> tail <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n-1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>_<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">case+</span> xxs <span class="keyword">of</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> RAevn xxs
      <span class="keyword">end</span> <span class="comment">// end of [RAodd]
</span>    <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">var</span> xx<span class="keyword">:</span> <span class="staexp">P a a</span>
        <span class="keyword">val</span> xxs <span class="keyword">=</span> ralist_uncons&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> xx<span class="keyword">)</span>
      <span class="keyword">in</span>
        RAodd <span class="keyword">(</span>xx<span class="keyword">.</span>1<span class="keyword">,</span> xxs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [RAevn]
</span><span class="keyword">}</span> <span class="comment">// end of [ralist_tail]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_lookup <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> lookup&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> lookup <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">=</span> 0 <span class="keyword">then</span> x <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> x01 <span class="keyword">=</span> lookup&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> nhalf <span class="keyword">(</span>i-1<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="keyword">if</span> i nmod 2 <span class="keyword">=</span> 0 <span class="keyword">then</span> x01<span class="keyword">.</span>1 <span class="keyword">else</span> x01<span class="keyword">.</span>0
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [RAodd]
</span>    <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> x01 <span class="keyword">=</span> lookup&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> nhalf i<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> i nmod 2 <span class="keyword">=</span> 0 <span class="keyword">then</span> x01<span class="keyword">.</span>0 <span class="keyword">else</span> x01<span class="keyword">.</span>1
      <span class="keyword">end</span> <span class="comment">// end of [RAevn]
</span><span class="keyword">}</span> <span class="comment">// end of [ralist_lookup]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Here is an example of constructing linear closures explicitly
</span>
<span class="keyword">dataviewtype</span> <span class="staexp"><A name="4166"><span class="stacstdec">closure_ <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">)</span></span></span></A> <span class="keyword">=</span>
  <span class="keyword">{</span><span class="staexp">param<span class="keyword">:</span> viewtype</span><span class="keyword">}</span> CLOSURE_ <span class="staexp"><span class="keyword">(</span>a<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>param<span class="keyword">,</span> <span class="keyword">(</span>param<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> a<span class="keyword">)</span></span>

<span class="keyword">fn</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> cloapp <span class="keyword">(</span>c<span class="keyword">:</span> <span class="staexp">closure_ a</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> <span class="keyword">~</span>CLOSURE_ <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>param<span class="keyword">}</span></span> <span class="keyword">(</span>p<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> c<span class="keyword">;</span> <span class="keyword">val</span> f <span class="keyword">=</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>param<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">&gt;</span> a</span>
<span class="keyword">in</span>
  f <span class="keyword">(</span>p<span class="keyword">,</span> x<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [cloapp]
</span>  
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> fupdate <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> c<span class="keyword">:</span> <span class="staexp">closure_ a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> f0 <span class="keyword">(</span>c<span class="keyword">:</span> <span class="staexp">closure_ a</span><span class="keyword">,</span> xx<span class="keyword">:</span> <span class="staexp">P a a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">P a a</span> <span class="keyword">=</span> <span class="keyword">'(</span>cloapp&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>c<span class="keyword">,</span> xx<span class="keyword">.</span>0<span class="keyword">)</span><span class="keyword">,</span> xx<span class="keyword">.</span>1<span class="keyword">)</span>
  <span class="keyword">fn</span> f1 <span class="keyword">(</span>c<span class="keyword">:</span> <span class="staexp">closure_ a</span><span class="keyword">,</span> xx<span class="keyword">:</span> <span class="staexp">P a a</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">P a a</span> <span class="keyword">=</span> <span class="keyword">'(</span>xx<span class="keyword">.</span>0<span class="keyword">,</span> cloapp&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>c<span class="keyword">,</span> xx<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> i <span class="keyword">=</span> 0 <span class="keyword">then</span> RAodd <span class="keyword">(</span>cloapp&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>c<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> i1 <span class="keyword">=</span> i - 1<span class="keyword">;</span> <span class="keyword">val</span> i2 <span class="keyword">=</span> i1 / 2<span class="keyword">;</span> <span class="keyword">val</span> parity <span class="keyword">=</span> i1 - <span class="keyword">(</span>i2 + i2<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">if</span> parity <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
          RAodd <span class="keyword">(</span>x<span class="keyword">,</span> fupdate&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> i2<span class="keyword">,</span> CLOSURE_ <span class="staexp"><span class="keyword">{</span>P a a<span class="keyword">}</span></span> <span class="keyword">(</span>c<span class="keyword">,</span> f0<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          RAodd <span class="keyword">(</span>x<span class="keyword">,</span> fupdate&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> i2<span class="keyword">,</span> CLOSURE_ <span class="staexp"><span class="keyword">{</span>P a a<span class="keyword">}</span></span> <span class="keyword">(</span>c<span class="keyword">,</span> f1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [RAodd]
</span>  <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> i2 <span class="keyword">=</span> i / 2<span class="keyword">;</span> <span class="keyword">val</span> parity <span class="keyword">=</span> i - <span class="keyword">(</span>i2 + i2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> parity <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
        RAevn <span class="keyword">(</span>fupdate&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> i2<span class="keyword">,</span> CLOSURE_ <span class="staexp"><span class="keyword">{</span>P a a<span class="keyword">}</span></span> <span class="keyword">(</span>c<span class="keyword">,</span> f0<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        RAevn <span class="keyword">(</span>fupdate&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xxs<span class="keyword">,</span> i2<span class="keyword">,</span> CLOSURE_ <span class="staexp"><span class="keyword">{</span>P a a<span class="keyword">}</span></span> <span class="keyword">(</span>c<span class="keyword">,</span> f1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">// end of [RAevn]
</span><span class="keyword">end</span> <span class="comment">// end of [fupdate]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_update <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f0 <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>x_box<span class="keyword">:</span> <span class="staexp">box_vt a</span><span class="keyword">,</span> _<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">a</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> <span class="keyword">let</span> <span class="keyword">val+</span> <span class="keyword">~</span>box_vt <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> x_box <span class="keyword">in</span> x <span class="keyword">end</span>
<span class="keyword">in</span>
  fupdate&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> CLOSURE_ <span class="keyword">(</span>box_vt x<span class="keyword">,</span> f0<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [ralist_update]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
  ralist_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><A name="5790"><span class="stacstdec">clo_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">typedef</span> <span class="staexp"><A name="5834"><span class="stacstdec">cloref_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
  <span class="keyword">val</span> f <span class="keyword">=</span> cloref_make_cloptr <span class="keyword">(</span><span class="prfexp">view@ f</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="5944"><span class="dyncstdec">cloref_make_cloptr <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span>
      <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>clo_type @ l</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">cloref_type</span></span></A>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ralist_foreach_cloref&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [ralist_foreach_clo]
</span>
<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> foreach <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>pos<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">ralist <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> RAodd <span class="keyword">(</span>x<span class="keyword">,</span> xxs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> x<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> xxs <span class="keyword">of</span>
      <span class="keyword">|</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">let</span>
          <span class="keyword">var</span> <span class="keyword">!</span>p_f2 <span class="keyword">with</span> <span class="prfexp">pf_f2</span> <span class="keyword">=</span>
            @lam <span class="keyword">(</span><span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xx<span class="keyword">:</span> <span class="staexp">P a a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=&lt;</span><span class="staexp">clo</span><span class="keyword">,</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="keyword">(</span>f <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xx<span class="keyword">.</span>0<span class="keyword">)</span><span class="keyword">;</span> f <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xx<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">typedef</span> <span class="staexp"><A name="6530"><span class="stacstdec">clo_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> P a a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
          <span class="keyword">typedef</span> <span class="staexp"><A name="6586"><span class="stacstdec">cloref_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> P a a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
          <span class="keyword">val</span> f2 <span class="keyword">=</span> cloref_make_clo <span class="keyword">(</span><span class="prfexp">pf_f2</span> <span class="keyword">|</span> p_f2<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="comment">// cutting a corner here!
</span>            <span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="6740"><span class="dyncstdec">cloref_make_clo <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>clo_type @ p_f2</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr p_f2</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">cloref_type</span></span></A>
          <span class="keyword">}</span> <span class="comment">// end of [val]
</span>        <span class="keyword">in</span>
          foreach&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xxs<span class="keyword">,</span> f2<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [RAodd]
</span>  <span class="keyword">|</span> RAevn xxs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> <span class="keyword">!</span>p_f2 <span class="keyword">with</span> <span class="prfexp">pf_f2</span> <span class="keyword">=</span>
        @lam <span class="keyword">(</span><span class="prfexp">pf0<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> xx<span class="keyword">:</span> <span class="staexp">P a a</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=&lt;</span><span class="staexp">clo</span><span class="keyword">,</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="keyword">(</span>f <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xx<span class="keyword">.</span>0<span class="keyword">)</span><span class="keyword">;</span> f <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xx<span class="keyword">.</span>1<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">typedef</span> <span class="staexp"><A name="7087"><span class="stacstdec">clo_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> P a a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
      <span class="keyword">typedef</span> <span class="staexp"><A name="7139"><span class="stacstdec">cloref_type <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> P a a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></span></A>
      <span class="keyword">val</span> f2 <span class="keyword">=</span> cloref_make_clo <span class="keyword">(</span><span class="prfexp">pf_f2</span> <span class="keyword">|</span> p_f2<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="comment">// cutting a corner here!
</span>        <span class="keyword">extern</span> <span class="keyword">castfn</span> <A name="7285"><span class="dyncstdec">cloref_make_clo <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>clo_type @ p_f2</span></span> <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr p_f2</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">cloref_type</span></span></A>
      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      foreach&lt;<span class="staexp">P a a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xxs<span class="keyword">,</span> f2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [RAevn]
</span><span class="comment">// end of [foreach]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span> ralist_foreach_cloref <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span> RAnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> foreach&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf0</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [ralist_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [funralist.dats] *)</span>
</PRE>
</BODY>
</HTML>
