<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: April 2008
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Map <span class="keyword">=</span> "ats_map_lin.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_hiexp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_ccomp_env.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span><span class="keyword">=</span> "ats_map_lin.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="1748"><span class="stacstdec">tmpvarmap <span class="keyword">=</span> $Map<span class="keyword">.</span>map_vt <span class="keyword">(</span>tmpvar_t<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span>

<span class="keyword">fn</span> tmpvarmap_add
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>tmpvarmap</span><span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> $Map<span class="keyword">.</span>map_search <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpvarmap_add]
</span>
<span class="keyword">fn</span> tmpvarmap_add_root
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>tmpvarmap</span><span class="keyword">,</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tmp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> tmpvar_root_get tmp <span class="keyword">of</span>
    <span class="keyword">|</span> TMPVAROPTsome tmp <span class="keyword">=&gt;</span> tmp <span class="keyword">|</span> TMPVAROPTnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> tmp
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">tmpvar_t</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> $Map<span class="keyword">.</span>map_search <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Map<span class="keyword">.</span>map_insert <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpvarmap]
</span>
<span class="keyword">fun</span> tmpvarmap_addlst
  <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>tmpvarmap</span><span class="keyword">,</span> tmps<span class="keyword">:</span> <span class="staexp">tmpvarlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> tmps <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>tmp<span class="keyword">,</span> tmps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span><span class="keyword">;</span> tmpvarmap_addlst <span class="keyword">(</span>m<span class="keyword">,</span> tmps<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [tmpvarmap_addlst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">tmpvarmap_vt <span class="keyword">=</span> tmpvarmap</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="2679"><span class="stacstdec">ENV
  <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">,</span> int<span class="keyword">)</span></span>
<span class="comment">// end of [ENV]
</span>
<span class="keyword">fn</span> _emit_tmpvarmap_dec <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">file_mode_lte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> knd<span class="keyword">:</span> <span class="staexp">int</span> <span class="comment">(*local/static*)</span>
  <span class="keyword">,</span> tmps<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tmpvarmap_vt</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">viewdef</span> <span class="staexp"><a name="2970"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="3010"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> _<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">,</span> knd<span class="keyword">)</span><span class="keyword">=</span> env
<span class="comment">//
</span>    <span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3176"><span class="dyncstdec">tmpvar_top_set
      <span class="keyword">(</span>tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> top<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a> <span class="keyword">=</span> "atsccomp_tmpvar_top_set"
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 1 <span class="keyword">then</span> tmpvar_top_set <span class="keyword">(</span>tmp<span class="keyword">,</span> 1<span class="keyword">)</span> <span class="comment">// static tmpvar
</span><span class="comment">//
</span>    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := <span class="keyword">!</span>p_i + 1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> tmpvar_is_void <span class="keyword">(</span>tmp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 0 <span class="keyword">then</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATSlocal_void ("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 1 <span class="keyword">then</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATSstatic_void ("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> tmp<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
      <span class="keyword">in</span>
        pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
      <span class="keyword">end</span> <span class="comment">// end of [tmpvar_is_void]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 0 <span class="keyword">then</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATSlocal ("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 1 <span class="keyword">then</span>
          fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATSstatic ("<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> tmpvar_typ_get tmp<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> tmp<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ") ;\n"<span class="keyword">)</span>
      <span class="keyword">in</span>
        pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">end</span> <span class="comment">// end of [f]
</span>  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span>l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">,</span> knd<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_foreach_inf <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> tmps<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="keyword">in</span>
  i <span class="comment">// the number of tmpvars
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_tmpvarmap_dec]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">dataviewtype</span> <span class="staexp"><a name="4625"><span class="stacstdec">ENV
  <span class="keyword">(</span>l<span class="keyword">:</span>addr<span class="keyword">,</span> i<span class="keyword">:</span>addr<span class="keyword">)</span></span></a></span> <span class="keyword">=</span> ENVcon <span class="staexp"><span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>ptr l<span class="keyword">,</span> ptr i<span class="keyword">)</span></span>
<span class="comment">// end of [ENV]
</span>
<span class="keyword">fn</span> _emit_tmpvarmap_markroot <span class="staexp"><span class="keyword">{</span>m<span class="keyword">:</span>file_mode<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>l<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mod<span class="keyword">:</span> <span class="staexp">file_mode_lte <span class="keyword">(</span>m<span class="keyword">,</span> w<span class="keyword">)</span></span></span><span class="keyword">,</span> <span class="prfexp">pf_fil<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>FILE m @ l</span></span>
  <span class="keyword">|</span> l<span class="keyword">:</span> <span class="staexp">ptr l</span><span class="keyword">,</span> tmps<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>tmpvarmap_vt</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">viewdef</span> <span class="staexp"><a name="4883"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>FILE m @ l<span class="keyword">,</span> int @ i<span class="keyword">)</span></span></a></span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="4923"><span class="stacstdec">VT <span class="keyword">=</span> ENV <span class="keyword">(</span>l<span class="keyword">,</span> i<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> f <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> tmp<span class="keyword">:</span> <span class="staexp">tmpvar_t</span><span class="keyword">,</span> _<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>VT</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val+</span> ENVcon <span class="keyword">(</span>p_l<span class="keyword">,</span> p_i<span class="keyword">)</span><span class="keyword">=</span> env
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>p_i := <span class="keyword">!</span>p_i + 1<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> tmpvar_is_void <span class="keyword">(</span>tmp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> "ATS_GC_MARKROOT(&amp;"<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_tmpvar <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> tmp<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ", sizeof("<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> emit_hityp <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> tmpvar_typ_get tmp<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint1_string <span class="keyword">(</span><span class="prfexp">pf_mod</span> <span class="keyword">|</span> <span class="keyword">!</span>p_l<span class="keyword">,</span> ")) ;\n"<span class="keyword">)</span>
        <span class="keyword">in</span>
          <span class="comment">// empty
</span>        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span>  <span class="keyword">in</span>
    pf := <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> pf_int<span class="keyword">)</span><span class="keyword">;</span> fold@ env
  <span class="keyword">end</span> <span class="comment">// end of [f]
</span>  <span class="keyword">val</span> env <span class="keyword">=</span> ENVcon <span class="keyword">(</span>l<span class="keyword">,</span> <span class="keyword">&amp;</span>i<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">@(</span>pf_fil<span class="keyword">,</span> view@ i<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_foreach_inf <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>VT<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> tmps<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>pf_fil := pf<span class="keyword">.</span>0<span class="keyword">;</span> view@ i := pf<span class="keyword">.</span>1<span class="keyword">)</span></span>
  <span class="keyword">val+</span> <span class="keyword">~</span>ENVcon <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> env
<span class="keyword">in</span>
  i <span class="comment">// the number of tmpvars
</span><span class="keyword">end</span> <span class="comment">// end of [_emit_tmpvarmap_markroot]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">in</span> <span class="comment">(* in of [local] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> tmpvarmap_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
  $Map<span class="keyword">.</span>map_make <span class="staexp"><span class="keyword">{</span>tmpvar_t<span class="keyword">,</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>compare_tmpvar_tmpvar<span class="keyword">)</span>
<span class="comment">// end of [tmpvarmap_nil]
</span>
<span class="keyword">implement</span> tmpvarmap_free <span class="keyword">(</span>tmps<span class="keyword">)</span> <span class="keyword">=</span> $Map<span class="keyword">.</span>map_free <span class="keyword">(</span>tmps<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
instr_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> ins<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux_branchlst <span class="keyword">(</span>m<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>tmpvarmap</span><span class="keyword">,</span> brs<span class="keyword">:</span> <span class="staexp">branchlst</span><span class="keyword">)</span>
    <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> brs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>br<span class="keyword">,</span> brs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> br<span class="keyword">.</span>branch_inss<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux_branchlst <span class="keyword">(</span>m<span class="keyword">,</span> brs<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux_branchlst]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> ins<span class="keyword">.</span>instr_node <span class="keyword">of</span>
  <span class="keyword">|</span> INSTRarr_heap <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRarr_stack <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRcall <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
<span class="comment">(*
  | INSTRcall_tail fl =&gt; ()
*)</span>
  <span class="keyword">|</span> INSTRcond <span class="keyword">(</span>_<span class="keyword">,</span> inss_then<span class="keyword">,</span> inss_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_then<span class="keyword">)</span><span class="keyword">;</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_else<span class="keyword">)</span><span class="keyword">;</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRfunction <span class="keyword">(</span>tmp_ret_all<span class="keyword">,</span> vps_arg<span class="keyword">,</span> inss_body<span class="keyword">,</span> tmp_ret<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp_ret_all<span class="keyword">)</span><span class="keyword">;</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_body<span class="keyword">)</span><span class="keyword">;</span>
      tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp_ret<span class="keyword">)</span><span class="keyword">;</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRfunction]
</span>  <span class="keyword">|</span> INSTRload_ptr <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRload_ptr_offs <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRload_var <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRload_var_offs <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRloop <span class="keyword">(</span>
      _<span class="comment">(*lab*)</span><span class="keyword">,</span> _<span class="comment">(*lab*)</span><span class="keyword">,</span> _<span class="comment">(*lab*)</span>
    <span class="keyword">,</span> inss_init<span class="keyword">,</span> _<span class="keyword">,</span> inss_test<span class="keyword">,</span> inss_post<span class="keyword">,</span> inss_body
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_init<span class="keyword">)</span><span class="keyword">;</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_test<span class="keyword">)</span><span class="keyword">;</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_post<span class="keyword">)</span><span class="keyword">;</span>
      instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_body<span class="keyword">)</span><span class="keyword">;</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRloop]
</span>  <span class="keyword">|</span> INSTRmove_con <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_lazy_delay <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_lazy_force <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_rec_box <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_rec_flt <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_ref <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRmove_val <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRraise <span class="keyword">(</span>tmp<span class="comment">(*uninitialized*)</span><span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRselect <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRselcon <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRselcon_ptr <span class="keyword">(</span>tmp<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
<span class="comment">(*
  | INSTRpar_spawn (tmp, _) =&gt; tmpvarmap_add_root (m, tmp)
  | INSTRpar_synch (tmp) =&gt; tmpvarmap_add_root (m, tmp)
*)</span>
  <span class="keyword">|</span> INSTRswitch <span class="keyword">(</span>brs<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_branchlst <span class="keyword">(</span>m<span class="keyword">,</span> brs<span class="keyword">)</span>
  <span class="keyword">|</span> INSTRtrywith <span class="keyword">(</span>inss_try<span class="keyword">,</span> tmp_exn<span class="keyword">,</span> brs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss_try<span class="keyword">)</span>
    <span class="keyword">in</span>
      tmpvarmap_add_root <span class="keyword">(</span>m<span class="keyword">,</span> tmp_exn<span class="keyword">)</span><span class="keyword">;</span> aux_branchlst <span class="keyword">(</span>m<span class="keyword">,</span> brs<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [INSTRtrywith]
</span>  <span class="keyword">|</span> INSTRvardec <span class="keyword">(</span>tmp<span class="keyword">)</span> <span class="keyword">=&gt;</span> tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> tmp<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [instr_tmpvarmap_add]
</span>
<span class="keyword">implement</span>
instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> inss <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>ins<span class="keyword">,</span> inss<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      instr_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> ins<span class="keyword">)</span><span class="keyword">;</span> instrlst_tmpvarmap_add <span class="keyword">(</span>m<span class="keyword">,</span> inss<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [instrlst_tmpvarmap_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_tmpvarmap_dec_local <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_tmpvarmap_dec <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> 0<span class="comment">(*local*)</span><span class="keyword">,</span> tmps<span class="keyword">)</span>
<span class="comment">// end of [emit_tmpvarmap_dec_local]
</span>
<span class="keyword">implement</span>
emit_tmpvarmap_dec_static <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_tmpvarmap_dec <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> 1<span class="comment">(*static*)</span><span class="keyword">,</span> tmps<span class="keyword">)</span>
<span class="comment">// end of [emit_tmpvarmap_dec_static]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
emit_tmpvarmap_markroot <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> out<span class="keyword">,</span> tmps<span class="keyword">)</span> <span class="keyword">=</span>
  _emit_tmpvarmap_markroot <span class="keyword">(</span><span class="prfexp">pf</span><span class="keyword">,</span> <span class="prfexp">view@ out</span> <span class="keyword">|</span> <span class="keyword">&amp;</span>out<span class="keyword">,</span> tmps<span class="keyword">)</span>
<span class="comment">// end of [emit_tmpvarmap_markroot]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> funentry_tmpvarmap_add <span class="keyword">(</span>tmps<span class="keyword">,</span> entry<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instrlst_tmpvarmap_add <span class="keyword">(</span>tmps<span class="keyword">,</span> funentry_body_get entry<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tmpvarmap_add_root <span class="keyword">(</span>tmps<span class="keyword">,</span> funentry_ret_get entry<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [funentry_tmpvarmap_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> tailjoinlst_tmpvarmap_add
  <span class="keyword">(</span>tmps<span class="keyword">,</span> tjs<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tmps<span class="keyword">,</span> tjs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>tmps<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>tmpvarmap_vt</span><span class="keyword">,</span> tjs<span class="keyword">:</span> <span class="staexp">tailjoinlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> tjs <span class="keyword">of</span>
    <span class="keyword">|</span> TAILJOINLSTcons <span class="keyword">(</span>_<span class="comment">(*tag*)</span><span class="keyword">,</span> _<span class="comment">(*fl*)</span><span class="keyword">,</span> tvs<span class="comment">(*arg*)</span><span class="keyword">,</span> tjs<span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">let</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tmpvarmap_addlst <span class="keyword">(</span>tmps<span class="keyword">,</span> tvs<span class="keyword">)</span> <span class="keyword">in</span> loop <span class="keyword">(</span>tmps<span class="keyword">,</span> tjs<span class="keyword">)</span> <span class="keyword">end</span>
      <span class="comment">// end of [TAILJOINTLSTcons]
</span>    <span class="keyword">|</span> TAILJOINLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">}</span> <span class="comment">// end of [tailjoinlst_tmpvarmap_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">end</span> <span class="comment">(* end of [local] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_ccomp_util.dats] *)</span>
</pre>
</body>
</html>
