<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">//
</span><span class="comment">// A parallelized implementation of mergesort
</span><span class="comment">//
</span><span class="comment">// Time: March 2008
</span><span class="comment">// Author: Hongwei Xi (* hwxi AT cs DOT bu DOT edu *)
</span><span class="comment">//
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#if</span> <span class="neuexp">undefined <span class="keyword">(</span>ARG_QUICKSORT_MT_DATS<span class="keyword">)</span></span> <span class="keyword">#then</span>

<span class="keyword">absviewt@ype</span> <span class="staexp"><a name="209"><span class="stacstdec">T</span></a></span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="223"><span class="dyncstdec">lte_T_T <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="265"><span class="dyncstdec">compare_T_T <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Sgn</span></span></a>

<span class="neuexp"><span class="keyword">overload</span> compare <span class="keyword">with</span> compare_T_T</span>
<span class="neuexp"><span class="keyword">overload</span> &lt;= <span class="keyword">with</span> lte_T_T</span>

<span class="keyword">#endif</span> <span class="comment">// end of [undefined (ARG_QUICKSORT_MT_DATS)]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> insert_one <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ofs<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mul<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>i<span class="keyword">,</span> sizeof T<span class="keyword">,</span> ofs<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf1<span class="keyword">:</span> <span class="staexp">array_v <span class="keyword">(</span>T<span class="keyword">,</span> i<span class="keyword">,</span> A<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf21<span class="keyword">:</span> <span class="staexp">T? @ <span class="keyword">(</span>A+ofs<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf22<span class="keyword">:</span> <span class="staexp">array_v <span class="keyword">(</span>T<span class="keyword">,</span> n-i-1<span class="keyword">,</span> A+ofs+sizeof T<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">T</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">ptr <span class="keyword">(</span>A+ofs<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span> <span class="keyword">|</span> void<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> i <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp">pf1_mul <span class="keyword">=</span> mul_add_const <span class="staexp"><span class="keyword">{</span>~1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">)</span></span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf11<span class="keyword">,</span> pf12<span class="keyword">)</span> <span class="keyword">=</span> array_v_unextend <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf1<span class="keyword">)</span></span>
      <span class="keyword">val</span> p1 <span class="keyword">=</span> p - sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span>
      <span class="keyword">val</span> x1 <span class="keyword">=</span> ptr_get_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf12</span> <span class="keyword">|</span> p1<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">if</span> x1 &lt;= x <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ptr_set_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf12</span> <span class="keyword">|</span> p1<span class="keyword">,</span> x1<span class="keyword">)</span>
        <span class="keyword">prval</span> <span class="prfexp">pf1 <span class="keyword">=</span> array_v_extend <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf1_mul<span class="keyword">,</span> pf11<span class="keyword">,</span> pf12<span class="keyword">)</span></span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := x
        <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> array_v_cons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
        <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> array_v_unsplit <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := x1
        <span class="keyword">prval</span> <span class="prfexp">pf2 <span class="keyword">=</span> array_v_cons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
      <span class="keyword">in</span>
        insert_one <span class="keyword">(</span><span class="prfexp">pf1_mul</span><span class="keyword">,</span> <span class="prfexp">pf11</span><span class="keyword">,</span> <span class="prfexp">pf12</span><span class="keyword">,</span> <span class="prfexp">pf2</span> <span class="keyword">|</span> x<span class="keyword">,</span> p1<span class="keyword">,</span> i-1<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> assert <span class="keyword">(</span>i <span class="keyword">=</span> 0<span class="keyword">)</span>
      <span class="keyword">prval</span> <span class="prfexp">MULbas <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf_mul</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> array_v_unnil <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf1<span class="keyword">)</span></span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := x
      <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> array_v_cons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [insert]
</span>
<span class="comment">(* ****** ****** *)</span>
  
<span class="keyword">fun</span> insert_all <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i &lt;= n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ofs<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="keyword">(</span>
    <span class="prfexp">pf_mul<span class="keyword">:</span> <span class="staexp">MUL <span class="keyword">(</span>i<span class="keyword">,</span> sizeof T<span class="keyword">,</span> ofs<span class="keyword">)</span></span></span>
  <span class="keyword">,</span> <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span>
  <span class="keyword">|</span> p<span class="keyword">:</span> <span class="staexp">ptr <span class="keyword">(</span>A+ofs<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> i <span class="keyword">&lt;</span> n <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> array_v_split <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> array_v_uncons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf2<span class="keyword">)</span></span>
    <span class="keyword">val</span> x <span class="keyword">=</span> ptr_get_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf21</span> <span class="keyword">|</span> p<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_new</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> insert_one <span class="keyword">(</span><span class="prfexp">pf_mul</span><span class="keyword">,</span> <span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf21</span><span class="keyword">,</span> <span class="prfexp">pf22</span> <span class="keyword">|</span> x<span class="keyword">,</span> p<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := pf_new</span>
  <span class="keyword">in</span>
    insert_all <span class="keyword">(</span><span class="prfexp">mul_add_const <span class="staexp"><span class="keyword">{</span>1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">)</span></span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> p+sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">,</span> i+1<span class="keyword">,</span> n<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [insert_all]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> insort <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> n &gt;= 2 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp">pf_mul <span class="keyword">=</span> MULind <span class="keyword">(</span>MULbas <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    insert_all <span class="keyword">(</span><span class="prfexp">pf_mul</span><span class="keyword">,</span> <span class="prfexp">pf</span> <span class="keyword">|</span> A+sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">,</span> 1<span class="keyword">,</span> n<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [insort]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">macdef</span> <span class="neuexp">size <span class="keyword">=</span> size1_of_int1</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> exch <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i1<span class="keyword">,</span>i2<span class="keyword">:</span>nat <span class="keyword">|</span> i1 <span class="keyword">&lt;</span> n<span class="keyword">;</span> i2 <span class="keyword">&lt;</span> n<span class="keyword">;</span> i1 &lt;&gt; i2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> i1<span class="keyword">:</span> <span class="staexp">int i1</span><span class="keyword">,</span> i2<span class="keyword">:</span> <span class="staexp">int i2</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">@(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">pf2</span><span class="keyword">,</span> <span class="prfexp">fpf</span> <span class="keyword">|</span> p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span>
    array_ptr_takeout2_tsz <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> <span class="keyword">(</span>size<span class="keyword">)</span>i1<span class="keyword">,</span> <span class="keyword">(</span>size<span class="keyword">)</span>i2<span class="keyword">,</span> sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="keyword">val</span> tmp <span class="keyword">=</span> <span class="keyword">!</span>p1<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p1 := <span class="keyword">!</span>p2<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p2 := tmp
<span class="keyword">in</span>
  pf := fpf <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [exch]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> innerLoop_l <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>l<span class="keyword">,</span>r<span class="keyword">:</span>int <span class="keyword">|</span> 0 &lt;= l<span class="keyword">;</span> l &lt;= r+1<span class="keyword">;</span> r <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n-l<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> pivot<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">int l</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int r</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">natLte <span class="keyword">(</span>r+1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> l &lt;= r <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf</span> <span class="keyword">|</span> p1<span class="keyword">)</span> <span class="keyword">=</span> array_ptr_takeout_tsz <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> <span class="keyword">(</span>size<span class="keyword">)</span>l<span class="keyword">,</span> sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> <span class="keyword">!</span>p1 &lt;= pivot <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := fpf <span class="keyword">(</span>pf1<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      innerLoop_l <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> l+1<span class="keyword">,</span> r<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      pf := fpf <span class="keyword">(</span>pf1<span class="keyword">)</span><span class="keyword">;</span> l
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    l <span class="comment">// return value
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [innerLoop_l]
</span>
<span class="keyword">fun</span> innerLoop_r <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>l<span class="keyword">,</span>r<span class="keyword">:</span>int <span class="keyword">|</span> 0 &lt;= l<span class="keyword">;</span> l &lt;= r+1<span class="keyword">;</span> r <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>r+1<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> pivot<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">int l</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int r</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">intBtw <span class="keyword">(</span>l-1<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> l &lt;= r <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf1</span><span class="keyword">,</span> <span class="prfexp">fpf</span> <span class="keyword">|</span> p1<span class="keyword">)</span> <span class="keyword">=</span> array_ptr_takeout_tsz <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> <span class="keyword">(</span>size<span class="keyword">)</span>r<span class="keyword">,</span> sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> pivot &lt;= <span class="keyword">!</span>p1 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := fpf <span class="keyword">(</span>pf1<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      innerLoop_r <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> l<span class="keyword">,</span> r-1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      pf := fpf <span class="keyword">(</span>pf1<span class="keyword">)</span><span class="keyword">;</span> r
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    r <span class="comment">// return value
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [innerLoop_r]
</span>
<span class="keyword">fun</span> outerLoop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>l<span class="keyword">,</span>r<span class="keyword">:</span>int <span class="keyword">|</span> 0 &lt;= l<span class="keyword">;</span> l &lt;= r+1<span class="keyword">;</span> r <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> pivot<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>T</span><span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">int l</span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">int r</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">natLte n</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> l <span class="keyword">=</span> innerLoop_l <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> innerLoop_r <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> l <span class="keyword">&lt;</span> r <span class="keyword">then</span> <span class="keyword">begin</span>
    exch <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> l<span class="keyword">,</span> r<span class="keyword">)</span><span class="keyword">;</span> outerLoop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> l+1<span class="keyword">,</span> r-1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    l <span class="comment">// the pivot
</span>  <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [outerLoop]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> partition <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat <span class="keyword">|</span> n &gt;= 2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">natLt n</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> ofs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>size<span class="keyword">)</span>n szmul2 sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span>
  <span class="keyword">prval</span> <span class="prfexp">pf1_mul <span class="keyword">=</span> mul_add_const <span class="staexp"><span class="keyword">{</span>~1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">)</span></span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">@(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> array_v_unextend <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf<span class="keyword">)</span></span>
  <span class="keyword">val</span> pivot <span class="keyword">=</span> ptr_get_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> A + ofs - sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">)</span>
  <span class="keyword">val</span> i_pivot <span class="keyword">=</span> outerLoop <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> A<span class="keyword">,</span> pivot<span class="keyword">,</span> 0<span class="keyword">,</span> n-2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
    <span class="keyword">if</span> i_pivot <span class="keyword">&lt;</span> n - 1 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf11</span><span class="keyword">,</span> <span class="prfexp">fpf1</span> <span class="keyword">|</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
        array_ptr_takeout_tsz <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> A<span class="keyword">,</span> <span class="keyword">(</span>size<span class="keyword">)</span>i_pivot<span class="keyword">,</span> sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ptr_set_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> A + ofs - sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p := pivot<span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := fpf1 <span class="keyword">(</span>pf11<span class="keyword">)</span></span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      ptr_set_vt&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf2</span> <span class="keyword">|</span> A + ofs - sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">,</span> pivot<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := array_v_extend <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf1_mul<span class="keyword">,</span> pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
<span class="keyword">in</span>
  i_pivot
<span class="keyword">end</span> <span class="comment">// end of [partition]
</span>
<span class="keyword">#define</span> <span class="neuexp">THRESHOLD 16</span>

<span class="keyword">fun</span> qsort_main <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">if</span> n &gt;= THRESHOLD <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> i_pivot <span class="keyword">=</span> partition <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> n<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_mul</span> <span class="keyword">|</span> ofs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>size<span class="keyword">)</span>i_pivot szmul2 sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span>
      <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> array_v_split <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span> <span class="keyword">=</span> array_v_uncons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf2<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp">pf1_mul <span class="keyword">=</span> mul_add_const <span class="staexp"><span class="keyword">{</span>1<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">)</span></span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> qsort_main <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> A<span class="keyword">,</span> i_pivot<span class="keyword">)</span>
    <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> qsort_main <span class="keyword">(</span><span class="prfexp">pf22</span> <span class="keyword">|</span> A+ofs+sizeof&lt;<span class="staexp">T</span><span class="keyword">&gt;</span><span class="keyword">,</span> n-i_pivot-1<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf2 := array_v_cons <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf21<span class="keyword">,</span> pf22<span class="keyword">)</span></span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := array_v_unsplit <span class="staexp"><span class="keyword">{</span>T<span class="keyword">}</span></span> <span class="keyword">(</span>pf_mul<span class="keyword">,</span> pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    <span class="comment">// empty
</span>  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">// end of [qsort]
</span>
<span class="keyword">fun</span> qsort <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>A<span class="keyword">:</span>addr<span class="keyword">}</span></span>
  <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>array_v <span class="keyword">(</span>T<span class="keyword">,</span> n<span class="keyword">,</span> A<span class="keyword">)</span></span></span> <span class="keyword">|</span> A<span class="keyword">:</span> <span class="staexp">ptr A</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int n</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  qsort_main <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">;</span> insort <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> A<span class="keyword">,</span> n<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [qsort]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [qsort_mt.dats] *)</span>
</pre>
</body>
</html>
