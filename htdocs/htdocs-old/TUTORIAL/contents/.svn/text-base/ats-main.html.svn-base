<HTML>
<BODY text="#000000" bgcolor="#ffffff" link="#0000FF" vlink="#CC00CC" alink="#ff0000">

<H2>The Main Function in ATS</H2>
<HR SIZE=1 ALIGN=LEFT><P>

The main function in ATS is declared as follows:

<pre>
fun main {n:int | n > 0} (argc: int n, argv: &(@[String][n])): void
  = "mainats"
</pre>

So this function takes an integer <i>argc</i> greater than 0 and a string
array <i>argv</i> of size <i>argc</i> and returns no value.  The syntax
<i>argv: &(@[String][n])</i> indicates that <i>argv</i> is a
call-by-reference argument. If we followed C++ kind of syntax, then
this would be written as something like <i>&argv: @[String][n]</i>.
<P>

The name "mainats", which is global, can be used in C code to refer to this
function.  When a program in ATS is compiled that implements the main
function in ATS, the following implementation of the main function in C is
automatically included in the C code generated by the ATS compiler:
<P>

<pre>
main (int argc, char *argv[]) {

// some initialization code is included here

mainats (argc, argv) ;
return 0 ;

}
</pre>

As an example, the following ATS program prints out the command line
on the standard output:

<pre>
implement main (argc, argv) = let

fun loop {n,i:nat | i <= n}
  (i: int i, argc: int n, argv: &(@[String][n])): void =
  if i < argc then begin
    print argv.[i]; if i > 0 then print (' '); loop (i+1, argc, argv)
  end
in

loop (0, argc, argv); print_newline ()

end // end of [main]
</pre>

There are also situations where the function <i>mainats</i> may need to be
implemented in C. If this happens, the function <i>main_dummy</i> needs to
be implemented as follows:

<pre>
implement main_dummy () = ()
</pre>

This allows the compiler to generate proper code for the main function in C.
<P>

As an example, we present as follows a typical scenario in GTK+
programming, where the function <i>gtk_init</i> needs to be called to
modify the arguments passed from a command line:

<pre>
// some function implemented in ATS
extern fun main_work {n:pos} (argc: int n, argv: &(@[String][n])): void
  = "main_work"

implement main_work (argc, argv) = ( (* some ATS code that does the main work *) )

implement main_dummy () = () // indicating [mainats] being implemented in C

%{

ats_void_type mainats (ats_int_type argc, ats_ptr_type argv) {

gtk_init ((int*)&argc, (char ***)&argv) ;
main_work (argc, argv) ;
return ;

}

%}
</pre>

<HR SIZE=1 ALIGN=LEFT><P>
The code used for illustration is available <a href="ats-main.dats">here</a>.

</BODY>
</HTML>
