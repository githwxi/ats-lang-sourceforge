<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">(*
** The Great Computer Language Shootout
** http://shootout.alioth.debian.org/
**
** contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
**
** compilation command:
**   atscc -fomit-frame-pointer -O3 fannkuch.dats -o fannkuch
*)</FONT>

<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">_<FONT COLOR="#787878">(*anonymous*)</FONT> <FONT COLOR="#000000">=</FONT> "prelude/DATS/array.dats"</FONT>

<FONT COLOR="#000000">macdef</FONT> <FONT COLOR="#800080">iarr <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_make_elt <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">,(</FONT>n<FONT COLOR="#000000">)</FONT>+1<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">iarr <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array <FONT COLOR="#000000">(</FONT>natLte n<FONT COLOR="#000000">,</FONT> n+1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">fn</FONT> iarr_copy <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGte 1</FONT> <FONT COLOR="#000000">=</FONT> 1 <FONT COLOR="#000000">in</FONT> <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>i &lt;= n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>B[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [iarr_copy]
</FONT>
<FONT COLOR="#000000">fn</FONT> print_iarr <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGte 1</FONT> <FONT COLOR="#000000">=</FONT> 1
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>i &lt;= n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>print A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> perm_rotate
  <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 1 &lt;= i<FONT COLOR="#000000">;</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">var</FONT> k<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGte 1</FONT> <FONT COLOR="#000000">=</FONT> 1<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">var</FONT> k1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> P1 <FONT COLOR="#000000">=</FONT> P[<FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>k <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>k1 := k+1<FONT COLOR="#000000">;</FONT> P[<FONT COLOR="#009000">k</FONT><FONT COLOR="#000000">]</FONT> := P[<FONT COLOR="#009000">k1</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> k := k1<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  P[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := P1
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> perm_next <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 1 &lt;= i<FONT COLOR="#000000">;</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte <FONT COLOR="#000000">(</FONT>n+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> x <FONT COLOR="#000000">=</FONT> C[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> x1 <FONT COLOR="#000000">=</FONT> x-1<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> perm_rotate <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">case+</FONT> 0 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">when</FONT> x1 <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT>C[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := x1<FONT COLOR="#000000">;</FONT> i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#787878">(* x1 = 0 *)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> C[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := i<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> i1 <FONT COLOR="#000000">=</FONT> i + 1
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> i1 &lt;= n <FONT COLOR="#000000">then</FONT> perm_next <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> i1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> i1
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> fannkuch <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> n &gt;= 2<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> S<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT> max<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> rev <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">,</FONT>u<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 1 &lt;= l<FONT COLOR="#000000">;</FONT> l &lt;= u+1<FONT COLOR="#000000">;</FONT> u &lt;= n<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>S<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int l</FONT><FONT COLOR="#000000">,</FONT> u<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int u</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> <FONT COLOR="#000000">(</FONT>l <FONT COLOR="#000000">&lt;</FONT> u<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> tmp <FONT COLOR="#000000">=</FONT> S[<FONT COLOR="#009000">l</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">in</FONT> S[<FONT COLOR="#009000">l</FONT><FONT COLOR="#000000">]</FONT> := S[<FONT COLOR="#009000">u</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> S[<FONT COLOR="#009000">u</FONT><FONT COLOR="#000000">]</FONT> := tmp<FONT COLOR="#000000">;</FONT> rev <FONT COLOR="#000000">(</FONT>S<FONT COLOR="#000000">,</FONT> l+1<FONT COLOR="#000000">,</FONT> u-1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">var</FONT> max<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> max<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> P[<FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">=</FONT> 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT>
    <FONT COLOR="#000000">if</FONT> P[<FONT COLOR="#009000">n</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">=</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">var</FONT> cnt<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> 0<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> iarr_copy <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> S<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">var</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte n</FONT> <FONT COLOR="#000000">=</FONT> S[<FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>x <FONT COLOR="#000000">&gt;</FONT> 1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">begin</FONT>
        cnt := cnt + 1<FONT COLOR="#000000">;</FONT> rev <FONT COLOR="#000000">(</FONT>S<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> x := S[<FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> max <FONT COLOR="#000000">&lt;</FONT> cnt <FONT COLOR="#000000">then</FONT> max := cnt
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> perm_next <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> 2<FONT COLOR="#000000">)</FONT> &lt;= n <FONT COLOR="#000000">then</FONT> fannkuch <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">,</FONT> S<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> max<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> max
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> iarr_init <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>A<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">iarr n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">var</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGte 1</FONT> <FONT COLOR="#000000">=</FONT> 1 <FONT COLOR="#000000">in</FONT> <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>i &lt;= n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := i<FONT COLOR="#000000">;</FONT> i := i+1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">NPRINT 30</FONT>

<FONT COLOR="#000000">implement</FONT> main <FONT COLOR="#000000">(</FONT>argc<FONT COLOR="#000000">,</FONT> argv<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> assert <FONT COLOR="#000000">(</FONT>argc &gt;= 2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">[</FONT><FONT COLOR="#0000FF">n<FONT COLOR="#000000">:</FONT>int</FONT><FONT COLOR="#000000">]</FONT> n <FONT COLOR="#000000">=</FONT> int1_of argv<FONT COLOR="#000000">.</FONT><FONT COLOR="#000000">[</FONT><FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> assert <FONT COLOR="#000000">(</FONT>n &gt;= 2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> C <FONT COLOR="#000000">=</FONT> iarr n<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> iarr_init <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> P <FONT COLOR="#000000">=</FONT> iarr n<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> iarr_init <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> NPRINT <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> print_iarr <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">var</FONT> times<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> 1<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">while</FONT> <FONT COLOR="#000000">(</FONT>times <FONT COLOR="#000000">&lt;</FONT> NPRINT<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">begin</FONT>
     perm_next <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> 2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> print_iarr <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> times := times + 1
  <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> iarr_init <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> iarr_init <FONT COLOR="#000000">(</FONT>P<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> S <FONT COLOR="#000000">=</FONT> iarr n<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> ans <FONT COLOR="#000000">=</FONT> fannkuch <FONT COLOR="#000000">(</FONT>C<FONT COLOR="#000000">,</FONT> P<FONT COLOR="#000000">,</FONT> S<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  printf <FONT COLOR="#000000">(</FONT>"Pfannkuchen(%i) = %i\n"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>n<FONT COLOR="#000000">,</FONT> ans<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* end of [fannkuch1.dats] *)</FONT>

<FONT COLOR="#787878">//// Some explanation about the code

In this example, each and every array subscription used in the code is
verified to be safe, that is, the subscript involved in within the bounds
of the subscripted array. Following is some explanation about the use of
dependent types in the code:

Given an integer n, the type natLte(n) is defined as follows  in ATS:

typedef natLte(n:int) = [i:nat | i &lt;= n] int(i)

where int(i) is the type for the only integer of value i. In plain words,
natLte(n) is for natural numbers (a.k.a., nonnegative integers) less than
or equal to n. Note that the syntax [...] is used for existential
quantification.

The type iarr(n) is defined as follows

typedef iarr(n:int) = array(natLte n, n+1)

In ATS, array(T, I) is a type for arrays of size I in which each element is
of type T. So iarr(n) is a type for arrays of size n+1 in which each
element is of type natLte(n), that is, each element is a natural number
less than or equal to n.

Now let us take a look at the following function definition:

fn iarr_copy {n:nat}
  (A: iarr n, B: iarr n, n: int n): void = let
  var i: intGte 1 = 1 in while (i &lt;= n) (B[i] := A[i]; i := i+1)
end // end of [iarr_copy]

The type assigned to iarr_copy is

{n:nat} (iarr n, iarr n, int n): void 

The syntax {...} is used for universal quantification. So the type of
iarr_copy states that for every natural number n, the function takes two
arrays of type iarr(n) and an integer whose value equals n and return
nothing. In the body of the function, we see the code B[i] := A[i]; here,
the ATS typechecker *must* verify that i is within the bounds of B and A;
this is easy as the code B[i] := A[i] occurs after the test (i &lt;= n)
succeeds. Note that if i is replaced with i+1, then a type error appears as
it is impossible to prove i+1 is within the bounds of A (i.e., 0 &lt;= i+1 &lt;
n+1) under the condition i &lt;= n.

In this example, for each and every array subscription, it is verified by
the ATS typechecker at the compile-time that the subscript involved is
within bounds. Probably the most interesting case here is the function
perm_next; the type assigned to this function indicates that the return
value of this function is a natural number less than or equal to n+1, where
n is the value of the third argument of the function.
</FONT></PRE></BODY>
