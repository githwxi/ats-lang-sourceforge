<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: March 2008
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Deb <span class="keyword">=</span> "ats_debug.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Err <span class="keyword">=</span> "ats_error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Lst <span class="keyword">=</span> "ats_list.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Set <span class="keyword">=</span> "ats_set_fun.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Sym <span class="keyword">=</span> "ats_symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Syn <span class="keyword">=</span> "ats_syntax.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_staexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"ats_dynexp3.sats"</span>

<span class="keyword">staload</span> <span class="staexp">"ats_hiexp.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_trans4.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THISFILENAME "ats_trans4.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">nil list_nil</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">cons list_cons</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">:: list_cons</span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">overload</span> <span class="keyword">=</span> <span class="keyword">with</span> $Sym<span class="keyword">.</span>eq_symbol_symbol</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> prerr_loc_error4 <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": error(4)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_error4]
</span>
<span class="keyword">fn</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_trans4)"
<span class="keyword">fn</span> prerr_loc_interror <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  $Loc<span class="keyword">.</span>prerr_location loc<span class="keyword">;</span> prerr ": INTERNAL ERROR (ats_trans4)"
<span class="keyword">end</span> <span class="comment">// end of [prerr_loc_interror]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hityp_ptr_abs <span class="keyword">(</span>s2t<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hityp</span> <span class="keyword">=</span>
  <span class="keyword">if</span> s2rt_is_boxed <span class="keyword">(</span>s2t<span class="keyword">)</span> <span class="keyword">then</span> hityp_ptr <span class="keyword">else</span> hityp_abs
<span class="comment">// end of [hityp_ptr_abs]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// HX-2010-12-05:
</span><span class="comment">// for testing if a type is named: a named type is one that
</span><span class="comment">// can be recovered from its name. For instance, bool, char,
</span><span class="comment">// float, double and int are all named types, but string is
</span><span class="comment">// not named as its (erasure) name is simply "ats_ptr_type".
</span><span class="comment">//
</span><span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2976"><span class="dyncstdec">s2exp_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> deep<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> named<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bool</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span></span></a> <span class="comment">// end of [s2exp_tr_named]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2exp_app_tr_named <span class="staexp"><span class="keyword">.&lt;&gt;.</span></span> <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> deep<span class="keyword">:</span> <span class="staexp">int</span>
  <span class="keyword">,</span> s2t_app<span class="keyword">:</span> <span class="staexp">s2rt</span>
  <span class="keyword">,</span> s2e_fun<span class="keyword">:</span> <span class="staexp">s2exp</span>
  <span class="keyword">,</span> s2es_arg<span class="keyword">:</span> <span class="staexp">s2explst</span>
  <span class="keyword">,</span> named<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bool</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "s2exp_app_tr: s2t_app = "; print s2t_app; print_newline ();
    print "s2exp_app_tr: s2e_fun = "; print s2e_fun; print_newline ();
    print "s2exp_app_tr: s2es_arg = "; print s2es_arg; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> s2e_fun<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Ecst s2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2t_app <span class="keyword">of</span>
<span class="comment">(*
    | _ when s2rt_is_boxed s2t_app =&gt; hityp_ptr
*)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2cst_isabs_get s2c <span class="keyword">of</span>
      <span class="keyword">|</span> Some <span class="keyword">(</span>os2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> os2e <span class="keyword">of</span>
        <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2e<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
          <span class="keyword">|</span> S2Elam <span class="keyword">(</span>s2vs_arg<span class="keyword">,</span> s2e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">//
</span>              <span class="keyword">fun</span> aux <span class="keyword">(</span>
                  s2vs<span class="keyword">:</span> <span class="staexp">s2varlst</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span>
                <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">stasub_t</span> <span class="keyword">=</span>
                <span class="keyword">case+</span> <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">of</span>
                <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>s2v<span class="keyword">,</span> s2vs<span class="keyword">)</span><span class="keyword">,</span> cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                    <span class="keyword">val</span> sub <span class="keyword">=</span> aux <span class="keyword">(</span>s2vs<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">in</span> stasub_add <span class="keyword">(</span>sub<span class="keyword">,</span> s2v<span class="keyword">,</span> s2e<span class="keyword">)</span>
                  <span class="keyword">end</span> <span class="comment">// end of [cons, cons]
</span>                <span class="keyword">|</span> <span class="keyword">(</span>nil _<span class="keyword">,</span> nil _<span class="keyword">)</span> <span class="keyword">=&gt;</span> stasub_nil
                <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span>
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": s2exp_app_tr: S2Eapp: arity error"
                    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
                  <span class="keyword">in</span>
                    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>stasub_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
                  <span class="keyword">end</span> <span class="comment">// end [_,_]
</span>              <span class="comment">// end of [aux]
</span><span class="comment">//
</span>              <span class="keyword">val</span> sub <span class="keyword">=</span> aux <span class="keyword">(</span>s2vs_arg<span class="keyword">,</span> s2es_arg<span class="keyword">)</span>
              <span class="keyword">val</span> s2e_app <span class="keyword">=</span> s2exp_subst <span class="keyword">(</span>sub<span class="keyword">,</span> s2e_body<span class="keyword">)</span>
<span class="comment">//
</span>            <span class="keyword">in</span>
              s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e_app<span class="keyword">,</span> named<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [S2Elam]
</span>          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t_app<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>        <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t_app<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [case]
</span>      <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t_app<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [case]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [S2Ecst] *)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t_app<span class="keyword">)</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [s2exp_app_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2Var_tr_named <span class="staexp"><span class="keyword">.&lt;&gt;.</span></span> <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
<span class="keyword">,</span> deep<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2V<span class="keyword">:</span> <span class="staexp">s2Var_t</span><span class="keyword">,</span> named<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>bool</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> s2Var_lbs_get s2V <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2Vb<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2elb <span class="keyword">=</span> s2Varbound_val_get <span class="keyword">(</span>s2Vb<span class="keyword">)</span>
    <span class="keyword">in</span>
      s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2elb<span class="keyword">,</span> named<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2Var_ubs_get s2V <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2Vb<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> s2eub <span class="keyword">=</span> s2Varbound_val_get <span class="keyword">(</span>s2Vb<span class="keyword">)</span>
      <span class="keyword">in</span>
        s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2eub<span class="keyword">,</span> named<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_abs <span class="comment">// end of [list_nil]
</span>    <span class="keyword">end</span> <span class="comment">// end of [list_nil]
</span><span class="keyword">end</span> <span class="comment">// end of [s2Var_tr_named]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> update_ifnot_named <span class="keyword">(</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span><span class="keyword">,</span> s2e<span class="keyword">:</span> <span class="staexp">s2exp</span><span class="keyword">,</span> named<span class="keyword">:</span> <span class="staexp">bool</span>
<span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> res <span class="keyword">of</span>
  <span class="keyword">|</span> Some _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">if</span> not<span class="keyword">(</span>named<span class="keyword">)</span> <span class="keyword">then</span> res := Some <span class="keyword">(</span>s2e<span class="keyword">)</span>
<span class="comment">// end of [update_ifnot_named]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2explst_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2es <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> named<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
      <span class="keyword">val</span> hit <span class="keyword">=</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> update_ifnot_named <span class="keyword">(</span>res<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
    <span class="keyword">in</span>
      list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> s2explst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [s2explst_tr_named]
</span>
<span class="keyword">fun</span> s2explst_tr <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> s2explst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2explstlst_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2ess<span class="keyword">:</span> <span class="staexp">s2explstlst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplstlst</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> s2ess <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2es<span class="keyword">,</span> s2ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hits <span class="keyword">=</span> s2explst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">in</span>
      list_cons <span class="keyword">(</span>hits<span class="keyword">,</span> s2explstlst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ess<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [s2explstlst_tr_named]
</span>
<span class="keyword">fun</span> s2explstlst_tr <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2ess<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplstlst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> s2explstlst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ess<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> s2explst_npf_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
<span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux1 <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> s2es <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>s2e<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> s2exp_is_proof s2e <span class="keyword">then</span> aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">var</span> named<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
          <span class="keyword">val</span> hit <span class="keyword">=</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> update_ifnot_named <span class="keyword">(</span>res<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
        <span class="keyword">in</span>
          list_cons <span class="keyword">(</span>hit<span class="keyword">,</span> aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [cons] *)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>  <span class="comment">// end of [aux1]
</span>  <span class="keyword">fun</span> aux2 <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2es <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>_<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> i-1<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// deadcode
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span> <span class="comment">// proof arguments have been dropped
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [aux2]
</span><span class="keyword">in</span>
  aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_npf_tr_named]
</span>
<span class="keyword">fun</span> s2explst_npf_tr <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> s2es<span class="keyword">:</span> <span class="staexp">s2explst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">in</span> s2explst_npf_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> s2es<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2explst_npf_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> labs2explst_npf_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
<span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhityplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux1 <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhityplst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
    <span class="keyword">|</span> LABS2EXPLSTcons
        <span class="keyword">(</span>l<span class="keyword">,</span> s2e<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> isprf <span class="keyword">=</span> s2exp_is_proof s2e <span class="keyword">in</span>
        <span class="keyword">if</span> isprf <span class="keyword">then</span> <span class="keyword">begin</span>
          aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span> <span class="comment">// HX: skipping the proof argument
</span>        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">var</span> named<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
          <span class="keyword">val</span> hit <span class="keyword">=</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> update_ifnot_named <span class="keyword">(</span>res<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
        <span class="keyword">in</span>
          LABHITYPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> hit<span class="keyword">,</span> aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="keyword">end</span> <span class="comment">// end of [LABS2EXPLSTcons]
</span>    <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux1]
</span>  <span class="keyword">fun</span> aux2 <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
    <span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ls2es<span class="keyword">:</span> <span class="staexp">labs2explst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>s2expopt</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhityplst</span> <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ls2es <span class="keyword">of</span>
      <span class="keyword">|</span> LABS2EXPLSTcons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> i-1<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">|</span> LABS2EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// deadcode
</span>    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      aux1 <span class="keyword">(</span>loc0<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span> <span class="comment">// proof arguments have been dropped
</span>    <span class="keyword">end</span> <span class="comment">// end of [if]
</span>  <span class="comment">// end of [aux2]
</span><span class="keyword">in</span>
  aux2 <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labs2explst_npf_tr_named]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_tr_named <span class="keyword">(</span>
  loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e0<span class="keyword">,</span> named
<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s2e0 <span class="keyword">=</span> s2exp_whnf s2e0<span class="keyword">;</span> <span class="keyword">val</span> s2t0 <span class="keyword">=</span> s2e0<span class="keyword">.</span>s2exp_srt
<span class="comment">(*
  val () = begin
    print "s2exp_tr_named: loc0 = "; $Loc.print_location loc0; print_newline ();
    print "s2exp_tr_named: deep = "; print deep; print_newline ();
    print "s2exp_tr_named: s2e0 = "; print s2e0; print_newline ();
  end // end of [val]
*)</span>
  <span class="keyword">fn</span> err <span class="keyword">(</span>
      loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> s2t0<span class="keyword">:</span> <span class="staexp">s2rt</span><span class="keyword">,</span> s2e0<span class="keyword">:</span> <span class="staexp">s2exp</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_loc_error4 <span class="keyword">(</span>loc0<span class="keyword">)</span><span class="keyword">;</span>
    $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": [%s]: s2exp_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": s2t0 = "<span class="keyword">;</span> prerr s2t0<span class="keyword">;</span> prerr "; s2e0 = "<span class="keyword">;</span> prerr_s2exp <span class="keyword">(</span>s2e0<span class="keyword">)</span><span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hityp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [err]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> s2e0<span class="keyword">.</span>s2exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> S2Eapp <span class="keyword">(</span>
      s2e_fun<span class="keyword">,</span> s2es_arg
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> s2t0 <span class="keyword">=</span> s2e0<span class="keyword">.</span>s2exp_srt <span class="keyword">in</span>
      s2exp_app_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2t0<span class="keyword">,</span> s2e_fun<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> named<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Eapp]
</span>  <span class="keyword">|</span> S2Ecrypt s2e <span class="keyword">=&gt;</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
  <span class="keyword">|</span> S2Ecst s2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2t0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> s2cst_isabs_get s2c <span class="keyword">of</span>
      <span class="keyword">|</span> Some os2e <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> os2e <span class="keyword">of</span>
        <span class="keyword">|</span> Some s2e <span class="keyword">=&gt;</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
        <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t0<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>      <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_ptr_abs <span class="keyword">(</span>s2t0<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Ecst]
</span>  <span class="keyword">|</span> S2Eclo <span class="keyword">(</span>knd<span class="keyword">,</span> s2exp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> knd &lt;&gt; 0 <span class="keyword">then</span> hityp_ptr <span class="comment">(*1/-1:cloptr/cloref*)</span> <span class="keyword">else</span> hityp_abs <span class="comment">(*0:clo*)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Eclo]
</span>  <span class="keyword">|</span> S2Edatconptr _ <span class="keyword">=&gt;</span> hityp_ptr
  <span class="keyword">|</span> S2Edatcontyp <span class="keyword">(</span>d2c<span class="keyword">,</span> s2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> deep <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> npf <span class="keyword">=</span> d2con_npf_get d2c
        <span class="keyword">val</span> hits_arg <span class="keyword">=</span> s2explst_npf_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> s2es<span class="keyword">)</span>
      <span class="keyword">in</span>
        hityp_tysumtemp <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        hityp_ptr <span class="comment">// deep = 0
</span>      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Edatcontyp]
</span>  <span class="keyword">|</span> S2Eexi <span class="keyword">(</span>_<span class="comment">(*s2vs*)</span><span class="keyword">,</span> _<span class="comment">(*s2ps*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
  <span class="keyword">|</span> S2Eextype <span class="keyword">(</span>name<span class="keyword">,</span> _arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> _arg <span class="keyword">=</span> s2explstlst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> _arg<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">case+</span> res <span class="keyword">of</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> named := true <span class="keyword">|</span> Some _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">)</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      hityp_extype <span class="keyword">(</span>name<span class="keyword">,</span> _arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Eextype]
</span>  <span class="keyword">|</span> S2Efun <span class="keyword">(</span>
      fc<span class="keyword">,</span> _<span class="comment">(*lin*)</span><span class="keyword">,</span> _<span class="comment">(*s2fe*)</span><span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">,</span> s2e_res
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> deep <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hits_arg <span class="keyword">=</span> s2explst_npf_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> s2es_arg<span class="keyword">)</span>
        <span class="keyword">val</span> hit_res <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e_res<span class="keyword">)</span>
        <span class="comment">// HX: [hityp_varetisze] turns [ats_var_type]
</span>        <span class="keyword">val</span> hit_res <span class="keyword">=</span> hityp_varetize <span class="keyword">(</span>hit_res<span class="keyword">)</span> <span class="comment">// into [ats_varet_type] if needed
</span><span class="comment">(*
        val HITNAM (_, name) = hit_res.hityp_name
        val () = (print "s2exp_tr_named: S2Efun: hit_res = "; print name; print_newline ())
*)</span>
      <span class="keyword">in</span>
        hityp_fun <span class="keyword">(</span>fc<span class="keyword">,</span> hits_arg<span class="keyword">,</span> hit_res<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span> <span class="keyword">case+</span> fc <span class="keyword">of</span>
        <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOfun <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_ptr <span class="comment">// function pointer
</span>        <span class="keyword">|</span> $Syn<span class="keyword">.</span>FUNCLOclo knd <span class="keyword">=&gt;</span> <span class="keyword">if</span> knd <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span>
            hityp_clo <span class="comment">// GCC is to report an error as [hityp_clo] is abstract
</span>          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> knd <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> hityp_clo_ptr <span class="keyword">else</span> hityp_clo_ref <span class="comment">(*knd = -1*)</span>
          <span class="keyword">end</span> <span class="comment">// end of [FUNCLOclo]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Efun]
</span>  <span class="keyword">|</span> S2Elam <span class="keyword">(</span>_<span class="comment">(*s2vs*)</span><span class="keyword">,</span> s2e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e_body<span class="keyword">,</span> named<span class="keyword">)</span>
  <span class="keyword">|</span> S2Emetfn <span class="keyword">(</span>_<span class="comment">(*stamp*)</span><span class="keyword">,</span> _<span class="comment">(*met*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">)</span>
<span class="comment">(*
// HX-2010-12-04: inadequate design
  | S2Enamed (name, _) =&gt; let
      val name = $Sym.symbol_name name in hityp_extype name
    end // end of [S2Enamed]
*)</span>
  <span class="keyword">|</span> S2Erefarg <span class="keyword">(</span>refval<span class="keyword">,</span> s2e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      hityp_refarg <span class="keyword">(</span>refval<span class="keyword">,</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e_arg<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Erefarg]
</span>  <span class="keyword">|</span> S2Etop <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
  <span class="keyword">|</span> S2Etyarr <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="keyword">,</span> s2e_elt<span class="keyword">)</span> <span class="keyword">in</span> hityp_tyarr <span class="keyword">(</span>hit_elt<span class="keyword">,</span> s2ess_dim<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [S2Etyarr]
</span>  <span class="keyword">|</span> S2Etyrec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">)</span> <span class="keyword">=&gt;</span> hit0 <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">(*
      val () = begin
        print "s2exp_tr_named: S2Etyrec: s2e0 = "; print s2e0; print_newline ()
      end // end of [val]
*)</span>
<span class="comment">//
</span>      <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> lhits <span class="keyword">=</span> labs2explst_npf_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> npf<span class="keyword">,</span> ls2es<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="comment">//
</span>      <span class="keyword">val</span> hit0 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> knd <span class="keyword">of</span>
        <span class="keyword">|</span> TYRECKINDbox <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
            <span class="keyword">if</span> deep <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> hityp_tyrectemp <span class="keyword">(</span>1<span class="comment">(*box*)</span><span class="keyword">,</span> lhits<span class="keyword">)</span>
            <span class="keyword">else</span> hityp_ptr
          <span class="keyword">end</span> <span class="comment">// end of [TYRECKINDbox]
</span>        <span class="keyword">|</span> TYRECKINDflt_ext name <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> named := true <span class="keyword">in</span> hityp_tyrec <span class="keyword">(</span>~1<span class="comment">(*ext*)</span><span class="keyword">,</span> name<span class="keyword">,</span> lhits<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [TYRECKINDflt_ext]
</span>        <span class="keyword">|</span> _ <span class="comment">(*TYRECKINDflt0/1*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> res <span class="keyword">of</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> named := true <span class="keyword">|</span> Some _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">in</span>
            <span class="keyword">case+</span> lhits <span class="keyword">of</span>
            <span class="keyword">|</span> LABHITYPLSTcons <span class="keyword">(</span>
                _<span class="comment">(*lab*)</span><span class="keyword">,</span> hit<span class="keyword">,</span> LABHITYPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">)</span> <span class="keyword">=&gt;</span> hityp_tyrecsin hit <span class="comment">// end of [LABHITYPLSTcons]
</span>            <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hityp_tyrectemp <span class="keyword">(</span>0<span class="comment">(*flt*)</span><span class="keyword">,</span> lhits<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [TYRECKINDflt0/1]
</span>      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hityp</span> <span class="comment">// end of [val]
</span><span class="comment">(*
      val () = begin
        print "s2exp_tr_named: S2Etyrec: hit0 = "; print_hityp hit0; print_newline ()
      end // end of [val]
*)</span>
    <span class="keyword">}</span> <span class="comment">// end of [S2Etyrec]
</span>  <span class="keyword">|</span> S2Euni <span class="keyword">(</span>_<span class="comment">(*s2vs*)</span><span class="keyword">,</span> _<span class="comment">(*s2ps*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">,</span> named<span class="keyword">)</span>
<span class="comment">(*
  | S2Eunion (stamp, s2i, ls2es) =&gt; let
      val lhits = labs2explst_npf_tr (0, ls2es)
      val lnames = List.map labhityp_labname_get lhits
      val tk_uni = TYKEYuni lnames
      val name = typedef_map_find tk
    in
      hityp_union (name, lhits)
    end // end of [S2Eunion]
*)</span>
  <span class="keyword">|</span> S2EVar s2V <span class="keyword">=&gt;</span> s2Var_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2V<span class="keyword">,</span> named<span class="keyword">)</span>
  <span class="keyword">|</span> S2Evar s2v <span class="keyword">=&gt;</span> hityp_s2var s2v
  <span class="keyword">|</span> S2Evararg _ <span class="keyword">=&gt;</span> hityp_vararg
  <span class="keyword">|</span> S2Ewth <span class="keyword">(</span>s2e<span class="keyword">,</span> _<span class="comment">(*wths2es*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> err <span class="keyword">(</span>loc0<span class="keyword">,</span> s2t0<span class="keyword">,</span> s2e0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_tr_named]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
** HX-2010-12-05: [s2e0] is assumed to be unnamed by default
*)</span>
  <span class="keyword">var</span> named<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false <span class="keyword">in</span> s2exp_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> deep<span class="keyword">,</span> s2e0<span class="keyword">,</span> named<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [s2exp_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hipatlst_typ_get <span class="keyword">(</span>hips<span class="keyword">:</span> <span class="staexp">hipatlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="staexp"><span class="keyword">{</span>hipat<span class="keyword">,</span> hityp<span class="keyword">}</span></span> <span class="keyword">(</span>hips<span class="keyword">,</span> <span class="keyword">lam</span> hip <span class="keyword">=&lt;&gt;</span> hip<span class="keyword">.</span>hipat_typ<span class="keyword">)</span>
<span class="comment">// end of [hipatlst_typ_get]
</span>
<span class="keyword">fn</span> p3at_is_proof <span class="keyword">(</span>p3t<span class="keyword">:</span> <span class="staexp">p3at</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> s2exp_is_proof <span class="keyword">(</span>p3t<span class="keyword">.</span>p3at_typ<span class="keyword">)</span>

<span class="keyword">fn</span> p3atlst_arg_tr
  <span class="keyword">(</span>npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> p3ts<span class="keyword">:</span> <span class="staexp">p3atlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">hipatlst</span> <span class="keyword">=</span> aux <span class="keyword">(</span>npf<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> p3ts<span class="keyword">:</span> <span class="staexp">p3atlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hipatlst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> p3ts <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>p3t<span class="keyword">,</span> p3ts<span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> p3ts<span class="keyword">)</span>
        <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> p3at_is_proof p3t <span class="keyword">then</span> aux <span class="keyword">(</span>0<span class="keyword">,</span> p3ts<span class="keyword">)</span>
          <span class="keyword">else</span> cons <span class="keyword">(</span>p3at_tr p3t<span class="keyword">,</span> aux <span class="keyword">(</span>0<span class="keyword">,</span> p3ts<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="comment">(* end of [list_cons] *)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [p3atlst_arg_tr]
</span>
<span class="keyword">fn</span> labp3atlst_arg_tr
  <span class="keyword">(</span>npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> lp3ts<span class="keyword">:</span> <span class="staexp">labp3atlst</span><span class="keyword">)</span>
  <span class="keyword">:</span> <span class="staexp">labhipatlst</span> <span class="keyword">=</span> aux <span class="keyword">(</span>npf<span class="keyword">,</span> lp3ts<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> lp3ts<span class="keyword">:</span> <span class="staexp">labp3atlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">labhipatlst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> lp3ts <span class="keyword">of</span>
    <span class="keyword">|</span> LABP3ATLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> p3t<span class="keyword">,</span> lp3ts<span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> lp3ts<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> p3at_is_proof p3t <span class="keyword">then</span> aux <span class="keyword">(</span>0<span class="keyword">,</span> lp3ts<span class="keyword">)</span>
          <span class="keyword">else</span> <span class="keyword">begin</span>
            LABHIPATLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> p3at_tr p3t<span class="keyword">,</span> aux <span class="keyword">(</span>0<span class="keyword">,</span> lp3ts<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">|</span> LABP3ATLSTdot <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHIPATLSTdot <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> LABP3ATLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHIPATLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [labp3atlst_arg_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
p3at_tr <span class="keyword">(</span>p3t0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hipat</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> p3t0<span class="keyword">.</span>p3at_loc
  <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> p3t0<span class="keyword">.</span>p3at_typ<span class="keyword">)</span>
<span class="comment">(*
  val () = begin
    print "p3at_tr: p3t0 = "; print_p3at p3t0; print_newline ()
    print "p3at_tr: p3t0.p3at_typ = "; print_s2exp p3t0.p3at_typ; print_newline ();
    print "p3at_tr: hit0 = "; print_hityp hit0; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> p3t0<span class="keyword">.</span>p3at_node <span class="keyword">of</span>
  <span class="keyword">|</span> P3Tann <span class="keyword">(</span>p3t<span class="keyword">,</span> s2e_ann<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hip <span class="keyword">=</span> p3at_tr p3t
      <span class="keyword">val</span> hit_ann <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_ann<span class="keyword">)</span>
    <span class="keyword">in</span>
      hipat_ann <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hip<span class="keyword">,</span> hit_ann<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [P3Tann]
</span>  <span class="keyword">|</span> P3Tany _ <span class="keyword">=&gt;</span> hipat_any <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
  <span class="keyword">|</span> P3Tas <span class="keyword">(</span>refknd<span class="keyword">,</span> d2v<span class="keyword">,</span> p3t<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_count_inc <span class="keyword">(</span>d2v<span class="keyword">)</span>
    <span class="keyword">in</span>  
      hipat_as <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> refknd<span class="keyword">,</span> d2v<span class="keyword">,</span> p3at_tr p3t<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [P3Tas]
</span>  <span class="keyword">|</span> P3Tbool b <span class="keyword">=&gt;</span> hipat_bool <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> b<span class="keyword">)</span>
  <span class="keyword">|</span> P3Tchar c <span class="keyword">=&gt;</span> hipat_char <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> c<span class="keyword">)</span>
  <span class="keyword">|</span> P3Tcon <span class="keyword">(</span>freeknd<span class="keyword">,</span> d2c<span class="keyword">,</span> npf<span class="keyword">,</span> p3ts_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hips_arg <span class="keyword">=</span> p3atlst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> p3ts_arg<span class="keyword">)</span>
      <span class="keyword">val</span> freeknd <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> p3ts_arg <span class="keyword">of</span>
        <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> freeknd <span class="keyword">|</span> list_nil _ <span class="keyword">=&gt;</span> 1 <span class="comment">(*nonfreeable*)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">int</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> hipatlst_is_unused hips_arg <span class="keyword">=&gt;</span>
          hipat_con_any <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> freeknd<span class="keyword">,</span> d2c<span class="keyword">)</span>
        <span class="comment">// end of [_ when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hipatlst_typ_get <span class="keyword">(</span>hips_arg<span class="keyword">)</span>
<span class="comment">(*
          val () = () where {
            val () = print "p3at_tr: P3Tcon: hits_arg = "
            val () = print_hityplst (hits_arg)
            val () = print_newline ()
          } // end of [val]
*)</span>
          <span class="keyword">val</span> hit_sum <span class="keyword">=</span> hityp_tysumtemp <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
<span class="comment">(*
          val () = () where {
            val () = print "p3at_tr: P3Tcon: hit_sum = "
            val () = print_hityp (hit_sum)
            val () = print_newline ()
          } // end of [val]
*)</span>
        <span class="keyword">in</span>
          hipat_con <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> freeknd<span class="keyword">,</span> d2c<span class="keyword">,</span> hips_arg<span class="keyword">,</span> hit_sum<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [P3Tcon]
</span>  <span class="keyword">|</span> P3Tempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hipat_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
  <span class="keyword">|</span> P3Texist <span class="keyword">(</span>_<span class="comment">(*s2vs*)</span><span class="keyword">,</span> p3t<span class="keyword">)</span> <span class="keyword">=&gt;</span> p3at_tr p3t
  <span class="keyword">|</span> P3Tint <span class="keyword">(</span>str<span class="keyword">,</span> int<span class="keyword">)</span> <span class="keyword">=&gt;</span> hipat_int <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">,</span> int<span class="keyword">)</span>
  <span class="keyword">|</span> P3Tlst <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> p3ts_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
      <span class="keyword">val</span> hips_elt <span class="keyword">=</span> p3atlst_tr p3ts_elt
    <span class="keyword">in</span>
      hipat_lst <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hit_elt<span class="keyword">,</span> hips_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [P3Tlst]
</span>  <span class="keyword">|</span> P3Trec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> lp3ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_rec <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> p3t0<span class="keyword">.</span>p3at_typ<span class="keyword">)</span>
      <span class="keyword">val</span> lhips <span class="keyword">=</span> labp3atlst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> lp3ts<span class="keyword">)</span>
    <span class="keyword">in</span>
      hipat_rec <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> lhips<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [P3Trec]
</span>  <span class="keyword">|</span> P3Tstring str <span class="keyword">=&gt;</span> hipat_string <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">)</span>
  <span class="keyword">|</span> P3Tvar <span class="keyword">(</span>refknd<span class="keyword">,</span> d2v<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      hipat_var <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> refknd<span class="keyword">,</span> d2v<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [P3Tvar]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      prerr ": p3at_tr: p3t0 = "<span class="keyword">;</span> prerr_p3at p3t0<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hipat<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">// end of [p3at_tr]
</span>
<span class="keyword">implement</span>
p3atlst_tr <span class="keyword">(</span>p3ts<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>p3ts<span class="keyword">,</span> p3at_tr<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> hiexplst_typ_get <span class="keyword">(</span>hies<span class="keyword">:</span> <span class="staexp">hiexplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hityplst</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">,</span> hityp<span class="keyword">}</span></span> <span class="keyword">(</span>hies<span class="keyword">,</span> <span class="keyword">lam</span> hie <span class="keyword">=&lt;&gt;</span> hie<span class="keyword">.</span>hiexp_typ<span class="keyword">)</span>
<span class="comment">// end of [hiexplst_typ_get]
</span>
<span class="keyword">fn</span> d3exp_is_proof <span class="keyword">(</span>d3e<span class="keyword">:</span> <span class="staexp">d3exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> s2exp_is_proof <span class="keyword">(</span>d3e<span class="keyword">.</span>d3exp_typ<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span> <span class="staexp"><a name="20144"><span class="stacstdec">hiexplst_vt <span class="keyword">=</span> List_vt hiexp</span></a></span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="20184"><span class="dyncstdec">d3explst_funarg_tr
  <span class="keyword">(</span>isvararg<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> arg<span class="keyword">:</span> <span class="staexp">d3explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hiexplst</span></span></a>
<span class="comment">// end of [d3explst_funarg_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d3explst_funarg_tr
  <span class="keyword">(</span>isvararg<span class="keyword">,</span> npf<span class="keyword">,</span> d3es<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fun</span> aux0 <span class="keyword">(</span>
      hies<span class="keyword">:</span> <span class="staexp">hiexplst_vt</span>
    <span class="keyword">,</span> ld3es<span class="keyword">:</span> <span class="staexp">labd3explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexplst</span> <span class="keyword">=</span> <span class="keyword">case+</span> ld3es <span class="keyword">of</span>
    <span class="keyword">|</span> LABD3EXPLSTcons <span class="keyword">(</span>_<span class="comment">(*lab*)</span><span class="keyword">,</span> d3e<span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e<span class="keyword">;</span> <span class="keyword">val</span> hies <span class="keyword">=</span> list_vt_cons <span class="keyword">(</span>hie<span class="keyword">,</span> hies<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux0 <span class="keyword">(</span>hies<span class="keyword">,</span> ld3es<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [LABD3EXPLSTcons]
</span>    <span class="keyword">|</span> LABD3EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> $Lst<span class="keyword">.</span>list_vt_reverse_list <span class="keyword">(</span>hies<span class="keyword">)</span>
  <span class="comment">// end of [aux0]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> aux1 <span class="keyword">(</span>
      hies<span class="keyword">:</span> <span class="staexp">hiexplst_vt</span>
    <span class="keyword">,</span> d3e<span class="keyword">:</span> <span class="staexp">d3exp</span>
    <span class="keyword">,</span> d3es<span class="keyword">:</span> <span class="staexp">d3explst</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">hiexplst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> d3es <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>d3e1<span class="keyword">,</span> d3es1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e<span class="keyword">;</span> <span class="keyword">val</span> hies <span class="keyword">=</span> list_vt_cons <span class="keyword">(</span>hie<span class="keyword">,</span> hies<span class="keyword">)</span>
      <span class="keyword">in</span>
        aux1 <span class="keyword">(</span>hies<span class="keyword">,</span> d3e1<span class="keyword">,</span> d3es1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> d3e <span class="keyword">=</span> loop <span class="keyword">(</span>d3e<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">fun</span> loop <span class="comment">// for a case like ,(`(@(1,2,3)))
</span>            <span class="keyword">(</span>d3e<span class="keyword">:</span> <span class="staexp">d3exp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">d3exp</span> <span class="keyword">=</span> <span class="keyword">case+</span> d3e<span class="keyword">.</span>d3exp_node <span class="keyword">of</span>
            <span class="keyword">|</span> D3Eseq <span class="keyword">(</span>list_cons <span class="keyword">(</span>d3e<span class="keyword">,</span> list_nil<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>d3e<span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> d3e
          <span class="comment">// end of [loop]  
</span>        <span class="keyword">}</span> <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>  
<span class="comment">//
</span>        <span class="keyword">if</span> isvararg <span class="keyword">then</span> <span class="keyword">(</span>
          <span class="keyword">case+</span> d3e<span class="keyword">.</span>d3exp_node <span class="keyword">of</span>
          <span class="keyword">|</span> D3Erec <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux0 <span class="keyword">(</span>hies<span class="keyword">,</span> ld3es<span class="keyword">)</span>
          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_vt_free__boxed <span class="keyword">(</span>hies<span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error4 <span class="keyword">(</span>d3e<span class="keyword">.</span>d3exp_loc<span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> $Deb<span class="keyword">.</span>debug_prerrf <span class="keyword">(</span>": [%s]: d3explst_funarg_tr"<span class="keyword">,</span> <span class="keyword">@(</span>THISFILENAME<span class="keyword">)</span><span class="keyword">)</span>
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the expression is expected to be a record of the form @(...) but it is not."
              <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">in</span>
               $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexplst<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
        <span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e<span class="keyword">;</span> <span class="keyword">val</span> hies <span class="keyword">=</span> list_vt_cons <span class="keyword">(</span>hie<span class="keyword">,</span> hies<span class="keyword">)</span>
        <span class="keyword">in</span>
          $Lst<span class="keyword">.</span>list_vt_reverse_list <span class="keyword">(</span>hies<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span><span class="comment">//
</span>      <span class="keyword">end</span> <span class="comment">(* end of [list_nil] *)</span>
  <span class="comment">// end of [aux1]
</span><span class="comment">//
</span>  <span class="keyword">fun</span> aux2 <span class="keyword">(</span>
      i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> d3es<span class="keyword">:</span> <span class="staexp">d3explst</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">hiexplst</span> <span class="keyword">=</span> <span class="comment">// HX: skipping proof args
</span>    <span class="keyword">case+</span> d3es <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>d3e<span class="keyword">,</span> d3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr <span class="keyword">(</span>d3e<span class="keyword">)</span> <span class="keyword">in</span> aux2 <span class="keyword">(</span>i-1<span class="keyword">,</span> d3es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span>
          aux1 <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> d3e<span class="keyword">,</span> d3es<span class="keyword">)</span> <span class="comment">// HX: no more proof args
</span>        <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [nil]
</span>  <span class="comment">// end of [aux2]
</span><span class="comment">//
</span><span class="keyword">in</span>
  aux2 <span class="keyword">(</span>npf<span class="keyword">,</span> d3es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3explst_funarg_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d3explst_arg_tr <span class="keyword">(</span>
  npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> d3es<span class="keyword">:</span> <span class="staexp">d3explst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
      i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> d3es<span class="keyword">:</span> <span class="staexp">d3explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexplst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> d3es <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>d3e<span class="keyword">,</span> d3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> i <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e <span class="keyword">in</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> d3es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [i &gt; 0]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d3exp_is_proof d3e <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e <span class="keyword">in</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> d3es<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            cons <span class="keyword">(</span>d3exp_tr d3e<span class="keyword">,</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> d3es<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>npf<span class="keyword">,</span> d3es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3explst_arg_tr]
</span>
<span class="keyword">fn</span> labd3explst_arg_tr <span class="keyword">(</span>
    npf<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ld3es<span class="keyword">:</span> <span class="staexp">labd3explst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhiexplst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>
      i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> ld3es<span class="keyword">:</span> <span class="staexp">labd3explst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">labhiexplst</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> ld3es <span class="keyword">of</span>
    <span class="keyword">|</span> LABD3EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> d3e<span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> i <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e <span class="keyword">in</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> ld3es<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [i &gt; 0]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> d3exp_is_proof d3e <span class="keyword">then</span> <span class="keyword">let</span>
             <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e <span class="keyword">in</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> ld3es<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
            LABHIEXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> d3exp_tr d3e<span class="keyword">,</span> aux <span class="keyword">(</span>i-1<span class="keyword">,</span> ld3es<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
        <span class="keyword">end</span>
      <span class="keyword">end</span> <span class="comment">// end of [LABHIEXPLSTcons]
</span>    <span class="keyword">|</span> LABD3EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> LABHIEXPLSTnil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  aux <span class="keyword">(</span>npf<span class="keyword">,</span> ld3es<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [labd3explst_arg_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d3exp_cst_tr <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> hit0<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> sym <span class="keyword">=</span> d2cst_sym_get d2c <span class="keyword">in</span>
  <span class="keyword">case+</span> sym <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_TRUE <span class="keyword">=&gt;</span> hiexp_bool <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> true<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_FALSE <span class="keyword">=&gt;</span> hiexp_bool <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> false<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hiexp_cst <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2c<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3exp_cst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d3exp_seq_tr <span class="keyword">(</span>
  loc0<span class="keyword">:</span> <span class="staexp">loc_t</span><span class="keyword">,</span> hit0<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> d3es<span class="keyword">:</span> <span class="staexp">d3explst</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hies <span class="keyword">=</span> d3explst_tr d3es <span class="keyword">in</span> hiexp_seq_simplify <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hies<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3exp_seq_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d3exp_tmpcst_tr <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> hit0<span class="keyword">:</span> <span class="staexp">hityp</span><span class="keyword">,</span> d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span><span class="keyword">,</span> s2ess<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> sym <span class="keyword">=</span> d2cst_sym_get d2c <span class="keyword">in</span> <span class="keyword">case+</span> sym <span class="keyword">of</span>
  <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> $Sym<span class="keyword">.</span>symbol_SIZEOF <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> s2ess <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>cons <span class="keyword">(</span>s2e<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        hiexp_sizeof <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        prerr ": d3exp_tmpcst_tr: sizeof"<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hitss <span class="keyword">=</span> s2explstlst_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ess<span class="keyword">)</span>
<span class="comment">(*
      val () = begin
        print "d3exp_tmpcst_tr: hitss = "; print hitss; print_newline ()
      end // end of [val]
*)</span>
    <span class="keyword">in</span>
      hiexp_tmpcst <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2c<span class="keyword">,</span> hitss<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [d3exp_tmpcst_tr] *)</span>

<span class="keyword">fn</span> d3exp_tmpvar_tr <span class="keyword">(</span>
    loc0<span class="keyword">:</span> <span class="staexp">loc_t</span>
  <span class="keyword">,</span> hit0<span class="keyword">:</span> <span class="staexp">hityp</span>
  <span class="keyword">,</span> d2v<span class="keyword">:</span> <span class="staexp">d2var_t</span><span class="keyword">,</span> s2ess<span class="keyword">:</span> <span class="staexp">s2explstlst</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hitss <span class="keyword">=</span> s2explstlst_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> s2ess<span class="keyword">)</span>
<span class="keyword">in</span>
  hiexp_tmpvar <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2v<span class="keyword">,</span> hitss<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3exp_tmpvar_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> d3lab1_tr
  <span class="keyword">(</span>d3l<span class="keyword">:</span> <span class="staexp">d3lab1</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hilab</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> d3l<span class="keyword">.</span>d3lab1_loc
<span class="keyword">in</span>
  <span class="keyword">case+</span> d3l<span class="keyword">.</span>d3lab1_node <span class="keyword">of</span>
  <span class="keyword">|</span> D3LAB1lab <span class="keyword">(</span>l<span class="keyword">,</span> s2e_rec<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_rec <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_rec<span class="keyword">)</span>
    <span class="keyword">in</span>
      hilab_lab <span class="keyword">(</span>loc0<span class="keyword">,</span> l<span class="keyword">,</span> hit_rec<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3LAB1lab]
</span>  <span class="keyword">|</span> D3LAB1ind <span class="keyword">(</span>d3ess<span class="keyword">,</span> s2e_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hiess <span class="keyword">=</span> <span class="keyword">(</span>
        $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>d3ess<span class="keyword">,</span> d3explst_tr<span class="keyword">)</span>
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexplstlst</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
    <span class="keyword">in</span>
      hilab_ind <span class="keyword">(</span>loc0<span class="keyword">,</span> hiess<span class="keyword">,</span> hit_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3LAB1ind]
</span><span class="keyword">end</span> <span class="comment">// end of [d3lab1_tr]
</span>
<span class="keyword">fn</span> d3lab1lst_tr
  <span class="keyword">(</span>d3ls<span class="keyword">:</span> <span class="staexp">d3lab1lst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hilablst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>d3ls<span class="keyword">,</span> d3lab1_tr<span class="keyword">)</span>
<span class="comment">// end of [d3lab1lst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> m3atch_tr
  <span class="keyword">(</span>m3at<span class="keyword">:</span> <span class="staexp">m3atch</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">himat</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr m3at<span class="keyword">.</span>m3atch_exp
  <span class="keyword">val</span> ohip <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> m3at<span class="keyword">.</span>m3atch_pat <span class="keyword">of</span>
    <span class="keyword">|</span> Some p3t <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>p3at_tr p3t<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hipatopt</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  himat_make <span class="keyword">(</span>m3at<span class="keyword">.</span>m3atch_loc<span class="keyword">,</span> hie<span class="keyword">,</span> ohip<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [m3atch_tr]
</span>
<span class="keyword">fn</span> m3atchlst_tr
  <span class="keyword">(</span>m3ats<span class="keyword">:</span> <span class="staexp">m3atchlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">himatlst</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>m3ats<span class="keyword">,</span> m3atch_tr<span class="keyword">)</span>
<span class="comment">// end of [m3atchlst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> c3lau_tr
  <span class="keyword">(</span>c3l<span class="keyword">:</span> <span class="staexp">c3lau</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hiclau</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "cla3_tr: c3l = "; print c3l; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> c3l<span class="keyword">.</span>c3lau_loc
  <span class="keyword">val</span> hips <span class="keyword">=</span> p3atlst_tr c3l<span class="keyword">.</span>c3lau_pat
<span class="comment">(*
  val () = begin
    print "cla3_tr: hips = "; print hips; print_newline ()
  end // end of [val]
*)</span>
  <span class="keyword">val</span> gua <span class="keyword">=</span> m3atchlst_tr c3l<span class="keyword">.</span>c3lau_gua
  <span class="keyword">val</span> body <span class="keyword">=</span> d3exp_tr c3l<span class="keyword">.</span>c3lau_exp
<span class="keyword">in</span>
  hiclau_make <span class="keyword">(</span>loc0<span class="keyword">,</span> hips<span class="keyword">,</span> gua<span class="keyword">,</span> body<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [c3lau_tr]
</span>
<span class="keyword">fn</span> c3laulst_tr
  <span class="keyword">(</span>c3ls<span class="keyword">:</span> <span class="staexp">c3laulst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hiclaulst</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fun</span> aux <span class="keyword">(</span> <span class="comment">// tail-recursive function
</span>      c3ls<span class="keyword">:</span> <span class="staexp">c3laulst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>hiclaulst? &gt;&gt; hiclaulst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> c3ls <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons
      <span class="keyword">(</span>c3l<span class="keyword">,</span> c3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
      <span class="keyword">|</span> _ <span class="keyword">when</span> c3l<span class="keyword">.</span>c3lau_neg <span class="keyword">&gt;</span> 0 <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>c3ls<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hicl <span class="keyword">=</span> c3lau_tr c3l
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := cons <span class="staexp"><span class="keyword">{</span>hiclau<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>hicl<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
          <span class="keyword">val+</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span> <span class="keyword">=</span> res
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>c3ls<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span>
        <span class="keyword">in</span>
          fold@ <span class="keyword">(</span>res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [_] *)</span>
      <span class="keyword">)</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_nil<span class="keyword">)</span>
  <span class="comment">(* end of [aux] *)</span>
<span class="comment">//
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">c3laulst</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>c3ls<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [c3laulst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">absview</span> <span class="staexp"><a name="28071"><span class="stacstdec">dyncstsetlst_push_token</span></a></span>

<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="28107"><span class="dyncstdec">the_dyncstset_get
  <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">dyncstset_t</span></span></a> <span class="keyword">=</span> "ats_ccomp_env_the_dyncstset_get"
<span class="comment">// end of [extern]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="28210"><span class="dyncstdec">the_dyncstsetlst_push
  <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>dyncstsetlst_push_token <span class="keyword">|</span> void<span class="keyword">)</span></span></span></a>
  <span class="keyword">=</span> "ats_ccomp_env_the_dyncstsetlst_push"
<span class="comment">// end of [extern]
</span>
<span class="keyword">extern</span>
<span class="keyword">fun</span> <a name="28344"><span class="dyncstdec">the_dyncstsetlst_pop <span class="keyword">(</span>
  <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp">dyncstsetlst_push_token</span></span> <span class="keyword">|</span> <span class="comment">(*none*)</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">dyncstset_t</span></span></a> <span class="keyword">=</span> "ats_ccomp_env_the_dyncstsetlst_pop"
<span class="comment">// end of [extern]
</span>
<span class="keyword">extern</span> <span class="comment">// HX: implemented in [ats_ccomp_env.dats]
</span><span class="keyword">fun</span> <a name="28537"><span class="dyncstdec">the_dyncstset_add_if
  <span class="keyword">(</span>d2c<span class="keyword">:</span> <span class="staexp">d2cst_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a> <span class="keyword">=</span> "ats_ccomp_env_the_dyncstset_add_if"
<span class="comment">// end of [extern]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d3exp_tr <span class="keyword">(</span>d3e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> d3e0<span class="keyword">.</span>d3exp_loc <span class="keyword">and</span> s2e0 <span class="keyword">=</span> d3e0<span class="keyword">.</span>d3exp_typ
<span class="comment">(*
  val () = begin
    print "d3exp_tr: s2e0 = "; print_s2exp s2e0; print_newline ();
    print "d3exp_tr: d3e0 = "; print_d3exp d3e0; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> d3e0<span class="keyword">.</span>d3exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> D3Eann_type <span class="keyword">(</span>d3e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_tr d3e
  <span class="keyword">|</span> D3Eapp_dyn <span class="keyword">(</span>d3e_fun<span class="keyword">,</span> npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_fun <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> d3e_fun<span class="keyword">.</span>d3exp_typ<span class="keyword">)</span>
      <span class="keyword">val</span> hie_fun <span class="keyword">=</span> d3exp_tr d3e_fun
      <span class="keyword">val</span> isvararg <span class="keyword">=</span> hityp_fun_is_vararg hit_fun
      <span class="keyword">val</span> hies_arg <span class="keyword">=</span> d3explst_funarg_tr <span class="keyword">(</span>isvararg<span class="keyword">,</span> npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> hie_fun<span class="keyword">.</span>hiexp_node <span class="keyword">of</span>
      <span class="keyword">|</span> HIEcst d2c <span class="keyword">when</span> d2cst_is_castfn d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
          val () = begin
            print "d3exp_tr: D3Eapp_dyn: castfn: d2c = "; print_d2cst d2c; print_newline ()
          end // end of [val]
*)</span>
          <span class="keyword">val</span> hie <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> hies_arg <span class="keyword">of</span>
            <span class="keyword">|</span> list_cons <span class="keyword">(</span>hie<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> hie <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                prerr_loc_interror <span class="keyword">(</span>loc0<span class="keyword">)</span><span class="keyword">;</span>
                prerr ": d3exp_tr: a casting function must be applied to exactly one argument."<span class="keyword">;</span>
                prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>          <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexp</span> <span class="comment">// end of [val]
</span>        <span class="keyword">in</span>
          hiexp_castfn <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2c<span class="keyword">,</span> hie<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [HIEcst when ...]
</span>      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> hiexp_app <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hit_fun<span class="keyword">,</span> hie_fun<span class="keyword">,</span> hies_arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eapp_dyn]
</span>  <span class="keyword">|</span> D3Eapp_sta d3e <span class="keyword">=&gt;</span> d3exp_tr d3e
  <span class="keyword">|</span> D3Earrinit <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> od3e_asz<span class="keyword">,</span> d3es_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
      <span class="keyword">val</span> ohie_asz <span class="keyword">=</span> d3expopt_tr od3e_asz
      <span class="keyword">val</span> hies_elt <span class="keyword">=</span> d3explst_tr d3es_elt
    <span class="keyword">in</span>
      hiexp_arrinit <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hit_elt<span class="keyword">,</span> ohie_asz<span class="keyword">,</span> hies_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Earrinit]
</span>  <span class="keyword">|</span> D3Earrsize <span class="keyword">(</span>s2e_elt<span class="keyword">,</span> d3es_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
      <span class="keyword">val</span> hies_elt <span class="keyword">=</span> d3explst_tr d3es_elt
    <span class="keyword">in</span>
      hiexp_arrsize <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hit_elt<span class="keyword">,</span> hies_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Earrsize]
</span>  <span class="keyword">|</span> D3Eassgn_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> d3exp_is_proof d3e_val <span class="keyword">then</span> <span class="keyword">begin</span>
        hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> hie_ptr <span class="keyword">=</span> d3exp_tr d3e_ptr
        <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr <span class="keyword">(</span>d3ls<span class="keyword">)</span>
        <span class="keyword">val</span> hie_val <span class="keyword">=</span> d3exp_tr d3e_val
      <span class="keyword">in</span>
        hiexp_assgn_ptr <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">,</span> hie_ptr<span class="keyword">,</span> hils<span class="keyword">,</span> hie_val<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [D3Eassgn_ptr] *)</span>
  <span class="keyword">|</span> D3Eassgn_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> d3exp_is_proof d3e_val <span class="keyword">then</span>
        hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">)</span>
      <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_count_inc d2v_ptr
        <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr <span class="keyword">(</span>d3ls<span class="keyword">)</span>
        <span class="keyword">val</span> hie_val <span class="keyword">=</span> d3exp_tr d3e_val
      <span class="keyword">in</span>
        hiexp_assgn_var <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">,</span> d2v_ptr<span class="keyword">,</span> hils<span class="keyword">,</span> hie_val<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [D3Eassgn_var] *)</span>
  <span class="keyword">|</span> D3Ebool b <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_bool <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> b<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Echar]
</span>  <span class="keyword">|</span> D3Ecaseof <span class="keyword">(</span>knd<span class="keyword">,</span> d3es<span class="keyword">,</span> c3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hies <span class="keyword">=</span> d3explst_tr d3es
<span class="comment">(*
      val () = begin
        print "d3exp_tr: D3Ecaseof: c3ls = "; print c3ls; print_newline ()
      end // end of [val]
*)</span>
      <span class="keyword">val</span> hicls <span class="keyword">=</span> c3laulst_tr c3ls
    <span class="keyword">in</span>
      hiexp_caseof_if <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> hies<span class="keyword">,</span> hicls<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Ecase]
</span>  <span class="keyword">|</span> D3Echar c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_char <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> c<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Echar]
</span>  <span class="keyword">|</span> D3Econ <span class="keyword">(</span>d2c<span class="keyword">,</span> npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
<span class="comment">(*
      val () = begin
        print "d3exp_tr: d2c = "; print d2c; print_newline ();
        print "d3exp_tr: npf = "; print npf; print_newline ();
        print "d3exp_tr: d3es_arg = "; print d3es_arg; print_newline ()
      end // end of [val]
*)</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hies_arg <span class="keyword">=</span> d3explst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span>
<span class="comment">(*
      val () = begin
        print "d3exp_tr: hies_arg = "; print hies_arg; print_newline ()
      end // end of [val]
*)</span>
      <span class="keyword">val</span> hits_arg <span class="keyword">=</span> hiexplst_typ_get hies_arg
      <span class="keyword">val</span> hit_sum <span class="keyword">=</span> hityp_tysumtemp <span class="keyword">(</span>d2c<span class="keyword">,</span> hits_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_con <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hit_sum<span class="keyword">,</span> d2c<span class="keyword">,</span> hies_arg<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Econ]
</span>  <span class="keyword">|</span> D3Ecst d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">(* d2c is external *)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_dyncstset_add_if <span class="keyword">(</span>d2c<span class="keyword">)</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      d3exp_cst_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2c<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Ecst]
</span>  <span class="keyword">|</span> D3Ecstsp cst <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_cstsp <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> cst<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Ecstsp]
</span>  <span class="keyword">|</span> D3Ecrypt <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_tr d3e
  <span class="keyword">|</span> D3Edynload fil <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_dynload <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> fil<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Edynload]
</span>  <span class="keyword">|</span> D3Eeffmask <span class="keyword">(</span>_<span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_tr d3e
  <span class="keyword">|</span> D3Eempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eempty]
</span>  <span class="keyword">|</span> D3Eextval code <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_extval <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> code<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eextval]
</span>  <span class="keyword">|</span> D3Efix <span class="keyword">(</span>
      knd<span class="keyword">,</span> d2v_fun<span class="keyword">,</span> d3e_def
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie_def <span class="keyword">=</span> d3exp_tr d3e_def
      <span class="keyword">val</span> isval <span class="keyword">=</span> hiexp_is_value <span class="keyword">(</span>hie_def<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// check for valueness of the def
</span>        <span class="keyword">if</span> isval <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          prerr_loc_error4 loc0<span class="keyword">;</span>
          prerr ": a non-value fixed-point dynamic expression is not supported."<span class="keyword">;</span>
          prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
      <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      hiexp_fix <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> d2v_fun<span class="keyword">,</span> hie_def<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Efix]
</span>  <span class="keyword">|</span> D3Efloat str <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_float <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Efloat]
</span>  <span class="keyword">|</span> D3Efloatsp str <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_floatsp <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Efloatsp]
</span>  <span class="keyword">|</span> D3Efoldat _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Efoldat]
</span>  <span class="keyword">|</span> D3Efreeat d3e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_freeat <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d3exp_tr d3e<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Efreeat]
</span>  <span class="keyword">|</span> D3Eif <span class="keyword">(</span>
      d3e_cond<span class="keyword">,</span> d3e_then<span class="keyword">,</span> d3e_else
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie_cond <span class="keyword">=</span> d3exp_tr d3e_cond
      <span class="keyword">val</span> hie_then <span class="keyword">=</span> d3exp_tr d3e_then
      <span class="keyword">val</span> hie_else <span class="keyword">=</span> d3exp_tr d3e_else
    <span class="keyword">in</span>
      hiexp_if <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie_cond<span class="keyword">,</span> hie_then<span class="keyword">,</span> hie_else<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eif]
</span>  <span class="keyword">|</span> D3Eint <span class="keyword">(</span>str<span class="keyword">,</span> int<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_int <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">,</span> int<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eint]
</span>  <span class="keyword">|</span> D3Eintsp <span class="keyword">(</span>str<span class="keyword">,</span> int<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_intsp <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">,</span> int<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eintsp]
</span>  <span class="keyword">|</span> D3Elam_dyn <span class="keyword">(</span>
      lin<span class="keyword">,</span> npf<span class="keyword">,</span> p3ts_arg<span class="keyword">,</span> d3e_body
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_fun <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hips_arg <span class="keyword">=</span> p3atlst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> p3ts_arg<span class="keyword">)</span>
      <span class="keyword">val</span> hie_body <span class="keyword">=</span> d3exp_tr d3e_body
    <span class="keyword">in</span>
      hiexp_lam <span class="keyword">(</span>loc0<span class="keyword">,</span> hit_fun<span class="keyword">,</span> hips_arg<span class="keyword">,</span> hie_body<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elam_dyn]
</span>  <span class="keyword">|</span> D3Elaminit_dyn <span class="keyword">(</span>
      lin<span class="keyword">,</span> npf<span class="keyword">,</span> p3ts_arg<span class="keyword">,</span> d3e_body
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_fun <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hips_arg <span class="keyword">=</span> p3atlst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> p3ts_arg<span class="keyword">)</span>
      <span class="keyword">val</span> hie_body <span class="keyword">=</span> d3exp_tr d3e_body
    <span class="keyword">in</span>
      hiexp_laminit <span class="keyword">(</span>loc0<span class="keyword">,</span> hit_fun<span class="keyword">,</span> hips_arg<span class="keyword">,</span> hie_body<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elaminit_dyn]
</span>  <span class="keyword">|</span> D3Elam_sta <span class="keyword">(</span>
      _<span class="comment">(*s2vs*)</span><span class="keyword">,</span> _<span class="comment">(*s2ps*)</span><span class="keyword">,</span> d3e_body
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> hie_body <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> hie_body <span class="keyword">=</span> d3exp_tr d3e_body
      <span class="keyword">val</span> isval <span class="keyword">=</span> hiexp_is_value <span class="keyword">(</span>hie_body<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isval <span class="keyword">then</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span> <span class="comment">// check for valueness
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error4 <span class="keyword">(</span>loc0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": a non-value body for static lambda-abstraction is not supported."
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
    <span class="keyword">}</span> <span class="comment">// end of [D3Elam_sta]
</span>  <span class="keyword">|</span> D3Elam_met <span class="keyword">(</span>_<span class="comment">(*s2es_met*)</span><span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_tr d3e
  <span class="keyword">|</span> D3Elazy_delay <span class="keyword">(</span>d3e_eval<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_lazy_delay <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d3exp_tr d3e_eval<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elazy_delay]
</span>  <span class="keyword">|</span> D3Elazy_vt_delay <span class="keyword">(</span>d3e_eval<span class="keyword">,</span> d3e_free<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie_eval <span class="keyword">=</span> d3exp_tr d3e_eval <span class="keyword">and</span> hie_free <span class="keyword">=</span> d3exp_tr d3e_free
    <span class="keyword">in</span>
      hiexp_lazy_vt_delay <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie_eval<span class="keyword">,</span> hie_free<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elazy_delay]
</span>  <span class="keyword">|</span> D3Elazy_force <span class="keyword">(</span>lin<span class="keyword">,</span> d3e_lazy<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_lazy_force <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> lin<span class="keyword">,</span> d3exp_tr d3e_lazy<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elazy_force]
</span>  <span class="keyword">|</span> D3Elet <span class="keyword">(</span>d3cs<span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hids <span class="keyword">=</span> d3eclst_tr d3cs<span class="keyword">;</span> <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e
    <span class="keyword">in</span>
      hiexp_let_simplify <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hids<span class="keyword">,</span> hie<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elet]
</span>  <span class="keyword">|</span> D3Eloop <span class="keyword">(</span>init<span class="keyword">,</span> test<span class="keyword">,</span> post<span class="keyword">,</span> body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> init <span class="keyword">=</span> d3expopt_tr init
      <span class="keyword">val</span> test <span class="keyword">=</span> d3exp_tr test
      <span class="keyword">val</span> post <span class="keyword">=</span> d3expopt_tr post
      <span class="keyword">val</span> body <span class="keyword">=</span> d3exp_tr body
    <span class="keyword">in</span>
      hiexp_loop <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">,</span> init<span class="keyword">,</span> test<span class="keyword">,</span> post<span class="keyword">,</span> body<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eloop]
</span>  <span class="keyword">|</span> D3Eloopexn i <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_loopexn <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eloopexn]
</span>  <span class="keyword">|</span> D3Elst <span class="keyword">(</span>lin<span class="keyword">,</span> s2e_elt<span class="keyword">,</span> d3es_elt<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_elt <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_elt<span class="keyword">)</span>
      <span class="keyword">val</span> hies_elt <span class="keyword">=</span> d3explst_tr d3es_elt
    <span class="keyword">in</span>
      hiexp_lst <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> lin<span class="keyword">,</span> hit_elt<span class="keyword">,</span> hies_elt<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Elst]
</span>  <span class="keyword">|</span> D3Eptrof_ptr <span class="keyword">(</span>d3e<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e<span class="keyword">;</span> <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr d3ls
    <span class="keyword">in</span>
      hiexp_ptrof_ptr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie<span class="keyword">,</span> hils<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eptrof_ptr]
</span>  <span class="keyword">|</span> D3Eptrof_var <span class="keyword">(</span>d2v<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_count_inc d2v<span class="keyword">;</span> <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr d3ls
    <span class="keyword">in</span>
      hiexp_ptrof_var <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2v<span class="keyword">,</span> hils<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eptrof_var]
</span>  <span class="keyword">|</span> D3Eraise d3e_exn <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_raise <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d3exp_tr d3e_exn<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eraise]
</span>  <span class="keyword">|</span> D3Erec <span class="keyword">(</span>knd<span class="keyword">,</span> npf<span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_rec <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> lhies <span class="keyword">=</span> labd3explst_arg_tr <span class="keyword">(</span>npf<span class="keyword">,</span> ld3es<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_rec <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> knd<span class="keyword">,</span> hit_rec<span class="keyword">,</span> lhies<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Erec]
</span>  <span class="keyword">|</span> D3Erefarg <span class="keyword">(</span>refval<span class="keyword">,</span> freeknd<span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e
    <span class="keyword">in</span>
      hiexp_refarg <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> refval<span class="keyword">,</span> freeknd<span class="keyword">,</span> hie<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Erefarg]
</span>  <span class="keyword">|</span> D3Escaseof _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": the static caseof-expression should have already been erased."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Escaseof]
</span>  <span class="keyword">|</span> D3Esel <span class="keyword">(</span>d3e<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e
      <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr d3ls
    <span class="keyword">in</span>
      hiexp_sel <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie<span class="keyword">,</span> hils<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esel]
</span>  <span class="keyword">|</span> D3Esel_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie_ptr <span class="keyword">=</span> d3exp_tr d3e_ptr
      <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr d3ls
    <span class="keyword">in</span>
      hiexp_sel_ptr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie_ptr<span class="keyword">,</span> hils<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esel_ptr]
</span>  <span class="keyword">|</span> D3Esel_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d2var_count_inc d2v_ptr
      <span class="keyword">val</span> hils <span class="keyword">=</span> d3lab1lst_tr d3ls
    <span class="keyword">in</span>
      hiexp_sel_var <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2v_ptr<span class="keyword">,</span> hils<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esel_var]
</span>  <span class="keyword">|</span> D3Eseq d3es <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      d3exp_seq_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d3es<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eseq]
</span>  <span class="keyword">|</span> D3Esif <span class="keyword">(</span>_<span class="comment">(*cond*)</span><span class="keyword">,</span> d3e_then<span class="keyword">,</span> d3e_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hie_then <span class="keyword">=</span> d3exp_tr d3e_then
      <span class="keyword">and</span> hie_else <span class="keyword">=</span> d3exp_tr d3e_else
    <span class="keyword">in</span>
      hiexp_sif <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">,</span> hie_then<span class="keyword">,</span> hie_else<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Esif]
</span>  <span class="keyword">|</span> D3Estring <span class="keyword">(</span>str<span class="keyword">,</span> len<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_string <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> str<span class="keyword">,</span> len<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Estring]
</span>  <span class="keyword">|</span> D3Estruct ld3es <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hit_rec <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> lhies <span class="keyword">=</span> labd3explst_arg_tr <span class="keyword">(</span>0<span class="keyword">,</span> ld3es<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_rec <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> 0<span class="comment">(*@{}*)</span><span class="keyword">,</span> hit_rec<span class="keyword">,</span> lhies<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Estruct]
</span>  <span class="keyword">|</span> D3Etmpcst <span class="keyword">(</span>d2c<span class="keyword">,</span> s2ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_fun <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      d3exp_tmpcst_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit_fun<span class="keyword">,</span> d2c<span class="keyword">,</span> s2ess<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Etmpcst]
</span>  <span class="keyword">|</span> D3Etmpvar <span class="keyword">(</span>d2v<span class="keyword">,</span> s2ess<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit_fun <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      d3exp_tmpvar_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> hit_fun<span class="keyword">,</span> d2v<span class="keyword">,</span> s2ess<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Etmpvar]
</span>  <span class="keyword">|</span> D3Etop <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      hiexp_top <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Etop]
</span>  <span class="keyword">|</span> D3Etrywith <span class="keyword">(</span>d3e<span class="keyword">,</span> c3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e<span class="keyword">;</span> <span class="keyword">val</span> hicls <span class="keyword">=</span> c3laulst_tr c3ls
    <span class="keyword">in</span>
      hiexp_trywith <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hie<span class="keyword">,</span> hicls<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Etrywith]
</span>  <span class="keyword">|</span> D3Evar d2v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>  <span class="keyword">if</span> d2var_isprf_get d2v <span class="keyword">then</span> <span class="keyword">begin</span>
        prerr_loc_error4 loc0<span class="keyword">;</span>
        prerr ": the dynamic variable ["<span class="keyword">;</span> prerr_d2var d2v<span class="keyword">;</span>
        prerr "] refers to a proof and thus should have been erased."<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [val]
</span>      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
    <span class="keyword">in</span>
      d2var_count_inc d2v<span class="keyword">;</span> hiexp_var <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> d2v<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Evar]
</span>  <span class="keyword">|</span> D3Eviewat_assgn_ptr _ <span class="keyword">=&gt;</span> hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">)</span>
  <span class="keyword">|</span> D3Eviewat_assgn_var _ <span class="keyword">=&gt;</span> hiexp_empty <span class="keyword">(</span>loc0<span class="keyword">,</span> hityp_void<span class="keyword">)</span>
  <span class="keyword">|</span> D3Eviewat_ptr _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": this proof expression should have already been erased."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_ptr]
</span>  <span class="keyword">|</span> D3Eviewat_var _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror loc0<span class="keyword">;</span>
      prerr ": this proof expression should have already been erased."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>hiexp<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_var]
</span>  <span class="keyword">|</span> D3Ewhere <span class="keyword">(</span>d3e<span class="keyword">,</span> d3cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> hit0 <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc0<span class="keyword">,</span> 0<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e0<span class="keyword">)</span>
      <span class="keyword">val</span> hids <span class="keyword">=</span> d3eclst_tr d3cs<span class="keyword">;</span> <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e
    <span class="keyword">in</span>
      hiexp_let_simplify <span class="keyword">(</span>loc0<span class="keyword">,</span> hit0<span class="keyword">,</span> hids<span class="keyword">,</span> hie<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Ewhere]
</span><span class="comment">(*
  | _ =&gt; begin
      prerr_loc_interror loc0;
      prerr "d3exp_tr: not yet implemented: d3e0 = "; prerr d3e0; prerr_newline ();
      $Err.abort {hiexp} ()
    end // end of [_]
*)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3exp_tr]
</span>
<span class="keyword">implement</span>
d3explst_tr <span class="keyword">(</span>d3es<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>d3es<span class="keyword">,</span> d3exp_tr<span class="keyword">)</span>

<span class="keyword">implement</span>
d3expopt_tr <span class="keyword">(</span>od3e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> od3e <span class="keyword">of</span>
  <span class="keyword">|</span> Some d3e <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>d3exp_tr d3e<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [d3expopt_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> labd3explst_prf_tr
  <span class="keyword">(</span>ld3es<span class="keyword">:</span> <span class="staexp">labd3explst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> ld3es <span class="keyword">of</span>
  <span class="keyword">|</span> LABD3EXPLSTcons <span class="keyword">(</span>l<span class="keyword">,</span> d3e<span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      d3exp_prf_tr d3e<span class="keyword">;</span> labd3explst_prf_tr ld3es
    <span class="keyword">end</span> <span class="comment">// end of [LABD3EXPLSTcons]
</span>  <span class="keyword">|</span> LABD3EXPLSTnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [labd3explst_prf_tr]
</span>
<span class="keyword">fn</span> c3laulst_prf_tr <span class="keyword">(</span>c3ls<span class="keyword">:</span> <span class="staexp">c3laulst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fn</span> f <span class="keyword">(</span>c3l<span class="keyword">:</span> <span class="staexp">c3lau</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> d3exp_prf_tr <span class="keyword">(</span>c3l<span class="keyword">.</span>c3lau_exp<span class="keyword">)</span>
<span class="keyword">in</span>
  $Lst<span class="keyword">.</span>list_foreach_fun <span class="keyword">(</span>c3ls<span class="keyword">,</span>  f<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [c3laulst_prf_tr]
</span>
<span class="keyword">implement</span>
d3exp_prf_tr <span class="keyword">(</span>d3e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
  val () = begin
    print "d3exp_prf_tr: d3e0 = " print d3e0; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> d3e0<span class="keyword">.</span>d3exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> D3Eann_type <span class="keyword">(</span>d3e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Eapp_dyn <span class="keyword">(</span>d3e_fun<span class="keyword">,</span> npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_fun
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3explst_prf_tr d3es_arg
    <span class="keyword">in</span>
      <span class="comment">(* empty *)</span>
    <span class="keyword">end</span> <span class="comment">// end of [D3Eapp_dyn]
</span>  <span class="keyword">|</span> D3Eapp_sta d3e <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Eassgn_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_ptr
      <span class="comment">// val () = d3lab1lst_prf_tr (d3ls) // is this really needed?
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_val
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eassgn_ptr]
</span>  <span class="keyword">|</span> D3Eassgn_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val hils = d3lab1lst_prf_tr (d3ls) // is this really needed?
</span>      <span class="keyword">val</span> hie_val <span class="keyword">=</span> d3exp_prf_tr d3e_val
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eassgn_var]
</span>  <span class="keyword">|</span> D3Ecaseof <span class="keyword">(</span>knd<span class="keyword">,</span> d3es<span class="keyword">,</span> c3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3explst_prf_tr d3es
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> c3laulst_prf_tr c3ls
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Ecase]
</span>  <span class="keyword">|</span> D3Echar c <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Econ <span class="keyword">(</span>d2c<span class="keyword">,</span> npf<span class="keyword">,</span> d3es_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3explst_prf_tr <span class="keyword">(</span>d3es_arg<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Econ]
</span>  <span class="keyword">|</span> D3Ecst d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="comment">(* d2c is external as it is used *)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_dyncstset_add_if <span class="keyword">(</span>d2c<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Ecst]
</span>  <span class="keyword">|</span> D3Ecrypt <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Eeffmask <span class="keyword">(</span>_<span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Eempty <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Eextval _<span class="comment">(*code*)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Efix <span class="keyword">(</span>knd<span class="keyword">,</span> d2v_fun<span class="keyword">,</span> d3e_def<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr <span class="keyword">(</span>d3e_def<span class="keyword">)</span>
<span class="comment">(*
  | D3Efloat _(*str*) =&gt; ()
  | D3Efloatsp _(*str*) =&gt; ()
*)</span>
  <span class="keyword">|</span> D3Efoldat d3e <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
<span class="comment">(*
  | D3Efreeat _ =&gt; ()
*)</span>
  <span class="keyword">|</span> D3Eif <span class="keyword">(</span>
      d3e_cond<span class="keyword">,</span> d3e_then<span class="keyword">,</span> d3e_else
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_cond
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_then
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_else
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eif]
</span>  <span class="keyword">|</span> D3Eint _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Elam_dyn <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="comment">(*arg*)</span><span class="keyword">,</span> d3e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e_body
  <span class="keyword">|</span> D3Elam_sta <span class="keyword">(</span>_<span class="comment">(*s2vs*)</span><span class="keyword">,</span> _<span class="comment">(*s2ps*)</span><span class="keyword">,</span> d3e_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e_body
  <span class="keyword">|</span> D3Elam_met <span class="keyword">(</span>_<span class="comment">(*s2es_met*)</span><span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Elet <span class="keyword">(</span>d3cs<span class="keyword">,</span> d3e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3eclst_prf_tr d3cs<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Elet]
</span>  <span class="keyword">|</span> D3Elst <span class="keyword">(</span>
      _<span class="comment">(*lin*)</span><span class="keyword">,</span> _<span class="comment">(*s2e*)</span><span class="keyword">,</span> d3es_elt
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3explst_prf_tr d3es_elt
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Elst]
</span>  <span class="keyword">|</span> D3Eptrof_ptr <span class="keyword">(</span>d3e<span class="keyword">,</span> _<span class="comment">(*labs*)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr <span class="keyword">(</span>d3e<span class="keyword">)</span>
  <span class="keyword">|</span> D3Eptrof_var _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Erec <span class="keyword">(</span>_<span class="comment">(*knd*)</span><span class="keyword">,</span> _<span class="comment">(*npf*)</span><span class="keyword">,</span> ld3es<span class="keyword">)</span> <span class="keyword">=&gt;</span> labd3explst_prf_tr ld3es
  <span class="keyword">|</span> D3Erefarg _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Escaseof <span class="keyword">(</span>_<span class="comment">(*s2e*)</span><span class="keyword">,</span> sc3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      $Lst<span class="keyword">.</span>list_foreach_fun <span class="keyword">(</span>sc3ls<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">fn</span> f <span class="keyword">(</span>sc3l<span class="keyword">:</span> <span class="staexp">sc3lau</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> d3exp_prf_tr <span class="keyword">(</span>sc3l<span class="keyword">.</span>sc3lau_exp<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [D3Escaseof]
</span>  <span class="keyword">|</span> D3Esel <span class="keyword">(</span>d3e<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e
  <span class="keyword">|</span> D3Esel_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> d3exp_prf_tr d3e_ptr
  <span class="keyword">|</span> D3Esel_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Eseq d3es <span class="keyword">=&gt;</span> d3explst_prf_tr d3es
  <span class="keyword">|</span> D3Esif <span class="keyword">(</span>
      _<span class="comment">(*cond*)</span><span class="keyword">,</span> d3e_then<span class="keyword">,</span> d3e_else
    <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_then
      <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_else
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Esif]
</span>  <span class="keyword">|</span> D3Estring _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Estruct ld3es <span class="keyword">=&gt;</span> labd3explst_prf_tr ld3es
  <span class="keyword">|</span> D3Evar _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> D3Eviewat_assgn_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_ptr
      <span class="comment">// val () = d3lablst_prf_tr (d3ls) // is this really needed?
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_val
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_assgn_ptr]
</span>  <span class="keyword">|</span> D3Eviewat_assgn_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> d3e_val<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val () = d3lablst_prf_tr (d3ls) // is this really needed?
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_val
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_assgn_var]
</span>  <span class="keyword">|</span> D3Eviewat_ptr <span class="keyword">(</span>d3e_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e_ptr
      <span class="comment">// val () = d3lablst_prf_tr (d3ls) // is this really needed?
</span>    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_ptr]
</span>  <span class="keyword">|</span> D3Eviewat_var <span class="keyword">(</span>d2v_ptr<span class="keyword">,</span> d3ls<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val () = d3lablst_prf_tr (d3ls) // is this really needed?
</span>    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Eviewat_var]
</span>  <span class="keyword">|</span> D3Ewhere <span class="keyword">(</span>d3e<span class="keyword">,</span> d3cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3eclst_prf_tr d3cs<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr d3e
    <span class="keyword">in</span>
      <span class="comment">// empty
</span>    <span class="keyword">end</span> <span class="comment">// end of [D3Ewhere]
</span>  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_loc_interror d3e0<span class="keyword">.</span>d3exp_loc<span class="keyword">;</span>
      prerr ": d3exp_prf_tr: d3e0 = "<span class="keyword">;</span> prerr_d3exp d3e0<span class="keyword">;</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
      $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [_]
</span><span class="keyword">end</span> <span class="comment">(* end of [d3exp_prf_tr] *)</span>

<span class="keyword">implement</span>
d3explst_prf_tr <span class="keyword">(</span>d3es<span class="keyword">)</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_foreach_fun <span class="keyword">(</span>d3es<span class="keyword">,</span> d3exp_prf_tr<span class="keyword">)</span>
<span class="comment">// end of [d3explst_prf_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> f3undec_tr <span class="keyword">(</span>
    decarg<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">,</span> d3c<span class="keyword">:</span> <span class="staexp">f3undec</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hifundec</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d3c<span class="keyword">.</span>f3undec_loc
  <span class="keyword">val</span> d2v_fun <span class="keyword">=</span> d3c<span class="keyword">.</span>f3undec_var
  <span class="keyword">val</span> hie_def <span class="keyword">=</span> d3exp_tr d3c<span class="keyword">.</span>f3undec_def
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> decarg <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        tmpvarmap_add <span class="keyword">(</span>d2v_fun<span class="keyword">,</span> decarg<span class="keyword">,</span> hie_def<span class="keyword">)</span> <span class="comment">// template function
</span>      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">(*
  val () = begin
    print "f3undec_tr: d2v_fun = "; print d2v_fun; print_newline ();
    print "f3undec_tr: hie_def = "; print hie_def; print_newline ();
  end // end of [val]
*)</span>
<span class="keyword">in</span>
  hifundec_make <span class="keyword">(</span>loc<span class="keyword">,</span> d2v_fun<span class="keyword">,</span> hie_def<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [f3undec_tr]
</span>
<span class="keyword">fn</span> f3undeclst_tr
  <span class="keyword">(</span>decarg<span class="keyword">:</span> <span class="staexp">s2qualst</span><span class="keyword">,</span> d3cs<span class="keyword">:</span> <span class="staexp">f3undeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hifundeclst</span> <span class="keyword">=</span>
  $Lst<span class="keyword">.</span>list_map_cloptr <span class="keyword">(</span>d3cs<span class="keyword">,</span> <span class="keyword">lam</span> d3c <span class="keyword">=&lt;</span><span class="staexp">cloptr1</span><span class="keyword">&gt;</span> f3undec_tr <span class="keyword">(</span>decarg<span class="keyword">,</span> d3c<span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [f3undeclst_tr]
</span>
<span class="keyword">fun</span> f3undeclst_prf_tr
  <span class="keyword">(</span>fundecs<span class="keyword">:</span> <span class="staexp">f3undeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> fundecs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>fundec<span class="keyword">,</span> fundecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      d3exp_prf_tr <span class="keyword">(</span>fundec<span class="keyword">.</span>f3undec_def<span class="keyword">)</span><span class="keyword">;</span> f3undeclst_prf_tr fundecs
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span><span class="comment">// end of [f3undeclst_prf_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> v3aldec_tr <span class="keyword">(</span>
  d3c<span class="keyword">:</span> <span class="staexp">v3aldec</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hivaldec</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d3c<span class="keyword">.</span>v3aldec_loc
  <span class="keyword">val</span> hip <span class="keyword">=</span> p3at_tr d3c<span class="keyword">.</span>v3aldec_pat
  <span class="keyword">val</span> d3e_def <span class="keyword">=</span> d3c<span class="keyword">.</span>v3aldec_def
  <span class="keyword">val</span> isprf <span class="keyword">=</span> d3exp_is_proof <span class="keyword">(</span>d3e_def<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isprf <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error4 <span class="keyword">(</span>loc<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": [val] should be replaced with [prval] as this is a proof binding."
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> hie <span class="keyword">=</span> d3exp_tr d3e_def
<span class="keyword">in</span>
  hivaldec_make <span class="keyword">(</span>loc<span class="keyword">,</span> hip<span class="keyword">,</span> hie<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [v3aldec_tr]
</span>
<span class="keyword">fn</span> v3aldeclst_tr
  <span class="keyword">(</span>d3cs<span class="keyword">:</span> <span class="staexp">v3aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hivaldeclst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>d3cs<span class="keyword">,</span> v3aldec_tr<span class="keyword">)</span>
<span class="comment">// end of [v3aldeclst_tr]
</span>
<span class="keyword">fn</span> v3ardec_tr
  <span class="keyword">(</span>d3c<span class="keyword">:</span> <span class="staexp">v3ardec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hivardec</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> d3c<span class="keyword">.</span>v3ardec_loc
  <span class="keyword">val</span> knd <span class="keyword">=</span> d3c<span class="keyword">.</span>v3ardec_knd
  <span class="keyword">val</span> d2v_ptr <span class="keyword">=</span> d3c<span class="keyword">.</span>v3ardec_dvar_ptr
  <span class="keyword">val</span> ini <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> d3c<span class="keyword">.</span>v3ardec_ini <span class="keyword">of</span>
    <span class="keyword">|</span> Some d3e <span class="keyword">=&gt;</span> Some <span class="keyword">(</span>d3exp_tr d3e<span class="keyword">)</span> <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiexpopt</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  hivardec_make <span class="keyword">(</span>loc<span class="keyword">,</span> knd<span class="keyword">,</span> d2v_ptr<span class="keyword">,</span> ini<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [v3ardec_tr]
</span>
<span class="keyword">fn</span> v3ardeclst_tr
  <span class="keyword">(</span>d3cs<span class="keyword">:</span> <span class="staexp">v3ardeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">hivardeclst</span> <span class="keyword">=</span> $Lst<span class="keyword">.</span>list_map_fun <span class="keyword">(</span>d3cs<span class="keyword">,</span> v3ardec_tr<span class="keyword">)</span>
<span class="comment">// end of [v3ardeclst_tr]
</span>
<span class="keyword">fun</span> v3aldeclst_prf_tr
  <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v3aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      d3exp_prf_tr <span class="keyword">(</span>valdec<span class="keyword">.</span>v3aldec_def<span class="keyword">)</span><span class="keyword">;</span> v3aldeclst_prf_tr valdecs
    <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span><span class="comment">// end of [v3aldeclst_prf_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> i3mpdec_tr <span class="keyword">(</span>
  d3c<span class="keyword">:</span> <span class="staexp">i3mpdec</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hiimpdec</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc0 <span class="keyword">=</span> d3c<span class="keyword">.</span>i3mpdec_loc
  <span class="keyword">val</span> d2c <span class="keyword">=</span> d3c<span class="keyword">.</span>i3mpdec_cst
  <span class="keyword">val</span> decarg <span class="keyword">=</span> d3c<span class="keyword">.</span>i3mpdec_decarg
  <span class="keyword">val</span> tmp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> decarg <span class="keyword">of</span> cons _ <span class="keyword">=&gt;</span> 1 <span class="keyword">|</span> nil _ <span class="keyword">=&gt;</span> 0<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span>
<span class="comment">//
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">s2expopt</span> <span class="keyword">=</span> None <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> tmparg <span class="keyword">=</span> d3c<span class="keyword">.</span>i3mpdec_tmparg
  <span class="keyword">val</span> tmparg <span class="keyword">=</span> s2explstlst_tr_named <span class="keyword">(</span>loc0<span class="keyword">,</span> tmparg<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> res <span class="keyword">of</span>
    <span class="keyword">|</span> Some <span class="keyword">(</span>s2e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error4 <span class="keyword">(</span>loc0<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the template parameter ["
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_s2exp <span class="keyword">(</span>s2e<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] is required to be named but it is not."
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">in</span>
        $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>    <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [None_vt]
</span>  <span class="keyword">)</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> def <span class="keyword">=</span> d3exp_tr d3c<span class="keyword">.</span>i3mpdec_def
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
    <span class="keyword">|</span> _ <span class="keyword">when</span> d2cst_is_fun d2c <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">case+</span> def<span class="keyword">.</span>hiexp_node <span class="keyword">of</span>
      <span class="keyword">|</span> HIElam _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_error4 <span class="keyword">(</span>loc0<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": the dynamic constant ["
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr <span class="keyword">(</span>d2c<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "] is required to be implemented as a function but it is not."
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> tmp <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> tmpcstmap_add <span class="keyword">(</span>d2c<span class="keyword">,</span> decarg<span class="keyword">,</span> def<span class="keyword">)</span>
  <span class="keyword">val</span> d2cs <span class="keyword">=</span> the_dyncstset_get <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">in</span>
<span class="comment">//
</span>  hiimpdec_make <span class="keyword">(</span>loc0<span class="keyword">,</span> d2c<span class="keyword">,</span> tmp<span class="keyword">,</span> decarg<span class="keyword">,</span> tmparg<span class="keyword">,</span> def<span class="keyword">,</span> d2cs<span class="keyword">)</span>
<span class="comment">//
</span><span class="keyword">end</span> <span class="comment">// end of [i3mpdec_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d3eclst_tr <span class="keyword">(</span>d3cs0<span class="keyword">)</span> <span class="keyword">=</span> res <span class="keyword">where</span> <span class="keyword">{</span>
<span class="comment">//
</span><span class="comment">// [aux0] and [aux1] are mutually tail-recursive
</span><span class="comment">//
</span>  <span class="keyword">fn*</span> aux0 <span class="keyword">(</span>
      d3cs<span class="keyword">:</span> <span class="staexp">d3eclst</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>hideclst? &gt;&gt; hideclst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d3cs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>d3c<span class="keyword">,</span> d3cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d3c<span class="keyword">.</span>d3ec_node <span class="keyword">of</span>
      <span class="keyword">|</span> D3Cnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux0 <span class="keyword">(</span>d3cs<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">|</span> D3Clist d3cs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_list <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> d3eclst_tr d3cs1<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Clist]
</span>      <span class="keyword">|</span> D3Csaspdec saspdec <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_saspdec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> saspdec<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Csaspdec]
</span>      <span class="keyword">|</span> D3Cdcstdec <span class="keyword">(</span>knd<span class="keyword">,</span> d2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_dcstdec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> knd<span class="keyword">,</span> d2cs<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cdcstdec]
</span>      <span class="keyword">|</span> D3Cdatdec <span class="keyword">(</span>knd<span class="keyword">,</span> s2cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_datdec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> knd<span class="keyword">,</span> s2cs<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cdatdec]
</span>      <span class="keyword">|</span> D3Cexndec d3cs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_exndec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> d3cs1<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cexndec]
</span>      <span class="keyword">|</span> D3Cextype <span class="keyword">(</span>name<span class="keyword">,</span> s2e_def<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> loc <span class="keyword">=</span> d3c<span class="keyword">.</span>d3ec_loc
          <span class="keyword">val</span> hit_def <span class="keyword">=</span> s2exp_tr <span class="keyword">(</span>loc<span class="keyword">,</span> 1<span class="comment">(*deep*)</span><span class="keyword">,</span> s2e_def<span class="keyword">)</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_extype <span class="keyword">(</span>loc<span class="keyword">,</span> name<span class="keyword">,</span> hit_def<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cextype]
</span>      <span class="keyword">|</span> D3Cextval <span class="keyword">(</span>name<span class="keyword">,</span> d3e_def<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hie_def <span class="keyword">=</span> d3exp_tr d3e_def
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_extval <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> name<span class="keyword">,</span> hie_def<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cextval]
</span>      <span class="keyword">|</span> D3Cextcode <span class="keyword">(</span>position<span class="comment">(*int*)</span><span class="keyword">,</span> code<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_extern <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> position<span class="keyword">,</span> code<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cextcode]
</span>      <span class="keyword">|</span> D3Cimpdec impdec <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> d2c <span class="keyword">=</span> impdec<span class="keyword">.</span>i3mpdec_cst
          <span class="keyword">val</span> hid <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> 0 <span class="keyword">of</span>
            <span class="keyword">|</span> _ <span class="keyword">when</span> d2cst_is_proof d2c <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pf_token</span> <span class="keyword">|</span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> the_dyncstsetlst_push <span class="keyword">(</span><span class="keyword">)</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3exp_prf_tr <span class="keyword">(</span>impdec<span class="keyword">.</span>i3mpdec_def<span class="keyword">)</span>
                <span class="keyword">val</span> d2cs <span class="keyword">=</span> the_dyncstsetlst_pop <span class="keyword">(</span><span class="prfexp">pf_token</span> <span class="keyword">|</span> <span class="comment">(*none*)</span><span class="keyword">)</span>
                <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> the_dyncstset_add_if <span class="keyword">(</span>d2c<span class="keyword">)</span>
                <span class="keyword">val</span> hid <span class="keyword">=</span> hiimpdec_prf_make <span class="keyword">(</span>impdec<span class="keyword">.</span>i3mpdec_loc<span class="keyword">,</span> d2c<span class="keyword">,</span> d2cs<span class="keyword">)</span>
              <span class="keyword">in</span>
                hidec_impdec_prf <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> hid<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_ when ...]
</span>            <span class="keyword">|</span> _ <span class="comment">(* nonproof implementation *)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                <span class="keyword">val</span> hid <span class="keyword">=</span> i3mpdec_tr impdec <span class="keyword">in</span> hidec_impdec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> hid<span class="keyword">)</span>
              <span class="keyword">end</span> <span class="comment">// end of [_]
</span>          <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">hidec</span> <span class="comment">// end of [val]
</span>        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cimpdec]
</span>      <span class="keyword">|</span> D3Cfundecs <span class="keyword">(</span>decarg<span class="keyword">,</span> knd<span class="keyword">,</span> fundecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> $Syn<span class="keyword">.</span>funkind_is_proof knd <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f3undeclst_prf_tr <span class="keyword">(</span>fundecs<span class="keyword">)</span> <span class="keyword">in</span> aux0 <span class="keyword">(</span>d3cs<span class="keyword">,</span> res<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> hifundecs <span class="keyword">=</span> f3undeclst_tr <span class="keyword">(</span>decarg<span class="keyword">,</span> fundecs<span class="keyword">)</span>
            <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_fundecs <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> decarg<span class="keyword">,</span> knd<span class="keyword">,</span> hifundecs<span class="keyword">)</span>
          <span class="keyword">in</span>
            aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">(* end of [D3Cfundecs] *)</span>
      <span class="keyword">|</span> D3Cvaldecs <span class="keyword">(</span>knd<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">if</span> $Syn<span class="keyword">.</span>valkind_is_proof knd <span class="keyword">then</span> <span class="keyword">let</span>
            <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v3aldeclst_prf_tr <span class="keyword">(</span>valdecs<span class="keyword">)</span> <span class="keyword">in</span> aux0 <span class="keyword">(</span>d3cs<span class="keyword">,</span> res<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
            <span class="keyword">val</span> hid <span class="keyword">=</span>
              hidec_valdecs <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> knd<span class="keyword">,</span> v3aldeclst_tr valdecs<span class="keyword">)</span>
            <span class="comment">// end of [val]
</span>          <span class="keyword">in</span>
            aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [if]
</span>        <span class="keyword">end</span> <span class="comment">(* end of [D3Cvaldecs] *)</span>
      <span class="keyword">|</span> D3Cvaldecs_par valdecs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_valdecs_par <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> v3aldeclst_tr valdecs<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cvaldecs_par]
</span>      <span class="keyword">|</span> D3Cvaldecs_rec valdecs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_valdecs_rec <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> v3aldeclst_tr valdecs<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cvaldecs_rec]
</span>      <span class="keyword">|</span> D3Cvardecs vardecs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_vardecs <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> v3ardeclst_tr vardecs<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cvardecs]
</span>      <span class="keyword">|</span> D3Clocal <span class="keyword">(</span>d3cs_head<span class="keyword">,</span> d3cs_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hids_head <span class="keyword">=</span> d3eclst_tr d3cs_head
          <span class="keyword">val</span> hids_body <span class="keyword">=</span> d3eclst_tr d3cs_body
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_local <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> hids_head<span class="keyword">,</span> hids_body<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Clocal]
</span>      <span class="keyword">|</span> D3Cstaload <span class="keyword">(</span>fil<span class="keyword">,</span> loadflag<span class="keyword">,</span> od3c<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> od3c <span class="keyword">of</span>
            <span class="keyword">|</span> Some d3cs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                <span class="comment">// record definitions for templates
</span>                <span class="keyword">let</span> <span class="keyword">val</span> _<span class="comment">(*hideclst*)</span> <span class="keyword">=</span> d3eclst_tr d3cs <span class="keyword">in</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">end</span>
              <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>            <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [val]
</span>          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_staload <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> fil<span class="keyword">,</span> loadflag<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cstaload]
</span>      <span class="keyword">|</span> D3Cdynload fil <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> hid <span class="keyword">=</span> hidec_dynload <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">,</span> fil<span class="keyword">)</span>
        <span class="keyword">in</span>
          aux1 <span class="keyword">(</span>d3cs<span class="keyword">,</span> hid<span class="keyword">,</span> res<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cdynload]
</span><span class="comment">(*
      | _ =&gt; let
          val () = (res := list_nil ())
        in
          prerr_loc_interror d3c.d3ec_loc;
          prerr ": d3eclst_tr: aux0: not available yet."; prerr_newline ();
          $Err.abort {void} ()
        end // end of [_]
*)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [list_cons] *)</span>
    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux0]
</span><span class="comment">//
</span>  <span class="keyword">and</span> aux1 <span class="keyword">(</span>
      d3cs<span class="keyword">:</span> <span class="staexp">d3eclst</span>
    <span class="keyword">,</span> hid<span class="keyword">:</span> <span class="staexp">hidec</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>hideclst? &gt;&gt; hideclst</span>
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := cons <span class="staexp"><span class="keyword">{</span>hidec<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>hid<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val+</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span> <span class="keyword">=</span> res
  <span class="keyword">in</span>
    aux0 <span class="keyword">(</span>d3cs<span class="keyword">,</span> <span class="keyword">!</span>res_nxt<span class="keyword">)</span><span class="keyword">;</span> fold@ res
  <span class="keyword">end</span> <span class="comment">// end of [aux1]
</span><span class="comment">//
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">hideclst</span> <span class="comment">// uninitialize
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux0 <span class="keyword">(</span>d3cs0<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [d3eclst_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
d3eclst_prf_tr
  <span class="keyword">(</span>d3cs0<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>d3cs0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>d3cs<span class="keyword">:</span> <span class="staexp">d3eclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d3cs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>d3c<span class="keyword">,</span> d3cs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> d3c<span class="keyword">.</span>d3ec_node <span class="keyword">of</span>
      <span class="keyword">|</span> D3Cnone <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>d3cs<span class="keyword">)</span>
      <span class="keyword">|</span> D3Clist d3cs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3eclst_prf_tr d3cs1 <span class="keyword">in</span> aux d3cs
        <span class="keyword">end</span> <span class="comment">// end of [D3Clist]
</span>      <span class="keyword">|</span> D3Cdatdec _ <span class="keyword">=&gt;</span> aux d3cs
      <span class="keyword">|</span> D3Cexndec _ <span class="keyword">=&gt;</span> aux d3cs
      <span class="keyword">|</span> D3Cdcstdec _ <span class="keyword">=&gt;</span> aux d3cs
      <span class="keyword">|</span> D3Cfundecs <span class="keyword">(</span>decarg<span class="keyword">,</span> knd<span class="keyword">,</span> fundecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f3undeclst_prf_tr fundecs <span class="keyword">in</span> aux <span class="keyword">(</span>d3cs<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cfundecs]
</span>      <span class="keyword">|</span> D3Cvaldecs <span class="keyword">(</span>knd<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v3aldeclst_prf_tr valdecs <span class="keyword">in</span> aux <span class="keyword">(</span>d3cs<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cvaldecs]
</span>      <span class="keyword">|</span> D3Cvaldecs_rec valdecs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v3aldeclst_prf_tr valdecs <span class="keyword">in</span> aux <span class="keyword">(</span>d3cs<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Cvaldecs_rec]
</span>      <span class="keyword">|</span> D3Clocal <span class="keyword">(</span>
          d3cs_head<span class="keyword">,</span> d3cs_body
        <span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3eclst_prf_tr d3cs_head
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> d3eclst_prf_tr d3cs_body
        <span class="keyword">in</span>
          aux <span class="keyword">(</span>d3cs<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [D3Clocal]
</span>      <span class="keyword">|</span> D3Cstaload _ <span class="keyword">=&gt;</span> aux d3cs
      <span class="keyword">|</span> D3Cdynload _ <span class="keyword">=&gt;</span> aux d3cs
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc_interror <span class="keyword">(</span>d3c<span class="keyword">.</span>d3ec_loc<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": d3eclst_prf_tr: illegal proof declaration."
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          $Err<span class="keyword">.</span>abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [_]
</span>      <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>    <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// end of [list_nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [d3eclst_prf_tr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_trans4.dats] *)</span>
</pre>
</body>
</html>
