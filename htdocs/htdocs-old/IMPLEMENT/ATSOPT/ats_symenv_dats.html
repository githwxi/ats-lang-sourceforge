<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    span.comment {color:#787878;font-style:italic}
    span.extern  {color:#A52A2A}
    span.keyword {color:#000000;font-weight:bold}
    span.neuexp  {color:#800080}
    span.staexp  {color:#0000FF}
    span.dynexp  {color:#E80000}
    span.prfexp  {color:#009000}
    span.stacstdec  {text-decoration:none}
    span.stacstuse  {color:#0000CF;text-decoration:underline}
    span.dyncstdec  {text-decoration:none}
    span.dyncstimp  {color:#B80000;text-decoration:underline}
    span.dyncstuse  {color:#B80000;text-decoration:underline}
    body          {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre>
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS/Anairiats - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of  the GNU GENERAL PUBLIC LICENSE (GPL) as published by the
** Free Software Foundation; either version 3, or (at  your  option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// Author: Hongwei Xi (hwxi AT cs DOT bu DOT edu)
</span><span class="comment">// Time: October 2008
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Sym <span class="keyword">=</span> "ats_symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">Map <span class="keyword">=</span> "ats_map_lin.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_symenv.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"ats_reference.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "ats_reference.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">THIS_FILE "ats_symenv.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="1815"><span class="stacstdec">sym_t <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymbol_2esats.html#1609"><span class="stacstuse">$Sym<span class="keyword">.</span>symbol_t</span></a></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">viewtypedef</span>
<span class="staexp"><a name="1871"><span class="stacstdec">symmap <span class="keyword">(</span>itm<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1634"><span class="stacstuse">$Map<span class="keyword">.</span>map_vt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a><span class="keyword">,</span> itm<span class="keyword">)</span></span></a></span>
<span class="keyword">viewtypedef</span>
<span class="staexp"><a name="1929"><span class="stacstdec">symmaplst <span class="keyword">(</span>itm<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">]</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">,</span> n<span class="keyword">)</span></span></a></span>

<span class="keyword">typedef</span>
<span class="staexp"><a name="1994"><span class="stacstdec">symenv <span class="keyword">(</span>itm<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  map<span class="keyword">=</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#10015"><span class="stacstuse">ref</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">)</span>
<span class="keyword">,</span> maplst<span class="keyword">=</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#10015"><span class="stacstuse">ref</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm<span class="keyword">)</span>
<span class="keyword">,</span> savedlst<span class="keyword">=</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#10015"><span class="stacstuse">ref</span></a> <span class="keyword">(</span><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22725"><span class="stacstuse">List_vt</span></a> <span class="keyword">@(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">,</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">,</span> pervasive<span class="keyword">=</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#10015"><span class="stacstuse">ref</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm<span class="keyword">)</span>
<span class="keyword">}</span></span></a></span> <span class="comment">// end of [symenv]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">symmap_t <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a></span>
<span class="keyword">assume</span> <span class="staexp">symenv_t <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1994"><span class="stacstuse">symenv</span></a></span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// HX: this one is used in other templates
</span><span class="comment">//
</span><span class="keyword">fn</span><span class="keyword">{</span><span class="keyword">}</span> prerr_interror <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr "INTERNAL ERROR (ats_symenv)"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1864"><span class="dyncstimp">symmap_search</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2271"><span class="dyncstuse">$Map<span class="keyword">.</span>map_search&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a></span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span>
<span class="comment">// end of [symmap_search]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1968"><span class="dyncstimp">symmap_ref_search</span></a> <span class="keyword">(</span>r_m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> r_m
<span class="keyword">in</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2271"><span class="dyncstuse">$Map<span class="keyword">.</span>map_search&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a></span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symmap_ref_search]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2079"><span class="dyncstimp">symmap_list_get</span></a> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2546"><span class="dyncstuse">$Map<span class="keyword">.</span>map_list_inf</span></a> m

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2185"><span class="dyncstimp">symmap_reflist_get</span></a> <span class="keyword">(</span>r_m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> r_m
<span class="keyword">in</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2546"><span class="dyncstuse">$Map<span class="keyword">.</span>map_list_inf</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symmap_ref_list]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2318"><span class="dyncstimp">symmap_insert</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2066"><span class="dyncstuse">$Map<span class="keyword">.</span>map_insert</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> 
<span class="comment">// end of [symmap_insert]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2423"><span class="dyncstimp">symmap_remove</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2168"><span class="dyncstuse">$Map<span class="keyword">.</span>map_remove</span></a> <span class="keyword">(</span>m<span class="keyword">,</span> k<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2579"><span class="dyncstimp">symmap_list_inf</span></a> <span class="keyword">(</span>m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2546"><span class="dyncstuse">$Map<span class="keyword">.</span>map_list_inf&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a></span><span class="keyword">,</span><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span>m<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1727"><span class="dyncstimp">symmap_make</span></a> <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1706"><span class="dyncstuse">$Map<span class="keyword">.</span>map_make</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a><span class="keyword">,</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymbol_2esats.html#4998"><span class="dyncstuse">$Sym<span class="keyword">.</span>compare_symbol_symbol</span></a><span class="keyword">)</span>
<span class="comment">// end of [symmap_make]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1787"><span class="dyncstimp">symmap_free</span></a> <span class="keyword">(</span>map<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#1870"><span class="dyncstuse">$Map<span class="keyword">.</span>map_free</span></a> <span class="keyword">(</span>map<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
symmaplst_free <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>ms<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#16293"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> ms <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>
      <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1787"><span class="dyncstuse">symmap_free&lt;</span></a><span class="staexp">itm</span><span class="keyword">&gt;</span> m<span class="keyword">;</span> symmaplst_free&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> ms
    <span class="keyword">)</span> <span class="comment">// end of [list_vt_cons]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [symmaplst_free]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
symmaplst_search <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    ms0<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a></span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a></span></a> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> itm</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ms0 <span class="keyword">of</span>
  <span class="keyword">|</span> list_vt_cons <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> <span class="keyword">!</span>p_ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2271"><span class="dyncstuse">$Map<span class="keyword">.</span>map_search</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
      <span class="keyword">|</span> Some_vt _ <span class="keyword">=&gt;</span> ans <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ms0<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ans
        <span class="keyword">}</span> <span class="comment">// end of [Some_vt]
</span>      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ans <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> symmaplst_search&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">,</span> k<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ms0
        <span class="keyword">}</span> <span class="comment">// end of [None_vt]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [list_vt_cons] *)</span>
  <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ ms0<span class="keyword">;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symmaplst_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2747"><span class="dyncstimp">symenv_make</span></a> <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  map<span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#1801"><span class="dyncstuse">ref_make_elt</span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1727"><span class="dyncstuse">symmap_make</span></a> <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">,</span> maplst<span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#1801"><span class="dyncstuse">ref_make_elt</span></a> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">,</span> savedlst<span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#1801"><span class="dyncstuse">ref_make_elt</span></a> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">,</span> pervasive<span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#1801"><span class="dyncstuse">ref_make_elt</span></a> <span class="keyword">(</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [symenv_make]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2827"><span class="dyncstimp">symenv_insert_fst</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map <span class="keyword">in</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2066"><span class="dyncstuse">$Map<span class="keyword">.</span>map_insert</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_insert_fst]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#2937"><span class="dyncstimp">symenv_remove_fst</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map <span class="keyword">in</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2168"><span class="dyncstuse">$Map<span class="keyword">.</span>map_remove</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_remove_fst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3069"><span class="dyncstimp">symenv_search_all</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map <span class="keyword">in</span>
    <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2271"><span class="dyncstuse">$Map<span class="keyword">.</span>map_search</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> ans <span class="keyword">of</span>
  <span class="keyword">|</span> Some_vt _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">let</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ans <span class="keyword">in</span> ans <span class="keyword">end</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
    <span class="keyword">in</span>
      symmaplst_search&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">,</span> k<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">(* end of [symenv_search] *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3201"><span class="dyncstimp">symenv_pervasive_search</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>pervasive
<span class="keyword">in</span>
  symmaplst_search&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">,</span> k<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_pervasive_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">itm<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
symmaplst_replace <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    ms0<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22675"><span class="stacstuse">list_vt</span></a></span></a> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a></span></a> itm<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> k<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1815"><span class="stacstuse">sym_t</span></a></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">itm</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#23028"><span class="stacstuse">Option_vt</span></a> itm</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> ms0 <span class="keyword">of</span>
  <span class="keyword">|</span> list_vt_cons <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> <span class="keyword">!</span>p_ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> ans <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2168"><span class="dyncstuse">$Map<span class="keyword">.</span>map_remove</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Some_vt _ <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2066"><span class="dyncstuse">$Map<span class="keyword">.</span>map_insert</span></a> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ms0
        <span class="keyword">}</span> <span class="comment">// end of [Some_vt]
</span>      <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ans <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> ans <span class="keyword">=</span> symmaplst_replace&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fold@ ms0
        <span class="keyword">}</span> <span class="comment">// end of [None_vt]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [list_vt_cons] *)</span>
  <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ ms0<span class="keyword">;</span> Some_vt i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symmaplst_replace]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3324"><span class="dyncstimp">symenv_pervasive_replace</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>pervasive
<span class="keyword">in</span>
  symmaplst_replace&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">,</span> k<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_pervasive_search]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3478"><span class="dyncstimp">symenv_pop</span></a> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fn</span> abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": symenv_pop: env.maplst is empty"<span class="keyword">;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#12890"><span class="dyncstuse">prerr_newline</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#4651"><span class="dyncstuse">exit</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// [abort]
</span><span class="comment">//
</span>  <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
    <span class="keyword">prval</span> <span class="prfexp">vbox pf_ms <span class="keyword">=</span> pfbox</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p_ms <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>p_ms := <span class="keyword">(</span>ms<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm</span><span class="keyword">)</span><span class="keyword">;</span> m
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        fold@ <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span>  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
<span class="keyword">in</span>
  <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1787"><span class="dyncstuse">symmap_free&lt;</span></a><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p_m := m
<span class="keyword">end</span> <span class="comment">// end of [symenv_pop]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3520"><span class="dyncstimp">symenv_push</span></a> <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
    <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">!</span>p_m
  <span class="keyword">in</span>
    <span class="keyword">!</span>p_m := <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1727"><span class="dyncstuse">symmap_make</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> m
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
<span class="keyword">in</span>
  <span class="keyword">!</span>p_ms := list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> <span class="keyword">!</span>p_ms<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_push]
</span>
<span class="comment">//
</span>
<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3625"><span class="dyncstimp">symenv_swap</span></a>
  <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">,</span> r_m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf1_m</span> <span class="keyword">|</span> p1_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="7579"><span class="stacstdec">elt <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1613"><span class="stacstuse">symmap_t</span></a> itm</span></a></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2835"><span class="dyncstuse">ref_swap&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#7579"><span class="stacstuse">elt</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>r_m<span class="keyword">,</span> <span class="keyword">!</span>p1_m<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [symenv_swap]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3988"><span class="dyncstimp">symenv_save</span></a> <span class="staexp"><span class="keyword">{</span>itm<span class="keyword">}</span></span> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
    <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">!</span>p_m
  <span class="keyword">in</span>
    <span class="keyword">!</span>p_m := <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1727"><span class="dyncstuse">symmap_make</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> m
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span>
<span class="comment">//
</span>  <span class="keyword">val</span> ms <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
    <span class="keyword">val</span> ms <span class="keyword">=</span> <span class="keyword">!</span>p_ms
  <span class="keyword">in</span>
    <span class="keyword">!</span>p_ms := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> ms
  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm</span>
<span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_saved</span> <span class="keyword">|</span> p_saved<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>savedlst
<span class="keyword">in</span>
  <span class="keyword">!</span>p_saved := list_vt_cons <span class="keyword">(</span> <span class="keyword">@(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span><span class="keyword">,</span> <span class="keyword">!</span>p_saved <span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_save]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#4053"><span class="dyncstimp">symenv_restore</span></a> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="8257"><span class="stacstdec">mms <span class="keyword">=</span> <span class="keyword">@(</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">,</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm<span class="keyword">)</span></span></a></span>
<span class="comment">//
</span>  <span class="keyword">fn</span> abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#8257"><span class="stacstuse">mms</span></a></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": symenv_restore: env.savedlst is empty"<span class="keyword">;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#12890"><span class="dyncstuse">prerr_newline</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#4651"><span class="dyncstuse">exit</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#8257"><span class="stacstuse">mms</span></a><span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [abort]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_saved</span> <span class="keyword">|</span> p_saved<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>savedlst
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>p_saved <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>mms<span class="keyword">,</span> rest<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">!</span>p_saved := <span class="keyword">(</span>rest<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fsta_2esats.html#22725"><span class="stacstuse">List_vt</span></a> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#8257"><span class="stacstuse">mms</span></a></span><span class="keyword">)</span><span class="keyword">;</span> mms
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_cons]
</span>    <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        fold@ <span class="keyword">(</span><span class="keyword">!</span>p_saved<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span>  <span class="keyword">end</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#8257"><span class="stacstuse">mms</span></a></span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
  <span class="keyword">in</span>
    <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1787"><span class="dyncstuse">symmap_free&lt;</span></a><span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_m<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p_m := m
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
  <span class="keyword">in</span>
    symmaplst_free&lt;<span class="staexp">itm</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">!</span>p_ms := ms
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// no return value
</span><span class="keyword">end</span> <span class="comment">// end of [symenv_restore]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3747"><span class="dyncstimp">symenv_top_get</span></a> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r_m <span class="keyword">=</span> env<span class="keyword">.</span>map
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> r_m
  <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">!</span>p_m
<span class="keyword">in</span>
  <span class="keyword">!</span>p_m := <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1727"><span class="dyncstuse">symmap_make</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> m
<span class="keyword">end</span> <span class="comment">// end of [symenv_top]
</span>
<span class="keyword">implement</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3812"><span class="dyncstimp">symenv_reftop_get</span></a> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> env<span class="keyword">.</span>map

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">itm</span><span class="keyword">}</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#3919"><span class="dyncstimp">symenv_localjoin</span></a> <span class="keyword">(</span>env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">//
</span>  <span class="keyword">fn</span> abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_interror <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    prerr ": symenv_localjoin: env.maplst is empty"<span class="keyword">;</span> <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#12890"><span class="dyncstuse">prerr_newline</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    <a href="XREF/_2ftmp_2fATS_2d0_2e2_2e3_2fprelude_2fbasics_5fdyn_2esats.html#4651"><span class="dyncstuse">exit</span></a> <span class="staexp"><span class="keyword">{</span><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [symenv_localjoint]
</span><span class="comment">//
</span>  <span class="keyword">val</span> m1 <span class="keyword">=</span> m <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
    <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> <span class="keyword">!</span>p_ms <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          <span class="keyword">!</span>p_ms := <span class="keyword">(</span>ms<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm</span><span class="keyword">)</span><span class="keyword">;</span> m
        <span class="keyword">end</span> <span class="comment">// list of [list_vt_cons]
</span>      <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fold@ <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#1787"><span class="dyncstuse">symmap_free&lt;</span></a><span class="staexp">itm</span><span class="keyword">&gt;</span> m1
<span class="comment">//
</span>  <span class="keyword">val</span> m2 <span class="keyword">=</span> m <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_ms</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>maplst
    <span class="keyword">val</span> m <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> <span class="keyword">!</span>p_ms <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> ms<span class="keyword">)</span> <span class="keyword">=&gt;</span> m <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_ms := <span class="keyword">(</span>ms<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1929"><span class="stacstuse">symmaplst</span></a> itm</span><span class="keyword">)</span>
        <span class="keyword">}</span> <span class="comment">// end of [list_vt_cons]
</span>      <span class="keyword">|</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
          fold@ <span class="keyword">(</span><span class="keyword">!</span>p_ms<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">$effmask_ref</span> <span class="keyword">(</span>abort <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [list_vt_nil]
</span>    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2edats.html#1871"><span class="stacstuse">symmap</span></a> itm</span> 
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="comment">//
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">vbox pf_m</span> <span class="keyword">|</span> p_m<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>map
<span class="keyword">in</span>
  <span class="keyword">!</span>p_m := <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fmap_5flin_2esats.html#2374"><span class="dyncstuse">$Map<span class="keyword">.</span>map_join</span></a> <span class="keyword">(</span>m2<span class="keyword">,</span> <span class="keyword">!</span>p_m<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_localjoin]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
<a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5fsymenv_2esats.html#4120"><span class="dyncstimp">symenv_pervasive_add</span></a> <span class="keyword">(</span>env<span class="keyword">,</span> m<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="prfexp">pfbox</span> <span class="keyword">|</span> p_ms<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2ftmp_2fATS_2d0_2e2_2e3_2fsrc_2fats_5freference_2esats.html#2660"><span class="dyncstuse">ref_get_view_ptr</span></a> env<span class="keyword">.</span>pervasive
  <span class="keyword">prval</span> <span class="prfexp">vbox pf_ms <span class="keyword">=</span> pfbox</span>
<span class="keyword">in</span>
  <span class="keyword">!</span>p_ms := list_vt_cons <span class="keyword">(</span>m<span class="keyword">,</span> <span class="keyword">!</span>p_ms<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symenv_pervasive_add]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [ats_symenv.dats] *)</span>
</pre>
</body>
</html>
