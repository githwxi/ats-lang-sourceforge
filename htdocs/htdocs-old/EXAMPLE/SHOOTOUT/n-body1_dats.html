<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">(*
** The Great Computer Language Shootout
** http://shootout.alioth.debian.org/
**
** contributed by Hongwei Xi (hwxi AT cs DOT bu DOT edu)
**
** compilation command:
**   atscc -msse2 -mfpmath=sse -O3 n-body.dats -o n-body -lm
*)</FONT>

<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">_<FONT COLOR="#787878">(*anonymous*)</FONT> <FONT COLOR="#000000">=</FONT> "prelude/DATS/array.dats"</FONT>

<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">M <FONT COLOR="#000000">=</FONT> "libc/SATS/math.sats"</FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">body <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>
  double<FONT COLOR="#000000">,</FONT> double<FONT COLOR="#000000">,</FONT> double<FONT COLOR="#000000">,</FONT> double<FONT COLOR="#000000">,</FONT> double<FONT COLOR="#000000">,</FONT> double<FONT COLOR="#000000">,</FONT> double
<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">val</FONT> sun <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 1.0<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> jupiter <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>
  4.84143144246472090<FONT COLOR="#000000">,</FONT>
 ~1.16032004402742839<FONT COLOR="#000000">,</FONT>
 ~1.03622044471123109e-1<FONT COLOR="#000000">,</FONT>
  1.66007664274403694e-3<FONT COLOR="#000000">,</FONT>
  7.69901118419740425e-3<FONT COLOR="#000000">,</FONT>
 ~6.90460016972063023e-5<FONT COLOR="#000000">,</FONT>
  9.54791938424326609e-4
<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> saturn <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>
  8.34336671824457987<FONT COLOR="#000000">,</FONT>
  4.12479856412430479<FONT COLOR="#000000">,</FONT>
 ~4.03523417114321381e-1<FONT COLOR="#000000">,</FONT>
 ~2.76742510726862411e-3<FONT COLOR="#000000">,</FONT>
  4.99852801234917238e-3<FONT COLOR="#000000">,</FONT>
  2.30417297573763929e-5<FONT COLOR="#000000">,</FONT>
  2.85885980666130812e-4
<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> neptune <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>
  1.28943695621391310e+1<FONT COLOR="#000000">,</FONT>
 ~1.51111514016986312e+1<FONT COLOR="#000000">,</FONT>
 ~2.23307578892655734e-1<FONT COLOR="#000000">,</FONT>
  2.96460137564761618e-3<FONT COLOR="#000000">,</FONT>
  2.37847173959480950e-3<FONT COLOR="#000000">,</FONT>
 ~2.96589568540237556e-5<FONT COLOR="#000000">,</FONT>
  4.36624404335156298e-5
<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> uranus <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>
  1.53796971148509165e+1<FONT COLOR="#000000">,</FONT>
 ~2.59193146099879641e+1<FONT COLOR="#000000">,</FONT>
  1.79258772950371181e-1<FONT COLOR="#000000">,</FONT>
  2.68067772490389322e-3<FONT COLOR="#000000">,</FONT>
  1.62824170038242295e-3<FONT COLOR="#000000">,</FONT>
 ~9.51592254519715870e-5<FONT COLOR="#000000">,</FONT>
  5.15138902046611451e-5
<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">PI 3.1415926535898</FONT>
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">SOLAR_MASS <FONT COLOR="#000000">(</FONT>4.0 * PI * PI<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">DAYS_PER_YEAR 365.24</FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">bodylst <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">:</FONT> int<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> list <FONT COLOR="#000000">(</FONT>body<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">N 5</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">N1 <FONT COLOR="#000000">(</FONT>N - 1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">macdef</FONT> <FONT COLOR="#800080">darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_make_elt&lt;double<FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>N<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">,</FONT> z<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT>vx<FONT COLOR="#000000">,</FONT> vy<FONT COLOR="#000000">,</FONT> vz<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">val</FONT> m <FONT COLOR="#000000">=</FONT> darray <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> loop <FONT COLOR="#000000">(</FONT>0<FONT COLOR="#000000">,</FONT> theBodies<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">DPY DAYS_PER_YEAR</FONT>
  <FONT COLOR="#000000">val</FONT> theBodies <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>sun<FONT COLOR="#000000">,</FONT> jupiter<FONT COLOR="#000000">,</FONT> saturn<FONT COLOR="#000000">,</FONT> neptune<FONT COLOR="#000000">,</FONT> uranus<FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">fun</FONT> loop <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT> nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> bs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bodylst <FONT COLOR="#000000">(</FONT>N-i<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>b<FONT COLOR="#000000">,</FONT> bs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> bs
    <FONT COLOR="#000000">in</FONT>
      x[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>0<FONT COLOR="#000000">;</FONT> y[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>1<FONT COLOR="#000000">;</FONT> z[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>2<FONT COLOR="#000000">;</FONT>
      vx[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>3 * DPY<FONT COLOR="#000000">;</FONT> vy[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>4 * DPY<FONT COLOR="#000000">;</FONT> vz[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>5 * DPY<FONT COLOR="#000000">;</FONT>
      m[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := b<FONT COLOR="#000000">.</FONT>6 * SOLAR_MASS<FONT COLOR="#000000">;</FONT>
      loop <FONT COLOR="#000000">(</FONT>i+1<FONT COLOR="#000000">,</FONT> bs<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">}</FONT>

<FONT COLOR="#787878">(* one step *)</FONT>

<FONT COLOR="#800080"><FONT COLOR="#000000">infix</FONT> 0 += -=</FONT>  <FONT COLOR="#787878">// for similar C notation
</FONT><FONT COLOR="#000000">macdef</FONT> <FONT COLOR="#800080">+= <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> d<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">,(</FONT>x<FONT COLOR="#000000">)</FONT> := <FONT COLOR="#000000">,(</FONT>x<FONT COLOR="#000000">)</FONT> + <FONT COLOR="#000000">,(</FONT>d<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">macdef</FONT> <FONT COLOR="#800080">-= <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> d<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">,(</FONT>x<FONT COLOR="#000000">)</FONT> := <FONT COLOR="#000000">,(</FONT>x<FONT COLOR="#000000">)</FONT> - <FONT COLOR="#000000">,(</FONT>d<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">fn</FONT> advance <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> pl <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= N <FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
      x[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> += dt*vx[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> y[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> += dt*vy[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> z[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> += dt*vz[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> pl <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">fun</FONT> vl <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">,</FONT>j<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 0 &lt;= i<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> j<FONT COLOR="#000000">;</FONT> j &lt;= N<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> j<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int j</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> 0 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">when</FONT> i <FONT COLOR="#000000">&lt;</FONT> N1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">if</FONT> j <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> dx <FONT COLOR="#000000">=</FONT> x[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - x[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> dy <FONT COLOR="#000000">=</FONT> y[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - y[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> dz <FONT COLOR="#000000">=</FONT> z[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - z[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT>
        <FONT COLOR="#000000">val</FONT> dist2 <FONT COLOR="#000000">=</FONT> dx * dx + dy * dy + dz * dz
        <FONT COLOR="#000000">val</FONT> dist <FONT COLOR="#000000">=</FONT> $M<FONT COLOR="#000000">.</FONT>sqrt <FONT COLOR="#000000">(</FONT>dist2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> mag <FONT COLOR="#000000">=</FONT> dt / <FONT COLOR="#000000">(</FONT>dist * dist2<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">val</FONT> mi <FONT COLOR="#000000">=</FONT> m[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> * mag <FONT COLOR="#000000">and</FONT> mj <FONT COLOR="#000000">=</FONT> m[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> * mag
      <FONT COLOR="#000000">in</FONT>
        vx[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> -= dx * mj<FONT COLOR="#000000">;</FONT> vy[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> -= dy * mj<FONT COLOR="#000000">;</FONT> vz[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> -= dz * mj<FONT COLOR="#000000">;</FONT> 
        vx[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> += dx * mi<FONT COLOR="#000000">;</FONT> vy[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> += dy * mi<FONT COLOR="#000000">;</FONT> vz[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> += dz * mi<FONT COLOR="#000000">;</FONT>
        vl <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> j+1<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> vl <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">,</FONT> i+2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;</FONT> pl <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  vl <FONT COLOR="#000000">(</FONT>dt<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* calculate initial velocity for the sun *)</FONT>
<FONT COLOR="#000000">fn</FONT> offmoment <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">M SOLAR_MASS</FONT>
  <FONT COLOR="#000000">fun</FONT> loop <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte N</FONT><FONT COLOR="#000000">,</FONT> px<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> py<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> pz<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> mi <FONT COLOR="#000000">=</FONT> m[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">in</FONT> loop <FONT COLOR="#000000">(</FONT>i+1<FONT COLOR="#000000">,</FONT> px+vx[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>*mi<FONT COLOR="#000000">,</FONT> py+vy[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>*mi<FONT COLOR="#000000">,</FONT> pz+vz[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>*mi<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      vx[<FONT COLOR="#009000">0</FONT><FONT COLOR="#000000">]</FONT> := <FONT COLOR="#000000">~</FONT>px / M<FONT COLOR="#000000">;</FONT> vy[<FONT COLOR="#009000">0</FONT><FONT COLOR="#000000">]</FONT> := <FONT COLOR="#000000">~</FONT>py / M<FONT COLOR="#000000">;</FONT> vz[<FONT COLOR="#009000">0</FONT><FONT COLOR="#000000">]</FONT> := <FONT COLOR="#000000">~</FONT>pz / M
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">in</FONT>
  loop <FONT COLOR="#000000">(</FONT>1<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> energy <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#787878">// mutual recursion
</FONT>  <FONT COLOR="#000000">fn*</FONT> l <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt N</FONT><FONT COLOR="#000000">,</FONT> j<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte N</FONT><FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> j <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> dx <FONT COLOR="#000000">=</FONT> x[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - x[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> dy <FONT COLOR="#000000">=</FONT> y[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - y[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> dz <FONT COLOR="#000000">=</FONT> z[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> - z[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> dist2 <FONT COLOR="#000000">=</FONT> dx * dx + dy * dy + dz * dz<FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> dist <FONT COLOR="#000000">=</FONT> $M<FONT COLOR="#000000">.</FONT>sqrt <FONT COLOR="#000000">(</FONT>dist2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      l <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> j+1<FONT COLOR="#000000">,</FONT> e-m[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>*m[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT>/dist<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> l0 <FONT COLOR="#000000">(</FONT>i+1<FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">and</FONT> l0 <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLte N</FONT><FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> N <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> vxi <FONT COLOR="#000000">=</FONT> vx[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> vyi <FONT COLOR="#000000">=</FONT> vy[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> vzi <FONT COLOR="#000000">=</FONT> vz[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
    <FONT COLOR="#000000">in</FONT>
      l <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">,</FONT> e + 0.5*m[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>*<FONT COLOR="#000000">(</FONT>vxi*vxi+vyi*vyi+vzi*vzi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> e
<FONT COLOR="#000000">in</FONT>
  l0 <FONT COLOR="#000000">(</FONT>0<FONT COLOR="#000000">,</FONT> 0.0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> advances <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>advance 0.01<FONT COLOR="#000000">;</FONT> advances <FONT COLOR="#000000">(</FONT>i-1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">implement</FONT> main <FONT COLOR="#000000">(</FONT>argc<FONT COLOR="#000000">,</FONT> argv<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> assert <FONT COLOR="#000000">(</FONT>argc <FONT COLOR="#000000">=</FONT> 2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> n <FONT COLOR="#000000">=</FONT> int1_of <FONT COLOR="#000000">(</FONT>argv<FONT COLOR="#000000">.</FONT><FONT COLOR="#000000">[</FONT><FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> assert <FONT COLOR="#000000">(</FONT>n &gt;= 2<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  offmoment<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  printf <FONT COLOR="#000000">(</FONT>"%.9f\n"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>energy<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  advances n<FONT COLOR="#000000">;</FONT>
  printf <FONT COLOR="#000000">(</FONT>"%.9f\n"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>energy<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* end of [n-body1.dats] *)</FONT>
</PRE></BODY>
